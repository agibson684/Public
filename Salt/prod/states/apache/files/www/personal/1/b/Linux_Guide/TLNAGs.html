<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><HTML>
<HEAD>
<TITLE></TITLE>
</HEAD>
<BODY>
<A name=1></a><b>Linux Network Administrators Guide</b><br>
<hr>
<A name=2></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#17"><b>1.&nbsp;Purpose&nbsp;and&nbsp;Audience&nbsp;for&nbsp;This&nbsp;Book............................................................................................................1</b></a><br>
<a href="TLNAGs.html#18"><b>2.&nbsp;Sources&nbsp;of&nbsp;Information...................................................................................................................................2</b></a><br>
<a href="TLNAGs.html#19">2.1.&nbsp;Documentation&nbsp;Available&nbsp;via&nbsp;FTP....................................................................................................3<br>2.2.&nbsp;Documentation&nbsp;Available&nbsp;via&nbsp;WWW...............................................................................................3<br>2.3.&nbsp;Documentation&nbsp;Available&nbsp;Commercially</a>.........................................................................................3<br><a href="TLNAGs.html#20">2.4.&nbsp;Linux&nbsp;Journal&nbsp;and&nbsp;Linux&nbsp;Magazine..................................................................................................4<br>2.5.&nbsp;Linux&nbsp;Usenet&nbsp;Newsgroups................................................................................................................4<br></a><a href="TLNAGs.html#21">2.6.&nbsp;Linux&nbsp;Mailing&nbsp;Lists</a>..........................................................................................................................5<br><a href="TLNAGs.html#22">2.7.&nbsp;Online&nbsp;Linux&nbsp;Support.......................................................................................................................6<br>2.8.&nbsp;Linux&nbsp;User&nbsp;Groups............................................................................................................................6<br></a><a href="TLNAGs.html#23">2.9.&nbsp;Obtaining&nbsp;Linux................................................................................................................................7</a><br>
<a href="TLNAGs.html#25"><b>3.&nbsp;File&nbsp;System&nbsp;Standards....................................................................................................................................9</b></a><br>
<a href="TLNAGs.html#26"><b>4.&nbsp;Standard&nbsp;Linux&nbsp;Base....................................................................................................................................10</b></a><br>
<a href="TLNAGs.html#27"><b>5.&nbsp;About&nbsp;This&nbsp;Book</b></a><b>...........................................................................................................................................11</b><br>
<a href="TLNAGs.html#29"><b>6.&nbsp;The&nbsp;Official&nbsp;Printed&nbsp;Version........................................................................................................................13</b></a><br>
<a href="TLNAGs.html#31"><b>7.&nbsp;Overview........................................................................................................................................................15</b></a><br>
<a href="TLNAGs.html#33"><b>8.&nbsp;Conventions&nbsp;Used&nbsp;in&nbsp;This&nbsp;Book...................................................................................................................17</b></a><br>
<a href="TLNAGs.html#34"><b>9.&nbsp;Submitting&nbsp;Changes......................................................................................................................................18</b></a><br>
<a href="TLNAGs.html#35"><b>10.&nbsp;Acknowledgments.......................................................................................................................................19</b></a><br>
<a href="TLNAGs.html#35">10.1.&nbsp;The&nbsp;Hall&nbsp;of&nbsp;Fame..........................................................................................................................19</a><br>
<a href="TLNAGs.html#37"><b>Chapter&nbsp;1.&nbsp;Introduction&nbsp;to&nbsp;Networking..........................................................................................................21</b></a><br>
<a href="TLNAGs.html#38"><b>1.1.&nbsp;History.........................................................................................................................................................22</b></a><br>
<a href="TLNAGs.html#39"><b>1.2.&nbsp;TCP/IP&nbsp;Networks.......................................................................................................................................23</b></a><br>
<a href="TLNAGs.html#39">1.2.1.&nbsp;Introduction&nbsp;to&nbsp;TCP/IP&nbsp;Networks................................................................................................23<br></a><a href="TLNAGs.html#40">1.2.2.&nbsp;Ethernets......................................................................................................................................24<br></a><a href="TLNAGs.html#41">1.2.3.&nbsp;Other&nbsp;Types&nbsp;of&nbsp;Hardware.............................................................................................................25<br></a><a href="TLNAGs.html#43">1.2.4.&nbsp;The&nbsp;Internet&nbsp;Protocol...................................................................................................................27<br></a><a href="TLNAGs.html#44">1.2.5.&nbsp;IP&nbsp;Over&nbsp;Serial&nbsp;Lines.....................................................................................................................28<br>1.2.6.&nbsp;The&nbsp;Transmission&nbsp;Control&nbsp;Protocol.............................................................................................28<br></a><a href="TLNAGs.html#45">1.2.7.&nbsp;The&nbsp;User&nbsp;Datagram&nbsp;Protocol</a>.......................................................................................................29<br><a href="TLNAGs.html#45">1.2.8.&nbsp;More&nbsp;on&nbsp;Ports...............................................................................................................................29<br></a><a href="TLNAGs.html#46">1.2.9.&nbsp;The&nbsp;Socket&nbsp;Library......................................................................................................................30</a><br>
<a href="TLNAGs.html#47"><b>1.3.&nbsp;UUCP&nbsp;Networks.........................................................................................................................................31</b></a><br>
<a href="TLNAGs.html#48"><b>1.4.&nbsp;Linux&nbsp;Networking......................................................................................................................................32</b></a><br>
i<br>
<hr>
<A name=3></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#48">1.4.1.&nbsp;Different&nbsp;Streaks&nbsp;of&nbsp;Development...............................................................................................32<br></a><a href="TLNAGs.html#49">1.4.2.&nbsp;Where&nbsp;to&nbsp;Get&nbsp;the&nbsp;Code.................................................................................................................33</a><br>
<a href="TLNAGs.html#50"><b>1.5.&nbsp;Maintaining&nbsp;Your&nbsp;System.........................................................................................................................34</b></a><br>
<a href="TLNAGs.html#50">1.5.1.&nbsp;System&nbsp;Security</a>...........................................................................................................................34<br>
<a href="TLNAGs.html#52"><b>Chapter&nbsp;2.&nbsp;Issues&nbsp;of&nbsp;TCP/IP&nbsp;Networking</b></a><b>.......................................................................................................36</b><br>
<a href="TLNAGs.html#53"><b>2.1.&nbsp;Networking&nbsp;Interfaces...............................................................................................................................37</b></a><br>
<a href="TLNAGs.html#54"><b>2.2.&nbsp;IP&nbsp;Addresses...............................................................................................................................................38</b></a><br>
<a href="TLNAGs.html#56"><b>2.3.&nbsp;Address&nbsp;Resolution....................................................................................................................................40</b></a><br>
<a href="TLNAGs.html#57"><b>2.4.&nbsp;IP&nbsp;Routing...................................................................................................................................................41</b></a><br>
<a href="TLNAGs.html#57">2.4.1.&nbsp;IP&nbsp;Networks.................................................................................................................................41<br>2.4.2.&nbsp;Subnetworks.................................................................................................................................41<br></a><a href="TLNAGs.html#58">2.4.3.&nbsp;Gateways......................................................................................................................................42<br></a><a href="TLNAGs.html#59">2.4.4.&nbsp;The&nbsp;Routing&nbsp;Table.......................................................................................................................43<br></a><a href="TLNAGs.html#61">2.4.5.&nbsp;Metric&nbsp;Values...............................................................................................................................45</a><br>
<a href="TLNAGs.html#62"><b>2.5.&nbsp;The&nbsp;Internet&nbsp;Control&nbsp;Message&nbsp;Protocol...................................................................................................46</b></a><br>
<a href="TLNAGs.html#63"><b>2.6.&nbsp;Resolving&nbsp;Host&nbsp;Names</b></a><b>...............................................................................................................................47</b><br>
<a href="TLNAGs.html#64"><b>Chapter&nbsp;3.&nbsp;Configuringthe&nbsp;NetworkingHardware........................................................................................48</b></a><br>
<a href="TLNAGs.html#67"><b>3.1.&nbsp;Kernel&nbsp;Configuration.................................................................................................................................51</b></a><br>
<a href="TLNAGs.html#67">3.1.1.&nbsp;Kernel&nbsp;Options&nbsp;in&nbsp;Linux&nbsp;2.0&nbsp;and&nbsp;Higher.....................................................................................51<br></a><a href="TLNAGs.html#69">3.1.2.&nbsp;Kernel&nbsp;Networking&nbsp;Options&nbsp;in&nbsp;Linux&nbsp;2.0.0&nbsp;and&nbsp;Higher..............................................................53</a><br>
<a href="TLNAGs.html#73"><b>3.2.&nbsp;A&nbsp;Tour&nbsp;of&nbsp;Linux&nbsp;Network&nbsp;Devices............................................................................................................57</b></a><br>
<a href="TLNAGs.html#75"><b>3.3.&nbsp;Ethernet&nbsp;Installation..................................................................................................................................59</b></a><br>
<a href="TLNAGs.html#75">3.3.1.&nbsp;Ethernet&nbsp;Autoprobing...................................................................................................................59</a><br>
<a href="TLNAGs.html#78"><b>3.4.&nbsp;The&nbsp;PLIP&nbsp;Driver</b></a><b>........................................................................................................................................62</b><br>
<a href="TLNAGs.html#80"><b>3.5.&nbsp;The&nbsp;PPP&nbsp;and&nbsp;SLIP&nbsp;Drivers</b></a><b>.......................................................................................................................64</b><br>
<a href="TLNAGs.html#81"><b>3.6.&nbsp;Other&nbsp;Network&nbsp;Types................................................................................................................................65</b></a><br>
<a href="TLNAGs.html#82"><b>Chapter&nbsp;4.&nbsp;Configuring&nbsp;the&nbsp;Serial&nbsp;Hardware.................................................................................................66</b></a><br>
<a href="TLNAGs.html#83"><b>4.1.&nbsp;Communications&nbsp;Software&nbsp;for&nbsp;Modem&nbsp;Links.........................................................................................67</b></a><br>
<a href="TLNAGs.html#84"><b>4.2.&nbsp;Introduction&nbsp;to&nbsp;Serial&nbsp;Devices...................................................................................................................68</b></a><br>
ii<br>
<hr>
<A name=4></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#85"><b>4.3.&nbsp;Accessing&nbsp;Serial&nbsp;Devices............................................................................................................................69</b></a><br>
<a href="TLNAGs.html#86">4.3.1.&nbsp;The&nbsp;Serial&nbsp;Device&nbsp;Special&nbsp;Files...................................................................................................70</a><br>
<a href="TLNAGs.html#88"><b>4.4.&nbsp;Serial&nbsp;Hardware.........................................................................................................................................72</b></a><br>
<a href="TLNAGs.html#89"><b>4.5.&nbsp;Using&nbsp;the&nbsp;Configuration&nbsp;Utilities..............................................................................................................73</b></a><br>
<a href="TLNAGs.html#89">4.5.1.&nbsp;The&nbsp;setserial&nbsp;Command................................................................................................................73<br></a><a href="TLNAGs.html#91">4.5.2.&nbsp;The&nbsp;stty&nbsp;Command.......................................................................................................................75</a><br>
<a href="TLNAGs.html#94"><b>4.6.&nbsp;Serial&nbsp;Devices&nbsp;and&nbsp;the&nbsp;login:&nbsp;Prompt.......................................................................................................78</b></a><br>
<a href="TLNAGs.html#94">4.6.1.&nbsp;Configuring&nbsp;the&nbsp;mgetty&nbsp;Daemon.................................................................................................78</a><br>
<a href="TLNAGs.html#97"><b>Chapter&nbsp;5.&nbsp;Configuring&nbsp;TCP/IP&nbsp;Networking.................................................................................................81</b></a><br>
<a href="TLNAGs.html#98"><b>5.1.&nbsp;Mounting&nbsp;the&nbsp;/proc&nbsp;Filesystem.................................................................................................................82</b></a><br>
<a href="TLNAGs.html#99"><b>5.2.&nbsp;Installing&nbsp;the&nbsp;Binaries................................................................................................................................83</b></a><br>
<a href="TLNAGs.html#100"><b>5.3.&nbsp;Setting&nbsp;the&nbsp;Hostname.................................................................................................................................84</b></a><br>
<a href="TLNAGs.html#101"><b>5.4.&nbsp;Assigning&nbsp;IP&nbsp;Addresses..............................................................................................................................85</b></a><br>
<a href="TLNAGs.html#102"><b>5.5.&nbsp;Creating&nbsp;Subnets........................................................................................................................................86</b></a><br>
<a href="TLNAGs.html#103"><b>5.6.&nbsp;Writing&nbsp;hosts&nbsp;and&nbsp;networks&nbsp;Files.............................................................................................................87</b></a><br>
<a href="TLNAGs.html#105"><b>5.7.&nbsp;Interface&nbsp;Configuration&nbsp;for&nbsp;IP..................................................................................................................89</b></a><br>
<a href="TLNAGs.html#105">5.7.1.&nbsp;The&nbsp;Loopback&nbsp;Interface...............................................................................................................89<br></a><a href="TLNAGs.html#107">5.7.2.&nbsp;Ethernet&nbsp;Interfaces.......................................................................................................................91<br></a><a href="TLNAGs.html#108">5.7.3.&nbsp;Routing&nbsp;Through&nbsp;a&nbsp;Gateway........................................................................................................92<br></a><a href="TLNAGs.html#109">5.7.4.&nbsp;Configuring&nbsp;a&nbsp;Gateway................................................................................................................93<br>5.7.5.&nbsp;The&nbsp;PLIP&nbsp;Interface.......................................................................................................................93<br></a><a href="TLNAGs.html#110">5.7.6.&nbsp;The&nbsp;SLIP&nbsp;and&nbsp;PPP&nbsp;Interfaces.......................................................................................................94<br>5.7.7.&nbsp;The&nbsp;Dummy&nbsp;Interface..................................................................................................................94<br></a><a href="TLNAGs.html#111">5.7.8.&nbsp;IP&nbsp;Alias</a>........................................................................................................................................95<br>
<a href="TLNAGs.html#112"><b>5.8.&nbsp;All&nbsp;About&nbsp;ifconfig.......................................................................................................................................96</b></a><br>
<a href="TLNAGs.html#115"><b>5.9.&nbsp;The&nbsp;netstat&nbsp;Command</b></a><b>...............................................................................................................................99</b><br>
<a href="TLNAGs.html#115">5.9.1.&nbsp;Displaying&nbsp;the&nbsp;Routing&nbsp;Table......................................................................................................99<br></a><a href="TLNAGs.html#116">5.9.2.&nbsp;Displaying&nbsp;Interface&nbsp;Statistics...................................................................................................100<br></a><a href="TLNAGs.html#117">5.9.3.&nbsp;Displaying&nbsp;Connections.............................................................................................................101</a><br>
<a href="TLNAGs.html#118"><b>5.10.&nbsp;Checking&nbsp;the&nbsp;ARP&nbsp;Tables</b></a><b>.....................................................................................................................102</b><br>
<a href="TLNAGs.html#120"><b>Chapter&nbsp;6.&nbsp;Name&nbsp;Service&nbsp;and&nbsp;Resolver&nbsp;Configuration...............................................................................104</b></a><br>
<a href="TLNAGs.html#121"><b>6.1.&nbsp;The&nbsp;Resolver&nbsp;Library</b></a><b>..............................................................................................................................105</b><br>
iii<br>
<hr>
<A name=5></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#121">6.1.1.&nbsp;The&nbsp;host.conf&nbsp;File......................................................................................................................105</a><br>
<a href="TLNAGs.html#122">6.1.1.1.&nbsp;Resolver&nbsp;environment&nbsp;variables.................................................................................106</a><br>
<a href="TLNAGs.html#123">6.1.2.&nbsp;The&nbsp;nsswitch.conf&nbsp;File...............................................................................................................107<br></a><a href="TLNAGs.html#125">6.1.3.&nbsp;Configuring&nbsp;Name&nbsp;Server&nbsp;Lookups&nbsp;Using&nbsp;resolv.conf..............................................................109<br></a><a href="TLNAGs.html#127">6.1.4.&nbsp;Resolver&nbsp;Robustness..................................................................................................................111</a><br>
<a href="TLNAGs.html#128"><b>6.2.&nbsp;How&nbsp;DNS&nbsp;Works......................................................................................................................................112</b></a><br>
<a href="TLNAGs.html#129">6.2.1.&nbsp;Name&nbsp;Lookups&nbsp;with&nbsp;DNS..........................................................................................................113<br></a><a href="TLNAGs.html#130">6.2.2.&nbsp;Types&nbsp;of&nbsp;Name&nbsp;Servers..............................................................................................................114<br></a><a href="TLNAGs.html#131">6.2.3.&nbsp;The&nbsp;DNS&nbsp;Database.....................................................................................................................115<br></a><a href="TLNAGs.html#132">6.2.4.&nbsp;Reverse&nbsp;Lookups........................................................................................................................116</a><br>
<a href="TLNAGs.html#134"><b>6.3.&nbsp;Running&nbsp;named........................................................................................................................................118</b></a><br>
<a href="TLNAGs.html#134">6.3.1.&nbsp;The&nbsp;named.boot&nbsp;File..................................................................................................................118<br></a><a href="TLNAGs.html#136">6.3.2.&nbsp;The&nbsp;BIND&nbsp;8&nbsp;host.conf&nbsp;File.........................................................................................................120<br></a><a href="TLNAGs.html#137">6.3.3.&nbsp;The&nbsp;DNS&nbsp;Database&nbsp;Files............................................................................................................121<br></a><a href="TLNAGs.html#141">6.3.4.&nbsp;Caching−only&nbsp;named&nbsp;Configuration..........................................................................................125<br></a><a href="TLNAGs.html#142">6.3.5.&nbsp;Writing&nbsp;the&nbsp;Master&nbsp;Files............................................................................................................126<br></a><a href="TLNAGs.html#144">6.3.6.&nbsp;Verifying&nbsp;the&nbsp;Name&nbsp;Server&nbsp;Setup..............................................................................................128<br></a><a href="TLNAGs.html#146">6.3.7.&nbsp;Other&nbsp;Useful&nbsp;Tools.....................................................................................................................130</a><br>
<a href="TLNAGs.html#148"><b>Chapter&nbsp;7.&nbsp;Serial&nbsp;Line&nbsp;IP................................................................................................................................132</b></a><br>
<a href="TLNAGs.html#149"><b>7.1.&nbsp;General&nbsp;Requirements.............................................................................................................................133</b></a><br>
<a href="TLNAGs.html#150"><b>7.2.&nbsp;SLIP&nbsp;Operation........................................................................................................................................134</b></a><br>
<a href="TLNAGs.html#153"><b>7.3.&nbsp;Dealing&nbsp;with&nbsp;Private&nbsp;IP&nbsp;Networks..........................................................................................................137</b></a><br>
<a href="TLNAGs.html#154"><b>7.4.&nbsp;Using&nbsp;dip...................................................................................................................................................138</b></a><br>
<a href="TLNAGs.html#154">7.4.1.&nbsp;A&nbsp;Sample&nbsp;Script.........................................................................................................................138<br></a><a href="TLNAGs.html#156">7.4.2.&nbsp;A&nbsp;dip&nbsp;Reference.........................................................................................................................140</a><br>
<a href="TLNAGs.html#156">7.4.2.1.&nbsp;The&nbsp;modem&nbsp;commands..............................................................................................140<br></a><a href="TLNAGs.html#157">7.4.2.2.&nbsp;The&nbsp;echo&nbsp;command....................................................................................................141<br>7.4.2.3.&nbsp;The&nbsp;get&nbsp;command.......................................................................................................141<br>7.4.2.4.&nbsp;The&nbsp;print&nbsp;command....................................................................................................141<br>7.4.2.5.&nbsp;Variable&nbsp;names..........................................................................................................141<br></a><a href="TLNAGs.html#158">7.4.2.6.&nbsp;The&nbsp;if&nbsp;and&nbsp;goto&nbsp;commands.........................................................................................142<br>7.4.2.7.&nbsp;send,&nbsp;wait,&nbsp;and&nbsp;sleep..................................................................................................142<br>7.4.2.8.&nbsp;mode&nbsp;and&nbsp;default........................................................................................................142</a><br>
<a href="TLNAGs.html#160"><b>7.5.&nbsp;Running&nbsp;in&nbsp;Server&nbsp;Mode.........................................................................................................................144</b></a><br>
<a href="TLNAGs.html#162"><b>Chapter&nbsp;8.&nbsp;The&nbsp;Point−to−Point&nbsp;Protocol......................................................................................................146</b></a><br>
<a href="TLNAGs.html#163"><b>8.1.&nbsp;PPP&nbsp;on&nbsp;Linux............................................................................................................................................147</b></a><br>
<a href="TLNAGs.html#164"><b>8.2.&nbsp;Running&nbsp;pppd...........................................................................................................................................148</b></a><br>
iv<br>
<hr>
<A name=6></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#165"><b>8.3.&nbsp;Using&nbsp;Options&nbsp;Files..................................................................................................................................149</b></a><br>
<a href="TLNAGs.html#166"><b>8.4.&nbsp;Using&nbsp;chat&nbsp;to&nbsp;Automate&nbsp;Dialing..............................................................................................................150</b></a><br>
<a href="TLNAGs.html#168"><b>8.5.&nbsp;IP&nbsp;Configuration&nbsp;Options........................................................................................................................152</b></a><br>
<a href="TLNAGs.html#168">8.5.1.&nbsp;Choosing&nbsp;IP&nbsp;Addresses..............................................................................................................152<br></a><a href="TLNAGs.html#169">8.5.2.&nbsp;Routing&nbsp;Through&nbsp;a&nbsp;PPP&nbsp;Link.....................................................................................................153</a><br>
<a href="TLNAGs.html#171"><b>8.6.&nbsp;Link&nbsp;Control&nbsp;Options</b></a><b>..............................................................................................................................155</b><br>
<a href="TLNAGs.html#173"><b>8.7.&nbsp;General&nbsp;Security&nbsp;Considerations............................................................................................................157</b></a><br>
<a href="TLNAGs.html#174"><b>8.8.&nbsp;Authentication&nbsp;with&nbsp;PPP.........................................................................................................................158</b></a><br>
<a href="TLNAGs.html#174">8.8.1.&nbsp;PAP&nbsp;Versus&nbsp;CHAP....................................................................................................................158<br></a><a href="TLNAGs.html#175">8.8.2.&nbsp;The&nbsp;CHAP&nbsp;Secrets&nbsp;File..............................................................................................................159<br></a><a href="TLNAGs.html#176">8.8.3.&nbsp;The&nbsp;PAP&nbsp;Secrets&nbsp;File.................................................................................................................160</a><br>
<a href="TLNAGs.html#178"><b>8.9.&nbsp;Debugging&nbsp;Your&nbsp;PPP&nbsp;Setup....................................................................................................................162</b></a><br>
<a href="TLNAGs.html#179"><b>8.10.&nbsp;More&nbsp;Advanced&nbsp;PPP&nbsp;Configurations...................................................................................................163</b></a><br>
<a href="TLNAGs.html#179">8.10.1.&nbsp;PPP&nbsp;Server...............................................................................................................................163<br></a><a href="TLNAGs.html#180">8.10.2.&nbsp;Demand&nbsp;Dialing.......................................................................................................................164<br></a><a href="TLNAGs.html#181">8.10.3.&nbsp;Persistent&nbsp;Dialing.....................................................................................................................165</a><br>
<a href="TLNAGs.html#183"><b>Chapter&nbsp;9.&nbsp;TCP/IP&nbsp;Firewall...........................................................................................................................167</b></a><br>
<a href="TLNAGs.html#184"><b>9.1.&nbsp;Methods&nbsp;of&nbsp;Attack....................................................................................................................................168</b></a><br>
<a href="TLNAGs.html#186"><b>9.2.&nbsp;What&nbsp;Is&nbsp;a&nbsp;Firewall?..................................................................................................................................170</b></a><br>
<a href="TLNAGs.html#187"><b>9.3.&nbsp;What&nbsp;Is&nbsp;IP&nbsp;Filtering?...............................................................................................................................171</b></a><br>
<a href="TLNAGs.html#188"><b>9.4.&nbsp;Setting&nbsp;Up&nbsp;Linux&nbsp;for&nbsp;Firewalling............................................................................................................172</b></a><br>
<a href="TLNAGs.html#188">9.4.1.&nbsp;Kernel&nbsp;Configured&nbsp;with&nbsp;IP&nbsp;Firewall..........................................................................................172<br></a><a href="TLNAGs.html#189">9.4.2.&nbsp;The&nbsp;ipfwadm&nbsp;Utility...................................................................................................................173<br>9.4.3.&nbsp;The&nbsp;ipchains&nbsp;Utility...................................................................................................................173<br>9.4.4.&nbsp;The&nbsp;iptables&nbsp;Utility....................................................................................................................173</a><br>
<a href="TLNAGs.html#190"><b>9.5.&nbsp;Three&nbsp;Ways&nbsp;We&nbsp;Can&nbsp;Do&nbsp;Filtering..........................................................................................................174</b></a><br>
<a href="TLNAGs.html#191"><b>9.6.&nbsp;Original&nbsp;IP&nbsp;Firewall&nbsp;(2.0&nbsp;Kernels)..........................................................................................................175</b></a><br>
<a href="TLNAGs.html#191">9.6.1.&nbsp;Using&nbsp;ipfwadm...........................................................................................................................175</a><br>
<a href="TLNAGs.html#191">9.6.1.1.&nbsp;A&nbsp;naïve&nbsp;example........................................................................................................175<br></a><a href="TLNAGs.html#193">9.6.1.2.&nbsp;An&nbsp;important&nbsp;refinement............................................................................................177<br>9.6.1.3.&nbsp;Listing&nbsp;our&nbsp;rules.........................................................................................................177</a><br>
<a href="TLNAGs.html#194">9.6.2.&nbsp;A&nbsp;More&nbsp;Complex&nbsp;Example........................................................................................................178<br></a><a href="TLNAGs.html#195">9.6.3.&nbsp;Summary&nbsp;of&nbsp;ipfwadm&nbsp;Arguments..............................................................................................179</a><br>
<a href="TLNAGs.html#195">9.6.3.1.&nbsp;Categories..................................................................................................................179</a><br>
v<br>
<hr>
<A name=7></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#195">9.6.3.2.&nbsp;Commands.................................................................................................................179<br></a><a href="TLNAGs.html#196">9.6.3.3.&nbsp;Parameters..................................................................................................................180<br></a><a href="TLNAGs.html#197">9.6.3.4.&nbsp;Optional&nbsp;arguments....................................................................................................181<br></a><a href="TLNAGs.html#198">9.6.3.5.&nbsp;ICMP&nbsp;datagram&nbsp;types................................................................................................182</a><br>
<a href="TLNAGs.html#199"><b>9.7.&nbsp;IP&nbsp;Firewall&nbsp;Chains&nbsp;(2.2&nbsp;Kernels)............................................................................................................183</b></a><br>
<a href="TLNAGs.html#199">9.7.1.&nbsp;Using&nbsp;ipchains............................................................................................................................183<br>9.7.2.&nbsp;ipchains&nbsp;Command&nbsp;Syntax........................................................................................................183</a><br>
<a href="TLNAGs.html#200">9.7.2.1.&nbsp;Commands.................................................................................................................184<br></a><a href="TLNAGs.html#201">9.7.2.2.&nbsp;Rule&nbsp;specification&nbsp;parameters....................................................................................185<br></a><a href="TLNAGs.html#202">9.7.2.3.&nbsp;Options.......................................................................................................................186</a><br>
<a href="TLNAGs.html#203">9.7.3.&nbsp;Our&nbsp;Naïve&nbsp;Example&nbsp;Revisited...................................................................................................187<br></a><a href="TLNAGs.html#204">9.7.4.&nbsp;Listing&nbsp;Our&nbsp;Rules&nbsp;with&nbsp;ipchains................................................................................................188<br>9.7.5.&nbsp;Making&nbsp;Good&nbsp;Use&nbsp;of&nbsp;Chains......................................................................................................188</a><br>
<a href="TLNAGs.html#205">9.7.5.1.&nbsp;User−defined&nbsp;chains..................................................................................................189<br></a><a href="TLNAGs.html#208">9.7.5.2.&nbsp;The&nbsp;ipchains&nbsp;support&nbsp;scripts......................................................................................192</a><br>
<a href="TLNAGs.html#210"><b>9.8.&nbsp;Netfilter&nbsp;and&nbsp;IP&nbsp;Tables&nbsp;(2.4&nbsp;Kernels)</b></a><b>.....................................................................................................194</b><br>
<a href="TLNAGs.html#212">9.8.1.&nbsp;Backward&nbsp;Compatability&nbsp;with&nbsp;ipfwadmand&nbsp;ipchains................................................................196<br>9.8.2.&nbsp;Using&nbsp;iptables............................................................................................................................196</a><br>
<a href="TLNAGs.html#212">9.8.2.1.&nbsp;Commands.................................................................................................................196<br></a><a href="TLNAGs.html#214">9.8.2.2.&nbsp;Rule&nbsp;specification&nbsp;parameters....................................................................................198<br></a><a href="TLNAGs.html#215">9.8.2.3.&nbsp;Options.......................................................................................................................199<br>9.8.2.4.&nbsp;Extensions..................................................................................................................199</a><br>
<a href="TLNAGs.html#217">9.8.3.&nbsp;Our&nbsp;Naïve&nbsp;Example&nbsp;Revisited,&nbsp;Yet&nbsp;Again.................................................................................201</a><br>
<a href="TLNAGs.html#218"><b>9.9.&nbsp;TOS&nbsp;Bit&nbsp;Manipulation.............................................................................................................................202</b></a><br>
<a href="TLNAGs.html#218">9.9.1.&nbsp;Setting&nbsp;the&nbsp;TOS&nbsp;Bits&nbsp;Using&nbsp;ipfwadm&nbsp;or&nbsp;ipchains......................................................................202<br></a><a href="TLNAGs.html#219">9.9.2.&nbsp;Setting&nbsp;the&nbsp;TOS&nbsp;Bits&nbsp;Using&nbsp;iptables..........................................................................................203</a><br>
<a href="TLNAGs.html#221"><b>9.10.&nbsp;Testing&nbsp;a&nbsp;Firewall&nbsp;Configuration</b></a><b>.........................................................................................................205</b><br>
<a href="TLNAGs.html#223"><b>9.11.&nbsp;A&nbsp;Sample&nbsp;Firewall&nbsp;Configuration.........................................................................................................207</b></a><br>
<a href="TLNAGs.html#230"><b>Chapter&nbsp;10.&nbsp;IP&nbsp;Accounting.............................................................................................................................214</b></a><br>
<a href="TLNAGs.html#231"><b>10.1.&nbsp;Configuring&nbsp;the&nbsp;Kernel&nbsp;for&nbsp;IP&nbsp;Accounting..........................................................................................215</b></a><br>
<a href="TLNAGs.html#232"><b>10.2.&nbsp;Configuring&nbsp;IP&nbsp;Accounting...................................................................................................................216</b></a><br>
<a href="TLNAGs.html#232">10.2.1.&nbsp;Accounting&nbsp;by&nbsp;Address............................................................................................................216<br></a><a href="TLNAGs.html#234">10.2.2.&nbsp;Accounting&nbsp;by&nbsp;Service&nbsp;Port.....................................................................................................218<br></a><a href="TLNAGs.html#236">10.2.3.&nbsp;Accounting&nbsp;of&nbsp;ICMP&nbsp;Datagrams</a>.............................................................................................220<br><a href="TLNAGs.html#237">10.2.4.&nbsp;Accounting&nbsp;by&nbsp;Protocol...........................................................................................................221</a><br>
<a href="TLNAGs.html#238"><b>10.3.&nbsp;Using&nbsp;IP&nbsp;Accounting&nbsp;Results.................................................................................................................222</b></a><br>
<a href="TLNAGs.html#238">10.3.1.&nbsp;Listing&nbsp;Accounting&nbsp;Data&nbsp;with&nbsp;ipfwadm...................................................................................222<br></a><a href="TLNAGs.html#239">10.3.2.&nbsp;Listing&nbsp;Accounting&nbsp;Data&nbsp;with&nbsp;ipchains....................................................................................223<br>10.3.3.&nbsp;Listing&nbsp;Accounting&nbsp;Data&nbsp;with&nbsp;iptables....................................................................................223</a><br>
vi<br>
<hr>
<A name=8></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#240"><b>10.4.&nbsp;Resetting&nbsp;the&nbsp;Counters</b></a><b>..........................................................................................................................224</b><br>
<a href="TLNAGs.html#241"><b>10.5.&nbsp;Flushing&nbsp;the&nbsp;Ruleset...............................................................................................................................225</b></a><br>
<a href="TLNAGs.html#242"><b>10.6.&nbsp;Passive&nbsp;Collection&nbsp;of&nbsp;Accounting&nbsp;Data.................................................................................................226</b></a><br>
<a href="TLNAGs.html#243"><b>Chapter&nbsp;11.&nbsp;IP&nbsp;Masquerade&nbsp;and&nbsp;Network&nbsp;Address&nbsp;Translation................................................................227</b></a><br>
<a href="TLNAGs.html#245"><b>11.1.&nbsp;Side&nbsp;Effects&nbsp;and&nbsp;Fringe&nbsp;Benefits...........................................................................................................229</b></a><br>
<a href="TLNAGs.html#246"><b>11.2.&nbsp;Configuring&nbsp;the&nbsp;Kernel&nbsp;for&nbsp;IP&nbsp;Masquerade........................................................................................230</b></a><br>
<a href="TLNAGs.html#248"><b>11.3.&nbsp;Configuring&nbsp;IP&nbsp;Masquerade</b></a><b>.................................................................................................................232</b><br>
<a href="TLNAGs.html#249">11.3.1.&nbsp;Setting&nbsp;Timing&nbsp;Parameters&nbsp;for&nbsp;IP&nbsp;Masquerade........................................................................233</a><br>
<a href="TLNAGs.html#251"><b>11.4.&nbsp;Handling&nbsp;Name&nbsp;Server&nbsp;Lookups..........................................................................................................235</b></a><br>
<a href="TLNAGs.html#252"><b>11.5.&nbsp;More&nbsp;About&nbsp;Network&nbsp;Address&nbsp;Translation.........................................................................................236</b></a><br>
<a href="TLNAGs.html#253"><b>Chapter&nbsp;12.&nbsp;ImportantNetwork&nbsp;Features.....................................................................................................237</b></a><br>
<a href="TLNAGs.html#254"><b>12.1.&nbsp;The&nbsp;inetd&nbsp;Super&nbsp;Server..........................................................................................................................238</b></a><br>
<a href="TLNAGs.html#257"><b>12.2.&nbsp;The&nbsp;tcpd&nbsp;Access&nbsp;Control&nbsp;Facility..........................................................................................................241</b></a><br>
<a href="TLNAGs.html#259"><b>12.3.&nbsp;The&nbsp;Services&nbsp;and&nbsp;Protocols&nbsp;Files</b></a><b>..........................................................................................................243</b><br>
<a href="TLNAGs.html#261"><b>12.4.&nbsp;Remote&nbsp;Procedure&nbsp;Call..........................................................................................................................245</b></a><br>
<a href="TLNAGs.html#263"><b>12.5.&nbsp;Configuring&nbsp;Remote&nbsp;Loginand&nbsp;Execution...........................................................................................247</b></a><br>
<a href="TLNAGs.html#263">12.5.1.&nbsp;Disabling&nbsp;the&nbsp;r;&nbsp;Commands</a>.....................................................................................................247<br><a href="TLNAGs.html#263">12.5.2.&nbsp;Installing&nbsp;and&nbsp;Configuring&nbsp;ssh.................................................................................................247</a><br>
<a href="TLNAGs.html#264">12.5.2.1.&nbsp;The&nbsp;ssh&nbsp;daemon.......................................................................................................248<br></a><a href="TLNAGs.html#265">12.5.2.2.&nbsp;The&nbsp;ssh&nbsp;client...........................................................................................................249<br></a><a href="TLNAGs.html#267">12.5.2.3.&nbsp;Using&nbsp;ssh..................................................................................................................251</a><br>
<a href="TLNAGs.html#270"><b>Chapter&nbsp;13.&nbsp;The&nbsp;Network&nbsp;Information&nbsp;System............................................................................................254</b></a><br>
<a href="TLNAGs.html#272"><b>13.1.&nbsp;Getting&nbsp;Acquainted&nbsp;with&nbsp;NIS................................................................................................................256</b></a><br>
<a href="TLNAGs.html#275"><b>13.2.&nbsp;NIS&nbsp;Versus&nbsp;NIS+....................................................................................................................................259</b></a><br>
<a href="TLNAGs.html#276"><b>13.3.&nbsp;The&nbsp;Client&nbsp;Side&nbsp;of&nbsp;NIS...........................................................................................................................260</b></a><br>
<a href="TLNAGs.html#277"><b>13.4.&nbsp;Running&nbsp;an&nbsp;NIS&nbsp;Server</b></a><b>.........................................................................................................................261</b><br>
<a href="TLNAGs.html#278"><b>13.5.&nbsp;NIS&nbsp;Server&nbsp;Security...............................................................................................................................262</b></a><br>
vii<br>
<hr>
<A name=9></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#280"><b>13.6.&nbsp;Setting&nbsp;Up&nbsp;an&nbsp;NIS&nbsp;Client&nbsp;with&nbsp;GNU&nbsp;libc</b></a><b>.............................................................................................264</b><br>
<a href="TLNAGs.html#282"><b>13.7.&nbsp;Choosing&nbsp;the&nbsp;Right&nbsp;Maps......................................................................................................................266</b></a><br>
<a href="TLNAGs.html#284"><b>13.8.&nbsp;Using&nbsp;the&nbsp;passwd&nbsp;and&nbsp;group&nbsp;Maps.......................................................................................................268</b></a><br>
<a href="TLNAGs.html#286"><b>13.9.&nbsp;Using&nbsp;NIS&nbsp;with&nbsp;Shadow&nbsp;Support..........................................................................................................270</b></a><br>
<a href="TLNAGs.html#287"><b>Chapter&nbsp;14.&nbsp;The&nbsp;NetworkFile&nbsp;System...........................................................................................................271</b></a><br>
<a href="TLNAGs.html#289"><b>14.1.&nbsp;Preparing&nbsp;NFS........................................................................................................................................273</b></a><br>
<a href="TLNAGs.html#290"><b>14.2.&nbsp;Mounting&nbsp;an&nbsp;NFS&nbsp;Volume.....................................................................................................................274</b></a><br>
<a href="TLNAGs.html#293"><b>14.3.&nbsp;The&nbsp;NFS&nbsp;Daemons..................................................................................................................................277</b></a><br>
<a href="TLNAGs.html#294"><b>14.4.&nbsp;The&nbsp;exports&nbsp;File......................................................................................................................................278</b></a><br>
<a href="TLNAGs.html#297"><b>14.5.&nbsp;Kernel−Based&nbsp;NFSv2&nbsp;Server&nbsp;Support</b></a><b>.................................................................................................281</b><br>
<a href="TLNAGs.html#298"><b>14.6.&nbsp;Kernel−Based&nbsp;NFSv3&nbsp;Server&nbsp;Support</b></a><b>.................................................................................................282</b><br>
<a href="TLNAGs.html#299"><b>Chapter&nbsp;15.&nbsp;IPX&nbsp;and&nbsp;the&nbsp;NCP&nbsp;Filesystem....................................................................................................283</b></a><br>
<a href="TLNAGs.html#300"><b>15.1.&nbsp;Xerox,&nbsp;Novell,&nbsp;and&nbsp;History....................................................................................................................284</b></a><br>
<a href="TLNAGs.html#301"><b>15.2.&nbsp;IPX&nbsp;and&nbsp;Linux........................................................................................................................................285</b></a><br>
<a href="TLNAGs.html#301">15.2.1.&nbsp;Caldera&nbsp;Support.......................................................................................................................285<br>15.2.2.&nbsp;More&nbsp;on&nbsp;NDS&nbsp;Support.............................................................................................................285</a><br>
<a href="TLNAGs.html#302"><b>15.3.&nbsp;Configuring&nbsp;the&nbsp;Kernel&nbsp;for&nbsp;IPXand&nbsp;NCPFS.......................................................................................286</b></a><br>
<a href="TLNAGs.html#303"><b>15.4.&nbsp;Configuring&nbsp;IPX&nbsp;Interfaces...................................................................................................................287</b></a><br>
<a href="TLNAGs.html#303">15.4.1.&nbsp;Network&nbsp;Devices&nbsp;Supporting&nbsp;IPX...........................................................................................287<br>15.4.2.&nbsp;IPX&nbsp;Interface&nbsp;Configuration&nbsp;Tools..........................................................................................287<br>15.4.3.&nbsp;The&nbsp;ipx_configure&nbsp;Command..................................................................................................287<br></a><a href="TLNAGs.html#304">15.4.4.&nbsp;The&nbsp;ipx_interface&nbsp;Command....................................................................................................288</a><br>
<a href="TLNAGs.html#306"><b>15.5.&nbsp;Configuring&nbsp;an&nbsp;IPX&nbsp;Router...................................................................................................................290</b></a><br>
<a href="TLNAGs.html#307">15.5.1.&nbsp;Static&nbsp;IPX&nbsp;Routing&nbsp;Using&nbsp;the&nbsp;ipx_route&nbsp;Command.................................................................291<br>15.5.2.&nbsp;Internal&nbsp;IPX&nbsp;Networks&nbsp;and&nbsp;Routing........................................................................................291</a><br>
<a href="TLNAGs.html#310"><b>15.6.&nbsp;Mounting&nbsp;a&nbsp;Remote&nbsp;NetWare&nbsp;Volume.................................................................................................294</b></a><br>
<a href="TLNAGs.html#310">15.6.1.&nbsp;A&nbsp;Simple&nbsp;ncpmount&nbsp;Example..................................................................................................294<br>15.6.2.&nbsp;The&nbsp;ncpmount&nbsp;Command&nbsp;in&nbsp;Detail..........................................................................................294<br></a><a href="TLNAGs.html#312">15.6.3.&nbsp;Hiding&nbsp;Your&nbsp;NetWare&nbsp;Login&nbsp;Password...................................................................................296<br>15.6.4.&nbsp;A&nbsp;More&nbsp;Complex&nbsp;ncpmount&nbsp;Example.....................................................................................296</a><br>
viii<br>
<hr>
<A name=10></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#314"><b>15.7.&nbsp;Exploring&nbsp;Some&nbsp;of&nbsp;the&nbsp;Other&nbsp;IPX&nbsp;Tools..............................................................................................298</b></a><br>
<a href="TLNAGs.html#314">15.7.1.&nbsp;Server&nbsp;List................................................................................................................................298<br>15.7.2.&nbsp;Send&nbsp;Messages&nbsp;to&nbsp;NetWare&nbsp;Users...........................................................................................298<br>15.7.3.&nbsp;Browsing&nbsp;and&nbsp;Manipulating&nbsp;Bindery&nbsp;Data..............................................................................298</a><br>
<a href="TLNAGs.html#316"><b>15.8.&nbsp;Printing&nbsp;to&nbsp;a&nbsp;NetWare&nbsp;Print&nbsp;Queue</b></a><b>.....................................................................................................300</b><br>
<a href="TLNAGs.html#316">15.8.1.&nbsp;Using&nbsp;nprint&nbsp;with&nbsp;the&nbsp;Line&nbsp;Printer&nbsp;Daemon.............................................................................300<br></a><a href="TLNAGs.html#318">15.8.2.&nbsp;Managing&nbsp;Print&nbsp;Queues............................................................................................................302</a><br>
<a href="TLNAGs.html#319"><b>15.9.&nbsp;NetWare&nbsp;Server&nbsp;Emulation...................................................................................................................303</b></a><br>
<a href="TLNAGs.html#320"><b>Chapter&nbsp;16.&nbsp;ManagingTaylor&nbsp;UUCP............................................................................................................304</b></a><br>
<a href="TLNAGs.html#322"><b>16.1.&nbsp;UUCP&nbsp;Transfers&nbsp;and&nbsp;Remote&nbsp;Execution.............................................................................................306</b></a><br>
<a href="TLNAGs.html#322">16.1.1.&nbsp;The&nbsp;Inner&nbsp;Workings&nbsp;of&nbsp;uucico.................................................................................................306<br></a><a href="TLNAGs.html#323">16.1.2.&nbsp;uucico&nbsp;Command−line&nbsp;Options...............................................................................................307</a><br>
<a href="TLNAGs.html#325"><b>16.2.&nbsp;UUCP&nbsp;Configuration&nbsp;Files....................................................................................................................309</b></a><br>
<a href="TLNAGs.html#325">16.2.1.&nbsp;A&nbsp;Gentle&nbsp;Introduction&nbsp;to&nbsp;Taylor&nbsp;UUCP...................................................................................309<br></a><a href="TLNAGs.html#327">16.2.2.&nbsp;What&nbsp;UUCP&nbsp;Needs&nbsp;to&nbsp;Know...................................................................................................311<br></a><a href="TLNAGs.html#328">16.2.3.&nbsp;Site&nbsp;Naming</a>.............................................................................................................................312<br><a href="TLNAGs.html#328">16.2.4.&nbsp;Taylor&nbsp;Configuration&nbsp;Files.......................................................................................................312<br></a><a href="TLNAGs.html#329">16.2.5.&nbsp;General&nbsp;Configuration&nbsp;Options&nbsp;Using&nbsp;the&nbsp;config&nbsp;File.............................................................313<br>16.2.6.&nbsp;How&nbsp;to&nbsp;Tell&nbsp;UUCP&nbsp;About&nbsp;Other&nbsp;Systems&nbsp;Using&nbsp;the&nbsp;sys&nbsp;File.................................................313</a><br>
<a href="TLNAGs.html#330">16.2.6.1.&nbsp;System&nbsp;name............................................................................................................314<br>16.2.6.2.&nbsp;Telephone&nbsp;number...................................................................................................314<br>16.2.6.3.&nbsp;port&nbsp;and&nbsp;speed..........................................................................................................314<br></a><a href="TLNAGs.html#331">16.2.6.4.&nbsp;The&nbsp;login&nbsp;chat..........................................................................................................315<br></a><a href="TLNAGs.html#332">16.2.6.5.&nbsp;Alternates.................................................................................................................316<br></a><a href="TLNAGs.html#333">16.2.6.6.&nbsp;Restricting&nbsp;call&nbsp;times...............................................................................................317</a><br>
<a href="TLNAGs.html#334">16.2.7.&nbsp;Identifying&nbsp;Available&nbsp;Devices&nbsp;Through&nbsp;the&nbsp;port&nbsp;File..............................................................318<br></a><a href="TLNAGs.html#335">16.2.8.&nbsp;How&nbsp;to&nbsp;Dial&nbsp;a&nbsp;Number&nbsp;Using&nbsp;the&nbsp;dial&nbsp;File..............................................................................319<br></a><a href="TLNAGs.html#336">16.2.9.&nbsp;UUCP&nbsp;Over&nbsp;TCP</a>.....................................................................................................................320<br><a href="TLNAGs.html#337">16.2.10.&nbsp;Using&nbsp;a&nbsp;Direct&nbsp;Connection.....................................................................................................321</a><br>
<a href="TLNAGs.html#338"><b>16.3.&nbsp;Controlling&nbsp;Access&nbsp;to&nbsp;UUCP&nbsp;Features.................................................................................................322</b></a><br>
<a href="TLNAGs.html#338">16.3.1.&nbsp;Command&nbsp;Execution................................................................................................................322<br>16.3.2.&nbsp;File&nbsp;Transfers...........................................................................................................................322<br></a><a href="TLNAGs.html#339">16.3.3.&nbsp;Forwarding...............................................................................................................................323</a><br>
<a href="TLNAGs.html#340"><b>16.4.&nbsp;Setting&nbsp;Up&nbsp;Your&nbsp;System&nbsp;for&nbsp;Dialing&nbsp;In................................................................................................324</b></a><br>
<a href="TLNAGs.html#340">16.4.1.&nbsp;Providing&nbsp;UUCP&nbsp;Accounts......................................................................................................324<br></a><a href="TLNAGs.html#341">16.4.2.&nbsp;Protecting&nbsp;Yourself&nbsp;Against&nbsp;Swindlers....................................................................................325<br>16.4.3.&nbsp;Be&nbsp;Paranoid:&nbsp;Call&nbsp;Sequence&nbsp;Checks........................................................................................325<br></a><a href="TLNAGs.html#342">16.4.4.&nbsp;Anonymous&nbsp;UUCP..................................................................................................................326</a><br>
<a href="TLNAGs.html#343"><b>16.5.&nbsp;UUCP&nbsp;Low−Level&nbsp;Protocols.................................................................................................................327</b></a><br>
<a href="TLNAGs.html#343">16.5.1.&nbsp;Protocol&nbsp;Overview...................................................................................................................327</a><br>
ix<br>
<hr>
<A name=11></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#344">16.5.2.&nbsp;Tuning&nbsp;the&nbsp;Transmission&nbsp;Protocol...........................................................................................328<br></a><a href="TLNAGs.html#345">16.5.3.&nbsp;Selecting&nbsp;Specific&nbsp;Protocols....................................................................................................329</a><br>
<a href="TLNAGs.html#346"><b>16.6.&nbsp;Troubleshooting</b></a><b>.....................................................................................................................................330</b><br>
<a href="TLNAGs.html#346">16.6.1.&nbsp;uucico&nbsp;Keeps&nbsp;Saying&nbsp;Wrong&nbsp;&nbsp;Time&nbsp;to&nbsp;Call&nbsp;..........................................................................330<br>16.6.2.&nbsp;uucico&nbsp;Complains&nbsp;That&nbsp;the&nbsp;Site&nbsp;Is&nbsp;Already&nbsp;Locked................................................................330<br>16.6.3.&nbsp;You&nbsp;Can&nbsp;Connect&nbsp;to&nbsp;the&nbsp;Remote&nbsp;Site,&nbsp;but&nbsp;the&nbsp;Chat&nbsp;Script&nbsp;Fails.............................................330<br></a><a href="TLNAGs.html#347">16.6.4.&nbsp;Your&nbsp;Modem&nbsp;Does&nbsp;Not&nbsp;Dial....................................................................................................331<br>16.6.5.&nbsp;Your&nbsp;Modem&nbsp;Tries&nbsp;to&nbsp;Dial&nbsp;but&nbsp;Doesn't&nbsp;Get&nbsp;Out......................................................................331<br>16.6.6.&nbsp;Login&nbsp;Succeeds,&nbsp;but&nbsp;the&nbsp;Handshake&nbsp;Fails................................................................................331</a><br>
<a href="TLNAGs.html#348"><b>16.7.&nbsp;Log&nbsp;Files&nbsp;and&nbsp;Debugging.......................................................................................................................332</b></a><br>
<a href="TLNAGs.html#349"><b>Chapter&nbsp;17.&nbsp;Electronic&nbsp;Mail...........................................................................................................................333</b></a><br>
<a href="TLNAGs.html#350"><b>17.1.&nbsp;What&nbsp;Is&nbsp;a&nbsp;Mail&nbsp;Message?</b></a><b>......................................................................................................................334</b><br>
<a href="TLNAGs.html#353"><b>17.2.&nbsp;How&nbsp;Is&nbsp;Mail&nbsp;Delivered?.........................................................................................................................337</b></a><br>
<a href="TLNAGs.html#354"><b>17.3.&nbsp;Email&nbsp;Addresses.....................................................................................................................................338</b></a><br>
<a href="TLNAGs.html#354">17.3.1.&nbsp;RFC−822..................................................................................................................................338<br>17.3.2.&nbsp;Obsolete&nbsp;Mail&nbsp;Formats.............................................................................................................338<br>17.3.3.&nbsp;Mixing&nbsp;Different&nbsp;Mail&nbsp;Formats...............................................................................................338</a><br>
<a href="TLNAGs.html#356"><b>17.4.&nbsp;How&nbsp;Does&nbsp;Mail&nbsp;Routing&nbsp;Work?............................................................................................................340</b></a><br>
<a href="TLNAGs.html#356">17.4.1.&nbsp;Mail&nbsp;Routing&nbsp;on&nbsp;the&nbsp;Internet....................................................................................................340<br>17.4.2.&nbsp;Mail&nbsp;Routing&nbsp;in&nbsp;the&nbsp;UUCP&nbsp;World...........................................................................................340<br></a><a href="TLNAGs.html#357">17.4.3.&nbsp;Mixing&nbsp;UUCP&nbsp;and&nbsp;RFC−822</a>..................................................................................................341<br>
<a href="TLNAGs.html#361"><b>17.5.&nbsp;Configuring&nbsp;elm</b></a><b>.....................................................................................................................................345</b><br>
<a href="TLNAGs.html#361">17.5.1.&nbsp;Global&nbsp;elm&nbsp;Options..................................................................................................................345<br>17.5.2.&nbsp;National&nbsp;Character&nbsp;Sets............................................................................................................345</a><br>
<a href="TLNAGs.html#363"><b>Chapter&nbsp;18.&nbsp;Sendmail</b></a><b>.....................................................................................................................................347</b><br>
<a href="TLNAGs.html#364"><b>18.1.&nbsp;Introduction&nbsp;to&nbsp;sendmail.......................................................................................................................348</b></a><br>
<a href="TLNAGs.html#365"><b>18.2.&nbsp;Installing&nbsp;sendmail.................................................................................................................................349</b></a><br>
<a href="TLNAGs.html#366"><b>18.3.&nbsp;Overview&nbsp;of&nbsp;Configuration&nbsp;Files...........................................................................................................350</b></a><br>
<a href="TLNAGs.html#367"><b>18.4.&nbsp;The&nbsp;sendmail.cf&nbsp;and&nbsp;sendmail.mc&nbsp;Files................................................................................................351</b></a><br>
<a href="TLNAGs.html#367">18.4.1.&nbsp;Two&nbsp;Example&nbsp;sendmail.mc&nbsp;Files.............................................................................................351<br></a><a href="TLNAGs.html#368">18.4.2.&nbsp;Typically&nbsp;Used&nbsp;sendmail.mc&nbsp;Parameters.................................................................................352</a><br>
<a href="TLNAGs.html#369">18.4.2.1.&nbsp;Comments................................................................................................................353<br>18.4.2.2.&nbsp;VERSIONID&nbsp;and&nbsp;OSTYPE.....................................................................................353<br>18.4.2.3.&nbsp;DOMAIN.................................................................................................................353<br></a><a href="TLNAGs.html#370">18.4.2.4.&nbsp;FEATURE...............................................................................................................354</a><br>
x<br>
<hr>
<A name=12></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#370">18.4.2.5.&nbsp;Local&nbsp;macro&nbsp;definitions...........................................................................................354<br>18.4.2.6.&nbsp;Defining&nbsp;mail&nbsp;transport&nbsp;protocols............................................................................354<br></a><a href="TLNAGs.html#371">18.4.2.7.&nbsp;Configure&nbsp;mail&nbsp;routing&nbsp;for&nbsp;local&nbsp;hosts.....................................................................355</a><br>
<a href="TLNAGs.html#373"><b>18.5.&nbsp;Generating&nbsp;the&nbsp;sendmail.cf&nbsp;File............................................................................................................357</b></a><br>
<a href="TLNAGs.html#374"><b>18.6.&nbsp;Interpreting&nbsp;and&nbsp;Writing&nbsp;Rewrite&nbsp;Rules</b></a><b>.............................................................................................358</b><br>
<a href="TLNAGs.html#374">18.6.1.&nbsp;sendmail.cf&nbsp;R&nbsp;and&nbsp;S&nbsp;Commands..............................................................................................358<br>18.6.2.&nbsp;Some&nbsp;Useful&nbsp;Macro&nbsp;Definitions..............................................................................................358<br></a><a href="TLNAGs.html#375">18.6.3.&nbsp;The&nbsp;Lefthand&nbsp;Side....................................................................................................................359<br>18.6.4.&nbsp;The&nbsp;Righthand&nbsp;Side</a>.................................................................................................................359<br><a href="TLNAGs.html#377">18.6.5.&nbsp;A&nbsp;Simple&nbsp;Rule&nbsp;Pattern&nbsp;Example..............................................................................................361<br>18.6.6.&nbsp;Ruleset&nbsp;Semantics....................................................................................................................361</a><br>
<a href="TLNAGs.html#378">18.6.6.1.&nbsp;Interpreting&nbsp;the&nbsp;rule&nbsp;in&nbsp;our&nbsp;example........................................................................362</a><br>
<a href="TLNAGs.html#380"><b>18.7.&nbsp;Configuring&nbsp;sendmail&nbsp;Options..............................................................................................................364</b></a><br>
<a href="TLNAGs.html#382"><b>18.8.&nbsp;Some&nbsp;Useful&nbsp;sendmail&nbsp;Configurations.................................................................................................366</b></a><br>
<a href="TLNAGs.html#382">18.8.1.&nbsp;Trusting&nbsp;Users&nbsp;to&nbsp;Set&nbsp;the&nbsp;From:&nbsp;Field......................................................................................366<br>18.8.2.&nbsp;Managing&nbsp;Mail&nbsp;Aliases............................................................................................................366<br></a><a href="TLNAGs.html#383">18.8.3.&nbsp;Using&nbsp;a&nbsp;Smart&nbsp;Host..................................................................................................................367<br></a><a href="TLNAGs.html#384">18.8.4.&nbsp;Managing&nbsp;Unwanted&nbsp;or&nbsp;Unsolicited&nbsp;Mail&nbsp;(Spam)...................................................................368</a><br>
<a href="TLNAGs.html#385">18.8.4.1.&nbsp;The&nbsp;Real−time&nbsp;Blackhole&nbsp;List.................................................................................369<br>18.8.4.2.&nbsp;The&nbsp;access&nbsp;database.................................................................................................369<br></a><a href="TLNAGs.html#387">18.8.4.3.&nbsp;Barring&nbsp;users&nbsp;from&nbsp;receiving&nbsp;mail...........................................................................371</a><br>
<a href="TLNAGs.html#387">18.8.5.&nbsp;Configuring&nbsp;Virtual&nbsp;Email&nbsp;Hosting</a>.........................................................................................371<br>
<a href="TLNAGs.html#387">18.8.5.1.&nbsp;Accepting&nbsp;mail&nbsp;for&nbsp;other&nbsp;domains...........................................................................371<br></a><a href="TLNAGs.html#388">18.8.5.2.&nbsp;Forwarding&nbsp;virtual−hosted&nbsp;mail&nbsp;to&nbsp;other&nbsp;destinations.............................................372</a><br>
<a href="TLNAGs.html#390"><b>18.9.&nbsp;Testing&nbsp;Your&nbsp;Configuration..................................................................................................................374</b></a><br>
<a href="TLNAGs.html#394"><b>18.10.&nbsp;Running&nbsp;sendmail................................................................................................................................378</b></a><br>
<a href="TLNAGs.html#395"><b>18.11.&nbsp;Tips&nbsp;and&nbsp;Tricks....................................................................................................................................379</b></a><br>
<a href="TLNAGs.html#395">18.11.1.&nbsp;Managing&nbsp;the&nbsp;Mail&nbsp;Spool</a>......................................................................................................379<br><a href="TLNAGs.html#395">18.11.2.&nbsp;Forcing&nbsp;a&nbsp;Remote&nbsp;Host&nbsp;to&nbsp;Process&nbsp;its&nbsp;Mail&nbsp;Queue................................................................379<br></a><a href="TLNAGs.html#396">18.11.3.&nbsp;Analyzing&nbsp;Mail&nbsp;Statistics.......................................................................................................380</a><br>
<a href="TLNAGs.html#396">18.11.3.1.&nbsp;mailstats.................................................................................................................380<br></a><a href="TLNAGs.html#397">18.11.3.2.&nbsp;hoststat...................................................................................................................381</a><br>
<a href="TLNAGs.html#398"><b>Chapter&nbsp;19.&nbsp;Getting&nbsp;EximUp&nbsp;and&nbsp;Running..................................................................................................382</b></a><br>
<a href="TLNAGs.html#399"><b>19.1.&nbsp;Running&nbsp;Exim.........................................................................................................................................383</b></a><br>
<a href="TLNAGs.html#401"><b>19.2.&nbsp;If&nbsp;Your&nbsp;Mail&nbsp;Doesn't&nbsp;Get&nbsp;Through.......................................................................................................385</b></a><br>
<a href="TLNAGs.html#402"><b>19.3.&nbsp;Compiling&nbsp;Exim</b></a><b>.....................................................................................................................................386</b><br>
xi<br>
<hr>
<A name=13></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#403"><b>19.4.&nbsp;Mail&nbsp;Delivery&nbsp;Modes..............................................................................................................................387</b></a><br>
<a href="TLNAGs.html#405"><b>19.5.&nbsp;Miscellaneous&nbsp;config&nbsp;Options................................................................................................................389</b></a><br>
<a href="TLNAGs.html#406"><b>19.6.&nbsp;Message&nbsp;Routing&nbsp;and&nbsp;Delivery</b></a><b>.............................................................................................................390</b><br>
<a href="TLNAGs.html#406">19.6.1.&nbsp;Routing&nbsp;Messages....................................................................................................................390<br>19.6.2.&nbsp;Delivering&nbsp;Messages&nbsp;to&nbsp;Local&nbsp;Addresses................................................................................390</a><br>
<a href="TLNAGs.html#407">19.6.2.1.&nbsp;Local&nbsp;users...............................................................................................................391<br>19.6.2.2.&nbsp;Forwarding...............................................................................................................391</a><br>
<a href="TLNAGs.html#408">19.6.3.&nbsp;Alias&nbsp;Files................................................................................................................................392<br></a><a href="TLNAGs.html#409">19.6.4.&nbsp;Mailing&nbsp;Lists............................................................................................................................393</a><br>
<a href="TLNAGs.html#410"><b>19.7.&nbsp;Protecting&nbsp;Against&nbsp;Mail&nbsp;Spam..............................................................................................................394</b></a><br>
<a href="TLNAGs.html#411"><b>19.8.&nbsp;UUCP&nbsp;Setup............................................................................................................................................395</b></a><br>
<a href="TLNAGs.html#412"><b>Chapter&nbsp;20.&nbsp;Netnews.......................................................................................................................................396</b></a><br>
<a href="TLNAGs.html#413"><b>20.1.&nbsp;Usenet&nbsp;History........................................................................................................................................397</b></a><br>
<a href="TLNAGs.html#414"><b>20.2.&nbsp;What&nbsp;Is&nbsp;Usenet,&nbsp;Anyway?</b></a><b>.....................................................................................................................398</b><br>
<a href="TLNAGs.html#416"><b>20.3.&nbsp;How&nbsp;Does&nbsp;Usenet&nbsp;Handle&nbsp;News?..........................................................................................................400</b></a><br>
<a href="TLNAGs.html#418"><b>Chapter&nbsp;21.&nbsp;C&nbsp;News........................................................................................................................................402</b></a><br>
<a href="TLNAGs.html#419"><b>21.1.&nbsp;Delivering&nbsp;News......................................................................................................................................403</b></a><br>
<a href="TLNAGs.html#421"><b>21.2.&nbsp;Installation..............................................................................................................................................405</b></a><br>
<a href="TLNAGs.html#423"><b>21.3.&nbsp;The&nbsp;sys&nbsp;File</b></a><b>.............................................................................................................................................407</b><br>
<a href="TLNAGs.html#426"><b>21.4.&nbsp;The&nbsp;active&nbsp;File........................................................................................................................................410</b></a><br>
<a href="TLNAGs.html#428"><b>21.5.&nbsp;Article&nbsp;Batching</b></a><b>.....................................................................................................................................412</b><br>
<a href="TLNAGs.html#431"><b>21.6.&nbsp;Expiring&nbsp;News........................................................................................................................................415</b></a><br>
<a href="TLNAGs.html#433"><b>21.7.&nbsp;Miscellaneous&nbsp;Files.................................................................................................................................417</b></a><br>
<a href="TLNAGs.html#435"><b>21.8.&nbsp;Control&nbsp;Messages...................................................................................................................................419</b></a><br>
<a href="TLNAGs.html#435">21.8.1.&nbsp;The&nbsp;cancel&nbsp;Message.................................................................................................................419<br>21.8.2.&nbsp;newgroup&nbsp;and&nbsp;rmgroup............................................................................................................419<br>21.8.3.&nbsp;The&nbsp;checkgroups&nbsp;Message.......................................................................................................419<br></a><a href="TLNAGs.html#437">21.8.4.&nbsp;sendsys,&nbsp;version,&nbsp;and&nbsp;senduuname...........................................................................................421</a><br>
<a href="TLNAGs.html#438"><b>21.9.&nbsp;C&nbsp;News&nbsp;in&nbsp;an&nbsp;NFS&nbsp;Environment...........................................................................................................422</b></a><br>
xii<br>
<hr>
<A name=14></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#439"><b>21.10.&nbsp;Maintenance&nbsp;Tools&nbsp;and&nbsp;Tasks.............................................................................................................423</b></a><br>
<a href="TLNAGs.html#441"><b>Chapter&nbsp;22.&nbsp;NNTP&nbsp;and&nbsp;thenntpd&nbsp;Daemon...................................................................................................425</b></a><br>
<a href="TLNAGs.html#443"><b>22.1.&nbsp;The&nbsp;NNTP&nbsp;Protocol................................................................................................................................427</b></a><br>
<a href="TLNAGs.html#443">22.1.1.&nbsp;Connecting&nbsp;to&nbsp;the&nbsp;News&nbsp;Server................................................................................................427<br>22.1.2.&nbsp;Pushing&nbsp;a&nbsp;News&nbsp;Article&nbsp;onto&nbsp;a&nbsp;Server.....................................................................................427<br></a><a href="TLNAGs.html#444">22.1.3.&nbsp;Changing&nbsp;to&nbsp;NNRP&nbsp;Reader&nbsp;Mode............................................................................................428<br></a><a href="TLNAGs.html#445">22.1.4.&nbsp;Listing&nbsp;Available&nbsp;Groups.........................................................................................................429<br>22.1.5.&nbsp;Listing&nbsp;Active&nbsp;Groups..............................................................................................................429<br></a><a href="TLNAGs.html#446">22.1.6.&nbsp;Posting&nbsp;an&nbsp;Article.....................................................................................................................430<br>22.1.7.&nbsp;Listing&nbsp;New&nbsp;Articles................................................................................................................430<br>22.1.8.&nbsp;Selecting&nbsp;a&nbsp;Group&nbsp;on&nbsp;Which&nbsp;to&nbsp;Operate..................................................................................430<br></a><a href="TLNAGs.html#447">22.1.9.&nbsp;Listing&nbsp;Articles&nbsp;in&nbsp;a&nbsp;Group......................................................................................................431<br>22.1.10.&nbsp;Retrieving&nbsp;an&nbsp;Article&nbsp;Header&nbsp;Only........................................................................................431<br></a><a href="TLNAGs.html#448">22.1.11.&nbsp;Retrieving&nbsp;an&nbsp;Article&nbsp;Body&nbsp;Only...........................................................................................432<br>22.1.12.&nbsp;Reading&nbsp;an&nbsp;Article&nbsp;from&nbsp;a&nbsp;Group...........................................................................................432</a><br>
<a href="TLNAGs.html#450"><b>22.2.&nbsp;Installing&nbsp;the&nbsp;NNTP&nbsp;Server...................................................................................................................434</b></a><br>
<a href="TLNAGs.html#451"><b>22.3.&nbsp;Restricting&nbsp;NNTP&nbsp;Access</b></a><b>......................................................................................................................435</b><br>
<a href="TLNAGs.html#453"><b>22.4.&nbsp;NNTP&nbsp;Authorization..............................................................................................................................437</b></a><br>
<a href="TLNAGs.html#454"><b>22.5.&nbsp;nntpd&nbsp;Interaction&nbsp;with&nbsp;C&nbsp;News.............................................................................................................438</b></a><br>
<a href="TLNAGs.html#455"><b>Chapter&nbsp;23.&nbsp;Internet&nbsp;News.............................................................................................................................439</b></a><br>
<a href="TLNAGs.html#456"><b>23.1.&nbsp;Some&nbsp;INN&nbsp;Internals...............................................................................................................................440</b></a><br>
<a href="TLNAGs.html#458"><b>23.2.&nbsp;Newsreaders&nbsp;and&nbsp;INN............................................................................................................................442</b></a><br>
<a href="TLNAGs.html#459"><b>23.3.&nbsp;Installing&nbsp;INN.........................................................................................................................................443</b></a><br>
<a href="TLNAGs.html#460"><b>23.4.&nbsp;Configuring&nbsp;INN:&nbsp;the&nbsp;Basic&nbsp;Setup........................................................................................................444</b></a><br>
<a href="TLNAGs.html#461"><b>23.5.&nbsp;INN&nbsp;Configuration&nbsp;Files........................................................................................................................445</b></a><br>
<a href="TLNAGs.html#461">23.5.1.&nbsp;Global&nbsp;Parameters....................................................................................................................445</a><br>
<a href="TLNAGs.html#461">23.5.1.1.&nbsp;The&nbsp;inn.conf&nbsp;file.......................................................................................................445</a><br>
<a href="TLNAGs.html#462">23.5.2.&nbsp;Configuring&nbsp;Newsgroups.........................................................................................................446</a><br>
<a href="TLNAGs.html#463">23.5.2.1.&nbsp;The&nbsp;active&nbsp;and&nbsp;newsgroups&nbsp;files..............................................................................447</a><br>
<a href="TLNAGs.html#464">23.5.3.&nbsp;Configuring&nbsp;Newsfeeds...........................................................................................................448</a><br>
<a href="TLNAGs.html#465">23.5.3.1.&nbsp;The&nbsp;newsfeeds&nbsp;file...................................................................................................449<br></a><a href="TLNAGs.html#467">23.5.3.2.&nbsp;The&nbsp;nntpsend.ctl&nbsp;file................................................................................................451</a><br>
<a href="TLNAGs.html#468">23.5.4.&nbsp;Controlling&nbsp;Newsreader&nbsp;Access...............................................................................................452</a><br>
<a href="TLNAGs.html#468">23.5.4.1.&nbsp;The&nbsp;incoming.conf&nbsp;file.............................................................................................452<br></a><a href="TLNAGs.html#470">23.5.4.2.&nbsp;The&nbsp;nnrp.access&nbsp;file.................................................................................................454</a><br>
<a href="TLNAGs.html#471">23.5.5.&nbsp;Expiring&nbsp;News&nbsp;Articles............................................................................................................455</a><br>
xiii<br>
<hr>
<A name=15></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#471">23.5.5.1.&nbsp;The&nbsp;expire.ctl&nbsp;file.....................................................................................................455</a><br>
<a href="TLNAGs.html#472">23.5.6.&nbsp;Handling&nbsp;Control&nbsp;Messages.....................................................................................................456</a><br>
<a href="TLNAGs.html#473">23.5.6.1.&nbsp;The&nbsp;control.ctl&nbsp;file....................................................................................................457</a><br>
<a href="TLNAGs.html#476"><b>23.6.&nbsp;Running&nbsp;INN..........................................................................................................................................460</b></a><br>
<a href="TLNAGs.html#477"><b>23.7.&nbsp;Managing&nbsp;INN:&nbsp;The&nbsp;ctlinnd&nbsp;Command...............................................................................................461</b></a><br>
<a href="TLNAGs.html#477">23.7.1.&nbsp;Add&nbsp;a&nbsp;New&nbsp;Group....................................................................................................................461<br>23.7.2.&nbsp;Change&nbsp;a&nbsp;Group.......................................................................................................................461<br></a><a href="TLNAGs.html#478">23.7.3.&nbsp;Remove&nbsp;a&nbsp;Group......................................................................................................................462<br>23.7.4.&nbsp;Renumber&nbsp;a&nbsp;Group...................................................................................................................462<br>23.7.5.&nbsp;Allow/Disallow&nbsp;Newsreaders..................................................................................................462<br></a><a href="TLNAGs.html#479">23.7.6.&nbsp;Reject&nbsp;Newsfeed&nbsp;Connections.................................................................................................463<br>23.7.7.&nbsp;Allow&nbsp;Newsfeed&nbsp;Connections..................................................................................................463<br>23.7.8.&nbsp;Disable&nbsp;News&nbsp;Server................................................................................................................463<br></a><a href="TLNAGs.html#480">23.7.9.&nbsp;Restart&nbsp;News&nbsp;Server.................................................................................................................464<br>23.7.10.&nbsp;Display&nbsp;Status&nbsp;of&nbsp;a&nbsp;Newsfeed................................................................................................464<br>23.7.11.&nbsp;Drop&nbsp;a&nbsp;Newsfeed....................................................................................................................464<br></a><a href="TLNAGs.html#481">23.7.12.&nbsp;Begin&nbsp;a&nbsp;Newsfeed..................................................................................................................465<br>23.7.13.&nbsp;Cancel&nbsp;an&nbsp;Article....................................................................................................................465</a><br>
<a href="TLNAGs.html#482"><b>Chapter&nbsp;24.&nbsp;Newsreader&nbsp;Configuration........................................................................................................466</b></a><br>
<a href="TLNAGs.html#483"><b>24.1.&nbsp;tin&nbsp;Configuration....................................................................................................................................467</b></a><br>
<a href="TLNAGs.html#484"><b>24.2.&nbsp;trn&nbsp;Configuration...................................................................................................................................468</b></a><br>
<a href="TLNAGs.html#485"><b>24.3.&nbsp;nn&nbsp;Configuration....................................................................................................................................469</b></a><br>
<a href="TLNAGs.html#487"><b>Appendix&nbsp;A.&nbsp;Example&nbsp;Network:The&nbsp;Virtual&nbsp;Brewery................................................................................471</b></a><br>
<a href="TLNAGs.html#488"><b>A.1.&nbsp;Connecting&nbsp;the&nbsp;Virtual&nbsp;Subsidiary&nbsp;Network........................................................................................472</b></a><br>
<a href="TLNAGs.html#489"><b>Appendix&nbsp;B.&nbsp;Useful&nbsp;Cable&nbsp;Configurations....................................................................................................473</b></a><br>
<a href="TLNAGs.html#490"><b>B.1.&nbsp;A&nbsp;PLIP&nbsp;Parallel&nbsp;Cable.............................................................................................................................474</b></a><br>
<a href="TLNAGs.html#491"><b>B.2.&nbsp;A&nbsp;Serial&nbsp;NULL&nbsp;Modem&nbsp;Cable................................................................................................................475</b></a><br>
<a href="TLNAGs.html#492"><b>Appendix&nbsp;C.&nbsp;Linux&nbsp;Network&nbsp;Administrator's&nbsp;Guide,&nbsp;Second&nbsp;Edition&nbsp;Copyright&nbsp;Information..............476</b></a><br>
<a href="TLNAGs.html#493"><b>C.1.&nbsp;0.&nbsp;Preamble..............................................................................................................................................477</b></a><br>
<a href="TLNAGs.html#494"><b>C.2.&nbsp;1.&nbsp;Applicability&nbsp;and&nbsp;Definitions</b></a><b>.............................................................................................................478</b><br>
<a href="TLNAGs.html#495"><b>C.3.&nbsp;2.&nbsp;Verbatim&nbsp;Copying...............................................................................................................................479</b></a><br>
<a href="TLNAGs.html#496"><b>C.4.&nbsp;3.&nbsp;Copying&nbsp;in&nbsp;Quantity............................................................................................................................480</b></a><br>
xiv<br>
<hr>
<A name=16></a>Linux Network Administrators Guide<br>
<b>Table of Contents</b><br>
<a href="TLNAGs.html#497"><b>C.5.&nbsp;4.&nbsp;Modifications.......................................................................................................................................481</b></a><br>
<a href="TLNAGs.html#499"><b>C.6.&nbsp;5.&nbsp;Combining&nbsp;Documents.......................................................................................................................483</b></a><br>
<a href="TLNAGs.html#500"><b>C.7.&nbsp;6.&nbsp;Collections&nbsp;of&nbsp;Documents...................................................................................................................484</b></a><br>
<a href="TLNAGs.html#501"><b>C.8.&nbsp;7.&nbsp;Aggregation&nbsp;with&nbsp;Independent&nbsp;Works..............................................................................................485</b></a><br>
<a href="TLNAGs.html#502"><b>C.9.&nbsp;8.&nbsp;Translation...........................................................................................................................................486</b></a><br>
<a href="TLNAGs.html#503"><b>C.10.&nbsp;9.&nbsp;Termination.......................................................................................................................................487</b></a><br>
<a href="TLNAGs.html#504"><b>C.11.&nbsp;10.&nbsp;Future&nbsp;Revisions&nbsp;of&nbsp;this&nbsp;License....................................................................................................488</b></a><br>
<a href="TLNAGs.html#505"><b>Appendix&nbsp;D.&nbsp;SAGE:&nbsp;The&nbsp;SystemAdministrators&nbsp;Guild..............................................................................489</b></a><br>
xv<br>
<hr>
<A name=17></a><b>1. Purpose and Audience for This Book</b><br>
This book was written to provide a single reference for network administration in a Linux environment.<br>Beginners and experienced users alike should find the information they need to cover nearly all important<br>administration activities required to manage a Linux network configuration. The possible range of topics to<br>cover is nearly limitless, so of course it has been impossible to include everything there is to say on all<br>subjects. We've tried to cover the most important and common ones. We've found that beginners to Linux<br>networking, even those with no prior exposure to Unix−like operating systems, have found this book good<br>enough to help them successfully get their Linux network configurations up and running and get them ready<br>to learn more.<br>
There are many books and other sources of information from which you can learn any of the topics covered<br>in this book (with the possible exception of some of the truly Linux−specific features, such as the new Linux<br>firewall interface, which is not well documented elsewhere) in greater depth. We've provided a bibliography<br>for you to use when you are ready to explore more.<br>
1. Purpose and Audience for This Book<br>
1<br>
<hr>
<A name=18></a><b>2. Sources of Information</b><br>
&nbsp;If you are new to the world of Linux, there are a number of resources to explore and become familiar with.<br>Having access to the Internet is helpful, but not essential.<br>
<i>Linux Documentation Project guides</i><br>
&nbsp;The Linux Documentation Project is a group of volunteers who have worked to produce books<br>(guides), HOWTO documents, and manual pages on topics ranging from installation to kernel<br>programming. The LDP works include:<br>
<i>Linux Installation and Getting Started</i><br>
By Matt Welsh, et al. This book describes how to obtain, install, and use Linux. It includes an<br>introductory Unix tutorial and information on systems administration, the X Window System, and<br>networking.<br>
<i>Linux System Administrators Guide</i><br>
By Lars Wirzenius and Joanna Oja. This book is a guide to general Linux system administration and<br>covers topics such as creating and configuring users, performing system backups, configuration of<br>major software packages, and installing and upgrading software.<br>
<i>Linux System Adminstration Made Easy</i><br>
By Steve Frampton. This book describes day−to−day administration and maintenance issues of<br>relevance to Linux users.<br>
<i>Linux Programmers Guide</i><br>
By B. Scott Burkett, Sven Goldt, John D. Harper, Sven van der Meer, and Matt Welsh. This book<br>covers topics of interest to people who wish to develop application software for Linux.<br>
<i>The Linux Kernel</i><br>
By David A. Rusling. This book provides an introduction to the Linux Kernel, how it is constructed,<br>and how it works. Take a tour of your kernel.<br>
<i>The Linux Kernel Module Programming Guide</i><br>
By Ori Pomerantz. This guide explains how to write Linux kernel modules.<br>
More manuals are in development. For more information about the LDP you should consult their World<br>Wide Web server at http://www.linuxdoc.org/ or one of its many mirrors.<br>
<i>HOWTO documents</i><br>
&nbsp;The Linux HOWTOs are a comprehensive series of papers detailing various aspects of the systemsuch as<br>installation and configuration of the X Window System software, or how to write in assembly language<br>programming under Linux. These are generally located in the&nbsp;HOWTO&nbsp;subdirectory of the FTP sites listed<br>
2. Sources of Information<br>
2<br>
<hr>
<A name=19></a>Linux Network Administrators Guide<br>
later, or they are available on the World Wide Web at one of the many Linux Documentation Project mirror<br>sites. See the Bibliography at the end of this book, or the file&nbsp;HOWTO−INDEX&nbsp;for a list of what's available.<br>
You might want to obtain the&nbsp;<i>Installation HOWTO</i>, which describes how to install Linux on your system; the<br><i>Hardware Compatibility HOWTO</i>, which contains a list of hardware known to work with Linux; and the<br><i>Distribution HOWTO</i>, which lists software vendors selling Linux on diskette and CD−ROM.<br>
The bibliography of this book includes references to the HOWTO documents that are related to Linux<br>networking.<br>
<i>Linux Frequently Asked Questions</i><br>
The&nbsp;<i>Linux Frequently Asked Questions with Answers</i>&nbsp;(FAQ) contains a wide assortment of questions and<br>answers about the system. It is a must−read for all newcomers.<br>
<b>2.1. Documentation Available via FTP</b><br>
&nbsp;If you have access to anonymous FTP, you can obtain all Linux documentation listed above from various<br>sites, including metalab.unc.edu:/pub/Linux/docs and tsx−11.mit.edu:/pub/linux/docs.<br>
These sites are mirrored by a number of sites around the world.<br>
<b>2.2. Documentation Available via WWW</b><br>
There are many Linux−based WWW sites available. The home site for the Linux Documentation Project can<br>be accessed at http://www.linuxdoc.org/.<br>
&nbsp;The Open Source Writers Guild (OSWG) is a project that has a scope that extends beyond Linux. The<br>OSWG, like this book, is committed to advocating and facilitating the production of OpenSource<br>documentation. The OSWG home site is at http://www.oswg.org:8080/oswg.<br>
Both of these sites contain hypertext (and other) versions of many Linux related documents.<br>
<b>2.3. Documentation Available Commercially</b><br>
A number of publishing companies and software vendors publish the works of the Linux Documentation<br>Project. Two such vendors are:<br>
Specialized Systems Consultants, Inc. (SSC)&nbsp;<br>http://www.ssc.com/&nbsp;<br>P.O. Box 55549 Seattle, WA 98155−0549&nbsp;<br>1−206−782−7733&nbsp;<br>1−206−782−7191 (FAX)&nbsp;<br>sales@ssc.com<br>
and:<br>
2.1. Documentation Available via FTP<br>
3<br>
<hr>
<A name=20></a>Linux Network Administrators Guide<br>
Linux Systems Labs<br>http://www.lsl.com/<br>18300 Tara Drive<br>Clinton Township, MI 48036<br>1−810−987−8807<br>1−810−987−3562 (FAX)<br>sales@lsl.com<br>
Both companies sell compendiums of Linux HOWTO documents and other Linux documentation in printed<br>and bound form.<br>
&nbsp;O'Reilly &amp; Associates publishes a series of Linux books. This one is a work of the Linux Documentation<br>Project, but most have been independently authored. Their range includes:<br>
<i>Running Linux</i><br>
An installation and user guide to the system describing how to get the most out of personal<br>computing with Linux.<br>
<i>Learning Debian GNU/Linux, Learning Red Hat Linux</i><br>
More basic than&nbsp;<i>Running Linux</i>, these books contain popular distributions on CD−ROM and offer<br>robust directions for setting them up and using them.<br>
<i>Linux in a Nutshell</i><br>
Another in the successful &quot;in a Nutshell&quot; series, this book focuses on providing a broad reference text<br>for Linux.<br>
<b>2.4. Linux Journal and Linux Magazine</b><br>
<i>Linux Journal</i>&nbsp;and&nbsp;<i>Linux Magazine</i>&nbsp;are monthly magazines for the Linux community, written and published<br>by a number of Linux activists. They contain articles ranging from novice questions and answers to kernel<br>programming internals. Even if you have Usenet access, these magazines are a good way to stay in touch<br>with the Linux community.<br>
<i>Linux Journal</i>&nbsp;is the oldest magazine and is published by S.S.C. Incorporated, for which details were listed<br>previously. You can also find the magazine on the World Wide Web at http://www.linuxjournal.com/.<br>
<i>Linux Magazine</i>&nbsp;is a newer, independent publication. The home web site for the magazine is<br>http://www.linuxmagazine.com/.<br>
<b>2.5. Linux Usenet Newsgroups</b><br>
If you have access to Usenet news, the following Linux−related newsgroups are available:<br>
2.4. Linux Journal and Linux Magazine<br>
4<br>
<hr>
<A name=21></a>Linux Network Administrators Guide<br>
<i>comp.os.linux.announce</i><br>
A moderated newsgroup containing announcements of new software, distributions, bug reports, and<br>goings−on in the Linux community. All Linux users should read this group. Submissions may be<br>mailed to linux−announce@news.ornl.gov.<br>
<i>comp.os.linux.help</i><br>
General questions and answers about installing or using Linux.<br>
<i>comp.os.linux.admin</i><br>
Discussions relating to systems administration under Linux.<br>
<i>comp.os.linux.networking</i><br>
Discussions relating to networking with Linux.<br>
<i>comp.os.linux.development</i><br>
Discussions about developing the Linux kernel and system itself.<br>
<i>comp.os.linux.misc</i><br>
A catch−all newsgroup for miscellaneous discussions that don't fall under the previous categories.<br>
There are also several newsgroups devoted to Linux in languages other than English, such as<br>fr.comp.os.linux in French and de.comp.os.linux in German.<br>
<b>2.6. Linux Mailing Lists</b><br>
There is a large number of specialist Linux mailing lists on which you will find many people willing to help<br>with questions you might have.<br>
The best−known of these are the lists hosted by Rutgers University. You may subscribe to these lists by<br>sending an email message formatted as follows:<br>
To: majordomo@vger.rutgers.edu<br>
Subject: anything at all<br>
Body:<br>
subscribe&nbsp;<i>listname</i><br>
Some of the available lists related to Linux networking are:<br>
<i>linux−net</i><br>
Discussion relating to Linux networking<br>
<i>linux−ppp</i><br>
2.6. Linux Mailing Lists<br>
5<br>
<hr>
<A name=22></a>Linux Network Administrators Guide<br>
Discussion relating to the Linux PPP implementation<br>
<i>linux−kernel</i><br>
Discussion relating to Linux kernel development<br>
<b>2.7. Online Linux Support</b><br>
There are many ways of obtaining help online, where volunteers from around the world offer expertise and<br>services to assist users with questions and problems.<br>
&nbsp;The OpenProjects IRC Network is an IRC network devoted entirely to Open ProjectsOpen Source and<br>Open Hardware alike. Some of its channels are designed to provide online Linux support services. IRC stands<br>for Internet Relay Chat, and is a network service that allows you to talk interactively on the Internet to other<br>users. IRC networks support multiple channels on which groups of people talk. Whatever you type in a<br>channel is seen by all other users of that channel.<br>
There are a number of active channels on the OpenProjects IRC network where you will find users 24 hours a<br>day, 7 days a week who are willing and able to help you solve any Linux problems you may have, or just<br>chat. You can use this service by installing an IRC client like&nbsp;<i>irc−II</i>, connecting to servername<br>irc.openprojects.org:6667, and joining the&nbsp;#linpeople&nbsp;channel.<br>
<b>2.8. Linux User Groups</b><br>
&nbsp;Many Linux User Groups around the world offer direct support to users. Many Linux User Groups engage<br>in activities such as installation days, talks and seminars, demonstration nights, and other completely social<br>events. Linux User Groups are a great way of meeting other Linux users in your area. There are a number of<br>published lists of Linux User Groups. Some of the better−known ones are:<br>
<i>Groups of Linux Users Everywhere</i><br>
http://www.ssc.com/glue/groups/<br>
<i>LUG list project</i><br>
http://www.nllgg.nl/lugww/<br>
<i>LUG registry</i><br>
http://www.linux.org/users/<br>
2.7. Online Linux Support<br>
6<br>
<hr>
<A name=23></a>Linux Network Administrators Guide<br>
<b>2.9. Obtaining Linux</b><br>
&nbsp;There is no single distribution of the Linux software; instead, there are many distributions, such as Debian,<br>RedHat, Caldera, Corel, SuSE, and Slackware. Each distribution contains everything you need to run a<br>complete Linux system: the kernel, basic utilities, libraries, support files, and applications software.<br>
Linux distributions may be obtained via a number of online sources, such as the Internet. Each of the major<br>distributions has its own FTP and web site. Some of these sites are:<br>
<i>Caldera</i><br>
http://www.caldera.com/ftp://ftp.caldera.com/<br>
<i>Corel</i><br>
http://www.corel.com/ftp://ftp.corel.com/<br>
<i>Debian</i><br>
http://www.debian.org/ftp://ftp.debian.org/<br>
<i>RedHat</i><br>
http://www.redhat.com/ftp://ftp.redhat.com/<br>
<i>Slackware</i><br>
http://www.slackware.com/ftp://ftp.slackware.com/<br>
<i>SuSE</i><br>
http://www.suse.com/ftp://ftp.suse.com/<br>
Many of the popular general FTP archive sites also mirror various Linux distributions. The best−known of<br>these sites are:<br>
metalab.unc.edu:/pub/Linux/distributions/<br>ftp.funet.fi:/pub/Linux/mirrors/<br>tsx−11.mit.edu:/pub/linux/distributions/<br>mirror.aarnet.edu.au:/pub/linux/distributions/<br>
Many of the modern distributions can be installed directly from the Internet. There is a lot of software to<br>download for a typical installation, though, so you'd probably want to do this only if you have a high−speed,<br>permanent network connection, or if you just need to update an existing installation.[1]<br>
Linux may be purchased on CD−ROM from an increasing number of software vendors. If your local<br>computer store doesn't have it, perhaps you should ask them to stock it! Most of the popular distributions can<br>be obtained on CD−ROM. Some vendors produce products containing multiple CD−ROMs, each of which<br>provides a different Linux distribution. This is an ideal way to try a number of different distributions before<br>you settle on your favorite one.<br>
2.9. Obtaining Linux<br>
7<br>
<hr>
<A name=24></a>Linux Network Administrators Guide<br>
2.9. Obtaining Linux<br>
8<br>
<hr>
<A name=25></a><b>3. File System Standards</b><br>
In the past, one of the problems that afflicted Linux distributions, as well as the packages of software running<br>on Linux, was the lack of a single accepted filesystem layout. This resulted in incompatibilities between<br>different packages, and confronted users and administrators with the task of locating various files and<br>programs.<br>
To improve this situation, in August 1993, several people formed the Linux File System Standard Group<br>(FSSTND). After six months of discussion, the group created a draft that presents a coherent file sytem<br>structure and defines the location of the most essential programs and configuration files.<br>
This standard was supposed to have been implemented by most major Linux distributions and packages. It is<br>a little unfortunate that, while most distributions have made some attempt to work toward the FSSTND, there<br>is a very small number of distributions that has actually adopted it fully. Throughout this book, we will<br>assume that any files discussed reside in the location specified by the standard; alternative locations will be<br>mentioned only when there is a long tradition that conflicts with this specification.<br>
The Linux FSSTND continued to develop, but was replaced by the Linux File Hierarchy Standard (FHS) in<br>1997. The FHS addresses the multi−architecture issues that the FSSTND did not. The FHS can be obtained<br>from the Linux documentation directory of all major Linux FTP sites and their mirrors, or at its home site at<br>http://www.pathname.com/fhs/. Daniel Quinlan, the coordinator of the FHS group, can be reached at<br>quinlan@transmeta.com.<br>
3. File System Standards<br>
9<br>
<hr>
<A name=26></a><b>4. Standard Linux Base</b><br>
The vast number of different Linux distributions, while providing lots of healthy choice for Linux users, has<br>created a problem for software developersparticularly developers of non−free software.<br>
Each distribution packages and supplies certain base libraries, configuration tools, system applications, and<br>configuration files. Unfortunately, differences in their versions, names, and locations make it very difficult to<br>know what will exist on any distribution. This makes it hard to develop binary applications that will work<br>reliably on all Linux distribution bases.<br>
To help overcome this problem, a new project sprang up called the Linux Standard Base. It aims to<br>describe a standard base distribution that complying distributions will use. If a developer designs an<br>application to work against the standard base platform, the application will work, and be portable to, any<br>complying Linux distribution.<br>
You can find information on the status of the Linux Standard Base project at its home web site at<br>http://www.linuxbase.org/.<br>
If you're concerned about interoperability, particularly of software from commercial vendors, you should<br>ensure that your Linux distribution is making an effort to participate in the standardization project.<br>
4. Standard Linux Base<br>
10<br>
<hr>
<A name=27></a><b>5. About This Book</b><br>
When Olaf joined the Linux Documentation Project in 1992, he wrote two small chapters on UUCP and<br><b>smail</b>, which he meant to contribute to the System Administrator's Guide. Development of TCP/IP<br>networking was just beginning, and when those small chapters started to grow, he wondered aloud<br>whether it would be nice to have a Networking Guide. Great! everyone said. Go for it! So he went for it<br>and wrote the first version of the Networking Guide, which was released in September 1993.<br>
Olaf continued work on the Networking Guide and eventually produced a much enhanced version of the<br>guide. Vince Skahan contributed the original&nbsp;<b>sendmail</b>&nbsp;mail chapter, which was completely replaced in this<br>edition because of a new interface to the&nbsp;<b>sendmail</b>&nbsp;configuration.<br>
The version of the guide that you are reading now is a revision and update prompted by O'Reilly &amp;<br>Associates and undertaken by Terry Dawson.[2]&nbsp;Terry has been an amateur radio operator for over 20 years<br>and has worked in the telecommunications industry for over 15 of those. He was co−author of the original<br>NET−FAQ, and has since authored and maintained various networking−related HOWTO documents. Terry<br>has always been an enthusiastic supporter of the Network Administrators Guide project, and added a few new<br>chapters to this version describing features of Linux networking that have been developed since the first<br>edition, plus a bunch of changes to bring the rest of the book up to date.<br>
The&nbsp;<b>exim&nbsp;</b>&nbsp;chapter was contributed by Philip Hazel,[3]&nbsp;who is a lead developer and maintainer of the<br>package.<br>
The book is organized roughly along the sequence of steps you have to take to configure your system for<br>networking. It starts by discussing basic concepts of networks, and TCP/IP−based networks in particular. It<br>then slowly works its way up from configuring TCP/IP at the device level to firewall, accounting, and<br>masquerade configuration, to the setup of common applications such as&nbsp;<b>rlogin</b>&nbsp;and friends, the Network File<br>System, and the Network Information System. This is followed by a chapter on how to set up your machine<br>as a UUCP node. Most of the remaining sections is dedicated to two major applications that run on top of<br>TCP/IP and UUCP: electronic mail and news. A special chapter has been devoted to the IPX protocol and the<br>NCP filesystem, because these are used in many corporate environments where Linux is finding a home.<br>
The email part features an introduction to the more intimate parts of mail transport and routing, and the<br>myriad of addressing schemes you may be confronted with. It describes the configuration and management of<br><b>exim</b>, a mail transport agent ideal for use in most situations not requiring UUCP, and&nbsp;<b>sendmail</b>, which is for<br>people who have to do more complicated routing involving UUCP.<br>
The news part gives you an overview of how Usenet news works. It covers INN and C News, the two most<br>widely used news transport software packages at the moment, and the use of NNTP to provide newsreading<br>access to a local network. The book closes with a chapter on the care and feeding of the most popular<br>newsreaders on Linux.<br>
Of course, a book can never exhaustively answer all questions you might have. So if you follow the<br>instructions in this book and something still does not work, please be patient. Some of your problems may be<br>due to mistakes on our part (see the section&nbsp;<a href="TLNAGs.html#34">Section 9</a>&quot;, later in this Preface), but they also may be caused by<br>changes in the networking software. Therefore, you should check the listed information resources first.<br>There's a good chance that you are not alone with your problems, so a fix or at least a proposed workaround<br>is likely to be known. If you have the opportunity, you should also try to get the latest kernel and network<br>release from one of the Linux FTP sites or a BBS near you. Many problems are caused by software from<br>different stages of development, which fail to work together properly. After all, Linux is a work in<br>
5. About This Book<br>
11<br>
<hr>
<A name=28></a>Linux Network Administrators Guide<br>
progress.<br>
5. About This Book<br>
12<br>
<hr>
<A name=29></a><b>6. The Official Printed Version</b><br>
In Autumn 1993, Andy Oram, who had been around the LDP mailing list from almost the very beginning,<br>asked Olaf about publishing this book at O'Reilly &amp; Associates. He was excited about this book, never<br>having imagined that it would become this successful. He and Andy finally agreed that O'Reilly would<br>produce an enhanced Official Printed Version of the Networking Guide, while Olaf retained the original<br>copyright so that the source of the book could be freely distributed. This means that you can choose freely:<br>you can get the various free forms of the document from your nearest Linux Documentation Project mirror<br>site and print it out, or you can purchase the official printed version from O'Reilly.<br>
Why, then, would you want to pay money for something you can get for free? Is Tim O'Reilly out of his mind<br>for publishing something everyone can print and even sell themselves?[4]&nbsp;Is there any difference between<br>these versions?<br>
The answers are it depends, no, definitely not, and yes and no. O'Reilly &amp; Associates does take a<br>risk in publishing the Networking Guide, and it seems to have paid off for them (they've asked us to do it<br>again). We believe this project serves as a fine example of how the free software world and companies can<br>cooperate to produce something both can benefit from. In our view, the great service O'Reilly is providing to<br>the Linux community (apart from the book becoming readily available in your local bookstore) is that it has<br>helped Linux become recognized as something to be taken seriously: a viable and useful alternative to other<br>commercial operating systems. It's a sad technical bookstore that doesn't have at least one shelf stacked with<br>O'Reilly Linux books.<br>
Why are they publishing it? They see it as their kind of book. It's what they'd hope to produce if they<br>contracted with an author to write about Linux. The pace, level of detail, and style fit in well with their other<br>offerings.<br>
The point of the LDP license is to make sure no one gets shut out. Other people can print out copies of this<br>book, and no one will blame you if you get one of these copies. But if you haven't gotten a chance to see the<br>O'Reilly version, try to get to a bookstore or look at a friend's copy. We think you'll like what you see, and<br>will want to buy it for yourself.<br>
So what about the differences between the printed and online versions? Andy Oram has made great efforts at<br>transforming our ramblings into something actually worth printing. (He has also reviewed a few other books<br>produced by the Linux Documentation Project, contributing whatever professional skills he can to the Linux<br>community.)<br>
Since Andy started reviewing the Networking Guide and editing the copies sent to him, the book has<br>improved vastly from its original form, and with every round of submission and feedback it improves again.<br>The opportunity to take advantage of a professional editor's skill is one not to be wasted. In many ways,<br>Andy's contribution has been as important as that of the authors. The same is also true of the copyeditors,<br>who got the book into the shape you see now. All these edits have been fed back into the online version, so<br>there is no difference in content.<br>
Still, the O'Reilly version&nbsp;<i>will</i>&nbsp;be different. It will be professionally bound, and while you may go to the<br>trouble to print the free version, it is unlikely that you will get the same quality result, and even then it is<br>more unlikely that you'll do it for the price. Secondly, our amateurish attempts at illustration will have been<br>replaced with nicely redone figures by O'Reilly's professional artists. Indexers have generated an improved<br>index, which makes locating information in the book a much simpler process. If this book is something you<br>intend to read from start to finish, you should consider reading the official printed version.<br>
6. The Official Printed Version<br>
13<br>
<hr>
<A name=30></a>Linux Network Administrators Guide<br>
6. The Official Printed Version<br>
14<br>
<hr>
<A name=31></a><b>7. Overview</b><br>
<a href="TLNAGs.html#37">Chapter 1</a>, discusses the history of Linux and covers basic networking information on UUCP, TCP/IP,<br>various protocols, hardware, and security. The next few chapters deal with configuring Linux for TCP/IP<br><a href="TLNAGs.html#52">networking and running some major applications. We examine IP a little more closely in&nbsp;Chapter 2</a>, before<br>getting our hands dirty with file editing and the like. If you already know how IP routing works and how<br>address resolution is performed, you can skip this chapter.<br>
<a href="TLNAGs.html#64">Chapter 3</a>, deals with very basic configuration issues, such as building a kernel and setting up your Ethernet<br>card. The configuration of your serial ports is covered separately in&nbsp;<a href="TLNAGs.html#82">Chapter 4, because the discussion does<br></a>not apply to TCP/IP networking only, but is also relevant for UUCP.<br>
<a href="TLNAGs.html#97">Chapter 5</a>, helps you set up your machine for TCP/IP networking. It contains installation hints for standalone<br>hosts with loopback enabled only, and hosts connected to an Ethernet. It also introduces you to a few useful<br><a href="TLNAGs.html#120">tools you can use to test and debug your setup.&nbsp;Chapter 6</a>, discusses how to configure hostname resolution<br>and explains how to set up a name server.<br>
<a href="TLNAGs.html#148">Chapter 7</a>, explains how to establish SLIP connections and gives a detailed reference for&nbsp;<b>dip</b>, a tool that<br><a href="TLNAGs.html#162">allows you to automate most of the necessary steps.&nbsp;Chapter 8</a>, covers PPP and&nbsp;<b>pppd</b>, the PPP daemon.<br>
<a href="TLNAGs.html#183">Chapter 9</a>, extends our discussion on network security and describes the Linux TCP/IP firewall and its<br>configuration tools:&nbsp;<b>ipfwadm</b>,&nbsp;<b>ipchains</b>, and&nbsp;<b>iptables</b>. IP firewalling provides a means of controlling who<br>can access your network and hosts very precisely.<br>
<a href="TLNAGs.html#230">Chapter 10, explains how to configure IP Accounting in Linux so you can keep track of how much traffic is<br></a>going where and who is generating it.<br>
<a href="TLNAGs.html#243">Chapter 11, covers a feature of the Linux networking software called IP masquerade, which allows whole IP<br></a>networks to connect to and use the Internet through a single IP address, hiding internal systems from<br>outsiders in the process.<br>
<a href="TLNAGs.html#253">Chapter 12, gives a short introduction to setting up some of the most important network applications, such as<br></a><b>rlogin</b>,&nbsp;<b>ssh</b>, etc. This chapter also covers how services are managed by the&nbsp;<b>inetd</b>&nbsp;superuser, and how you may<br>restrict certain security−relevant services to a set of trusted hosts.<br>
<a href="TLNAGs.html#270">Chapter 13, and&nbsp;</a><a href="TLNAGs.html#287">Chapter 14</a>, discuss NIS and NFS. NIS is a tool used to distribute administative information,<br>such as user passwords in a local area network. NFS allows you to share filesystems between several hosts in<br>your network.<br>
In&nbsp;<a href="TLNAGs.html#299">Chapter 15, we discuss the IPX protocol and the NCP filesystem. These allow Linux to be integrated into a<br></a>Novell NetWare environment, sharing files and printers with non−Linux machines.<br>
<a href="TLNAGs.html#320">Chapter 16, gives you an extensive introduction to the administration of Taylor UUCP, a free implementation<br></a>of the UUCP suite.<br>
<a href="TLNAGs.html#349">The remainder of the book is taken up by a detailed tour of electronic mail and Usenet news.&nbsp;Chapter 17,<br></a>introduces you to the central concepts of electronic mail, like what a mail address looks like, and how the<br>mail handling system manages to get your message to the recipient.<br>
7. Overview<br>
15<br>
<hr>
<A name=32></a>Linux Network Administrators Guide<br>
<a href="TLNAGs.html#363">Chapter 18, and&nbsp;</a><a href="TLNAGs.html#398">Chapter 19</a>, cover the configuration of&nbsp;<b>sendmail</b>&nbsp;and&nbsp;<b>exim</b>, two mail transport agents you<br>can use for Linux. This book explains both of them, because&nbsp;<b>exim</b>&nbsp;is easier to install for the beginner, while<br><b>sendmail</b>&nbsp;provides support for UUCP.<br>
<a href="TLNAGs.html#412">Chapter 20</a>, through&nbsp;<a href="TLNAGs.html#455">Chapter 23</a>, explain the way news is managed in Usenet and how you install and use C<br>
News,&nbsp;<b>nntpd</b>, and INN: three popular software packages for managing Usenet news. After the brief<br>introduction in&nbsp;<a href="TLNAGs.html#412">Chapter 20</a>, you can read&nbsp;<a href="TLNAGs.html#418">Chapter 21</a>, if you want to transfer news using C News, a traditional<br>service generally used with UUCP. The following chapters discuss more modern alternatives to C News that<br>use the Internet−based protocol NNTP (Network News Transfer Protocol).&nbsp;<a href="TLNAGs.html#441">Chapter 22</a>&nbsp;covers how to set up a<br>simple NNTP daemon,&nbsp;<b>nntpd</b><a href="TLNAGs.html#455">, to provide news reading access for a local network, while&nbsp;Chapter<br>23</a>&nbsp;describes a more robust server for more extensive NetNews transfers, the InterNet News daemon (INN).<br>And finally,&nbsp;<a href="TLNAGs.html#482">Chapter 24, shows you how to configure and maintain various newsreaders.</a><br>
7. Overview<br>
16<br>
<hr>
<A name=33></a><b>8. Conventions Used in This Book</b><br>
All examples presented in this book assume you are using a&nbsp;<b>sh</b>&nbsp;compatible shell. The&nbsp;<b>bash</b>&nbsp;shell is<br><b>sh</b>&nbsp;compatible and is the standard shell of all Linux distributions. If you happen to be a&nbsp;<b>csh</b>&nbsp;user, you will<br>have to make appropriate adjustments.<br>
The following is a list of the typographical conventions used in this book:<br>
<i>Italic</i><br>
Used for file and directory names, program and command names, command−line options, email<br>addresses and pathnames, URLs, and for emphasizing new terms.<br>
<i>Boldface</i><br>
Used for machine names, hostnames, site names, usernames and IDs, and for occasional emphasis.<br>
<i>Constant Width</i><br>
Used in examples to show the contents of code files or the output from commands and to indicate<br>environment variables and keywords that appear in code.<br>
<i>Constant Width Italic</i><br>
Used to indicate variable options, keywords, or text that the user is to replace with an actual value.<br>
<i><b>Constant Width Bold</b></i><br>
Used in examples to show commands or other text that should be typed literally by the user.<br>
<b>Warning</b><br>
Text appearing in this manner offers a warning. You can make a mistake here that hurts your system or is<br>hard to recover from.<br>
8. Conventions Used in This Book<br>
17<br>
<hr>
<A name=34></a><b>9. Submitting Changes</b><br>
We have tested and verified the information in this book to the best of our ability, but you may find that<br>features have changed (or even that we have made mistakes!). Please let us know about any errors you find,<br>as well as your suggestions for future editions, by writing to:<br>
O'Reilly &amp; Associates, Inc.<br>101 Morris Street<br>Sebastopol, CA 95472<br>1−800−998−9938 (in the U.S. or Canada)<br>1−707−829−0515 (international or local)<br>1−707−829−0104 (FAX)<br>
You can send us messages electronically. To be put on the mailing list or request a catalog, send email to:<br>
<i>info@oreilly.com</i><br>
To ask technical questions or comment on the book, send email to:<br>
<i>bookquestions@oreilly.com</i><br>
We have a web site for the book, where we'll list examples, errata, and any plans for future editions. You can<br>access this page at:<br>
<i>http://www.oreilly.com/catalog/linag2</i><br>
For more information about this book and others, see the O'Reilly web site:<br>
<i>http://www.oreilly.com</i><br>
9. Submitting Changes<br>
18<br>
<hr>
<A name=35></a><b>10. Acknowledgments</b><br>
This edition of the Networking Guide owes almost everything to the outstanding work of Olaf and Vince. It<br>is difficult to appreciate the effort that goes into researching and writing a book of this nature until you've had<br>a chance to work on one yourself. Updating the book was a challenging task, but with an excellent base to<br>work from, it was an enjoyable one.<br>
This book owes very much to the numerous people who took the time to proof−read it and help iron out many<br>mistakes, both technical and grammatical (never knew that there was such a thing as a dangling participle).<br>Phil Hughes, John Macdonald, and Erik Ratcliffe all provided very helpful (and on the whole, quite<br>consistent) feedback on the content of the book.<br>
We also owe many thanks to the people at O'Reilly we've had the pleasure to work with: Sarah Jane<br>Shangraw, who got the book into the shape you can see now; Maureen Dempsey, who copyedited the text;<br>Rob Romano, Rhon Porter, and Chris Reilley, who created all the figures; Hanna Dyer, who designed the<br>cover; Alicia Cech, David Futato, and Jennifer Niedherst for the internal layout; Lars Kaufman for suggesting<br>old woodcuts as a visual theme; Judy Hoer for the index; and finally, Tim O'Reilly for the courage to take up<br>such a project.<br>
We are greatly indebted to Andres Sepúlveda, Wolfgang Michaelis, Michael K. Johnson, and all developers<br>who spared the time to check the information provided in the Networking Guide. Phil Hughes, John<br>MacDonald, and Eric Ratcliffe contributed invaluable comments on the second edition. We also wish to<br>thank all those who read the first version of the Networking Guide and sent corrections and suggestions. You<br>can find a hopefully complete list of contributors in the file&nbsp;Thanks&nbsp;in the online distribution. Finally, this<br>book would not have been possible without the support of Holger Grothe, who provided Olaf with the<br>Internet connectivity he needed to make the original version happen.<br>
Olaf would also like to thank the following groups and companies that printed the first edition of the<br>Networking Guide and have donated money either to him or to the Linux Documentation Project as a whole:<br>Linux Support Team, Erlangen, Germany; S.u.S.E. GmbH, Fuerth, Germany; and Linux System Labs, Inc.,<br>Clinton Twp., United States, RedHat Software, North Carolina, United States.<br>
Terry thanks his wife, Maggie, who patiently supported him throughout his participation in the project<br>despite the challenges presented by the birth of their first child, Jack. Additionally, he thanks the&nbsp;<i>many</i>&nbsp;people<br>of the Linux community who either nurtured or suffered him to the point at which he could actually take part<br>and actively contribute. I'll help you if you promise to help someone else in return.<br>
<b>10.1. The Hall of Fame</b><br>
Besides those we have already mentioned, a large number of people have contributed to the Networking<br>Guide, by reviewing it and sending us corrections and suggestions. We are very grateful.<br>
Here is a list of those whose contributions left a trace in our mail folders.<br>
Al Longyear, Alan Cox, Andres Sepúlveda, Ben Cooper, Cameron Spitzer, Colin McCormack, D.J. Roberts,<br>Emilio Lopes, Fred N. van Kempen, Gert Doering, Greg Hankins, Heiko Eissfeldt, J.P. Szikora, Johannes<br>Stille, Karl Eichwalder, Les Johnson, Ludger Kunz, Marc van Diest, Michael K. Johnson, Michael Nebel,<br>Michael Wing, Mitch D'Souza, Paul Gortmaker, Peter Brouwer, Peter Eriksson, Phil Hughes, Raul Deluth<br>
10. Acknowledgments<br>
19<br>
<hr>
<A name=36></a>Linux Network Administrators Guide<br>
Miller, Rich Braun, Rick Sladkey, Ronald Aarts, Swen Thüemmler, Terry Dawson, Thomas Quinot, and<br>Yury Shevchuk.<br>
10. Acknowledgments<br>
20<br>
<hr>
<A name=37></a><b>Chapter 1. Introduction to Networking</b><br>
Chapter 1. Introduction to Networking<br>
21<br>
<hr>
<A name=38></a><b>1.1. History</b><br>
The idea of networking is probably as old as telecommunications itself. Consider people living in the Stone<br>Age, when drums may have been used to transmit messages between individuals. Suppose caveman A wants<br>to invite caveman B over for a game of hurling rocks at each other, but they live too far apart for B to hear A<br>banging his drum. What are A's options? He could 1) walk over to B's place, 2) get a bigger drum, or 3) ask<br>C, who lives halfway between them, to forward the message. The last option is called&nbsp;<i>networking</i>.<br>
Of course, we have come a long way from the primitive pursuits and devices of our forebears. Nowadays, we<br>have computers talk to each other over vast assemblages of wires, fiber optics, microwaves, and the like, to<br>make an appointment for Saturday's soccer match.[5]&nbsp;In the following description, we will deal with the<br>means and ways by which this is accomplished, but leave out the wires, as well as the soccer part.<br>
We will describe three types of networks in this guide. We will focus on TCP/IP most heavily because it is<br>the most popular protocol suite in use on both Local Area Networks (LANs) and Wide Area Networks<br>(WANs), such as the Internet. We will also take a look at UUCP and IPX. UUCP was once commonly used<br>to transport news and mail messages over dialup telephone connections. It is less common today, but is still<br>useful in a variety of situations. The IPX protocol is used most commonly in the Novell NetWare<br>environment and we'll describe how to use it to connect your Linux machine into a Novell network. Each of<br>these protocols are networking protocols and are used to carry data between host computers. We'll discuss<br>how they are used and introduce you to their underlying principles.<br>
&nbsp;We define a network as a collection of&nbsp;<i>hosts</i>&nbsp;that are able to communicate with each other, often by relying<br>on the services of a number of dedicated hosts that relay data between the participants. Hosts are often<br>computers, but need not be; one can also think of X terminals or intelligent printers as hosts. Small<br>agglomerations of hosts are also called&nbsp;<i>sites</i>.<br>
&nbsp;Communication is impossible without some sort of language or code. In computer networks, these<br>languages are collectively referred to as&nbsp;<i>protocols</i>. However, you shouldn't think of written protocols here,<br>but rather of the highly formalized code of behavior observed when heads of state meet, for instance. In a<br>very similar fashion, the protocols used in computer networks are nothing but very strict rules for the<br>exchange of messages between two or more hosts.<br>
1.1. History<br>
22<br>
<hr>
<A name=39></a><b>1.2. TCP/IP Networks</b><br>
&nbsp;Modern networking applications require a sophisticated approach to carrying data from one machine to<br>another. If you are managing a Linux machine that has many users, each of whom may wish to<br>simultaneously connect to remote hosts on a network, you need a way of allowing them to share your<br>network connection without interfering with each other. The approach that a large number of modern<br>networking protocols uses is called&nbsp;<i>packet−switching</i>. A&nbsp;<i>packet</i>&nbsp;is a small chunk of data that is transferred<br>from one machine to another across the network. The switching occurs as the datagram is carried across each<br>link in the network. A packet−switched network shares a single network link among many users by<br>alternately sending packets from one user to another across that link.<br>
The solution that Unix systems, and subsequently many non−Unix systems, have adopted is known as<br>TCP/IP. When talking about TCP/IP networks you will hear the term&nbsp;<i>datagram</i>, which technically has a<br>special meaning but is often used interchangeably with&nbsp;<i>packet</i>. In this section, we will have a look at<br>underlying concepts of the TCP/IP protocols.<br>
<b>1.2.1. Introduction to TCP/IP Networks</b><br>
&nbsp;TCP/IP traces its origins to a research project funded by the United States Defense Advanced Research<br>Projects Agency (DARPA) in 1969. The ARPANET was an experimental network that was converted into an<br>operational one in 1975 after it had proven to be a success.<br>
&nbsp;In 1983, the new protocol suite TCP/IP was adopted as a standard, and all hosts on the network were<br>required to use it. When ARPANET finally grew into the Internet (with ARPANET itself passing out of<br>existence in 1990), the use of TCP/IP had spread to networks beyond the Internet itself. Many companies<br>have now built corporate TCP/IP networks, and the Internet has grown to a point at which it could almost be<br>considered a mainstream consumer technology. It is difficult to read a newspaper or magazine now without<br>seeing reference to the Internet; almost everyone can now use it.<br>
&nbsp;For something concrete to look at as we discuss TCP/IP throughout the following sections, we will<br>consider Groucho Marx University (GMU), situated somewhere in Fredland, as an example. Most<br>departments run their own Local Area Networks, while some share one and others run several of them. They<br>are all interconnected and hooked to the Internet through a single high−speed link.<br>
Suppose your Linux box is connected to a LAN of Unix hosts at the Mathematics department, and its name<br>is erdos. To access a host at the Physics department, say quark, you enter the following command:<br>
$&nbsp;<b>rlogin quark.physics</b><br>
Welcome to the Physics Department at GMU<br>
(ttyq2) login:<br>
At the prompt, you enter your login name, say andres, and your password. You are then given a shell[6]&nbsp;on<br>quark, to which you can type as if you were sitting at the system's console. After you exit the shell, you are<br>returned to your own machine's prompt. You have just used one of the instantaneous, interactive applications<br>that TCP/IP provides: remote login.<br>
&nbsp;While being logged into quark, you might also want to run a graphical user interface application, like a<br>word processing program, a graphics drawing program, or even a World Wide Web browser. The X windows<br>system is a fully network−aware graphical user environment, and it is available for many different computing<br>
1.2. TCP/IP Networks<br>
23<br>
<hr>
<A name=40></a>Linux Network Administrators Guide<br>
systems. To tell this application that you want to have its windows displayed on your host's screen, you have<br>to set the DISPLAY environment variable:<br>
$&nbsp;<b>DISPLAY=erdos.maths:0.0</b><br>
$&nbsp;<b>export DISPLAY</b><br>
If you now start your application, it will contact your X server instead of quark's, and display all its windows<br>on your screen. Of course, this requires that you have X11 runnning on erdos. The point here is that TCP/IP<br>allows quark and erdos to send X11 packets back and forth to give you the illusion that you're on a single<br>system. The network is almost transparent here.<br>
Another very important application in TCP/IP networks is NFS, which stands for&nbsp;<i>Network File System</i>. It is<br>another form of making the network transparent, because it basically allows you to treat directory hierarchies<br>from other hosts as if they were local file systems and look like any other directories on your host. For<br>example, all users' home directories can be kept on a central server machine from which all other hosts on the<br>LAN mount them. The effect is that users can log in to any machine and find themselves in the same home<br>directory. Similarly, it is possible to share large amounts of data (such as a database, documentation or<br>application programs) among many hosts by maintaining one copy of the data on a server and allowing other<br>hosts to access it. We will come back to NFS in&nbsp;<a href="TLNAGs.html#287">Chapter 14</a>.<br>
Of course, these are only examples of what you can do with TCP/IP networks. The possibilities are almost<br>limitless, and we'll introduce you to more as you read on through the book.<br>
We will now have a closer look at the way TCP/IP works. This information will help you understand how<br>and why you have to configure your machine. We will start by examining the hardware, and slowly work our<br>way up.<br>
<b>1.2.2. Ethernets</b><br>
&nbsp;The most common type of LAN hardware is known as&nbsp;<i>Ethernet</i>. In its simplest form, it consists of a single<br>cable with hosts attached to it through connectors, taps, or transceivers. Simple Ethernets are relatively<br>inexpensive to install, which together with a net transfer rate of 10, 100, or even 1,000 Megabits per second,<br>accounts for much of its popularity.<br>
&nbsp;Ethernets come in three flavors:&nbsp;<i>thick</i>,&nbsp;<i>thin</i>, and&nbsp;<i>twisted pair</i>. Thin and thick Ethernet each use a coaxial<br>cable, differing in diameter and the way you may attach a host to this cable. Thin Ethernet uses a T−shaped<br>BNC connector, which you insert into the cable and twist onto a plug on the back of your computer. Thick<br>Ethernet requires that you drill a small hole into the cable, and attach a transceiver using a vampire tap.<br>One or more hosts can then be connected to the transceiver. Thin and thick Ethernet cable can run for a<br>maximum of 200 and 500 meters respectively, and are also called 10base−2 and 10base−5. The base refers<br>to baseband modulation and simply means that the data is directly fed onto the cable without any modem.<br>The number at the start refers to the speed in Megabits per second, and the number at the end is the maximum<br>length of the cable in hundreds of metres. Twisted pair uses a cable made of two pairs of copper wires and<br>usually requires additional hardware known as&nbsp;<i>active hubs</i>. Twisted pair is also known as 10base−T, the T<br>meaning twisted pair. The 100 Megabits per second version is known as 100base−T.<br>
To add a host to a thin Ethernet installation, you have to disrupt network service for at least a few minutes<br>because you have to cut the cable to insert the connector. Although adding a host to a thick Ethernet system is<br>a little complicated, it does not typically bring down the network. Twisted pair Ethernet is even simpler. It<br>
1.2.2. Ethernets<br>
24<br>
<hr>
<A name=41></a>Linux Network Administrators Guide<br>
uses a device called a hub, which serves as an interconnection point. You can insert and remove hosts<br>from a hub without interrupting any other users at all.<br>
Many people prefer thin Ethernet for small networks because it is very inexpensive; PC cards come for as<br>little as US $30 (many companies are literally throwing them out now), and cable is in the range of a few<br>cents per meter. However, for large−scale installations, either thick Ethernet or twisted pair is more<br>appropriate. For example, the Ethernet at GMU's Mathematics Department originally chose thick Ethernet<br>because it is a long route that the cable must take so traffic will not be disrupted each time a host is added to<br>the network. Twisted pair installations are now very common in a variety of installations. The Hub hardware<br>is dropping in price and small units are now available at a price that is attractive to even small domestic<br>networks. Twisted pair cabling can be significantly cheaper for large installations, and the cable itself is much<br>more flexible than the coaxial cables used for the other Ethernet systems. The network administrators in<br>GMU's mathematics department are planning to replace the existing network with a twisted pair network in<br>the coming finanical year because it will bring them up to date with current technology and will save them<br>significant time when installing new host computers and moving existing computers around.<br>
One of the drawbacks of Ethernet technology is its limited cable length, which precludes any use of it other<br>than for LANs. However, several Ethernet segments can be linked to one another using repeaters, bridges, or<br>routers. Repeaters simply copy the signals between two or more segments so that all segments together will<br>act as if they are one Ethernet. Due to timing requirements, there may not be more than four repeaters<br>between any two hosts on the network. Bridges and routers are more sophisticated. They analyze incoming<br>data and forward it only when the recipient host is not on the local Ethernet.<br>
&nbsp;Ethernet works like a bus system, where a host may send packets (or&nbsp;<i>frames</i>) of up to 1,500 bytes to<br>another host on the same Ethernet. A host is addressed by a six−byte address hardcoded into the firmware of<br>its Ethernet network interface card (NIC). These addresses are usually written as a sequence of two−digit hex<br>numbers separated by colons, as in aa:bb:cc:dd:ee:ff.<br>
&nbsp;A frame sent by one station is seen by all attached stations, but only the destination host actually picks it up<br>and processes it. If two stations try to send at the same time, a&nbsp;<i>collision</i>&nbsp;occurs. Collisions on an Ethernet are<br>detected very quickly by the electronics of the interface cards and are resolved by the two stations aborting<br>the send, each waiting a random interval and re−attempting the transmission. You'll hear lots of stories about<br>collisions on Ethernet being a problem and that utilization of Ethernets is only about 30 percent of the<br>available bandwidth because of them. Collisions on Ethernet are a&nbsp;<i>normal</i>&nbsp;phenomenon, and on a very busy<br>Ethernet network you shouldn't be surprised to see collision rates of up to about 30 percent. Utilization of<br>Ethernet networks is more realistically limited to about 60 percent before you need to start worrying about<br>it.[7]<br>
<b>1.2.3. Other Types of Hardware</b><br>
In larger installations, such as Groucho Marx University, Ethernet is usually not the only type of equipment<br>used. There are many other data communications protocols available and in use. All of the protocols listed are<br>supported by Linux, but due to space constraints we'll describe them briefly. Many of the protocols have<br>HOWTO documents that describe them in detail, so you should refer to those if you're interested in exploring<br>those that we don't describe in this book.<br>
&nbsp;At Groucho Marx University, each department's LAN is linked to the campus high−speed backbone<br>network, which is a fiber optic cable running a network technology called&nbsp;<i>Fiber Distributed Data<br>Interface</i>&nbsp;(FDDI). FDDI uses an entirely different approach to transmitting data, which basically involves<br>
1.2.3. Other Types of Hardware<br>
25<br>
<hr>
<A name=42></a>Linux Network Administrators Guide<br>
sending around a number of&nbsp;<i>tokens</i>, with a station being allowed to send a frame only if it captures a token.<br>The main advantage of a token−passing protocol is a reduction in collisions. Therefore, the protocol can more<br>easily attain the full speed of the transmission medium, up to 100 Mbps in the case of FDDI. FDDI, being<br>based on optical fiber, offers a significant advantage because its maximum cable length is much greater than<br>wire−based technologies. It has limits of up to around 200 km, which makes it ideal for linking many<br>buildings in a city, or as in GMU's case, many buildings on a campus.<br>
&nbsp;Similarly, if there is any IBM computing equipment around, an IBM Token Ring network is quite likely to<br>be installed. Token Ring is used as an alternative to Ethernet in some LAN environments, and offers the same<br>sorts of advantages as FDDI in terms of achieving full wire speed, but at lower speeds (4 Mbps or 16 Mbps),<br>and lower cost because it is based on wire rather than fiber. In Linux, Token Ring networking is configured in<br>almost precisely the same way as Ethernet, so we don't cover it specifically.<br>
Although it is much less likely today than in the past, other LAN technologies, such as ArcNet and DECNet,<br>might be installed. Linux supports these too, but we don't cover them here.<br>
&nbsp;Many national networks operated by Telecommunications companies support packet switching protocols.<br>Probably the most popular of these is a standard named X.25. Many Public Data Networks, like Tymnet in<br>the U.S., Austpac in Australia, and Datex−P in Germany offer this service. X.25 defines a set of networking<br>protocols that describes how data terminal equipment, such as a host, communicates with data<br>communications equipment (an X.25 switch). X.25 requires a synchronous data link, and therefore special<br>synchronous serial port hardware. It is possible to use X.25 with normal serial ports if you use a special<br>device called a PAD (Packet Assembler Disassembler). The PAD is a standalone device that provides<br>asynchronous serial ports and a synchronous serial port. It manages the X.25 protocol so that simple terminal<br>devices can make and accept X.25 connections. X.25 is often used to carry other network protocols, such as<br>TCP/IP. Since IP datagrams cannot simply be mapped onto X.25 (or vice versa), they are encapsulated in<br>X.25 packets and sent over the network. There is an experimental implementation of the X.25 protocol<br>available for Linux.<br>
&nbsp;A more recent protocol commonly offered by telecommunications companies is called&nbsp;<i>Frame Relay</i>. The<br>Frame Relay protocol shares a number of technical features with the X.25 protocol, but is much more like the<br>IP protocol in behavior. Like X.25, Frame Relay requires special synchronous serial hardware. Because of<br>their similarities, many cards support both of these protocols. An alternative is available that requires no<br>special internal hardware, again relying on an external device called a Frame Relay Access Device (FRAD)<br>to manage the encapsulation of Ethernet packets into Frame Relay packets for transmission across a network.<br>Frame Relay is ideal for carrying TCP/IP between sites. Linux provides drivers that support some types of<br>internal Frame Relay devices.<br>
&nbsp;If you need higher speed networking that can carry many different types of data, such as digitized voice<br>and video, alongside your usual data, ATM (Asynchronous Transfer Mode) is probably what you'll be<br>interested in. ATM is a new network technology that has been specifically designed to provide a manageable,<br>high−speed, low−latency means of carrying data, and provide control over the Quality of Service (Q.S.).<br>Many telecommunications companies are deploying ATM network infrastructure because it allows the<br>convergence of a number of different network services into one platform, in the hope of achieving savings in<br>management and support costs. ATM is often used to carry TCP/IP. The Networking−HOWTO offers<br>information on the Linux support available for ATM.<br>
&nbsp;Frequently, radio amateurs use their radio equipment to network their computers; this is commonly called<br><i>packet radio</i>. One of the protocols used by amateur radio operators is called AX.25 and is loosely derived<br>from X.25. Amateur radio operators use the AX.25 protocol to carry TCP/IP and other protocols, too. AX.25,<br>like X.25, requires serial hardware capable of synchronous operation, or an external device called a<br>
1.2.3. Other Types of Hardware<br>
26<br>
<hr>
<A name=43></a><IMG src="TLNAG-43_1.png"><br>
Linux Network Administrators Guide<br>
Terminal Node Controller to convert packets transmitted via an asynchronous serial link into packets<br>transmitted synchronously. There are a variety of different sorts of interface cards available to support packet<br>radio operation; these cards are generally referred to as being Z8530 SCC based, and are named after the<br>most popular type of communications controller used in the designs. Two of the other protocols that are<br>commonly carried by AX.25 are the NetRom and Rose protocols, which are network layer protocols. Since<br>these protocols run over AX.25, they have the same hardware requirements. Linux supports a fully featured<br>implementation of the AX.25, NetRom, and Rose protocols. The AX25−HOWTO is a good source of<br>information on the Linux implementation of these protocols.<br>
Other types of Internet access involve dialing up a central system over slow but cheap serial lines (telephone,<br>ISDN, and so on). These require yet another protocol for transmission of packets, such as SLIP or PPP, which<br>will be described later.<br>
<b>1.2.4. The Internet Protocol</b><br>
&nbsp;Of course, you wouldn't want your networking to be limited to one Ethernet or one point−to−point data<br>link. Ideally, you would want to be able to communicate with a host computer regardless of what type of<br>physical network it is connected to. For example, in larger installations such as Groucho Marx University,<br>you usually have a number of separate networks that have to be connected in some way. At GMU, the Math<br>department runs two Ethernets: one with fast machines for professors and graduates, and another with slow<br>machines for students. Both are linked to the FDDI campus backbone network.<br>
&nbsp;This connection is handled by a dedicated host called a&nbsp;<i>gateway</i>&nbsp;that handles incoming and outgoing<br>packets by copying them between the two Ethernets and the FDDI fiber optic cable. For example, if you are<br>at the Math department and want to access quark on the Physics department's LAN from your Linux box, the<br>networking software will not send packets to quark directly because it is not on the same Ethernet. Therefore,<br>it has to rely on the gateway to act as a forwarder. The gateway (named sophus) then forwards these packets<br>to its peer gateway niels at the Physics department, using the backbone network, with niels delivering it to the<br>destination machine. Data flow between erdos and quark is shown in&nbsp;<a href="TLNAGs.html#43">Figure 1−1</a>.<br>
<b>Figure 1−1. The three steps of sending a datagram from erdos to quark</b><br>
1.2.4. The Internet Protocol<br>
27<br>
<hr>
<A name=44></a>Linux Network Administrators Guide<br>
&nbsp;This scheme of directing data to a remote host is called&nbsp;<i>routing</i>, and packets are often referred to as<br><i>datagrams</i>&nbsp;in this context. To facilitate things, datagram exchange is governed by a single protocol that is<br>independent of the hardware used: IP, or&nbsp;<i>Internet Protocol</i>. In&nbsp;<a href="TLNAGs.html#52">Chapter 2, we will cover IP and the issues of<br></a>routing in greater detail.<br>
&nbsp;The main benefit of IP is that it turns physically dissimilar networks into one apparently homogeneous<br>network. This is called internetworking, and the resulting meta−network is called an&nbsp;<i>internet</i>. Note the<br>subtle difference here between&nbsp;<i>an</i>&nbsp;internet and&nbsp;<i>the</i>&nbsp;Internet. The latter is the official name of one particular<br>global internet.<br>
&nbsp;Of course, IP also requires a hardware−independent addressing scheme. This is achieved by assigning each<br>host a unique 32−bit number called the&nbsp;<i>IP address</i>. An IP address is usually written as four decimal numbers,<br>one for each 8−bit portion, separated by dots. For example, quark might have an IP address of 0x954C0C04,<br>which would be written as 149.76.12.4. This format is also called&nbsp;<i>dotted decimal notation</i>&nbsp;and sometimes<br><i>dotted quad notation</i>. It is increasingly going under the name IPv4 (for Internet Protocol, Version 4) because<br>a new standard called IPv6 offers much more flexible addressing, as well as other modern features. It will be<br>at least a year after the release of this edition before IPv6 is in use.<br>
&nbsp;You will notice that we now have three different types of addresses: first there is the host's name, like<br>quark, then there are IP addresses, and finally, there are hardware addresses, like the 6−byte Ethernet address.<br>All these addresses somehow have to match so that when you type&nbsp;<b>rlogin quark</b>, the networking software<br>can be given quark's IP address; and when IP delivers any data to the Physics department's Ethernet, it<br>somehow has to find out what Ethernet address corresponds to the IP address.<br>
We will deal with these situations in&nbsp;<a href="TLNAGs.html#52">Chapter 2. For now, it's enough to remember that these steps of finding<br></a>addresses are called&nbsp;<i>hostname resolution</i>, for mapping hostnames onto IP addresses, and&nbsp;<i>address resolution</i>,<br>for mapping the latter to hardware addresses.<br>
<b>1.2.5. IP Over Serial Lines</b><br>
&nbsp;On serial lines, a de facto standard exists known as SLIP, or&nbsp;<i>Serial Line IP</i>. A modification of SLIP<br>known as CSLIP, or&nbsp;<i>Compressed SLIP</i>, performs compression of IP headers to make better use of the<br>relatively low bandwidth provided by most serial links. Another serial protocol is PPP, or the&nbsp;<i>Point−to−Point<br>Protocol</i>. PPP is more modern than SLIP and includes a number of features that make it more attractive. Its<br>main advantage over SLIP is that it isn't limited to transporting IP datagrams, but is designed to allow just<br>about any protocol to be carried across it.<br>
<b>1.2.6. The Transmission Control Protocol</b><br>
&nbsp;Sending datagrams from one host to another is not the whole story. If you log in to quark, you want to have<br>a reliable connection between your&nbsp;<b>rlogin</b>&nbsp;process on erdos and the shell process on quark. Thus, the<br>information sent to and fro must be split up into packets by the sender and reassembled into a character<br>stream by the receiver. Trivial as it seems, this involves a number of complicated tasks.<br>
A very important thing to know about IP is that, by intent, it is not reliable. Assume that ten people on your<br>Ethernet started downloading the latest release of Netscape's web browser source code from GMU's FTP<br>server. The amount of traffic generated might be too much for the gateway to handle, because it's too slow<br>
1.2.5. IP Over Serial Lines<br>
28<br>
<hr>
<A name=45></a>Linux Network Administrators Guide<br>
and it's tight on memory. Now if you happen to send a packet to quark, sophus might be out of buffer space<br>for a moment and therefore unable to forward it. IP solves this problem by simply discarding it. The packet is<br>irrevocably lost. It is therefore the responsibility of the communicating hosts to check the integrity and<br>completeness of the data and retransmit it in case of error.<br>
This process is performed by yet another protocol,&nbsp;<i>Transmission Control Protocol</i>&nbsp;(TCP), which builds a<br>reliable service on top of IP. The essential property of TCP is that it uses IP to give you the illusion of a<br>simple connection between the two processes on your host and the remote machine, so you don't have to care<br>about how and along which route your data actually travels. A TCP connection works essentially like a<br>two−way pipe that both processes may write to and read from. Think of it as a telephone conversation.<br>
&nbsp;TCP identifies the end points of such a connection by the IP addresses of the two hosts involved and the<br>number of a&nbsp;<i>port</i>&nbsp;on each host. Ports may be viewed as attachment points for network connections. If we are<br>to strain the telephone example a little more, and you imagine that cities are like hosts, one might compare IP<br>addresses to area codes (where numbers map to cities), and port numbers to local codes (where numbers map<br>to individual people's telephones). An individual host may support many different services, each<br>distinguished by its own port number.<br>
In the&nbsp;<b>rlogin</b>&nbsp;example, the client application (<b>rlogin</b>) opens a port on erdos and connects to port 513 on<br>quark, to which the&nbsp;<b>rlogind</b>&nbsp;server is known to listen. This action establishes a TCP connection. Using this<br>connection,&nbsp;<b>rlogind</b>&nbsp;performs the authorization procedure and then spawns the shell. The shell's standard<br>input and output are redirected to the TCP connection, so that anything you type to&nbsp;<b>rlogin</b>&nbsp;on your machine<br>will be passed through the TCP stream and be given to the shell as standard input.<br>
<b>1.2.7. The User Datagram Protocol</b><br>
&nbsp;Of course, TCP isn't the only user protocol in TCP/IP networking. Although suitable for applications like<br><b>rlogin</b>, the overhead involved is prohibitive for applications like NFS, which instead uses a sibling protocol<br>of TCP called UDP, or&nbsp;<i>User Datagram Protocol</i>. Just like TCP, UDP allows an application to contact a<br>service on a certain port of the remote machine, but it doesn't establish a connection for this. Instead, you use<br>it to send single packets to the destination servicehence its name.<br>
Assume you want to request a small amount of data from a database server. It takes at least three datagrams<br>to establish a TCP connection, another three to send and confirm a small amount of data each way, and<br>another three to close the connection. UDP provides us with a means of using only two datagrams to achieve<br>almost the same result. UDP is said to be connectionless, and it doesn't require us to establish and close a<br>session. We simply put our data into a datagram and send it to the server; the server formulates its reply, puts<br>the data into a datagram addressed back to us, and transmits it back. While this is both faster and more<br>efficient than TCP for simple transactions, UDP was not designed to deal with datagram loss. It is up to the<br>application, a name server for example, to take care of this.<br>
<b>1.2.8. More on Ports</b><br>
&nbsp;Ports may be viewed as attachment points for network connections. If an application wants to offer a<br>certain service, it attaches itself to a port and waits for clients (this is also called&nbsp;<i>listening</i>&nbsp;on the port). A<br>client who wants to use this service allocates a port on its local host and connects to the server's port on the<br>remote host. The same port may be open on many different machines, but on each machine only one process<br>
1.2.7. The User Datagram Protocol<br>
29<br>
<hr>
<A name=46></a>Linux Network Administrators Guide<br>
can open a port at any one time.<br>
An important property of ports is that once a connection has been established between the client and the<br>server, another copy of the server may attach to the server port and listen for more clients. This property<br>permits, for instance, several concurrent remote logins to the same host, all using the same port 513. TCP is<br>able to tell these connections from one another because they all come from different ports or hosts. For<br>example, if you log in twice to quark from erdos, the first&nbsp;<b>rlogin</b>&nbsp;client will use the local port 1023, and the<br>second one will use port 1022. Both, however, will connect to the same port 513 on quark. The two<br>connections will be distinguished by use of the port numbers used at erdos.<br>
&nbsp;This example shows the use of ports as rendezvous points, where a client contacts a specific port to obtain a<br>specific service. In order for a client to know the proper port number, an agreement has to be reached<br>between the administrators of both systems on the assignment of these numbers. For services that are widely<br>used, such as&nbsp;<b>rlogin</b>, these numbers have to be administered centrally. This is done by the IETF (Internet<br>Engineering Task Force), which regularly releases an RFC titled&nbsp;<i>Assigned Numbers</i>&nbsp;(RFC−1700). It<br>describes, among other things, the port numbers assigned to well−known services. Linux uses a file called<br>/etc/services&nbsp;that maps service names to numbers.<br>
It is worth noting that although both TCP and UDP connections rely on ports, these numbers do not conflict.<br>This means that TCP port 513, for example, is different from UDP port 513. In fact, these ports serve as<br>access points for two different services, namely&nbsp;<b>rlogin</b>&nbsp;(TCP) and&nbsp;<b>rwho</b>&nbsp;(UDP).&nbsp;<br>
<b>1.2.9. The Socket Library</b><br>
In Unix operating systems, the software performing all the tasks and protocols described above is usually part<br>of the kernel, and so it is in Linux. The programming interface most common in the Unix world is the<br><i>Berkeley Socket Library</i>. Its name derives from a popular analogy that views ports as sockets and connecting<br>to a port as plugging in. It provides the&nbsp;bind&nbsp;call to specify a remote host, a transport protocol, and a service<br>that a program can connect or listen to (using&nbsp;connect,&nbsp;listen, and&nbsp;accept). The socket library is<br>somewhat more general in that it provides not only a class of TCP/IP−based sockets (the&nbsp;AF_INET&nbsp;sockets),<br>but also a class that handles connections local to the machine (the&nbsp;AF_UNIX&nbsp;class). Some implementations<br>can also handle other classes, like the XNS (<i>Xerox Networking System</i>) protocol or X.25.<br>
&nbsp;In Linux, the socket library is part of the standard&nbsp;libc&nbsp;C library. It supports the&nbsp;AF_INET&nbsp;and<br>AF_INET6&nbsp;sockets for TCP/IP and&nbsp;AF_UNIX&nbsp;for Unix domain sockets. It also supports&nbsp;AF_IPX&nbsp;for<br>Novell's network protocols,&nbsp;AF_X25&nbsp;for the X.25 network protocol,&nbsp;AF_ATMPVC&nbsp;and&nbsp;AF_ATMSVC&nbsp;for the<br>ATM network protocol and&nbsp;AF_AX25,&nbsp;AF_NETROM, and&nbsp;AF_ROSE&nbsp;sockets for Amateur Radio protocol<br>support. Other protocol families are being developed and will be added in time.<br>
1.2.9. The Socket Library<br>
30<br>
<hr>
<A name=47></a><b>1.3. UUCP Networks</b><br>
&nbsp;Unix−to−Unix Copy (UUCP) started out as a package of programs that transferred files over serial lines,<br>scheduled those transfers, and initiated execution of programs on remote sites. It has undergone major<br>changes since its first implementation in the late seventies, but it is still rather spartan in the services it offers.<br>Its main application is still in Wide Area Networks, based on periodic dialup telephone links.<br>
UUCP was first developed by Bell Laboratories in 1977 for communication between their Unix development<br>sites. In mid−1978, this network already connected over 80 sites. It was running email as an application, as<br>well as remote printing. However, the system's central use was in distributing new software and bug fixes.<br>Today, UUCP is not confined solely to the Unix environment. There are free and commercial ports available<br>for a variety of platforms, including AmigaOS, DOS, and Atari's TOS.<br>
One of the main disadvantages of UUCP networks is that they operate in batches. Rather than having a<br>permanent connection established between hosts, it uses temporary connections. A UUCP host machine<br>might dial in to another UUCP host only once a day, and then only for a short period of time. While it is<br>connected, it will transfer all of the news, email, and files that have been queued, and then disconnect. It is<br>this queuing that limits the sorts of applications that UUCP can be applied to. In the case of email, a user may<br>prepare an email message and post it. The message will stay queued on the UUCP host machine until it dials<br>in to another UUCP host to transfer the message. This is fine for network services such as email, but is no use<br>at all for services such as&nbsp;<b>rlogin</b>.<br>
Despite these limitations, there are still many UUCP networks operating all over the world, run mainly by<br>hobbyists, which offer private users network access at reasonable prices. The main reason for the longtime<br>popularity of UUCP was that it was very cheap compared to having your computer directly connected to the<br>Internet. To make your computer a UUCP node, all you needed was a modem, a working UUCP<br>implementation, and another UUCP node that was willing to feed you mail and news. Many people were<br>prepared to provide UUCP feeds to individuals because such connections didn't place much demand on their<br>existing network.<br>
We cover the configuration of UUCP in a chapter of its own later in the book, but we won't focus on it too<br>heavily, as it's being replaced rapidly with TCP/IP, now that cheap Internet access has become commonly<br>available in most parts of the world.<br>
1.3. UUCP Networks<br>
31<br>
<hr>
<A name=48></a><b>1.4. Linux Networking</b><br>
As it is the result of a concerted effort of programmers around the world, Linux wouldn't have been possible<br>without the global network. So it's not surprising that in the early stages of development, several people<br>started to work on providing it with network capabilities. A UUCP implementation was running on Linux<br>almost from the very beginning, and work on TCP/IP−based networking started around autumn 1992, when<br>Ross Biro and others created what has now become known as Net−1.<br>
After Ross quit active development in May 1993, Fred van Kempen began to work on a new implementation,<br>rewriting major parts of the code. This project was known as Net−2. The first public release, Net−2d, was<br>made in the summer of 1993 (as part of the 0.99.10 kernel), and has since been maintained and expanded by<br>several people, most notably Alan Cox.[8]&nbsp;Alan's original work was known as Net−2Debugged. After heavy<br>debugging and numerous improvements to the code, he changed its name to Net−3 after Linux 1.0 was<br>released. The Net−3 code was further developed for Linux 1.2 and Linux 2.0. The 2.2 and later kernels use<br>the Net−4 version network support, which remains the standard official offering today.<br>
The Net−4 Linux Network code offers a wide variety of device drivers and advanced features. Standard<br>Net−4 protocols include SLIP and PPP (for sending network traffic over serial lines), PLIP (for parallel<br>lines), IPX (for Novell compatible networks, which we'll discuss in&nbsp;<a href="TLNAGs.html#299">Chapter 15), Appletalk (for Apple<br></a>networks) and AX.25, NetRom, and Rose (for amateur radio networks). Other standard Net−4 features<br><a href="TLNAGs.html#183">include IP firewalling, IP accounting (discussed later in&nbsp;Chapter 9</a>&nbsp;and&nbsp;<a href="TLNAGs.html#230">Chapter 10</a>), and IP Masquerade<br><a href="TLNAGs.html#243">(discussed later in&nbsp;Chapter 11. IP tunnelling in a couple of different flavors and advanced policy routing are<br></a>supported. A very large variety of Ethernet devices is supported, in addition to support for some FDDI,<br>Token Ring, Frame Relay, and ISDN, and ATM cards.<br>
Additionally, there are a number of other features that greatly enhance the flexibility of Linux. These<br>features include an implementation of the SMB filesystem, which interoperates with applications like<br><i>lanmanager</i>&nbsp;and Microsoft Windows, called Samba, written by Andrew Tridgell, and an implementation of<br>the Novell NCP (NetWare Core Protocol).[9]<br>
<b>1.4.1. Different Streaks of Development</b><br>
There have been, at various times, varying network development efforts active for Linux.<br>
&nbsp;Fred continued development after Net−2Debugged was made the official network implementation. This<br>development led to the Net−2e, which featured a much revised design of the networking layer. Fred was<br>working toward a standardized Device Driver Interface (DDI), but the Net−2e work has ended now.<br>
Yet another implementation of TCP/IP networking came from Matthias Urlichs, who wrote an ISDN driver<br>for Linux and FreeBSD. For this driver, he integrated some of the BSD networking code in the Linux kernel.<br>That project, too is no longer being worked on.<br>
There has been a lot of rapid change in the Linux kernel networking implementation, and change is still the<br>watchword as development continues. Sometimes this means that changes also have to occur in other<br>software, such as the network configuration tools. While this is no longer as large a problem as it once was,<br>you may still find that upgrading your kernel to a later version means that you must upgrade your network<br>configuration tools, too. Fortunately, with the large number of Linux distributions available today, this is a<br>quite simple task.<br>
1.4. Linux Networking<br>
32<br>
<hr>
<A name=49></a>Linux Network Administrators Guide<br>
&nbsp;The Net−4 network implementation is now quite mature and is in use at a very large number of sites around<br>the world. Much work has been done on improving the performance of the Net−4 implementation, and it now<br>competes with the best implementations available for the same hardware platforms. Linux is proliferating in<br>the Internet Service Provider environment, and is often used to build cheap and reliable World Wide Web<br>servers, mail servers, and news servers for these sorts of organizations. There is now sufficient development<br>interest in Linux that it is managing to keep abreast of networking technology as it changes, and current<br>releases of the Linux kernel offer the next generation of the IP protocol, IPv6, as a standard offering.<br>
<b>1.4.2. Where to Get the Code</b><br>
&nbsp;It seems odd now to remember that in the early days of the Linux network code development, the standard<br>kernel required a huge patch kit to add the networking support to it. Today, network development occurs as<br>part of the mainstream Linux kernel development process. The latest stable Linux kernels can be found on<br><i>ftp.kernel.org</i>&nbsp;in&nbsp;/pub/linux/kernel/v2.x/, where&nbsp;<i>x</i>&nbsp;is an even number. The latest experimental<br>Linux kernels can be found on&nbsp;<i>ftp.kernel.org</i>&nbsp;in&nbsp;/pub/linux/kernel/v2.y/, where&nbsp;<i>y</i>&nbsp;is an odd number.<br>There are Linux kernel source mirrors all over the world. It is now hard to imagine Linux without standard<br>network support.<br>
1.4.2. Where to Get the Code<br>
33<br>
<hr>
<A name=50></a><b>1.5. Maintaining Your System</b><br>
&nbsp;Throughout this book, we will mainly deal with installation and configuration issues. Administration is,<br>however, much more than thatafter setting up a service, you have to keep it running, too. For most services,<br>only a little attendance will be necessary, while some, like mail and news, require that you perform routine<br>tasks to keep your system up to date. We will discuss these tasks in later chapters.<br>
&nbsp;The absolute minimum in maintenance is to check system and per−application log files regularly for error<br>conditions and unusual events. Often, you will want to do this by writing a couple of administrative shell<br>scripts and periodically running them from&nbsp;<b>cron</b>. The source distributions of some major applications, like<br><b>inn</b>&nbsp;or C News, contain such scripts. You only have to tailor them to suit your needs and preferences.<br>
The output from any of your&nbsp;<b>cron</b>&nbsp;jobs should be mailed to an administrative account. By default, many<br>applications will send error reports, usage statistics, or log file summaries to the root account. This makes<br>sense only if you log in as root frequently; a much better idea is to forward root's mail to your personal<br>account by setting up a mail alias as described in&nbsp;<a href="TLNAGs.html#398">Chapter 19</a>&nbsp;or&nbsp;<a href="TLNAGs.html#363">Chapter 18</a>.<br>
However carefully you have configured your site, Murphy's law guarantees that some problem&nbsp;<i>will</i>&nbsp;surface<br>eventually. Therefore, maintaining a system also means being available for complaints. Usually, people<br>expect that the system administrator can at least be reached via email as root, but there are also other<br>addresses that are commonly used to reach the person responsible for a specific aspect of maintenence. For<br>instance, complaints about a malfunctioning mail configuration will usually be addressed to postmaster, and<br>problems with the news system may be reported to newsmaster or usenet. Mail to hostmaster should be<br>redirected to the person in charge of the host's basic network services, and the DNS name service if you run a<br>name server.<br>
<b>1.5.1. System Security</b><br>
&nbsp;Another very important aspect of system administration in a network environment is protecting your<br>system and users from intruders. Carelessly managed systems offer malicious people many targets. Attacks<br>range from password guessing to Ethernet snooping, and the damage caused may range from faked mail<br>messages to data loss or violation of your users' privacy. We will mention some particular problems when<br>discussing the context in which they may occur and some common defenses against them.<br>
This section will discuss a few examples and basic techniques for dealing with system security. Of course, the<br>topics covered cannot treat all security issues you may be faced with in detail; they merely serve to illustrate<br>the problems that may arise. Therefore, reading a good book on security is an absolute must, especially in a<br>networked system.<br>
System security starts with good system administration. This includes checking the ownership and<br>permissions of all vital files and directories and monitoring use of privileged accounts. The COPS program,<br>for instance, will check your file system and common configuration files for unusual permissions or other<br>anomalies. It is also wise to use a password suite that enforces certain rules on the users' passwords that make<br>them hard to guess. The shadow password suite, for instance, requires a password to have at least five letters<br>and to contain both upper− and lowercase numbers, as well as non−alphabetic characters.<br>
When making a service accessible to the network, make sure to give it least privilege; don't permit it to do<br>things that aren't required for it to work as designed. For example, you should make programs setuid to<br>
1.5. Maintaining Your System<br>
34<br>
<hr>
<A name=51></a>Linux Network Administrators Guide<br>
root or some other privileged account only when necessary. Also, if you want to use a service for only a very<br>limited application, don't hesitate to configure it as restrictively as your special application allows. For<br>instance, if you want to allow diskless hosts to boot from your machine, you must provide&nbsp;<i>Trivial File<br>Transfer Protocol</i>&nbsp;(TFTP) so that they can download basic configuration files from the&nbsp;/boot&nbsp;directory.<br>However, when used unrestrictively, TFTP allows users anywhere in the world to download any<br>world−readable file from your system. If this is not what you want, restrict TFTP service to the<br>/boot&nbsp;directory.[10]<br>
You might also want to restrict certain services to users from certain hosts, say from your local network. In<br><a href="TLNAGs.html#253">Chapter 12, we introduce&nbsp;</a><b>tcpd</b>, which does this for a variety of network applications. More sophisticated<br>methods of restricting access to particular hosts or services will be explored later in&nbsp;<a href="TLNAGs.html#183">Chapter 9.</a><br>
Another important point is to avoid dangerous software. Of course, any software you use can be dangerous<br>because software may have bugs that clever people might exploit to gain access to your system. Things like<br>this happen, and there's no complete protection against it. This problem affects free software and commercial<br>products alike.[11]&nbsp;However, programs that require special privilege are inherently more dangerous than<br>others, because any loophole can have drastic consequences.[12]&nbsp;If you install a setuid program for network<br>purposes, be doubly careful to check the documentation so that you don't create a security breach by accident.<br>
&nbsp;Another source of concern should be programs that enable login or command execution with limited<br>authentication. The&nbsp;<b>rlogin</b>,&nbsp;<b>rsh</b>, and&nbsp;<b>rexec</b>&nbsp;commands are all very useful, but offer very limited authentication<br>of the calling party. Authentication is based on trust of the calling host name obtained from a name server<br>(we'll talk about these later), which can be faked. Today it should be standard practice to disable the<br><b>r</b>&nbsp;commands completely and replace them with the&nbsp;<b>ssh</b>&nbsp;suite of tools. The&nbsp;<b>ssh</b>&nbsp;tools use a much more reliable<br>authentication method and provide other services, such as encryption and compression, as well.<br>
You can never rule out the possibility that your precautions might fail, regardless of how careful you have<br>been. You should therefore make sure you detect intruders early. Checking the system log files is a good<br>starting point, but the intruder is probably clever enough to anticipate this action and will delete any obvious<br>traces he or she left. However, there are tools like&nbsp;<b>tripwire</b>, written by Gene Kim and Gene Spafford, that<br>allow you to check vital system files to see if their contents or permissions have been changed.<br><b>tripwire</b>&nbsp;computes various strong checksums over these files and stores them in a database. During<br>subsequent runs, the checksums are recomputed and compared to the stored ones to detect any modifications.<br>
1.5. Maintaining Your System<br>
35<br>
<hr>
<A name=52></a><b>Chapter 2. Issues of TCP/IP Networking</b><br>
In this chapter we turn to the configuration decisions you'll need to make when connecting your Linux<br>machine to a TCP/IP network, including dealing with IP addresses, hostnames, and routing issues. This<br>chapter gives you the background you need in order to understand what your setup requires, while the next<br>chapters cover the tools you will use.<br>
To learn more about TCP/IP and the reasons behind it, refer to the three−volume set&nbsp;<i>Internetworking with<br>TCP/IP</i>, by Douglas R. Comer (Prentice Hall). For a more detailed guide to managing a TCP/IP network, see<br><i>TCP/IP Network Administration</i>&nbsp;by Craig Hunt (O'Reilly).<br>
Chapter 2. Issues of TCP/IP Networking<br>
36<br>
<hr>
<A name=53></a><b>2.1. Networking Interfaces</b><br>
To hide the diversity of equipment that may be used in a networking environment, TCP/IP defines an abstract<br><i>interface</i>&nbsp;through which the hardware is accessed. This interface offers a set of operations that is the same for<br>all types of hardware and basically deals with sending and receiving packets.<br>
For each peripheral networking device, a corresponding interface has to be present in the kernel. For<br>example, Ethernet interfaces in Linux are called by such names as&nbsp;eth0&nbsp;and&nbsp;eth1; PPP (discussed in<br><a href="TLNAGs.html#162">Chapter 8</a>) interfaces are named&nbsp;ppp0&nbsp;and&nbsp;ppp1; and FDDI interfaces are given names like&nbsp;fddi0&nbsp;and<br>fddi1. These interface names are used for configuration purposes when you want to specify a particular<br>physical device in a configuration command, and they have no meaning beyond this use.<br>
Before being used by TCP/IP networking, an interface must be assigned an IP address that serves as its<br>identification when communicating with the rest of the world. This address is different from the interface<br>name mentioned previously; if you compare an interface to a door, the address is like the nameplate pinned<br>on it.<br>
Other device parameters may be set, like the maximum size of datagrams that can be processed by a<br>particular piece of hardware, which is referred to as&nbsp;<i>Maximum Transfer Unit</i>&nbsp;(MTU). Other attributes will be<br>introduced later. Fortunately, most attributes have sensible defaults.<br>
2.1. Networking Interfaces<br>
37<br>
<hr>
<A name=54></a><b>2.2. IP Addresses</b><br>
As mentioned in&nbsp;<a href="TLNAGs.html#37">Chapter 1, the IP networking protocol understands addresses as 32−bit numbers. Each<br></a>machine must be assigned a number unique to the networking environment.[13]&nbsp;If you are running a local<br>network that does not have TCP/IP traffic with other networks, you may assign these numbers according to<br>your personal preferences. There are some IP address ranges that have been reserved for such private<br><a href="TLNAGs.html#55">networks. These ranges are listed in&nbsp;Table 2−1</a>. However, for sites on the Internet, numbers are assigned by a<br>central authority, the&nbsp;<i>Network Information Center</i>&nbsp;(NIC).[14]<br>
&nbsp;IP addresses are split up into four eight−bit numbers called&nbsp;<i>octets</i>&nbsp;for readability. For example,<br>quark.physics.groucho.edu has an IP address of 0x954C0C04, which is written as 149.76.12.4. This format is<br>often referred to as&nbsp;<i>dotted quad notation</i>.<br>
Another reason for this notation is that IP addresses are split into a&nbsp;<i>network</i>&nbsp;number, which is contained in the<br>leading octets, and a&nbsp;<i>host</i>&nbsp;number, which is the remainder. When applying to the NIC for IP addresses, you<br>are not assigned an address for each single host you plan to use. Instead, you are given a network number and<br>allowed to assign all valid IP addresses within this range to hosts on your network according to your<br>preferences.<br>
The size of the host part depends on the size of the network. To accommodate different needs, several classes<br>of networks, defining different places to split IP addresses, have been defined. The class networks are<br>described here:<br>
<i>Class A</i><br>
Class A comprises networks 1.0.0.0 through 127.0.0.0. The network number is contained in the first<br>octet. This class provides for a 24−bit host part, allowing roughly 1.6 million hosts per network.<br>
<i>Class B</i><br>
Class B contains networks 128.0.0.0 through 191.255.0.0; the network number is in the first two<br>octets. This class allows for 16,320 nets with 65,024 hosts each.<br>
<i>Class C</i><br>
Class C networks range from 192.0.0.0 through 223.255.255.0, with the network number contained<br>in the first three octets. This class allows for nearly 2 million networks with up to 254 hosts.<br>
<i>Classes D, E, and F</i><br>
Addresses falling into the range of 224.0.0.0 through 254.0.0.0 are either experimental or are<br>reserved for special purpose use and don't specify any network. IP Multicast, which is a service that<br>allows material to be transmitted to many points on an internet at one time, has been assigned<br>addresses from within this range.<br>
If we go back to the example in Chapter 1, we find that 149.76.12.4, the address of quark, refers to host<br>12.4 on the class B network 149.76.0.0.<br>
You may have noticed that not all possible values in the previous list were allowed for each octet in the host<br>part. This is because octets 0 and 255 are reserved for special purposes. An address where all host part bits<br>
2.2. IP Addresses<br>
38<br>
<hr>
<A name=55></a>Linux Network Administrators Guide<br>
are 0 refers to the network, and an address where all bits of the host part are 1 is called a&nbsp;<i>broadcast address</i>.<br>This refers to all hosts on the specified network simultaneously. Thus, 149.76.255.255 is not a valid host<br>address, but refers to all hosts on network 149.76.0.0.<br>
&nbsp;A number of network addresses are reserved for special purposes. 0.0.0.0 and 127.0.0.0 are two such<br>addresses. The first is called the&nbsp;<i>default route</i>, and the latter is the&nbsp;<i>loopback address</i>. The default route has to<br>do with the way the IP routes datagrams.<br>
Network 127.0.0.0 is reserved for IP traffic local to your host. Usually, address 127.0.0.1 will be assigned to<br>a special interface on your host, the&nbsp;<i>loopback interface</i>, which acts like a closed circuit. Any IP packet<br>handed to this interface from TCP or UDP will be returned to them as if it had just arrived from some<br>network. This allows you to develop and test networking software without ever using a real network. The<br>loopback network also allows you to use networking software on a standalone host. This may not be as<br>uncommon as it sounds; for instance, many UUCP sites don't have IP connectivity at all, but still want to run<br>the INN news system. For proper operation on Linux, INN requires the loopback interface.<br>
Some address ranges from each of the network classes have been set aside and designated reserved or<br>private address ranges. These addresses are reserved for use by private networks and are not routed on the<br>Internet. They are commonly used by organizations building their own intranet, but even small networks<br>often find them useful. The reserved network addresses appear in&nbsp;<a href="TLNAGs.html#55">Table 2−1.</a><br>
<b>Table 2−1. IP Address Ranges Reserved for Private Use</b><br>
<b>Class&nbsp;Networks</b><br>
A<br>
10.0.0.0 through 10.255.255.255<br>
B<br>
172.16.0.0 through 172.31.0.0<br>
C<br>
192.168.0.0 through 192.168.255.0<br>
2.2. IP Addresses<br>
39<br>
<hr>
<A name=56></a><b>2.3. Address Resolution</b><br>
Now that you've seen how IP addresses are composed, you may be wondering how they are used on an<br>Ethernet or Token Ring network to address different hosts. After all, these protocols have their own addresses<br>to identify hosts that have absolutely nothing in common with an IP address, don't they? Right.<br>
&nbsp;A mechanism is needed to map IP addresses onto the addresses of the underlying network. The mechanism<br>used is the&nbsp;<i>Address Resolution Protocol</i>&nbsp;(ARP). In fact, ARP is not confined to Ethernet or Token Ring, but is<br>used on other types of networks, such as the amateur radio AX.25 protocol. The idea underlying ARP is<br>exactly what most people do when they have to find Mr. X in a throng of 150 people: the person who wants<br>him calls out loudly enough that everyone in the room can hear them, expecting him to respond if he is there.<br>When he responds, we know which person he is.<br>
When ARP wants to find the Ethernet address corresponding to a given IP address, it uses an Ethernet feature<br>called&nbsp;<i>broadcasting</i>, in which a datagram is addressed to all stations on the network simultaneously. The<br>broadcast datagram sent by ARP contains a query for the IP address. Each receiving host compares this query<br>to its own IP address and if it matches, returns an ARP reply to the inquiring host. The inquiring host can<br>now extract the sender's Ethernet address from the reply.<br>
You may wonder how a host can reach an Internet address that may be on a different network halfway around<br>the world. The answer to this question involves&nbsp;<i>routing</i>, namely finding the physical location of a host in a<br>network. We will discuss this issue further in the next section.<br>
Let's talk a little more about ARP. Once a host has discovered an Ethernet address, it stores it in its ARP<br>cache so that it doesn't have to query for it again the next time it wants to send a datagram to the host in<br>question. However, it is unwise to keep this information forever; the remote host's Ethernet card may be<br>replaced because of technical problems, so the ARP entry becomes invalid. Therefore, entries in the ARP<br>cache are discarded after some time to force another query for the IP address.<br>
&nbsp;Sometimes it is also necessary to find the IP address associated with a given Ethernet address. This happens<br>when a diskless machine wants to boot from a server on the network, which is a common situation on Local<br>Area Networks. A diskless client, however, has virtually no information about itselfexcept for its Ethernet<br>address! So it broadcasts a message containing a request asking a boot server to provide it with an IP address.<br>There's another protocol for this situation named&nbsp;<i>Reverse Address Resolution Protocol</i>&nbsp;(RARP). Along with<br>the BOOTP protocol, it serves to define a procedure for bootstrapping diskless clients over the network.<br>
2.3. Address Resolution<br>
40<br>
<hr>
<A name=57></a><b>2.4. IP Routing</b><br>
We now take up the question of finding the host that datagrams go to based on the IP address. Different parts<br>of the address are handled in different ways; it is your job to set up the files that indicate how to treat each<br>part.<br>
<b>2.4.1. IP Networks</b><br>
When you write a letter to someone, you usually put a complete address on the envelope specifying the<br>country, state, and Zip Code. After you put it in the mailbox, the post office will deliver it to its destination: it<br>will be sent to the country indicated, where the national service will dispatch it to the proper state and region.<br>The advantage of this hierarchical scheme is obvious: wherever you post the letter, the local postmaster<br>knows roughly which direction to forward the letter, but the postmaster doesn't care which way the letter will<br>travel once it reaches its country of destination.<br>
IP networks are structured similarly. The whole Internet consists of a number of proper networks, called<br><i>autonomous systems</i>. Each system performs routing between its member hosts internally so that the task of<br>delivering a datagram is reduced to finding a path to the destination host's network. As soon as the datagram<br>is handed to&nbsp;<i>any</i>&nbsp;host on that particular network, further processing is done exclusively by the network itself.<br>
<b>2.4.2. Subnetworks</b><br>
This structure is reflected by splitting IP addresses into a host and network part, as explained previously. By<br>default, the destination network is derived from the network part of the IP address. Thus, hosts with identical<br>IP&nbsp;<i>network</i>&nbsp;numbers should be found within the same network.[15]<br>
It makes sense to offer a similar scheme&nbsp;<i>inside</i>&nbsp;the network, too, since it may consist of a collection of<br>hundreds of smaller networks, with the smallest units being physical networks like Ethernets. Therefore, IP<br>allows you to subdivide an IP network into several&nbsp;<i>subnets</i>.<br>
&nbsp;A subnet takes responsibility for delivering datagrams to a certain range of IP addresses. It is an extension<br>of the concept of splitting bit fields, as in the A, B, and C classes. However, the network part is now extended<br>to include some bits from the host part. The number of bits that are interpreted as the subnet number is given<br>by the so−called&nbsp;<i>subnet mask</i>, or&nbsp;<i>netmask</i>. This is a 32−bit number too, which specifies the bit mask for the<br>network part of the IP address.<br>
The campus network of Groucho Marx University is an example of such a network. It has a class B network<br>number of 149.76.0.0, and its netmask is therefore 255.255.0.0.<br>
Internally, GMU's campus network consists of several smaller networks, such various departments' LANs. So<br>the range of IP addresses is broken up into 254 subnets, 149.76.1.0 through 149.76.254.0. For example, the<br>department of Theoretical Physics has been assigned 149.76.12.0. The campus backbone is a network in its<br>own right, and is given 149.76.1.0. These subnets share the same IP network number, while the third octet is<br>used to distinguish between them. They will thus use a subnet mask of 255.255.255.0.<br>
<a href="TLNAGs.html#58">Figure 2−1&nbsp;shows how 149.76.12.4, the address of quark, is interpreted differently when the address is taken<br></a>as an ordinary class B network and when used with subnetting.<br>
2.4. IP Routing<br>
41<br>
<hr>
<A name=58></a><IMG src="TLNAG-58_1.png"><br>
<IMG src="TLNAG-58_2.png"><br>
Linux Network Administrators Guide<br>
<b>Figure 2−1. Subnetting a class B network</b><br>
&nbsp;It is worth noting that&nbsp;<i>subnetting</i>&nbsp;(the technique of generating subnets) is only an&nbsp;<i>internal division</i>&nbsp;of the<br>network. Subnets are generated by the network owner (or the administrators). Frequently, subnets are created<br>to reflect existing boundaries, be they physical (between two Ethernets), administrative (between two<br>departments), or geographical (between two locations), and authority over each subnet is delegated to some<br>contact person. However, this structure affects only the network's internal behavior, and is completely<br>invisible to the outside world.<br>
<b>2.4.3. Gateways</b><br>
Subnetting is not only a benefit to the organization; it is frequently a natural consequence of hardware<br>boundaries. The viewpoint of a host on a given physical network, such as an Ethernet, is a very limited one: it<br>can only talk to the host of the network it is on. All other hosts can be accessed only through special−purpose<br>machines called&nbsp;<i>gateways</i>. A gateway is a host that is connected to two or more physical networks<br>simultaneously and is configured to switch packets between them.<br>
<a href="TLNAGs.html#58">Figure 2−2&nbsp;shows part of the network topology at Groucho Marx University (GMU). Hosts that are on two<br></a>subnets at the same time are shown with both addresses.<br>
<b>Figure 2−2. A part of the net topology at Groucho Marx University</b><br>
2.4.3. Gateways<br>
42<br>
<hr>
<A name=59></a>Linux Network Administrators Guide<br>
Different physical networks have to belong to different IP networks for IP to be able to recognize if a host is<br>on a local network. For example, the network number 149.76.4.0 is reserved for hosts on the mathematics<br>LAN. When sending a datagram to quark, the network software on erdos immediately sees from the IP<br>address 149.76.12.4 that the destination host is on a different physical network, and therefore can be reached<br>only through a gateway (sophus by default).<br>
sophus itself is connected to two distinct subnets: the Mathematics department and the campus backbone. It<br>accesses each through a different interface,&nbsp;eth0&nbsp;and&nbsp;fddi0, respectively. Now, what IP address do we<br>assign it? Should we give it one on subnet 149.76.1.0, or on 149.76.4.0?<br>
The answer is: both. sophus has been assigned the address 149.76.1.1 for use on the 149.76.1.0 network<br>and address 149.76.4.1 for use on the 149.76.4.0 network. A gateway must be assigned one IP address for<br>each network it belongs to. These addressesalong with the corresponding netmaskare tied to the interface<br>through which the subnet is accessed. Thus, the interface and address mapping for sophus would look like<br>this:<br>
<b>Interface&nbsp;Address</b><br>
<b>Netmask</b><br>
eth0<br>
149.76.4.1&nbsp;255.255.255.0<br>
fddi0<br>
149.76.1.1&nbsp;255.255.255.0<br>
lo<br>
127.0.0.1<br>
255.0.0.0<br>
The last entry describes the loopback interface&nbsp;lo, which we talked about earlier.<br>
Generally, you can ignore the subtle difference between attaching an address to a host or its interface. For<br>hosts that are on one network only, like erdos, you would generally refer to the host as having this−and−that<br>IP address, although strictly speaking, it's the Ethernet interface that has this IP address. The distinction is<br>really important only when you refer to a gateway.<br>
<b>2.4.4. The Routing Table</b><br>
We now focus our attention on how IP chooses a gateway to use to deliver a datagram to a remote network.<br>
We have seen that erdos, when given a datagram for quark, checks the destination address and finds that it is<br>not on the local network. erdos therefore sends the datagram to the default gateway sophus, which is now<br>faced with the same task. sophus recognizes that quark is not on any of the networks it is connected to<br>directly, so it has to find yet another gateway to forward it through. The correct choice would be niels, the<br>gateway to the Physics department. sophus thus needs information to associate a destination network with a<br>suitable gateway.<br>
IP uses a table for this task that associates networks with the gateways by which they may be reached. A<br>catch−all entry (the&nbsp;<i>default route</i>) must generally be supplied too; this is the gateway associated with network<br>0.0.0.0. All destination addresses match this route, since none of the 32 bits are required to match, and<br>therefore packets to an unknown network are sent through the default route. On sophus, the table might look<br>like this:<br>
2.4.4. The Routing Table<br>
43<br>
<hr>
<A name=60></a>Linux Network Administrators Guide<br>
<b>Network</b><br>
<b>Netmask</b><br>
<b>Gateway</b><br>
<b>Interface</b><br>
149.76.1.0&nbsp;255.255.255.0&nbsp;−<br>
fddi0<br>
149.76.2.0&nbsp;255.255.255.0&nbsp;149.76.1.2&nbsp;fddi0<br>
149.76.3.0&nbsp;255.255.255.0&nbsp;149.76.1.3&nbsp;fddi0<br>
149.76.4.0&nbsp;255.255.255.0&nbsp;−<br>
eth0<br>
149.76.5.0&nbsp;255.255.255.0&nbsp;149.76.1.5&nbsp;fddi0<br>
&amp;<br>
&amp;<br>
&amp;<br>
&amp;<br>
0.0.0.0<br>
0.0.0.0<br>
149.76.1.2&nbsp;fddi0<br>
If you need to use a route to a network that sophus is directly connected to, you don't need a gateway; the<br>gateway column here contains a hyphen.<br>
The process for identifying whether a particular destination address matches a route is a mathematical<br>operation. The process is quite simple, but it requires an understanding of binary arithmetic and logic: A route<br>matches a destination if the network address logically ANDed with the netmask precisely equals the<br>destination address logically ANDed with the netmask.<br>
Translation: a route matches if the number of bits of the network address specified by the netmask (starting<br>from the left−most bit, the high order bit of byte one of the address) match that same number of bits in the<br>destination address.<br>
When the IP implementation is searching for the best route to a destination, it may find a number of routing<br>entries that match the target address. For example, we know that the default route matches every destination,<br>but datagrams destined for locally attached networks will match their local route, too. How does IP know<br>which route to use? It is here that the netmask plays an important role. While both routes match the<br>destination, one of the routes has a larger netmask than the other. We previously mentioned that the netmask<br>was used to break up our address space into smaller networks. The larger a netmask is, the more specifically a<br>target address is matched; when routing datagrams, we should always choose the route that has the largest<br>netmask. The default route has a netmask of zero bits, and in the configuration presented above, the locally<br>attached networks have a 24−bit netmask. If a datagram matches a locally attached network, it will be routed<br>to the appropriate device in preference to following the default route because the local network route matches<br>with a greater number of bits. The only datagrams that will be routed via the default route are those that don't<br>match any other route.<br>
&nbsp;You can build routing tables by a variety of means. For small LANs, it is usually most efficient to construct<br>them by hand and feed them to IP using the&nbsp;<b>route</b><a href="TLNAGs.html#97">&nbsp;command at boot time (see&nbsp;Chapter 5</a>). For larger<br>networks, they are built and adjusted at runtime by&nbsp;<i>routing daemons</i>; these daemons run on central hosts of<br>the network and exchange routing information to compute optimal routes between the member networks.<br>
&nbsp;Depending on the size of the network, you'll need to use different routing protocols. For routing inside<br>autonomous systems (such as the Groucho Marx campus), the&nbsp;<i>internal routing protocols</i>&nbsp;are used. The most<br>prominent one of these is the&nbsp;<i>Routing Information Protocol</i>&nbsp;(RIP), which is implemented by the BSD<br><b>routed</b>&nbsp;daemon. For routing between autonomous systems,&nbsp;<i>external routing protocols</i>&nbsp;like&nbsp;<i>External Gateway<br>Protocol</i>&nbsp;(EGP) or&nbsp;<i>Border Gateway Protocol</i>&nbsp;(BGP) have to be used; these protocols, including RIP, have<br>been implemented in the University of Cornell's&nbsp;<b>gated</b>&nbsp;daemon.<br>
2.4.4. The Routing Table<br>
44<br>
<hr>
<A name=61></a>Linux Network Administrators Guide<br>
<b>2.4.5. Metric Values</b><br>
We depend on dynamic routing to choose the best route to a destination host or network based on the number<br>of&nbsp;<i>hops</i>. Hops are the gateways a datagram has to pass before reaching a host or network. The shorter a route<br>is, the better RIP rates it. Very long routes with 16 or more hops are regarded as unusable and are discarded.<br>
RIP manages routing information internal to your local network, but you have to run&nbsp;<b>gated</b>&nbsp;on all hosts. At<br>boot time,&nbsp;<b>gated</b>&nbsp;checks for all active network interfaces. If there is more than one active interface (not<br>counting the loopback interface), it assumes the host is switching packets between several networks and will<br>actively exchange and broadcast routing information. Otherwise, it will only passively receive RIP updates<br>and update the local routing table.<br>
When broadcasting information from the local routing table,&nbsp;<b>gated</b>&nbsp;computes the length of the route from the<br>so−called&nbsp;<i>metric value</i>&nbsp;associated with the routing table entry. This metric value is set by the system<br>administrator when configuring the route, and should reflect the actual route cost.[16]&nbsp;Therefore, the metric<br>of a route to a subnet that the host is directly connected to should always be zero, while a route going through<br>two gateways should have a metric of two. You don't have to bother with metrics if you don't use&nbsp;<b>RIP</b>&nbsp;or<br><b>gated</b>.<br>
2.4.5. Metric Values<br>
45<br>
<hr>
<A name=62></a><b>2.5. The Internet Control Message Protocol</b><br>
&nbsp;IP has a companion protocol that we haven't talked about yet. This is the&nbsp;<i>Internet Control Message<br>Protocol</i>&nbsp;(ICMP), used by the kernel networking code to communicate error messages to other hosts. For<br>instance, assume that you are on erdos again and want to&nbsp;<b>telnet</b>&nbsp;to port 12345 on quark, but there's no process<br>listening on that port. When the first TCP packet for this port arrives on quark, the networking layer will<br>recognize this arrival and immediately return an ICMP message to erdos stating Port Unreachable.<br>
&nbsp;The ICMP protocol provides several different messages, many of which deal with error conditions.<br>However, there is one very interesting message called the Redirect message. It is generated by the routing<br>module when it detects that another host is using it as a gateway, even though a much shorter route exists. For<br>example, after booting, the routing table of sophus may be incomplete. It might contain the routes to the<br>Mathematics network, to the FDDI backbone, and the default route pointing at the Groucho Computing<br>Center's gateway (gcc1). Thus, packets for quark would be sent to gcc1 rather than to niels, the gateway to<br>the Physics department. When receiving such a datagram, gcc1 will notice that this is a poor choice of route<br>and will forward the packet to niels, meanwhile returning an ICMP Redirect message to sophus telling it of<br>the superior route.<br>
This seems to be a very clever way to avoid manually setting up any but the most basic routes. However, be<br>warned that relying on dynamic routing schemes, be it RIP or ICMP Redirect messages, is not always a good<br>idea. ICMP Redirect and RIP offer you little or no choice in verifying that some routing information is indeed<br>authentic. This situation allows malicious good−for−nothings to disrupt your entire network traffic, or even<br>worse. Consequently, the Linux networking code treats Network Redirect messages as if they were Host<br>Redirects. This minimizes the damage of an attack by restricting it to just one host, rather than the whole<br>network. On the flip side, it means that a little more traffic is generated in the event of a legitimate condition,<br>as each host causes the generation of an ICMP Redirect message. It is generally considered bad practice to<br>rely on ICMP redirects for anything these days.<br>
2.5. The Internet Control Message Protocol<br>
46<br>
<hr>
<A name=63></a><b>2.6. Resolving Host Names</b><br>
As described previously, addressing in TCP/IP networking, at least for IP Version 4, revolves around 32−bit<br>numbers. However, you will have a hard time remembering more than a few of these numbers. Therefore,<br>hosts are generally known by ordinary names such as gauss or strange. It becomes the application's duty to<br>find the IP address corresponding to this name. This process is called&nbsp;<i>hostname resolution</i>.<br>
When an application needs to find the IP address of a given host, it relies on the library functions<br>gethostbyname(3)&nbsp;and&nbsp;gethostbyaddr(3). Traditionally, these and a number of related procedures<br>were grouped in a separate library called the&nbsp;<i>resolverlibrary</i>; on Linux, these functions are part of the<br>standard&nbsp;libc. Colloquially, this collection of functions is therefore referred to as the resolver. Resolver<br>name configuration is detailed in&nbsp;<a href="TLNAGs.html#120">Chapter 6.</a><br>
On a small network like an Ethernet or even a cluster of Ethernets, it is not very difficult to maintain tables<br>mapping hostnames to addresses. This information is usually kept in a file named&nbsp;/etc/hosts. When<br>adding or removing hosts, or reassigning addresses, all you have to do is update the&nbsp;hosts&nbsp;file on all hosts.<br>Obviously, this will become burdensome with networks that comprise more than a handful of machines.<br>
One solution to this problem is the&nbsp;<i>Network Information System</i>&nbsp;(NIS), developed by Sun Microsystems,<br>colloquially called YP or Yellow Pages. NIS stores the&nbsp;hosts&nbsp;file (and other information) in a database on a<br>master host from which clients may retrieve it as needed. Still, this approach is suitable only for<br>medium−sized networks such as LANs, because it involves maintaining the entire&nbsp;hosts&nbsp;database centrally<br><a href="TLNAGs.html#270">and distributing it to all servers. NIS installation and configuration is discussed in detail in&nbsp;Chapter 13.</a><br>
On the Internet, address information was initially stored in a single&nbsp;HOSTS.TXT&nbsp;database, too. This file was<br>maintained at the&nbsp;<i>Network Information Center</i>&nbsp;(NIC), and had to be downloaded and installed by all<br>participating sites. When the network grew, several problems with this scheme arose. Besides the<br>administrative overhead involved in installing&nbsp;HOSTS.TXT&nbsp;regularly, the load on the servers that distributed<br>it became too high. Even more severe, all names had to be registered with the NIC, which made sure that no<br>name was issued twice.<br>
This is why a new name resolution scheme was adopted in 1994: the&nbsp;<i>Domain Name System</i>. DNS was<br>designed by Paul Mockapetris and addresses both problems simultaneously. We discuss the Domain Name<br>System in detail in&nbsp;<a href="TLNAGs.html#120">Chapter 6</a>.<br>
2.6. Resolving Host Names<br>
47<br>
<hr>
<A name=64></a><b>Chapter 3. Configuringthe NetworkingHardware</b><br>
We've been talking quite a bit about network interfaces and general TCP/IP issues, but we haven't really<br>covered what happens when the networking code in the kernel accesses a piece of hardware. In order to<br>describe this accurately, we have to talk a little about the concept of interfaces and drivers.<br>
First, of course, there's the hardware itself, for example an Ethernet, FDDI or Token Ring card: this is a slice<br>of Epoxy cluttered with lots of tiny chips with strange numbers on them, sitting in a slot of your PC. This is<br>what we generally call a physical device.<br>
&nbsp;For you to use a network card, special functions have to be present in your Linux kernel that understand the<br>particular way this device is accessed. The software that implements these functions is called a&nbsp;<i>device driver</i>.<br>Linux has device drivers for many different types of network interface cards: ISA, PCI, MCA, EISA, Parallel<br>port, PCMCIA, and more recently, USB.<br>
But what do we mean when we say a driver handles a device? Let's consider an Ethernet card. The driver<br>has to be able to communicate with the peripheral's on−card logic somehow: it has to send commands and<br>data to the card, while the card should deliver any data received to the driver.<br>
In IBM−style personal computers, this communication takes place through a cluster of I/O addresses that are<br>mapped to registers on the card and/or through shared or direct memory transfers. All commands and data the<br>kernel sends to the card have to go to these addresses. I/O and memory addresses are generally described by<br>providing the starting or&nbsp;<i>base address</i>. Typical base addresses for ISA bus Ethernet cards are&nbsp;0x280&nbsp;or<br>0x300. PCI bus network cards generally have their I/O address automatically assigned.<br>
Usually you don't have to worry about any hardware issues such as the base address because the kernel makes<br>an attempt at boot time to detect a card's location. This is called&nbsp;<i>auto probing</i>, which means that the kernel<br>reads several memory or I/O locations and compares the data it reads there with what it would expect to see if<br>a certain network card were installed at that location. However, there may be network cards it cannot detect<br>automatically; this is sometimes the case with cheap network cards that are not−quite clones of standard cards<br>from other manufacturers. Also, the kernel will normally attempt to detect only one network device when<br>booting. If you're using more than one card, you have to tell the kernel about the other cards explicitly.<br>
Another parameter that you might have to tell the kernel about is the interrupt request line. Hardware<br>components usually interrupt the kernel when they need to be taken care offor example, when data has<br>arrived or a special condition occurs. In an ISA bus PC, interrupts may occur on one of 15 interrupt channels<br>numbered 0, 1, and 3 through 15. The interrupt number assigned to a hardware component is called its<br><i>interrupt request number</i>&nbsp;(IRQ).[17]<br>
&nbsp;As described in&nbsp;&nbsp;<a href="TLNAGs.html#52">Chapter 2, the kernel accesses a piece of network hardware through a software construct<br></a>called an&nbsp;<i>interface</i>. Interfaces offer an abstract set of functions that are the same across all types of hardware,<br>such as sending or receiving a datagram.<br>
&nbsp;Interfaces are identified by means of names. In many other Unix−like operating systems, the network<br>interface is implemented as a special device file in the&nbsp;/dev/&nbsp;directory. If you type the&nbsp;ls −las<br>/dev/&nbsp;command, you will see what these device files look like. In the file permissions (second) column you<br>will see that device files begin with a letter rather than the hyphen seen for normal files. This character<br>indicates the device type. The most common device types are&nbsp;b, which indicates the device is a&nbsp;<i>block</i>&nbsp;device<br>and handles whole blocks of data with each read and write, and&nbsp;c, which indicates the device is a<br><i>character</i>&nbsp;device and handles data one character at a time. Where you would normally see the file length in<br>
Chapter 3. Configuringthe NetworkingHardware<br>
48<br>
<hr>
<A name=65></a><IMG src="TLNAG-65_1.png"><br>
Linux Network Administrators Guide<br>
the&nbsp;<b>ls</b>&nbsp;output, you instead see two numbers, called the major and minor device numbers. These numbers<br>indicate the actual device with which the device file is associated.<br>
Each device driver registers a unique major number with the kernel. Each&nbsp;<i>instance</i>&nbsp;of that device registers a<br>unique minor number for that major device. The&nbsp;tty&nbsp;interfaces,/dev/tty*, are a character mode device<br>indicated by the&nbsp;c, and each have a major number of&nbsp;4, but&nbsp;/dev/tty1&nbsp;has a minor number of&nbsp;1, and<br>/dev/tty2&nbsp;has a minor number of&nbsp;2. Device files are very useful for many types of devices, but can be<br>clumsy to use when trying to find an unused device to open.<br>
Linux interface names are defined internally in the kernel and are not device files in the&nbsp;/dev&nbsp;directory.<br><a href="TLNAGs.html#73">Some typical device names are listed later in&nbsp;Section 3.2. The assignment of interfaces to devices usually<br></a>depends on the order in which devices are configured. For instance, the first Ethernet card installed will<br>become&nbsp;eth0, and the next will be&nbsp;eth1. SLIP interfaces are handled differently from others because they<br>are assigned dynamically. Whenever a SLIP connection is established, an interface is assigned to the serial<br>port.<br>
<a href="TLNAGs.html#65">Figure 3−1&nbsp;illustrates the relationship between the hardware, device drivers, and interfaces.</a><br>
<b>Figure 3−1. The relationship between drivers, interfaces, and hardware</b><br>
When booting, the kernel displays the devices it detects and the interfaces it installs. The following is an<br>excerpt from typical boot messages:<br>
&nbsp;.<br>
&nbsp;. &nbsp;This processor honors the WP bit even when in supervisor mode./&nbsp;<br>
&nbsp; &nbsp; Good.&nbsp;<br>
Swansea University Computer Society NET3.035 for Linux 2.0&nbsp;<br>
NET3: Unix domain sockets 0.13 for Linux NET3.035.<br>
Swansea University Computer Society TCP/IP for NET3.034&nbsp;<br>
IP Protocols: IGMP,ICMP, UDP, TCP&nbsp;<br>
Swansea University Computer Society IPX 0.34 for NET3.035&nbsp;<br>
IPX Portions Copyright (c) 1995 Caldera, Inc.<br>
Serial driver version 4.13 with no serial options enabled&nbsp;<br>
tty00 at 0x03f8 (irq = 4) is a 16550A<br>
tty01 at 0x02f8 (irq = 3) is a 16550A<br>
CSLIP: code copyright 1989 Regents of the University of California&nbsp;<br>
PPP: Version 2.2.0 (dynamic channel allocation)&nbsp;<br>
PPP Dynamic channel allocation code copyright 1995 Caldera, Inc.&nbsp;<br>
PPP line discipline registered. &nbsp;<br>
eth0: 3c509 at 0x300 tag 1, 10baseT port, address 00 a0 24 0e e4 e0,/&nbsp;<br>
&nbsp; &nbsp; IRQ 10.<br>
Chapter 3. Configuringthe NetworkingHardware<br>
49<br>
<hr>
<A name=66></a>Linux Network Administrators Guide<br>
3c509.c:1.12 6/4/97 becker@cesdis.gsfc.nasa.gov&nbsp;<br>
Linux Version 2.0.32 (root@perf) (gcc Version 2.7.2.1)&nbsp;<br>
#1 Tue Oct 21 15:30:44 EST 1997<br>
&nbsp;.<br>
&nbsp;.<br>
This example shows that the kernel has been compiled with TCP/IP enabled, and it includes drivers for SLIP,<br>CSLIP, and PPP. The third line from the bottom says that a 3C509 Ethernet card was detected and installed<br>as interface&nbsp;eth0. If you have some other type of network cardperhaps a D−Link pocket adaptor, for<br>examplethe kernel will usually print a line starting with its device namedl0&nbsp;in the D−Link<br>examplefollowed by the type of card detected. If you have a network card installed but don't see any similar<br>message, the kernel is unable to detect your card properly. This situation will be discussed later in the section<br>Ethernet Autoprobing.<br>
Chapter 3. Configuringthe NetworkingHardware<br>
50<br>
<hr>
<A name=67></a><b>3.1. Kernel Configuration</b><br>
Most Linux distributions are supplied with boot disks that work for all common types of PC hardware.<br>Generally, the supplied kernel is highly modularized and includes nearly every possible driver. This is a great<br>idea for boot disks, but is probably not what you'd want for long−term use. There isn't much point in having<br>drivers cluttering up your disk that you will never use. Therefore, you will generally roll your own kernel and<br>include only those drivers you actually need or want; that way you save a little disk space and reduce the time<br>it takes to compile a new kernel.<br>
In any case, when running a Linux system, you should be familiar with building a kernel. Think of it as a<br>right of passage, an affirmation of the one thing that makes free software as powerful as it isyou have the<br>source. It isn't a case of, I have to compile a kernel, rather it's a case of, I&nbsp;<i>can</i>&nbsp;compile a kernel. The<br>basics of compiling a Linux kernel are explained in Matt Welsh's book,&nbsp;<i>Running Linux</i>&nbsp;(O'Reilly). Therefore,<br>we will discuss only configuration options that affect networking in this section.<br>
&nbsp;One important point that does bear repeating here is the way the kernel version numbering scheme works.<br>Linux kernels are numbered in the following format:&nbsp;2.2.14. The first digit indicates the&nbsp;<i>major</i>&nbsp;version<br>number. This digit changes when there are large and significant changes to the kernel design. For example,<br>the kernel changed from major 1 to 2 when the kernel obtained support for machines other than Intel<br>machines. The second number is the&nbsp;<i>minor</i>&nbsp;version number. In many respects, this number is the most<br>important number to look at. The Linux development community has adopted a standard at which&nbsp;<i>even</i>&nbsp;minor<br>version numbers indicate&nbsp;<i>production</i>, or&nbsp;<i>stable</i>, kernels and&nbsp;<i>odd</i>&nbsp;minor version numbers indicate&nbsp;<i>development</i>,<br>or&nbsp;<i>unstable</i>, kernels. The stable kernels are what you should use on a machine that is important to you, as they<br>have been more thoroughly tested. The development kernels are what you should use if you are interested in<br>experimenting with the newest features of Linux, but they may have problems that haven't yet been found and<br>fixed. The third number is simply incremented for each release of a minor version.[18]<br>
When running&nbsp;<b>make menuconfig</b>, you are presented with a text−based menu that offers lists of configuration<br>questions, such as whether you want kernel math emulation. One of these queries asks you whether you want<br>TCP/IP networking support. You must answer this with&nbsp;y&nbsp;to get a kernel capable of networking.<br>
<b>3.1.1. Kernel Options in Linux 2.0 and Higher</b><br>
After the general option section is complete, the configuration will go on to ask whether you want to include<br>support for various features, such as SCSI drivers or sound cards. The prompt will indicate what options are<br>available. You can press&nbsp;?&nbsp;to obtain a description of what the option is actually offering. You'll always have<br>the option of yes (y) to statically include the component in the kernel, or no (n) to exclude the component<br>completely. You'll also see the module (m) option for those components that may be compiled as a run−time<br>loadable module. Modules need to be loaded before they can be used, and are useful for drivers of<br>components that you use infrequently.<br>
The subsequent list of questions deal with networking support. The exact set of configuration options is in<br>constant flux due to ongoing development. A typical list of options offered by most kernel versions around<br>2.0 and 2.1 looks like this:<br>
*<br>
* Network device support<br>
*<br>
Network device support (CONFIG_NETDEVICES) [Y/n/?]&nbsp;<br>
3.1. Kernel Configuration<br>
51<br>
<hr>
<A name=68></a>Linux Network Administrators Guide<br>
You must answer this question with&nbsp;y&nbsp;if you want to use&nbsp;<i>any</i>&nbsp;type of networking devices, whether they are<br>Ethernet, SLIP, PPP, or whatever. When you answer the question with&nbsp;y, support for Ethernet−type devices<br>is enabled automatically. You must answer additional questions if you want to enable support for other types<br>of network drivers:<br>
PLIP (parallel port) support (CONFIG_PLIP) [N/y/m/?] y<br>
PPP (point−to−point) support (CONFIG_PPP) [N/y/m/?] y<br>
*<br>
* CCP compressors for PPP are only built as modules.<br>
*<br>
SLIP (serial line) support (CONFIG_SLIP) [N/y/m/?] m<br>
&nbsp;CSLIP compressed headers (CONFIG_SLIP_COMPRESSED) [N/y/?] (NEW) y<br>
&nbsp;Keepalive and linefill (CONFIG_SLIP_SMART) [N/y/?] (NEW) y<br>
&nbsp;Six bit SLIP encapsulation (CONFIG_SLIP_MODE_SLIP6) [N/y/?] (NEW) y<br>
&nbsp;These questions concern the various link layer protocols that Linux supports. Both PPP and SLIP allow you<br>to transport IP datagrams across serial lines. PPP is actually a suite of protocols used to send network traffic<br>across serial lines. Some of the protocols that form PPP manage the way that you authenticate yourself to the<br>dial−in server, while others manage the way certain protocols are carried across the linkPPP is not limited to<br>carrying TCP/IP datagrams; it may also carry other protocol such as IPX.<br>
If you answer&nbsp;y&nbsp;or&nbsp;m&nbsp;to SLIP support, you will be prompted to answer the three questions that appear below<br>it. The compressed header option provides support for CSLIP, a technique that compresses TCP/IP headers to<br>as little as three bytes. Note that this kernel option does not turn on CSLIP automatically; it merely provides<br>the necessary kernel functions for it. The&nbsp;Keepalive and linefill&nbsp;option causes the SLIP support to<br>periodically generate activity on the SLIP line to avoid it being dropped by an inactivity timer. The&nbsp;Six<br>bit SLIP encapsulation&nbsp;option allows you to run SLIP over lines and circuits that are not capable of<br>transmitting the whole 8−bit data set cleanly. This is similar to the uuencoding or binhex technique used to<br>send binary files by electronic mail.<br>
PLIP provides a way to send IP datagrams across a parallel port connection. It is mostly used to communicate<br>with PCs running DOS. On typical PC hardware, PLIP can be faster than PPP or SLIP, but it requires much<br>more CPU overhead to perform, so while the transfer rate might be good, other tasks on the machine may be<br>slow.<br>
The following questions address network cards from various vendors. As more drivers are being developed,<br>you are likely to see questions added to this section. If you want to build a kernel you can use on a number of<br>different machines, or if your machine has more than one type of network card installed, you can enable more<br>than one driver:<br>
&nbsp;.<br>
&nbsp;.<br>
Ethernet (10 or 100Mbit) (CONFIG_NET_ETHERNET) [Y/n/?]&nbsp;<br>
3COM cards (CONFIG_NET_VENDOR_3COM) [Y/n/?]&nbsp;<br>
3c501 support (CONFIG_EL1) [N/y/m/?]<br>
3c503 support (CONFIG_EL2) [N/y/m/?]<br>
3c509/3c579 support (CONFIG_EL3) [Y/m/n/?]<br>
3c590/3c900 series (592/595/597/900/905) &quot;Vortex/Boomerang&quot; support/<br>
&nbsp; &nbsp; (CONFIG_VORTEX) [N/y/m/?]<br>
AMD LANCE and PCnet (AT1500 and NE2100) support (CONFIG_LANCE) [N/y/?]<br>
AMD PCInet32 (VLB and PCI) support (CONFIG_LANCE32) [N/y/?] (NEW)<br>
Western Digital/SMC cards (CONFIG_NET_VENDOR_SMC) [N/y/?]<br>
WD80*3 support (CONFIG_WD80x3) [N/y/m/?] (NEW)<br>
SMC Ultra support (CONFIG_ULTRA) [N/y/m/?] (NEW)<br>
SMC Ultra32 support (CONFIG_ULTRA32) [N/y/m/?] (NEW)<br>
3.1. Kernel Configuration<br>
52<br>
<hr>
<A name=69></a>Linux Network Administrators Guide<br>
SMC 9194 support (CONFIG_SMC9194) [N/y/m/?] (NEW)<br>
Other ISA cards (CONFIG_NET_ISA) [N/y/?]<br>
Cabletron E21xx support (CONFIG_E2100) [N/y/m/?] (NEW)<br>
DEPCA, DE10x, DE200, DE201, DE202, DE422 support (CONFIG_DEPCA) [N/y/m/?]/&nbsp;<br>
&nbsp; &nbsp; (NEW)<br>
EtherWORKS 3 (DE203, DE204, DE205) support (CONFIG_EWRK3) [N/y/m/?] (NEW)<br>
EtherExpress 16 support (CONFIG_EEXPRESS) [N/y/m/?] (NEW)<br>
HP PCLAN+ (27247B and 27252A) support (CONFIG_HPLAN_PLUS) [N/y/m/?] (NEW)<br>
HP PCLAN (27245 and other 27xxx series) support (CONFIG_HPLAN) [N/y/m/?]/&nbsp;<br>
&nbsp; &nbsp; (NEW)<br>
HP 10/100VG PCLAN (ISA, EISA, PCI) support (CONFIG_HP100) [N/y/m/?] (NEW)<br>
NE2000/NE1000 support (CONFIG_NE2000) [N/y/m/?] (NEW)<br>
SK_G16 support (CONFIG_SK_G16) [N/y/?] (NEW)<br>
EISA, VLB, PCI and on card controllers (CONFIG_NET_EISA) [N/y/?]<br>
Apricot Xen−II on card ethernet (CONFIG_APRICOT) [N/y/m/?] (NEW)<br>
Intel EtherExpress/Pro 100B support (CONFIG_EEXPRESS_PRO100B) [N/y/m/?]/&nbsp;<br>
&nbsp; &nbsp; (NEW)<br>
DE425, DE434, DE435, DE450, DE500 support (CONFIG_DE4X5) [N/y/m/?] (NEW)<br>
DECchip Tulip (dc21x4x) PCI support (CONFIG_DEC_ELCP) [N/y/m/?] (NEW)<br>
Digi Intl. RightSwitch SE−X support (CONFIG_DGRS) [N/y/m/?] (NEW)<br>
Pocket and portable adaptors (CONFIG_NET_POCKET) [N/y/?]<br>
AT−LAN−TEC/RealTek pocket adaptor support (CONFIG_ATP) [N/y/?] (NEW)<br>
D−Link DE600 pocket adaptor support (CONFIG_DE600) [N/y/m/?] (NEW)<br>
D−Link DE620 pocket adaptor support (CONFIG_DE620) [N/y/m/?] (NEW)<br>
Token Ring driver support (CONFIG_TR) [N/y/?]<br>
IBM Tropic chipset based adaptor support (CONFIG_IBMTR) [N/y/m/?] (NEW)<br>
FDDI driver support (CONFIG_FDDI) [N/y/?]<br>
Digital DEFEA and DEFPA adapter support (CONFIG_DEFXX) [N/y/?] (NEW)<br>
ARCnet support (CONFIG_ARCNET) [N/y/m/?]<br>
&nbsp; Enable arc0e (ARCnet &quot;Ether−Encap&quot; packet format) (CONFIG_ARCNET_ETH)/&nbsp;<br>
&nbsp; &nbsp; &nbsp; [N/y/?] (NEW)<br>
&nbsp; Enable arc0s (ARCnet RFC1051 packet format) (CONFIG_ARCNET_1051)/&nbsp;<br>
&nbsp; &nbsp; &nbsp; [N/y/?] (NEW)<br>
&nbsp;.<br>
&nbsp;.<br>
Finally, in the file system section, the configuration script will ask you whether you want support for NFS,<br>the networking file system. NFS lets you export file systems to several hosts, which makes the files appear as<br>if they were on an ordinary hard disk attached to the host:<br>
NFS file system support (CONFIG_NFS_FS) [y]<br>
<a href="TLNAGs.html#287">We describe NFS in detail in&nbsp;Chapter 14.</a><br>
<b>3.1.2. Kernel Networking Options in Linux 2.0.0 and Higher</b><br>
&nbsp;Linux 2.0.0 marked a significant change in Linux Networking. Many features were made a standard part of<br>the Kernel, such as support for IPX. A number of options were also added and made configurable. Many of<br>these options are used only in very special circumstances and we won't cover them in detail. The Networking<br>HOWTO probably addresses what is not covered here. We'll list a number of useful options in this section,<br>and explain when you'd want to use each one:<br>
<i>Basics</i><br>
To use TCP/IP networking, you must answer this question with&nbsp;y. If you answer with&nbsp;n, however,<br>you will still be able to compile the kernel with IPX support:<br>
3.1.2. Kernel Networking Options in Linux 2.0.0 and Higher<br>
53<br>
<hr>
<A name=70></a>Linux Network Administrators Guide<br>
Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; [*] TCP/IP networking<br>
<i>Gateways</i><br>
&nbsp;You have to enable this option if your system acts as a gateway between two networks or between<br>a LAN and a SLIP link, etc. It doesn't hurt to enable this by default, but you may want to disable it to<br>configure a host as a so−called&nbsp;<i>firewall</i>. Firewalls are hosts that are connected to two or more<br>networks, but don't route traffic between them. They're commonly used to provide users with Internet<br>access at minimal risk to the internal network. Users are allowed to log in to the firewall and use<br>Internet services, but the company's machines are protected from outside attacks because incoming<br><a href="TLNAGs.html#183">connections can't cross the firewall (firewalls are covered in detail in&nbsp;Chapter 9</a>):<br>
&nbsp; &nbsp; [*] IP: forwarding/gatewaying<br>
<i>Virtual hosting</i><br>
&nbsp;These options together allow to you configure more than one IP address onto an interface. This is<br>sometimes useful if you want to do virtual hosting, through which a single machine can be<br>configured to look and act as though it were actually many separate machines, each with its own<br>network personality. We'll talk more about IP aliasing in a moment:<br>
&nbsp; &nbsp; [*] Network aliasing<br>
&nbsp; &nbsp; &nbsp; &nbsp; &lt;*&gt; IP: aliasing support<br>
<i>Accounting</i><br>
This option enables you to collect data on the volume of IP traffic leaving and arriving at your<br>machine (we cover this is detail in&nbsp;<a href="TLNAGs.html#230">Chapter 10</a>):<br>
&nbsp; &nbsp; [*] IP: accounting<br>
<i>PC hug</i><br>
This option works around an incompatibility with some versions of PC/TCP, a commercial TCP/IP<br>implementation for DOS−based PCs. If you enable this option, you will still be able to communicate<br>with normal Unix machines, but performance may be hurt over slow links:<br>
&nbsp; &nbsp; −−− (it is safe to leave these untouched)<br>
&nbsp; &nbsp; [*] IP: PC/TCP compatibility mode<br>
<i>Diskless booting</i><br>
This function enables&nbsp;<i>Reverse Address Resolution Protocol</i>&nbsp;(RARP). RARP is used by diskless<br>clients and X terminals to request their IP address when booting. You should enable RARP if you<br>plan to serve this sort of client. A small program called&nbsp;<b>rarp</b>, included with the standard networking<br>utilities, is used to add entries to the kernel RARP table:<br>
&nbsp; &nbsp; &lt;*&gt; IP: Reverse ARP<br>
<i>MTU</i><br>
3.1.2. Kernel Networking Options in Linux 2.0.0 and Higher<br>
54<br>
<hr>
<A name=71></a>Linux Network Administrators Guide<br>
&nbsp;When sending data over TCP, the kernel has to break up the stream into blocks of data to pass to<br>IP. The size of the block is called the&nbsp;<i>Maximum Transmission Unit</i>, or MTU. For hosts that can be<br>reached over a local network such as an Ethernet, it is typical to use an MTU as large as the<br>maximum length of an Ethernet packet¡,500 bytes. When routing IP over a Wide Area Network<br>like the Internet, it is preferable to use smaller−sized datagrams to ensure that they don't need to be<br>further broken down along the route through a process called&nbsp;<i>IP fragmentation</i>.[19]&nbsp;The kernel is<br>able to automatically determine the smallest MTU of an IP route and to automatically configure a<br>TCP connection to use it. This behavior is on by default. If you answer&nbsp;y&nbsp;to this option this feature<br>will be disabled.<br>
If you do want to use smaller packet sizes for data sent to specific hosts (because, for example, the<br>data goes through a SLIP link), you can do so using the&nbsp;<b>mss</b>&nbsp;option of the&nbsp;<b>route</b>&nbsp;command, which is<br>briefly discussed at the end of this chapter:<br>
&nbsp; &nbsp; [ ] IP: Disable Path MTU Discovery (normally enabled)<br>
<i>Security feature</i><br>
&nbsp;The IP protocol supports a feature called&nbsp;<i>Source Routing</i>. Source routing allows you to specify the<br>route a datagram should follow by coding the route into the datagram itself. This was once probably<br>useful before routing protocols such as RIP and OSPF became commonplace. But today it's<br>considered a security threat because it can provide clever attackers with a way of circumventing<br>certain types of firewall protection by bypassing the routing table of a router. You would normally<br>want to filter out source routed datagrams, so this option is normally enabled:<br>
&nbsp; &nbsp; [*] IP: Drop source routed frames<br>
<i>Novell support</i><br>
&nbsp;This option enables support for IPX, the transport protocol Novell Networking uses. Linux will<br>function quite happily as an IPX router and this support is useful in environments where you have<br>Novell fileservers. The NCP filesystem also requires IPX support enabled in your kernel; if you wish<br>to attach to and mount your Novell filesystems you must have this option enabled (we'll dicuss IPX<br><a href="TLNAGs.html#299">and the NCP filesystem in&nbsp;Chapter 15):</a><br>
&nbsp; &nbsp; &lt;*&gt; The IPX protocol<br>
<i>Amateur radio</i><br>
&nbsp;These three options select support for the three Amateur Radio protocols supported by Linux:<br>AX.25, NetRom and Rose (we don't describe them in this book, but they are covered in detail in the<br>AX25 HOWTO):<br>
&nbsp; &nbsp; &lt;*&gt; Amateur Radio AX.25 Level 2<br>
&nbsp; &nbsp; &lt;*&gt; Amateur Radio NET/ROM<br>
&nbsp; &nbsp; &lt;*&gt; Amateur Radio X.25 PLP (Rose)<br>
Linux supports another driver type: the dummy driver. The following question appears toward the<br>start of the device−driver section:<br>
&nbsp; &nbsp; &lt;*&gt; Dummy net driver support<br>
3.1.2. Kernel Networking Options in Linux 2.0.0 and Higher<br>
55<br>
<hr>
<A name=72></a>Linux Network Administrators Guide<br>
The dummy driver doesn't really do much, but it is quite useful on standalone or PPP/SLIP hosts. It is<br>basically a masqueraded loopback interface. On hosts that offer PPP/SLIP but have no other network<br>interface, you want to have an interface that bears your IP address all the time. This is discussed in a<br>little more detail in&nbsp;<a href="TLNAGs.html#110">Section 5.7.7&quot; in&nbsp;</a><a href="TLNAGs.html#97">Chapter 5</a>. Note that today you can achieve the same result by<br>using the IP alias feature and configuring your IP address as an alias on the loopback interface.<br>
3.1.2. Kernel Networking Options in Linux 2.0.0 and Higher<br>
56<br>
<hr>
<A name=73></a><b>3.2. A Tour of Linux Network Devices</b><br>
The Linux kernel supports a number of hardware drivers for various types of equipment. This section gives a<br>short overview of the driver families available and the interface names they use.<br>
There is a number of standard names for interfaces in Linux, which are listed here. Most drivers support more<br>than one interface, in which case the interfaces are numbered, as in&nbsp;eth0&nbsp;and&nbsp;eth1:<br>
<i>lo</i><br>
&nbsp;This is the local loopback interface. It is used for testing purposes, as well as a couple of network<br>applications. It works like a closed circuit in that any datagram written to it will immediately be<br>returned to the host's networking layer. There's always one loopback device present in the kernel, and<br>there's little sense in having more.<br>
<i>eth0,&nbsp;eth1, &amp;</i><br>
These are the Ethernet card interfaces. They are used for most Ethernet cards, including many of the<br>parallel port Ethernet cards.<br>
<i>tr0,&nbsp;tr1, &amp;</i><br>
These are the Token Ring card interfaces. They are used for most Token Ring cards, including<br>non−IBM manufactured cards.<br>
<i>sl0,&nbsp;sl1, &amp;</i><br>
These are the SLIP interfaces. SLIP interfaces are associated with serial lines in the order in which<br>they are allocated for SLIP.<br>
<i>ppp0,&nbsp;ppp1, &amp;</i><br>
These are the PPP interfaces. Just like SLIP interfaces, a PPP interface is associated with a serial line<br>once it is converted to PPP mode.<br>
<i>plip0,&nbsp;plip1, &amp;</i><br>
&nbsp;These are the PLIP interfaces. PLIP transports IP datagrams over parallel lines. The interfaces are<br>allocated by the PLIP driver at system boot time and are mapped onto parallel ports. In the<br><i>2.0.x</i>&nbsp;kernels there is a direct relationship between the device name and the I/O port of the parallel<br>port, but in later kernels the device names are allocated sequentially, just as for SLIP and PPP devices.<br>
<i>ax0,&nbsp;ax1, &amp;</i><br>
&nbsp;These are the AX.25 interfaces. AX.25 is the primary protocol used by amateur radio operators.<br>AX.25 interfaces are allocated and mapped in a similar fashion to SLIP devices.<br>
There are many other types of interfaces available for other network drivers. We've listed only the most<br>common ones.<br>
3.2. A Tour of Linux Network Devices<br>
57<br>
<hr>
<A name=74></a>Linux Network Administrators Guide<br>
During the next few sections, we will discuss the details of using the drivers described previously. The<br>Networking HOWTO provides details on how to configure most of the others, and the AX25 HOWTO<br>explains how to configure the Amateur Radio network devices.<br>
3.2. A Tour of Linux Network Devices<br>
58<br>
<hr>
<A name=75></a><b>3.3. Ethernet Installation</b><br>
The current Linux network code supports a large variety of Ethernet cards. Most drivers were written by<br>Donald Becker, who authored a family of drivers for cards based on the National Semiconductor 8390 chip;<br>these have become known as the Becker Series Drivers. Many other developers have contributed drivers, and<br>today there are few common Ethernet cards that aren't supported by Linux. The list of supported Ethernet<br>cards is growing all the time, so if your card isn't supported yet, chances are it will be soon.<br>
Sometime earlier in Linux's history we would have attempted to list all supported Ethernet cards, but that<br>would now take too much time and space. Fortunately, Paul Gortmaker maintains the Ethernet HOWTO,<br>which lists each of the supported cards and provides useful information about getting each of them running<br>under Linux.[20]&nbsp;It is posted monthly to the comp.os.linux.answers newsgroup, and is also available on any<br>of the Linux Documentation Project mirror sites.<br>
Even if you are confident you know how to install a particular type of Ethernet card in your machine, it is<br>often worthwhile taking a look at what the Ethernet HOWTO has to say about it. You will find information<br>that extends beyond simple configuration issues. For example, it could save you a lot of headaches to know<br>the behavior of some DMA−based Ethernet cards that use the same DMA channel as the Adaptec 1542 SCSI<br>controller by default. Unless you move one of them to a different DMA channel, you will wind up with the<br>Ethernet card writing packet data to arbitrary locations on your hard disk.<br>
To use any of the supported Ethernet cards with Linux, you may use a precompiled kernel from one of the<br>major Linux distributions. These generally have modules available for all of the supported drivers, and the<br>installation process usually allows you to select which drivers you want loaded. In the long term, however,<br>it's better to build your own kernel and compile only those drivers you actually need; this saves disk space<br>and memory.<br>
<b>3.3.1. Ethernet Autoprobing</b><br>
Many of the Linux Ethernet drivers are smart enough to know how to search for the location of your Ethernet<br>card. This saves you having to tell the kernel where it is manually. The Ethernet HOWTO lists whether a<br>particular driver uses autoprobing and in which order it searches the I/O address for the card.<br>
There are three limitations to the autoprobing code. First, it may not recognize all cards properly. This is<br>especially true for some of the cheaper clones of common cards. Second, the kernel won't autoprobe for more<br>than one card unless specifically instructed. This was a conscious design decision, as it is assumed you will<br>want to have control over which card is assigned to which interface. The best way to do this reliably is to<br>manually configure the Ethernet cards in your machine. Third, the driver may not probe at the address that<br>your card is configured for. Generally speaking, the drivers will autoprobe at the addresses that the particular<br>device is capable of being configured for, but sometimes certain addresses are ignored to avoid hardware<br>conflicts with other types of cards that commonly use that same address.<br>
PCI network cards should be reliably detected. But if you are using more than one card, or if the autoprobe<br>should fail to detect your card, you have a way to explicitly tell the kernel about the card's base address and<br>name.<br>
&nbsp;At boot time you can supply arguments and information to the kernel that any of the kernel components<br>may read. This mechanism allows you to pass information to the kernel that Ethernet drivers can use to locate<br>
3.3. Ethernet Installation<br>
59<br>
<hr>
<A name=76></a>Linux Network Administrators Guide<br>
your Ethernet hardware without making the driver probe.<br>
If you use lilo to boot your system, you can pass parameters to the kernel by specifying them through the<br>append option in the&nbsp;lilo.conf&nbsp;file. To inform the kernel about an Ethernet device, you can pass the<br>following parameters:<br>
ether=<i>irq</i>,<i>base_addr</i>,[<i>param1</i>,][<i>param2</i>,]<i>name</i><br>
The first four parameters are numeric, while the last is the device name. The&nbsp;<i>irq</i>,&nbsp;<i>base_addr</i>, and<br><i>name</i>&nbsp;parameters are required, but the two&nbsp;<i>param</i>&nbsp;parameters are optional. Any of the numeric values may<br>be set to zero, which causes the kernel to determine the value by probing.<br>
&nbsp;The first parameter sets the IRQ assigned to the device. By default, the kernel will try to autodetect the<br>device's IRQ channel. The 3c503 driver, for example, has a special feature that selects a free IRQ from the<br>list 5, 9, 3, 4 and configures the card to use this line. The&nbsp;<i>base_addr</i>&nbsp;parameter gives the I/O base address<br>of the card; a value of zero tells the kernel to probe the addresses listed above.<br>
Different drivers use the next two parameters differently. For shared−memory cards, such as the WD80x3,<br>they specify starting and ending addresses of the shared memory area. Other cards commonly use&nbsp;<i>param1</i>&nbsp;to<br>set the level at which debugging information is displayed. Values of 1 through 7 denote increasing levels of<br>verbosity, while 8 turns them off altogether; 0 denotes the default. The 3c503 driver uses&nbsp;<i>param2</i>&nbsp;to choose<br>between the internal transceiver (default) or an external transceiver (a value of 1). The former uses the card's<br>BNC connector; the latter uses its AUI port. The&nbsp;<i>param</i>&nbsp;arguments need not be included at all if you don't<br>have anything special to configure.<br>
The first non−numeric argument is interpreted by the kernel as the device name. You must specify a device<br>name for each Ethernet card you describe.<br>
If you have two Ethernet cards, you can have Linux autodetect one card and pass the second card's<br>parameters with&nbsp;<b>lilo</b>, but you'll probably want to manually configure both cards. If you decide to have the<br>kernel probe for one and manually configure the second, you must make sure the kernel doesn't accidentally<br>find the second card first, or else the other one won't be registered at all. You do this by passing&nbsp;<b>lilo</b>&nbsp;a<br>reserve option, which explicitly tells the kernel to avoid probing the I/O space taken up by the second card.<br>For instance, to make Linux install a second Ethernet card at&nbsp;0x300&nbsp;as&nbsp;eth1, you would pass the following<br>parameters to the kernel:<br>
reserve=0x300,32 ether=0,0x300,eth1<br>
The&nbsp;<i>reserve</i>&nbsp;option makes sure no driver accesses the second card's I/O space when probing for some device.<br>You may also use the kernel parameters to override autoprobing for&nbsp;eth0:<br>
reserve=0x340,32 ether=0,0x340,eth0<br>
You can turn off autoprobing altogether. You might do this, for example, to stop a kernel probing for an<br>Ethernet card you might have temporarily removed. Disabling autoprobing is as simple as specifying a<br><i>base_addr</i>&nbsp;argument of −1:<br>
ether=0,−1,eth0<br>
To supply these parameters to the kernel at boot time, you enter the parameters at the lilo &quot;boot:&quot; prompt. To<br>have&nbsp;<b>lilo</b>&nbsp;give you the &quot;boot:&quot; at the prompt, you must press any one of the Control, Alt or Shift keys while<br>
3.3. Ethernet Installation<br>
60<br>
<hr>
<A name=77></a>Linux Network Administrators Guide<br>
<b>lilo</b>&nbsp;is booting. If you press the Tab key at the prompt, you will be presented with a list of kernels that you<br>may boot. To boot a kernel with parameters supplied, enter the name of the kernel you wish to boot, followed<br>by a space, then followed by the parameters you wish to supply. When you press the Enter key,&nbsp;<b>lilo</b>&nbsp;will load<br>that kernel and boot it with the parameters you've supplied.<br>
To make this change occur automatically on each reboot, enter the parameters into the<br>/etc/lilo.conf&nbsp;using the&nbsp;append=&nbsp;keyword. An example might look like this:<br>
boot=/dev/hda<br>
root=/dev/hda2<br>
install=/boot/boot.b<br>
map=/boot/map<br>
vga=normal<br>
delay=20<br>
append=&quot;ether=10,300,eth0&quot;<br>
image=/boot/vmlinuz−2.2.14<br>
label=2.2.14<br>
read−only<br>
After you've edited&nbsp;lilo.conf, you must rerun the&nbsp;<b>lilo</b>&nbsp;command to activate the change.<br>
3.3. Ethernet Installation<br>
61<br>
<hr>
<A name=78></a><b>3.4. The PLIP Driver</b><br>
<i>Parallel Line IP</i>&nbsp;(PLIP) is a cheap way to network when you want to connect only two machines. It uses a<br>parallel port and a special cable, achieving speeds of 10 kilobytes per second to 20 kilobytes per second.<br>
PLIP was originally developed by Crynwr, Inc. Its design at the time was rather ingenious (or, if you prefer, a<br>hack), because the original parallel ports on IBM PCs were designed to spend their time being unidirectional<br>printer ports; the eight data lines could be used only to send data from the PC to the peripheral device, but not<br>the other way around.[21]&nbsp;The Cyrnwr PLIP design worked around this limitation by using the port's five<br>status lines for input, which limited it to transferring all data as nibbles (half bytes) only, but allowed for<br>bidirectional transfer. This mode of operation was called PLIP mode 0. Today, the parallel ports supplied<br>on PC hardware cater to full bidirectional 8−bit data transfer, and PLIP has been extended to accomodate this<br>with the addition of PLIP mode 1.<br>
Linux kernels up to and including Version 2.0 support PLIP mode 0 only, and an enhanced parallel port<br>driver exists as a patch against the 2.0 kernel and as a standard part of the 2.2 kernel code to provide PLIP<br>mode 1 operation, too.&nbsp;[22]&nbsp;Unlike earlier versions of the PLIP code, the driver now attempts to be<br>compatible with the PLIP implementations from Crynwr, as well as the PLIP driver in NCSA&nbsp;<b>telnet</b>.[23]&nbsp;To<br>connect two machines using PLIP, you need a special cable sold at some shops as a Null Printer or Turbo<br>Laplink cable. You can, however, make one yourself fairly easily;&nbsp;<a href="TLNAGs.html#489">Appendix B</a>&nbsp;shows you how.<br>
The PLIP driver for Linux is the work of almost countless persons. It is currently maintained by Niibe<br>Yutaka.[24]&nbsp;If compiled into the kernel, it sets up a network interface for each of the possible printer ports,<br>with&nbsp;plip0&nbsp;corresponding to parallel port&nbsp;lp0,&nbsp;plip1&nbsp;corresponding to&nbsp;lp1, etc. The mapping of<br>interfaces to ports differs in the 2.0 kernels and the 2.2 kernels. In the 2.0 kernels, the mapping was hardwired<br>in the&nbsp;drivers/net/Spacd.c&nbsp;file in the kernel source. The default mappings in this file are:<br>
<b>Interface&nbsp;I/O Port&nbsp;IRQ</b><br>
plip0<br>
0x3BC<br>
7<br>
plip1<br>
0x378<br>
7<br>
plip2<br>
0x278<br>
5<br>
If you configured your printer port in a different way, you must change these values in<br>drivers/net/Space.c&nbsp;in the Linux kernel source and build a new kernel.<br>
In the 2.2 kernels, the PLIP driver uses the parport parallel port sharing driver developed by Philip<br>Blundell.[25]&nbsp;The new driver allocates the PLIP network device names serially, just as for the Ethernet or<br>PPP drivers, so the first PLIP device created is&nbsp;plip0, the second is&nbsp;plip1, and so on. The physical<br>parallel port hardware is also allocated serially. By default, the parallel port driver will attempt to detect your<br>parallel port hardware with an autoprobe routine, recording the physical device information in the order<br>found. It is better practice to explicitly tell the kernel the physical I/O parameters. You can do this by<br>supplying arguments to the&nbsp;parport_pc.o&nbsp;module as you load it, or if you have compiled the driver into<br>your kernel, using lilo to supply arguments to the kernel at boot time. The IRQ setting of any device may be<br>changed later by writing the new IRQ value to the related&nbsp;/proc/parport/*/irq&nbsp;file.<br>
Configuring the physical I/O parameters in a 2.2 kernel when loading the module is straightforward. For<br>instance, to tell the driver that you have two PC−style parallel ports at I/O addresses&nbsp;0x278&nbsp;and&nbsp;0c378&nbsp;and<br>
3.4. The PLIP Driver<br>
62<br>
<hr>
<A name=79></a>Linux Network Administrators Guide<br>
IRQs 5 and 7, respectively, you would load the module with the following arguments:<br>
modprobe parport_ &nbsp; &nbsp; &nbsp; pc io=0x278,0x378 irq=5,7<br>
The corresponding arguments to pass to the kernel for a compiled−in driver are:<br>
parport=0x278,5 parport=0x378,7<br>
You would use the lilo append keyword to have these arguments passed to the kernel automatically at boot<br>time.<br>
When the PLIP driver is initialized, either at boot time if it is built−in, or when the&nbsp;plip.o&nbsp;module is<br>loaded, each of the parallel ports will have a&nbsp;plip&nbsp;network device associated with it.&nbsp;plip0&nbsp;will be<br>assigned to the first parallel port device,&nbsp;plip1&nbsp;the second, and so on. You can manually override this<br>automatic assignment using another set of kernel arguments. For instance, to assign&nbsp;parport0&nbsp;to network<br>device&nbsp;plip0, and&nbsp;parport1&nbsp;to network device&nbsp;plip1, you would use kernel arguments of:<br>
plip=parport1 plip=parport0<br>
This mapping does not mean, however, that you cannot use these parallel ports for printing or other purposes.<br>The physical parallel port devices are used by the PLIP driver only when the corresponding interface is<br>configured up.<br>
3.4. The PLIP Driver<br>
63<br>
<hr>
<A name=80></a><b>3.5. The PPP and SLIP Drivers</b><br>
Point−to−Point Protocol (PPP) and Serial Line IP (SLIP) are widely used protocols for carrying IP packets<br>over a serial link. A number of institutions offer dialup PPP and SLIP access to machines that are on the<br>Internet, thus providing IP connectivity to private persons (something that's otherwise hardly affordable).<br>
No hardware modifications are necessary to run PPP or SLIP; you can use any serial port. Since serial port<br>configuration is not specific to TCP/IP networking, we have devoted a separate chapter to this. Please refer to<br><a href="TLNAGs.html#82">Chapter 4</a><a href="TLNAGs.html#162">, for more information. We cover PPP in detail in&nbsp;Chapter 8</a>, and SLIP in&nbsp;<a href="TLNAGs.html#148">Chapter 7.</a><br>
3.5. The PPP and SLIP Drivers<br>
64<br>
<hr>
<A name=81></a><b>3.6. Other Network Types</b><br>
&nbsp;Most other network types are configured similarly to Ethernet. The arguments passed to the loadable<br>modules will be different and some drivers may not support more than one card, but just about everything<br>else is the same. Documentation for these cards is generally available in the<br>/usr/src/linux/Documentation/networking/&nbsp;directory of the Linux kernel source.<br>
3.6. Other Network Types<br>
65<br>
<hr>
<A name=82></a><b>Chapter 4. Configuring the Serial Hardware</b><br>
The Internet is growing at an incredible rate. Much of this growth is attributed to Internet users who can't<br>afford high−speed permanent network connections and who use protocols such as SLIP, PPP, or UUCP to<br>dial in to a network provider to retrieve their daily dose of email and news.<br>
&nbsp;This chapter is intended to help all people who rely on modems to maintain their link to the outside world.<br>We won't cover the mechanics of how to configure your modem (the manual that came with it will tell you<br>more about it than we can), but we will cover most of the Linux−specific aspects of managing devices that<br>use serial ports. Topics include serial communications software, creating the serial device files, serial<br>hardware, and configuring serial devices using the&nbsp;<b>setserial</b>&nbsp;and&nbsp;<b>stty</b>&nbsp;commands. Many other related topics<br>are covered in the Serial HOWTO by David Lawyer.[26]<br>
Chapter 4. Configuring the Serial Hardware<br>
66<br>
<hr>
<A name=83></a><b>4.1. Communications Software for Modem Links</b><br>
There are a number of communications packages available for Linux. Many of these packages are&nbsp;<i>terminal<br>programs</i>, which allow a user to dial in to another computer as if she were sitting in front of a simple<br>terminal. The traditional terminal program for Unix−like environments is&nbsp;<b>kermit</b>. It is, however, fairly<br>ancient now, and would probably be considered difficult to use. There are more comfortable programs<br>available that support features, like telephone−dialing dictionaries, script languages to automate dialing and<br>logging in to remote computer systems, and a variety of file exchange protocols. One of these programs is<br><b>minicom</b>, which was modeled after some of the most popular DOS terminal programs. X11 users are<br>accommodated, too.&nbsp;<b>seyon</b>&nbsp;is a fully featured X11−based communications program.<br>
Terminal programs aren't the only type of serial communication programs available. Other programs let you<br>connect to a host and download news and email in a single bundle, to read and reply later at your leisure. This<br>can save a lot of time, and is especially useful if you are unfortunate enough to live in an area where your<br>local calls are time−charged. All of the reading and replying time can be spent offline, and when you are<br>ready, you can redial and upload your responses in a single bundle. This all consumes a bit more hard disk<br>because all of the messages have to be stored to your disk before you can read them, but this could be a<br>reasonable trade−off at today's hard drive prices.<br>
&nbsp;UUCP epitomizes this communication software style. It is a program suite that copies files from one host to<br>another and executes programs on a remote host. It is frequently used to transport mail or news in private<br>networks. Ian Taylor's UUCP package, which also runs under Linux, is described in detail in&nbsp;<a href="TLNAGs.html#320">Chapter 16</a>.<br>Other noninteractive communications software is used throughout networks such as Fidonet. Fidonet<br>application ports like&nbsp;<b>ifmail</b>&nbsp;are also available, although we expect that not many people still use them.<br>
PPP and SLIP are in between, allowing both interactive and noninteractive use. Many people use PPP or<br>SLIP to dial in to their campus network or other Internet Service Provider to run FTP and read web pages.<br>PPP and SLIP are also, however, commonly used over permanent or semipermanent connections for<br>LAN−to−LAN coupling, although this is really only interesting with ISDN or other high−speed network<br>connections.<br>
4.1. Communications Software for Modem Links<br>
67<br>
<hr>
<A name=84></a><b>4.2. Introduction to Serial Devices</b><br>
The Unix kernel provides devices for accessing serial hardware, typically called&nbsp;<i>tty</i>&nbsp;devices (pronounced as it<br>is spelled: T−T−Y). This is an abbreviation for&nbsp;<i>Teletype device</i>, which used to be one of the major<br>manufacturers of terminal devices in the early days of Unix. The term is used now for any character−based<br>data terminal. Throughout this chapter, we use the term to refer exclusively to the Linux device files rather<br>than the physical terminal.<br>
Linux provides three classes of tty devices: serial devices, virtual terminals (all of which you can access in<br>turn by pressing Alt−F1 through Alt−F<i>nn</i>&nbsp;on the local console), and pseudo−terminals (similar to a two−way<br>pipe, used by applications such as X11). The former were called tty devices because the original<br>character−based terminals were connected to the Unix machine by a serial cable or telephone line and<br>modem. The latter two were named after the tty device because they were created to behave in a similar<br>fashion from the programmer's perspective.<br>
&nbsp;SLIP and PPP are most commonly implemented in the kernel. The kernel doesn't really treat the&nbsp;<i>tty</i>&nbsp;device<br>as a network device that you can manipulate like an Ethernet device, using commands such as&nbsp;<b>ifconfig</b>.<br>However, it does treat tty devices as places where network devices can be bound. To do this, the kernel<br>changes what is called the line discipline of the tty device. Both SLIP and PPP are line disciplines that<br>may be enabled on tty devices. The general idea is that the serial driver handles data given to it differently,<br>depending on the line discipline it is configured for. In its default line discipline, the driver simply transmits<br>each character it is given in turn. When the SLIP or PPP line discipline is selected, the driver instead reads a<br>block of data, wraps a special header around it that allows the remote end to identify that block of data in a<br>stream, and transmits the new data block. It isn't too important to understand this yet; we'll cover both SLIP<br>and PPP in later chapters, and it all happens automatically for you anyway.<br>
4.2. Introduction to Serial Devices<br>
68<br>
<hr>
<A name=85></a><b>4.3. Accessing Serial Devices</b><br>
Like all devices in a Unix system, serial ports are accessed through device special files, located in the<br>/dev&nbsp;directory. There are two varieties of device files related to serial drivers, and there is one device file of<br>each type for each port. The device will behave slightly differently, depending on which of its device files we<br>open. We'll cover the differences because it will help you understand some of the configurations and advice<br>that you might see relating to serial devices, but in practice you need to use only one of these. At some point<br>in the future, one of them may even disappear completely.<br>
&nbsp;The most important of the two classes of serial device has a major number of 4, and its device special files<br>are named&nbsp;ttyS0,&nbsp;ttyS1, etc. The second variety has a major number of 5, and was designed for use when<br>dialing out (calling out) through a port; its device special files are called&nbsp;cua0,&nbsp;cua1, etc. In the Unix world,<br>counting generally starts at zero, while laypeople tend to start at one. This creates a small amount of<br>confusion for people because&nbsp;COM1:&nbsp;is represented by&nbsp;/dev/ttyS0,&nbsp;COM2:&nbsp;by&nbsp;/dev/ttyS1, etc.<br>Anyone familiar with IBM PC−style hardware knows that&nbsp;COM3:&nbsp;and greater were never really standardized<br>anyway.<br>
The&nbsp;<i>cua</i>, or callout, devices were created to solve the problem of avoiding conflicts on serial devices for<br>modems that have to support both incoming and outgoing connections. Unfortunately, they've created their<br>own problems and are now likely to be discontinued. Let's briefly look at the problem.<br>
Linux, like Unix, allows a device, or any other file, to be opened by more than one process simultaneously.<br>Unfortunately, this is rarely useful with tty devices, as the two processes will almost certainly interfere with<br>each other. Luckily, a mechanism was devised to allow a process to check if a tty device had already been<br>opened by another device before opening it. The mechanism uses what are called&nbsp;<i>lock files</i>. The idea was that<br>when a process wanted to open a tty device, it would check for the existence of a file in a special location,<br>named similarly to the device it intends to open. If the file does not exist, the process creates it and opens the<br>tty device. If the file does exist, the process assumes another process already has the tty device open and takes<br>appropriate action. One last clever trick to make the lock file management system work was writing the<br>process ID (pid) of the process that had created the lock file into the lock file itself; we'll talk more about that<br>in a moment.<br>
The lock file mechanism works perfectly well in circumstances in which you have a defined location for the<br>lock files and all programs know where to find them. Alas, this wasn't always the case for Linux. It wasn't<br>until the Linux Filesystem Standard defined a standard location for lock files when&nbsp;tty&nbsp;lock files began to<br>work correctly. At one time there were at least four, and possibly more locations chosen by software<br>developers to store lock files:&nbsp;/usr/spool/locks/,&nbsp;/var/spool/locks/,&nbsp;/var/lock/, and<br>/usr/lock/. Confusion caused chaos. Programs were opening lock files in different locations that were<br>meant to control a single tty device; it was as if lock files weren't being used at all.<br>
The&nbsp;cua&nbsp;devices were created to provide a solution to this problem. Rather than relying on the use of lock<br>files to prevent clashes between programs wanting to use the serial devices, it was decided that the kernel<br>could provide a simple means of arbitrating who should be given access. If the&nbsp;ttyS&nbsp;device were already<br>opened, an attempt to open the&nbsp;cua&nbsp;would result in an error that a program could interpret to mean the device<br>was already being used. If the&nbsp;cua&nbsp;device were already open and an attempt was made to open the&nbsp;ttyS, the<br>request would block; that is, it would be put on hold and wait until the&nbsp;cua&nbsp;device was closed by the other<br>process. This worked quite well if you had a single modem that you had configured for dial−in access and<br>you occasionally wanted to dial out on the same device. But it did not work very well in environments where<br>you had multiple programs wanting to call out on the same device. The only way to solve the contention<br>problem was to use lock files! Back to square one.<br>
4.3. Accessing Serial Devices<br>
69<br>
<hr>
<A name=86></a>Linux Network Administrators Guide<br>
Suffice it to say that the Linux Filesystem Standard came to the rescue and now mandates that lock files be<br>stored in the&nbsp;/var/lock&nbsp;directory, and that by convention, the lock file name for the&nbsp;ttyS1&nbsp;device, for<br>instance, is&nbsp;LCK..ttyS1. The&nbsp;cua&nbsp;lock files should also go in this directory, but use of&nbsp;cua&nbsp;devices is now<br>discouraged.<br>
The&nbsp;cua&nbsp;devices will probably still be around for some time to provide a period of backward compatibility,<br>but in time they will be retired. If you are wondering what to use, stick to the&nbsp;ttyS&nbsp;device and make sure<br>that your system is Linux FSSTND compliant, or at the very least that all programs using the serial devices<br>agree on where the lock files are located. Most software dealing with serial tty devices provides a<br>compile−time option to specify the location of the lock files. More often than not, this will appear as a<br>variable called something like&nbsp;LOCKDIR&nbsp;in the&nbsp;Makefile&nbsp;or in a configuration header file. If you're<br>compiling the software yourself, it is best to change this to agree with the FSSTND−specified location. If<br>you're using a precompiled binary and you're not sure where the program will write its lock files, you can use<br>the following command to gain a hint:<br>
<b>strings&nbsp;</b>binaryfile&nbsp;|&nbsp;<b>grep</b>&nbsp;lock<br>
If the location found does not agree with the rest of your system, you can try creating a symbolic link from<br>the lock directory that the foreign executable wants to use back to&nbsp;/var/lock/. This is ugly, but it will<br>work.<br>
<b>4.3.1. The Serial Device Special Files</b><br>
&nbsp;Minor numbers are identical for both types of serial devices. If you have your modem on one of the ports<br>COM1: through COM4:, its minor number will be the COM port number plus 63. If you are using special<br>serial hardware, such as a high−performance multiple port serial controller, you will probably need to create<br>special device files for it; it probably won't use the standard device driver. The Serial−HOWTO should be<br>able to assist you in finding the appropriate details.<br>
Assume your modem is on COM2:. Its minor number will be 65, and its major number will be 4 for normal<br>use. There should be a device called&nbsp;ttyS1&nbsp;that has these numbers. List the serial ttys in the<br>/dev/&nbsp;directory. The fifth and sixth columns show the major and minor numbers, respectively:<br>
$&nbsp;<b>ls −l /dev/ttyS*</b><br>
0 crw−rw−−−− &nbsp; 1 uucp &nbsp; &nbsp; dialout &nbsp; &nbsp;4, &nbsp;64 Oct 13 &nbsp;1997 /dev/ttyS0<br>
0 crw−rw−−−− &nbsp; 1 uucp &nbsp; &nbsp; dialout &nbsp; &nbsp;4, &nbsp;65 Jan 26 21:55 /dev/ttyS1<br>
0 crw−rw−−−− &nbsp; 1 uucp &nbsp; &nbsp; dialout &nbsp; &nbsp;4, &nbsp;66 Oct 13 &nbsp;1997 /dev/ttyS2<br>
0 crw−rw−−−− &nbsp; 1 uucp &nbsp; &nbsp; dialout &nbsp; &nbsp;4, &nbsp;67 Oct 13 &nbsp;1997 /dev/ttyS3<br>
If there is no device with major number 4 and minor number 65, you will have to create one. Become the<br>superuser and type:<br>
#&nbsp;<b>mknod −m 666 /dev/ttyS1 c 4 65</b><br>
#&nbsp;<b>chown uucp.dialout /dev/ttyS1</b><br>
The various Linux distributions use slightly differing strategies for who should own the serial devices.<br>Sometimes they will be owned by&nbsp;<i>root</i>, and other times they will be owned by another user, such as&nbsp;<b>uucp</b>&nbsp;in<br>our example. Modern distributions have a group specifically for dial−out devices, and any users who are<br>allowed to use them are added to this group.<br>
4.3.1. The Serial Device Special Files<br>
70<br>
<hr>
<A name=87></a>Linux Network Administrators Guide<br>
Some people suggest making&nbsp;/dev/modem&nbsp;a symbolic link to your modem device so that casual users<br>don't have to remember the somewhat unintuitive&nbsp;ttyS1. However, you cannot use&nbsp;modem&nbsp;in one program<br>and the real device file name in another. Their lock files would have different names and the locking<br>mechanism wouldn't work.<br>
4.3.1. The Serial Device Special Files<br>
71<br>
<hr>
<A name=88></a><b>4.4. Serial Hardware</b><br>
RS−232 is currently the most common standard for serial communications in the PC world. It uses a number<br>of circuits for transmitting single bits, as well as for synchronization. Additional lines may be used for<br>signaling the presence of a carrier (used by modems) and for handshaking. Linux supports a wide variety of<br>serial cards that use the RS−232 standard.<br>
Hardware handshake is optional, but very useful. It allows either of the two stations to signal whether it is<br>ready to receive more data, or if the other station should pause until the receiver is done processing the<br>incoming data. The lines used for this are called Clear to Send (CTS) and Ready to Send (RTS),<br>respectively, which explains the colloquial name for hardware handshake: RTS/CTS. The other type of<br>handshake you might be familiar with is called XON/XOFF handshaking. XON/XOFF uses two<br>nominated characters, conventionally Ctrl−S and Ctrl−Q, to signal to the remote end that it should stop and<br>start transmitting data, respectively. While this method is simple to implement and okay for use by dumb<br>terminals, it causes great confusion when you are dealing with binary data, as you may want to transmit those<br>characters as part of your data stream, and not have them interpreted as flow control characters. It is also<br>somewhat slower to take effect than hardware handshake. Hardware handshake is clean, fast, and<br>recommended in preference to XON/XOFF when you have a choice.<br>
&nbsp;In the original IBM PC, the RS−232 interface was driven by a UART chip called the 8250. PCs around the<br>time of the 486 used a newer version of the UART called the 16450. It was slightly faster than the 8250.<br>Nearly all Pentium−based machines have been supplied with an even newer version of the UART called the<br>16550. Some brands (most notably internal modems equipped with the Rockwell chip set) use completely<br>different chips that emulate the behavior of the 16550 and can be treated similarly. Linux supports all of these<br>in its standard serial port driver.[27]<br>
The 16550 was a significant improvement over the 8250 and the 16450 because it offered a 16−byte FIFO<br>buffer. The 16550 is actually a family of UART devices, comprising the 16550, the 16550A, and the<br>16550AFN (later renamed PC16550DN). The differences relate to whether the FIFO actually works; the<br>16550AFN is the one that is sure to work. There was also an NS16550, but its FIFO never really worked<br>either.<br>
The 8250 and 16450 UARTs had a simple 1−byte buffer. This means that a 16450 generates an interrupt for<br>every character transmitted or received. Each interrupt takes a short period of time to service, and this small<br>delay limits 16450s to a reliable maximum bit speed of about 9,600 bps in a typical ISA bus machine.<br>
In the default configuration, the kernel checks the four standard serial ports, COM1: through COM4:. The<br>kernel is also able to automatically detect what UART is used for each of the standard serial ports, and will<br>make use of the enhanced FIFO buffer of the 16550, if it is available.<br>
4.4. Serial Hardware<br>
72<br>
<hr>
<A name=89></a><b>4.5. Using the Configuration Utilities</b><br>
Now let's spend some time looking at the two most useful serial device configuration utilities:&nbsp;<b>setserial</b>&nbsp;and<br><b>stty</b>.<br>
<b>4.5.1. The setserial Command</b><br>
The kernel will make its best effort to correctly determine how your serial hardware is configured, but the<br>variations on serial device configuration makes this determination difficult to achieve 100 percent reliably in<br>practice. A good example of where this is a problem is the internal modems we talked about earlier. The<br>UART they use has a 16−byte FIFO buffer, but it looks like a 16450 UART to the kernel device driver:<br>unless we specifically tell the driver that this port is a 16550 device, the kernel will not make use of the<br>extended buffer. Yet another example is that of the dumb 4−port cards that allow sharing of a single IRQ<br>among a number of serial devices. We may have to specifically tell the kernel which IRQ port it's supposed to<br>use, and that IRQs may be shared.<br>
<b>setserial</b>&nbsp;was created to configure the serial driver at runtime. The&nbsp;<b>setserial</b>&nbsp;command is most commonly<br>executed at boot time from a script called&nbsp;0setserial&nbsp;on some distributions, and&nbsp;rc.serial&nbsp;on others.<br>This script is charged with the responsibility of initializing the serial driver to accommodate any nonstandard<br>or unusual serial hardware in the machine.<br>
The general syntax for the&nbsp;<b>setserial</b>&nbsp;command is:<br>
setserial&nbsp;<i>device</i>&nbsp;[<i>parameters</i>]<br>
in which the device is one of the serial devices, such as&nbsp;<i>ttyS0</i>.<br>
The&nbsp;<b>setserial</b>&nbsp;command has a large number of parameters. The most common of these are described in&nbsp;<a href="TLNAGs.html#89">Table<br>4−1</a>. For information on the remainder of the parameters, you should refer to the&nbsp;<b>setserial</b>&nbsp;manual page.<br>
<b>Table 4−1. setserial Command−Line Parameters</b><br>
<b>Parameter</b><br>
<b>Description</b><br>
port<i>&nbsp;port_number</i><br>
Specify the I/O port address of the serial device. Port numbers should be specified<br>in hexadecimal notation, e.g.,&nbsp;0x2f8.<br>
irq<i>&nbsp;num</i><br>
Specify the interrupt request line the serial device is using.<br>
uart<i>&nbsp;uart_type</i><br>
Specify the UART type of the serial device. Common values are&nbsp;16450,&nbsp;16550,<br>etc. Setting this value to&nbsp;none&nbsp;will disable this serial device.<br>
fourport<br>
Specifying this parameter instructs the kernel serial driver that this port is one port<br>of an AST Fourport card.<br>
spd_hi<br>
4.5. Using the Configuration Utilities<br>
73<br>
<hr>
<A name=90></a>Linux Network Administrators Guide<br>
Program the UART to use a speed of 57.6 kbps when a process requests 38.4 kbps.<br>
spd_vhi<br>
Program the UART to use a speed of 115 kbps when a process requests 38.4 kbps.<br>
spd_normal<br>
Program the UART to use the default speed of 38.4 kbps when requested. This<br>parameter is used to reverse the effect of a&nbsp;spd_hi&nbsp;or&nbsp;spd_vhi&nbsp;performed on the<br>specified serial device.<br>
auto_irq<br>
This parameter will cause the kernel to attempt to automatically determine the IRQ<br>of the specified device. This attempt may not be completely reliable, so it is<br>probably better to think of this as a request for the kernel to guess the IRQ. If you<br>know the IRQ of the device, you should specify that it use the&nbsp;irq&nbsp;parameter<br>instead.<br>
autoconfig<br>
This parameter must be specified in conjunction with the&nbsp;port&nbsp;parameter. When<br>this parameter is supplied,&nbsp;<b>setserial</b>&nbsp;instructs the kernel to attempt to automatically<br>determine the UART type located at the supplied port address. If the<br>auto_irq&nbsp;parameter is also supplied, the kernel attempts to automatically<br>determine the IRQ, too.<br>
skip_test<br>
This parameter instructs the kernel not to bother performing the UART type test<br>during auto−configuration. This is necessary when the UART is incorrectly<br>detected by the kernel.<br>
A typical and simple&nbsp;rc&nbsp;file to configure your serial ports at boot time might look something like that shown<br><a href="TLNAGs.html#90">in&nbsp;Example 4−1</a>. Most Linux distributions will include something slightly more sophisticated than this one.<br>
<b>Example 4−1. Example rc.serial setserial Commands</b><br>
# /etc/rc.serial − serial line configuration script.<br>
#<br>
# Configure serial devices<br>
/sbin/setserial /dev/ttyS0 auto_irq skip_test autoconfig<br>
/sbin/setserial /dev/ttyS1 auto_irq skip_test autoconfig<br>
/sbin/setserial /dev/ttyS2 auto_irq skip_test autoconfig<br>
/sbin/setserial /dev/ttyS3 auto_irq skip_test autoconfig<br>
#<br>
# Display serial device configuration<br>
/sbin/setserial −bg /dev/ttyS*<br>
The&nbsp;−bg /dev/ttyS*&nbsp;argument in the last command will print a neatly formatted summary of the<br>hardware configuration of all active serial devices. The output will look like that shown in&nbsp;<a href="TLNAGs.html#90">Example 4−2.</a><br>
<b>Example 4−2. Output of setserial −bg /dev/ttyS Command</b><br>
/dev/ttyS0 at 0x03f8 (irq = 4) is a 16550A<br>
/dev/ttyS1 at 0x02f8 (irq = 3) is a 16550A<br>
4.5. Using the Configuration Utilities<br>
74<br>
<hr>
<A name=91></a>Linux Network Administrators Guide<br>
<b>4.5.2. The stty Command</b><br>
The name&nbsp;<b>stty</b>&nbsp;probably means set tty, but the&nbsp;<b>stty</b>&nbsp;command can also be used to display a terminal's<br>configuration. Perhaps even more so than&nbsp;<b>setserial</b>, the&nbsp;<b>stty</b>&nbsp;command provides a bewildering number of<br>characteristics you can configure. We'll cover the most important of these in a moment. You can find the rest<br>described in the&nbsp;<b>stty</b>&nbsp;manual page.<br>
The&nbsp;<b>stty</b>&nbsp;command is most commonly used to configure terminal parameters, such as whether characters will<br>be echoed or what key should generate a break signal. We explained earlier that serial devices are tty devices<br>and the&nbsp;<b>stty</b>&nbsp;command is therefore equally applicable to them.<br>
One of the more important uses of the&nbsp;<b>stty</b>&nbsp;for serial devices is to enable hardware handshaking on the device.<br>We talked briefly about hardware handshaking earlier. The default configuration for serial devices is for<br>hardware handshaking to be disabled. This setting allows three wire serial cables to work; they don't<br>support the necessary signals for hardware handshaking, and if it were enabled by default, they'd be unable to<br>transmit any characters to change it.<br>
Surprisingly, some serial communications programs don't enable hardware handshaking, so if your modem<br>supports hardware handshaking, you should configure the modem to use it (check your modem manual for<br>what command to use), and also configure your serial device to use it. The&nbsp;<b>stty</b>&nbsp;command has a<br>crtscts&nbsp;flag that enables hardware handshaking on a device; you'll need to use this. The command is<br>probably best issued from the&nbsp;rc.serial&nbsp;file (or equivalent) at boot time using commands like those<br>shown in&nbsp;<a href="TLNAGs.html#91">Example 4−3.</a><br>
<b>Example 4−3. Example rc.serial stty Commands</b><br>
#<br>
stty crtscts &lt; /dev/ttyS0<br>
stty crtscts &lt; /dev/ttyS1<br>
stty crtscts &lt; /dev/ttyS2<br>
stty crtscts &lt; /dev/ttyS3<br>
#<br>
The&nbsp;<b>stty</b>&nbsp;command works on the current terminal by default, but by using the input redirection (&lt;) feature<br>of the shell, we can have&nbsp;<b>stty</b>&nbsp;manipulate any tty device. It's a common mistake to forget whether you are<br>supposed to use &lt; or &gt;; modern versions of the&nbsp;<b>stty</b>&nbsp;command have a much cleaner syntax for doing<br>this. To use the new syntax, we'd rewrite our sample configuration to look like that shown in&nbsp;<a href="TLNAGs.html#91">Example 4−4.</a><br>
<b>Example 4−4. Example rc.serial stty Commands Using Modern Syntax</b><br>
#<br>
stty crtscts −F /dev/ttyS0<br>
stty crtscts −F /dev/ttyS1<br>
stty crtscts −F /dev/ttyS2<br>
stty crtscts −F /dev/ttyS3<br>
#<br>
4.5.2. The stty Command<br>
75<br>
<hr>
<A name=92></a>Linux Network Administrators Guide<br>
We mentioned that the&nbsp;<b>stty</b>&nbsp;command can be used to display the terminal configuration parameters of a tty<br>device. To display all of the active settings on a tty device, use:<br>
$&nbsp;<b>stty −a −F /dev/ttyS1</b><br>
The output of this command, shown in&nbsp;<a href="TLNAGs.html#92">Example 4−5, gives you the status of all flags for that device; a flag<br></a>shown with a preceding minus, as in&nbsp;−crtscts, means that the flag has been turned off.<br>
<b>Example 4−5. Output of stty −a Command</b><br>
speed 19200 baud; rows 0; columns 0; line = 0;<br>
intr = ^C; quit = ^\; erase = ^?; kill = ^U; eof = ^D; eol = &lt;undef&gt;;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eol2 = &lt;undef&gt;; start = ^Q; stop = ^S; susp = ^Z; rprnt = ^R;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;werase = ^W; lnext = ^V; flush = ^O; min = 1; time = 0;<br>
−parenb −parodd cs8 hupcl −cstopb cread clocal −crtscts<br>
−ignbrk −brkint −ignpar −parmrk −inpck −istrip −inlcr −igncr −icrnl −ixon<br>
&nbsp; &nbsp; &nbsp; &nbsp; −ixoff −iuclc −ixany −imaxbel<br>
−opost −olcuc −ocrnl onlcr −onocr −onlret −ofill −ofdel nl0 cr0 tab0<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bs0 vt0 ff0<br>
−isig −icanon iexten echo echoe echok −echonl −noflsh −xcase −tostop<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;−echoprt echoctl echoke<br>
<a href="TLNAGs.html#92">A description of the most important of these flags is given in&nbsp;Table 4−2</a>. Each of these flags is enabled by<br>supplying it to&nbsp;<b>stty</b>&nbsp;and disabled by supplying it to&nbsp;<b>stty</b>&nbsp;with the − character in front of it. Thus, to disable<br>hardware handshaking on the&nbsp;ttyS0&nbsp;device, you would use:<br>
$&nbsp;<b>stty −crtscts −F /dev/ttyS0</b><br>
<b>Table 4−2. stty Flags Most Relevant to Configuring Serial Devices</b><br>
<b>Flags</b><br>
<b>Description</b><br>
N<br>
Set the line speed to&nbsp;N&nbsp;bits per second.<br>
crtsdts<br>
Enable/Disable hardware handshaking.<br>
ixon<br>
Enable/Disable XON/XOFF flow control.<br>
clocal<br>
Enable/Disable modem control signals such as DTR/DTS and DCD. This is necessary if you<br>are using a three wire serial cable because it does not supply these signals.<br>
cs5 cs6<br>
cs7 cs8<br>
Set number of data bits to 5, 6, 7, or 8, respectively.<br>
parodd<br>
Enable odd parity. Disabling this flag enables even parity.<br>
parenb<br>
Enable parity checking. When this flag is negated, no parity is used.<br>
cstopb<br>
4.5.2. The stty Command<br>
76<br>
<hr>
<A name=93></a>Linux Network Administrators Guide<br>
Enable use of two stop bits per character. When this flag is negated, one stop bit per character<br>is used.<br>
echo<br>
Enable/Disable echoing of received characters back to sender.<br>
The next example combines some of these flags and sets the&nbsp;ttyS0&nbsp;device to 19,200 bps, 8 data bits, no<br>parity, and hardware handshaking with echo disabled:<br>
$&nbsp;<b>stty 19200 cs8 −parenb crtscts −echo −F /dev/ttyS0</b><br>
4.5.2. The stty Command<br>
77<br>
<hr>
<A name=94></a><b>4.6. Serial Devices and the login: Prompt</b><br>
It was once very common that a Unix installation involved one server machine and many dumb character<br>mode terminals or dial−up modems. Today that sort of installation is less common, which is good news for<br>many people interested in operating this way, because the dumb terminals are now very cheap to acquire.<br>Dial−up modem configurations are no less common, but these days they would probably be used to support a<br>SLIP or PPP login (discussed in&nbsp;<a href="TLNAGs.html#148">Chapter 7&nbsp;and&nbsp;</a><a href="TLNAGs.html#162">Chapter 8</a>) than to be used for a simple login. Nevertheless,<br>each of these configurations can make use of a simple program called a&nbsp;<b>getty</b>&nbsp;program.<br>
The term&nbsp;<b>getty</b>&nbsp;is probably a contraction of get tty. A&nbsp;<b>getty</b>&nbsp;program opens a serial device, configures it<br>appropriately, optionally configures a modem, and waits for a connection to be made. An active connection<br>on a serial device is usually indicated by the Data Carrier Detect (DCD) pin on the serial device being raised.<br>When a connection is detected, the&nbsp;<b>getty</b>&nbsp;program issues a&nbsp;login:&nbsp;prompt, and then invokes the<br><b>login</b>&nbsp;program to handle the actual system login. Each of the virtual terminals (e.g.,&nbsp;/dev/tty1) in Linux<br>has a&nbsp;<b>getty</b>&nbsp;running against it.<br>
There are a number of different&nbsp;<b>getty</b>&nbsp;implementations, each designed to suit some configurations better than<br>others. The&nbsp;<b>getty</b>&nbsp;that we'll describe here is called&nbsp;<b>mgetty</b>. It is quite popular because it has all sorts of<br>features that make it especially modem−friendly, including support for automatic fax programs and voice<br>modems. We'll concentrate on configuring&nbsp;<b>mgetty</b>&nbsp;to answer conventional data calls and leave the rest for<br>you to explore at your convenience.<br>
<b>4.6.1. Configuring the mgetty Daemon</b><br>
The&nbsp;<b>mgetty</b>&nbsp;daemon is available in source form from ftp://alpha.greenie.net/pub/mgetty/source/, and is<br>available in just about all Linux distributions in prepackaged form. The&nbsp;<b>mgetty</b>&nbsp;daemon differs from most<br>other&nbsp;<b>getty</b>&nbsp;implementations in that it has been designed specifically for Hayes−compatible modems. It still<br>supports direct terminal connections, but is best suited for dialup applications. Rather than using the DCD<br>line to detect an incoming call, it listens for the&nbsp;RING&nbsp;message generated by modern modems when they<br>detect an incoming call and are not configured for auto−answer.<br>
The main executable program is called&nbsp;/usr/sbin/mgetty, and its main configuration file is called<br>/etc/mgetty/mgetty.config. There are a number of other binary programs and configuration files<br>that cover other&nbsp;<b>mgetty</b>&nbsp;features.<br>
For most installations, configuration is a matter of editing the&nbsp;/etc/mgetty/ mgetty.config&nbsp;file and<br>adding appropriate entries to the&nbsp;/etc/inittab&nbsp;file to execute&nbsp;<b>mgetty</b>&nbsp;automatically.<br>
<a href="TLNAGs.html#94">Example 4−6</a>&nbsp;shows a very simple&nbsp;<b>mgetty</b>&nbsp;configuration file. This example configures two serial devices.<br>The first,&nbsp;/dev/ttyS0, supports a Hayes−compatible modem at 38,400 bps. The second,&nbsp;/dev/ttyS0,<br>supports a directly connected VT100 terminal at 19,200 bps.<br>
<b>Example 4−6. Sample /etc/mgetty/mgetty.config File</b><br>
#<br>
# mgetty configuration file<br>
#<br>
# this is a sample configuration file, see mgetty.info for details<br>
4.6. Serial Devices and the login: Prompt<br>
78<br>
<hr>
<A name=95></a>Linux Network Administrators Guide<br>
#<br>
# comment lines start with a &quot;#&quot;, empty lines are ignored<br>
#<br>
# −−−−− global section −−−−−<br>
#<br>
# In this section, you put the global defaults, per−port stuff is below<br>
#<br>
# access the modem(s) with 38400 bps<br>
speed 38400<br>
#<br>
# set the global debug level to &quot;4&quot; (default from policy.h)<br>
debug 4<br>
#<br>
# −−−−− port specific section −−−−−<br>
#&nbsp;<br>
# Here you can put things that are valid only for one line, not the others<br>
#<br>
#<br>
# Hayes modem connected to ttyS0: don't do fax, less logging<br>
#<br>
port ttyS0<br>
&nbsp; debug 3<br>
&nbsp; data−only y<br>
#<br>
# direct connection of a VT100 terminal which doesn't like DTR drops<br>
#<br>
port ttyS1<br>
&nbsp; direct y<br>
&nbsp; speed 19200<br>
&nbsp; toggle−dtr n<br>
#<br>
The configuration file supports global and port−specific options. In our example we used a global option to<br>set the speed to 38,400 bps. This value is inherited by the&nbsp;ttyS0&nbsp;port. Ports we apply&nbsp;<b>mgetty</b>&nbsp;to use this<br>speed setting unless it is overwritten by a port−specific speed setting, as we have done in the<br>ttyS1&nbsp;configuration.<br>
The&nbsp;debug&nbsp;keyword controls the verbosity of&nbsp;<b>mgetty</b>&nbsp;logging. The&nbsp;data−only&nbsp;keyword in the<br>ttyS0&nbsp;configuration causes&nbsp;<b>mgetty</b>&nbsp;to ignore any modem fax features, to operate just as a data modem. The<br>direct&nbsp;keyword in the&nbsp;ttyS1&nbsp;configuration instructs&nbsp;<b>mgetty</b>&nbsp;not to attempt any modem initialization on<br>the port. Finally, the&nbsp;toggle−dtr&nbsp;keyword instructs&nbsp;<b>mgetty</b>&nbsp;not to attempt to hang up the line by dropping<br>the DTR (Data Terminal Ready) pin on the serial interface; some terminals don't like this to happen.<br>
You can also choose to leave the&nbsp;mgetty.config&nbsp;file empty and use command−line arguments to specify<br>most of the same parameters. The documentation accompanying the application includes a complete<br>description of the&nbsp;<b>mgetty</b>&nbsp;configuration file parameters and command−line arguments. See the following<br>example.<br>
We need to add two entries to the&nbsp;/etc/inittab&nbsp;file to activate this configuration. The&nbsp;inittab&nbsp;file is<br>the configuration file of the Unix System V&nbsp;<b>init</b>&nbsp;command. The&nbsp;<b>init</b>&nbsp;command is responsible for system<br>initialization; it provides a means of automatically executing programs at boot time and re−executing them<br>when they terminate. This is ideal for the goals of running a&nbsp;<b>getty</b>&nbsp;program.<br>
T0:23:respawn:/sbin/mgetty ttyS0<br>
T1:23:respawn:/sbin/mgetty ttyS1<br>
4.6. Serial Devices and the login: Prompt<br>
79<br>
<hr>
<A name=96></a>Linux Network Administrators Guide<br>
Each line of the&nbsp;/etc/inittab&nbsp;file contains four fields, separated by colons. The first field is an identifier<br>that uniquely labels an entry in the file; traditionally it is two characters, but modern versions allow four. The<br>second field is the list of run levels at which this entry should be active. A run level is a means of providing<br>alternate machine configurations and is implemented using trees of startup scripts stored in directories called<br>/etc/rc1.d,&nbsp;/etc/rc2.d, etc. This feature is typically implemented very simply, and you should model<br>your entries on others in the file or refer to your system documentation for more information. The third field<br>describes when to take action. For the purposes of running a&nbsp;<b>getty</b>&nbsp;program, this field should be set to<br>respawn, meaning that the command should be re−executed automatically when it dies. There are several<br>other options, as well, but they are not useful for our purposes here. The fourth field is the actual command to<br>execute; this is where we specify the&nbsp;<b>mgetty</b>&nbsp;command and any arguments we wish to pass it. In our simple<br>example we're starting and restarting&nbsp;<b>mgetty</b>&nbsp;whenever the system is operating at either of run levels two or<br>three, and are supplying as an argument just the name of the device we wish it to use. The&nbsp;<b>mgetty</b>&nbsp;command<br>assumes the&nbsp;/dev/, so we don't need to supply it.<br>
This chapter was a quick introduction to&nbsp;<b>mgetty</b>&nbsp;and how to offer login prompts to serial devices. You can<br>find more extensive information in the Serial−HOWTO.<br>
After you've edited the configuration files, you need to reload&nbsp;<b>init</b>&nbsp;to make the changes take effect. Simply<br>send a hangup signal to the&nbsp;<b>init</b>&nbsp;process; it always has a process ID of one, so you can use the following<br>command safely:<br>
#&nbsp;<b>kill −HUP 1</b><br>
4.6. Serial Devices and the login: Prompt<br>
80<br>
<hr>
<A name=97></a><b>Chapter 5. Configuring TCP/IP Networking</b><br>
&nbsp;In this chapter, we walk you through all the necessary steps to set up TCP/IP networking on your machine.<br>Starting with the assignment of IP addresses, we slowly work our way through the configuration of TCP/IP<br>network interfaces and introduce a few tools that come in handy when hunting down network installation<br>problems.<br>
Most of the tasks covered in this chapter will generally have to be done only once. Afterward, you have to<br>touch most configuration files only when adding a new system to your network or when you reconfigure your<br>system entirely. Some of the commands used to configure TCP/IP, however, have to be executed each time<br>the system is booted. This is usually done by invoking them from the system&nbsp;/etc/rc*&nbsp;scripts.<br>
Commonly, the network−specific part of this procedure is contained in a script. The name of this script<br>varies in different Linux distributions. In many older Linux distributions, it is known as&nbsp;rc.net&nbsp;or<br>rc.inet. Sometimes you will also see two scripts named&nbsp;rc.inet1&nbsp;and&nbsp;rc.inet2; the former<br>initializes the kernel part of networking and the latter starts basic networking services and applications. In<br>modern distributions, the&nbsp;rc&nbsp;files are structured in a more sophisticated arrangement; here you may find<br>scripts in the&nbsp;/etc/init.d/&nbsp;(or&nbsp;/etc/rc.d/init.d/) directory that create the network devices and<br>other&nbsp;rc&nbsp;files that run the network application programs. This book's examples are based on the latter<br>arrangement.<br>
This chapter discusses parts of the script that configure your network interfaces, while applications will be<br>covered in later chapters. After finishing this chapter, you should have established a sequence of commands<br>that properly configure TCP/IP networking on your computer. You should then replace any sample<br>commands in your configuration scripts with your commands, make sure the script is executed from the basic<br>rc&nbsp;script at startup time, and reboot your machine. The networking&nbsp;rc&nbsp;scripts that come along with your<br>favorite Linux distribution should provide a solid example from which to work.<br>
Chapter 5. Configuring TCP/IP Networking<br>
81<br>
<hr>
<A name=98></a><b>5.1. Mounting the /proc Filesystem</b><br>
Some of the configuration tools of the Linux NET−2 and NET−3 release rely on the&nbsp;/proc&nbsp;filesystem for<br>communicating with the kernel. This interface permits access to kernel runtime information through a<br>filesystem−like mechanism. When mounted, you can list its files like any other filesystem, or display their<br>contents. Typical items include the&nbsp;loadavg&nbsp;file, which contains the system load average, and&nbsp;meminfo,<br>which shows current core memory and swap usage.<br>
To this, the networking code adds the&nbsp;net&nbsp;directory. It contains a number of files that show things like the<br>kernel ARP tables, the state of TCP connections, and the routing tables. Most network administration tools<br>get their information from these files.<br>
The&nbsp;proc&nbsp;filesystem (or&nbsp;procfs, as it is also known) is usually mounted on&nbsp;/proc&nbsp;at system boot time.<br>The best method is to add the following line to&nbsp;/etc/fstab:<br>
# procfs mount point:<br>
none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/proc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; proc &nbsp; &nbsp;defaults<br>
Then execute&nbsp;<b>mount /proc</b>&nbsp;from your&nbsp;/etc/rc&nbsp;script.<br>
The&nbsp;procfs&nbsp;is now configured into most kernels by default. If the&nbsp;procfs&nbsp;is not in your kernel, you will<br>get a message such as:&nbsp;mount: fs type procfs not supported by kernel. You will then<br>have to recompile the kernel and answer yes when asked for&nbsp;procfs&nbsp;support.<br>
5.1. Mounting the /proc Filesystem<br>
82<br>
<hr>
<A name=99></a><b>5.2. Installing the Binaries</b><br>
If you are using one of the prepackaged Linux distributions, it will contain the major networking applications<br>and utilities along with a coherent set of sample files. The only case in which you might have to obtain and<br>install new utilities is when you install a new kernel release. As they occasionally involve changes in the<br>kernel networking layer, you will need to update the basic configuration tools. This update at least involves<br>recompiling, but sometimes you may also be required to obtain the latest set of binaries. These binaries are<br>available at their official home site at&nbsp;<i>ftp.inka.de/pub/comp/Linux/networking/NetTools/</i>, packaged in an<br>archive called&nbsp;net−tools−XXX.tar.gz, where&nbsp;XXX&nbsp;is the version number. The release matching Linux<br>2.0 is&nbsp;net−tools−1.45.<br>
If you want to compile and install the standard TCP/IP network applications yourself, you can obtain the<br>sources from most Linux FTP servers. All modern Linux distributions include a fairly comprehensive range<br>of TCP/IP network applications, such as World Wide Web browsers,&nbsp;<b>telnet</b>&nbsp;and&nbsp;<b>ftp</b>&nbsp;programs, and other<br>network applications, such as&nbsp;<b>talk</b>. If you do find something that you do need to compile yourself, the<br>chances are good that it will compile under Linux from source quite simply if you follow the instructions<br>included in the source package.<br>
5.2. Installing the Binaries<br>
83<br>
<hr>
<A name=100></a><b>5.3. Setting the Hostname</b><br>
Most, if not all, network applications rely on you to set the local host's name to some reasonable value. This<br>setting is usually made during the boot procedure by executing the&nbsp;<b>hostname</b>&nbsp;command. To set the hostname<br>to&nbsp;<i>name</i>, enter:<br>
#&nbsp;<b>hostname&nbsp;</b><i>name</i><br>
It is common practice to use the unqualified hostname without specifying the domain name. For instance,<br>hosts at the Virtual Brewery (described in&nbsp;<a href="TLNAGs.html#487">Appendix A) might be called vale.vbrew.com or<br></a>vlager.vbrew.com. These are their official&nbsp;<i>fully qualified domain names</i>&nbsp;(FQDNs). Their local hostnames<br>would be the first component of the name, such as vale. However, as the local hostname is frequently used to<br>look up the host's IP address, you have to make sure that the resolver library is able to look up the host's IP<br>address. This usually means that you have to enter the name in&nbsp;/etc/hosts.<br>
&nbsp;Some people suggest using the&nbsp;<b>domainname</b>&nbsp;command to set the kernel's idea of a domain name to the<br>remaining part of the FQDN. This way you could combine the output from&nbsp;<b>hostname</b>&nbsp;and&nbsp;<b>domainname</b>&nbsp;to<br>get the FQDN again. However, this is at best only half correct.&nbsp;<b>domainname</b>&nbsp;is generally used to set the<br>host's NIS domain, which may be entirely different from the DNS domain to which your host belongs.<br>Instead, to ensure that the short form of your hostname is resolvable with all recent versions of the<br><b>hostname</b>&nbsp;command, either add it as an entry in your local Domain Name Server or place the fully qualified<br>domain name in the&nbsp;/etc/hosts&nbsp;file. You may then use the&nbsp;<i>−−fqdn</i>&nbsp;argument to the<br><b>hostname</b>&nbsp;command, and it will print the fully qualifed domain name.<br>
5.3. Setting the Hostname<br>
84<br>
<hr>
<A name=101></a><b>5.4. Assigning IP Addresses</b><br>
If you configure the networking software on your host for standalone operation (for instance, to be able to run<br>the INN Netnews software), you can safely skip this section, because the only IP address you will need is for<br>the loopback interface, which is always 127.0.0.1.<br>
Things are a little more complicated with real networks like Ethernets. If you want to connect your host to an<br>existing network, you have to ask its administrators to give you an IP address on this network. When setting<br>up a network all by yourself, you have to assign IP addresses yourself.<br>
Hosts within a local network should usually share addresses from the same logical IP network. Hence, you<br>have to assign an IP network address. If you have several physical networks, you have to either assign them<br>different network numbers, or use subnetting to split your IP address range into several subnetworks.<br>Subnetting will be revisited in the next section,&nbsp;<a href="TLNAGs.html#102">Section 5.5</a>.<br>
When picking an IP network number, much depends on whether you intend to get on the Internet in the near<br>future. If so, you should obtain an official IP address&nbsp;<i>now</i>. Ask your network service provider to help you. If<br>you want to obtain a network number, just in case you might get on the Internet someday, request a Network<br>Address Application Form from hostmaster@internic.net, or your country's own Network Information<br>Center, if there is one.<br>
If your network is not connected to the Internet and won't be in the near future, you are free to choose any<br>legal network address. Just make sure no packets from your internal network escape to the real Internet. To<br>make sure no harm can be done even if packets&nbsp;<i>did</i>&nbsp;escape, you should use one of the network numbers<br>reserved for private use. The Internet Assigned Numbers Authority (IANA) has set aside several network<br>numbers from classes A, B, and C that you can use without registering. These addresses are valid only within<br>your private network and are not routed between real Internet sites. The numbers are defined by RFC 1597<br>and are listed in&nbsp;<a href="TLNAGs.html#55">Table 2−1&nbsp;in&nbsp;</a><a href="TLNAGs.html#52">Chapter 2. Note that the second and third blocks contain 16 and 256 networks,<br></a>respectively.<br>
Picking your addresses from one of these network numbers is not only useful for networks completely<br>unconnected to the Internet; you can still implement a slightly more restricted access using a single host as a<br>gateway. To your local network, the gateway is accessible by its internal IP address, while the outside world<br>knows it by an officially registered address (assigned to you by your provider). We come back to this concept<br>in connection with the IP masquerade facility in&nbsp;<a href="TLNAGs.html#243">Chapter 11</a>.<br>
Throughout the remainder of the book, we will assume that the brewery's network manager uses a class B<br>network number, say 172.16.0.0. Of course, a class C network number would definitely suffice to<br>accommodate both the Brewery's and the Winery's networks. We'll use a class B network here for the sake of<br>simplicity; it will make the subnetting examples in the next section of this chapter a little more intuitive.<br>
5.4. Assigning IP Addresses<br>
85<br>
<hr>
<A name=102></a><b>5.5. Creating Subnets</b><br>
To operate several Ethernets (or other networks, once a driver is available), you have to split your network<br>into subnets. Note that subnetting is required only if you have more than one&nbsp;<i>broadcast<br>network</i>point−to−point links don't count. For instance, if you have one Ethernet, and one or more SLIP links<br>to the outside world, you don't need to subnet your network. This is explained in more detail in&nbsp;<a href="TLNAGs.html#148">Chapter 7.</a><br>
To accommodate the two Ethernets, the Brewery's network manager decides to use 8 bits of the host part as<br>additional subnet bits. This leaves another 8 bits for the host part, allowing for 254 hosts on each of the<br>subnets. She then assigns subnet number 1 to the brewery, and gives the winery number 2. Their respective<br>network addresses are thus 172.16.1.0 and 172.16.2.0. The subnet mask is 255.255.255.0.<br>
vlager, which is the gateway between the two networks, is assigned a host number of 1 on both of them,<br>which gives it the IP addresses 172.16.1.1 and 172.16.2.1, respectively.<br>
Note that in this example we are using a class B network to keep things simple, but a class C network would<br>be more realistic. With the new networking code, subnetting is not limited to byte boundaries, so even a class<br>C network may be split into several subnets. For instance, you could use two bits of the host part for the<br>netmask, giving you 4 possible subnets with 64 hosts on each.[28]<br>
5.5. Creating Subnets<br>
86<br>
<hr>
<A name=103></a><b>5.6. Writing hosts and networks Files</b><br>
After you have subnetted your network, you should prepare for some simple sort of hostname resolution<br>using the&nbsp;/etc/hosts&nbsp;file. If you are not going to use DNS or NIS for address resolution, you have to put<br>all hosts in the&nbsp;hosts&nbsp;file.<br>
Even if you want to run DNS or NIS during normal operation, you should have some subset of all hostnames<br>in&nbsp;/etc/hosts. You should have some sort of name resolution, even when no network interfaces are<br>running, for example, during boot time. This is not only a matter of convenience, but it allows you to use<br>symbolic hostnames in your network&nbsp;rc&nbsp;scripts. Thus, when changing IP addresses, you only have to copy an<br>updated&nbsp;hosts&nbsp;file to all machines and reboot, rather than edit a large number of&nbsp;rc&nbsp;files separately.<br>Usually you put all local hostnames and addresses in&nbsp;hosts, adding those of any gateways and NIS servers<br>used.[29]<br>
You should make sure your resolver only uses information from the&nbsp;hosts&nbsp;file during initial testing. Sample<br>files that come with your DNS or NIS software may produce strange results. To make all applications use<br>/etc/hosts&nbsp;exclusively when looking up the IP address of a host, you have to edit the<br>/etc/host.conf&nbsp;file. Comment out any lines that begin with the keyword order by preceding them with<br>a hash sign, and insert the line:<br>
order hosts<br>
The configuration of the resolver library is covered in detail in&nbsp;<a href="TLNAGs.html#120">Chapter 6.</a><br>
The&nbsp;hosts&nbsp;file contains one entry per line, consisting of an IP address, a hostname, and an optional list of<br>aliases for the hostname. The fields are separated by spaces or tabs, and the address field must begin in the<br>first column. Anything following a hash sign (#) is regarded as a comment and is ignored.<br>
Hostnames can be either fully qualified or relative to the local domain. For vale, you would usually enter the<br>fully qualified name, vale.vbrew.com, and vale by itself in the&nbsp;hosts&nbsp;file, so that it is known by both its<br>official name and the shorter local name.<br>
This is an example how a&nbsp;hosts&nbsp;file at the Virtual Brewery might look. Two special names are included,<br>vlager−if1 and vlager−if2, which give the addresses for both interfaces used on vlager:<br>
#<br>
# Hosts file for Virtual Brewery/Virtual Winery<br>
#<br>
# IP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FQDN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aliases<br>
#<br>
127.0.0.1 &nbsp; &nbsp; &nbsp; localhost<br>
#<br>
172.16.1.1 &nbsp; &nbsp; &nbsp;vlager.vbrew.com &nbsp; &nbsp; &nbsp;vlager vlager−if1<br>
172.16.1.2 &nbsp; &nbsp; &nbsp;vstout.vbrew.com &nbsp; &nbsp; &nbsp;vstout<br>
172.16.1.3 &nbsp; &nbsp; &nbsp;vale.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp;vale<br>
#<br>
172.16.2.1 &nbsp; &nbsp; &nbsp;vlager−if2<br>
172.16.2.2 &nbsp; &nbsp; &nbsp;vbeaujolais.vbrew.com vbeaujolais<br>
172.16.2.3 &nbsp; &nbsp; &nbsp;vbardolino.vbrew.com &nbsp;vbardolino<br>
172.16.2.4 &nbsp; &nbsp; &nbsp;vchianti.vbrew.com &nbsp; &nbsp;vchianti<br>
&nbsp;Just as with a host's IP address, you should sometimes use a symbolic name for network numbers, too.<br>Therefore, the&nbsp;hosts&nbsp;file has a companion called&nbsp;/etc/networks&nbsp;that maps network names to network<br>
5.6. Writing hosts and networks Files<br>
87<br>
<hr>
<A name=104></a>Linux Network Administrators Guide<br>
numbers, and vice versa. At the Virtual Brewery, we might install a&nbsp;networks&nbsp;file like this:[30]<br>
# /etc/networks for the Virtual Brewery<br>
brew−net &nbsp; &nbsp; &nbsp;172.16.1.0<br>
wine−net &nbsp; &nbsp; &nbsp;172.16.2.0<br>
5.6. Writing hosts and networks Files<br>
88<br>
<hr>
<A name=105></a><b>5.7. Interface Configuration for IP</b><br>
<a href="TLNAGs.html#82">After setting up your hardware as explained in&nbsp;Chapter 4</a>, you have to make these devices known to the<br>kernel networking software. A couple of commands are used to configure the network interfaces and<br>initialize the routing table. These tasks are usually performed from the network initialization script each time<br>you boot the system. The basic tools for this process are called&nbsp;<b>ifconfig</b>&nbsp;(where if stands for interface)<br>and&nbsp;<b>route</b>.<br>
<b>ifconfig</b>&nbsp;is used to make an interface accessible to the kernel networking layer. This involves the assignment<br>of an IP address and other parameters, and activation of the interface, also known as bringing up the<br>interface. Being active here means that the kernel will send and receive IP datagrams through the interface.<br>The simplest way to invoke it is with:<br>
ifconfig&nbsp;<i>interface&nbsp;ip−address</i><br>
This command assigns&nbsp;<i>ip−address</i>&nbsp;to&nbsp;<i>interface</i>&nbsp;and activates it. All other parameters are set to default<br>values. For instance, the default network mask is derived from the network class of the IP address, such as<br>255.255.0.0 for a class B address.&nbsp;<b>ifconfig</b><a href="TLNAGs.html#112">&nbsp;is described in detail in the section&nbsp;Section 5.8.</a><br>
<b>route</b>&nbsp;allows you to add or remove routes from the kernel routing table. It can be invoked as:<br>
route [add|del] [−net|−host]&nbsp;<i>target</i>&nbsp;[<i>if</i>]<br>
The&nbsp;add&nbsp;and&nbsp;del&nbsp;arguments determine whether to add or delete the route to&nbsp;<i>target</i>. The&nbsp;−net&nbsp;and<br>−host&nbsp;arguments tell the route command whether the target is a network or a host (a host is assumed if you<br>don't specify). The&nbsp;if&nbsp;argument is again optional, and allows you to specify to which network interface the<br>route should be directedthe Linux kernel makes a sensible guess if you don't supply this information. This<br>topic will be explained in more detail in succeeding sections.<br>
<b>5.7.1. The Loopback Interface</b><br>
The very first interface to be activated is the loopback interface:<br>
#&nbsp;<b>ifconfig lo 127.0.0.1</b><br>
Occasionally, you will see the dummy hostname localhost being used instead of the IP address.&nbsp;<b>ifconfig</b>&nbsp;will<br>look up the name in the&nbsp;hosts&nbsp;file, where an entry should declare it as the hostname for 127.0.0.1:<br>
# Sample /etc/hosts entry for localhost<br>
localhost &nbsp; &nbsp; 127.0.0.1<br>
To view the configuration of an interface, you invoke&nbsp;<b>ifconfig</b>, giving it only the interface name as<br>argument:<br>
$&nbsp;<b>ifconfig lo</b><br>
lo &nbsp; &nbsp; &nbsp; &nbsp;Link encap:Local Loopback &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:127.0.0.1 &nbsp;Mask:255.0.0.0<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP LOOPBACK RUNNING &nbsp;MTU:3924 &nbsp;Metric:1<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:0 errors:0 dropped:0 overruns:0 frame:0<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br>
5.7. Interface Configuration for IP<br>
89<br>
<hr>
<A name=106></a>Linux Network Administrators Guide<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Collisions:0&nbsp;<br>
As you can see, the loopback interface has been assigned a netmask of 255.0.0.0, since 127.0.0.1 is a class A<br>address.<br>
Now you can almost start playing with your mini−network. What is still missing is an entry in the routing<br>table that tells IP that it may use this interface as a route to destination 127.0.0.1. This is accomplished by<br>using:<br>
# route add 127.0.0.1<br>
Again, you can use localhost instead of the IP address, provided you've entered it into your&nbsp;/etc/hosts.<br>
&nbsp;Next, you should check that everything works fine, for example by using&nbsp;<b>ping</b>.&nbsp;<b>ping</b>&nbsp;is the networking<br>equivalent of a sonar device.[31]&nbsp;The command is used to verify that a given address is actually reachable,<br>and to measure the delay that occurs when sending a datagram to it and back again. The time required for this<br>process is often referred to as the round−trip time:<br>
#&nbsp;<b>ping localhost</b><br>
PING localhost (127.0.0.1): 56 data bytes<br>
64 bytes from 127.0.0.1: icmp_seq=0 ttl=255 time=0.4 ms<br>
64 bytes from 127.0.0.1: icmp_seq=1 ttl=255 time=0.4 ms<br>
64 bytes from 127.0.0.1: icmp_seq=2 ttl=255 time=0.4 ms<br>
^C<br>
−−− localhost ping statistics −−−<br>
3 packets transmitted, 3 packets received, 0% packet loss<br>
round−trip min/avg/max = 0.4/0.4/0.4 ms<br>
#<br>
When you invoke&nbsp;<b>ping</b>&nbsp;as shown here, it will continue emitting packets forever, unless interrupted by the<br>user. The&nbsp;^C&nbsp;marks the place where we pressed Ctrl−C.<br>
The previous example shows that packets for 127.0.0.1 are properly delivered and a reply is returned to<br><b>ping</b>&nbsp;almost instantaneously. This shows that you have successfully set up your first network interface.<br>
&nbsp;If the output you get from&nbsp;<b>ping</b>&nbsp;does not resemble that shown in the previous example, you are in trouble.<br>Check any errors if they indicate that some file hasn't been installed properly. Check that the&nbsp;<b>ifconfig</b>&nbsp;and<br><b>route</b>&nbsp;binaries you use are compatible with the kernel release you run, and above all, that the kernel has been<br>compiled with networking enabled (you see this from the presence of the&nbsp;/proc/net&nbsp;directory). If you get<br>an error message saying Network unreachable, you probably got the&nbsp;<b>route</b>&nbsp;command wrong. Make sure<br>you use the same address you gave to&nbsp;<b>ifconfig</b>.<br>
The steps previously described are enough to use networking applications on a standalone host. After<br>adding the lines mentioned earlier to your network initialization script and making sure it will be executed at<br>boot time, you may reboot your machine and try out various applications. For instance,&nbsp;<b>telnet<br>localhost</b>&nbsp;should establish a&nbsp;<b>telnet</b>&nbsp;connection to your host, giving you a&nbsp;login:&nbsp;prompt.<br>
However, the loopback interface is useful not only as an example in networking books, or as a test bed during<br>development, but is actually used by some applications during normal operation.[32]&nbsp;Therefore, you always<br>have to configure it, regardless of whether your machine is attached to a network or not.<br>
5.7. Interface Configuration for IP<br>
90<br>
<hr>
<A name=107></a>Linux Network Administrators Guide<br>
<b>5.7.2. Ethernet Interfaces</b><br>
Configuring an Ethernet interface is pretty much the same as the loopback interface; it just requires a few<br>more parameters when you are using subnetting.<br>
At the Virtual Brewery, we have subnetted the IP network, which was originally a class B network, into class<br>C subnetworks. To make the interface recognize this, the&nbsp;<b>ifconfig</b>&nbsp;incantation would look like this:<br>
#&nbsp;<b>ifconfig eth0 vstout netmask 255.255.255.0</b><br>
This command assigns the&nbsp;eth0&nbsp;interface the IP address of vstout (172.16.1.2). If we omitted the netmask,<br><b>ifconfig</b>&nbsp;would deduce the netmask from the IP network class, which would result in an incorrect netmask of<br>255.255.0.0. Now a quick check shows:<br>
#&nbsp;<b>ifconfig eth0</b><br>
eth0 &nbsp; &nbsp; &nbsp;Link encap 10Mps Ethernet HWaddr &nbsp;00:00:C0:90:B3:42<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr 172.16.1.2 Bcast 172.16.1.255 Mask 255.255.255.0<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING &nbsp;MTU 1500 &nbsp;Metric 1<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets 0 errors 0 dropped 0 overrun 0<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets 0 errors 0 dropped 0 overrun 0<br>
You can see that&nbsp;<b>ifconfig</b>&nbsp;automatically sets the broadcast address (the Bcast field) to the usual value, which<br>is the host's network number with all the host bits set. Also, the maximum transmission unit (the maximum<br>size of IP datagrams the kernel will generate for this interface) has been set to the maximum size of Ethernet<br>packets: 1,500 bytes. The defaults are usually what you will use, but all these values can be overidden if<br>required, with special options that will be described under&nbsp;<a href="TLNAGs.html#112">Section 5.8</a>.<br>
Just as for the loopback interface, you now have to install a routing entry that informs the kernel about the<br>network that can be reached through&nbsp;eth0. For the Virtual Brewery, you might invoke&nbsp;<b>route</b>&nbsp;as:<br>
#&nbsp;<b>route add −net 172.16.1.0</b><br>
At first this looks a little like magic, because it's not really clear how&nbsp;<b>route</b>&nbsp;detects which interface to route<br>through. However, the trick is rather simple: the kernel checks all interfaces that have been configured so far<br>and compares the destination address (172.16.1.0 in this case) to the network part of the interface address<br>(that is, the bitwise AND of the interface address and the netmask). The only interface that matches is&nbsp;eth0.<br>
Now, what's that&nbsp;−net&nbsp;option for? This is used because&nbsp;<b>route</b>&nbsp;can handle both routes to networks and routes<br>to single hosts (as you saw before with localhost). When given an address in dotted quad notation,<br><b>route</b>&nbsp;attempts to guess whether it is a network or a hostname by looking at the host part bits. If the address's<br>host part is zero,&nbsp;<b>route</b>&nbsp;assumes it denotes a network; otherwise,&nbsp;<b>route</b>&nbsp;takes it as a host address. Therefore,<br><b>route</b>&nbsp;would think that 172.16.1.0 is a host address rather than a network number, because it cannot know<br>that we use subnetting. We have to tell&nbsp;<b>route</b>&nbsp;explicitly that it denotes a network, so we give it the&nbsp;−net&nbsp;flag.<br>
Of course, the&nbsp;<b>route</b>&nbsp;command is a little tedious to type, and it's prone to spelling mistakes. A more<br>convenient approach is to use the network names we defined in&nbsp;/etc/networks. This approach makes the<br>command much more readable; even the&nbsp;−net&nbsp;flag can be omitted because&nbsp;<b>route</b>&nbsp;knows that<br>172.16.1.0 denotes a network:<br>
#&nbsp;<b>route add brew−net</b><br>
5.7.2. Ethernet Interfaces<br>
91<br>
<hr>
<A name=108></a>Linux Network Administrators Guide<br>
&nbsp;Now that you've finished the basic configuration steps, we want to make sure that your Ethernet interface is<br>indeed running happily. Choose a host from your Ethernet, for instance vlager, and type:<br>
#&nbsp;<b>ping vlager</b><br>
PING vlager: 64 byte packets<br>
64 bytes from 172.16.1.1: icmp_seq=0. time=11. ms<br>
64 bytes from 172.16.1.1: icmp_seq=1. time=7. ms<br>
64 bytes from 172.16.1.1: icmp_seq=2. time=12. ms<br>
64 bytes from 172.16.1.1: icmp_seq=3. time=3. ms<br>
^C<br>
−−−−vstout.vbrew.com PING Statistics−−−−<br>
4 packets transmitted, 4 packets received, 0<br>
round−trip (ms) &nbsp;min/avg/max = 3/8/12<br>
If you don't see similar output, something is broken. If you encounter unusual packet loss rates, this hints at<br>a hardware problem, like bad or missing terminators. If you don't receive any replies at all, you should check<br>the interface configuration with&nbsp;<b>netstat</b>&nbsp;described later in&nbsp;<a href="TLNAGs.html#115">Section 5.9</a>. The packet statistics displayed by<br><b>ifconfig</b>&nbsp;should tell you whether any packets have been sent out on the interface at all. If you have access to<br>the remote host too, you should go over to that machine and check the interface statistics. This way you can<br>determine exactly where the packets got dropped. In addition, you should display the routing information<br>with&nbsp;<b>route</b>&nbsp;to see if both hosts have the correct routing entry.&nbsp;<b>route</b>&nbsp;prints out the complete kernel routing<br>table when invoked without any arguments (−n&nbsp;just makes it print addresses as dotted quad instead of using<br>the hostname):<br>
#&nbsp;<b>route −n</b><br>
Kernel routing table<br>
Destination &nbsp;Gateway &nbsp;Genmask &nbsp; &nbsp; &nbsp; &nbsp; Flags Metric Ref Use &nbsp; &nbsp;Iface<br>
127.0.0.1 &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;112 lo<br>
172.16.1.0 &nbsp; * &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0 &nbsp; U &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; 10 eth0<br>
The detailed meaning of these fields is explained later in&nbsp;<a href="TLNAGs.html#115">Section 5.9</a>.&quot; The Flags column contains a list of<br>flags set for each interface. U is always set for active interfaces, and H says the destination address denotes a<br>host. If the H flag is set for a route that you meant to be a network route, you have to reissue the<br><b>route</b>&nbsp;command with the&nbsp;−net&nbsp;option. To check whether a route you have entered is used at all, check to see<br>if the Use field in the second to last column increases between two invocations of&nbsp;<b>ping</b>.<br>
<b>5.7.3. Routing Through a Gateway</b><br>
In the previous section, we covered only the case of setting up a host on a single Ethernet. Quite frequently,<br>however, one encounters networks connected to one another by gateways. These gateways may simply link<br>two or more Ethernets, but may also provide a link to the outside world, such as the Internet. In order to use a<br>gateway, you have to provide additional routing information to the networking layer.<br>
The Ethernets of the Virtual Brewery and the Virtual Winery are linked through such a gateway, namely the<br>host vlager. Assuming that vlager has already been configured, we just have to add another entry to vstout's<br>routing table that tells the kernel it can reach all hosts on the Winery's network through vlager. The<br>appropriate incantation of&nbsp;<b>route</b>&nbsp;is shown below; the gw keyword tells it that the next argument denotes a<br>gateway:<br>
#&nbsp;<b>route add wine−net gw vlager</b><br>
5.7.3. Routing Through a Gateway<br>
92<br>
<hr>
<A name=109></a>Linux Network Administrators Guide<br>
Of course, any host on the Winery network you wish to talk to must have a routing entry for the Brewery's<br>network. Otherwise you would only be able to send data to the Winery network from the Brewery network,<br>but the hosts on the Winery would be unable to reply.<br>
This example describes only a gateway that switches packets between two isolated Ethernets. Now assume<br>that vlager also has a connection to the Internet (say, through an additional SLIP link). Then we would want<br>datagrams to&nbsp;<i>any</i>&nbsp;destination network other than the Brewery to be handed to vlager. This action can be<br>accomplished by making it the default gateway for vstout:<br>
#&nbsp;<b>route add default gw vlager</b><br>
&nbsp;The network name default is a shorthand for 0.0.0.0, which denotes the default route. The default route<br>matches every destination and will be used if there is no more specific route that matches. You do not have to<br>add this name to&nbsp;/etc/networks&nbsp;because it is built into&nbsp;<b>route</b>.<br>
If you see high packet loss rates when pinging a host behind one or more gateways, this may hint at a very<br>congested network. Packet loss is not so much due to technical deficiencies as to temporary excess loads on<br>forwarding hosts, which makes them delay or even drop incoming datagrams.<br>
<b>5.7.4. Configuring a Gateway</b><br>
Configuring a machine to switch packets between two Ethernets is pretty straightforward. Assume we're back<br>at vlager, which is equipped with two Ethernet cards, each connected to one of the two networks. All you<br>have to do is configure both interfaces separately, giving them their respective IP addresses and matching<br>routes, and that's it.<br>
It is quite useful to add information on the two interfaces to the&nbsp;hosts&nbsp;file as shown in the following<br>example, so we have handy names for them, too:<br>
172.16.1.1 &nbsp; &nbsp; &nbsp;vlager.vbrew.com &nbsp; &nbsp;vlager vlager−if1<br>
172.16.2.1 &nbsp; &nbsp; &nbsp;vlager−if2<br>
The sequence of commands to set up the two interfaces is then:<br>
#&nbsp;<b>ifconfig eth0 vlager−if1</b><br>
#&nbsp;<b>route add brew−net</b><br>
#&nbsp;<b>ifconfig eth1 vlager−if2</b><br>
#&nbsp;<b>route add wine−net</b><br>
If this sequence doesn't work, make sure your kernel has been compiled with support for IP forwarding<br>enabled. One good way to do this is to ensure that the first number on the second line of<br>/proc/net/snmp&nbsp;is set to&nbsp;1.<br>
<b>5.7.5. The PLIP Interface</b><br>
A PLIP link used to connect two machines is a little different from an Ethernet. PLIP links are an example of<br>what are called&nbsp;<i>point−to−point</i>&nbsp;links, meaning that there is a single host at each end of the link. Networks<br>like Ethernet are called&nbsp;<i>broadcast</i>&nbsp;networks. Configuration of point−to−point links is different because unlike<br>
5.7.4. Configuring a Gateway<br>
93<br>
<hr>
<A name=110></a>Linux Network Administrators Guide<br>
broadcast networks, point−to−point links don't support a network of their own.<br>
PLIP provides very cheap and portable links between computers. As an example, we'll consider the laptop<br>computer of an employee at the Virtual Brewery that is connected to vlager via PLIP. The laptop itself is<br>called vlite and has only one parallel port. At boot time, this port will be registered as&nbsp;plip1. To activate the<br>link, you have to configure the&nbsp;plip1&nbsp;interface using the following commands:[33]<br>
#&nbsp;<b>ifconfig plip1 vlite pointopoint vlager</b><br>
#&nbsp;<b>route add default gw vlager</b><br>
The first command configures the interface, telling the kernel that this is a point−to−point link, with the<br>remote side having the address of vlager. The second installs the default route, using vlager as gateway. On<br>vlager, a similar&nbsp;<b>ifconfig</b>&nbsp;command is necessary to activate the link (a&nbsp;<b>route</b>&nbsp;invocation is not needed):<br>
#&nbsp;<b>ifconfig plip1 vlager pointopoint vlite</b><br>
Note that the&nbsp;plip1&nbsp;interface on vlager does not need a separate IP address, but may also be given the<br>address 172.16.1.1. Point−to−point networks don't support a network directly, so the interfaces don't require<br>an address on any supported network. The kernel uses the interface information in the routing table to avoid<br>any possible confusion.[34]<br>
Now we have configured routing from the laptop to the Brewery's network; what's still missing is a way to<br>route from any of the Brewery's hosts to vlite. One particularly cumbersome way is to add a specific route to<br>every host's routing table that names vlager as a gateway to vlite:<br>
#&nbsp;<b>route add vlite gw vlager</b><br>
&nbsp;Dynamic routing offers a much better option for temporary routes. You could use&nbsp;<b>gated</b>, a routing daemon,<br>which you would have to install on each host in the network in order to distribute routing information<br>dynamically. The easiest option, however, is to use&nbsp;<i>proxy ARP</i>&nbsp;(Address Resolution Protocol). With proxy<br>ARP, vlager will respond to any ARP query for vlite by sending its own Ethernet address. All packets for<br>vlite will wind up at vlager, which then forwards them to the laptop. We will come back to proxy ARP in the<br>section&nbsp;<a href="TLNAGs.html#118">Section 5.10.</a><br>
Current&nbsp;net−tools&nbsp;releases contain a tool called&nbsp;<b>plipconfig</b>, which allows you to set certain PLIP timing<br>parameters. The IRQ to be used for the printer port can be set using the&nbsp;<b>ifconfig</b>&nbsp;command.<br>
<b>5.7.6. The SLIP and PPP Interfaces</b><br>
Although SLIP and PPP links are only simple point−to−point links like PLIP connections, there is much<br>more to be said about them. Usually, establishing a SLIP connection involves dialing up a remote site<br>through your modem and setting the serial line to SLIP mode. PPP is used in a similar fashion. We discuss<br>SLIP and PPP in detail in&nbsp;<a href="TLNAGs.html#148">Chapter 7</a><a href="TLNAGs.html#162">&nbsp;and&nbsp;Chapter 8</a>.<br>
<b>5.7.7. The Dummy Interface</b><br>
The dummy interface is a little exotic, but rather useful nevertheless. Its main benefit is with standalone hosts<br>and machines whose only IP network connection is a dialup link. In fact, the latter are standalone hosts most<br>
5.7.6. The SLIP and PPP Interfaces<br>
94<br>
<hr>
<A name=111></a>Linux Network Administrators Guide<br>
of the time, too.<br>
The dilemma with standalone hosts is that they only have a single network device active, the loopback<br>device, which is usually assigned the address 127.0.0.1. On some occasions, however, you must send data to<br>the official IP address of the local host. For instance, consider the laptop vlite, which was disconnected<br>from a network for the duration of this example. An application on vlite may now want to send data to<br>another application on the same host. Looking up vlite in&nbsp;/etc/hosts&nbsp;yields an IP address of 172.16.1.65,<br>so the application tries to send to this address. As the loopback interface is currently the only active interface<br>on the machine, the kernel has no idea that 172.16.1.65 actually refers to itself! Consequently, the kernel<br>discards the datagram and returns an error to the application.<br>
This is where the dummy device steps in. It solves the dilemma by simply serving as the alter ego of the<br>loopback interface. In the case of vlite, you simply give it the address 172.16.1.65 and add a host route<br>pointing to it. Every datagram for 172.16.1.65 is then delivered locally. The proper invocation is:[35]<br>
#&nbsp;<b>ifconfig dummy vlite</b><br>
#&nbsp;<b>route add vlite</b><br>
<b>5.7.8. IP Alias</b><br>
New kernels support a feature that can completely replace the dummy interface and serve other useful<br>functions.&nbsp;<i>IP Alias</i>&nbsp;allows you to configure multiple IP addresses onto a physical device. In the simplest case,<br>you could replicate the function of the dummy interface by configuring the host address as an alias onto the<br>loopback interface and completely avoid using the dummy interface. In more complex uses, you could<br>configure your host to look like many different hosts, each with its own IP address. This configuration is<br>sometimes called Virtual Hosting, although technically it is also used for a variety of other techniques.<br>
[36]<br>
To configure an alias for an interface, you must first ensure that your kernel has been compiled with support<br>for IP Alias (check that you have a&nbsp;/proc/net/ip_alias&nbsp;file; if not, you will have to recompile your<br>kernel). Configuration of an IP alias is virtually identical to configuring a real network device; you use a<br>special name to indicate it's an alias that you want. For example:<br>
#&nbsp;<b>ifconfig lo:0 172.16.1.1</b><br>
This command would produce an alias for the loopback interface with the address&nbsp;172.16.1.1. IP aliases<br>are referred to by appending :<i>n</i>&nbsp;to the actual network device, in which n is an integer. In our example, the<br>network device we are creating the alias on is&nbsp;lo, and we are creating an alias numbered zero for it. This<br>way, a single physical device may support a number of aliases.<br>
Each alias may be treated as though it is a separate device, and as far as the kernel IP software is concerned, it<br>will be; however, it will be sharing its hardware with another interface.<br>
5.7.8. IP Alias<br>
95<br>
<hr>
<A name=112></a><b>5.8. All About ifconfig</b><br>
There are many more parameters to&nbsp;<b>ifconfig</b>&nbsp;than we have described so far. Its normal invocation is this:<br>
ifconfig&nbsp;<i>interface</i>&nbsp;[<i>address</i>&nbsp;[<i>parameters</i>]]<br>
<i>interface</i>&nbsp;is the interface name, and&nbsp;<i>address</i>&nbsp;is the IP address to be assigned to the interface. This may<br>be either an IP address in dotted quad notation or a name that&nbsp;<b>ifconfig</b>&nbsp;will look up in&nbsp;/etc/hosts.<br>
If&nbsp;<b>ifconfig</b>&nbsp;is invoked with only the interface name, it displays that interface's configuration. When invoked<br>without any parameters, it displays all interfaces you have configured so far; a&nbsp;−a&nbsp;option forces it to show the<br>inactive ones as well. A sample invocation for the Ethernet interface&nbsp;eth0&nbsp;may look like this:<br>
#&nbsp;<b>ifconfig eth0</b><br>
eth0 &nbsp; &nbsp; &nbsp;Link encap 10Mbps Ethernet &nbsp;HWaddr 00:00:C0:90:B3:42<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr 172.16.1.2 Bcast 172.16.1.255 Mask 255.255.255.0<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING &nbsp;MTU 1500 &nbsp;Metric 0<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets 3136 errors 217 dropped 7 overrun 26<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets 1752 errors 25 dropped 0 overrun 0<br>
&nbsp;The&nbsp;MTU&nbsp;and&nbsp;Metric&nbsp;fields show the current MTU and metric value for that interface. The metric value is<br>traditionally used by some operating systems to compute the cost of a route. Linux doesn't use this value yet,<br>but defines it for compatibility, nevertheless.<br>
The&nbsp;RX&nbsp;and&nbsp;TX&nbsp;lines show how many packets have been received or transmitted error free, how many errors<br>occurred, how many packets were dropped (probably because of low memory), and how many were lost<br>because of an overrun. Receiver overruns usually occur when packets come in faster than the kernel can<br>service the last interrupt. The flag values printed by&nbsp;<b>ifconfig</b>&nbsp;roughly correspond to the names of its<br>command−line options; they will be explained later.<br>
The following is a list of parameters recognized by&nbsp;<b>ifconfig</b>&nbsp;with the corresponding flag names. Options that<br>simply turn on a feature also allow it to be turned off again by preceding the option name by a dash (−).<br>
<i>up</i><br>
This option makes an interface accessible to the IP layer. This option is implied when an<br><i>address</i>&nbsp;is given on the command line. It may also be used to reenable an interface that has been<br>taken down temporarily using the&nbsp;down&nbsp;option.<br>
This option corresponds to the flags&nbsp;UP&nbsp;and&nbsp;RUNNING.<br>
<i>down</i><br>
This option marks an interface inaccessible to the IP layer. This effectively disables any IP traffic<br>through the interface. Note that this option will also automatically delete all routing entries that use<br>this interface.<br>
<i>netmask mask</i><br>
&nbsp;This option assigns a subnet mask to be used by the interface. It may be given as either a 32−bit<br>hexadecimal number preceded by 0x, or as a dotted quad of decimal numbers. While the dotted quad<br>
5.8. All About ifconfig<br>
96<br>
<hr>
<A name=113></a>Linux Network Administrators Guide<br>
format is more common, the hexadecimal representation is often easier to work with. Netmasks are<br>essentially binary, and it is easier to do binary−to−hexadecimal than binary−to−decimal conversion.<br>
<i>pointopoint address</i><br>
This option is used for point−to−point IP links that involve only two hosts. This option is needed to<br>configure SLIP or PLIP interfaces, for example. If a point−to−point address has been set,<br><b>ifconfig</b>&nbsp;displays the&nbsp;POINTOPOINT&nbsp;flag.<br>
<i>broadcast address</i><br>
&nbsp;The broadcast address is usually made up from the network number by setting all bits of the host<br>part. Some IP implementations (systems derived from BSD 4.2, for instance) use a different scheme<br>in which all host part bits are cleared instead. The&nbsp;broadcast&nbsp;option adapts to these strange<br>environments. If a broadcast address has been set,&nbsp;<b>ifconfig</b>&nbsp;displays the&nbsp;BROADCAST&nbsp;flag.<br>
<i>irq</i><br>
&nbsp;This option allows you to set the IRQ line used by certain devices. This is especially useful for<br>PLIP, but may also be useful for certain Ethernet cards.<br>
<i>metric number</i><br>
&nbsp;This option may be used to assign a metric value to the routing table entry created for the interface.<br>This metric is used by the Routing Information Protocol (RIP) to build routing tables for the<br>network.[37]&nbsp;The default metric used by&nbsp;<b>ifconfig</b>&nbsp;is zero. If you don't run a RIP daemon, you don't<br>need this option at all; if you do, you will rarely need to change the metric value.<br>
<i>mtu bytes</i><br>
This sets the Maximum Transmission Unit, which is the maximum number of octets the interface is<br>able to handle in one transaction. For Ethernets, the MTU defaults to 1,500 (the largest allowable size<br>of an Ethernet packet); for SLIP interfaces, it is 296. (There is no constraint on the MTU of SLIP<br>links; this value is a good compromise.)<br>
<i>arp</i><br>
This is an option specific to broadcast networks such as Ethernets or packet radio. It enables the use<br>of the Address Resolution Protocol (ARP) to detect the physical addresses of hosts attached to the<br>network. For broadcast networks, it is on by default. If ARP is disabled,&nbsp;<b>ifconfig</b>&nbsp;displays the<br>NOARP&nbsp;flag.<br>
<i>−arp</i><br>
This option disables the use of ARP on this interface.<br>
<i>promisc</i><br>
&nbsp;This option puts the interface in promiscuous mode. On a broadcast network, this makes the<br>interface receive all packets, regardless of whether they were destined for this host or not. This<br>allows network traffic analysis using packet filters and such, also called&nbsp;<i>Ethernet snooping</i>. Usually,<br>
5.8. All About ifconfig<br>
97<br>
<hr>
<A name=114></a>Linux Network Administrators Guide<br>
this is a good technique for hunting down network problems that are otherwise hard to detect. Tools<br>such as&nbsp;<b>tcpdump</b>&nbsp;rely on this.<br>
On the other hand, this option allows attackers to do nasty things, such as skim the traffic of your<br>network for passwords. You can protect against this type of attack by prohibiting just anyone from<br>plugging their computers into your Ethernet. You could also use secure authentication protocols, such<br>as Kerberos or the secure shell login suite.[38]&nbsp;This option corresponds to the&nbsp;PROMISC&nbsp;flag.<br>
<i>−promisc</i><br>
This option turns promiscuous mode off.<br>
<i>allmulti</i><br>
Multicast addresses are like Ethernet broadcast addresses, except that instead of automatically<br>including everybody, the only people who receive packets sent to a multicast address are those<br>programmed to listen to it. This is useful for applications like Ethernet−based videoconferencing or<br>network audio, to which only those interested can listen. Multicast addressing is supported by most,<br>but not all, Ethernet drivers. When this option is enabled, the interface receives and passes multicast<br>packets for processing. This option corresponds to the&nbsp;ALLMULTI&nbsp;flag.<br>
<i>−allmulti</i><br>
This option turns multicast addresses off.<br>
5.8. All About ifconfig<br>
98<br>
<hr>
<A name=115></a><b>5.9. The netstat Command</b><br>
<b>netstat</b>&nbsp;is a useful tool for checking your network configuration and activity. It is in fact a collection of<br>several tools lumped together. We discuss each of its functions in the following sections.<br>
<b>5.9.1. Displaying the Routing Table</b><br>
When you invoke&nbsp;<b>netstat</b>&nbsp;with the&nbsp;−r&nbsp;flag, it displays the kernel routing table in the way we've been doing<br>with&nbsp;<b>route</b>. On vstout, it produces:<br>
#&nbsp;<b>netstat −nr</b><br>
Kernel IP routing table<br>
Destination &nbsp; Gateway &nbsp; &nbsp; &nbsp;Genmask &nbsp; &nbsp; &nbsp; &nbsp; Flags &nbsp;MSS Window &nbsp;irtt Iface<br>
127.0.0.1 &nbsp; &nbsp; * &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.255 UH &nbsp; &nbsp; &nbsp; 0 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 lo<br>
172.16.1.0 &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0 &nbsp; U &nbsp; &nbsp; &nbsp; &nbsp;0 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 eth0<br>
172.16.2.0 &nbsp; &nbsp;172.16.1.1 &nbsp; 255.255.255.0 &nbsp; UG &nbsp; &nbsp; &nbsp; 0 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 eth0<br>
The&nbsp;−n&nbsp;option makes&nbsp;<b>netstat</b>&nbsp;print addresses as dotted quad IP numbers rather than the symbolic host and<br>network names. This option is especially useful when you want to avoid address lookups over the network<br>(e.g., to a DNS or NIS server).<br>
The second column of&nbsp;<b>netstat</b>'s output shows the gateway to which the routing entry points. If no gateway<br>is used, an asterisk is printed instead. The third column shows the generality of the route, i.e., the network<br>mask for this route. When given an IP address to find a suitable route for, the kernel steps through each of the<br>routing table entries, taking the bitwise AND of the address and the genmask before comparing it to the target<br>of the route.<br>
The fourth column displays the following flags that describe the route:<br>
<i>G</i><br>
The route uses a gateway.<br>
<i>U</i><br>
The interface to be used is up.<br>
<i>H</i><br>
Only a single host can be reached through the route. For example, this is the case for the loopback<br>entry 127.0.0.1.<br>
<i>D</i><br>
This route is dynamically created. It is set if the table entry has been generated by a routing daemon<br>like&nbsp;<b>gated</b><a href="TLNAGs.html#62">&nbsp;or by an ICMP redirect message (see the section&nbsp;Section 2.5&nbsp;in Chapter 2).</a><br>
<i>M</i><br>
5.9. The netstat Command<br>
99<br>
<hr>
<A name=116></a>Linux Network Administrators Guide<br>
This route is set if the table entry was modified by an ICMP redirect message.<br>
<i>!</i><br>
The route is a reject route and datagrams will be dropped.<br>
&nbsp;The next three columns show the MSS, Window and irtt that will be applied to TCP connections<br>established via this route. The MSS is the Maximum Segment Size and is the size of the largest datagram the<br>kernel will construct for transmission via this route. The Window is the maximum amount of data the system<br>will accept in a single burst from a remote host. The acronym&nbsp;irtt&nbsp;stands for initial round trip time. The<br>TCP protocol ensures that data is reliably delivered between hosts by retransmitting a datagram if it has been<br>lost. The TCP protocol keeps a running count of how long it takes for a datagram to be delivered to the<br>remote end, and an acknowledgement to be received so that it knows how long to wait before assuming a<br>datagram needs to retransmitted; this process is called the round−trip time. The initial round−trip time is the<br>value that the TCP protocol will use when a connection is first established. For most network types, the<br>default value is okay, but for some slow networks, notably certain types of amateur packet radio networks,<br>the time is too short and causes unnecessary retransmission. The&nbsp;irtt&nbsp;value can be set using the<br><b>route</b>&nbsp;command. Values of zero in these fields mean that the default is being used.<br>
Finally, the last field displays the network interface that this route will use.<br>
<b>5.9.2. Displaying Interface Statistics</b><br>
When invoked with the&nbsp;−i&nbsp;flag,&nbsp;<b>netstat</b>&nbsp;displays statistics for the network interfaces currently configured. If<br>the&nbsp;−a&nbsp;option is also given, it prints&nbsp;<i>all</i>&nbsp;interfaces present in the kernel, not only those that have been<br>configured currently. On vstout, the output from&nbsp;<b>netstat</b>&nbsp;will look like this:<br>
#&nbsp;<b>netstat −i</b><br>
Kernel Interface table<br>
Iface MTU Met &nbsp;RX−OK RX−ERR RX−DRP RX−OVR &nbsp;TX−OK TX−ERR TX−DRP TX−OVR Flags<br>
lo &nbsp; &nbsp; &nbsp;0 &nbsp; 0 &nbsp; 3185 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 &nbsp; 3185 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 BLRU<br>
eth0 1500 &nbsp; 0 972633 &nbsp; &nbsp; 17 &nbsp; &nbsp; 20 &nbsp; &nbsp;120 628711 &nbsp; &nbsp;217 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 BRU<br>
The&nbsp;MTU&nbsp;and&nbsp;Met&nbsp;fields show the current MTU and metric values for that interface. The&nbsp;RX&nbsp;and&nbsp;TX&nbsp;columns<br>show how many packets have been received or transmitted error−free (RX−OK/TX−OK) or damaged<br>(RX−ERR/TX−ERR); how many were dropped (RX−DRP/TX−DRP); and how many were lost because of an<br>overrun (RX−OVR/TX−OVR).<br>
The last column shows the flags that have been set for this interface. These characters are one−character<br>versions of the long flag names that are printed when you display the interface configuration with&nbsp;<b>ifconfig</b>:<br>
<i>B</i><br>
A broadcast address has been set.<br>
<i>L</i><br>
This interface is a loopback device.<br>
<i>M</i><br>
5.9.2. Displaying Interface Statistics<br>
100<br>
<hr>
<A name=117></a>Linux Network Administrators Guide<br>
All packets are received (promiscuous mode).<br>
<i>O</i><br>
ARP is turned off for this interface.<br>
<i>P</i><br>
This is a point−to−point connection.<br>
<i>R</i><br>
Interface is running.<br>
<i>U</i><br>
Interface is up.<br>
<b>5.9.3. Displaying Connections</b><br>
<b>netstat</b>&nbsp;supports a set of options to display active or passive sockets. The options&nbsp;−t,&nbsp;−u,&nbsp;−w, and&nbsp;−x&nbsp;show<br>active TCP, UDP, RAW, or Unix socket connections. If you provide the&nbsp;−a&nbsp;flag in addition, sockets that are<br>waiting for a connection (i.e., listening) are displayed as well. This display will give you a list of all servers<br>that are currently running on your system.<br>
Invoking&nbsp;<b>netstat −ta</b>&nbsp;on vlager produces this output:<br>
$&nbsp;<b>netstat −ta</b><br>
Active Internet Connections<br>
Proto Recv−Q Send−Q Local Address &nbsp; &nbsp;Foreign Address &nbsp; &nbsp;(State)<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:domain &nbsp; &nbsp; &nbsp; &nbsp; *:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:smtp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 vlager:smtp &nbsp; &nbsp; &nbsp;vstout:1040 &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:telnet &nbsp; &nbsp; &nbsp; &nbsp; *:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 localhost:1046 &nbsp; vbardolino:telnet &nbsp;ESTABLISHED &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:chargen &nbsp; &nbsp; &nbsp; &nbsp;*:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:daytime &nbsp; &nbsp; &nbsp; &nbsp;*:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:discard &nbsp; &nbsp; &nbsp; &nbsp;*:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:echo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:shell &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 *:login &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LISTEN &nbsp;<br>
This output shows most servers simply waiting for an incoming connection. However, the fourth line shows<br>an incoming SMTP connection from vstout, and the sixth line tells you there is an outgoing&nbsp;<b>telnet</b>&nbsp;connection<br>to vbardolino.[39]<br>
Using the&nbsp;−a&nbsp;flag by itself will display all sockets from all families.<br>
5.9.3. Displaying Connections<br>
101<br>
<hr>
<A name=118></a><b>5.10. Checking the ARP Tables</b><br>
On some occasions, it is useful to view or alter the contents of the kernel's ARP tables, for example when you<br>suspect a duplicate Internet address is the cause for some intermittent network problem. The&nbsp;<b>arp</b>&nbsp;tool was<br>made for situations like this. Its command−line options are:<br>
arp [−v] [−t&nbsp;<i>hwtype</i>] −a [<i>hostname</i>]<br>
arp [−v] [−t&nbsp;<i>hwtype</i>] −s&nbsp;<i>hostname&nbsp;hwaddr</i><br>
arp [−v] −d&nbsp;<i>hostname</i>&nbsp;[<i>hostname</i>&amp;]<br>
All&nbsp;<i>hostname</i>&nbsp;arguments may be either symbolic hostnames or IP addresses in dotted quad notation.<br>
The first invocation displays the ARP entry for the IP address or host specified, or all hosts known if no<br><i>hostname</i>&nbsp;is given. For example, invoking&nbsp;<b>arp</b>&nbsp;on vlager may yield:<br>
#&nbsp;<b>arp −a</b><br>
IP address &nbsp; &nbsp; &nbsp;HW type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HW address<br>
172.16.1.3 &nbsp; &nbsp; &nbsp;10Mbps Ethernet &nbsp; &nbsp; &nbsp; &nbsp; 00:00:C0:5A:42:C1<br>
172.16.1.2 &nbsp; &nbsp; &nbsp;10Mbps Ethernet &nbsp; &nbsp; &nbsp; &nbsp; 00:00:C0:90:B3:42<br>
172.16.2.4 &nbsp; &nbsp; &nbsp;10Mbps Ethernet &nbsp; &nbsp; &nbsp; &nbsp; 00:00:C0:04:69:AA<br>
which shows the Ethernet addresses of vlager, vstout and vale.<br>
You can limit the display to the hardware type specified using the&nbsp;−t&nbsp;option. This may be ether, ax25, or<br>pronet, standing for 10 Mbps Ethernet; AMPR AX.25, and IEEE 802.5 token ring equipment, respectively.<br>
The&nbsp;−s&nbsp;option is used to permanently add&nbsp;<i>hostname</i>'s Ethernet address to the ARP tables. The<br><i>hwaddr</i>&nbsp;argument specifies the hardware address, which is by default expected to be an Ethernet address<br>specified as six hexadecimal bytes separated by colons. You may also set the hardware address for other<br>types of hardware, using the&nbsp;−t&nbsp;option.<br>
For some reason, ARP queries for the remote host sometimes fail, for instance when its ARP driver is buggy<br>or there is another host in the network that erroneously identifies itself with that host's IP address; this<br>problem requires you to manually add an IP address to the ARP table. Hard−wiring IP addresses in the ARP<br>table is also a (very drastic) measure to protect yourself from hosts on your Ethernet that pose as someone<br>else.<br>
Invoking&nbsp;<b>arp</b>&nbsp;using the&nbsp;−d&nbsp;switch deletes all ARP entries relating to the given host. This switch may be used<br>to force the interface to re−attempt obtaining the Ethernet address for the IP address in question. This is<br>useful when a misconfigured system has broadcasted wrong ARP information (of course, you have to<br>reconfigure the broken host first).<br>
&nbsp;The&nbsp;−s&nbsp;option may also be used to implement&nbsp;<i>proxy</i>&nbsp;ARP. This is a special technique through which a host,<br>say gate, acts as a gateway to another host named fnord by pretending that both addresses refer to the same<br>host, namely gate. It does so by publishing an ARP entry for fnord that points to its own Ethernet interface.<br>Now when a host sends out an ARP query for fnord, gate will return a reply containing its own Ethernet<br>address. The querying host will then send all datagrams to gate, which dutifully forwards them to fnord.<br>
These contortions may be necessary when you want to access fnord from a DOS machine with a broken TCP<br>implementation that doesn't understand routing too well. When you use proxy ARP, it will appear to the DOS<br>machine as if fnord was on the local subnet, so it doesn't have to know about how to route through a gateway.<br>
5.10. Checking the ARP Tables<br>
102<br>
<hr>
<A name=119></a>Linux Network Administrators Guide<br>
Another useful application of proxy ARP is when one of your hosts acts as a gateway to some other host only<br>temporarily, for instance, through a dial−up link. In a previous example, we encountered the laptop vlite,<br>which was connected to vlager through a PLIP link from time to time. Of course, this application will work<br>only if the address of the host you want to provide proxy ARP for is on the same IP subnet as your gateway.<br>vstout could proxy ARP for any host on the Brewery subnet (172.16.1.0), but never for a host on the Winery<br>subnet (172.16.2.0).<br>
The proper invocation to provide proxy ARP for fnord is given below; of course, the given Ethernet address<br>must be that of gate:<br>
# arp −s fnord 00:00:c0:a1:42:e0 pub<br>
The proxy ARP entry may be removed again by invoking:<br>
# arp −d fnord<br>
5.10. Checking the ARP Tables<br>
103<br>
<hr>
<A name=120></a><b>Chapter 6. Name Service and Resolver<br>Configuration</b><br>
As we discussed in&nbsp;<a href="TLNAGs.html#52">Chapter 2, TCP/IP networking may rely on different schemes to convert names into<br></a>addresses. The simplest way is a host table stored in&nbsp;/etc/hosts. This is useful only for small LANs that<br>are run by one single administrator and otherwise have no IP traffic with the outside world. The format of the<br>hosts<a href="TLNAGs.html#97">&nbsp;file has already been described in&nbsp;Chapter 5.</a><br>
Alternatively, you can use the&nbsp;<i>Berkeley Internet Name Domain service</i>&nbsp;(BIND) for resolving hostnames to IP<br>addresses. Configuring BIND can be a real chore, but once you've done it, you can easily make changes in<br>the network topology. On Linux, as on many other Unixish systems, name service is provided through a<br>program called&nbsp;<b>named</b>. At startup, it loads a set of master files into its internal cache and waits for queries<br>from remote or local user processes. There are different ways to set up BIND, and not all require you to run a<br>name server on every host.<br>
This chapter can do little more than give a rough sketch of how DNS works and how to operate a name<br>server. It should be sufficient if you have a small LAN and an Internet uplink. For the most current<br>information, you may want to check the documentation contained in the BIND source package, which<br>supplies manual pages, release notes, and the&nbsp;<i>BIND Operator's Guide</i>&nbsp;(BOG). Don't let this name scare you<br>off; it's actually a very useful document. For a more comprehensive coverage of DNS and associated issues,<br>you may find&nbsp;<i>DNS and BIND</i>&nbsp;by Paul Albitz and Cricket Liu (O'Reilly) a useful reference. DNS questions<br>may be answered in a newsgroup called comp.protocols.tcp−ip.domains. For technical details, the Domain<br>Name System is defined by RFC numbers 1033, 1034, and 1035.<br>
Chapter 6. Name Service and Resolver Configuration<br>
104<br>
<hr>
<A name=121></a><b>6.1. The Resolver Library</b><br>
The term&nbsp;<i>resolver</i>&nbsp;refers not to a special application, but to the resolver library. This is a collection of<br>functions that can be found in the standard C library. The central routines are&nbsp;gethostbyname(2)&nbsp;and<br>gethostbyaddr(2), which look up all IP addresses associated with a host name, and vice versa. They<br>may be configured to simply look up the information in&nbsp;hosts, to query a number of DNS name servers, or<br>to use the&nbsp;<i>hosts</i>&nbsp;database of Network Information Service (NIS).<br>
The resolver functions read configuration files when they are invoked. From these configuration files, they<br>determine what databases to query, in which order, and other details relevant to how you've configured your<br>environment. The older Linux standard library, libc, used&nbsp;/etc/host.conf&nbsp;as its master configuration<br>file, but Version 2 of the GNU standard library, glibc, uses&nbsp;/etc/nsswitch.conf. We'll describe each in<br>turn, since both are commonly used.<br>
<b>6.1.1. The host.conf File</b><br>
The&nbsp;/etc/host.conf&nbsp;tells the older Linux standard library resolver functions which services to use, and<br>in what order.<br>
Options in&nbsp;host.conf&nbsp;must appear on separate lines. Fields may be separated by white space (spaces or<br>tabs). A hash sign (#) introduces a comment that extends to the next newline. The following options are<br>available:<br>
<i>order</i><br>
This option determines the order in which the resolving services are tried. Valid options are bind for<br>querying the name server,&nbsp;hosts&nbsp;for lookups in&nbsp;/etc/hosts, and nis for NIS lookups. Any or all<br>of them may be specified. The order in which they appear on the line determines the order in which<br>the respective services are tried.<br>
<i>multi</i><br>
multi&nbsp;takes on or off as options. This determines if a host in&nbsp;/etc/hosts&nbsp;is allowed to have<br>several IP addresses, which is usually referred to as being multi−homed. The default is off. This<br>flag has no effect on DNS or NIS queries.<br>
<i>nospoof</i><br>
&nbsp;As we'll explain in the section&nbsp;&nbsp;<a href="TLNAGs.html#132">Section 6.2.4</a>, DNS allows you to find the hostname belonging to<br>an IP address by using the in−addr.arpa domain. Attempts by name servers to supply a false<br>hostname are called&nbsp;<i>spoofing</i>. To guard against this, the resolver can be configured to check whether<br>the original IP address is in fact associated with the obtained hostname. If not, the name is rejected<br>and an error is returned. This behavior is turned on by setting nospoof on.<br>
<i>alert</i><br>
This option takes on or off as arguments. If it is turned on, any spoof attempts will cause the resolver<br>to log a message to the&nbsp;<b>syslog</b>&nbsp;facility.<br>
6.1. The Resolver Library<br>
105<br>
<hr>
<A name=122></a>Linux Network Administrators Guide<br>
<i>trim</i><br>
This option takes an argument specifying a domain name that will be removed from hostnames<br>before lookup. This is useful for&nbsp;hosts&nbsp;entries, for which you might only want to specify hostnames<br>without a local domain. If you specify your local domain name here, it will be removed from a<br>lookup of a host with the local domain name appended, thus allowing the lookup in&nbsp;/etc/hosts&nbsp;to<br>succeed. The domain name you add must end with the (.) character (e.g., :linux.org.au.) if<br>trim&nbsp;is to work correctly.<br>
trim options accumulate; you can consider your host as being local to several domains.<br>
A sample file for vlager is shown in&nbsp;<a href="TLNAGs.html#122">Example 6−1.</a><br>
<b>Example 6−1. Sample host.conf File</b><br>
# /etc/host.conf<br>
# We have named running, but no NIS (yet)<br>
order &nbsp; bind,hosts<br>
# Allow multiple addrs<br>
multi &nbsp; on<br>
# Guard against spoof attempts<br>
nospoof on<br>
# Trim local domain (not really necessary).<br>
trim &nbsp; &nbsp;vbrew.com.<br>
<b>6.1.1.1. Resolver environment variables</b><br>
The settings from&nbsp;host.conf&nbsp;may be overridden using a number of environment variables:<br>
<i>RESOLV_HOST_CONF</i><br>
This variable specifies a file to be read instead of&nbsp;/etc/host.conf.<br>
<i>RESOLV_SERV_ORDER</i><br>
This variable overrides the order option given in&nbsp;host.conf. Services are given as hosts, bind,<br>and nis, separated by a space, comma, colon, or semicolon.<br>
<i>RESOLV_SPOOF_CHECK</i><br>
This variable determines the measures taken against spoofing. It is completely disabled by off. The<br>values warn and warn off enable spoof checking by turning logging on and off, respectively. A value<br>of * turns on spoof checks, but leaves the logging facility as defined in&nbsp;host.conf.<br>
<i>RESOLV_MULTI</i><br>
This variable uses a value of on or off to override the multi options from&nbsp;host.conf.<br>
<i>RESOLV_OVERRIDE_TRIM_DOMAINS</i><br>
6.1.1.1. Resolver environment variables<br>
106<br>
<hr>
<A name=123></a>Linux Network Administrators Guide<br>
This variable specifies a list of trim domains that override those given in&nbsp;host.conf. Trim<br>domains were explained earlier when we discussed the trim keyword.<br>
<i>RESOLV_ADD_TRIM_DOMAINS</i><br>
This variable specifies a list of trim domains that are added to those given in&nbsp;host.conf.<br>
<b>6.1.2. The nsswitch.conf File</b><br>
Version 2 of the GNU standard library includes a more powerful and flexible replacement for the older<br>host.conf&nbsp;mechanism. The concept of the name service has been extended to include a variety of different<br>types of information. Configuration options for all of the different functions that query these databases have<br>been brought back into a single configuration file; the&nbsp;nsswitch.conf&nbsp;file.<br>
The&nbsp;nsswitch.conf&nbsp;file allows the system administrator to configure a wide variety of different<br>databases. We'll limit our discussion to options that relate to host and network IP address resolution. You can<br>easily find more information about the other features by reading the GNU standard library documentation.<br>
Options in&nbsp;nsswitch.conf&nbsp;must appear on separate lines. Fields may be separated by whitespace (spaces<br>or tabs). A hash sign (#) introduces a comment that extends to the next newline. Each line describes a<br>particular service; hostname resolution is one of these. The first field in each line is the name of the database,<br>ending with a colon. The database name associated with host address resolution is hosts. A related database is<br>networks, which is used for resolution of network names into network addresses. The remainder of each line<br>stores options that determine the way lookups for that database are performed.<br>
The following options are available:<br>
<i>dns</i><br>
Use the Domain Name System (DNS) service to resolve the address. This makes sense only for host<br>address resolution, not network address resolution. This mechanism uses the<br>/etc/resolv.conf&nbsp;file that we'll describe later in the chapter.<br>
<i>files</i><br>
Search a local file for the host or network name and its corresponding address. This option uses the<br>traditional&nbsp;/etc/hosts&nbsp;and&nbsp;/etc/network&nbsp;files.<br>
<i>nis or nisplus</i><br>
Use the Network Information System (NIS) to resolve the host or network address. NIS and NIS+<br>are discussed in detail in&nbsp;<a href="TLNAGs.html#270">Chapter 13.</a><br>
The order in which the services to be queried are listed determines the order in which they are queried when<br>attempting to resolve a name. The query−order list is in the service description in the<br>/etc/nsswitch.conf&nbsp;file. The services are queried from left to right and by default searching stops<br>when a resolution is successful.<br>
6.1.2. The nsswitch.conf File<br>
107<br>
<hr>
<A name=124></a>Linux Network Administrators Guide<br>
A simple example of host and network database specification that would mimic our configuration using the<br>older libc standard library is shown in&nbsp;<a href="TLNAGs.html#124">Example 6−2.</a><br>
<b>Example 6−2. Sample nsswitch.conf File</b><br>
# /etc/nsswitch.conf<br>
#<br>
# Example configuration of GNU Name Service Switch functionality.<br>
# Information about this file is available in the `libc6−doc' package.<br>
hosts: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dns files<br>
networks: &nbsp; &nbsp; &nbsp; files<br>
This example causes the system to look up hosts first in the Domain Name System, and the<br>/etc/hosts&nbsp;file, if that can't find them. Network name lookups would be attempted using only the<br>/etc/networks&nbsp;file.<br>
You are able to control the lookup behavior more precisely using action items that describe what action to<br>take given the result of the previous lookup attempt. Action items appear between service specifications, and<br>are enclosed within square brackets, [ ]. The general syntax of the action statement is:<br>
[ [!]&nbsp;<i>status</i>&nbsp;=&nbsp;<i>action</i>&nbsp;... ]<br>
There are two possible actions:<br>
<i>return</i><br>
Controls returns to the program that attempted the name resolution. If a lookup attempt was<br>successful, the resolver will return with the details, otherwise it will return a zero result.<br>
<i>continue</i><br>
The resolver will move on to the next service in the list and attempt resolution using it.<br>
The optional (!) character specifies that the status value should be inverted before testing; that is, it means<br>not.<br>
The available status values on which we can act are:<br>
<i>success</i><br>
The requested entry was found without error. The default action for this status is return.<br>
<i>notfound</i><br>
There was no error in the lookup, but the target host or network could not be found. The default<br>action for this status is continue.<br>
<i>unavail</i><br>
6.1.2. The nsswitch.conf File<br>
108<br>
<hr>
<A name=125></a>Linux Network Administrators Guide<br>
The service queried was unavailable. This could mean that the&nbsp;hosts&nbsp;or&nbsp;networks&nbsp;file was<br>unreadable for the files service or that a name server or NIS server did not respond for the dns or<br>nis services. The default action for this status is continue.<br>
<i>tryagain</i><br>
This status means the service is temporarily unavailable. For the files files service, this would usually<br>indicate that the relevant file was locked by some process. For other services, it may mean the server<br>was temporarily unable to accept connections. The default action for this status is continue.<br>
A simple example of how you might use this mechanism is shown in&nbsp;<a href="TLNAGs.html#125">Example 6−3.</a><br>
<b>Example 6−3. Sample nsswitch.conf File Using an Action Statement</b><br>
# /etc/nsswitch.conf<br>
#<br>
# Example configuration of GNU Name Service Switch functionality.<br>
# Information about this file is available in the `libc6−doc' package.<br>
hosts: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dns [!UNAVAIL=return] files<br>
networks: &nbsp; &nbsp; &nbsp; files<br>
This example attempts host resolution using the Domain Name Service system. If the return status is anything<br>other than unavailable, the resolver returns whatever it has found. If, and only if, the DNS lookup attempt<br>returns an unavailable status, the resolver attempts to use the local&nbsp;/etc/hosts. This means that we should<br>use the&nbsp;hosts&nbsp;file only if our name server is unavailable for some reason.<br>
<b>6.1.3. Configuring Name Server Lookups Using resolv.conf</b><br>
When configuring the resolver library to use the BIND name service for host lookups, you also have to tell it<br>which name servers to use. There is a separate file for this called&nbsp;resolv.conf. If this file does not exist or<br>is empty, the resolver assumes the name server is on your local host.<br>
To run a name server on your local host, you have to set it up separately, as will be explained in the following<br>section. If you are on a local network and have the opportunity to use an existing name server, this should<br>always be preferred. If you use a dialup IP connection to the Internet, you would normally specify the name<br>server of your service provider in the&nbsp;resolv.conf&nbsp;file.<br>
The most important option in&nbsp;resolv.conf&nbsp;is name server, which gives the IP address of a name server to<br>use. If you specify several name servers by giving the name server option several times, they are tried in the<br>order given. You should therefore put the most reliable server first. The current implementation allows you to<br>have up to three name server statements in&nbsp;resolv.conf. If no name server option is given, the resolver<br>attempts to connect to the name server on the local host.<br>
&nbsp;Two other options, domain and search, let you use shortcut names for hosts in your local domain. Usually,<br>when just telnetting to another host in your local domain, you don't want to type in the fully qualified<br>hostname, but use a name like gauss on the command line and have the resolver tack on the<br>mathematics.groucho.edu part.<br>
6.1.3. Configuring Name Server Lookups Using resolv.conf<br>
109<br>
<hr>
<A name=126></a>Linux Network Administrators Guide<br>
This is just the domain statement's purpose. It lets you specify a default domain name to be appended when<br>DNS fails to look up a hostname. For instance, when given the name gauss, the resolver fails to find gauss. in<br>DNS, because there is no such top−level domain. When given mathematics.groucho.edu as a default domain,<br>the resolver repeats the query for gauss with the default domain appended, this time succeeding.<br>
That's just fine, you may think, but as soon you get out of the Math department's domain, you're back to those<br>fully qualified domain names. Of course, you would also want to have shorthands like quark.physics for hosts<br>in the Physics department's domain.<br>
This is when the&nbsp;<i>search list</i>&nbsp;comes in. A search list can be specified using the search option, which is a<br>generalization of the domain statement. Where the latter gives a single default domain, the former specifies a<br>whole list of them, each to be tried in turn until a lookup succeeds. This list must be separated by blanks or<br>tabs.<br>
The search and domain statements are mutually exclusive and may not appear more than once. If neither<br>option is given, the resolver will try to guess the default domain from the local hostname using the<br>getdomainname(2)&nbsp;system call. If the local hostname doesn't have a domain part, the default domain will<br>be assumed to be the root domain.<br>
If you decide to put a search statement into&nbsp;resolv.conf, you should be careful about what domains you<br>add to this list. Resolver libraries prior to BIND 4.9 used to construct a default search list from the domain<br>name when no search list was given. This default list was made up of the default domain itself, plus all of its<br>parent domains up to the root. This caused some problems because DNS requests wound up at name servers<br>that were never meant to see them.<br>
Assume you're at the Virtual Brewery and want to log in to foot.groucho.edu. By a slip of your fingers, you<br>mistype foot as foo, which doesn't exist. GMU's name server will therefore tell you that it knows no such<br>host. With the old−style search list, the resolver would now go on trying the name with vbrew.com and<br>com appended. The latter is problematic because groucho.edu.com might actually be a valid domain name.<br>Their name server might then even find foo in their domain, pointing you to one of their hostswhich clearly<br>was not intended.<br>
For some applications, these bogus host lookups can be a security problem. Therefore, you should usually<br>limit the domains on your search list to your local organization, or something comparable. At the<br>Mathematics department of Groucho Marx University, the search list would commonly be set to<br>maths.groucho.edu and groucho.edu.<br>
If default domains sound confusing to you, consider this sample&nbsp;resolv.conf&nbsp;file for the Virtual Brewery:<br>
# /etc/resolv.conf<br>
# Our domain<br>
domain &nbsp; &nbsp; &nbsp; &nbsp; vbrew.com<br>
#<br>
# We use vlager as central name server:<br>
name server &nbsp; &nbsp; 172.16.1.1<br>
When resolving the name vale, the resolver looks up vale and, failing this, vale.vbrew.com.<br>
6.1.3. Configuring Name Server Lookups Using resolv.conf<br>
110<br>
<hr>
<A name=127></a>Linux Network Administrators Guide<br>
<b>6.1.4. Resolver Robustness</b><br>
When running a LAN inside a larger network, you definitely should use central name servers if they are<br>available. The name servers develop rich caches that speed up repeat queries, since all queries are forwarded<br>to them. However, this scheme has a drawback: when a fire destroyed the backbone cable at Olaf's university,<br>no more work was possible on his department's LAN because the resolver could no longer reach any of the<br>name servers. This situation caused difficulties with most network services, such as X terminal logins and<br>printing.<br>
Although it is not very common for campus backbones to go down in flames, one might want to take<br>precautions against cases like this.<br>
One option is to set up a local name server that resolves hostnames from your local domain and forwards all<br>queries for other hostnames to the main servers. Of course, this is applicable only if you are running your<br>own domain.<br>
Alternatively, you can maintain a backup host table for your domain or LAN in&nbsp;/etc/hosts. This is very<br>simple to do. You simply ensure that the resolver library queries DNS first, and the hosts file next. In an<br>/etc/host.conf&nbsp;file you'd use order bind,hosts, and in an&nbsp;/etc/nsswitch.conf&nbsp;file you'd use<br>hosts: dns files, to make the resolver fall back to the hosts file if the central name server is unreachable.<br>
6.1.4. Resolver Robustness<br>
111<br>
<hr>
<A name=128></a><IMG src="TLNAG-128_1.png"><br>
<b>6.2. How DNS Works</b><br>
DNS organizes hostnames in a domain hierarchy. A&nbsp;<i>domain</i>&nbsp;is a collection of sites that are related in some<br>sensebecause they form a proper network (e.g., all machines on a campus, or all hosts on BITNET), because<br>they all belong to a certain organization (e.g., the U.S. government), or because they're simply geographically<br>close. For instance, universities are commonly grouped in the edu domain, with each university or college<br>using a separate&nbsp;<i>subdomain</i>, below which their hosts are subsumed. Groucho Marx University have the<br>groucho.edu domain, while the LAN of the Mathematics department is assigned maths.groucho.edu. Hosts on<br>the departmental network would have this domain name tacked onto their hostname, so erdos would be<br>known as erdos.maths.groucho.edu. This is called the&nbsp;<i>fully qualified domain name</i>&nbsp;(FQDN), which uniquely<br>identifies this host worldwide.<br>
<a href="TLNAGs.html#128">Figure 6−1&nbsp;shows a section of the namespace. The entry at the root of this tree, which is denoted by a single<br></a>dot, is quite appropriately called the&nbsp;<i>root domain</i>&nbsp;and encompasses all other domains. To indicate that a<br>hostname is a fully qualified domain name, rather than a name relative to some (implicit) local domain, it is<br>sometimes written with a trailing dot. This dot signifies that the name's last component is the root domain.<br>
<b>Figure 6−1. A part of the domain namespace</b><br>
Depending on its location in the name hierarchy, a domain may be called top−level, second−level, or<br>third−level. More levels of subdivision occur, but they are rare. This list details several top−level domains<br>you may see frequently:<br>
<b>Domain&nbsp;Description</b><br>
edu<br>
(Mostly U.S.) educational institutions like universities.<br>
com<br>
Commercial organizations and companies.<br>
org<br>
Non−commercial organizations. Private UUCP networks are often in this domain.<br>
net<br>
Gateways and other administrative hosts on a network.<br>
6.2. How DNS Works<br>
112<br>
<hr>
<A name=129></a>Linux Network Administrators Guide<br>
mil<br>
U.S. military institutions.<br>
gov<br>
U.S. government institutions.<br>
uucp<br>
Officially, all site names formerly used as UUCP names without domains have been moved to this<br>domain.<br>
Historically, the first four of these were assigned to the U.S., but recent changes in policy have meant that<br>these domains, named global Top Level Domains (gTLD), are now considered global in nature. Negotiations<br>are currently underway to broaden the range of gTLDs, which may result in increased choice in the future.<br>
Outside the U.S., each country generally uses a top−level domain of its own named after the two−letter<br>country code defined in ISO−3166. Finland, for instance, uses the fi domain; fr is used by France, de by<br>Germany, and au by Australia. Below this top−level domain, each country's NIC is free to organize<br>hostnames in whatever way they want. Australia has second−level domains similar to the international<br>top−level domains, named com.au and edu.au. Other countries, like Germany, don't use this extra level, but<br>have slightly long names that refer directly to the organizations running a particular domain. It's not<br>uncommon to see hostnames like ftp.informatik.uni−erlangen.de. Chalk that up to German efficiency.<br>
Of course, these national domains do not imply that a host below that domain is actually located in that<br>country; it means only that the host has been registered with that country's NIC. A Swedish manufacturer<br>might have a branch in Australia and still have all its hosts registered with the se top−level domain.<br>
Organizing the namespace in a hierarchy of domain names nicely solves the problem of name uniqueness;<br>with DNS, a hostname has to be unique only within its domain to give it a name different from all other hosts<br>worldwide. Furthermore, fully qualified names are easy to remember. Taken by themselves, these are already<br>very good reasons to split up a large domain into several subdomains.<br>
&nbsp;DNS does even more for you than this. It also allows you to delegate authority over a subdomain to its<br>administrators. For example, the maintainers at the Groucho Computing Center might create a subdomain for<br>each department; we already encountered the math and physics subdomains above. When they find the<br>network at the Physics department too large and chaotic to manage from outside (after all, physicists are<br>known to be an unruly bunch of people), they may simply pass control of the physics.groucho.edu domain to<br>the administrators of this network. These administrators are free to use whatever hostnames they like and<br>assign them IP addresses from their network in whatever fashion they desire, without outside interference.<br>
To this end, the namespace is split up into&nbsp;<i>zones</i>, each rooted at a domain. Note the subtle difference between<br>a&nbsp;<i>zone</i>&nbsp;and a&nbsp;<i>domain</i>: the domain groucho.edu encompasses all hosts at Groucho Marx University, while the<br>zone groucho.edu includes only the hosts that are managed by the Computing Center directly; those at the<br>Mathematics department, for example. The hosts at the Physics department belong to a different zone,<br>namely physics.groucho.edu. In&nbsp;<a href="TLNAGs.html#128">Figure 6−1, the start of a zone is marked by a small circle to the right of the<br></a>domain name.<br>
<b>6.2.1. Name Lookups with DNS</b><br>
At first glance, all this domain and zone fuss seems to make name resolution an awfully complicated<br>business. After all, if no central authority controls what names are assigned to which hosts, how is a humble<br>application supposed to know?<br>
6.2.1. Name Lookups with DNS<br>
113<br>
<hr>
<A name=130></a>Linux Network Administrators Guide<br>
Now comes the really ingenious part about DNS. If you want to find the IP address of erdos, DNS says, Go<br>ask the people who manage it, and they will tell you.<br>
In fact, DNS is a giant distributed database. It is implemented by so−called name servers that supply<br>information on a given domain or set of domains. For each zone there are at least two, or at most a few, name<br>servers that hold all authoritative information on hosts in that zone. To obtain the IP address of erdos, all you<br>have to do is contact the name server for the groucho.edu zone, which will then return the desired data.<br>
Easier said than done, you might think. So how do I know how to reach the name server at Groucho Marx<br>University? In case your computer isn't equipped with an address−resolving oracle, DNS provides for this,<br>too. When your application wants to look up information on erdos, it contacts a local name server, which<br>conducts a so−called iterative query for it. It starts off by sending a query to a name server for the root<br>domain, asking for the address of erdos.maths.groucho.edu. The root name server recognizes that this name<br>does not belong to its zone of authority, but rather to one below the edu domain. Thus, it tells you to contact<br>an edu zone name server for more information and encloses a list of all edu name servers along with their<br>addresses. Your local name server will then go on and query one of those, for instance, a.isi.edu. In a manner<br>similar to the root name server, a.isi.edu knows that the groucho.edu people run a zone of their own, and<br>points you to their servers. The local name server will then present its query for erdos to one of these, which<br>will finally recognize the name as belonging to its zone, and return the corresponding IP address.<br>
This looks like a lot of traffic being generated for looking up a measly IP address, but it's really only<br>miniscule compared to the amount of data that would have to be transferred if we were still stuck with<br>HOSTS.TXT. There's still room for improvement with this scheme, however.<br>
To improve response time during future queries, the name server stores the information obtained in its local<br><i>cache</i>. So the next time anyone on your local network wants to look up the address of a host in the<br>groucho.edu domain, your name server will go directly to the groucho.edu name server.[40]<br>
Of course, the name server will not keep this information forever; it will discard it after some time. The<br>expiration interval is called the&nbsp;<i>time to live</i>, or TTL. Each datum in the DNS database is assigned such a TTL<br>by administrators of the responsible zone.<br>
<b>6.2.2. Types of Name Servers</b><br>
Name servers that hold all information on hosts within a zone are called&nbsp;<i>authoritative</i>&nbsp;for this zone, and<br>sometimes are referred to as&nbsp;<i>master name servers</i>. Any query for a host within this zone will end up at one of<br>these master name servers.<br>
&nbsp;Master servers must be fairly well synchronized. Thus, the zone's network administrator must make one the<br><i>primary</i>&nbsp;server, which loads its zone information from data files, and make the others&nbsp;<i>secondary</i>&nbsp;servers,<br>which transfer the zone data from the primary server at regular intervals.<br>
Having several name servers distributes workload; it also provides backup. When one name server machine<br>fails in a benign way, like crashing or losing its network connection, all queries will fall back to the other<br>servers. Of course, this scheme doesn't protect you from server malfunctions that produce wrong replies to all<br>DNS requests, such as from software bugs in the server program itself.<br>
You can also run a name server that is not authoritative for any domain.&nbsp;[41]&nbsp;This is useful, as the name<br>server will still be able to conduct DNS queries for the applications running on the local network and cache<br>
6.2.2. Types of Name Servers<br>
114<br>
<hr>
<A name=131></a>Linux Network Administrators Guide<br>
the information. Hence it is called a&nbsp;<i>caching−only</i>&nbsp;server.<br>
<b>6.2.3. The DNS Database</b><br>
We have seen that DNS not only deals with IP addresses of hosts, but also exchanges information on name<br>servers. DNS databases may have, in fact, many different types of entries.<br>
A single piece of information from the DNS database is called a&nbsp;<i>resource record</i>&nbsp;(RR). Each record has a<br>type associated with it describing the sort of data it represents, and a class specifying the type of network it<br>applies to. The latter accommodates the needs of different addressing schemes, like IP addresses (the IN<br>class), Hesiod addresses (used by MIT's Kerberos system), and a few more. The prototypical resource record<br>type is the A record, which associates a fully qualified domain name with an IP address.<br>
&nbsp;A host may be known by more than one name. For example you might have a server that provides both<br>FTP and World Wide Web servers, which you give two names: ftp.machine.org and www.machine.org.<br>However, one of these names must be identified as the official or&nbsp;<i>canonical</i>&nbsp;hostname, while the others are<br>simply aliases referring to the official hostname. The difference is that the canonical hostname is the one with<br>an associated A record, while the others only have a record of type CNAME that points to the canonical<br>hostname.<br>
We will not go through all record types here, but we will give you a brief example.&nbsp;<a href="TLNAGs.html#131">Example 6−4&nbsp;shows a<br></a>part of the domain database that is loaded into the name servers for the physics.groucho.edu zone.<br>
<b>Example 6−4. An Excerpt from the named.hosts File for the Physics Department</b><br>
; Authoritative Information on physics.groucho.edu.<br>
@ &nbsp;IN &nbsp;SOA niels.physics.groucho.edu. janet.niels.physics.groucho.edu. {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1999090200 &nbsp; &nbsp; &nbsp; ; serial no<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 360000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; refresh<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; retry<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; expire<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; default ttl<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
;<br>
; Name servers<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;NS &nbsp; &nbsp; &nbsp; niels<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;NS &nbsp; &nbsp; &nbsp; gauss.maths.groucho.edu.<br>
gauss.maths.groucho.edu. IN A 149.76.4.23<br>
;<br>
; Theoretical Physics (subnet 12)<br>
niels &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.12.1<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.1.12<br>
name server &nbsp; &nbsp;IN &nbsp; &nbsp;CNAME &nbsp; &nbsp;niels<br>
otto &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.12.2<br>
quark &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.12.4<br>
down &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.12.5<br>
strange &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.12.6<br>
...<br>
; Collider Lab. (subnet 14)<br>
boson &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.14.1<br>
muon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.14.7<br>
bogon &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp;A &nbsp; &nbsp; &nbsp; &nbsp;149.76.14.12<br>
...<br>
6.2.3. The DNS Database<br>
115<br>
<hr>
<A name=132></a>Linux Network Administrators Guide<br>
&nbsp;Apart from the A and CNAME records, you can see a special record at the top of the file, stretching several<br>lines. This is the SOA resource record signaling the&nbsp;<i>Start of Authority</i>, which holds general information on<br>the zone the server is authoritative for. The SOA record comprises, for instance, the default time to live for all<br>records.<br>
Note that all names in the sample file that do not end with a dot should be interpreted relative to the<br>physics.groucho.edu domain. The special name (@) used in the&nbsp;SOA&nbsp;record refers to the domain name by<br>itself.<br>
We have seen earlier that the name servers for the groucho.edu domain somehow have to know about the<br>physics zone so that they can point queries to their name servers. This is usually achieved by a pair of<br>records: the NS record that gives the server's FQDN, and an A record that associates an address with that<br>name. Since these records are what holds the namespace together, they are frequently called&nbsp;<i>glue records</i>.<br>They are the only instances of records in which a parent zone actually holds information on hosts in the<br>subordinate zone. The glue records pointing to the name servers for physics.groucho.edu are shown in<br><a href="TLNAGs.html#132">Example 6−5</a>.<br>
<b>Example 6−5. An Excerpt from the named.hosts File for GMU</b><br>
&nbsp;; Zone data for the groucho.edu zone.<br>
&nbsp;@ &nbsp;IN &nbsp;SOA vax12.gcc.groucho.edu. joe.vax12.gcc.groucho.edu. {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1999070100 &nbsp; &nbsp; &nbsp; ; serial no<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 360000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; refresh<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; retry<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; expire<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; default ttl<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br>
&nbsp;....<br>
&nbsp;;<br>
&nbsp;; Glue records for the physics.groucho.edu zone<br>
&nbsp;physics &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp; NS &nbsp; &nbsp; &nbsp; &nbsp;niels.physics.groucho.edu.<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp; NS &nbsp; &nbsp; &nbsp; &nbsp;gauss.maths.groucho.edu.<br>
&nbsp;niels.physics &nbsp;IN &nbsp; &nbsp; A &nbsp; &nbsp; &nbsp; &nbsp; 149.76.12.1<br>
&nbsp;gauss.maths &nbsp; &nbsp;IN &nbsp; &nbsp; A &nbsp; &nbsp; &nbsp; &nbsp; 149.76.4.23<br>
&nbsp;...<br>
<b>6.2.4. Reverse Lookups</b><br>
Finding the IP address belonging to a host is certainly the most common use for the Domain Name System,<br>but sometimes you'll want to find the canonical hostname corresponding to an address. Finding this hostname<br>is called&nbsp;<i>reverse mapping</i>, and is used by several network services to verify a client's identity. When using a<br>single&nbsp;hosts&nbsp;file, reverse lookups simply involve searching the file for a host that owns the IP address in<br>question. With DNS, an exhaustive search of the namespace is out of the question. Instead, a special domain,<br>in−addr.arpa, has been created that contains the IP addresses of all hosts in a reversed dotted quad notation.<br>For instance, an IP address of 149.76.12.4 corresponds to the name 4.12.76.149.in−addr.arpa. The<br>resource−record type linking these names to their canonical hostnames is PTR.<br>
&nbsp;Creating a zone of authority usually means that its administrators have full control over how they assign<br>addresses to names. Since they usually have one or more IP networks or subnets at their hands, there's a<br>one−to−many mapping between DNS zones and IP networks. The Physics department, for instance,<br>comprises the subnets 149.76.8.0, 149.76.12.0, and 149.76.14.0.<br>
6.2.4. Reverse Lookups<br>
116<br>
<hr>
<A name=133></a>Linux Network Administrators Guide<br>
Consequently, new zones in the in−addr.arpa domain have to be created along with the physics zone, and<br>delegated to the network administrators at the department: 8.76.149.in−addr.arpa, 12.76.149.in−addr.arpa,<br>and 14.76.149.in−addr.arpa. Otherwise, installing a new host at the Collider Lab would require them to<br>contact their parent domain to have the new address entered into their in−addr.arpa zone file.<br>
The zone database for subnet 12 is shown in&nbsp;<a href="TLNAGs.html#133">Example 6−6. The corresponding glue records in the database of<br></a>their parent zone are shown in&nbsp;<a href="TLNAGs.html#133">Example 6−7.</a><br>
<b>Example 6−6. An Excerpt from the named.rev File for Subnet 12</b><br>
&nbsp;; the 12.76.149.in−addr.arpa domain.<br>
&nbsp;@ &nbsp;IN &nbsp;SOA &nbsp;niels.physics.groucho.edu. janet.niels.physics.groucho.edu. {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1999090200 360000 3600 3600000 3600<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp;2 &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp; PTR &nbsp; &nbsp; &nbsp; otto.physics.groucho.edu.<br>
&nbsp;4 &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp; PTR &nbsp; &nbsp; &nbsp; quark.physics.groucho.edu.<br>
&nbsp;5 &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp; PTR &nbsp; &nbsp; &nbsp; down.physics.groucho.edu.<br>
&nbsp;6 &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp; PTR &nbsp; &nbsp; &nbsp; strange.physics.groucho.edu.<br>
<b>Example 6−7. An Excerpt from the named.rev File for Network 149.76</b><br>
&nbsp;; the 76.149.in−addr.arpa domain.<br>
&nbsp;@ &nbsp;IN &nbsp;SOA vax12.gcc.groucho.edu. joe.vax12.gcc.groucho.edu. {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1999070100 360000 3600 3600000 3600<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp;...<br>
&nbsp;; subnet 4: Mathematics Dept.<br>
&nbsp;1.4 &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; &nbsp; PTR &nbsp; &nbsp; &nbsp;sophus.maths.groucho.edu.<br>
&nbsp;17.4 &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp; PTR &nbsp; &nbsp; &nbsp;erdos.maths.groucho.edu.<br>
&nbsp;23.4 &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp; PTR &nbsp; &nbsp; &nbsp;gauss.maths.groucho.edu.<br>
&nbsp;...<br>
&nbsp;; subnet 12: Physics Dept, separate zone<br>
&nbsp;12 &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp; NS &nbsp; &nbsp; &nbsp; niels.physics.groucho.edu.<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp; &nbsp; NS &nbsp; &nbsp; &nbsp; gauss.maths.groucho.edu.<br>
&nbsp;niels.physics.groucho.edu. IN &nbsp;A 149.76.12.1<br>
&nbsp;gauss.maths.groucho.edu. IN &nbsp;A &nbsp; 149.76.4.23<br>
&nbsp;...<br>
in−addr.arpa system zones can only be created as supersets of IP networks. An even more severe restriction<br>is that these networks' netmasks have to be on byte boundaries. All subnets at Groucho Marx University have<br>a netmask of 255.255.255.0, hence an in−addr.arpa zone could be created for each subnet. However, if the<br>netmask were 255.255.255.128 instead, creating zones for the subnet 149.76.12.128 would be impossible,<br>because there's no way to tell DNS that the 12.76.149.in−addr.arpa domain has been split into two zones of<br>authority, with hostnames ranging from 1 through 127, and 128 through 255, respectively.<br>
6.2.4. Reverse Lookups<br>
117<br>
<hr>
<A name=134></a><b>6.3. Running named</b><br>
<b>named</b>&nbsp;(pronounced&nbsp;<i>name−dee</i>) provides DNS on most Unix machines. It is a server program originally<br>developed for BSD to provide name service to clients, and possibly to other name servers. BIND Version 4<br>was around for some time and appeared in most Linux distributions. The new release, Version 8, has been<br>introduced in most Linux distributions, and is a big change from previous versions.[42]&nbsp;It has many new<br>features, such as support for DNS dynamic updates, DNS change notifications, much improved performance,<br>and a new configuration file syntax. Please check the documentation contained in the source distribution for<br>details.<br>
This section requires some understanding of the way DNS works. If the following discussion is all Greek to<br>you, you may want to reread the section&nbsp;<a href="TLNAGs.html#128">Section 6.2</a>.&quot;<br>
<b>named</b>&nbsp;is usually started at system boot time and runs until the machine goes down again. Implementations<br>of BIND prior to Version 8 take their information from a configuration file called&nbsp;<b>/etc/named.boot</b>&nbsp;and<br>various files that map domain names to addresses. The latter are called&nbsp;<i>zone files</i>. Versions of BIND from<br>Version 8 onwards use&nbsp;/etc/named.conf&nbsp;in place of&nbsp;/etc/named.boot.<br>
To run&nbsp;<b>named</b>&nbsp;at the prompt, enter:<br>
#&nbsp;<b>/usr/sbin/named</b><br>
<b>named</b>&nbsp;will come up and read the&nbsp;<b>named.boot</b>&nbsp;file and any zone files specified therein. It writes its process<br>ID to&nbsp;/var/run/named.pid&nbsp;in ASCII, downloads any zone files from primary servers, if necessary, and<br>starts listening on port 53 for DNS queries.<br>
<b>6.3.1. The named.boot File</b><br>
The BIND configuration file prior to Version 8 was very simple in structure. BIND Version 8 has a very<br>different configuration file syntax to deal with many of the new features introduced. The name of the<br>configuration file changed from&nbsp;/etc/named.boot, in older versions of BIND, to<br>/etc/named.conf&nbsp;in BIND Version 8. We'll focus on configuring the older version because it is probably<br>what most distributions are still using, but we'll present an equivalent&nbsp;named.conf&nbsp;to illustrate the<br>differences, and we'll talk about how to convert the old format into the new one.<br>
The&nbsp;<b>named.boot</b>&nbsp;file is generally small and contains little but pointers to master files containing zone<br>information and pointers to other name servers. Comments in the boot file start with the (#) or (;) characters<br>and extend to the next newline. Before we discuss the format of&nbsp;named.boot&nbsp;in more detail, we will take a<br>look at the sample file for vlager given in&nbsp;<a href="TLNAGs.html#134">Example 6−8.</a><br>
<b>Example 6−8. The named.boot File for vlager</b><br>
;<br>
; /etc/named.boot file for vlager.vbrew.com<br>
;<br>
directory &nbsp; &nbsp; /var/named<br>
6.3. Running named<br>
118<br>
<hr>
<A name=135></a>Linux Network Administrators Guide<br>
;<br>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; domain &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file<br>
;−−−−−−−−−−−−−−−−−<br>
cache &nbsp; &nbsp; &nbsp; &nbsp; . &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;named.ca<br>
primary &nbsp; &nbsp; &nbsp; vbrew.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;named.hosts<br>
primary &nbsp; &nbsp; &nbsp; 0.0.127.in−addr.arpa &nbsp; &nbsp; named.local<br>
primary &nbsp; &nbsp; &nbsp; 16.172.in−addr.arpa &nbsp; &nbsp; &nbsp;named.rev<br>
Let's look at each statement individually. The directory keyword tells&nbsp;<b>named</b>&nbsp;that all filenames referred to<br>later in this file, zone files for example, are located in the&nbsp;/var/named&nbsp;directory. This saves a little typing.<br>
The primary keyword shown in this example loads information into&nbsp;<b>named</b>. This information is taken from<br>the master files specified as the last of the parameters. These files represent DNS resource records, which we<br>will look at next.<br>
In this example, we configured&nbsp;<b>named</b>&nbsp;as the primary name server for three domains, as indicated by the<br>three primary statements. The first of these statements instructs&nbsp;<b>named</b>&nbsp;to act as a primary server for<br>vbrew.com, taking the zone data from the file&nbsp;named.hosts.<br>
The cache keyword is very special and should be present on virtually all machines running a name server. It<br>instructs&nbsp;<b>named</b>&nbsp;to enable its cache and to load the&nbsp;<i>root name server hints</i>&nbsp;from the cache file specified<br>(named.ca&nbsp;in our example). We will come back to the name server hints in the following list.<br>
Here's a list of the most important options you can use in&nbsp;named.boot:<br>
<i>directory</i><br>
This option specifies a directory in which zone files reside. Names of files in other options may be<br>given relative to this directory. Several directories may be specified by repeatedly using directory.<br>The Linux file system standard suggests this should be&nbsp;/var/named.<br>
<i>primary</i><br>
&nbsp;This option takes a domain name and filename as an argument, declaring the local server<br>authoritative for the named domain. As a primary server,&nbsp;<b>named</b>&nbsp;loads the zone information from the<br>given master file.<br>
There will always be at least one primary entry in every boot file used for reverse mapping of<br>network 127.0.0.0, which is the local loopback network.<br>
<i>secondary</i><br>
&nbsp;This statement takes a domain name, an address list, and a filename as an argument. It declares the<br>local server a secondary master server for the specified domain.<br>
A secondary server holds authoritative data on the domain, too, but it doesn't gather it from files;<br>instead, it tries to download it from the primary server. The IP address of at least one primary server<br>thus must be given to&nbsp;<b>named</b>&nbsp;in the address list. The local server contacts each of them in turn until it<br>successfully transfers the zone database, which is then stored in the backup file given as the third<br>argument. If none of the primary servers responds, the zone data is retrieved from the backup file<br>instead.<br>
6.3. Running named<br>
119<br>
<hr>
<A name=136></a>Linux Network Administrators Guide<br>
<b>named</b>&nbsp;then attempts to refresh the zone data at regular intervals. This process is explained later in<br>connection with the SOA resource record type.<br>
<i>cache</i><br>
&nbsp;This option takes a domain name and filename as arguments. This file contains the root server<br>hints, which is a list of records pointing to the root name servers. Only NS and A records will be<br>recognized. The&nbsp;<i>domain</i>&nbsp;should be the root domain name, a simple period (.).<br>
This information is absolutely crucial to&nbsp;<b>named</b>; if the cache statement does not occur in the boot<br>file,&nbsp;<b>named</b>&nbsp;will not develop a local cache at all. This situation/lack of development will severely<br>degrade performance and increase network load if the next server queried is not on the local net.<br>Moreover,&nbsp;<b>named</b>&nbsp;will not be able to reach any root name servers, and thus won't resolve any<br>addresses except those it is authoritative for. An exception from this rule involves forwarding servers<br>(see the forwarders option that follows).<br>
<i>forwarders</i><br>
This statement takes a whitespace−separated list of addresses as an argument. The IP addresses in<br>this list specify a list of name servers that&nbsp;<b>named</b>&nbsp;may query if it fails to resolve a query from its<br>local cache. They are tried in order until one of them responds to the query. Typically, you would use<br>the name server of your network provider or another well−known server as a forwarder.<br>
<i>slave</i><br>
This statement makes the name server a&nbsp;<i>slave</i>&nbsp;server. It never performs recursive queries itself, but<br>only forwards them to servers specified in the forwarders statement.<br>
There are two options that we will not describe here: sortlist and domain. Two other directives may also be<br>used inside these database files: $INCLUDE and $ORIGIN. Since they are rarely needed, we will not<br>describe them here, either.<br>
<b>6.3.2. The BIND 8 host.conf File</b><br>
BIND Version 8 introduced a range of new features, and with these came a new configuration file syntax.<br>The&nbsp;named.boot, with its simple single line statements, was replaced by the&nbsp;named.conf&nbsp;file, with a<br>syntax like that of&nbsp;<b>gated</b>&nbsp;and resembling C source syntax.<br>
The new syntax is more complex, but fortunately a tool has been provided that automates conversion from<br>the old syntax to the new syntax. In the BIND 8 source package, a&nbsp;<b>perl</b>&nbsp;program called<br><b>named−bootconf.pl</b>&nbsp;is provided that will read your existing&nbsp;named.boot&nbsp;file from&nbsp;stdin&nbsp;and convert it<br>into the equivalent&nbsp;named.conf&nbsp;format on&nbsp;stdout. To use it, you must have the&nbsp;<b>perl</b>&nbsp;interpreter installed.<br>
You should use the script somewhat like this:<br>
#&nbsp;<b>cd /etc</b><br>
#&nbsp;<b>named−bootconf.pl &lt;named.boot &gt;named.conf</b><br>
The script then produces a&nbsp;named.conf&nbsp;that looks like that shown in&nbsp;<a href="TLNAGs.html#137">Example 6−9. We've cleaned out a</a><br>
6.3.2. The BIND 8 host.conf File<br>
120<br>
<hr>
<A name=137></a>Linux Network Administrators Guide<br>
few of the helpful comments the script includes to help show the almost direct relationship between the old<br>and the new syntax.<br>
<b>Example 6−9. The BIND 8 equivalent named.conf File for vlager</b><br>
//&nbsp;<br>
// /etc/named.boot file for vlager.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
options {<br>
&nbsp; &nbsp; &nbsp; &nbsp; directory &quot;/var/named&quot;;<br>
};<br>
zone &quot;.&quot; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; type hint;<br>
&nbsp; &nbsp; &nbsp; &nbsp; file &quot;named.ca&quot;;<br>
};<br>
zone &quot;vbrew.com&quot; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; type master;<br>
&nbsp; &nbsp; &nbsp; &nbsp; file &quot;named.hosts&quot;;<br>
};<br>
zone &quot;0.0.127.in−addr.arpa&quot; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; type master;<br>
&nbsp; &nbsp; &nbsp; &nbsp; file &quot;named.local&quot;;<br>
};<br>
zone &quot;16.172.in−addr.arpa&quot; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; type master;<br>
&nbsp; &nbsp; &nbsp; &nbsp; file &quot;named.rev&quot;;<br>
};<br>
If you take a close look, you will see that each of the one−line statements in&nbsp;named.boot&nbsp;has been<br>converted into a C−like statement enclosed within {} characters in the&nbsp;named.conf&nbsp;file.<br>
The comments, which in the&nbsp;named.boot&nbsp;file were indicated by a semicolon (;), are now indicated by two<br>forward slashes (//).<br>
The directory statement has been translated into an options paragraph with a directory clause.<br>
The cache and primary statements have been converted into zone paragraphs with type clauses of hint and<br>master, respectively.<br>
The zone files do not need to be modified in any way; their syntax remains unchanged.<br>
The new configuration syntax allows for many new options that we haven't covered here. If you'd like<br>information on the new options, the best source of information is the documentation supplied with the BIND<br>Version 8 source package.<br>
<b>6.3.3. The DNS Database Files</b><br>
Master files included with&nbsp;<b>named</b>, like&nbsp;<b>named.hosts</b>, always have a domain associated with them, which is<br>called the&nbsp;<i>origin</i>. This is the domain name specified with the cache and primary options. Within a master file,<br>you are allowed to specify domain and host names relative to this domain. A name given in a configuration<br>file is considered&nbsp;<i>absolute</i>&nbsp;if it ends in a single dot, otherwise it is considered relative to the origin. The origin<br>
6.3.3. The DNS Database Files<br>
121<br>
<hr>
<A name=138></a>Linux Network Administrators Guide<br>
by itself may be referred to using (@).<br>
&nbsp;The data contained in a master file is split up in&nbsp;<i>resource records</i>(RRs). RRs are the smallest units of<br>information available through DNS. Each resource record has a type. A records, for instance, map a hostname<br>to an IP address, and a CNAME record associates an alias for a host with its official hostname. To see an<br>example, look at&nbsp;<a href="TLNAGs.html#142">Example 6−11</a>, which shows the&nbsp;<b>named.hosts</b>&nbsp;master file for the Virtual Brewery.<br>
Resource record representations in master files share a common format:<br>
[<i>domain</i>] [<i>ttl</i>] [<i>class</i>]&nbsp;<i>type&nbsp;rdata</i><br>
Fields are separated by spaces or tabs. An entry may be continued across several lines if an opening brace<br>occurs before the first newline and the last field is followed by a closing brace. Anything between a<br>semicolon and a newline is ignored. A description of the format terms follows:<br>
<i>domain</i><br>
This term is the domain name to which the entry applies. If no domain name is given, the RR is<br>assumed to apply to the domain of the previous RR.<br>
<i>ttl</i><br>
In order to force resolvers to discard information after a certain time, each RR is associated a time<br>to live (<i>ttl</i>). The ttl field specifies the time in seconds that the information is valid after it has been<br>retrieved from the server. It is a decimal number with at most eight digits.<br>
If no ttl value is given, the field value defaults to that of the&nbsp;<i>minimum</i>&nbsp;field of the preceding SOA<br>record.<br>
<i>class</i><br>
This is an address class, like IN for IP addresses or HS for objects in the Hesiod class. For TCP/IP<br>networking, you have to specify IN.<br>
If no class field is given, the class of the preceding RR is assumed.<br>
<i>type</i><br>
This describes the type of the RR. The most common types are A, SOA, PTR, and NS. The following<br>sections describe the various types of RRs.<br>
<i>rdata</i><br>
This holds the data associated with the RR. The format of this field depends on the type of RR. In the<br>following discussion, it will be described for each RR separately.<br>
The following is partial list of RRs to be used in DNS master files. There are a couple more of them that we<br>will not explain; they are experimental and of little use, generally.<br>
<i>SOA</i><br>
6.3.3. The DNS Database Files<br>
122<br>
<hr>
<A name=139></a>Linux Network Administrators Guide<br>
&nbsp;This RR describes a zone of authority (SOA means Start of Authority). It signals that the<br>records following the SOA RR contain authoritative information for the domain. Every master file<br>included by a primary statement must contain an SOA record for this zone. The resource data<br>contains the following fields:<br>
<i>origin</i><br>
This field is the canonical hostname of the primary name server for this domain. It is usually given as<br>an absolute name.<br>
<i>contact</i><br>
This field is the email address of the person responsible for maintaining the domain, with the &quot;@&quot;<br>sign replaced by a dot. For instance, if the responsible person at the Virtual Brewery were janet, this<br>field would contain janet.vbrew.com.<br>
<i>serial</i><br>
This field is the version number of the zone file, expressed as a single decimal number. Whenever<br>data is changed in the zone file, this number should be incremented. A common convention is to use<br>a number that reflects the date of the last update, with a version number appended to it to cover the<br>case of multiple updates occurring on a single day, e.g., 2000012600 being update 00 that occurred<br>on January 26, 2000.<br>
The serial number is used by secondary name servers to recognize zone information changes. To stay<br>up to date, secondary servers request the primary server's SOA record at certain intervals and<br>compare the serial number to that of the cached SOA record. If the number has changed, the<br>secondary servers transfer the whole zone database from the primary server.<br>
<i>refresh</i><br>
This field specifies the interval in seconds that the secondary servers should wait between checking<br>the SOA record of the primary server. Again, this is a decimal number with at most eight digits.<br>
Generally, the network topology doesn't change too often, so this number should specify an interval<br>of roughly a day for larger networks, and even more for smaller ones.<br>
<i>retry</i><br>
This number determines the intervals at which a secondary server should retry contacting the primary<br>server if a request or a zone refresh fails. It must not be too low, or a temporary failure of the server<br>or a network problem could cause the secondary server to waste network resources. One hour, or<br>perhaps one−half hour, might be a good choice.<br>
<i>expire</i><br>
This field specifies the time in seconds after which a secondary server should finally discard all zone<br>data if it hasn't been able to contact the primary server. You should normally set this field to at least a<br>week (604,800 seconds), but increasing it to a month or more is also reasonable.<br>
<i>minimum</i><br>
6.3.3. The DNS Database Files<br>
123<br>
<hr>
<A name=140></a>Linux Network Administrators Guide<br>
This field is the default&nbsp;<i>ttl</i>&nbsp;value for resource records that do not explicitly contain one. The ttl value<br>specifies the maximum amount of time other name servers may keep the RR in their cache. This time<br>applies only to normal lookups, and has nothing to do with the time after which a secondary server<br>should try to update the zone information.<br>
If the topology of your network does not change frequently, a week or even more is probably a good<br>choice. If single RRs change more frequently, you could still assign them smaller ttls individually. If<br>your network changes frequently, you may want to set&nbsp;<i>minimum</i>&nbsp;to one day (86,400 seconds).<br>
<i>A</i><br>
&nbsp;This record associates an IP address with a hostname. The resource data field contains the address in dotted<br>quad notation.<br>
&nbsp;For each hostname, there must be only one A record. The hostname used in this A record is considered the<br>official or&nbsp;<i>canonical</i>&nbsp;hostname. All other hostnames are aliases and must be mapped onto the canonical<br>hostname using a CNAME record. If the canonical name of our host were&nbsp;<i>vlager</i>, we'd have an A record that<br>associated that hostname with its IP address. Since we may also want another name associated with that<br>address, say news, we'd create a CNAME record that associates this alternate name with the canonical name.<br>We'll talk more about CNAME records shortly.<br>
<i>NS</i><br>
NS records are used to specify a zone's primary server and all its secondary servers. An NS record points to a<br>master name server of the given zone, with the resource data field containing the hostname of the name server.<br>
You will meet NS records in two situations: The first situation is when you delegate authority to a<br>subordinate zone; the second is within the master zone database of the subordinate zone itself. The sets of<br>servers specified in both the parent and delegated zones should match.<br>
The NS record specifies the name of the primary and secondary name servers for a zone. These names must<br>be resolved to an address so they can be used. Sometimes the servers belong to the domain they are serving,<br>which causes a chicken and egg problem; we can't resolve the address until the name server is reachable,<br>but we can't reach the name server until we resolve its address. To solve this dilemma, we can configure<br>special A records directly into the name server of the parent zone. The A records allow the name servers of<br>the parent domain to resolve the IP address of the delegated zone name servers. These records are commonly<br>called&nbsp;<i>glue records</i>&nbsp;because they provide the glue that binds a delegated zone to its parent.<br>
<i>CNAME</i><br>
This record associates an alias with a host's&nbsp;<i>canonical hostname</i>. It provides an alternate name by which users<br>can refer to the host whose canonical name is supplied as a parameter. The canonical hostname is the one the<br>master file provides an A record for; aliases are simply linked to that name by a CNAME record, but don't<br>have any other records of their own.<br>
<i>PTR</i><br>
This type of record is used to associate names in the in−addr.arpa domain with hostnames. It is used for<br>reverse mapping of IP addresses to hostnames. The hostname given must be the canonical hostname.<br>
6.3.3. The DNS Database Files<br>
124<br>
<hr>
<A name=141></a>Linux Network Administrators Guide<br>
<i>MX</i><br>
This RR announces a&nbsp;<i>mail exchanger&nbsp;</i>&nbsp;for a domain. Mail exchangers are discussed in&nbsp;<a href="TLNAGs.html#356">Section 17.4.1</a>. The<br>syntax of an MX record is:<br>
[<i>domain</i>] [<i>ttl</i>] [<i>class</i>] MX&nbsp;<i>preference&nbsp;host</i><br>
<i>host</i>&nbsp;names the mail exchanger for&nbsp;<i>domain</i>. Every mail exchanger has an integer&nbsp;<i>preference</i>&nbsp;associated<br>with it. A mail transport agent that wants to deliver mail to&nbsp;<i>domain</i>&nbsp;tries all hosts who have an MX record<br>for this domain until it succeeds. The one with the lowest preference value is tried first, then the others, in<br>order of increasing preference value.<br>
<i>HINFO</i><br>
This record provides information on the system's hardware and software. Its syntax is:<br>
[<i>domain</i>] [<i>ttl</i>] [<i>class</i>] HINFO&nbsp;<i>hardware software</i><br>
The&nbsp;<i>hardware</i>&nbsp;field identifies the hardware used by this host. Special conventions are used to specify this.<br>A list of valid machine names is given in the Assigned Numbers RFC (RFC−1700). If the field contains<br>any blanks, it must be enclosed in double quotes. The&nbsp;<i>software</i>&nbsp;field names the operating system software<br>used by the system. Again, a valid name from the Assigned Numbers RFC should be chosen.<br>
An&nbsp;HINFO&nbsp;record to describe an Intel−based Linux machine should look something like:<br>
tao &nbsp; &nbsp; &nbsp;36500 &nbsp;IN &nbsp;HINFO &nbsp;IBM−PC &nbsp;LINUX2.2<br>
and&nbsp;HINFO&nbsp;records for Linux running on Motorola 68000−based machines might look like:<br>
cevad 36500 IN &nbsp;HINFO &nbsp;ATARI−104ST LINUX2.0<br>
jedd &nbsp;36500 IN &nbsp;HINFO &nbsp;AMIGA−3000 &nbsp;LINUX2.0<br>
<b>6.3.4. Caching−only named Configuration</b><br>
There is a special type of&nbsp;named&nbsp;configuration that we'll talk about before we explain how to build a full<br>name server configuration. It is called a&nbsp;<i>caching−only</i>&nbsp;configuration. It doesn't really serve a domain, but acts<br>as a relay for all DNS queries produced on your host. The advantage of this scheme is that it builds up a<br>cache so only the first query for a particular host is actually sent to the name servers on the Internet. Any<br>repeated request will be answered directly from the cache in your local name server. This may not seem<br><a href="TLNAGs.html#148">useful yet, but it will when you are dialing in to the Internet, as described in&nbsp;Chapter 7</a>&nbsp;and&nbsp;<a href="TLNAGs.html#162">Chapter 8.</a><br>
A&nbsp;named.boot&nbsp;file for a caching−only server looks like this:<br>
; named.boot file for caching−only server<br>
directory &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/named<br>
primary &nbsp; &nbsp; &nbsp; 0.0.127.in−addr.arpa &nbsp; named.local ; localhost network<br>
cache &nbsp; &nbsp; &nbsp; &nbsp; . &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;named.ca &nbsp; &nbsp;; root servers<br>
6.3.4. Caching−only named Configuration<br>
125<br>
<hr>
<A name=142></a>Linux Network Administrators Guide<br>
In addition to this&nbsp;named.boot&nbsp;file, you must set up the&nbsp;named.ca&nbsp;file with a valid list of root name<br>servers. You could copy and use&nbsp;<a href="TLNAGs.html#142">Example 6−10</a>&nbsp;for this purpose. No other files are needed for a caching−only<br>server configuration.<br>
<b>6.3.5. Writing the Master Files</b><br>
<a href="TLNAGs.html#142">Example 6−10,&nbsp;Example 6−11,&nbsp;</a><a href="TLNAGs.html#143">Example 6−12, and&nbsp;Example 6−13</a>&nbsp;give sample files for a name server at the<br>brewery, located on vlager. Due to the nature of the network discussed (a single LAN), the example is pretty<br>straightforward.<br>
&nbsp;The&nbsp;named.ca&nbsp;&nbsp;cache file shown in&nbsp;<a href="TLNAGs.html#142">Example 6−10</a>&nbsp;shows sample hint records for a root name server. A<br>typical cache file usually describes about a dozen name servers. You can obtain the current list of name<br>servers for the root domain using the&nbsp;<b>nslookup</b>&nbsp;tool described in the next section.[43]<br>
<b>Example 6−10. The named.ca File</b><br>
;<br>
; /var/named/named.ca &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Cache file for the brewery.<br>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;We're not on the Internet, so we don't need<br>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;any root servers. To activate these<br>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;records, remove the semicolons.<br>
;<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp;IN &nbsp;NS &nbsp; &nbsp;A.ROOT−SERVERS.NET.<br>
;A.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 198.41.0.4<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;B.ROOT−SERVERS.NET.<br>
;B.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 128.9.0.107<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;C.ROOT−SERVERS.NET.<br>
;C.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 192.33.4.12<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;D.ROOT−SERVERS.NET.<br>
;D.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 128.8.10.90<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;E.ROOT−SERVERS.NET.<br>
;E.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 192.203.230.10<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;F.ROOT−SERVERS.NET.<br>
;F.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 192.5.5.241<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;G.ROOT−SERVERS.NET.<br>
;G.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 192.112.36.4<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;H.ROOT−SERVERS.NET.<br>
;H.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 128.63.2.53<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;I.ROOT−SERVERS.NET.<br>
;I.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 192.36.148.17<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;J.ROOT−SERVERS.NET.<br>
;J.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 198.41.0.10<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;K.ROOT−SERVERS.NET.<br>
;K.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 193.0.14.129&nbsp;<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;L.ROOT−SERVERS.NET.<br>
;L.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 198.32.64.12<br>
;. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;NS &nbsp; &nbsp;M.ROOT−SERVERS.NET.<br>
;M.ROOT−SERVERS.NET. &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp; &nbsp;A &nbsp; &nbsp; 202.12.27.33<br>
;<br>
<b>Example 6−11. The named.hosts File</b><br>
;<br>
6.3.5. Writing the Master Files<br>
126<br>
<hr>
<A name=143></a>Linux Network Administrators Guide<br>
; /var/named/named.hosts &nbsp; &nbsp; &nbsp; Local hosts at the brewery<br>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Origin is vbrew.com<br>
;<br>
@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp;SOA &nbsp; vlager.vbrew.com. janet.vbrew.com. (<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2000012601 ; serial<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;86400 &nbsp; &nbsp; &nbsp;; refresh: once per day<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600 &nbsp; &nbsp; &nbsp; ; retry: &nbsp; one hour<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3600000 &nbsp; &nbsp;; expire: &nbsp;42 days<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;604800 &nbsp; &nbsp; ; minimum: 1 week<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp;NS &nbsp; &nbsp;vlager.vbrew.com.<br>
;<br>
; local mail is distributed on vlager<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp;MX &nbsp; &nbsp;10 vlager<br>
;<br>
; loopback address<br>
localhost. &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 127.0.0.1<br>
;<br>
; Virtual Brewery Ethernet<br>
vlager &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 172.16.1.1<br>
vlager−if1 &nbsp; &nbsp; &nbsp; IN &nbsp;CNAME vlager<br>
; vlager is also news server<br>
news &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;CNAME vlager<br>
vstout &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 172.16.1.2<br>
vale &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 172.16.1.3<br>
;<br>
; Virtual Winery Ethernet<br>
vlager−if2 &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 172.16.2.1<br>
vbardolino &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 172.16.2.2<br>
vchianti &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 172.16.2.3<br>
vbeaujolais &nbsp; &nbsp; &nbsp;IN &nbsp;A &nbsp; &nbsp; 172.16.2.4<br>
;<br>
; Virtual Spirits (subsidiary) Ethernet<br>
vbourbon &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;A &nbsp; &nbsp; 172.16.3.1<br>
vbourbon−if1 &nbsp; &nbsp; IN &nbsp;CNAME vbourbon<br>
<b>Example 6−12. The named.local File</b><br>
;<br>
; /var/named/named.local &nbsp; &nbsp; &nbsp; Reverse mapping of 127.0.0<br>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Origin is 0.0.127.in−addr.arpa.<br>
;<br>
@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;SOA &nbsp; vlager.vbrew.com. joe.vbrew.com. (<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; serial<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 360000 &nbsp; &nbsp; ; refresh: 100 hrs<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600 &nbsp; &nbsp; &nbsp; ; retry: &nbsp; one hour<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600000 &nbsp; &nbsp;; expire: &nbsp;42 days<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 360000 &nbsp; &nbsp; ; minimum: 100 hrs<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;NS &nbsp; &nbsp;vlager.vbrew.com.<br>
1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; localhost.<br>
<b>Example 6−13. The named.rev File</b><br>
;<br>
; /var/named/named.rev &nbsp; &nbsp; &nbsp; &nbsp; Reverse mapping of our IP addresses<br>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Origin is 16.172.in−addr.arpa.<br>
;<br>
6.3.5. Writing the Master Files<br>
127<br>
<hr>
<A name=144></a>Linux Network Administrators Guide<br>
@ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;SOA &nbsp; vlager.vbrew.com. joe.vbrew.com. (<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 16 &nbsp; &nbsp; &nbsp; &nbsp; ; serial<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 86400 &nbsp; &nbsp; &nbsp;; refresh: once per day<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600 &nbsp; &nbsp; &nbsp; ; retry: &nbsp; one hour<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3600000 &nbsp; &nbsp;; expire: &nbsp;42 days<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 604800 &nbsp; &nbsp; ; minimum: 1 week<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;NS &nbsp; &nbsp;vlager.vbrew.com.<br>
; brewery<br>
1.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; vlager.vbrew.com.<br>
2.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; vstout.vbrew.com.<br>
3.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; vale.vbrew.com.<br>
; winery<br>
1.2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; vlager−if2.vbrew.com.<br>
2.2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; vbardolino.vbrew.com.<br>
3.2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; vchianti.vbrew.com.<br>
4.2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IN &nbsp;PTR &nbsp; vbeaujolais.vbrew.com.<br>
<b>6.3.6. Verifying the Name Server Setup</b><br>
<b>nslookup</b>&nbsp;is a great tool for checking the operation of your name server setup. It can be used both<br>interactively with prompts and as a single command with immediate output. In the latter case, you simply<br>invoke it as:<br>
$&nbsp;<b>nslookup</b><br>
<i>hostname</i><br>
<b>nslookup</b>&nbsp;queries the name server specified in&nbsp;resolv.conf&nbsp;for&nbsp;<i>hostname</i>. (If this file names more than<br>one server,&nbsp;<b>nslookup</b>&nbsp;chooses one at random.)<br>
The interactive mode, however, is much more exciting. Besides looking up individual hosts, you may query<br>for any type of DNS record and transfer the entire zone information for a domain.<br>
When invoked without an argument,&nbsp;<b>nslookup</b>&nbsp;displays the name server it uses and enters interactive mode.<br>At the&nbsp;<b>&gt;</b>&nbsp;prompt, you may type any domain name you want to query. By default, it asks for class A records,<br>those containing the IP address relating to the domain name.<br>
You can look for record types by issuing:<br>
&gt;&nbsp;<b>set type=</b>type<br>
in which&nbsp;<i>type</i>&nbsp;is one of the resource record names described earlier, or ANY.<br>
You might have the following&nbsp;<b>nslookup</b>&nbsp;session:<br>
$&nbsp;<b>nslookup</b><br>
Default Server: &nbsp;tao.linux.org.au<br>
Address: &nbsp;203.41.101.121<br>
&gt;&nbsp;<b>metalab.unc.edu</b><br>
Server: &nbsp;tao.linux.org.au<br>
Address: &nbsp;203.41.101.121<br>
Name: &nbsp; &nbsp;metalab.unc.edu<br>
6.3.6. Verifying the Name Server Setup<br>
128<br>
<hr>
<A name=145></a>Linux Network Administrators Guide<br>
Address: &nbsp;152.2.254.81<br>
&gt;<br>
The output first displays the DNS server being queried, and then the result of the query.<br>
If you try to query for a name that has no IP address associated with it, but other records were found in the<br>DNS database,&nbsp;<b>nslookup</b>&nbsp;returns with an error message saying&nbsp;No type A records found.<br>However, you can make it query for records other than type A by issuing the&nbsp;<b>set type</b>&nbsp;command. To get the<br>SOA record of unc.edu, you would issue:<br>
&gt;&nbsp;<b>unc.edu</b><br>
Server: &nbsp;tao.linux.org.au<br>
Address: &nbsp;203.41.101.121<br>
*** No address (A) records available for unc.edu<br>
&gt;&nbsp;<b>set type=SOA</b><br>
&gt;&nbsp;<b>unc.edu</b><br>
Server: &nbsp;tao.linux.org.au<br>
Address: &nbsp;203.41.101.121<br>
unc.edu<br>
&nbsp; &nbsp; &nbsp; &nbsp; origin = ns.unc.edu<br>
&nbsp; &nbsp; &nbsp; &nbsp; mail addr = host−reg.ns.unc.edu<br>
&nbsp; &nbsp; &nbsp; &nbsp; serial = 1998111011<br>
&nbsp; &nbsp; &nbsp; &nbsp; refresh = 14400 (4H)<br>
&nbsp; &nbsp; &nbsp; &nbsp; retry &nbsp; = 3600 (1H)<br>
&nbsp; &nbsp; &nbsp; &nbsp; expire &nbsp;= 1209600 (2W)<br>
&nbsp; &nbsp; &nbsp; &nbsp; minimum ttl = 86400 (1D)<br>
unc.edu name server = ns2.unc.edu<br>
unc.edu name server = ncnoc.ncren.net<br>
unc.edu name server = ns.unc.edu<br>
ns2.unc.edu &nbsp; &nbsp; internet address = 152.2.253.100<br>
ncnoc.ncren.net internet address = 192.101.21.1<br>
ncnoc.ncren.net internet address = 128.109.193.1<br>
ns.unc.edu &nbsp; &nbsp; &nbsp;internet address = 152.2.21.1<br>
In a similar fashion, you can query for MX records:<br>
&gt;&nbsp;<b>set type=MX</b><br>
&gt;&nbsp;<b>unc.edu</b><br>
Server: &nbsp;tao.linux.org.au<br>
Address: &nbsp;203.41.101.121<br>
unc.edu preference = 0, mail exchanger = conga.oit.unc.edu<br>
unc.edu preference = 10, mail exchanger = imsety.oit.unc.edu<br>
unc.edu name server = ns.unc.edu<br>
unc.edu name server = ns2.unc.edu<br>
unc.edu name server = ncnoc.ncren.net<br>
conga.oit.unc.edu &nbsp; &nbsp; &nbsp; internet address = 152.2.22.21<br>
imsety.oit.unc.edu &nbsp; &nbsp; &nbsp;internet address = 152.2.21.99<br>
ns.unc.edu &nbsp; &nbsp; &nbsp;internet address = 152.2.21.1<br>
ns2.unc.edu &nbsp; &nbsp; internet address = 152.2.253.100<br>
ncnoc.ncren.net internet address = 192.101.21.1<br>
ncnoc.ncren.net internet address = 128.109.193.1<br>
Using a type of ANY returns all resource records associated with a given name.<br>
6.3.6. Verifying the Name Server Setup<br>
129<br>
<hr>
<A name=146></a>Linux Network Administrators Guide<br>
&nbsp;A practical application of&nbsp;<b>nslookup</b>, besides debugging, is to obtain the current list of root name servers.<br>You can obtain this list by querying for all NS records associated with the root domain:<br>
&gt;&nbsp;<b>set type=NS</b><br>
&gt;&nbsp;<b>.</b><br>
Server: &nbsp;tao.linux.org.au<br>
Address: &nbsp;203.41.101.121<br>
Non−authoritative answer:<br>
(root) &nbsp;name server = A.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = H.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = B.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = C.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = D.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = E.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = I.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = F.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = G.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = J.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = K.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = L.ROOT−SERVERS.NET<br>
(root) &nbsp;name server = M.ROOT−SERVERS.NET<br>
Authoritative answers can be found from:<br>
A.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 198.41.0.4<br>
H.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 128.63.2.53<br>
B.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 128.9.0.107<br>
C.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 192.33.4.12<br>
D.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 128.8.10.90<br>
E.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 192.203.230.10<br>
I.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 192.36.148.17<br>
F.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 192.5.5.241<br>
G.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 192.112.36.4<br>
J.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 198.41.0.10<br>
K.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 193.0.14.129<br>
L.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 198.32.64.12<br>
M.ROOT−SERVERS.NET &nbsp; &nbsp; &nbsp;internet address = 202.12.27.33<br>
To see the complete set of available commands, use the&nbsp;<b>help</b>&nbsp;command in&nbsp;<b>nslookup</b>.<br>
<b>6.3.7. Other Useful Tools</b><br>
There are a few tools that can help you with your tasks as a BIND administrator. We will briefly describe two<br>of them here. Please refer to the documentation that comes with these tools for more information on how to<br>use them.<br>
<b>hostcvt</b>&nbsp;helps you with your initial BIND configuration by converting your&nbsp;/etc/hosts&nbsp;file into master<br>files for&nbsp;<b>named</b>. It generates both the forward (A) and reverse mapping (PTR) entries, and takes care of<br>aliases. Of course, it won't do the whole job for you, as you may still want to tune the timeout values in the<br>SOA record, for example, or add MX records. Still, it may help you save a few aspirins.&nbsp;<b>hostcvt</b>&nbsp;is part of the<br>BIND source, but can also be found as a standalone package on a few Linux FTP servers.<br>
After setting up your name server, you may want to test your configuration. Some good tools that make this<br>job much simpler: the first is called&nbsp;<b>dnswalk</b>, which is a Perl−based package. The second is called&nbsp;<b>nslint</b>.<br>They both walk your DNS database looking for common mistakes and verify that the information they find is<br>
6.3.7. Other Useful Tools<br>
130<br>
<hr>
<A name=147></a>Linux Network Administrators Guide<br>
consistent. Two other useful tools are&nbsp;<b>host</b>&nbsp;and&nbsp;<b>dig</b>, which are general purpose DNS database query tools.<br>You can use these tools to manually inspect and diagnose DNS database entries.<br>
These tools are likely to be available in prepackaged form.&nbsp;<b>dnswalk</b>&nbsp;and&nbsp;<b>nslint</b>&nbsp;are available in source from<br>http://www.visi.com/~barr/dnswalk/ and ftp://ftp.ee.lbl.gov/nslint.tar.Z. The&nbsp;<b>host</b>&nbsp;and&nbsp;<b>dig</b>&nbsp;source codes can be<br>found at ftp://ftp.nikhef.nl/pub/network/ and ftp://ftp.is.co.za/networking/ip/dns/dig/.<br>
6.3.7. Other Useful Tools<br>
131<br>
<hr>
<A name=148></a><b>Chapter 7. Serial Line IP</b><br>
Packet protocols like IP or IPX rely upon the receiver host knowing where the start and end of each packet<br>are in the data stream. The mechanism used to mark and detect the start and end of packets is called<br><i>delimitation</i>. The Ethernet protocol manages this mechanism in a LAN environment, and the SLIP and PPP<br>protocols manage it for serial communications lines.<br>
The comparatively low cost of low−speed dialup modems and telephone circuits has made the serial line IP<br>protocols immensely popular, especially for providing connectivity to end users of the Internet. The hardware<br>required to run SLIP or PPP is simple and readily available. All that is required is a modem and a serial port<br>equipped with a FIFO buffer.<br>
The SLIP protocol is very simple to implement and at one time was the more common of the two. Today<br>almost everyone uses the PPP protocol instead. The PPP protocol adds a host of sophisticated features that<br>contribute to its popularity today, and we'll look at the most important of these later.<br>
Linux supports kernel−based drivers for both SLIP and PPP. The drivers have both been around for some<br>time and are stable and reliable. In this chapter and the next, we'll discuss both protocols and how to<br>configure them.<br>
Chapter 7. Serial Line IP<br>
132<br>
<hr>
<A name=149></a><b>7.1. General Requirements</b><br>
To use SLIP or PPP, you have to configure some basic networking features as described in the previous<br>chapters. You must set up the loopback interface and configure the name resolver. When connecting to the<br>Internet, you will want to use DNS. Your options here are the same as for PPP: you can perform your DNS<br>queries across your serial link by configuring your Internet Service Provider's IP address into your<br>/etc/resolv.conf&nbsp;file, or configure a caching−only name server as described under&nbsp;<a href="TLNAGs.html#141">Section 6.3.4</a>, in<br><a href="TLNAGs.html#120">Chapter 6</a>.&quot;<br>
7.1. General Requirements<br>
133<br>
<hr>
<A name=150></a><b>7.2. SLIP Operation</b><br>
Dialup IP servers frequently offer SLIP service through special user accounts. After logging in to such an<br>account, you are not dropped into the common shell; instead, a program or shell script is executed that<br>enables the server's SLIP driver for the serial line and configures the appropriate network interface. Then you<br>have to do the same at your end of the link.<br>
On some operating systems, the SLIP driver is a user−space program; under Linux, it is part of the kernel,<br>which makes it a lot faster. This speed requires, however, that the serial line be converted to the SLIP mode<br>explicitly. This conversion is done by means of a special tty line discipline, SLIPDISC. While the tty is in<br>normal line discipline (DISC0), it exchanges data only with user processes, using the normal&nbsp;read(2)&nbsp;and<br>write(2)&nbsp;calls, and the SLIP driver is unable to write to or read from the tty. In SLIPDISC, the roles are<br>reversed: now any user−space processes are blocked from writing to or reading from the tty, while all data<br>coming in on the serial port is passed directly to the SLIP driver.<br>
The SLIP driver itself understands a number of variations on the SLIP protocol. Apart from ordinary SLIP, it<br>also understands CSLIP, which performs the so−called Van Jacobson header compression (described in<br>RFC−1144) on outgoing IP packets. This compression improves throughput for interactive sessions<br>noticeably. There are also six−bit versions for each of these protocols.<br>
A simple way to convert a serial line to SLIP mode is by using the&nbsp;<b>slattach</b>&nbsp;tool. Assume you have your<br>modem on&nbsp;/dev/ttyS3&nbsp;and have logged in to the SLIP server successfully. You will then execute:<br>
#&nbsp;<b>slattach /dev/ttyS3 &amp;</b><br>
This tool switches the line discipline of&nbsp;ttyS3&nbsp;to&nbsp;SLIPDISC&nbsp;and attaches it to one of the SLIP network<br>interfaces. If this is your first active SLIP link, the line will be attached to&nbsp;sl0; the second will be attached<br>to&nbsp;sl1, and so on. The current kernels support a default maximum of 256 simultaneous SLIP links.<br>
The default line discipline chosen by&nbsp;<b>slattach</b>&nbsp;is CSLIP. You may choose any other discipline using the<br>−p&nbsp;switch. To use normal SLIP (no compression), you use:<br>
#&nbsp;<b>slattach −p slip /dev/ttyS3 &amp;</b><br>
<a href="TLNAGs.html#150">The disciplines available are listed in&nbsp;Table 7−1</a>. A special pseudo−discipline is available called&nbsp;adaptive,<br>which causes the kernel to automatically detect which type of SLIP encapsulation is being used by the remote<br>end.<br>
<b>Table 7−1. Linux Slip−Line Disciplines</b><br>
<b>Description</b><br>
Disclipline<br>
slip<br>
Traditional SLIP encapsulation.<br>
cslip<br>
SLIP encapsulation with Van Jacobsen header compression.<br>
slip6<br>
7.2. SLIP Operation<br>
134<br>
<hr>
<A name=151></a>Linux Network Administrators Guide<br>
SLIP encapsulation with six−bit encoding. The encoding method is similar to that used by the<br><b>uuencode</b>&nbsp;command, and causes the SLIP datagram to be converted into printable ASCII<br>characters. This conversion is useful when you do not have a serial link that is eight bit clean.<br>
cslip6<br>
SLIP encapsulation with Van Jacobsen header compression and six−bit encoding.<br>
adaptive<br>
This is not a real line discipline; instead, it causes the kernel to attempt to identify the line<br>discipline being used by the remote machine and to match it.<br>
Note that you must use the same encapsulation as your peer. For example, if cowslip uses CSLIP, you also<br>have to do so. If your SLIP connection doesn't work, the first thing you should do is ensure that both ends of<br>the link agree on whether to use header compression or not. If you are unsure what the remote end is using,<br>try configuring your host for adaptive slip. The kernel might figure out the right type for you.<br>
<b>slattach</b>&nbsp;lets you enable not only SLIP, but other protocols that use the serial line, like PPP or KISS (another<br>protocol used by ham radio people). Doing this is not common, though, and there are better tools available to<br>support these protocols. For details, please refer to the&nbsp;slattach(8)&nbsp;manual page.<br>
After turning over the line to the SLIP driver, you must configure the network interface. Again, you do this<br>using the standard&nbsp;<b>ifconfig</b>&nbsp;and&nbsp;<b>route</b>&nbsp;commands. Assume that we have dialed up a server named<br>cowslip from vlager. On&nbsp;<i>vlager</i>&nbsp;you would execute:<br>
#&nbsp;<b>ifconfig sl0 vlager−slip pointopoint cowslip</b><br>
#&nbsp;<b>route add cowslip</b><br>
#&nbsp;<b>route add default gw cowslip</b><br>
The first command configures the interface as a point−to−point link to cowslip, while the second and third<br>add the route to cowslip and the default route, using cowslip as a gateway.<br>
Two things are worth noting about the&nbsp;<b>ifconfig</b>&nbsp;invocation: The pointopoint option that specifies the address<br>of the remote end of a point−to−point link and our use of vlager−slip as the address of the local SLIP<br>interface.<br>
We have mentioned that you can use the same address you assigned to vlager's Ethernet interface for your<br>SLIP link, as well. In this case, vlager−slip might just be another alias for address 172.16.1.1. However, it is<br>also possible that you have to use an entirely different address for your SLIP link. One such case is when<br>your network uses an unregistered IP network address, as the Brewery does. We will return to this scenario in<br>greater detail in the next section.<br>
For the remainder of this chapter we will always use vlager−slip to refer to the address of the local SLIP<br>interface.<br>
When taking down the SLIP link, you should first remove all routes through cowslip using&nbsp;<b>route</b>&nbsp;with the<br>del&nbsp;option, then take the interface down, and send&nbsp;<b>slattach</b>&nbsp;the hangup signal. The you must hang up the<br>modem using your terminal program again:<br>
#&nbsp;<b>route del default</b><br>
#&nbsp;<b>route del cowslip</b><br>
#&nbsp;<b>ifconfig sl0 down</b><br>
#&nbsp;<b>kill −HUP&nbsp;<i>516</i></b><br>
7.2. SLIP Operation<br>
135<br>
<hr>
<A name=152></a>Linux Network Administrators Guide<br>
Note that the&nbsp;<i>516</i>&nbsp;should be replaced with the process id (as shown in the output of&nbsp;<b>ps ax</b>) of the<br><b>slattach</b>&nbsp;command controlling the slip device you wish to take down.<br>
7.2. SLIP Operation<br>
136<br>
<hr>
<A name=153></a><b>7.3. Dealing with Private IP Networks</b><br>
<a href="TLNAGs.html#97">You will remember from&nbsp;Chapter 5</a>, that the Virtual Brewery has an Ethernet−based IP network using<br>unregistered network numbers that are reserved for internal use only. Packets to or from one of these<br>networks are not routed on the Internet; if we were to have vlager dial into cowslip and act as a router for the<br>Virtual Brewery network, hosts within the Brewery's network could not talk to real Internet hosts directly<br>because their packets would be dropped silently by the first major router.<br>
To work around this dilemma, we will configure vlager to act as a kind of launch pad for accessing Internet<br>services. To the outside world, it will present itself as a normal SLIP−connected Internet host with a<br>registered IP address (probably assigned by the network provider running cowslip). Anyone logged in to<br>vlager can use text−based programs like&nbsp;<b>ftp</b>,&nbsp;<b>telnet</b>, or even&nbsp;<b>lynx</b>&nbsp;to make use of the Internet. Anyone on the<br>Virtual Brewery LAN can therefore telnet and log in to vlager and use the programs there. For some<br>applications, there may be solutions that avoid logging in to vlager. For WWW users, for example, we could<br>run a so−called&nbsp;<i>proxy server</i>&nbsp;on vlager, which would relay all requests from your users to their respective<br>servers.<br>
Having to log in to vlager to make use of the Internet is a little clumsy. But apart from eliminating the<br>paperwork (and cost) of registering an IP network, it has the added benefit of going along well with a firewall<br>setup. Firewalls are dedicated hosts used to provide limited Internet access to users on your local network<br>without exposing the internal hosts to network attacks from the outside world. Simple firewall configuration<br>is covered in more detail in&nbsp;<a href="TLNAGs.html#183">Chapter 9. In&nbsp;</a><a href="TLNAGs.html#243">Chapter 11, we'll discuss a Linux feature called IP masquerade<br></a>that provides a powerful alternative to proxy servers.<br>
Assume that the Brewery has been assigned the IP address 192.168.5.74 for SLIP access. All you have to do<br>to realize that the setup discussed above is to enter this address into your&nbsp;/etc/hosts&nbsp;file, naming it<br>vlager−slip. The procedure for bringing up the SLIP link itself remains unchanged.<br>
7.3. Dealing with Private IP Networks<br>
137<br>
<hr>
<A name=154></a><b>7.4. Using dip</b><br>
Now that was rather simple. Nevertheless, you might want to automate the steps previously described. It<br>would be much better to have a simple command that performs all the steps necessary to open the serial<br>device, cause the modem to dial the provider, log in, enable the SLIP line discipline, and configure the<br>network interface. This is what the&nbsp;<b>dip</b>&nbsp;command is for.<br>
<b>dip</b>&nbsp;means&nbsp;<i>Dialup IP</i>. It was written by Fred van Kempen and has been patched very heavily by a number of<br>people. Today there is one strain that is used by almost everyone: Version&nbsp;dip337p−uri, which is included<br>with most modern Linux distributions, or is available from the metalab.unc.edu FTP archive.<br>
<b>dip</b>&nbsp;provides an interpreter for a simple scripting language that can handle the modem for you, convert the<br>line to SLIP mode, and configure the interfaces. The script language is powerful enough to suit most<br>configurations.<br>
&nbsp;To be able to configure the SLIP interface,&nbsp;<b>dip</b>&nbsp;requires root privilege. It would now be tempting to make<br><b>dip</b>&nbsp;setuid to root so that all users can dial up some SLIP server without having to give them root access. This<br>is very dangerous, though, because setting up bogus interfaces and default routes with&nbsp;<b>dip</b>&nbsp;may disrupt<br>routing on your network. Even worse, this action would give your users power to connect to&nbsp;<i>any</i>&nbsp;SLIP server<br>and launch dangerous attacks on your network. If you want to allow your users to fire up a SLIP connection,<br>write small wrapper programs for each prospective SLIP server and have these wrappers invoke&nbsp;<b>dip</b>&nbsp;with the<br>specific script that establishes the connection. Carefully written wrapper programs can then safely be made<br>setuid to root.[44]&nbsp;An alternative, more flexible approach is to give trusted users root access to&nbsp;<b>dip</b>&nbsp;using a<br>program like&nbsp;<b>sudo</b>.<br>
<b>7.4.1. A Sample Script</b><br>
Assume that the host to which we make our SLIP connection is cowslip, and that we have written a script for<br><b>dip</b>&nbsp;to run called&nbsp;cowslip.dip&nbsp;that makes our connection. We invoke&nbsp;<b>dip</b>&nbsp;with the script name as<br>argument:<br>
#&nbsp;<b>dip cowslip.dip</b><br>
DIP: Dialup IP Protocol Driver version 3.3.7 (12/13/93)<br>
Written by Fred N. van Kempen, MicroWalt Corporation.<br>
connected to cowslip.moo.com with addr 192.168.5.74<br>
#<br>
The script itself is shown in&nbsp;<a href="TLNAGs.html#154">Example 7−1.</a><br>
<b>Example 7−1. A Sample dip Script</b><br>
# Sample dip script for dialing up cowslip<br>
# Set local and remote name and address<br>
&nbsp; &nbsp; &nbsp; &nbsp; get $local vlager−slip<br>
&nbsp; &nbsp; &nbsp; &nbsp; get $remote cowslip<br>
&nbsp; &nbsp; &nbsp; &nbsp; port ttyS3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# choose a serial port<br>
&nbsp; &nbsp; &nbsp; &nbsp; speed 38400 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# set speed to max<br>
&nbsp; &nbsp; &nbsp; &nbsp; modem HAYES &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# set modem type<br>
&nbsp; &nbsp; &nbsp; &nbsp; reset &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# reset modem and tty<br>
7.4. Using dip<br>
138<br>
<hr>
<A name=155></a>Linux Network Administrators Guide<br>
&nbsp; &nbsp; &nbsp; &nbsp; flush &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# flush out modem response<br>
# Prepare for dialing.<br>
&nbsp; &nbsp; &nbsp; &nbsp; send ATQ0V1E1X1\r<br>
&nbsp; &nbsp; &nbsp; &nbsp; wait OK 2<br>
&nbsp; &nbsp; &nbsp; &nbsp; if $errlvl != 0 goto error<br>
&nbsp; &nbsp; &nbsp; &nbsp; dial 41988<br>
&nbsp; &nbsp; &nbsp; &nbsp; if $errlvl != 0 goto error<br>
&nbsp; &nbsp; &nbsp; &nbsp; wait CONNECT 60<br>
&nbsp; &nbsp; &nbsp; &nbsp; if $errlvl != 0 goto error<br>
# Okay, we're connected now<br>
&nbsp; &nbsp; &nbsp; &nbsp; sleep 3<br>
&nbsp; &nbsp; &nbsp; &nbsp; send \r\n\r\n<br>
&nbsp; &nbsp; &nbsp; &nbsp; wait ogin: 10<br>
&nbsp; &nbsp; &nbsp; &nbsp; if $errlvl != 0 goto error<br>
&nbsp; &nbsp; &nbsp; &nbsp; send Svlager\n<br>
&nbsp; &nbsp; &nbsp; &nbsp; wait ssword: 5<br>
&nbsp; &nbsp; &nbsp; &nbsp; if $errlvl != 0 goto error<br>
&nbsp; &nbsp; &nbsp; &nbsp; send knockknock\n<br>
&nbsp; &nbsp; &nbsp; &nbsp; wait running 30<br>
&nbsp; &nbsp; &nbsp; &nbsp; if $errlvl != 0 goto error<br>
# We have logged in, and the remote side is firing up SLIP.<br>
&nbsp; &nbsp; &nbsp; &nbsp; print Connected to $remote with address $rmtip<br>
&nbsp; &nbsp; &nbsp; &nbsp; default &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Make this link our default route<br>
&nbsp; &nbsp; &nbsp; &nbsp; mode SLIP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# We go to SLIP mode, too<br>
# fall through in case of error<br>
error:<br>
&nbsp; &nbsp; &nbsp; &nbsp; print SLIP to $remote failed.<br>
After connecting to cowslip and enabling SLIP,&nbsp;<b>dip</b>&nbsp;will detach from the terminal and go to the background.<br>You can then start using the normal networking services on the SLIP link. To terminate the connection,<br>simply invoke&nbsp;<b>dip</b>&nbsp;with the&nbsp;−k&nbsp;option. This sends a hangup signal to&nbsp;<b>dip</b>, using the process ID&nbsp;<b>dip</b>&nbsp;records in<br>/etc/dip.pid:<br>
#&nbsp;<b>dip −k</b><br>
In&nbsp;<b>dip</b>'s scripting language, keywords prefixed with a dollar symbol denote variable names.&nbsp;<b>dip</b>&nbsp;has a<br>predefined set of variables, which will be listed below. $remote and $local, for instance, contain the<br>hostnames of the remote and local hosts involved in the SLIP link.<br>
The first two statements in the sample script are&nbsp;<b>get</b>&nbsp;commands, which is&nbsp;<b>dip</b>'s way to set a variable. Here, the<br>local and remote hostnames are set to vlager and cowslip, respectively.<br>
The next five statements set up the terminal line and the modem. reset sends a reset string to the modem.<br>The next statement flushes out the modem response so that the login chat in the next few lines works<br>properly. This chat is pretty straightforward: it simply dials 41988, the phone number of cowslip, and logs in<br>to the account Svlager using the password knockknock. The wait command makes&nbsp;<b>dip</b>&nbsp;wait for the string<br>given as its first argument; the number given as its second argument makes the wait time out after that many<br>seconds if no such string is received. The if commands interspersed in the login procedure check that no error<br>occurred while executing the command.<br>
The final commands executed after logging in are default, which makes the SLIP link the default route to all<br>hosts, and mode, which enables SLIP mode on the line and configures the interface and routing table for you.<br>
7.4. Using dip<br>
139<br>
<hr>
<A name=156></a>Linux Network Administrators Guide<br>
<b>7.4.2. A dip Reference</b><br>
In this section, we will give a reference for most of&nbsp;<b>dip</b>'s commands. You can get an overview of all the<br>commands it provides by invoking&nbsp;<b>dip</b>&nbsp;in test mode and entering the help command. To learn about the<br>syntax of a command, you may enter it without any arguments. Remember that this does not work with<br>commands that take no arguments. The following example illustrates the help command:<br>
#&nbsp;<b>dip −t</b><br>
DIP: Dialup IP Protocol Driver version 3.3.7p−uri (25 Dec 96)<br>
Written by Fred N. van Kempen, MicroWalt Corporation.<br>
Debian version 3.3.7p−2 (debian).<br>
DIP&gt;&nbsp;<b>help</b><br>
DIP knows about the following commands:<br>
&nbsp; &nbsp; &nbsp; &nbsp; beep &nbsp; &nbsp; &nbsp; &nbsp; bootp &nbsp; &nbsp; &nbsp; &nbsp;break &nbsp; &nbsp; &nbsp; &nbsp;chatkey &nbsp; &nbsp; &nbsp;config &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; databits &nbsp; &nbsp; dec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default &nbsp; &nbsp; &nbsp;dial &nbsp; &nbsp; &nbsp; &nbsp; echo &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; flush &nbsp; &nbsp; &nbsp; &nbsp;get &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;goto &nbsp; &nbsp; &nbsp; &nbsp; help &nbsp; &nbsp; &nbsp; &nbsp; if &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;init &nbsp; &nbsp; &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp; &nbsp; modem &nbsp; &nbsp; &nbsp; &nbsp;netmask &nbsp; &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; onexit &nbsp; &nbsp; &nbsp; parity &nbsp; &nbsp; &nbsp; password &nbsp; &nbsp; proxyarp &nbsp; &nbsp; print &nbsp; &nbsp; &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; psend &nbsp; &nbsp; &nbsp; &nbsp;port &nbsp; &nbsp; &nbsp; &nbsp; quit &nbsp; &nbsp; &nbsp; &nbsp; reset &nbsp; &nbsp; &nbsp; &nbsp;securidfixed&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; securid &nbsp; &nbsp; &nbsp;send &nbsp; &nbsp; &nbsp; &nbsp; shell &nbsp; &nbsp; &nbsp; &nbsp;skey &nbsp; &nbsp; &nbsp; &nbsp; sleep &nbsp; &nbsp; &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; speed &nbsp; &nbsp; &nbsp; &nbsp;stopbits &nbsp; &nbsp; term &nbsp; &nbsp; &nbsp; &nbsp; timeout &nbsp; &nbsp; &nbsp;wait &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
DIP&gt;&nbsp;<b>echo</b><br>
Usage: echo on|off<br>
DIP&gt;<br>
Throughout the following section, examples that display the&nbsp;<b>DIP&gt;</b>&nbsp;prompt show how to enter a command in<br>test mode and what output it produces. Examples lacking this prompt should be taken as script excerpts.<br>
<b>7.4.2.1. The modem commands</b><br>
<b>dip</b>&nbsp;provides a number of commands that configure your serial line and modem. Some of these are obvious,<br>such as port, which selects a serial port, and speed, databits, stopbits, and parity, which set the common line<br>parameters. The modem command selects a modem type. Currently, the only type supported is<br>HAYES (capitalization required). You have to provide&nbsp;<b>dip</b>&nbsp;with a modem type, or else it will refuse to<br>execute the dial and reset commands. The reset command sends a reset string to the modem; the string used<br>depends on the modem type selected. For Hayes−compatible modems, this string is ATZ.<br>
The flush code can be used to flush out all responses the modem has sent so far. Otherwise, a chat script<br>following reset might be confused because it reads the OK responses from earlier commands.<br>
The init command selects an initialization string to be passed to the modem before dialing. The default for<br>Hayes modems is ATE0 Q0 V1 X1, which turns on echoing of commands and long result codes, and<br>selects blind dialing (no checking of dial tone). Modern modems have a good factory default configuration,<br>so this is a little unnecessary, though it does no harm.<br>
The dial command sends the initialization string to the modem and dials up the remote system. The default<br>dial command for Hayes modems is ATD.<br>
7.4.2. A dip Reference<br>
140<br>
<hr>
<A name=157></a>Linux Network Administrators Guide<br>
<b>7.4.2.2. The echo command</b><br>
The echo command serves as a debugging aid. Calling echo on makes&nbsp;<b>dip</b>&nbsp;echo to the console everything it<br>sends to the serial device. This can be turned off again by calling echo off.<br>
<b>dip</b>&nbsp;also allows you to leave script mode temporarily and enter terminal mode. In this mode, you can use<br><b>dip</b>&nbsp;just like any ordinary terminal program, writing the characters you type to the serial line, reading data<br>from the serial line, and displaying the characters. To leave this mode, enter Ctrl−].<br>
<b>7.4.2.3. The get command</b><br>
The get command is&nbsp;<b>dip</b>'s way of setting a variable. The simplest form is to set a variable to a constant, as we<br>did in&nbsp;cowslip.dip. You may, however, also prompt the user for input by specifying the keyword<br>ask instead of a value:<br>
DIP&gt;&nbsp;<b>get $local ask</b><br>
Enter the value for $local: _<br>
A third method is to obtain the value from the remote host. Bizarre as it seems at first, this is very useful in<br>some cases. Some SLIP servers will not allow you to use your own IP address on the SLIP link, but will<br>rather assign you one from a pool of addresses whenever you dial in, printing some message that informs you<br>about the address you have been assigned. If the message looks something like&nbsp;Your address:<br>192.168.5.74, the following piece of&nbsp;<b>dip</b>&nbsp;code would let you pick up the address:<br>
# finish login<br>
wait address: 10<br>
get $locip remote<br>
<b>7.4.2.4. The print command</b><br>
This is the command used to echo text to the console from which&nbsp;<b>dip</b>&nbsp;was started. Any of&nbsp;<b>dip</b>'s variables may<br>be used in print commands. Here's an example:<br>
DIP&gt;&nbsp;<b>print Using port $port at speed $speed</b><br>
Using port ttyS3 at speed 38400<br>
<b>7.4.2.5. Variable names</b><br>
<b>dip</b>&nbsp;understands only a predefined set of variables. A variable name always begins with a dollar symbol and<br>must be written in lowercase letters.<br>
The $local and $locip variables contain the local host's name and IP address. When you store the canonical<br>hostname in $local,&nbsp;<b>dip</b>&nbsp;will automatically attempt to resolve the hostname to an IP address and to store it in<br>the $locip variable. A similar but backward process occurs when you assign an IP address to the<br>$locip variable;&nbsp;<b>dip</b>&nbsp;will attempt to perform a reverse lookup to identify the name of the host and store it in<br>the $local variable.<br>
7.4.2.2. The echo command<br>
141<br>
<hr>
<A name=158></a>Linux Network Administrators Guide<br>
The $remote and $rmtip variables operate in the same way for the remote host's name and address.<br>$mtu contains the MTU value for the connection.<br>
These five variables are the only ones that may be assigned values directly using the get command. A number<br>of other variables are set as a result of the configuration commands bearing the same name, but may be used<br>in print statements; these variables are $modem, $port, and $speed.<br>
$errlvl is the variable through which you can access the result of the last command executed. An error level<br>of 0 indicates success, while a nonzero value denotes an error.<br>
<b>7.4.2.6. The if and goto commands</b><br>
The if command is a conditional branch, rather than a full−featured programming&nbsp;<i>if</i>&nbsp;statement. Its syntax is:<br>
if&nbsp;<i>var&nbsp;op&nbsp;number</i>&nbsp;goto&nbsp;<i>label</i><br>
The expression must be a simple comparison between one of the variables $errlvl, $locip, and $rmtip.<br><i>var</i>&nbsp;must be an integer number; the operator&nbsp;<i>op</i>&nbsp;may be one of&nbsp;==,&nbsp;!=,&nbsp;&lt;,&nbsp;&gt;,&nbsp;&lt;=, and&nbsp;&gt;=.<br>
The goto command makes the execution of the script continue at the line following that bearing the&nbsp;<i>label</i>.<br>A label must be the first word on the line and must be followed immediately by a colon.<br>
<b>7.4.2.7. send, wait, and sleep</b><br>
These commands help implement simple chat scripts in&nbsp;<b>dip</b>. The send command outputs its arguments to the<br>serial line. It does not support variables, but understands all C−style backslash character sequences, such as<br>\n for newline and \b for backspace. The tilde character (~) can be used as an abbreviation for carriage<br>return/newline.<br>
The wait command takes a word as an argument and will read all input on the serial line until it detects a<br>sequence of characters that match this word. The word itself may not contain any blanks. Optionally, you<br>may give wait a timeout value as a second argument; if the expected word is not received within that many<br>seconds, the command will return with an $errlvl value of 1. This command is used to detect login and other<br>prompts.<br>
The sleep command may be used to wait for a certain amount of time; for instance, to patiently wait for any<br>login sequence to complete. Again, the interval is specified in seconds.<br>
<b>7.4.2.8. mode and default</b><br>
These commands are used to flip the serial line to SLIP mode and configure the interface.<br>
The mode command is the last command executed by&nbsp;<b>dip</b>&nbsp;before going into daemon mode. Unless an error<br>occurs, the command does not return.<br>
mode takes a protocol name as argument.&nbsp;<b>dip</b>&nbsp;currently recognizes SLIP, CSLIP, SLIP6, CSLIP6, PPP, and<br>TERM as valid names. The current version of&nbsp;<b>dip</b>&nbsp;does not understand adaptive SLIP, however.<br>
7.4.2.6. The if and goto commands<br>
142<br>
<hr>
<A name=159></a>Linux Network Administrators Guide<br>
After enabling SLIP mode on the serial line,&nbsp;<b>dip</b>&nbsp;executes&nbsp;<b>ifconfig</b>&nbsp;to configure the interface as a<br>point−to−point link, and invokes&nbsp;<b>route</b>&nbsp;to set the route to the remote host.<br>
If, in addition, the script executes the default command before mode,&nbsp;<b>dip</b>&nbsp;creates a default route that points to<br>the SLIP link.<br>
7.4.2.6. The if and goto commands<br>
143<br>
<hr>
<A name=160></a><b>7.5. Running in Server Mode</b><br>
Setting up your SLIP client was the hard part. Configuring your host to act as a SLIP server is much easier.<br>
There are two ways of configuring a SLIP server. Both ways require that you set up one login account per<br>SLIP client. Assume you provide SLIP service to Arthur Dent at dent.beta.com. You might create an account<br>named dent by adding the following line to your&nbsp;passwd&nbsp;file:<br>
dent:*:501:60:Arthur Dent's SLIP account:/tmp:/usr/sbin/diplogin<br>
Afterwards, you would set dent's password using the&nbsp;<b>passwd</b>&nbsp;utility.<br>
The&nbsp;<b>dip</b>&nbsp;command can be used in server mode by invoking it as&nbsp;<b>diplogin</b>. Usually&nbsp;<b>diplogin</b>&nbsp;is a link to&nbsp;<b>dip</b>.<br>Its main configuration file is&nbsp;/etc/diphosts, which is where you specify what IP address a SLIP user<br>will be assigned when he or she dials in. Alternatively, you can also use the&nbsp;<b>sliplogin</b>&nbsp;command, a<br>BSD−derived tool featuring a more flexible configuration scheme that lets you execute shell scripts whenever<br>a host connects and disconnects.<br>
When our SLIP user dent logs in,&nbsp;<b>dip</b>&nbsp;starts up as a server. To find out if he is indeed permitted to use SLIP,<br>it looks up the username in&nbsp;/etc/diphosts. This file details the access rights and connection parameter<br>for each SLIP user. The general format for an&nbsp;/etc/diphosts&nbsp;entry looks like:<br>
# /etc/diphosts<br>
<i>user</i>:<i>password</i>:<i>rem−addr</i>:<i>loc−addr</i>:<i>netmask</i>:<i>comments</i>:<i>protocol</i>,<i>MTU</i><br>
#<br>
<a href="TLNAGs.html#160">Each of the fields is described in&nbsp;Table 7−2</a>.<br>
<b>Table 7−2. /etc/diphosts Field Description</b><br>
<b>Field</b><br>
<b>Description</b><br>
user<br>
The username of the user invoking&nbsp;<b>dip</b>&nbsp;that this entry will apply to.<br>
password<br>
Field 2 of the&nbsp;/etc/diphosts&nbsp;file is used to add an extra layer of password−based security<br>on the connection. You can place a password in encrypted form here (just as in<br>/etc/passwd) and&nbsp;<b>diplogin</b>&nbsp;will prompt for the user to enter the password before allowing<br>SLIP access. Note that this password is used in addition to the normal&nbsp;<b>login</b>−based password<br>the user will enter.<br>
rem−addr<br>
The address that will be assigned to the remote machine. This address may be specified either<br>as a hostname that will be resolved or an IP address in dotted quad notation.<br>
loc−addr<br>
The IP address that will be used for this end of the SLIP link. This may also be specified as a<br>resolvable hostname or in dotted quad format.<br>
netmask<br>
The netmask that will be used for routing purposes. Many people are confused by this entry.<br>The netmask doesn't apply to the SLIP link itself, but is used in combination with the<br>
7.5. Running in Server Mode<br>
144<br>
<hr>
<A name=161></a>Linux Network Administrators Guide<br>
rem−addr&nbsp;field to produce a route to the remote site. The netmask should be that used by the<br>network supported by that of the remote host.<br>
comments<br>
This field is free−form text that you may use to help document the&nbsp;/etc/diphosts&nbsp;file. It<br>serves no other purpose.<br>
protocol<br>
This field is where you specify what protocol or line discipline you want applied to this<br>connection. Valid entries here are the same as those valid for the&nbsp;−p&nbsp;argument to the<br><b>slattach</b>&nbsp;command.<br>
MTU<br>
The maximum transmission unit that this link will carry. This field describes the largest<br>datagram that will be transmitted across the link. Any datagram routed to the SLIP device that<br>is larger than the MTU will be fragmented into datagrams no larger than this value. Usually, the<br>MTU is configured identically at both ends of the link.<br>
A sample entry for dent could look like this:<br>
dent::dent.beta.com:vbrew.com:255.255.255.0:Arthur Dent:CSLIP,296<br>
Our example gives our user dent access to SLIP with no additional password required. He will be assigned<br>the IP address associated with dent.beta.com with a netmask of&nbsp;255.255.255.0. His default route should<br>be directed to the IP address of vbrew.com, and he will use the CSLIP protocol with an MTU of 296 bytes.<br>
When dent logs in,&nbsp;<b>diplogin</b>&nbsp;extracts the information on him from the&nbsp;diphosts&nbsp;file. If the second field<br>contains a value,&nbsp;<b>diplogin</b>&nbsp;will prompt for an external security password. The string entered by the user is<br>encrypted and compared to the password from&nbsp;diphosts. If they do not match, the login attempt is<br>rejected. If the password field contains the string s/key, and&nbsp;<b>dip</b>&nbsp;was compiled with S/Key support, S/Key<br>authentication will take place. S/Key authentication is described in the documentation that comes in the<br><b>dip</b>&nbsp;source package.<br>
After a successful login,&nbsp;<b>diplogin</b>&nbsp;proceeds by flipping the serial line to CSLIP or SLIP mode, and sets up the<br>interface and route. This connection remains established until the user disconnects and the modem drops the<br>line.&nbsp;<b>diplogin</b>&nbsp;then returns the line to normal line discipline and exits.<br>
<b>diplogin</b>&nbsp;requires superuser privilege. If you don't have&nbsp;<b>dip</b>&nbsp;running setuid root, you should make<br>
<b>diplogin</b>&nbsp;a separate copy of&nbsp;<b>dip</b>&nbsp;instead of a simple link.&nbsp;<b>diplogin</b>&nbsp;can then safely be made setuid without<br>affecting the status of&nbsp;<b>dip</b>&nbsp;itself.&nbsp;<br>
7.5. Running in Server Mode<br>
145<br>
<hr>
<A name=162></a><b>Chapter 8. The Point−to−Point Protocol</b><br>
&nbsp;Like SLIP, PPP is a protocol used to send datagrams across a serial connection; however, it addresses a<br>couple of the deficiencies of SLIP. First, it can carry a large number of protocols and is thus not limited to the<br>IP protocol. It provides error detection on the link itself, while SLIP accepts and forwards corrupted<br>datagrams as long as the corruption does not occur in the header. Equally important, it lets the<br>communicating sides negotiate options, such as the IP address and the maximum datagram size at startup<br>time, and provides client authorization. This built−in negotiation allows reliable automation of the connection<br>establishment, while the authentication removes the need for the clumsy user login accounts that SLIP<br>requires. For each of these capabilities, PPP has a separate protocol. In this chapter, we briefly cover these<br>basic building blocks of PPP. This discussion of PPP is far from complete; if you want to know more about<br>PPP, we urge you to read its RFC specification and the dozen or so companion RFCs.[45]&nbsp;There is also a<br>comprehensive O'Reilly book on the topic of&nbsp;<i>Using &amp; Managing PPP</i>, by Andrew Sun.<br>
At the very bottom of PPP is the&nbsp;<i>High−Level Data Link Control</i>&nbsp;(HDLC) protocol, which defines the<br>boundaries around the individual PPP frames and provides a 16−bit checksum.[46]&nbsp;As opposed to the more<br>primitive SLIP encapsulation, a PPP frame is capable of holding packets from protocols other than IP, such<br>as Novell's IPX or Appletalk. PPP achieves this by adding a protocol field to the basic HDLC frame that<br>identifies the type of packet carried by the frame.<br>
The&nbsp;<i>Link Control Protocol</i>, (LCP) is used on top of HDLC to negotiate options pertaining to the data link.<br>For instance, the&nbsp;<i>Maximum Receive Unit</i>&nbsp;(MRU), states the maximum datagram size that one side of the link<br>agrees to receive.<br>
&nbsp;An important step at the configuration stage of a PPP link is client authorization. Although it is not<br>mandatory, it is really a must for dialup lines in order to keep out intruders. Usually the called host (the<br>server) asks the client to authorize itself by proving it knows some secret key. If the caller fails to produce the<br>correct secret, the connection is terminated. With PPP, authorization works both ways; the caller may also ask<br>the server to authenticate itself. These authentication procedures are totally independent of each other. There<br>are two protocols for different types of authorization, which we will discuss further in this chapter:&nbsp;<i>Password<br>Authentication Protocol</i>&nbsp;(PAP) and&nbsp;<i>Challenge Handshake Authentication Protocol</i>&nbsp;(CHAP).<br>
&nbsp;Each network protocol that is routed across the data link (like IP and AppleTalk) is configured dynamically<br>using a corresponding&nbsp;<i>Network Control Protocol</i>&nbsp;(NCP). To send IP datagrams across the link, both sides<br>running PPP must first negotiate which IP address each of them uses. The control protocol used for this<br>negotiation is the&nbsp;<i>Internet Protocol Control Protocol</i>&nbsp;(IPCP).<br>
&nbsp;Besides sending standard IP datagrams across the link, PPP also supports Van Jacobson header<br>compression of IP datagrams. This technique shrinks the headers of TCP packets to as little as three bytes. It<br>is also used in CSLIP, and is more colloquially referred to as VJ header compression. The use of compression<br>may be negotiated at startup time through IPCP, as well.<br>
Chapter 8. The Point−to−Point Protocol<br>
146<br>
<hr>
<A name=163></a><b>8.1. PPP on Linux</b><br>
On Linux, PPP functionality is split into two parts: a kernel component that handles the low−level protocols<br>(HDLC, IPCP, IPXCP, etc.) and the user space&nbsp;<b>pppd</b>&nbsp;daemon that handles the various higher−level protocols,<br>such as PAP and CHAP. The current release of the PPP software for Linux contains the PPP daemon<br><b>pppd</b>&nbsp;and a program named&nbsp;<b>chat</b>&nbsp;that automates the dialing of the remote system.<br>
The PPP kernel driver was written by Michael Callahan and reworked by Paul Mackerras.&nbsp;<b>pppd</b>&nbsp;was derived<br>from a free PPP implementation[47]&nbsp;for Sun and 386BSD machines that was written by Drew Perkins and<br>others, and is maintained by Paul Mackerras. It was ported to Linux by Al Longyear.&nbsp;<b>chat</b>&nbsp;was written by<br>Karl Fox.[48]<br>
&nbsp;Like SLIP, PPP is implemented by a special line discipline. To use a serial line as a PPP link, you first<br>establish the connection over your modem as usual, and subsequently convert the line to PPP mode. In this<br>mode, all incoming data is passed to the PPP driver, which checks the incoming HDLC frames for validity<br>(each HDLC frame carries a 16−bit checksum), and unwraps and dispatches them. Currently, PPP is able to<br>transport both the IP protocol, optionally using Van Jacobson header compression, and the IPX protocol.<br>
<b>pppd</b>&nbsp;aids the kernel driver, performing the initialization and authentication phase that is necessary before<br>
actual network traffic can be sent across the link.&nbsp;<b>pppd</b>'s behavior may be fine−tuned using a number of<br>options. As PPP is rather complex, it is impossible to explain all of them in a single chapter. This book<br>therefore cannot cover all aspects of&nbsp;<b>pppd</b>, but only gives you an introduction. For more information, consult<br><i>Using &amp; Managing PPP</i>&nbsp;or the&nbsp;<b>pppd</b>&nbsp;manual pages, and&nbsp;READMEs in the&nbsp;<b>pppd</b>&nbsp;source distribution, which<br>should help you sort out most questions this chapter fails to discuss. The PPP−HOWTO might also be of use.<br>
Probably the greatest help you will find in configuring PPP will come from other users of the same Linux<br>distribution. PPP configuration questions are very common, so try your local usergroup mailing list or the<br>IRC Linux channel. If your problems persist even after reading the documentation, you could try the<br>comp.protocols.ppp newsgroup. This is the place where you can find most of the people involved in<br><b>pppd</b>&nbsp;development.<br>
8.1. PPP on Linux<br>
147<br>
<hr>
<A name=164></a><b>8.2. Running pppd</b><br>
&nbsp;When you want to connect to the Internet through a PPP link, you have to set up basic networking<br>capabilities, such as the loopback device and the resolver. Both have been covered in&nbsp;<a href="TLNAGs.html#97">Chapter 5</a><a href="TLNAGs.html#120">, and&nbsp;Chapter<br>6. You can simply configure the name server of your Internet Service Provider in the<br></a>/etc/resolv.conf&nbsp;file, but this will mean that every DNS request is sent across your serial link. This<br>situation is not optimal; the closer (network−wise) you are to your name server, the faster the name lookups<br>will be. An alternative solution is to configure a caching−only name server at a host on your network. This<br>means that the first time you make a DNS query for a particular host, your request will be sent across your<br>serial link, but every subsequent request will be answered directly by your local name server, and will be<br>much faster. This configuration is described in Chapter 6, in&nbsp;<a href="TLNAGs.html#141">Section 6.3.4</a>.<br>
As an introductory example of how to establish a PPP connection with&nbsp;<b>pppd</b>, assume you are at vlager again.<br>First, dial in to the PPP server c3po and log in to the ppp account. c3po will execute its PPP driver. After<br>exiting the communications program you used for dialing, execute the following command, substituting the<br>name of the serial device you used for the&nbsp;ttyS3&nbsp;shown here:<br>
#&nbsp;<b>pppd /dev/ttyS3 38400 crtscts defaultroute</b><br>
&nbsp;This command flips the serial line&nbsp;ttyS3&nbsp;to the PPP line discipline and negotiates an IP link with c3po.<br>The transfer speed used on the serial port will be 38,400 bps. The crtscts option turns on hardware handshake<br>on the port, which is an absolute must at speeds above 9,600 bps.<br>
The first thing&nbsp;<b>pppd</b>&nbsp;does after starting up is negotiate several link characteristics with the remote end using<br>LCP. Usually, the default set of options&nbsp;<b>pppd</b>&nbsp;tries to negotiate will work, so we won't go into this here.<br>Expect to say that part of this negotiation involves requesting or assigning the IP addresses at each end of the<br>link.<br>
For the time being, we also assume that c3po doesn't require any authentication from us, so the configuration<br>phase is completed successfully.<br>
<b>pppd</b>&nbsp;will then negotiate the IP parameters with its peer using IPCP, the IP control protocol. Since we<br>
didn't specify any particular IP address to&nbsp;<b>pppd</b>&nbsp;earlier, it will try to use the address obtained by having the<br>resolver look up the local hostname. Both will then announce their addresses to each other.<br>
Usually, there's nothing wrong with these defaults. Even if your machine is on an Ethernet, you can use the<br>same IP address for both the Ethernet and the PPP interface. Nevertheless,&nbsp;<b>pppd</b>&nbsp;allows you to use a different<br>address, or even to ask your peer to use some specific address. These options are discussed later in the<br><a href="TLNAGs.html#168">Section 8.5&nbsp;section.</a><br>
&nbsp;After going through the IPCP setup phase,&nbsp;<b>pppd</b>&nbsp;will prepare your host's networking layer to use the PPP<br>link. It first configures the PPP network interface as a point−to−point link, using&nbsp;ppp0&nbsp;for the first PPP link<br>that is active,&nbsp;<b>ppp1</b>&nbsp;for the second, and so on. Next, it sets up a routing table entry that points to the host at<br>the other end of the link. In the previous example,&nbsp;<b>pppd</b>&nbsp;made the default network route point to c3po,<br>because we gave it the defaultroute option.[49]&nbsp;The default route simplifies your routing by causing any IP<br>datagram destined to a nonlocal host to be sent to c3po; this makes sense since it is the only way they can be<br>reached. There are a number of different routing schemes&nbsp;<b>pppd</b>&nbsp;supports, which we will cover in detail later<br>in this chapter.<br>
8.2. Running pppd<br>
148<br>
<hr>
<A name=165></a><b>8.3. Using Options Files</b><br>
Before&nbsp;<b>pppd</b>&nbsp;parses its command−line arguments, it scans several files for default options. These files may<br>contain any valid command−line arguments spread out across an arbitrary number of lines. Hash signs<br>introduce comments.<br>
The first options file is&nbsp;/etc/ppp/options, which is always scanned when&nbsp;<b>pppd</b>&nbsp;starts up. Using it to set<br>some global defaults is a good idea, because it allows you to keep your users from doing several things that<br>may compromise security. For instance, to make&nbsp;<b>pppd</b>&nbsp;require some kind of authentication (either PAP or<br>CHAP) from the peer, you add the&nbsp;auth&nbsp;option to this file. This option cannot be overridden by the user, so<br>it becomes impossible to establish a PPP connection with any system that is not in your authentication<br>databases. Note, however, that some options can be overridden; the connect string is a good example.<br>
The other options file, which is read after&nbsp;/etc/ppp/options, is&nbsp;.ppprc&nbsp;in the user's home directory.<br>It allows each user to specify her own set of default options.<br>
A sample&nbsp;/etc/ppp/options&nbsp;file might look like this:<br>
# Global options for pppd running on vlager.vbrew.com<br>
lock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # use UUCP−style device locking<br>
auth &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # require authentication<br>
usehostname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# use local hostname for CHAP<br>
domain vbrew.com &nbsp; &nbsp; # our domain name<br>
&nbsp;The lock keyword makes&nbsp;<b>pppd</b>&nbsp;comply to the standard UUCP method of device locking. With this<br>convention, each process that accesses a serial device, say&nbsp;/dev/ttyS3, creates a lock file with a name like<br>LCK..ttyS3&nbsp;in a special lock−file directory to signal that the device is in use. This is necessary to prevent<br>signal other programs, such as&nbsp;<b>minicom</b>&nbsp;or&nbsp;<b>uucico</b>, from opening the serial device while it is used by PPP.<br>
The next three options relate to authentication and, therefore, to system security. The authentication options<br>are best placed in the global configuration file because they are privileged and cannot be overridden by<br>users'&nbsp;~/.ppprc&nbsp;options files.<br>
8.3. Using Options Files<br>
149<br>
<hr>
<A name=166></a><b>8.4. Using chat to Automate Dialing</b><br>
&nbsp;One of the things that may have struck you as inconvenient in the previous example is that you had to<br>establish the connection manually before you could fire up&nbsp;<b>pppd</b>. Unlike&nbsp;<b>dip</b>,&nbsp;<b>pppd</b>&nbsp;does not have its own<br>scripting language for dialing the remote system and logging in, but relies on an external program or shell<br>script to do this. The command to be executed can be given to&nbsp;<b>pppd</b>&nbsp;with the connect command−line option.<br><b>pppd</b>&nbsp;will redirect the command's standard input and output to the serial line.<br>
The&nbsp;<b>pppd</b>&nbsp;software package is supplied with a very simple program called&nbsp;<b>chat</b>, which is capable of being<br>used in this way to automate simple login sequences. We'll talk about this command in some detail.<br>
&nbsp;If your login sequence is complex, you will need something more powerful than&nbsp;<b>chat</b>. One useful<br>alternative you might consider is&nbsp;<b>expect</b>, written by Don Libes. It has a very powerful language based on Tcl,<br>and was designed exactly for this sort of application. Those of you whose login sequence requires, for<br>example, challenge/response authentication involving calculator−like key generators will find<br><b>expect</b>&nbsp;powerful enough to handle the task. Since there are so many possible variations on this theme, we<br>won't describe how to develop an appropriate expect script in this book. Suffice it to say, you'd call your<br>expect script by specifying its name using the&nbsp;<b>pppd</b>&nbsp;connect option. It's also important to note that when the<br>script is running, the standard input and output will be attached to the modem, not to the terminal that<br>invoked&nbsp;<b>pppd</b>. If you require user interaction, you should manage it by opening a spare virtual terminal, or<br>arrange some other means.<br>
&nbsp;The&nbsp;<b>chat</b>&nbsp;command lets you specify a UUCP−style chat script. Basically, a chat script consists of an<br>alternating sequence of strings that we expect to receive from the remote system, and the answers we are to<br>send. We will call them&nbsp;<i>expect</i>&nbsp;and&nbsp;<i>send</i>&nbsp;strings, respectively. This is a typical excerpt from a chat script:<br>
ogin: b1ff ssword: s3|&lt;r1t<br>
This script tells&nbsp;<b>chat</b>&nbsp;to wait for the remote system to send the login prompt and return the login name b1ff.<br>We wait only for ogin: so that it doesn't matter if the login prompt starts with an uppercase or lowercase l, or<br>if it arrives garbled. The following string is another expect string that makes&nbsp;<b>chat</b>&nbsp;wait for the password<br>prompt and send our response password.<br>
This is basically what chat scripts are all about. A complete script to dial up a PPP server would, of course,<br>also have to include the appropriate modem commands. Assume that your modem understands the Hayes<br>command set, and the server's telephone number is 318714. The complete&nbsp;<b>chat</b>&nbsp;invocation to establish a<br>connection with c3po would then be:<br>
$&nbsp;<b>chat −v '' ATZ OK ATDT318714 CONNECT '' ogin: ppp word: GaGariN</b><br>
By definition, the first string must be an expect string, but as the modem won't say anything before we have<br>kicked it, we make&nbsp;<b>chat</b>&nbsp;skip the first expect by specifying an empty string. We then send ATZ, the reset<br>command for Hayes−compatible modems, and wait for its response (OK). The next string sends the<br><b>dial</b>&nbsp;command along with the phone number to&nbsp;<b>chat</b>, and expects the CONNECT message in response. This<br>is followed by an empty string again because we don't want to send anything now, but rather wait for the<br>login prompt. The remainder of the chat script works exactly as described previously. This description<br>probably looks a bit confusing, but we'll see in a moment that there is a way to make chat scripts a lot easier<br>to understand.<br>
The&nbsp;−v&nbsp;option makes&nbsp;<b>chat</b>&nbsp;log all activities to the&nbsp;<b>syslog</b>&nbsp;daemon local2 facility.[50]<br>
8.4. Using chat to Automate Dialing<br>
150<br>
<hr>
<A name=167></a>Linux Network Administrators Guide<br>
Specifying the chat script on the command line bears a certain risk because users can view a process's<br>command line with the&nbsp;<b>ps</b>&nbsp;command. You can avoid this risk by putting the chat script in a file like<br>dial−c3po. You make&nbsp;<b>chat</b>&nbsp;read the script from the file instead of the command line by giving it the<br>−f&nbsp;option, followed by the filename. This action has the added benefit of making our chat expect sequences<br>easier to understand. To convert our example, our&nbsp;dial−c3po&nbsp;file would look like:<br>
'' &nbsp; &nbsp; &nbsp;ATZ<br>
OK &nbsp; &nbsp; &nbsp;ATDT318714<br>
CONNECT ''<br>
ogin: &nbsp; ppp<br>
word: &nbsp; GaGariN<br>
When we use a chat script file in this way, the string we expect to receive is on the left and the response we<br>will send is on the right. They are much easier to read and understand when presented this way.<br>
The complete&nbsp;<b>pppd</b>&nbsp;incantation would now look like this:<br>
#&nbsp;<b>pppd connect &quot;chat −f dial−c3po&quot; /dev/ttyS3 38400 −detach \</b><br>
<b>&nbsp; &nbsp; &nbsp; &nbsp; crtscts modem defaultroute</b><br>
Besides the connect option that specifies the dialup script, we have added two more options to the command<br>line: −detach, which tells&nbsp;<b>pppd</b>&nbsp;not to detach from the console and become a background process, and the<br>modem keyword, which makes it perform modem−specific actions on the serial device, like disconnecting<br>the line before and after the call. If you don't use this keyword,&nbsp;<b>pppd</b>&nbsp;will not monitor the port's DCD line<br>and will therefore not detect whether the remote end hangs up unexpectedly.<br>
The examples we have shown are rather simple;&nbsp;<b>chat</b>&nbsp;allows for much more complex scripts. For instance, it<br>can specify strings on which to abort the chat with an error. Typical abort strings are messages like BUSY or<br>NO CARRIER that your modem usually generates when the called number is busy or doesn't answer. To<br>make&nbsp;<b>chat</b>&nbsp;recognize these messages immediately rather than timing out, you can specify them at the<br>beginning of the script using the ABORT keyword:<br>
$&nbsp;<b>chat −v ABORT BUSY ABORT 'NO CARRIER' '' ATZ OK ...</b><br>
Similarly, you can change the timeout value for parts of the chat scripts by inserting TIMEOUT options.<br>
Sometimes you also need to have conditional execution for parts of the chat script: when you don't receive<br>the remote end's login prompt, you might want to send a BREAK or a carriage return. You can achieve this<br>by appending a subscript to an expect string. The subscript consists of a sequence of send and expect strings,<br>just like the overall script itself, which are separated by hyphens. The subscript is executed whenever the<br>expected string it is appended to is not received in time. In the example above, we would modify the chat<br>script as follows:<br>
ogin:−BREAK−ogin: ppp ssword: GaGariN<br>
When&nbsp;<b>chat</b>&nbsp;doesn't see the remote system send the login prompt, the subscript is executed by first sending a<br>BREAK, and then waiting for the login prompt again. If the prompt now appears, the script continues as<br>usual; otherwise, it will terminate with an error.&nbsp;<br>
8.4. Using chat to Automate Dialing<br>
151<br>
<hr>
<A name=168></a><b>8.5. IP Configuration Options</b><br>
IPCP is used to negotiate a number of IP parameters at link configuration time. Usually, each peer sends an<br>IPCP Configuration Request packet, indicating which values it wants to change from the defaults and the new<br>value. Upon receipt, the remote end inspects each option in turn and either acknowledges or rejects it.<br>
<b>pppd</b>&nbsp;gives you a lot of control over which IPCP options it will try to negotiate. You can tune it through<br>various command−line options that we will discuss in this section.<br>
<b>8.5.1. Choosing IP Addresses</b><br>
&nbsp;All IP interfaces require IP addresses assigned to them; a PPP device always has an IP address. The PPP<br>suite of protocols provides a mechanism that allows the automatic assignment of IP addresses to PPP<br>interfaces. It is possible for the PPP program at one end of a point−to−point link to assign an IP address for<br>the remote end to use, or each may use its own.<br>
Some PPP servers that handle a lot of client sites assign addresses dynamically; addresses are assigned to<br>systems only when calling in and are reclaimed after they have logged off again. This allows the number of<br>IP addresses required to be limited to the number of dialup lines. While limitation is convenient for managers<br>of the PPP dialup server, it is often less convenient for users who are dialing in. We discussed the way that<br><a href="TLNAGs.html#120">hostnames are mapped to IP addresses by use of a database in&nbsp;Chapter 6</a>. In order for people to connect to<br>your host, they must know your IP address or the hostname associated with it. If you are a user of a PPP<br>service that assigns you an IP address dynamically, this knowledge is difficult without providing some means<br>of allowing the DNS database to be updated after you are assigned an IP address. Such systems do exist, but<br>we won't cover them in detail here; instead, we will look at the more preferable approach, which involves you<br>being able to use the same IP address each time you establish your network connection.[51]<br>
In the previous example, we had&nbsp;<b>pppd</b>&nbsp;dial up c3po and establish an IP link. No provisions were taken to<br>choose a particular IP address on either end of the link. Instead, we let&nbsp;<b>pppd</b>&nbsp;take its default action. It<br>attempts to resolve the local hostname, vlager in our example, to an IP address, which it uses for the local<br>end, while letting the remote machine, c3po, provide its own. PPP supports several alternatives to this<br>arrangement.<br>
To ask for particular addresses, you generally provide&nbsp;<b>pppd</b>&nbsp;with the following option:<br>
<i>local_addr</i>:<i>remote_addr</i><br>
<i>local_addr</i>&nbsp;and&nbsp;<i>remote_addr</i>&nbsp;may be specified either in dotted quad notation or as<br>hostnames.[52]&nbsp;This option makes&nbsp;<b>pppd</b>&nbsp;attempt to use the first address supplied as its own IP address, and<br>the second as the peer's. If the peer rejects either of the addresses during IPCP negotiation, no IP link will be<br>established.[53]<br>
If you are dialing in to a server and expect it to assign you an IP address, you should ensure that&nbsp;<b>pppd</b>&nbsp;does<br>not attempt to negotiate one for itself. To do this, use the&nbsp;noipdefault&nbsp;option and leave the<br><i>local_addr</i>&nbsp;blank. The&nbsp;noipdefault&nbsp;option will stop&nbsp;<b>pppd</b>&nbsp;from trying to use the IP address<br>associated with the hostname as the local address.<br>
If you want to set only the local address but accept any address the peer uses, simply leave out the<br>
8.5. IP Configuration Options<br>
152<br>
<hr>
<A name=169></a>Linux Network Administrators Guide<br>
<i>remote_addr</i>&nbsp;part. To make vlager use the IP address 130.83.4.27 instead of its own, give it<br>130.83.4.27:&nbsp;on the command line. Similarly, to set the remote address only, leave the<br><i>local_addr</i>&nbsp;field blank. By default,&nbsp;<b>pppd</b>&nbsp;will then use the address associated with your hostname.<br>
<b>8.5.2. Routing Through a PPP Link</b><br>
&nbsp;After setting up the network interface,&nbsp;<b>pppd</b>&nbsp;will usually set up a host route to its peer only. If the remote<br>host is on a LAN, you certainly want to be able to connect to hosts behind your peer as well; in that case, a<br>network route must be set up.<br>
We have already seen that&nbsp;<b>pppd</b>&nbsp;can be asked to set the default route using the&nbsp;defaultroute&nbsp;option. This<br>option is very useful if the PPP server you dialed up acts as your Internet gateway.<br>
&nbsp;The reverse case, in which your system acts as a gateway for a single host, is also relatively easy to<br>accomplish. For example, take some employee at the Virtual Brewery whose home machine is called<br>oneshot. Let's also assume that we've configured vlager as a dialin PPP server. If we've configured vlager to<br>dynamically assign an IP address that belongs to the Brewery's subnet, then we can use the<br>proxyarp&nbsp;option with&nbsp;<b>pppd</b>, which will install a proxy ARP entry for oneshot. This automatically makes<br>oneshot accessible from all hosts at the Brewery and the Winery.<br>
However, things aren't always that simple. Linking two local area networks usually requires adding a<br>specific network route because these networks may have their own default routes. Besides, having both peers<br>use the PPP link as the default route would generate a loop, through which packets to unknown destinations<br>would ping−pong between the peers until their time to live expired.<br>
Suppose the Virtual Brewery opens a branch in another city. The subsidiary runs an Ethernet of its own using<br>the IP network number 172.16.3.0, which is subnet 3 of the Brewery's class B network. The subsidiary wants<br>to connect to the Brewery's network via PPP to update customer databases. Again, vlager acts as the gateway<br>for the brewery network and will support the PPP link; its peer at the new branch is called vbourbon and has<br>an IP address of 172.16.3.1. This network is illustrated in&nbsp;<a href="TLNAGs.html#487">Figure A−2&nbsp;in&nbsp;Appendix A</a>.<br>
When vbourbon connects to vlager, it makes the default route point to vlager as usual. On vlager, however,<br>we will have only the point−to−point route to vbourbon and will have to specially configure a network route<br>for subnet 3 that uses vbourbon as its gateway. We could do this manually using the&nbsp;<b>route</b>&nbsp;command by hand<br>after the PPP link is established, but this is not a very practical solution. Fortunately, we can configure the<br>route automatically by using a feature of&nbsp;<b>pppd</b>&nbsp;that we haven't discussed yetthe&nbsp;<b>ip−up</b>&nbsp;command. This<br>command is a shell script or program located in&nbsp;/etc/ppp&nbsp;that is executed by&nbsp;<b>pppd</b>&nbsp;after the PPP interface<br>has been configured. When present, it is invoked with the following parameters:<br>
ip−up&nbsp;<i>iface&nbsp;device&nbsp;speed&nbsp;local_addr&nbsp;remote_addr</i><br>
The following table summarizes the meaning of each of the arguments (in the first column, we show the<br>number used by the shell script to refer to each argument):<br>
<b>Argument&nbsp;Name</b><br>
<b>Purpose</b><br>
$1<br>
<i>iface</i><br>
The network interface used, e.g.,&nbsp;ppp0<br>
8.5.2. Routing Through a PPP Link<br>
153<br>
<hr>
<A name=170></a>Linux Network Administrators Guide<br>
$2<br>
<i>device</i><br>
The pathname of the serial device file used (/dev/tty, if stdin/stdout are<br>used)<br>
$3<br>
<i>speed</i><br>
The speed of the serial device in bits per second<br>
$4<br>
<i>local_addr</i><br>
The IP address of the link's remote end in dotted quad notation<br>
$5<br>
<i>remote_addr</i><br>
The IP address of the remote end of the link in dotted quad notation<br>
In our case, the&nbsp;<b>ip−up</b>&nbsp;script may contain the following code fragment:[54]<br>
#!/bin/sh<br>
case $5 in<br>
172.16.3.1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# this is vbourbon<br>
&nbsp; &nbsp; &nbsp; &nbsp; route add −net 172.16.3.0 gw 172.16.3.1;;<br>
...<br>
esac<br>
exit 0<br>
Similarly,&nbsp;<b>/etc/ppp/ip−down</b>&nbsp;can be used to undo any actions of&nbsp;<b>ip−up</b>&nbsp;after the PPP link has been taken<br>down again. So in our&nbsp;<b>/etc/ppp/ip−down</b>&nbsp;script we would have a&nbsp;<b>route</b>&nbsp;command that removed the route we<br>created in the&nbsp;<b>/etc/ppp/ip−up</b>&nbsp;script.<br>
&nbsp;However, the routing scheme is not yet complete. We have set up routing table entries on both PPP hosts,<br>but so far none of the hosts on either network knows anything about the PPP link. This is not a big problem if<br>all hosts at the subsidiary have their default route pointing at vbourbon, and all Brewery hosts route to<br>vlager by default. If this is not the case, your only option is usually to use a routing daemon like&nbsp;<b>gated</b>. After<br>creating the network route on vlager, the routing daemon broadcasts the new route to all hosts on the attached<br>subnets.<br>
8.5.2. Routing Through a PPP Link<br>
154<br>
<hr>
<A name=171></a><b>8.6. Link Control Options</b><br>
We already encountered the Link Control Protocol (LCP), which is used to negotiate link characteristics and<br>test the link.<br>
The two most important options negotiated by LCP are the&nbsp;<i>Asynchronous Control Character Map</i>&nbsp;and the<br><i>Maximum Receive Unit</i>. There are a number of other LCP configuration options, but they are far too<br>specialized to discuss here.<br>
&nbsp;The Asynchronous Control Character Map, colloquially called the&nbsp;<i>async map</i>, is used on asynchronous<br>links, such as telephone lines, to identify control characters that must be escaped (replaced by a specific<br>two−character sequence) to avoid them being interpreted by equipment used to establish the link. For<br>instance, you may want to avoid the XON and XOFF characters used for software handshake because a<br>misconfigured modem might choke upon receipt of an XOFF. Other candidates include Ctrl−l (the<br><b>telnet</b>&nbsp;escape character). PPP allows you to escape any of the characters with ASCII codes 0 through 31 by<br>specifying them in the async map.<br>
The async map is a 32−bit−wide bitmap expressed in hexadecimal. The least significant bit corresponds to<br>the ASCII NULL character, and the most significant bit corresponds to ASCII 31 decimal. These 32 ASCII<br>characters are the control characters. If a bit is set in the bitmap, it signals that the corresponding character<br>must be escaped before it is transmitted across the link.<br>
To tell your peer that it doesn't have to escape all control characters, but only a few of them, you can specify<br>an async map to&nbsp;<b>pppd</b>&nbsp;using the&nbsp;asyncmap&nbsp;option. For example, if only&nbsp;^S&nbsp;and&nbsp;^Q&nbsp;(ASCII 17 and 19,<br>commonly used for XON and XOFF) must be escaped, use the following option:<br>
asyncmap 0x000A0000<br>
The conversion is simple as long as you can convert binary to hex. Lay out 32 bits in front of you. The<br>right−most bit corresponds to ASCII 00 (NULL), and the left−most bit corresponds to ASCII 32 decimal. Set<br>the bits corresponding to the characters you want escaped to one, and all others to zero. To convert that into<br>the hexadecimal number&nbsp;<b>pppd</b>&nbsp;expects, simply take each set of 4 bits and convert them into hex. You should<br>end up with eight hexadecimal figures. String them all together and preprend àx to signify it is a<br>hexadecimal number, and you are done.<br>
Initially, the async map is set to&nbsp;0xffffffffthat is, all control characters will be escaped. This is a safe<br>default, but is usually much more than you need. Each character that appears in the async map results in two<br>characters being transmitted across the link, so escaping comes at the cost of increased link utilization and a<br>corresponding performance reduction.<br>
In most circumstances, an async map of&nbsp;0x0&nbsp;works fine. No escaping is performed.<br>
&nbsp;The Maximum Receive Unit (MRU), signals to the peer the maximum size of HDLC frames we want to<br>receive. Although this may remind you of the Maximum Transfer Unit (MTU) value, these two have little in<br>common. The MTU is a parameter of the kernel networking device and describes the maximum frame size<br>the interface is able to transmit. The MRU is more of an advice to the remote end not to generate frames<br>larger than the MRU; the interface must nevertheless be able to receive frames of up to 1,500 bytes.<br>
Choosing an MRU is therefore not so much a question of what the link is capable of transferring, but of<br>what gives you the best throughput. If you intend to run interactive applications over the link, setting the<br>
8.6. Link Control Options<br>
155<br>
<hr>
<A name=172></a>Linux Network Administrators Guide<br>
MRU to values as low as 296 is a good idea, so that an occasional larger packet (say, from an FTP session)<br>doesn't make your cursor jump. To tell&nbsp;<b>pppd</b>&nbsp;to request an MRU of 296, you give it the option&nbsp;mru 296.<br>Small MRUs, however, make sense only if you have VJ header compression (it is enabled by default),<br>because otherwise you'd waste a large amount of your bandwidth just carrying the IP header for each<br>datagram.<br>
<b>pppd</b>&nbsp;also understands a couple of LCP options that configure the overall behavior of the negotiation process,<br>such as the maximum number of configuration requests that may be exchanged before the link is terminated.<br>Unless you know exactly what you are doing, you should leave these options alone.<br>
&nbsp;Finally, there are two options that apply to LCP echo messages. PPP defines two messages,&nbsp;<i>Echo<br>Request</i>&nbsp;and&nbsp;<i>Echo Response</i>.&nbsp;<b>pppd</b>&nbsp;uses this feature to check if a link is still operating. You can enable this by<br>using the&nbsp;lcp−echo−interval&nbsp;option together with a time in seconds. If no frames are received from the<br>remote host within this interval,&nbsp;<b>pppd</b>&nbsp;generates an Echo Request and expects the peer to return an Echo<br>Response. If the peer does not produce a response, the link is terminated after a certain number of requests<br>are sent. This number can be set using the&nbsp;lcp−echo−failure&nbsp;option. By default, this feature is disabled<br>altogether.&nbsp;<br>
8.6. Link Control Options<br>
156<br>
<hr>
<A name=173></a><b>8.7. General Security Considerations</b><br>
&nbsp;A misconfigured PPP daemon can be a devastating security breach. It can be as bad as letting anyone plug<br>their machine into your Ethernet (and that can be very bad). In this section, we discuss a few measures that<br>should make your PPP configuration safe.<br>
<b>Note:&nbsp;</b>Root privilege is required to configure the network device and routing table. You will<br>usually solve this by running&nbsp;<b>pppd</b>&nbsp;setuid root. However,&nbsp;<b>pppd</b>&nbsp;allows users to set various<br>security−relevant options.<br>
To protect against any attacks a user may launch by manipulating&nbsp;<b>pppd</b>&nbsp;options, you should set a couple of<br>default values in the global&nbsp;/etc/ppp/options<a href="TLNAGs.html#165">&nbsp;file, like those shown in the sample file in&nbsp;Section 8.3,<br></a>earlier in this chapter. Some of them, such as the authentication options, cannot be overridden by the user,<br>and thus provide reasonable protection against manipulations. An important option to protect is the<br>connect option. If you intend to allow non−root users to invoke&nbsp;<b>pppd</b>&nbsp;to connect to the Internet, you should<br>always add the&nbsp;connect&nbsp;and&nbsp;noauth&nbsp;options to the global options file&nbsp;/etc/ppp/options. If you fail<br>to do this, users will be able to execute arbitrary commands with&nbsp;root&nbsp;privileges by specifying the command<br>as their connect command on the&nbsp;<b>pppd</b>&nbsp;line or in their personal options file.<br>
Another good idea is to restrict which users may execute&nbsp;<b>pppd</b>&nbsp;by creating a group in&nbsp;/etc/group&nbsp;and<br>adding only those users who you wish to have the ability to execute the PPP daemon. You should then<br>change group ownership of the&nbsp;<b>pppd</b>&nbsp;daemon to that group and remove the world execute privileges. To do<br>this, assuming you've called your group dialout, you could use something like:<br>
#&nbsp;<b>chown root /usr/sbin/pppd</b><br>
#&nbsp;<b>chgrp dialout /usr/sbin/pppd</b><br>
#&nbsp;<b>chmod 4750 /usr/sbin/pppd</b><br>
Of course, you have to protect yourself from the systems you speak PPP with, too. To fend off hosts posing<br>as someone else, you should always require some sort of authentication from your peer. Additionally, you<br>should not allow foreign hosts to use any IP address they choose, but restrict them to at most a few. The<br>following section will deal with these topics in detail.<br>
8.7. General Security Considerations<br>
157<br>
<hr>
<A name=174></a><b>8.8. Authentication with PPP</b><br>
&nbsp;With PPP, each system may require its peer to authenticate itself using one of two authentication protocols:<br>the&nbsp;<i>Password Authentication Protocol</i>&nbsp;(PAP), and the&nbsp;<i>Challenge Handshake Authentication<br>Protocol</i>&nbsp;(CHAP). When a connection is established, each end can request the other to authenticate itself,<br>regardless of whether it is the caller or the callee. In the description that follows, we will loosely talk of<br>client and server when we want to distinguish between the system sending authentication requests and<br>the system responding to them. A PPP daemon can ask its peer for authentication by sending yet another LCP<br>configuration request identifying the desired authentication protocol.<br>
<b>8.8.1. PAP Versus CHAP</b><br>
PAP, which is offered by many Internet Service Providers, works basically the same way as the normal login<br>procedure. The client authenticates itself by sending a username and a (optionally encrypted) password to the<br>server, which the server compares to its secrets database.[55]&nbsp;This technique is vulnerable to eavesdroppers,<br>who may try to obtain the password by listening in on the serial line, and to repeated trial and error attacks.<br>
CHAP does not have these deficiencies. With CHAP, the server sends a randomly generated challenge<br>string to the client, along with its hostname. The client uses the hostname to look up the appropriate secret,<br>combines it with the challenge, and encrypts the string using a one−way hashing function. The result is<br>returned to the server along with the client's hostname. The server now performs the same computation, and<br>acknowledges the client if it arrives at the same result.<br>
CHAP also doesn't require the client to authenticate itself only at startup time, but sends challenges at regular<br>intervals to make sure the client hasn't been replaced by an intruder, for instance by switching phone lines, or<br>because of a modem configuration error that causes the PPP daemon not to notice that the original phone call<br>has dropped out and someone else has dialed in.<br>
<b>pppd</b>&nbsp;keeps the secret keys for PAP and CHAP in two separate files called&nbsp;/etc/ppp/pap−secrets&nbsp;and<br>/etc/ppp/chap−secrets. By entering a remote host in one or the other file, you have fine control over<br>whether PAP or CHAP is used to authenticate yourself with your peer, and vice versa.<br>
By default,&nbsp;<b>pppd</b>&nbsp;doesn't require authentication from the remote host, but it will agree to authenticate itself<br>when requested by the remote host. Since CHAP is so much stronger than PAP,&nbsp;<b>pppd</b>&nbsp;tries to use the former<br>whenever possible. If the peer does not support it, or if&nbsp;<b>pppd</b>&nbsp;can't find a CHAP secret for the remote system<br>in its&nbsp;chap−secrets&nbsp;file, it reverts to PAP. If it doesn't have a PAP secret for its peer either, it refuses to<br>authenticate altogether. As a consequence, the connection is shut down.<br>
You can modify this behavior in several ways. When given the&nbsp;auth&nbsp;keyword,&nbsp;<b>pppd</b>&nbsp;requires the peer to<br>authenticate itself.&nbsp;<b>pppd</b>&nbsp;agrees to use either CHAP or PAP as long as it has a secret for the peer in its CHAP<br>or PAP database. There are other options to turn a particular authentication protocol on or off, but I won't<br>describe them here.<br>
If all systems you talk to with PPP agree to authenticate themselves with you, you should put the<br>auth&nbsp;option in the global&nbsp;/etc/ppp/options&nbsp;file and define passwords for each system in the<br>chap−secrets&nbsp;file. If a system doesn't support CHAP, add an entry for it to the&nbsp;pap−secrets&nbsp;file. That<br>way, you can make sure no unauthenticated system connects to your host.<br>
8.8. Authentication with PPP<br>
158<br>
<hr>
<A name=175></a>Linux Network Administrators Guide<br>
The next two sections discuss the two PPP secrets files,&nbsp;pap−secrets&nbsp;and&nbsp;chap−secrets. They are<br>located in&nbsp;/etc/ppp&nbsp;and contain triplets of clients, servers, and passwords, optionally followed by a list of<br>IP addresses. The interpretation of the client and server fields is different for CHAP and PAP, and also<br>depends on whether we authenticate ourselves with the peer, or whether we require the server to authenticate<br>itself with us.<br>
<b>8.8.2. The CHAP Secrets File</b><br>
&nbsp;When it has to authenticate itself with a server using CHAP,&nbsp;<b>pppd</b>&nbsp;searches the&nbsp;chap−secrets&nbsp;file for<br>an entry with the client field equal to the local hostname, and the server field equal to the remote hostname<br>sent in the CHAP challenge. When requiring the peer to authenticate itself, the roles are simply reversed:<br><b>pppd</b>&nbsp;then looks for an entry with the client field equal to the remote hostname (sent in the client's CHAP<br>response), and the server field equal to the local hostname.<br>
The following is a sample&nbsp;chap−secrets&nbsp;file for vlager:[56]<br>
# CHAP secrets for vlager.vbrew.com<br>
#<br>
# client &nbsp; &nbsp; &nbsp; &nbsp; server &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; secret &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;addrs<br>
#−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−<br>
vlager.vbrew.com &nbsp;c3po.lucas.com &nbsp; &quot;Use The Source Luke&quot; vlager.vbrew.com<br>
c3po.lucas.com &nbsp; &nbsp;vlager.vbrew.com &quot;arttoo! arttoo!&quot; &nbsp; &nbsp; c3po.lucas.com<br>
* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vlager.vbrew.com &quot;TuXdrinksVicBitter&quot; &nbsp;pub.vbrew.com<br>
When vlager establishes a PPP connection with c3po, c3po asks vlager to authenticate itself by sending a<br>CHAP challenge.&nbsp;<b>pppd</b>&nbsp;on vlager then scans&nbsp;chap−secrets&nbsp;for an entry with the client field equal to<br>vlager.vbrew.com and the server field equal to c3po.lucas.com, and finds the first line shown in the<br>example.[57]&nbsp;It then produces the CHAP response from the challenge string and the secret (Use The<br>Source Luke), and sends it off to c3po.<br>
<b>pppd</b>&nbsp;also composes a CHAP challenge for c3po containing a unique challenge string and its fully qualified<br>hostname, vlager.vbrew.com. c3po constructs a CHAP response in the way we discussed, and returns it to<br>vlager.&nbsp;<b>pppd</b>&nbsp;then extracts the client hostname (c3po.vbrew.com) from the response and searches the<br>chap−secrets&nbsp;file for a line matching c3po as a client and vlager as the server. The second line does this,<br>so&nbsp;<b>pppd</b>&nbsp;combines the CHAP challenge and the secret&nbsp;arttoo! arttoo!, encrypts them, and compares<br>the result to c3po's CHAP response.<br>
&nbsp;The optional fourth field lists the IP addresses that are acceptable for the client named in the first field. The<br>addresses can be given in dotted quad notation or as hostnames that are looked up with the resolver. For<br>instance, if c3po asks to use an IP address during IPCP negotiation that is not in this list, the request is<br>rejected, and IPCP is shut down. In the sample file shown above, c3po is therefore limited to using its own IP<br>address. If the address field is empty, any addresses are allowed; a value of&nbsp;−&nbsp;prevents the use of IP with<br>that client altogether.<br>
The third line of the sample&nbsp;chap−secrets&nbsp;file allows any host to establish a PPP link with vlager because<br>a client or server field of&nbsp;*&nbsp;is a wildcard matching any hostname. The only requirements are that the<br>connecting host must know the secret and that it must use the IP address associated with pub.vbrew.com.<br>Entries with wildcard hostnames may appear anywhere in the secrets file, since&nbsp;<b>pppd</b>&nbsp;will always use the best<br>match it can find for the server/client pair.<br>
8.8.2. The CHAP Secrets File<br>
159<br>
<hr>
<A name=176></a>Linux Network Administrators Guide<br>
<b>pppd</b>&nbsp;may need some help forming hostnames. As explained before, the remote hostname is always provided<br>by the peer in the CHAP challenge or response packet. The local hostname is obtained by calling the<br>gethostname(2)&nbsp;function by default. If you have set the system name to your unqualified hostname, you<br>also have to provide&nbsp;<b>pppd</b>&nbsp;with the domain name using the&nbsp;domain&nbsp;option:<br>
#&nbsp;<b>pppd &amp; domain vbrew.com</b><br>
This provision appends the Brewery's domain name to vlager for all authentication related activities. Other<br>options that modify&nbsp;<b>pppd</b>'s idea of the local hostname are&nbsp;usehostname&nbsp;and&nbsp;name. When you give the<br>local IP address on the command line using&nbsp;<i><b>local</b></i><b>:<i>remote</i></b>&nbsp;and&nbsp;<i>local</i>&nbsp;as a name instead of a dotted quad,<br><b>pppd</b>&nbsp;uses this as the local hostname.<br>
<b>8.8.3. The PAP Secrets File</b><br>
&nbsp;The PAP secrets file is very similar to CHAP's. The first two fields always contain a username and a server<br>name; the third holds the PAP secret. When the remote host sends its authentication information,&nbsp;<b>pppd</b>&nbsp;uses<br>the entry that has a server field equal to the local hostname, and a user field equal to the username sent in the<br>request. When it is necessary for us to send our credentials to the peer,&nbsp;<b>pppd</b>&nbsp;uses the secret that has a user<br>field equal to the local username and the server field equal to the remote hostname.<br>
A sample PAP secrets file might look like this:<br>
# /etc/ppp/pap−secrets<br>
#<br>
# user &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;server &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;secret &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;addrs<br>
vlager−pap &nbsp; &nbsp; &nbsp;c3po &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cresspahl &nbsp; &nbsp; &nbsp; vlager.vbrew.com<br>
c3po &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vlager &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DonaldGNUth &nbsp; &nbsp; c3po.lucas.com<br>
The first line is used to authenticate ourselves when talking to c3po. The second line describes how a user<br>named c3po has to authenticate itself with us.<br>
The name vlager−pap in the first column is the username we send to c3po. By default,&nbsp;<b>pppd</b>&nbsp;picks the local<br>hostname as the username, but you can also specify a different name by giving the&nbsp;user&nbsp;option followed by<br>that name.<br>
When picking an entry from the&nbsp;pap−secrets&nbsp;file to identify us to a remote host,&nbsp;<b>pppd</b>&nbsp;must know the<br>remote host's name. As it has no way of finding that out, you must specify it on the command line using the<br>remotename&nbsp;keyword followed by the peer's hostname. To use the above entry for authentication with<br>c3po, for example, we must add the following option to&nbsp;<b>pppd</b>'s command line:<br>
#&nbsp;<b>pppd ... remotename c3po user vlager−pap</b><br>
In the fourth field of the PAP secrets file (and all following fields), you can specify what IP addresses are<br>allowed for that particular host, just as in the CHAP secrets file. The peer will be allowed to request only<br>addresses from that list. In the sample file, the entry that c3po will use when it dials inthe line where c3po is<br>the clientallows it to use its real IP address and no other.<br>
Note that PAP is a rather weak authentication method, you should use CHAP instead whenever possible. We<br>will therefore not cover PAP in greater detail here; if you are interested in using it, you will find more PAP<br>features in the&nbsp;pppd(8)&nbsp;manual page.&nbsp;<br>
8.8.3. The PAP Secrets File<br>
160<br>
<hr>
<A name=177></a>Linux Network Administrators Guide<br>
8.8.3. The PAP Secrets File<br>
161<br>
<hr>
<A name=178></a><b>8.9. Debugging Your PPP Setup</b><br>
&nbsp;By default,&nbsp;<b>pppd</b>&nbsp;logs any warnings and error messages to&nbsp;<b>syslog</b>'s daemon facility. You have to add an<br>entry to&nbsp;syslog.conf&nbsp;that redirects these messages to a file or even the console; otherwise,&nbsp;<b>syslog</b>&nbsp;simply<br>discards them. The following entry sends all messages to&nbsp;/var/log/ppp−log:<br>
daemon.* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/log/ppp−log<br>
If your PPP setup doesn't work right away, you should look in this log file. If the log messages don't help,<br>you can also turn on extra debugging output using the&nbsp;debug&nbsp;option. This output makes&nbsp;<b>pppd</b>&nbsp;log the<br>contents of all control packets sent or received to&nbsp;<b>syslog</b>. All messages then go to the daemon facility.<br>
Finally, the most drastic way to check a problem is to enable kernel−level debugging by invoking&nbsp;<b>pppd</b>&nbsp;with<br>the&nbsp;kdebug&nbsp;option. It is followed by a numeric argument that is the sum of the following values: 1 for<br>general debug messages, 2 for printing the contents of all incoming HDLC frames, and 4 to make the driver<br>print all outgoing HDLC frames. To capture kernel debugging messages, you must either run a<br><b>syslogd</b>&nbsp;daemon that reads the&nbsp;/proc/kmsg&nbsp;file, or the&nbsp;<b>klogd</b>&nbsp;daemon. Either of them directs kernel<br>debugging to the&nbsp;<b>syslog</b>&nbsp;kernel facility.<br>
8.9. Debugging Your PPP Setup<br>
162<br>
<hr>
<A name=179></a><b>8.10. More Advanced PPP Configurations</b><br>
While configuring PPP to dial in to a network like the Internet is the most common application, there are<br>those of you who have more advanced requirements. In this section we'll talk about a few of the more<br>advanced configurations possible with PPP under Linux.<br>
<b>8.10.1. PPP Server</b><br>
&nbsp;Running&nbsp;<b>pppd</b>&nbsp;as a server is just a matter of configuring a serial tty device to invoke&nbsp;<b>pppd</b>&nbsp;with appropriate<br>options when an incoming data call has been received. One way to do this is to create a special account, say<br>ppp, and give it a script or program as a login shell that invokes&nbsp;<b>pppd</b>&nbsp;with these options. Alternatively, if<br>you intend to support PAP or CHAP authentication, you can use the&nbsp;<b>mgetty</b>&nbsp;program to support your modem<br>and exploit its /AutoPPP/ feature.<br>
To build a server using the login method, you add a line similar to the following to your<br>/etc/passwd&nbsp;file:[58]<br>
ppp:x:500:200:Public PPP Account:/tmp:/etc/ppp/ppplogin<br>
If your system supports shadow passwords, you also need to add an entry to the&nbsp;/etc/shadow&nbsp;file:<br>
ppp:!:10913:0:99999:7:::<br>
Of course, the UID and GID you use depends on which user you wish to own the connection, and how you've<br>created it. You also have to set the password for the mentioned account using the&nbsp;<b>passwd</b>&nbsp;command.<br>
The&nbsp;<b>ppplogin</b>&nbsp;script might look like this:<br>
#!/bin/sh<br>
# ppplogin − script to fire up pppd on login<br>
mesg n<br>
stty −echo<br>
exec pppd −detach silent modem crtscts<br>
The&nbsp;<b>mesg</b>&nbsp;command disables other users from writing to the tty by using, for instance, the&nbsp;<b>write</b>&nbsp;command.<br>The&nbsp;<b>stty</b>&nbsp;command turns off character echoing. This command is necessary; otherwise, everything the peer<br>sends would be echoed back to it. The most important&nbsp;<b>pppd</b>&nbsp;option given is −detach because it prevents<br><b>pppd</b>&nbsp;from detaching from the controlling tty. If we didn't specify this option, it would go to the background,<br>making the shell script exit. This in turn would cause the serial line to hang up and the connection to be<br>dropped. The&nbsp;<b>silent</b>&nbsp;option causes&nbsp;<b>pppd</b>&nbsp;to wait until it receives a packet from the calling system before it<br>starts sending. This option prevents transmit timeouts from occurring when the calling system is slow in<br>firing up its PPP client. The modem option makes&nbsp;<b>pppd</b>&nbsp;drive the modem control lines of the serial port. You<br>should always turn this option on when using&nbsp;<b>pppd</b>&nbsp;with a modem. The&nbsp;crtscts&nbsp;option turns on hardware<br>handshake.<br>
Besides these options, you might want to force some sort of authentication, for example, by specifying<br>auth&nbsp;on&nbsp;<b>pppd</b>'s command line or in the global options file. The manual page also discusses more specific<br>options for turning individual authentication protocols on and off.<br>
8.10. More Advanced PPP Configurations<br>
163<br>
<hr>
<A name=180></a>Linux Network Administrators Guide<br>
If you wish to use&nbsp;<b>mgetty</b>, all you need to do is configure&nbsp;<b>mgetty</b>&nbsp;to support the serial device your modem is<br><a href="TLNAGs.html#94">connected to (see&nbsp;Section 4.6.1&nbsp;for details), configure&nbsp;</a><b>pppd</b>&nbsp;for either PAP or CHAP authentication with<br>appropriate options in its&nbsp;options&nbsp;file, and finally, add a section similar to the following to your<br>/etc/mgetty/login.config&nbsp;file:<br>
# Configure mgetty to automatically detect incoming PPP calls and invoke<br>
# the pppd daemon to handle the connection.<br>
#<br>
/AutoPPP/ − &nbsp; &nbsp; ppp &nbsp; /usr/sbin/pppd auth −chap +pap login<br>
The first field is a special piece of magic used to detect that an incoming call is a PPP one. You must not<br>change the case of this string; it is case sensitive. The third column is the username that appears in<br><b>who</b>&nbsp;listings when someone has logged in. The rest of the line is the command to invoke. In our example,<br>we've ensured that PAP authentication is required, disabled CHAP, and specified that the system<br>passwd&nbsp;file should be used for authenticating users. This is probably similar to what you'll want.<br>Remember, you can specify the options in the&nbsp;options&nbsp;file or on the command line if you prefer.<br>
Here is a small checklist of tasks to perform and the sequence you should perform them to get PPP dial in<br>working on your machine. Make sure each step works before moving on to the next:<br>
Configure the modem for auto−answer mode. On Hayes−compatible modems, this is performed<br>
1.&nbsp;<br>
using a command like&nbsp;ATS0=3. If you're going to be using the&nbsp;<b>mgetty</b>&nbsp;daemon, this isn't necessary.<br>Configure the serial device with a&nbsp;<br>
2.&nbsp;<br>
<b>getty</b>&nbsp;type of command to answer incoming calls. A commonly<br>
used&nbsp;<b>getty</b>&nbsp;variant is&nbsp;<b>mgetty</b>.<br>Consider authentication. Will your callers authenticate using PAP, CHAP, or system login?<br>
3.&nbsp;<br>
Configure&nbsp;<br>
4.&nbsp;<br>
<b>pppd</b>&nbsp;as server as described in this section.<br>
Consider routing. Will you need to provide a network route to callers? Routing can be performed<br>
5.&nbsp;<br>
using the&nbsp;ip−up&nbsp;script.<br>
<b>8.10.2. Demand Dialing</b><br>
&nbsp;When there is IP traffic to be carried across the link,&nbsp;<i>demand dialing</i>&nbsp;causes your telephone modem to dial<br>and to establish a connection to a remote host. Demand dialing is most useful when you can't leave your<br>telephone line permanently switched to your Internet provider. For example, you might have to pay timed<br>local calls, so it might be cheaper to have the telephone line switched on only when you need it and<br>disconnected when you aren't using the Internet.<br>
Traditional Linux solutions have used the&nbsp;<b>diald</b>&nbsp;command, which worked well but was fairly tricky to<br>configure. Versions 2.3.0 and later of the PPP daemon have built−in support for demand dialing and make it<br>very simple to configure. You must use a modern kernel for this to work, too. Any of the later 2.0 kernels will<br>work just fine.<br>
To configure&nbsp;<b>pppd</b>&nbsp;for demand dialing, all you need to do is add options to your&nbsp;options&nbsp;file or the<br><b>pppd</b>&nbsp;command line. The following table summarizes the options related to demand dialing:<br>
<b>Option</b><br>
<b>Description</b><br>
demand<br>
8.10.2. Demand Dialing<br>
164<br>
<hr>
<A name=181></a>Linux Network Administrators Guide<br>
This option specifies that the PPP link should be placed in demand dial<br>mode. The PPP network device will be created, but the<br>connect&nbsp;command will not be used until a datagram is transmitted by<br>the local host. This option is mandatory for demand dialing to work.<br>
active−filter<i>&nbsp;expression</i><br>
This option allows you to specify which data packets are to be<br>considered active traffic. Any traffic matching the specified rule will<br>restart the demand dial idle timer, ensuring that&nbsp;<b>pppd</b>&nbsp;waits again<br>before closing the link. The filter syntax has been borrowed from the<br><b>tcpdump</b>&nbsp;command. The default filter matches all datagrams.<br>
holdoff<i>&nbsp;n</i><br>
This option allows you to specify the minimum amount of time, in<br>seconds, to wait before reconnecting this link if it terminates. If the<br>connection fails while&nbsp;<b>pppd</b>&nbsp;believes it is in active use, it will be<br>re−established after this timer has expired. This timer does not apply to<br>reconnections after an idle timeout.<br>
idle<i>&nbsp;n</i><br>
If this option is configured,&nbsp;<b>pppd</b>&nbsp;will disconnect the link whenever<br>this timer expires. Idle times are specified in seconds. Each new active<br>data packet will reset the timer.<br>
A simple demand dialing configuration would therefore look something like this:<br>
demand<br>
holdoff 60<br>
idle 180<br>
This configuration would enable demand dialing, wait 60 seconds before re−establishing a failed connection,<br>and drop the link if 180 seconds pass without any active data on the link.<br>
<b>8.10.3. Persistent Dialing</b><br>
<i>Persistent dialing</i>&nbsp;is what people who have permanent dialup connections to a network will want to use.<br>
There is a subtle difference between demand dialing and persistent dialing. With persistent dialing, the<br>connection is automatically established as soon as the PPP daemon is started, and the persistent aspect comes<br>into play whenever the telephone call supporting the link fails. Persistent dialing ensures that the link is<br>always available by automatically rebuilding the connection if it fails.<br>
You might be fortunate to not have to pay for your telephone calls; perhaps they are local and free, or perhaps<br>they're paid by your company. The persistent dialing option is extremely useful in this situation. If you do<br>have to pay for your telephone calls, then you have to be a little careful. If you pay for your telephone calls<br>on a time−charged basis, persistent dialing is almost certainly not what you want, unless you're very sure<br>you'll be using the connection fairly steadily twenty−four hours a day. If you do pay for calls, but they are not<br>time charged, you need to be careful to protect yourself against situations that might cause the modem to<br>endlessly redial. The&nbsp;<b>pppd</b>&nbsp;daemon provides an option that can help reduce the effects of this problem.<br>
To enable persistent dialing, you must include the persist option in one of your&nbsp;<b>pppd</b>&nbsp;options files. Including<br>this option alone is all you need to have&nbsp;<b>pppd</b>&nbsp;automatically invoke the command specified by the<br>
8.10.3. Persistent Dialing<br>
165<br>
<hr>
<A name=182></a>Linux Network Administrators Guide<br>
connect option to rebuild the connection when the link fails. If you are concerned about the modem redialing<br>too rapidly (in the case of modem or server fault at the other end of the connection), you can use the<br>holdoff option to set the minimum amount of time that&nbsp;<b>pppd</b>&nbsp;will wait before attempting to reconnect. This<br>option won't solve the problem of a fault costing you money in wasted phone calls, but it will at least serve to<br>reduce the impact of one.<br>
A typical configuration might have persistent dialing options that look like this:<br>
persist<br>
holdoff 600<br>
The holdoff time is specified in seconds. In our example,&nbsp;<b>pppd</b>&nbsp;waits a full five minutes before redialing after<br>the call drops out.<br>
It is possible to combine persistent dialing with demand dialing, using idle to drop the link if it has been idle<br>for a specified period of time. We doubt many users would want to do so, but this scenario is described<br>briefly in the&nbsp;<b>pppd</b>&nbsp;manual page, if you'd like to pursue it.<br>
8.10.3. Persistent Dialing<br>
166<br>
<hr>
<A name=183></a><b>Chapter 9. TCP/IP Firewall</b><br>
&nbsp;Security is increasingly important for companies and individuals alike. The Internet has provided them with<br>a powerful tool to distribute information about themselves and obtain information from others, but it has also<br>exposed them to dangers that they have previously been exempt from. Computer crime, information theft,<br>and malicious damage are all potential dangers.<br>
An unauthorized and unscrupulous person who gains access to a computer system may guess system<br>passwords or exploit the bugs and idiosyncratic behavior of certain programs to obtain a working account on<br>that machine. Once they are able to log in to the machine, they may have access to information that may be<br>damaging, such as commercially sensitive information like marketing plans, new project details, or customer<br>information databases. Damaging or modifying this type of data can cause severe setbacks to the company.<br>
The safest way to avoid such widespread damage is to prevent unauthorized people from gaining network<br>access to the machine. This is where firewalls come in.<br>
<b>Warning</b><br>
Constructing secure firewalls is an art. It involves a good understanding of technology, but equally<br>important, it requires an understanding of the philosophy behind firewall designs. We won't cover<br>everything you need to know in this book; we strongly recommend you do some additional research before<br>trusting any particular firewall design, including any we present here.<br>
There is enough material on firewall configuration and design to fill a whole book, and indeed there are some<br>good resources that you might like to read to expand your knowledge on the subject. Two of these are:<br>
<i>Building Internet Firewalls</i><br>
by D. Chapman and E. Zwicky (O'Reilly). A guide explaining how to design and install firewalls for<br>Unix, Linux, and Windows NT, and how to configure Internet services to work with the firewalls.<br>
<i>Firewalls and Internet Security</i><br>
by W. Cheswick and S. Bellovin (Addison Wesley). This book covers the philosophy of firewall<br>design and implementation.<br>
We will focus on the Linux−specific technical issues in this chapter. Later we will present a sample firewall<br>configuration that should serve as a useful starting point in your own configuration, but as with all<br>security−related matters, trust no one. Double check the design, make sure you understand it, and then<br>modify it to suit your requirements. To be safe, be sure.<br>
Chapter 9. TCP/IP Firewall<br>
167<br>
<hr>
<A name=184></a><b>9.1. Methods of Attack</b><br>
&nbsp;As a network administrator, it is important that you understand the nature of potential attacks on computer<br>security. We'll briefly describe the most important types of attacks so that you can better understand precisely<br>what the Linux IP firewall will protect you against. You should do some additional reading to ensure that you<br>are able to protect your network against other types of attacks. Here are some of the more important methods<br>of attack and ways of protecting yourself against them:<br>
<i>Unauthorized access</i><br>
This simply means that people who shouldn't use your computer services are able to connect and use<br>them. For example, people outside your company might try to connect to your company accounting<br>machine or to your NFS server.<br>
There are various ways to avoid this attack by carefully specifying who can gain access through these<br>services. You can prevent network access to all except the intended users.<br>
<i>Exploitation of known weaknesses in programs</i><br>
Some programs and network services were not originally designed with strong security in mind and<br>are inherently vulnerable to attack. The BSD remote services (rlogin, rexec, etc.) are an example.<br>
The best way to protect yourself against this type of attack is to disable any vulnerable services or<br>find alternatives. With Open Source, it is sometimes possible to repair the weaknesses in the software.<br>
<i>Denial of service</i><br>
Denial of service attacks cause the service or program to cease functioning or prevent others from<br>making use of the service or program. These may be performed at the network layer by sending<br>carefully crafted and malicious datagrams that cause network connections to fail. They may also be<br>performed at the application layer, where carefully crafted application commands are given to a<br>program that cause it to become extremely busy or stop functioning.<br>
Preventing suspicious network traffic from reaching your hosts and preventing suspicious program<br>commands and requests are the best ways of minimizing the risk of a denial of service attack. It's<br>useful to know the details of the attack method, so you should educate yourself about each new attack<br>as it gets publicized.<br>
<i>Spoofing</i><br>
This type of attack causes a host or application to mimic the actions of another. Typically the<br>attacker pretends to be an innocent host by following IP addresses in network packets. For example, a<br>well−documented exploit of the BSD rlogin service can use this method to mimic a TCP connection<br>from another host by guessing TCP sequence numbers.<br>
To protect against this type of attack, verify the authenticity of datagrams and commands. Prevent<br>datagram routing with invalid source addresses. Introduce unpredictablility into connection control<br>mechanisms, such as TCP sequence numbers and the allocation of dynamic port addresses.<br>
<i>Eavesdropping</i><br>
9.1. Methods of Attack<br>
168<br>
<hr>
<A name=185></a>Linux Network Administrators Guide<br>
This is the simplest type of attack. A host is configured to &quot;listen&quot; to and capture data not belonging<br>to it. Carefully written eavesdropping programs can take usernames and passwords from user login<br>network connections. Broadcast networks like Ethernet are especially vulnerable to this type of attack.<br>
To protect against this type of threat, avoid use of broadcast network technologies and enforce the<br>use of data encryption.<br>
IP firewalling is very useful in preventing or reducing unauthorized access, network layer denial of service,<br>and IP spoofing attacks. It not very useful in avoiding exploitation of weaknesses in network services or<br>programs and eavesdropping.<br>
9.1. Methods of Attack<br>
169<br>
<hr>
<A name=186></a><IMG src="TLNAG-186_1.png"><br>
<b>9.2. What Is a Firewall?</b><br>
A firewall is a secure and trusted machine that sits between a private network and a public network.&nbsp;[59]&nbsp;The<br>firewall machine is configured with a set of rules that determine which network traffic will be allowed to pass<br>and which will be blocked or refused. In some large organizations, you may even find a firewall located<br>inside their corporate network to segregate sensitive areas of the organization from other employees. Many<br>cases of computer crime occur from within an organization, not just from outside.<br>
Firewalls can be constructed in quite a variety of ways. The most sophisticated arrangement involves a<br>number of separate machines and is known as a&nbsp;<i>perimeter network</i>. Two machines act as &quot;filters&quot; called<br>chokes to allow only certain types of network traffic to pass, and between these chokes reside network<br>servers such as a mail gateway or a World Wide Web proxy server. This configuration can be very safe and<br>easily allows quite a great range of control over who can connect both from the inside to the outside, and<br>from the outside to the inside. This sort of configuration might be used by large organizations.<br>
Typically though, firewalls are single machines that serve all of these functions. These are a little less secure,<br>because if there is some weakness in the firewall machine itself that allows people to gain access to it, the<br>whole network security has been breached. Nevertheless, these types of firewalls are cheaper and easier to<br><a href="TLNAGs.html#186">manage than the more sophisticated arrangement just described.&nbsp;Figure 9−1</a>&nbsp;illustrates the two most common<br>firewall configurations.<br>
<b>Figure 9−1. The two major classes of firewall design</b><br>
The Linux kernel provides a range of built−in features that allow it to function quite nicely as an IP firewall.<br>The network implementation includes code to do IP filtering in a number of different ways, and provides a<br>mechanism to quite accurately configure what sort of rules you'd like to put in place. The Linux firewall is<br>flexible enough to make it very useful in either of the configurations illustrated in&nbsp;<a href="TLNAGs.html#186">Figure 9−1</a>. Linux firewall<br><a href="TLNAGs.html#230">software provides two other useful features that we'll discuss in separate chapters: IP Accounting (Chapter<br>10</a>) and IP masquerade (<a href="TLNAGs.html#243">Chapter 11</a>).<br>
9.2. What Is a Firewall?<br>
170<br>
<hr>
<A name=187></a><b>9.3. What Is IP Filtering?</b><br>
&nbsp;IP filtering is simply a mechanism that decides which types of IP datagrams will be processed normally and<br>which will be discarded. By&nbsp;<i>discarded</i>&nbsp;we mean that the datagram is deleted and completely ignored, as if it<br>had never been received. You can apply many different sorts of criteria to determine which datagrams you<br>wish to filter; some examples of these are:<br>
Protocol type: TCP, UDP, ICMP, etc.<br>
•&nbsp;<br>
Socket number (for TCP/UPD)<br>
•&nbsp;<br>
Datagram type: SYN/ACK, data, ICMP Echo Request, etc.<br>
•&nbsp;<br>
Datagram source address: where it came from<br>
•&nbsp;<br>
Datagram destination address: where it is going to<br>
•&nbsp;<br>
It is important to understand at this point that IP filtering is a network layer facility. This means it doesn't<br>understand anything about the application using the network connections, only about the connections<br>themselves. For example, you may deny users access to your internal network on the default telnet port, but if<br>you rely on IP filtering alone, you can't stop them from using the telnet program with a port that you do allow<br>to pass trhough your firewall. You can prevent this sort of problem by using proxy servers for each service<br>that you allow across your firewall. The proxy servers understand the application they were designed to proxy<br>and can therefore prevent abuses, such as using the telnet program to get past a firewall by using the World<br>Wide Web port. If your firewall supports a World Wide Web proxy, their telnet connection will always be<br>answered by the proxy and will allow only HTTP requests to pass. A large number of proxy−server programs<br>exist. Some are free software and many others are commercial products. The Firewall−HOWTO discusses<br>one popular set of these, but they are beyond the scope of this book.<br>
The IP filtering ruleset is made up of many combinations of the criteria listed previously. For example, let's<br>imagine that you wanted to allow World Wide Web users within the Virtual Brewery network to have no<br>access to the Internet except to use other sites' web servers. You would configure your firewall to allow<br>forwarding of:<br>
datagrams with a source address on Virtual Brewery network, a destination address of anywhere, and<br>
•&nbsp;<br>
with a destination port of 80 (WWW)<br>datagrams with a destination address of Virtual Brewery network and a source port of 80 (WWW)<br>
•&nbsp;<br>
from a source address of anywhere<br>
Note that we've used two rules here. We have to allow our data to go out, but also the corresponding reply<br>data to come back in. In practice, as we'll see shortly, Linux simplifies this and allows us to specify this in<br>one command.<br>
9.3. What Is IP Filtering?<br>
171<br>
<hr>
<A name=188></a><b>9.4. Setting Up Linux for Firewalling</b><br>
&nbsp;To build a Linux IP firewall, it is necessary to have a kernel built with IP firewall support and the<br>appropriate configuration utility. In all production kernels prior to the 2.2 series, you would use the<br><b>ipfwadm</b>&nbsp;utility. The 2.2.x kernels marked the release of the third generation of IP firewall for Linux called<br><i>IP Chains</i>. IP chains use a program similar to&nbsp;<b>ipfwadm</b>&nbsp;called&nbsp;<b>ipchains</b>. Linux kernels 2.3.15 and later<br>support the fourth generation of Linux IP firewall called&nbsp;<i>netfilter</i>. The&nbsp;<i>netfilter</i>&nbsp;code is the result of a large<br>redesign of the packet handling flow in Linux. The&nbsp;<i>netfilter</i>&nbsp;is a multifaceted creature, providing direct<br>backward−compatible support for both&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>ipchains</b>&nbsp;as well as a new alternative command called<br><b>iptables</b>. We'll talk about the differences between the three in the next few sections.<br>
<b>9.4.1. Kernel Configured with IP Firewall</b><br>
The Linux kernel must be configured to support IP firewalling. There isn't much more to it than selecting the<br>appropriate options when performing a&nbsp;make menuconfig&nbsp;of your kernel.[60]&nbsp;We described how to do<br><a href="TLNAGs.html#64">this is in&nbsp;Chapter 3</a>. In 2.2 kernels you should select the following options:<br>
Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] Network firewalls<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] TCP/IP networking<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] IP: firewalling<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] IP: firewall packet logging<br>
In kernels 2.4.0 and later you should select this option instead:<br>
&nbsp; Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; &nbsp;[*] Network packet filtering (replaces ipchains)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IP: Netfilter Configuration &nbsp;−−−&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; Userspace queueing via NETLINK (EXPERIMENTAL)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; IP tables support (required for filtering/masq/NAT)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; limit match support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; MAC address match support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; netfilter MARK match support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; Multiple port match support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; TOS match support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; Connection state match support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; Unclean match support (EXPERIMENTAL)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; Owner match support (EXPERIMENTAL)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; Packet filtering<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; &nbsp; REJECT target support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; &nbsp; MIRROR target support (EXPERIMENTAL)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; Packet mangling<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; &nbsp; TOS target support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; &nbsp; MARK target support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; &nbsp; LOG target support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; ipchains (2.2−style) support<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;M&gt; ipfwadm (2.0−style) support<br>
9.4. Setting Up Linux for Firewalling<br>
172<br>
<hr>
<A name=189></a>Linux Network Administrators Guide<br>
<b>9.4.2. The ipfwadm Utility</b><br>
The&nbsp;<b>ipfwadm</b>&nbsp;(IP Firewall Administration) utility is the tool used to build the firewall rules for all kernels<br>prior to 2.2.0. Its command syntax can be very confusing because it can do such a complicated range of<br>things, but we'll provide some common examples that will illustrate the most important variations of these.<br>
The&nbsp;<b>ipfwadm</b>&nbsp;utility is included in most modern Linux distributions, but perhaps not by default. There may<br>be a specific software package for it that you have to install. If your distribution does not include it, you can<br>obtain the source package from ftp.xos.nl in the&nbsp;/pub/linux/ipfwadm/&nbsp;directory, and compile it<br>yourself.<br>
<b>9.4.3. The ipchains Utility</b><br>
Just as for the&nbsp;<b>ipfwadm</b>&nbsp;utility, the&nbsp;<b>ipchains</b>&nbsp;utility can be somewhat baffling to use at first. It provides all<br>of the flexibility of&nbsp;<b>ipfwadm</b>&nbsp;with a simplified command syntax, and additionally provides a chaining<br>mechanism that allows you to manage multiple rulesets and link them together. We'll cover rule chaining in a<br>separate section near the end of the chapter, because for most situations it is an advanced concept.<br>
The&nbsp;<b>ipchains</b>&nbsp;command appears in most Linux distributions based on the 2.2 kernels. If you want to<br>compile it yourself, you can find the source package from its developer's site at<br><i>http://www.rustcorp.com/linux/ipchains/</i>. Included in the source package is a wrapper script called<br><b>ipfwadm−wrapper</b>&nbsp;that mimics the&nbsp;<b>ipfwadm</b>&nbsp;command, but actually invokes the&nbsp;<b>ipchains</b>&nbsp;command.<br>Migration of an existing firewall configuration is much more painless with this addition.<br>
<b>9.4.4. The iptables Utility</b><br>
The syntax of the&nbsp;<b>iptables</b>&nbsp;utility is quite similar to that of the&nbsp;<b>ipchains</b>&nbsp;syntax. The changes are<br>improvements and a result of the tool being redesigned to be extensible through shared libraries. Just as for<br><b>ipchains</b>, we'll present&nbsp;<b>iptables</b>&nbsp;equivalents of the examples so you can compare and contrast its syntax with<br>the others.<br>
The&nbsp;<b>iptables</b>&nbsp;utility is included in the&nbsp;<i>netfilter</i>&nbsp;source package available at&nbsp;<i>http://www.samba.org/netfilter/</i>. It<br>will also be included in any Linux distribution based on the 2.4 series kernels.<br>
We'll talk a bit about&nbsp;<i>netfilter</i>'s huge step forward in a section of its own later in this chapter.<br>
9.4.2. The ipfwadm Utility<br>
173<br>
<hr>
<A name=190></a><IMG src="TLNAG-190_1.png"><br>
<b>9.5. Three Ways We Can Do Filtering</b><br>
Consider how a Unix machine, or in fact any machine capable of IP routing, processes IP datagrams. The<br>basic steps, shown in&nbsp;<a href="TLNAGs.html#190">Figure 9−2</a>&nbsp;are:<br>
<b>Figure 9−2. The stages of IP datagram processing</b><br>
The IP datagram is received. (1)<br>
•&nbsp;<br>
The incoming IP datagram is examined to determine if it is destined for a process on this machine.<br>
•&nbsp;<br>
If the datagram is for this machine, it is processed locally. (2)<br>
•&nbsp;<br>
If it is not destined for this machine, a search is made of the routing table for an appropriate route and<br>
•&nbsp;<br>
the datagram is forwarded to the appropriate interface or dropped if no route can be found. (3)<br>Datagrams from local processes are sent to the routing software for forwarding to the appropriate<br>
•&nbsp;<br>
interface. (4)<br>The outgoing IP datagram is examined to determine if there is a valid route for it to take, if not, it is<br>
•&nbsp;<br>
dropped.<br>The IP datagram is transmitted. (5)<br>
•&nbsp;<br>
In our diagram, the flow 1’3’5 represents our machine routing data between a host on our Ethernet network to<br>a host reachable via our PPP link. The flows 1’2 and 4’5 represent the data input and output flows of a<br>network program running on our local host. The flow 4’3’2 would represent data flow via a loopback<br>connection. Naturally data flows both into and out of network devices. The question marks on the diagram<br>represent the points where the IP layer makes routing decisions.<br>
The Linux kernel IP firewall is capable of applying filtering at various stages in this process. That is, you can<br>filter the IP datagrams that come in to your machine, filter those datagrams being forwarded across your<br>machine, and filter those datagrams that are ready to be transmitted.<br>
In&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>ipchains</b>, an Input rule applies to flow 1 on the diagram, a Forwarding rule to flow 3, and an<br>Output rule to flow 5. We'll see when we discuss&nbsp;<i>netfilter</i>&nbsp;later that the points of interception have changed so<br>that an Input rule is applied at flow 2, and an Output rule is applied at flow 4. This has important implications<br>for how you structure your rulesets, but the general principle holds true for all versions of Linux firewalling.<br>
This may seem unnecessarily complicated at first, but it provides flexibility that allows some very<br>sophisticated and powerful configurations to be built.<br>
9.5. Three Ways We Can Do Filtering<br>
174<br>
<hr>
<A name=191></a><b>9.6. Original IP Firewall (2.0 Kernels)</b><br>
&nbsp;The first generation IP firewall support for Linux appeared in the 1.1 series kernel. It was a port of the BSD<br>ipfw firewall support to Linux by Alan Cox. The firewall support that appeared in the 2.0 series kernels and is<br>the second generation was enhanced by Jos Vos, Pauline Middelink, and others.<br>
<b>9.6.1. Using ipfwadm</b><br>
The&nbsp;<b>ipfwadm</b>&nbsp;command was the configuration tool for the second generation Linux IP firewall. Perhaps the<br>simplest way to describe the use of the&nbsp;<b>ipfwadm</b>&nbsp;command is by example. To begin, let's code the example<br>we presented earlier.<br>
<b>9.6.1.1. A naïve example</b><br>
Let's suppose that we have a network in our organization and that we are using a Linux−based firewall<br>machine to connect our network to the Internet. Additionally, let's suppose that we wish the users of that<br>network to be able to access web servers on the Internet, but to allow no other traffic to be passed.<br>
We will put in place a forwarding rule to allow datagrams with a source address on our network and a<br>destination socket of port 80 to be forwarded out, and for the corresponding reply datagrams to be forwarded<br>back via the firewall.<br>
Assume our network has a 24−bit network mask (Class C) and an address of 172.16.1.0. The rules we might<br>use are:<br>
#&nbsp;<b>ipfwadm −F −f</b><br>
#&nbsp;<b>ipfwadm −F −p deny</b><br>
#&nbsp;<b>ipfwadm −F −a accept −P tcp −S 172.16.1.0/24 −D 0/0 80</b><br>
#&nbsp;<b>ipfwadm −F −a accept −P tcp −S 0/0 80 −D 172.16.1.0/24</b><br>
The&nbsp;−F&nbsp;command−line argument tells&nbsp;<b>ipfwadm</b>&nbsp;that this is a forwarding rule. The first command instructs<br><b>ipfwadm</b>&nbsp;to &quot;flush&quot; all of the forwarding rules. This ensures we are working from a known state before we<br>begin adding specific rules.<br>
The second rule sets our default forwarding policy. We tell the kernel to deny or disallow forwarding of IP<br>datagrams. It is very important to set the default policy, because this describes what will happen to any<br>datagrams that are not specifically handled by any other rule. In most firewall configurations, you will want<br>to set your default policy to &quot;deny,&quot; as shown, to be sure that only the traffic you specifically allow past your<br>firewall is forwarded.<br>
The third and fourth rules are the ones that implement our requirement. The third command allows our<br>datagrams out, and the fourth rule allows the responses back.<br>
Let's review each of the arguments:<br>
<i>−F</i><br>
This is a Forwarding rule.<br>
9.6. Original IP Firewall (2.0 Kernels)<br>
175<br>
<hr>
<A name=192></a>Linux Network Administrators Guide<br>
<i>−a accept</i><br>
Append this rule with the policy set to &quot;accept,&quot; meaning we will forward any datagrams that match<br>this rule.<br>
<i>−P tcp</i><br>
This rule applies to tcp datagrams (as opposed to UDP or ICMP).<br>
<i>−S 172.16.1.0/24</i><br>
The Source address must have the first 24 bits matching those of the network address 172.16.1.0.<br>
<i>−D 0/0 80</i><br>
The destination address must have zero bits matching the address 0.0.0.0. This is really a shorthand<br>notation for &quot;anything.&quot; The 80 is the destination port, in this case WWW. You may also use any<br>entry that appears in the&nbsp;/etc/services&nbsp;file to describe the port, so&nbsp;−D 0/0 www&nbsp;would have<br>worked just as well.<br>
<b>ipfwadm</b>&nbsp;accepts network masks in a form with which you may not be familiar. The&nbsp;/nn&nbsp;notation is a means<br>of describing how many bits of the supplied address are significant, or the size of the mask. The bits are<br>always counted from left to right; some common examples are listed in&nbsp;<a href="TLNAGs.html#192">Table 9−1.</a><br>
<b>Table 9−1. Common Netmask Bit Values</b><br>
<b>Netmask</b><br>
<b>Bits</b><br>
255.0.0.0<br>
8<br>
255.255.0.0<br>
16<br>
255.255.255.0<br>
24<br>
255.255.255.128&nbsp;25<br>
255.255.255.192&nbsp;26<br>
255.255.255.224&nbsp;27<br>
255.255.255.240&nbsp;28<br>
255.255.255.248&nbsp;29<br>
255.255.255.252&nbsp;30<br>
We mentioned earlier that&nbsp;<b>ipfwadm</b>&nbsp;implements a small trick that makes adding these sorts of rules easier.<br>This trick is an option called&nbsp;<i>−b</i>, which makes the command a bidirectional rule.<br>
The bidirectional flag allows us to collapse our two rules into one as follows:<br>
#&nbsp;<b>ipfwadm −F −a accept −P tcp −S 172.16.1.0/24 −D 0/0 80 −b</b><br>
9.6. Original IP Firewall (2.0 Kernels)<br>
176<br>
<hr>
<A name=193></a>Linux Network Administrators Guide<br>
<b>9.6.1.2. An important refinement</b><br>
Take a closer look at our ruleset. Can you see that there is still one method of attack that someone outside<br>could use to defeat our firewall?<br>
Our ruleset allows all datagrams from outside our network with a source port of 80 to pass. This will include<br>those datagrams with the SYN bit set! The SYN bit is what declares a TCP datagram to be a connection<br>request. If a person on the outside had privileged access to a host, they could make a connection through our<br>firewall to any of our hosts, provided they use port 80 at their end. This is not what we intended.<br>
Fortunately there is a solution to this problem. The&nbsp;<b>ipfwadm</b>&nbsp;command provides another flag that allows us<br>to build rules that will match datagrams with the SYN bit set. Let's change our example to include such a<br>rule:<br>
#&nbsp;<b>ipfwadm −F −a deny −P tcp −S 0/0 80 −D 172.16.10.0/24 −y</b><br>
#&nbsp;<b>ipfwadm −F −a accept −P tcp −S 172.16.1.0/24 −D 0/0 80 −b</b><br>
The&nbsp;−y&nbsp;flag causes the rule to match only if the SYN flag is set in the datagram. So our new rule says: &quot;Deny<br>any TCP datagrams destined for our network from anywhere with a source port of 80 and the SYN bit set,&quot; or<br>&quot;Deny any connection requests from hosts using port 80.&quot;<br>
Why have we placed this special rule&nbsp;<i>before</i>&nbsp;the main rule? IP firewall rules operate so that the first match is<br>the rule that is used. Both rules would match the datagrams we want to stop, so we must be sure to put the<br>deny&nbsp;rule before the&nbsp;accept&nbsp;rule.<br>
<b>9.6.1.3. Listing our rules</b><br>
After we've entered our rules, we ask&nbsp;<b>ipfwadm</b>&nbsp;to list them for us using the command:<br>
#&nbsp;<b>ipfwadm −F −l</b><br>
This command will list all of the configured forwarding rules. The output should look something like this:<br>
#&nbsp;<b>ipfwadm −F −l</b><br>
IP firewall forward rules, default policy: accept<br>
type &nbsp;prot source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ports<br>
deny &nbsp;tcp &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.10.0/24 &nbsp; &nbsp; &nbsp; www −&gt; any<br>
acc &nbsp; tcp &nbsp;172.16.1.0/24 &nbsp; &nbsp; &nbsp; &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; any −&gt; www<br>
The&nbsp;<b>ipfwadm</b>&nbsp;command will attempt to translate the port number into a service name using the<br>/etc/services&nbsp;if an entry exists there.<br>
The default output is lacking in some important detail for us. In the default listing output, we can't see the<br>effect of the&nbsp;−y&nbsp;argument. The&nbsp;<b>ipfwadm</b>&nbsp;command is able to produce a more detailed listing output if you<br>specify the&nbsp;−e&nbsp;(extended output) argument too. We won't show the whole output here because it is too wide<br>for the page, but it includes an&nbsp;opt&nbsp;(options) column that shows the&nbsp;−y&nbsp;option controlling SYN packets:<br>
#&nbsp;<b>ipfwadm −F −l −e</b><br>
P firewall forward rules, default policy: accept<br>
&nbsp;pkts bytes type &nbsp;prot opt &nbsp;tosa tosx ifname &nbsp;ifaddress &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp;... &nbsp;&nbsp;<br>
&nbsp; &nbsp; 0 &nbsp; &nbsp; 0 deny &nbsp;tcp &nbsp;−−y− 0xFF 0x00 any &nbsp; &nbsp; any &nbsp; &nbsp; &nbsp; &nbsp; anywhere &nbsp; &nbsp; &nbsp;... &nbsp; &nbsp; &nbsp;&nbsp;<br>
9.6.1.2. An important refinement<br>
177<br>
<hr>
<A name=194></a><IMG src="TLNAG-194_1.png"><br>
Linux Network Administrators Guide<br>
&nbsp; &nbsp; 0 &nbsp; &nbsp; 0 acc &nbsp; tcp &nbsp;b−−− 0xFF 0x00 any &nbsp; &nbsp; any &nbsp; &nbsp; &nbsp; &nbsp; 172.16.1.0/24 ...<br>
<b>9.6.2. A More Complex Example</b><br>
The previous example was a simple one. Not all network services are as simple as the WWW service to<br>configure; in practice, a typical firewall configuration would be much more complex. Let's look at another<br>common example, this time FTP. We want our internal network users to be able to log into FTP servers on<br>the Internet to read and write files. But we don't want people on the Internet to be able to log into our FTP<br>servers.<br>
We know that FTP uses two TCP ports: port 20 (ftp−data) and port 21 (ftp), so:<br>
#&nbsp;<b>ipfwadm −a deny −P tcp −S 0/0 20 −D 172.16.1.0/24 −y</b><br>
#&nbsp;<b>ipfwadm −a accept −P tcp −S 172.16.1.0/24 −D 0/0 20 −b</b><br>
#<br>
#&nbsp;<b>ipfwadm −a deny −P tcp −S 0/0 21 −D 172.16.1.0/24 −y</b><br>
#&nbsp;<b>ipfwadm −a accept −P tcp −S 172.16.1.0/24 −D 0/0 21 −b</b><br>
Right? Well, not necessarily. FTP servers can operate in two different modes: passive mode and active<br>mode.[61]&nbsp;In passive mode, the FTP server listens for a connection from the client. In active mode, the server<br>actually makes the connection to the client. Active mode is usually the default. The differences are illustrated<br><a href="TLNAGs.html#194">in&nbsp;Figure 9−3.</a><br>
<b>Figure 9−3. FTP server modes</b><br>
Many FTP servers make their data connection from port 20 when operating in active mode, which simplifies<br>things for us a little, but unfortunately not all do.[62]<br>
But how does this affect us? Take a look at our rule for port 20, the FTP−data port. The rule as we have it<br>now assumes that the connection will be made by our client to the server. This will work if we use passive<br>mode. But it is very difficult for us to configure a satisfactory rule to allow FTP active mode, because we<br>may not know in advance what ports will be used. If we open up our firewall to allow incoming connections<br>on any port, we are exposing our network to attack on all services that accept connections.<br>
The dilemna is most safely resolved by insisting that our users operate in passive mode. Most FTP servers<br>and many FTP clients will operate this way. The popular&nbsp;<b>ncftp</b>&nbsp;client also supports passive mode, but it may<br>require a small configuration change to make it default to passive mode. Many World Wide Web browsers<br>
9.6.2. A More Complex Example<br>
178<br>
<hr>
<A name=195></a>Linux Network Administrators Guide<br>
such as the Netscape browser also support passive mode FTP, so it shouldn't be too hard to find appropriate<br>software to use. Alternatively, you can avoid the issue entirely by using an FTP proxy server that accepts a<br>connection from the internal network and establishes connections to the outside network.<br>
In building your firewall, you will probably find a number of these sorts of problems. You should always<br>give careful thought to how a service actually operates to be sure you have put in place an appropriate ruleset<br>for it. A real firewall configuration can be quite complex.<br>
<b>9.6.3. Summary of ipfwadm Arguments</b><br>
The&nbsp;<b>ipfwadm</b>&nbsp;has many different arguments that relate to IP firewall configuration. The general syntax is:<br>
<b>ipfwadm&nbsp;</b><i>category&nbsp;command&nbsp;parameters&nbsp;[options]</i><br>
Let's take a look at each of these.<br>
<b>9.6.3.1. Categories</b><br>
One and only one of the following must be supplied. The category tells the firewall what sort of firewall rule<br>you are configuring:<br>
<i>−I</i><br>
Input rule<br>
<i>−O</i><br>
Output rule<br>
<i>−F</i><br>
Forwarding rule<br>
<b>9.6.3.2. Commands</b><br>
At least one of the following must be supplied and applies only to those rules that relate to the supplied<br>category. The command tells the firewall what action to take.<br>
<i>−a [policy]</i><br>
Append a new rule<br>
<i>−i [policy]</i><br>
Insert a new rule<br>
9.6.3. Summary of ipfwadm Arguments<br>
179<br>
<hr>
<A name=196></a>Linux Network Administrators Guide<br>
<i>−d [policy]</i><br>
Delete an existing rule<br>
<i>−p policy</i><br>
Set the default policy<br>
<i>−l</i><br>
List all existing rules<br>
<i>−f</i><br>
Flush all existing rules<br>
The policies relevant to IP firewall and their meanings are:<br>
<i>accept</i><br>
Allows matching datagrams to be received, forwarded, or transmitted<br>
<i>deny</i><br>
Blocks matching datagrams from being received, forwarded, or transmitted<br>
<i>reject</i><br>
Blocks matching datagrams from being received, forwarded, or transmitted, and sends the host that<br>sent the datagram and ICMP error message<br>
<b>9.6.3.3. Parameters</b><br>
At least one of the following must be supplied. Use the parameters to specify to which datagrams this rule<br>applies:<br>
<i>−P protocol</i><br>
Can be TCP, UDP, ICMP, or all. Example:<br>
−P tcp<br>
<i>−S address[/mask] [port]</i><br>
Source IP address that this rule will match. A netmask of /32 will be assumed if you don't supply<br>one. You may optionally specify which ports this rule will apply to. You must also specify the<br>protocol using the&nbsp;−P&nbsp;argument described above for this to work. If you don't specify a port or port<br>
9.6.3.3. Parameters<br>
180<br>
<hr>
<A name=197></a>Linux Network Administrators Guide<br>
range, all ports will be assumed to match. Ports may be specified by name, using their<br>/etc/services&nbsp;entry if you wish. In the case of the ICMP protocol, the port field is used to<br>indicate the ICMP datagram types. Port ranges may be described; use the general syntax:<br><i>lowport</i>:<i>highport</i>. Here is an example:<br>
−S 172.29.16.1/24 ftp:ftp−data<br>
<i>−D address[/mask] [port]</i><br>
Specify the destination IP address that this rule will match. The destination address is coded with the<br>same rules as the source address described previously. Here is an example:<br>
−D 172.29.16.1/24 smtp<br>
<i>−V address</i><br>
Specify the address of the network interface on which the packet is received (−I) or is being sent<br>(−O). This allows us to create rules that apply only to certain network interfaces on our machine.<br>Here is an example:<br>
−V 172.29.16.1<br>
<i>−W name</i><br>
Specify the name of the network interface. This argument works in the same way as the<br>−V&nbsp;argument, except you supply the device name instead of its address. Here is an example:<br>
−W ppp0<br>
<b>9.6.3.4. Optional arguments</b><br>
These arguments are sometimes very useful:<br>
<i>−b</i><br>
This is used for bidirectional mode. This flag matches traffic flowing in either direction between the<br>specified source and destination. This saves you from having to create two rules: one for the forward<br>direction of a connection and one for the reverse.<br>
<i>−o</i><br>
This enables logging of matching datagrams to the kernel log. Any datagram that matches this rule<br>will be logged as a kernel message. This is useful to enable you to detect unauthorized access.<br>
<i>−y</i><br>
This is used to match TCP connect datagrams. The option causes the rule to match only datagrams<br>that attempt to establish TCP connections. Only datagrams that have their SYN bit set, but their ACK<br>bit unset, will match. This is useful to filter TCP connection attempts and is ignored for other<br>
9.6.3.4. Optional arguments<br>
181<br>
<hr>
<A name=198></a>Linux Network Administrators Guide<br>
protocols.<br>
<i>−k</i><br>
This is used to match TCP acknowledgement datagrams. This option causes the rule to match only<br>datagrams that are acknowledgements to packets attempting to establish TCP connections. Only<br>datagrams that have their ACK bit set will match. This is useful to filter TCP connection attempts<br>and is ignored for all other protocols.<br>
<b>9.6.3.5. ICMP datagram types</b><br>
&nbsp;Each of the firewall configuration commands allows you to specify ICMP datagram types. Unlike TCP and<br>UDP ports, there is no convenient configuration file that lists the datagram types and their meanings. The<br>ICMP datagram types are defined in RFC−1700, the Assigned Numbers RFC. The ICMP datagram types are<br>also listed in one of the standard C library header files. The&nbsp;/usr/include/netinet/ip_icmp.h&nbsp;file,<br>which belongs to the GNU standard library package and is used by C programmers when writing network<br>software that uses the ICMP protocol, also defines the ICMP datagram types. For your convenience, we've<br>listed them in&nbsp;<a href="TLNAGs.html#198">Table 9−2. The&nbsp;</a><b>iptables</b>&nbsp;command interface allows you to specify ICMP types by name, so<br>we've listed the mnemonics it uses, as well.<br>
<b>Table 9−2. ICMP Datagram Types</b><br>
<b>Type Number&nbsp;iptables Mnemonic</b><br>
<b>Type Description</b><br>
0<br>
echo−reply<br>
Echo Reply<br>
3<br>
destination−unreachable&nbsp;Destination Unreachable<br>
4<br>
source−quench<br>
Source Quench<br>
5<br>
redirect<br>
Redirect<br>
8<br>
echo−request<br>
Echo Request<br>
11<br>
time−exceeded<br>
Time Exceeded<br>
12<br>
parameter−problem<br>
Parameter Problem<br>
13<br>
timestamp−request<br>
Timestamp Request<br>
14<br>
timestamp−reply<br>
Timestamp Reply<br>
15<br>
none<br>
Information Request<br>
16<br>
none<br>
Information Reply<br>
17<br>
address−mask−request<br>
Address Mask Request<br>
18<br>
address−mask−reply<br>
Address Mask Reply<br>
9.6.3.5. ICMP datagram types<br>
182<br>
<hr>
<A name=199></a><b>9.7. IP Firewall Chains (2.2 Kernels)</b><br>
Most aspects of Linux are evolving to meet the increasing demands of its users; IP firewall is no exception.<br>The traditional IP firewall implementation is fine for most applications, but can be clumsy and inefficient to<br>configure for complex environments. To solve this problem, a new method of configuring IP firewall and<br>related features was developed. This new method was called IP Firewall Chains and was first released for<br>general use in the 2.2.0 Linux kernel.<br>
&nbsp;The IP Firewall Chains support was developed by Paul Russell and Michael Neuling.&nbsp;[63]&nbsp;Paul has<br>documented the IP Firewall Chains software in the IPCHAINS−HOWTO.<br>
IP Firewall Chains allows you to develop classes of firewall rules to which you may then add and remove<br>hosts or networks. An artifact of firewall rule chaining is that it may improve firewall performance in<br>configurations in which there are lots of rules.<br>
IP Firewall Chains are supported by the 2.2 series kernels and are also available as a patch against the 2.0.*<br>kernels. The HOWTO describes where to obtain the patch and provides lots of useful hints about how to<br>effectively use the&nbsp;<b>ipchains</b>&nbsp;configuration utility.<br>
<b>9.7.1. Using ipchains</b><br>
&nbsp;There are two ways you can use the&nbsp;<b>ipchains</b>&nbsp;utility. The first way is to make use of the<br><b>ipfwadm−wrapper</b>&nbsp;shell script, which is mostly a drop−in replacement for&nbsp;<b>ipfwadm</b>&nbsp;that drives the<br><b>ipchains</b>&nbsp;program in the background. If you want to do this, then read no further. Instead, reread the previous<br>sections describing&nbsp;<b>ipfwadm</b>, and substitute&nbsp;<b>ipfwadm−wrapper</b>&nbsp;in its place. This will work, but there is no<br>guarantee that the script will be maintained, and you will not be taking advantage of any of the advanced<br>features that the IP Firewall Chains have to offer.<br>
The second way to use&nbsp;<b>ipchains</b>&nbsp;is to learn its new syntax and modify any existing configurations you have to<br>use the new syntax instead of the old. With some careful consideration, you may find you can optimize your<br>configuration as you convert. The&nbsp;<b>ipchains</b>&nbsp;syntax is easier to learn than the&nbsp;<b>ipfwadm</b>, so this is a good<br>option.<br>
The&nbsp;<b>ipfwadm</b>&nbsp;manipulated three rulesets for the purpose of configuring firewalling. With IP Firewall Chains<br>you can create arbitrary numbers of rulesets, each linked to one another, but there are three rulesets related to<br>firewalling that are always present. The standard rulesets are direct equivalents of those used with&nbsp;<b>ipfwadm</b>,<br>except they have names:&nbsp;input,&nbsp;forward&nbsp;and&nbsp;output.<br>
Let's first look at the general syntax of the&nbsp;<b>ipchains</b>&nbsp;command, then we'll look at how we'd use<br><b>ipchains</b>&nbsp;instead of&nbsp;<b>ipfwadm</b>&nbsp;without worrying about any of the advanced chaining features. We'll do this by<br>revisiting our previous examples.<br>
<b>9.7.2. ipchains Command Syntax</b><br>
The&nbsp;<b>ipchains</b>&nbsp;command syntax is straightforward. We'll now look at the most important of those. The<br>general syntax of most&nbsp;<b>ipchains</b>&nbsp;commands is:<br>
9.7. IP Firewall Chains (2.2 Kernels)<br>
183<br>
<hr>
<A name=200></a>Linux Network Administrators Guide<br>
<b>ipchains&nbsp;</b><i>command&nbsp;rule−specification&nbsp;options</i><br>
<b>9.7.2.1. Commands</b><br>
There are a number of ways we can manipulate rules and rulesets with the&nbsp;<b>ipchains</b>&nbsp;command. Those<br>relevant to IP firewalling are:<br>
<i>−A chain</i><br>
Append one or more rules to the end of the nominated chain. If a hostname is supplied as either<br>source or destination and it resolves to more than one IP address, a rule will be added for each<br>address.<br>
<i>−I chain rulenum</i><br>
Insert one or more rules to the start of the nominated chain. Again, if a hostname is supplied in the<br>rule specification, a rule will be added for each of the addresses it resolves to.<br>
<i>−D chain</i><br>
Delete one or more rules from the specified chain that matches the rule specification.<br>
<i>−D chain rulenum</i><br>
Delete the rule residing at position&nbsp;<i>rulenum</i>&nbsp;in the specified chain. Rule positions start at one for<br>the first rule in the chain.<br>
<i>−R chain rulenum</i><br>
Replace the rule residing at position&nbsp;<i>rulenum</i>&nbsp;in the specific chain with the supplied rule<br>specification.<br>
<i>−C chain</i><br>
Check the datagram described by the rule specification against the specific chain. This command will<br>return a message describing how the datagram was processed by the chain. This is very useful for<br>testing your firewall configuration, and we look at it in detail a little later.<br>
<i>−L [chain]</i><br>
List the rules of the specified chain, or for all chains if no chain is specified.<br>
<i>−F [chain]</i><br>
Flush the rules of the specified chain, or for all chains if no chain is specified.<br>
<i>−Z [chain]</i><br>
9.7.2.1. Commands<br>
184<br>
<hr>
<A name=201></a>Linux Network Administrators Guide<br>
Zero the datagram and byte counters for all rules of the specified chain, or for all chains if no chain is<br>specified.<br>
<i>−N chain</i><br>
Create a new chain with the specified name. A chain of the same name must not already exist. This is<br>how user−defined chains are created.<br>
<i>−X [chain]</i><br>
Delete the specified user−defined chain, or all user−defined chains if no chain is specified. For this<br>command to be successful, there must be no references to the specified chain from any other rules<br>chain.<br>
<i>−P chain policy</i><br>
Set the default policy of the specified chain to the specified policy. Valid firewalling policies are<br>ACCEPT,&nbsp;DENY,&nbsp;REJECT,&nbsp;REDIR, or&nbsp;RETURN.&nbsp;ACCEPT,&nbsp;DENY, and&nbsp;REJECT&nbsp;have the same<br>meanings as those for the tradition IP firewall implementation.&nbsp;REDIR&nbsp;specifies that the datagram<br>should be transparently redirected to a port on the firewall host. The&nbsp;RETURN&nbsp;target causes the IP<br>firewall code to return to the Firewall Chain that called the one containing this rule and continues<br>starting at the rule after the calling rule.<br>
<b>9.7.2.2. Rule specification parameters</b><br>
A number of&nbsp;<b>ipchains</b>&nbsp;parameters create a rule specification by determining what types of packets match. If<br>any of these parameters is omitted from a rule specification, its default is assumed:<br>
<i>−p [!]protocol</i><br>
Specifies the protocol of the datagram that will match this rule. Valid protocol names are&nbsp;tcp,&nbsp;udp,<br>icmp, or&nbsp;all. You may also specify a protocol number here to match other protocols. For example,<br>you might use&nbsp;4&nbsp;to match the&nbsp;ipip&nbsp;encapsulation protocol. If the&nbsp;!&nbsp;is supplied, the rule is negated<br>and the datagram will match any protocol other than the protocol specified. If this parameter isn't<br>supplied, it will default to&nbsp;all.<br>
<i>−s [!]address[/mask] [!] [port]</i><br>
Specifies the source address and port of the datagram that will match this rule. The address may be<br>supplied as a hostname, a network name, or an IP address. The optional&nbsp;mask&nbsp;is the netmask to use<br>and may be supplied either in the traditional form (e.g., /255.255.255.0) or the modern form (e.g.,<br>/24). The optional&nbsp;port&nbsp;specifies the TCP or UDP port, or the ICMP datagram type that will match.<br>You may supply a port specification only if you've supplied the&nbsp;−p&nbsp;parameter with one of the&nbsp;tcp,<br>udp, or&nbsp;icmp&nbsp;protocols. Ports may be specified as a range by specifying the upper and lower limits<br>of the range with a colon as a delimiter. For example,&nbsp;20:25&nbsp;described all of the ports numbered<br>from 20 up to and including 25. Again, the&nbsp;!&nbsp;character may be used to negate the values.<br>
9.7.2.2. Rule specification parameters<br>
185<br>
<hr>
<A name=202></a>Linux Network Administrators Guide<br>
<i>−d [!]address[/mask] [!] [port]</i><br>
Specifies the destination address and port of the datagram that will match this rule. The coding of this<br>parameter is the same as that of the&nbsp;−s&nbsp;parameter.<br>
<i>−j target</i><br>
Specifies the action to take when this rule matches. You can think of this parameter as meaning<br>jump to. Valid targets are&nbsp;ACCEPT,&nbsp;DENY,&nbsp;REJECT,&nbsp;REDIR, and&nbsp;RETURN. We described the<br>meanings of each of these targets earlier. However, you may also specify the name of a user−defined<br>chain where processing will continue. If this parameter is omitted, no action is taken on matching<br>rule datagrams at all other than to update the datagram and byte counters.<br>
<i>−i [!]interface−name</i><br>
Specifies the interface on which the datagram was received or is to be transmitted. Again, the<br>!&nbsp;inverts the result of the match. If the interface name ends with&nbsp;+, then any interface that begins<br>with the supplied string will match. For example,&nbsp;−i ppp+&nbsp;would match any PPP network device<br>and&nbsp;−i ! eth+&nbsp;would match all interfaces except Ethernet devices.<br>
<i>[!] −f</i><br>
Specifies that this rule applies to everything but the first fragment of a fragmented datagram.<br>
<b>9.7.2.3. Options</b><br>
The following&nbsp;<b>ipchains</b>&nbsp;options are more general in nature. Some of them control rather esoteric features of<br>the IP chains software:<br>
<i>−b</i><br>
Causes the command to generate two rules. One rule matches the parameters supplied, and the other<br>rule added matches the corresponding parameters in the reverse direction.<br>
<i>−v</i><br>
Causes&nbsp;<b>ipchains</b>&nbsp;to be verbose in its output. It will supply more information.<br>
<i>−n</i><br>
Causes&nbsp;<b>ipchains</b>&nbsp;to display IP address and ports as numbers without attempting to resolve them to<br>their corresponding names.<br>
<i>−l</i><br>
Enables kernel logging of matching datagrams. Any datagram that matches the rule will be logged by<br>the kernel using its&nbsp;printk()&nbsp;function, which is usually handled by the&nbsp;<b>sysklogd</b>&nbsp;program and<br>written to a log file. This is useful for making unusual datagrams visible.<br>
9.7.2.3. Options<br>
186<br>
<hr>
<A name=203></a>Linux Network Administrators Guide<br>
<i>−o[maxsize]</i><br>
Causes the IP chains software to copy any datagrams matching the rule to the userspace netlink<br>device. The maxsize argument limits the number of bytes from each datagram that are passed to the<br>netlink device. This option is of most use to software developers, but may be exploited by software<br>packages in the future.<br>
<i>−m markvalue</i><br>
Causes matching datagrams to be&nbsp;<i>marked</i>&nbsp;with a value. Mark values are unsigned 32−bit numbers. In<br>existing implementations this does nothing, but at some point in the future, it may determine how the<br>datagram is handled by other software such as the routing code. If a markvalue begins with a&nbsp;+&nbsp;or&nbsp;−,<br>the value is added or subtracted from the existing markvalue.<br>
<i>−t andmask xormask</i><br>
Enables you to manipulate the type of service bits in the IP header of any datagram that matches<br>this rule. The type of service bits are used by intelligent routers to prioritize datagrams before<br>forwarding them. The Linux routing software is capable of this sort prioritization. The&nbsp;<i>andmask</i>&nbsp;and<br><i>xormask</i>&nbsp;represent bit masks that will be logically ANDed and ORed with the type of service bits of<br>the datagram respectively. This is an advanced feature that is discussed in more detail in the<br>IPCHAINS−HOWTO.<br>
<i>−x</i><br>
Causes any numbers in the&nbsp;<b>ipchains</b>&nbsp;output to be expanded to their exact values with no rounding.<br>
<i>−y</i><br>
Causes the rule to match any TCP datagram with the SYN bit set and the ACK and FIN bits clear.<br>This is used to filter TCP connection requests.<br>
<b>9.7.3. Our Naïve Example Revisited</b><br>
Let's again suppose that we have a network in our organization and that we are using a Linux−based firewall<br>machine to allow our users access to WWW servers on the Internet, but to allow no other traffic to be passed.<br>
If our network has a 24−bit network mask (class C) and has an address of 172.16.1.0, we'd use the following<br><b>ipchains</b>&nbsp;rules:<br>
#&nbsp;<b>ipchains −F forward</b><br>
#&nbsp;<b>ipchains −P forward DENY</b><br>
#&nbsp;<b>ipchains −A forward −s 0/0 80 −d 172.16.1.0/24 −p tcp −y −j DENY</b><br>
#&nbsp;<b>ipchains −A forward −s 172.16.1.0/24 −d 0/0 80 −p tcp −b −j ACCEPT</b><br>
The first of the commands flushes all of the rules from the&nbsp;forward&nbsp;rulesets and the second set of<br>commands sets the default policy of the&nbsp;forward&nbsp;ruleset to&nbsp;DENY. Finally, the third and fourth commands<br>do the specific filtering we want. The fourth command allows datagrams to and from web servers on the<br>
9.7.3. Our Naïve Example Revisited<br>
187<br>
<hr>
<A name=204></a>Linux Network Administrators Guide<br>
outside of our network to pass, and the third prevents incoming TCP connections with a source port of 80.<br>
If we now wanted to add rules that allowed passive mode only access to FTP servers in the outside network,<br>we'd add these rules:<br>
#&nbsp;<b>ipchains −A forward −s 0/0 20 −d 172.16.1.0/24 −p tcp −y −j DENY</b><br>
#&nbsp;<b>ipchains −A forward −s 172.16.1.0/24 −d 0/0 20 −p tcp −b −j ACCEPT</b><br>
#&nbsp;<b>ipchains −A forward −s 0/0 21 −d 172.16.1.0/24 −p tcp −y −j DENY</b><br>
#&nbsp;<b>ipchains −A forward −s 172.16.1.0/24 −d 0/0 21 −p tcp −b −j ACCEPT</b><br>
<b>9.7.4. Listing Our Rules with ipchains</b><br>
To list our rules with&nbsp;<b>ipchains</b>, we use its&nbsp;−L&nbsp;argument. Just as with&nbsp;<b>ipfwadm</b>, there are arguments that<br>control the amount of detail in the output. In its simplest form,&nbsp;<b>ipchains</b>&nbsp;produces output that looks like:<br>
#&nbsp;<b>ipchains −L −n</b><br>
Chain input (policy ACCEPT):<br>
Chain forward (policy DENY):<br>
target &nbsp; &nbsp; prot opt &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination &nbsp; &nbsp; &nbsp; &nbsp; ports<br>
DENY &nbsp; &nbsp; &nbsp; tcp &nbsp;−y−−−− &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.1.0/24 &nbsp; &nbsp; &nbsp; 80 −&gt; &nbsp; *<br>
ACCEPT &nbsp; &nbsp; tcp &nbsp;−−−−−− &nbsp;172.16.1.0/24 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * −&gt; &nbsp; 80<br>
ACCEPT &nbsp; &nbsp; tcp &nbsp;−−−−−− &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.1.0/24 &nbsp; &nbsp; &nbsp; 80 −&gt; &nbsp; *<br>
ACCEPT &nbsp; &nbsp; tcp &nbsp;−−−−−− &nbsp;172.16.1.0/24 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * −&gt; &nbsp; 20<br>
ACCEPT &nbsp; &nbsp; tcp &nbsp;−−−−−− &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.1.0/24 &nbsp; &nbsp; &nbsp; 20 −&gt; &nbsp; *<br>
ACCEPT &nbsp; &nbsp; tcp &nbsp;−−−−−− &nbsp;172.16.1.0/24 &nbsp; &nbsp; &nbsp; 0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * −&gt; &nbsp; 21<br>
ACCEPT &nbsp; &nbsp; tcp &nbsp;−−−−−− &nbsp;0.0.0.0/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.1.0/24 &nbsp; &nbsp; &nbsp; 21 −&gt; &nbsp; *<br>
Chain output (policy ACCEPT):<br>
If you don't supply the name of a chain to list,&nbsp;<b>ipchains</b>&nbsp;will list all rules in all chains. The&nbsp;−n&nbsp;argument in<br>our example tells&nbsp;<b>ipchains</b>&nbsp;not to attempt to convert any address or ports into names. The information<br>presented should be self−explanatory.<br>
A verbose form, invoked by the&nbsp;−u&nbsp;option, provides much more detail. Its output adds fields for the datagram<br>and byte counters, Type of Service&nbsp;<i>AND</i>&nbsp;and&nbsp;<i>XOR</i>&nbsp;flags, the interface name, the mark, and the outsize.<br>
All rules created with&nbsp;<b>ipchains</b>&nbsp;have datagram and byte counters associated with them. This is how IP<br>Accounting is implemented and will be discussed in detail in&nbsp;<a href="TLNAGs.html#230">Chapter 10</a>. By default these counters are<br>presented in a rounded form using the suffixes&nbsp;K&nbsp;and&nbsp;M&nbsp;to represent units of one thousand and one million,<br>respectively. If the&nbsp;−x&nbsp;argument is supplied, the counters are expanded to their full unrounded form.<br>
<b>9.7.5. Making Good Use of Chains</b><br>
You now know that the&nbsp;<b>ipchains</b>&nbsp;command is a replacement for the&nbsp;<b>ipfwadm</b>&nbsp;with a simpler command−line<br>syntax and some interesting enhancements, but you're no doubt wanting to know where you'd use the<br>user−defined chains and why. You'll also probably want to know how to use the support scripts that<br>accompany the&nbsp;<b>ipchains</b>&nbsp;command in its software package. We'll now explore these subjects and address the<br>questions.<br>
9.7.4. Listing Our Rules with ipchains<br>
188<br>
<hr>
<A name=205></a><IMG src="TLNAG-205_1.png"><br>
Linux Network Administrators Guide<br>
<b>9.7.5.1. User−defined chains</b><br>
&nbsp;The three rulesets of the traditional IP firewall code provided a mechanism for building firewall<br>configurations that were fairly simple to understand and manage for small networks with simple firewalling<br>requirements. When the configuration requirements are not simple, a number of problems become apparent.<br>Firstly, large networks often require much more than the small number of firewalling rules we've seen so far;<br>inevitably needs arise that require firewalling rules added to cover special case scenarios. As the number of<br>rules grows, the performance of the firewall deterioriates as more and more tests are conducted on each<br>datagram and managability becomes an issue. Secondly, it is not possible to enable and disable sets of rules<br>atomically; instead, you are forced to expose yourself to attack while you are in the middle of rebuilding your<br>ruleset.<br>
The design of IP Firewall Chains helps to alleviate these problems by allowing the network administrator to<br>create arbitrary sets of firwewall rules that we can link to the three inbuilt rulesets. We can use the&nbsp;−N&nbsp;option<br>of&nbsp;<b>ipchains</b>&nbsp;to create a new chain with any name we please of eight characters or less. (Restricting the name<br>to lowercase letters only is probably a good idea.) The&nbsp;−j&nbsp;option configures the action to take when a<br>datagram matches the rule specification. The&nbsp;−j&nbsp;option specifies that if a datagram matches a rule, further<br>testing should be performed against a user−defined chain. We'll illustrate this with a diagram.<br>
Consider the following&nbsp;<b>ipchains</b>&nbsp;commands:<br>
ipchains −P input DENY<br>
ipchains −N tcpin<br>
ipchains −A tcpin −s ! 172.16.0.0/16<br>
ipchains −A tcpin −p tcp −d 172.16.0.0/16 ssh −j ACCEPT<br>
ipchains −A tcpin −p tcp −d 172.16.0.0/16 www −j ACCEPT<br>
ipchains −A input −p tcp −j tcpin<br>
ipchains −A input −p all<br>
We set the default input chain policy to&nbsp;deny. The second command creates a user−defined chain called<br>tcpin. The third command adds a rule to the&nbsp;tcpin&nbsp;chain that matches any datagram that was sourced<br>from outside our local network; the rule takes no action. This rule is an accounting rule and will be discussed<br><a href="TLNAGs.html#230">in more detail in&nbsp;Chapter 10. The next two rules match any datagram that is destined for our local network<br></a>and either of the&nbsp;ssh&nbsp;or&nbsp;www&nbsp;ports; datagrams matching these rules are accepted. The next rule is when the<br>real&nbsp;<i>ipchains</i>&nbsp;magic begins. It causes the firewall software to check any datagram of protocol TCP against the<br>tcpin user−defined chain. Lastly, we add a rule to our&nbsp;input&nbsp;chain that matches any datagram; this is<br>another accounting rule. They will produce the following Firewall Chains shown in Figure 9−4.<br>
<b>Figure 9−4. A simple IP chain ruleset</b><br>
Our&nbsp;input&nbsp;and&nbsp;tcpin&nbsp;chains are populated with our rules. Datagram processing always beings at one of<br>the inbuilt chains. We'll see how our user−defined chain is called into play by following the processing path<br>of different types of datagrams.<br>
9.7.5.1. User−defined chains<br>
189<br>
<hr>
<A name=206></a><IMG src="TLNAG-206_1.png"><br>
<IMG src="TLNAG-206_2.png"><br>
Linux Network Administrators Guide<br>
<a href="TLNAGs.html#206">First, let's look at what happens when a UDP datagram for one of our hosts is received.&nbsp;Figure 9−5&nbsp;illustrates<br></a>the flow through the rules.<br>
<b>Figure 9−5. The sequence of rules tested for a received UDP datagram</b><br>
The datagram is received by the&nbsp;input&nbsp;chain and falls through the first two rules because they match ICMP<br>and TCP protocols, respectively. It matches the third rule in the&nbsp;input&nbsp;chain, but it doesn't specify a target,<br>so its datagram and byte counters are updated, but no other action takes place. The datagram reaches the end<br>of the&nbsp;input&nbsp;chain, meets with the default&nbsp;input&nbsp;chain policy, and is denied.<br>
To see our user−defined chain in operation, let's now consider what happens when we receive a TCP<br>datagram destined for the&nbsp;ssh&nbsp;port of one of our hosts. The sequence is shown in&nbsp;<a href="TLNAGs.html#206">Figure 9−6</a>.<br>
<b>Figure 9−6. The rules flow for a received TCP datagram for ssh</b><br>
This time the second rule in the&nbsp;input&nbsp;chain does match and it specifies a target of&nbsp;tcpin, our<br>user−defined chain. Specifying a user−defined chain as a target causes the datagram to be tested against the<br>rules in that chain, so the next rule tested is the first rule in the&nbsp;tcpin&nbsp;chain. The first rule matches any<br>datagram that has a source address outside our local network and specifies no target, so it too is an accounting<br>rule and testing falls through to the next rule. The second rule in our&nbsp;tcpin&nbsp;chain does match and specifies a<br>target of&nbsp;ACCEPT. We have arrived at target, so no further firewall processing occurs. The datagram is<br>accepted.<br>
Finally, let's look at what happens when we reach the end of a user−defined chain. To see this, we'll map the<br>flow for a TCP datagram destined for a port other than than the two we are handling specifically, as shown in<br><a href="TLNAGs.html#206">Figure 9−7.</a><br>
<b>Figure 9−7. The rules flow for a received TCP datagram for telnet</b><br>
9.7.5.1. User−defined chains<br>
190<br>
<hr>
<A name=207></a><IMG src="TLNAG-207_1.png"><br>
Linux Network Administrators Guide<br>
The user−defined chains do not have default policies. When all rules in a user−defined chain have been<br>tested, and none have matched, the firewall code acts as though a&nbsp;RETURN&nbsp;rule were present, so if this isn't<br>what you want, you should ensure you supply a rule at the end of the user−defined chain that takes whatever<br>action you wish. In our example, our testing returns to the rule in the&nbsp;input&nbsp;ruleset immediately following<br>the one that moved us to our user−defined chain. Eventually we reach the end of the&nbsp;input&nbsp;chain, which<br>does have a default policy and our datagram is denied.<br>
This example is very simple, but illustrates our point. A more practical use of IP chains would be much more<br>complex. A slightly more sophisticated example is provided in the following list of commands:<br>
#<br>
# Set default forwarding policy to REJECT<br>
ipchains −P forward REJECT<br>
#<br>
# create our user−defined chains<br>
ipchains −N sshin<br>
ipchains −N sshout<br>
ipchains −N wwwin<br>
ipchains −N wwwout<br>
#<br>
# Ensure we reject connections coming the wrong way<br>
ipchains −A wwwin −p tcp −s 172.16.0.0/16 −y −j REJECT<br>
ipchains −A wwwout −p tcp −d 172.16.0.0/16 −y −j REJECT<br>
ipchains −A sshin −p tcp −s 172.16.0.0/16 −y −j REJECT<br>
ipchains −A sshout −p tcp −d 172.16.0.0/16 −y −j REJECT<br>
#<br>
# Ensure that anything reaching the end of a user−defined chain is rejected.<br>
ipchains −A sshin −j REJECT<br>
ipchains −A sshout −j REJECT<br>
ipchains −A wwwin −j REJECT<br>
ipchains −A wwwout −j REJECT<br>
#<br>
# divert www and ssh services to the relevant user−defined chain<br>
ipchains −A forward −p tcp −d 172.16.0.0/16 ssh −b −j sshin<br>
ipchains −A forward −p tcp −s 172.16.0.0/16 −d 0/0 ssh −b −j sshout<br>
ipchains −A forward −p tcp −d 172.16.0.0/16 www −b −j wwwin<br>
ipchains −A forward −p tcp −s 172.16.0.0/16 −d 0/0 www −b −j wwwout<br>
#<br>
# Insert our rules to match hosts at position two in our user−defined chains.<br>
ipchains −I wwwin 2 −d 172.16.1.2 −b −j ACCEPT<br>
ipchains −I wwwout 2 −s 172.16.1.0/24 −b −j ACCEPT<br>
ipchains −I sshin 2 −d 172.16.1.4 −b −j ACCEPT&nbsp;<br>
ipchains −I sshout 2 −s 172.16.1.4 −b −j ACCEPT<br>
ipchains −I sshout 2 −s 172.16.1.6 −b −j ACCEPT<br>
#<br>
In this example, we've used a selection of user−defined chains both to simplify management of our firewall<br>configuration and improve the efficiency of our firewall as compared to a solution involving only the built−in<br>
9.7.5.1. User−defined chains<br>
191<br>
<hr>
<A name=208></a>Linux Network Administrators Guide<br>
chains.<br>
Our example creates user−defined chains for each of the&nbsp;ssh&nbsp;and&nbsp;www&nbsp;services in each connection direction.<br>The chain called&nbsp;wwwout&nbsp;is where we place rules for hosts that are allowed to make outgoing World Wide<br>Web connections, and&nbsp;sshin&nbsp;is where we define rules for hosts to which we want to allow incoming ssh<br>connections. We've assumed that we have a requirement to allow and deny individual hosts on our network<br>the ability to make or receive&nbsp;ssh&nbsp;and&nbsp;www&nbsp;connections. The simplication occurs because the user−defined<br>chains allow us to neatly group the rules for the host incoming and outgoing permissions rather than<br>muddling them all together. The improvement in efficiency occurs because for any particular datagram, we<br>have reduced the average number of tests required before a target is found. The efficiency gain increases as<br>we add more hosts. If we hadn't used user−defined chains, we'd potentially have to search the whole list of<br>rules to determine what action to take with each and every datagram received. Even if we assume that each of<br>the rules in our list matches an equal proportion of the total number of datagrams processed, we'd still be<br>searching half the list on average. User−defined chains allow us to avoid testing large numbers of rules if the<br>datagram being tested doesn't match the simple rule in the built−in chain that jumps to them.<br>
<b>9.7.5.2. The ipchains support scripts</b><br>
The&nbsp;<b>ipchains</b>&nbsp;software package is supplied with three support scripts. The first of these we've discussed<br>briefly already, while the remaining two provide an easy and convenient means of saving and restoring your<br>firewall configuration.<br>
The&nbsp;<b>ipfwadm−wrapper</b>&nbsp;script emulates the command−line syntax of the&nbsp;<b>ipfwadm</b>&nbsp;command, but drives the<br><b>ipchains</b>&nbsp;command to build the firewall rules. This is a convenient way to migrate your existing firewall<br>configuration to the kernel or an alternative to learning the&nbsp;<b>ipchains</b>&nbsp;syntax. The&nbsp;<b>ipfwadm−wrapper</b>&nbsp;script<br>behaves differently from the&nbsp;<b>ipfwadm</b>&nbsp;command in two ways: firstly, because the&nbsp;<b>ipchains</b>&nbsp;command doesn't<br>support specification of an interface by address, the&nbsp;<b>ipfwadm−wrapper</b>&nbsp;script accepts an argument of&nbsp;−V&nbsp;but<br>attempts to convert it into the&nbsp;<b>ipchains</b>&nbsp;equivalent of a&nbsp;−W&nbsp;by searching for the interface name configured<br>with the supplied address. The&nbsp;<b>ipfwadm−wrapper</b>&nbsp;script will always provide a warning when you use the<br>−V&nbsp;option to remind you of this. Secondly, fragment accounting rules are not translated correctly.<br>
&nbsp;The&nbsp;<b>ipchains−save</b>&nbsp;and&nbsp;<b>ipchains−restore</b>&nbsp;scripts make building and modifying a firewall configuration<br>much simpler. The&nbsp;<b>ipchains−save</b>&nbsp;command reads the current firewall configuration and writes a simplified<br>form to the standard output. The&nbsp;<b>ipchains−restore</b>&nbsp;command reads data in the output format of the<br><b>ipchains−save</b>&nbsp;command and configures the IP firewall with these rules. The advantage of using these scripts<br>over directly modifying your firewall configuration script and testing the configuration is the ability to<br>dynamically build your configuration once and then save it. You can then restore that configuration, modify<br>it, and resave it as you please.<br>
To use the scripts, you'd enter something like:<br>
<b>ipchains−save&nbsp;&gt;/var/state/ipchains/firewall.state</b><br>
to save your current firewall configuration. You'd restore it, perhaps at boot time, with:<br>
<b>ipchains−restore&nbsp;&lt;/var/state/ipchains/firewall.state</b><br>
The&nbsp;<b>ipchains−restore</b>&nbsp;script checks if any user−defined chain listed in its input already exists. If you've<br>supplied the&nbsp;−f&nbsp;argument, it will automatically flush the rules from the user−defined chain before<br>configuring those in the input. The default behavior asks you whether to skip this chain or to flush it.<br>
9.7.5.2. The ipchains support scripts<br>
192<br>
<hr>
<A name=209></a>Linux Network Administrators Guide<br>
9.7.5.2. The ipchains support scripts<br>
193<br>
<hr>
<A name=210></a><b>9.8. Netfilter and IP Tables (2.4 Kernels)</b><br>
While developing IP Firewall Chains, Paul Russell decided that IP firewalling should be less difficult; he<br>soon set about the task of simplifying aspects of datagram processing in the kernel firewalling code and<br>produced a filtering framework that was both much cleaner and much more flexible. He called this new<br>framework&nbsp;<i>netfilter</i>.<br>
<b>Note:&nbsp;</b>At the time of preparation of this book the&nbsp;<i>netfilter</i>&nbsp;design had not yet stabilized. We<br>hope you'll forgive any errors in the description of&nbsp;<i>netfilter</i>&nbsp;or its associated configuration<br>tools that result from changes that occurred after preparation of this material. We considered<br>the&nbsp;<i>netfilter</i>&nbsp;work important enough to justify the inclusion of this material, despite parts of it<br>being speculative in nature. If you're in any doubt, the relevant HOWTO documents will<br>contain the most accurate and up−to−date information on the detailed issues associated with<br>the&nbsp;<i>netfilter</i>&nbsp;configuration.<br>
So what was wrong with IP chains? They vastly improved the efficiency and management of firewall rules.<br>But the way they processed datagrams was still complex, especially in conjunction with firewall−related<br>features like IP masquerade (discussed in&nbsp;<a href="TLNAGs.html#243">Chapter 11</a>) and other forms of address translation. Part of this<br>complexity existed because IP masquerade and Network Address Translation were developed independently<br>of the IP firewalling code and integrated later, rather than having been designed as a true part of the firewall<br>code from the start. If a developer wanted to add yet more features in the datagram processing sequence, he<br>would have had difficulty finding a place to insert the code and would have been forced to make changes in<br>the kernel in order to do so.<br>
Still, there were other problems. In particular, the input chain described input to the IP networking layer as<br>a whole. The input chain affected both datagrams to be&nbsp;<i>destined for</i>&nbsp;this host and datagrams to be&nbsp;<i>routed<br>by</i>&nbsp;this host. This was somewhat counterintuitive because it confused the function of the input chain with that<br>of the forward chain, which applied only to datagrams to be forwarded, but which always followed the input<br>chain. If you wanted to treat datagrams for this host differently from datagrams to be forwarded, it was<br>necessary to build complex rules that excluded one or the other. The same problem applied to the output<br>chain.<br>
Inevitably some of this complexity spilled over into the system administrator's job because it was reflected in<br>the way that rulesets had to be designed. Moreover, any extensions to filtering required direct modifications<br>to the kernel, because all filtering policies were implemented there and there was no way of providing a<br>transparent interface into it.&nbsp;<i>netfilter</i>&nbsp;addresses both the complexity and the rigidity of older solutions by<br>implementing a generic framework in the kernel that streamlines the way datagrams are processed and<br>provides a capability to extend filtering policy without having to modify the kernel.<br>
Let's take a look at two of the key changes made.&nbsp;&nbsp;<a href="TLNAGs.html#211">Figure 9−8</a>&nbsp;illustrates how datagrams are processed in the<br><a href="TLNAGs.html#211">IP chains implementation, while&nbsp;Figure 9−9&nbsp;illustrates how they are processed in the<br></a><i>netfilter</i>&nbsp;implementation. The key differences are the removal of the masquerading function from the core<br>code and a change in the locations of the input and output chains. To accompany these changes, a new and<br>extensible configuration tool called&nbsp;<b>iptables</b>&nbsp;was created.<br>
In IP chains, the input chain applies to all datagrams received by the host, irrespective of whether they are<br>destined for the local host or routed to some other host. In&nbsp;<i>netfilter</i>, the input chain applies&nbsp;<i>only</i>&nbsp;to datagrams<br>destined for the local host, and the forward chain applies only to datagrams destined for&nbsp;<i>another</i>&nbsp;host.<br>Similarly, in IP chains, the output chain applies to all datagrams leaving the local host, irrespective of<br>whether the datagram is generated on the local host or routed from some other host. In&nbsp;<i>netfilter</i>, the output<br>
9.8. Netfilter and IP Tables (2.4 Kernels)<br>
194<br>
<hr>
<A name=211></a><IMG src="TLNAG-211_1.png"><br>
<IMG src="TLNAG-211_2.png"><br>
Linux Network Administrators Guide<br>
chain applies&nbsp;<i>only</i>&nbsp;to datagrams generated on this host and does not apply to datagrams being routed from<br>another host. This change alone offers a huge simplification of many firewall configurations.<br>
<b>Figure 9−8. Datagram processing chain in IP chains</b><br>
In&nbsp;<a href="TLNAGs.html#211">Figure 9−8, the components labeled demasq and masq are separate kernel components responsible<br></a>for the incoming and outgoing processing of masqueraded datagrams. These have been reimplemented as<br><i>netfilter</i>&nbsp;modules.<br>
Consider the case of a configuration for which the default policy for each of the input, forward, and output<br>chains is&nbsp;deny. In IP chains, six rules would be needed to allow any session through a firewall host: two<br>each in the input, forward, and output chains (one would cover each forward path and one would cover each<br>return path). You can imagine how this could easily become extremely complex and difficult to manage when<br>you want to mix sessions that could be routed and sessions that could connect to the local host without being<br>routed. IP chains allow you to create chains that would simplify this task a little, but the design isn't obvious<br>and requires a certain level of expertise.<br>
In the&nbsp;<i>netfilter</i>&nbsp;implementation with&nbsp;<b>iptables</b>, this complexity disappears completely. For a service to be<br>routed across the firewall host, but not terminate on the local host, only two rules are required: one each for<br>the forward and the reverse directions in the forward chain. This is the obvious way to design firewalling<br>rules, and will serve to simplify the design of firewall configurations immensely.<br>
<b>Figure 9−9. Datagram processing chain in netfilter</b><br>
&nbsp;The PACKET−FILTERING−HOWTO offers a detailed list of the changes that have been made, so let's<br>focus on the more practical aspects here.<br>
9.8. Netfilter and IP Tables (2.4 Kernels)<br>
195<br>
<hr>
<A name=212></a>Linux Network Administrators Guide<br>
<b>9.8.1. Backward Compatability with ipfwadmand ipchains</b><br>
The remarkable flexibility of Linux&nbsp;<i>netfilter</i>&nbsp;is illustrated by its ability to emulate the&nbsp;<b>ipfwadm</b>&nbsp;and<br><b>ipchains</b>&nbsp;interfaces. Emulation makes transition to the new generation of firewall software a little easier.<br>
The two&nbsp;<i>netfilter</i>&nbsp;kernel modules called&nbsp;ipfwadm.o&nbsp;and&nbsp;ipchains.o&nbsp;provide backward compatibility<br>for&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>ipchains</b>. You may load only one of these modules at a time, and use one only if the<br>ip_tables.o&nbsp;module is not loaded. When the appropriate module is loaded,&nbsp;<i>netfilter</i>&nbsp;works exactly like<br>the former firewall implementation.<br>
<i>netfilter</i>&nbsp;mimics the&nbsp;<b>ipchains</b>&nbsp;interface with the following commands:<br>
rmmod ip_tables<br>
modprobe ipchains<br>
ipchains&nbsp;<i>...</i><br>
<b>9.8.2. Using iptables</b><br>
The&nbsp;<b>iptables</b>&nbsp;utility is used to configure&nbsp;<i>netfilter</i>&nbsp;filtering rules. Its syntax borrows heavily from the<br><b>ipchains</b>&nbsp;command, but differs in one very significant respect: it is&nbsp;<i>extensible</i>. What this means is that its<br>functionality can be extended without recompiling it. It manages this trick by using shared libraries. There are<br>standard extensions and we'll explore some of them in a moment.<br>
Before you can use the&nbsp;<b>iptables</b>&nbsp;command, you must load the&nbsp;<i>netfilter</i>&nbsp;kernel module that provides support<br>for it. The easiest way to do this is to use the&nbsp;<b>modprobe</b>&nbsp;command as follows:<br>
modprobe ip_tables<br>
The&nbsp;<b>iptables</b>&nbsp;command is used to configure both IP filtering and Network Address Translation. To facilitate<br>this, there are two tables of rules called&nbsp;<i>filter</i>&nbsp;and&nbsp;<i>nat</i>. The filter table is assumed if you do not specify the<br>−t&nbsp;option to override it. Five built−in chains are also provided. The&nbsp;INPUT&nbsp;and&nbsp;FORWARD&nbsp;chains are<br>available for the&nbsp;filter&nbsp;table, the&nbsp;PREROUTING&nbsp;and&nbsp;POSTROUTING&nbsp;chains are available for the<br>nat&nbsp;table, and the&nbsp;OUTPUT&nbsp;chain is available for both tables. In this chapter we'll discuss only the<br><i>filter</i>&nbsp;table. We'll look at the&nbsp;<i>nat</i>&nbsp;table in&nbsp;<a href="TLNAGs.html#243">Chapter 11</a><br>
The general syntax of most&nbsp;<b>iptables</b>&nbsp;commands is:<br>
<b>iptables&nbsp;</b><i>command&nbsp;rule−specification&nbsp;extensions</i><br>
Now we'll take a look at some options in detail, after which we'll review some examples.<br>
<b>9.8.2.1. Commands</b><br>
There are a number of ways we can manipulate rules and rulesets with the&nbsp;<b>iptables</b>&nbsp;command. Those relevant<br>to IP firewalling are:<br>
9.8.1. Backward Compatability with ipfwadmand ipchains<br>
196<br>
<hr>
<A name=213></a>Linux Network Administrators Guide<br>
<i>−A chain</i><br>
Append one or more rules to the end of the nominated chain. If a hostname is supplied as either a<br>source or destination and it resolves to more than one IP address, a rule will be added for each<br>address.<br>
<i>−I chain rulenum</i><br>
Insert one or more rules to the start of the nominated chain. Again, if a hostname is supplied in the<br>rule specification, a rule will be added for each of the addresses to which it resolves.<br>
<i>−D chain</i><br>
Delete one or more rules from the specified chain matching the rule specification.<br>
<i>−D chain rulenum</i><br>
Delete the rule residing at position&nbsp;<i>rulenum</i>&nbsp;in the specified chain. Rule positions start at 1 for the<br>first rule in the chain.<br>
<i>−R chain rulenum</i><br>
Replace the rule residing at position&nbsp;<i>rulenum</i>&nbsp;in the specific chain with the supplied rule<br>specification.<br>
<i>−C chain</i><br>
Check the datagram described by the rule specification against the specific chain. This command will<br>return a message describing how the chain processed the datagram. This is very useful for testing<br>your firewall configuration and we will look at it in detail later.<br>
<i>−L [chain]</i><br>
List the rules of the specified chain, or for all chains if no chain is specified.<br>
<i>−F [chain]</i><br>
Flush the rules of the specified chain, or for all chains if no chain is specified.<br>
<i>−Z [chain]</i><br>
Zero the datagram and byte counters for all rules of the specified chain, or for all chains if no chain is<br>specified.<br>
<i>−N chain</i><br>
Create a new chain with the specified name. A chain of the same name must not already exist. This is<br>how user−defined chains are created.<br>
<i>−X [chain]</i><br>
9.8.1. Backward Compatability with ipfwadmand ipchains<br>
197<br>
<hr>
<A name=214></a>Linux Network Administrators Guide<br>
Delete the specified user−defined chain, or all user−defined chains if no chain is specified. For this<br>command to be successful, there must be no references to the specified chain from any other rules<br>chain.<br>
<i>−P chain policy</i><br>
Set the default policy of the specified chain to the specified policy. Valid firewalling policies are<br>ACCEPT,&nbsp;DROP,&nbsp;QUEUE, and&nbsp;RETURN.&nbsp;ACCEPT&nbsp;allows the datagram to pass.&nbsp;DROP&nbsp;causes the<br>datagram to be discarded.&nbsp;QUEUE&nbsp;causes the datagram to be passed to userspace for further<br>processing. The&nbsp;RETURN&nbsp;target causes the IP firewall code to return to the Firewall Chain that called<br>the one containing this rule, and continue starting at the rule after the calling rule.<br>
<b>9.8.2.2. Rule specification parameters</b><br>
There are a number of&nbsp;<b>iptables</b>&nbsp;parameters that constitute a rule specification. Wherever a rule specification<br>is required, each of these parameters must be supplied or their default will be assumed.<br>
<i>−p [!]protocol</i><br>
Specifies the protocol of the datagram that will match this rule. Valid protocol names are&nbsp;tcp,&nbsp;udp,<br>icmp, or a number, if you know the IP protocol number.[64]&nbsp;For example, you might use&nbsp;4&nbsp;to match<br>the&nbsp;ipip&nbsp;encapsulation protocol. If the&nbsp;!&nbsp;character is supplied, the rule is negated and the datagram<br>will match any protocol other than the specified protocol. If this parameter isn't supplied, it will<br>default to match all protocols.<br>
<i>−s [!]address[/mask]</i><br>
Specifies the source address of the datagram that will match this rule. The address may be supplied as<br>a hostname, a network name, or an IP address. The optional&nbsp;mask&nbsp;is the netmask to use and may be<br>supplied either in the traditional form (e.g., /255.255.255.0) or in the modern form (e.g., /24).<br>
<i>−d [!]address[/mask]</i><br>
Specifies the destination address and port of the datagram that will match this rule. The coding of this<br>parameter is the same as that of the&nbsp;−s&nbsp;parameter.<br>
<i>−j target</i><br>
Specifies what action to take when this rule matches. You can think of this parameter as meaning<br>jump to. Valid targets are&nbsp;ACCEPT,&nbsp;DROP,&nbsp;QUEUE, and&nbsp;RETURN. We described the meanings of<br>each of these previously in the &quot;Commands&quot; section. You may also specify the name of a<br>user−defined chain where processing will continue. You may also supply the name of a target<br>supplied by an extension. We'll talk about extensions shortly. If this parameter is omitted, no action is<br>taken on matching datagrams at all, other than to update the datagram and byte counters of this rule.<br>
<i>−i [!]interface−name</i><br>
9.8.2.2. Rule specification parameters<br>
198<br>
<hr>
<A name=215></a>Linux Network Administrators Guide<br>
Specifies the interface on which the datagram was received. Again, the&nbsp;!&nbsp;inverts the result of the<br>match. If the interface name ends with&nbsp;+&nbsp;then any interface that begins with the supplied string<br>will match. For example,&nbsp;−i ppp+&nbsp;would match any PPP network device and&nbsp;−i ! eth+&nbsp;would<br>match all interfaces except ethernet devices.<br>
<i>−o [!]interface−name</i><br>
Specifies the interface on which the datagram is to be transmitted. This argument has the same<br>coding as the&nbsp;−i&nbsp;argument.<br>
<i>[!] −f</i><br>
Specifies that this rule applies only to the second and later fragments of a fragmented datagram, not<br>to the first fragment.<br>
<b>9.8.2.3. Options</b><br>
The following&nbsp;<b>iptables</b>&nbsp;options are more general in nature. Some of them control rather esoteric features of<br>the&nbsp;<i>netfilter</i>&nbsp;software.<br>
<i>−v</i><br>
causes&nbsp;<b>iptables</b>&nbsp;to be verbose in its output; it will supply more information.<br>
<i>−n</i><br>
causes&nbsp;<b>iptables</b>&nbsp;to display IP address and ports as numbers without attempting to resolve them to<br>their corresponding names.<br>
<i>−x</i><br>
causes any numbers in the&nbsp;<b>iptables</b>&nbsp;output to be expanded to their exact values with no rounding.<br>
<i>− −line−numbers</i><br>
causes line numbers to be displayed when listing rulesets. The line number will correspond to the<br>rule's position within the chain.<br>
<b>9.8.2.4. Extensions</b><br>
We said earlier that the&nbsp;<b>iptables</b>&nbsp;utility is extensible through optional shared library modules. There are<br>some standard extensions that provide some of the features&nbsp;<b>ipchains</b>&nbsp;provided. To make use of an extension,<br>you must specify its name through the&nbsp;−m<i>&nbsp;name</i>&nbsp;argument to&nbsp;<b>iptables</b>. The following list shows the&nbsp;−m&nbsp;and<br>−p&nbsp;options that set up the extension's context, and the options provided by that extension.<br>
9.8.2.3. Options<br>
199<br>
<hr>
<A name=216></a>Linux Network Administrators Guide<br>
<b>9.8.2.4.1. TCP Extensions: used with −m tcp −p tcp</b><br>
<i>− −sport [!] [port[:port]]</i><br>
Specifies the port that the datagram source must be using to match this rule. Ports may be specified as<br>a range by specifying the upper and lower limits of the range using the colon as a delimiter. For<br>example,&nbsp;20:25&nbsp;described all of the ports numbered 20 up to and including 25. Again, the<br>!&nbsp;character may be used to negate the values.<br>
<i>− −dport [!] [port[:port]]</i><br>
Specifies the port that the datagram destination must be using to match this rule. The argument is<br>coded identically to the&nbsp;− −sport&nbsp;option.<br>
<i>− −tcp−flags [!] mask comp</i><br>
Specifies that this rule should match when the TCP flags in the datagram match those specified by<br><i>mask</i>&nbsp;and&nbsp;<i>comp</i>.&nbsp;<i>mask</i>&nbsp;is a comma−separated list of flags that should be examined when making the<br>test.&nbsp;<i>comp</i>&nbsp;is a comma−separated list of flags that must be set for the rule to match. Valid flags are:<br><i>SYN</i>,&nbsp;<i>ACK</i>,&nbsp;<i>FIN</i>,&nbsp;<i>RST</i>,&nbsp;<i>URG</i>,&nbsp;<i>PSH</i>,&nbsp;<i>ALL</i>&nbsp;or&nbsp;<i>NONE</i>. This is an advanced option: refer to a good<br>description of the TCP protocol, such as RFC−793, for a description of the meaning and implication<br>of each of these flags. The&nbsp;!&nbsp;character negates the rule.<br>
<i>[!] − −syn</i><br>
Specifies the rule to match only datagrams with the&nbsp;SYN&nbsp;bit set and the&nbsp;ACK&nbsp;and&nbsp;FIN&nbsp;bits cleared.<br>Datagrams with these options are used to open TCP connections, and this option can therefore be<br>used to manage connection requests. This option is shorthand for:<br>
− −tcp−flags SYN,RST,ACK SYN<br>
When you use the negation operator, the rule will match all datagrams that do not have both the&nbsp;SYN&nbsp;and<br>ACK&nbsp;bits set.<br>
<b>9.8.2.4.2. UDP Extensions: used with −m udp −p udp</b><br>
<i>− −sport [!] [port[:port]]</i><br>
Specifies the port that the datagram source must be using to match this rule. Ports may be specified as<br>a range by specifying the upper and lower limits of the range using the colon as a delimiter. For<br>example,&nbsp;20:25&nbsp;describes all of the ports numbered 20 up to and including 25. Again, the<br>!&nbsp;character may be used to negate the values.<br>
<i>− −dport [!] [port[:port]]</i><br>
Specifies the port that the datagram destination must be using to match this rule. The argument is<br>coded identically to the&nbsp;− −sport&nbsp;option.<br>
9.8.2.4. Extensions<br>
200<br>
<hr>
<A name=217></a>Linux Network Administrators Guide<br>
<b>9.8.2.4.3. ICMP Extensions: used with&nbsp;−m icmp −p icmp</b><br>
<i>− −icmp−type [!] typename</i><br>
Specifies the ICMP message type that this rule will match. The type may be specified by number or<br>name. Some valid names are:&nbsp;echo−request,&nbsp;echo−reply,&nbsp;source−quench,<br>time−exceeded,&nbsp;destination−unreachable,&nbsp;network−unreachable,<br>host−unreachable,&nbsp;protocol−unreachable, and&nbsp;port−unreachable.<br>
<b>9.8.2.4.4. MAC Extensions: used with&nbsp;−m mac</b><br>
<i>− −mac−source [!] address</i><br>
Specifies the host's Ethernet address that transmitted the datagram that this rule will match. This only<br>makes sense in a rule in the input or forward chains because we will be transmitting any datagram<br>that passes the output chain.<br>
<b>9.8.3. Our Naïve Example Revisited, Yet Again</b><br>
To implement our naïve example using the&nbsp;<i>netfilter</i>, you could simply load the&nbsp;ipchains.o&nbsp;module and<br>pretend it is the&nbsp;<b>ipchains</b>&nbsp;version. Instead, we'll reimplement it using&nbsp;<b>iptables</b>&nbsp;to illustrate how similar it is.<br>
Yet again, let's suppose that we have a network in our organization and that we are using a Linux−based<br>firewall machine to allow our users to be able to access WWW servers on the Internet, but to allow no other<br>traffic to be passed.<br>
If our network has a 24−bit network mask (class C) and has an address of 172.16.1.0, then we'd use the<br>following&nbsp;<b>iptables</b>&nbsp;rules:<br>
#&nbsp;<b>modprobe ip_tables</b><br>
#&nbsp;<b>iptables −F FORWARD</b><br>
#&nbsp;<b>iptables −P FORWARD DROP</b><br>
#&nbsp;<b>iptables −A FORWARD −m tcp −p tcp −s 0/0 −−sport 80 −d 172.16.1.0/24 /</b><br>
<b>&nbsp; &nbsp; −−syn −j DROP</b><br>
#&nbsp;<b>iptables −A FORWARD −m tcp −p tcp −s 172.16.1.0/24 −−sport /</b><br>
<b>&nbsp; &nbsp; 80 −d 0/0 −j ACCEPT</b><br>
#&nbsp;<b>iptables −A FORWARD −m tcp −p tcp −d 172.16.1.0/24 −−dport 80 −s 0/0 −j /</b><br>
<b>&nbsp; &nbsp; ACCEPT</b><br>
In this example the&nbsp;<b>iptables</b>&nbsp;commands are interpreted exactly as the equivalent&nbsp;<b>ipchains</b>&nbsp;commands. The<br>major exception that the&nbsp;ip_tables.o&nbsp;module must load. Note that&nbsp;<b>iptables</b>&nbsp;doesn't support the&nbsp;−b&nbsp;option,<br>so we must supply a rule for each direction.<br>
9.8.2.4. Extensions<br>
201<br>
<hr>
<A name=218></a><b>9.9. TOS Bit Manipulation</b><br>
&nbsp;The Type Of Service (TOS) bits are a set of four−bit flags in the IP header. When any one of these bit flags<br>is set, routers may handle the datagram differently than datagrams with no TOS bits set. Each of the four bits<br>has a different purpose and only one of the TOS bits may be set at any time, so combinations are not allowed.<br>The bit flags are called Type of Service bits because they enable the application transmitting the data to tell<br>the network the type of network service it requires.<br>
The classes of network service available are:<br>
<i>Minimum delay</i><br>
Used when the time it takes for a datagram to travel from the source host to destination host (latency)<br>is most important. A network provider might, for example, use both optical fiber and satellite<br>network connections. Data carried across satellite connections has farther to travel and their latency is<br>generally therefore higher than for terrestrial−based network connections between the same<br>endpoints. A network provider might choose to ensure that datagrams with this type of service set are<br>not carried by satellite.<br>
<i>Maximum throughput</i><br>
Used when the volume of data transmitted in any period of time is important. There are many types<br>of network applications for which latency is not particularly important but the network throughput is;<br>for example, bulk−file transfers. A network provider might choose to route datagrams with this type<br>of service set via high−latency, high−bandwidth routes, such as satellite connections.<br>
<i>Maximum reliability</i><br>
Used when it is important that you have some certainty that the data will arrive at the destination<br>without retransmission being required. The IP protocol may be carried over any number of<br>underlying transmission mediums. While SLIP and PPP are adequate datalink protocols, they are not<br>as reliable as carrying IP over some other network, such as an X.25 network. A network provider<br>might make an alternate network available, offering high reliability, to carry IP that would be used if<br>this type of service is selected.<br>
<i>Minimum cost</i><br>
Used when it is important to minimize the cost of data transmission. Leasing bandwidth on a satellite<br>for a transpacific crossing is generally less costly than leasing space on a fiber−optical cable over the<br>same distance, so network providers may choose to provide both and charge differently depending on<br>which you use. In this scenario, your minimum cost type of service bit may cause your datagrams<br>to be routed via the lower−cost satellite route.<br>
<b>9.9.1. Setting the TOS Bits Using ipfwadm or ipchains</b><br>
&nbsp;The&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>ipchains</b>&nbsp;commands deal with the TOS bits in much the same manner. In both cases you<br>specify a rule that matches the datagrams with particular TOS bits set, and use the&nbsp;−t&nbsp;argument to specify the<br>change you wish to make.<br>
9.9. TOS Bit Manipulation<br>
202<br>
<hr>
<A name=219></a>Linux Network Administrators Guide<br>
The changes are specified using two−bit masks. The first of these bit masks is logically ANDed with the IP<br>options field of the datagram and the second is logically eXclusive−ORd with it. If this sounds complicated,<br>we'll give you the recipes required to enable each of the types of service in a moment.<br>
The bit masks are specified using eight−bit hexadecimal values. Both&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>ipchains</b>&nbsp;use the same<br>argument syntax:<br>
−t&nbsp;<i>andmask&nbsp;xormask</i><br>
Fortunately the same mask arguments can be used each time you wish to set a particular type of service, to<br><a href="TLNAGs.html#219">save you having to work them out. They are presented with some suggested uses in&nbsp;Table 9−3</a>.<br>
<b>Table 9−3. Suggested Uses for TOS Bitmasks</b><br>
<b>TOS</b><br>
<b>ANDmask&nbsp;XORmask&nbsp;Suggested Use</b><br>
Minimum Delay<br>
0x01<br>
0x10<br>
ftp, telnet, ssh<br>
Maximum Throughput&nbsp;0x01<br>
0x08<br>
ftp−data, www<br>
Maximum Reliability<br>
0x01<br>
0x04<br>
snmp, dns<br>
Minimum Cost<br>
0x01<br>
0x02<br>
nntp, smtp<br>
<b>9.9.2. Setting the TOS Bits Using iptables</b><br>
The&nbsp;<b>iptables</b>&nbsp;tool allows you to specify rules that capture only datagrams with TOS bits matching some<br>predetermined value using the&nbsp;−m tos&nbsp;option, and for setting the TOS bits of IP datagrams matching a rule<br>using the&nbsp;−j TOS&nbsp;target. You may set TOS bits only on the&nbsp;FORWARD&nbsp;and&nbsp;OUTPUT&nbsp;chains. The matching<br>and the setting occur quite independently. You can configure all sort of interesting rules. For example, you<br>can configure a rule that discads all datagrams with certain TOS bit combinations, or a rule that sets the TOS<br>bits of datagrams only from certain hosts. Most often you will use rules that contain both matching and<br>setting to perform TOS bit translations, just as you could for&nbsp;<b>ipfwadm</b>&nbsp;or&nbsp;<b>ipchains</b>.<br>
Rather than the complicated two−mask configuration of&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>ipchains</b>,&nbsp;<b>iptables</b>&nbsp;uses the simpler<br>approach of plainly specifying what the TOS bits should match, or to what the TOS bits should be set.<br>Additionally, rather than having to remember and use the hexadecimal value, you may specify the TOS bits<br>using the more friendly mnemonics listed in the upcoming table.<br>
The general syntax used to match TOS bits looks like:<br>
−m tos −−tos&nbsp;<i>mnemonic</i>&nbsp;[<i>other−args</i>] −j&nbsp;<i>target</i><br>
The general syntax used to set TOS bits looks like:<br>
[<i>other−args</i>] −j TOS −−set&nbsp;<i>mnemonic</i><br>
9.9.2. Setting the TOS Bits Using iptables<br>
203<br>
<hr>
<A name=220></a>Linux Network Administrators Guide<br>
Remember that these would typically be used together, but they can be used quite independently if you have a<br>configuration that requires it.<br>
<b>Mnemonic</b><br>
<b>Hexadecimal</b><br>
Normal−Service<br>
0x00<br>
Minimize−Cost<br>
0x02<br>
Maximize−Reliability<br>
0x04<br>
Maximize−Throughput&nbsp;0x08<br>
Minimize−Delay<br>
0x10<br>
9.9.2. Setting the TOS Bits Using iptables<br>
204<br>
<hr>
<A name=221></a><b>9.10. Testing a Firewall Configuration</b><br>
After you've designed an appropriate firewall configuration, it's important to validate that it does in fact do<br>what you want it to do. One way to do this is to use a test host outside your network to attempt to pierce your<br>firewall: this can be quite clumsy and slow, though, and is limited to testing only those addresses that you can<br>actually use.<br>
A faster and easier method is available with the Linux firewall implementation. It allows you to manually<br>generate tests and run them through the firewall configuration just as if you were testing with actual<br>datagrams. All varieties of the Linux kernel firewall software,&nbsp;<b>ipfwadm</b>,&nbsp;<b>ipchains</b>, and&nbsp;<b>iptables</b>, provide<br>support for this style of testing. The implementation involves use of the relevant&nbsp;<i>check</i>&nbsp;command.<br>
The general test procedure is as follows:<br>
Design and configure your firewall using&nbsp;<br>
1.&nbsp;<br>
<b>ipfwadm</b>,&nbsp;<b>ipchains</b>, or&nbsp;<b>iptables</b>.<br>
Design a series of tests that will determine whether your firewall is actually working as you intend.<br>
2.&nbsp;<br>
For these tests you may use any source or destination address, so choose some address combinations<br>that should be accepted and some others that should be dropped. If you're allowing or disallowing<br>only certain ranges of addresses, it is a good idea to test addresses on either side of the boundary of<br>the rangeone address just inside the boundary and one address just outside the boundary. This will<br>help ensure that you have the correct boundaries configured, because it is sometimes easy to specify<br>netmasks incorrectly in your configuration. If you're filtering by protocol and port number, your tests<br>should also check all important combinations of these parameters. For example, if you intend to<br>accept only TCP under certain circumstances, check that UDP datagrams are dropped.<br>Develop&nbsp;<br>
3.&nbsp;<br>
<b>ipfwadm</b>,&nbsp;<b>ipchains</b>, or&nbsp;<b>iptables</b>&nbsp;rules to implement each test. It is probably worthwhile to<br>
write all the rules into a script so you can test and re−test easily as you correct mistakes or change<br>your design. Tests use almost the same syntax as rule specifications, but the arguments take on<br>slightly differing meanings. For example, the source address argument in a rule specification<br>specifies the source address that datagrams matching this rule should have. The source address<br>argument in test syntax, in contrast, specifies the source address of the test datagram that will be<br>generated. For&nbsp;<b>ipfwadm</b>, you must use the&nbsp;−c&nbsp;option to specify that this command is a test, while for<br><b>ipchains</b>&nbsp;and&nbsp;<b>iptables</b>, you must use the&nbsp;−C&nbsp;option. In all cases you must&nbsp;<i>always</i>&nbsp;specify the source<br>address, destination address, protocol, and interface to be used for the test. Other arguments, such as<br>port numbers or TOS bit settings, are optional.<br>Execute each test command and note the output. The output of each test will be a single word<br>
4.&nbsp;<br>
indicating the final target of the datagram after running it through the firewall configurationthat is,<br>where the processing ended. For&nbsp;<b>ipchains</b>&nbsp;and&nbsp;<b>iptables</b>, user−specified chains will be tested in<br>addition to the built−in ones.<br>Compare the output of each test against the desired result. If there are any discrepancies, you will<br>
5.&nbsp;<br>
need to analyse your ruleset to determine where you've made the error. If you've written your test<br>commands into a script file, you can easily rerun the test after correcting any errors in your firewall<br>configuration. It's a good practice to flush your rulesets completely and rebuild them from scratch,<br>rather than to make changes dynamically. This helps ensure that the active configuration you are<br>testing actually reflects the set of commands in your configuration script.<br>
Let's take a quick look at what a manual test transcript would look like for our naïve example with&nbsp;<b>ipchains</b>.<br>You will remember that our local network in the example was 172.16.1.0 with a netmask of 255.255.255.0,<br>and we were to allow TCP connections out to web servers on the net. Nothing else was to pass our forward<br>chain. Start with a transmission that we know should work, a connection from a local host to a web server<br>outside:<br>
9.10. Testing a Firewall Configuration<br>
205<br>
<hr>
<A name=222></a>Linux Network Administrators Guide<br>
#&nbsp;<b>ipchains −C forward −p tcp −s 172.16.1.0 1025 −d 44.136.8.2 80 −i eth0</b><br>
accepted<br>
Note the arguments had to be supplied and the way they've been used to describe a datagram. The output of<br>the command indicates that that the datagram was accepted for forwarding, which is what we hoped for.<br>
Now try another test, this time with a source address that doesn't belong to our network. This one should be<br>denied:<br>
#&nbsp;<b>ipchains −C forward −p tcp −s 172.16.2.0 1025 −d 44.136.8.2 80 −i eth0</b><br>
denied<br>
Try some more tests, this time with the same details as the first test, but with different protocols. These<br>should be denied, too:<br>
#&nbsp;<b>ipchains −C forward −p udp −s 172.16.1.0 1025 −d 44.136.8.2 80 −i eth0</b><br>
denied<br>
#&nbsp;<b>ipchains −C forward −p icmp −s 172.16.1.0 1025 −d 44.136.8.2 80 −i eth0</b><br>
denied<br>
Try another destination port, again expecting it to be denied:<br>
#&nbsp;<b>ipchains −C forward −p tcp −s 172.16.1.0 1025 −d 44.136.8.2 23 −i eth0</b><br>
denied<br>
You'll go a long way toward achieving peace of mind if you design a series of exhaustive tests. While this<br>can sometimes be as difficult as designing the firewall configuration, it's also the best way of knowing that<br>your design is providing the security you expect of it.<br>
9.10. Testing a Firewall Configuration<br>
206<br>
<hr>
<A name=223></a><b>9.11. A Sample Firewall Configuration</b><br>
We've discussed the fundamentals of firewall configuration. Let's now look at what a firewall configuration<br>might actually look like.<br>
The configuration in this example has been designed to be easily extended and customized. We've provided<br>three versions. The first version is implemented using the&nbsp;<b>ipfwadm</b>&nbsp;command (or the<br><b>ipfwadm−wrapper</b>&nbsp;script), the second uses&nbsp;<b>ipchains</b>, and the third uses&nbsp;<b>iptables</b>. The example doesn't<br>attempt to exploit user−defined chains, but it will show you the similarities and differences between the old<br>and new firewall configuration tool syntaxes:<br>
#!/bin/bash<br>
##########################################################################<br>
# IPFWADM VERSION<br>
# This sample configuration is for a single host firewall configuration<br>
# with no services supported by the firewall machine itself.<br>
##########################################################################<br>
# USER CONFIGURABLE SECTION<br>
# The name and location of the ipfwadm utility. Use ipfwadm−wrapper for<br>
# 2.2.* kernels.<br>
IPFWADM=ipfwadm<br>
# The path to the ipfwadm executable.<br>
PATH=&quot;/sbin&quot;<br>
# Our internal network address space and its supporting network device.<br>
OURNET=&quot;172.29.16.0/24&quot;<br>
OURBCAST=&quot;172.29.16.255&quot;<br>
OURDEV=&quot;eth0&quot;<br>
# The outside address and the network device that supports it.<br>
ANYADDR=&quot;0/0&quot;<br>
ANYDEV=&quot;eth1&quot;<br>
# The TCP services we wish to allow to pass − &quot;&quot; empty means all ports<br>
# note: space separated<br>
TCPIN=&quot;smtp www&quot;<br>
TCPOUT=&quot;smtp www ftp ftp−data irc&quot;<br>
# The UDP services we wish to allow to pass − &quot;&quot; empty means all ports<br>
# note: space separated<br>
UDPIN=&quot;domain&quot;<br>
UDPOUT=&quot;domain&quot;<br>
# The ICMP services we wish to allow to pass − &quot;&quot; empty means all types<br>
# ref: /usr/include/netinet/ip_icmp.h for type numbers<br>
# note: space separated<br>
ICMPIN=&quot;0 3 11&quot;<br>
ICMPOUT=&quot;8 3 11&quot;<br>
# Logging; uncomment the following line to enable logging of datagrams<br>
# that are blocked by the firewall.<br>
# LOGGING=1<br>
# END USER CONFIGURABLE SECTION<br>
###########################################################################<br>
9.11. A Sample Firewall Configuration<br>
207<br>
<hr>
<A name=224></a>Linux Network Administrators Guide<br>
# Flush the Incoming table rules<br>
$IPFWADM −I −f<br>
# We want to deny incoming access by default.<br>
$IPFWADM −I −p deny<br>
# SPOOFING<br>
# We should not accept any datagrams with a source address matching ours<br>
# from the outside, so we deny them.<br>
$IPFWADM −I −a deny −S $OURNET −W $ANYDEV<br>
# SMURF<br>
# Disallow ICMP to our broadcast address to prevent &quot;Smurf&quot; style attack.<br>
$IPFWADM −I −a deny −P icmp −W $ANYDEV −D $OURBCAST<br>
# TCP<br>
# We will accept all TCP datagrams belonging to an existing connection<br>
# (i.e. having the ACK bit set) for the TCP ports we're allowing through.<br>
# This should catch more than 95 % of all valid TCP packets.<br>
$IPFWADM −I −a accept −P tcp −D $OURNET $TCPIN −k −b<br>
# TCP − INCOMING CONNECTIONS<br>
# We will accept connection requests from the outside only on the<br>
# allowed TCP ports.<br>
$IPFWADM −I −a accept −P tcp −W $ANYDEV −D $OURNET $TCPIN −y<br>
# TCP − OUTGOING CONNECTIONS<br>
# We accept all outgoing tcp connection requests on allowed TCP ports.<br>
$IPFWADM −I −a accept −P tcp −W $OURDEV −D $ANYADDR $TCPOUT −y<br>
# UDP − INCOMING<br>
# We will allow UDP datagrams in on the allowed ports.<br>
$IPFWADM −I −a accept −P udp −W $ANYDEV −D $OURNET $UDPIN<br>
# UDP − OUTGOING<br>
# We will allow UDP datagrams out on the allowed ports.<br>
$IPFWADM −I −a accept −P udp −W $OURDEV −D $ANYADDR $UDPOUT<br>
# ICMP − INCOMING<br>
# We will allow ICMP datagrams in of the allowed types.<br>
$IPFWADM −I −a accept −P icmp −W $ANYDEV −D $OURNET $UDPIN<br>
# ICMP − OUTGOING<br>
# We will allow ICMP datagrams out of the allowed types.<br>
$IPFWADM −I −a accept −P icmp −W $OURDEV −D $ANYADDR $UDPOUT<br>
# DEFAULT and LOGGING<br>
# All remaining datagrams fall through to the default<br>
# rule and are dropped. They will be logged if you've<br>
# configured the LOGGING variable above.<br>
#<br>
if [ &quot;$LOGGING&quot; ]<br>
then<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred TCP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPFWADM −I −a reject −P tcp −o<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred UDP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPFWADM −I −a reject −P udp −o<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred ICMP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPFWADM −I −a reject −P icmp −o<br>
fi<br>
9.11. A Sample Firewall Configuration<br>
208<br>
<hr>
<A name=225></a>Linux Network Administrators Guide<br>
#<br>
# end.<br>
Now we'll reimplement it using the&nbsp;<b>ipchains</b>&nbsp;command:<br>
#!/bin/bash<br>
##########################################################################<br>
# IPCHAINS VERSION<br>
# This sample configuration is for a single host firewall configuration<br>
# with no services supported by the firewall machine itself.<br>
##########################################################################<br>
# USER CONFIGURABLE SECTION<br>
# The name and location of the ipchains utility.<br>
IPCHAINS=ipchains<br>
# The path to the ipchains executable.<br>
PATH=&quot;/sbin&quot;<br>
# Our internal network address space and its supporting network device.<br>
OURNET=&quot;172.29.16.0/24&quot;<br>
OURBCAST=&quot;172.29.16.255&quot;<br>
OURDEV=&quot;eth0&quot;<br>
# The outside address and the network device that supports it.<br>
ANYADDR=&quot;0/0&quot;<br>
ANYDEV=&quot;eth1&quot;<br>
# The TCP services we wish to allow to pass − &quot;&quot; empty means all ports<br>
# note: space separated<br>
TCPIN=&quot;smtp www&quot;<br>
TCPOUT=&quot;smtp www ftp ftp−data irc&quot;<br>
# The UDP services we wish to allow to pass − &quot;&quot; empty means all ports<br>
# note: space separated<br>
UDPIN=&quot;domain&quot;<br>
UDPOUT=&quot;domain&quot;<br>
# The ICMP services we wish to allow to pass − &quot;&quot; empty means all types<br>
# ref: /usr/include/netinet/ip_icmp.h for type numbers<br>
# note: space separated<br>
ICMPIN=&quot;0 3 11&quot;<br>
ICMPOUT=&quot;8 3 11&quot;<br>
# Logging; uncomment the following line to enable logging of datagrams<br>
# that are blocked by the firewall.<br>
# LOGGING=1<br>
# END USER CONFIGURABLE SECTION<br>
##########################################################################<br>
# Flush the Input table rules<br>
$IPCHAINS −F input<br>
# We want to deny incoming access by default.<br>
$IPCHAINS −P input deny<br>
# SPOOFING<br>
# We should not accept any datagrams with a source address matching ours<br>
# from the outside, so we deny them.<br>
$IPCHAINS −A input −s $OURNET −i $ANYDEV −j deny<br>
9.11. A Sample Firewall Configuration<br>
209<br>
<hr>
<A name=226></a>Linux Network Administrators Guide<br>
# SMURF<br>
# Disallow ICMP to our broadcast address to prevent &quot;Smurf&quot; style attack.<br>
$IPCHAINS −A input −p icmp −w $ANYDEV −d $OURBCAST −j deny<br>
# We should accept fragments, in ipchains we must do this explicitly.<br>
$IPCHAINS −A input −f −j accept<br>
# TCP<br>
# We will accept all TCP datagrams belonging to an existing connection<br>
# (i.e. having the ACK bit set) for the TCP ports we're allowing through.<br>
# This should catch more than 95 % of all valid TCP packets.<br>
$IPCHAINS −A input −p tcp −d $OURNET $TCPIN ! −y −b −j accept<br>
# TCP − INCOMING CONNECTIONS<br>
# We will accept connection requests from the outside only on the<br>
# allowed TCP ports.<br>
$IPCHAINS −A input −p tcp −i $ANYDEV −d $OURNET $TCPIN −y −j accept<br>
# TCP − OUTGOING CONNECTIONS<br>
# We accept all outgoing TCP connection requests on allowed TCP ports.<br>
$IPCHAINS −A input −p tcp −i $OURDEV −d $ANYADDR $TCPOUT −y −j accept<br>
# UDP − INCOMING<br>
# We will allow UDP datagrams in on the allowed ports.<br>
$IPCHAINS −A input −p udp −i $ANYDEV −d $OURNET $UDPIN −j accept<br>
# UDP − OUTGOING<br>
# We will allow UDP datagrams out on the allowed ports.<br>
$IPCHAINS −A input −p udp −i $OURDEV −d $ANYADDR $UDPOUT −j accept<br>
# ICMP − INCOMING<br>
# We will allow ICMP datagrams in of the allowed types.<br>
$IPCHAINS −A input −p icmp −w $ANYDEV −d $OURNET $UDPIN −j accept<br>
# ICMP − OUTGOING<br>
# We will allow ICMP datagrams out of the allowed types.<br>
$IPCHAINS −A input −p icmp −i $OURDEV −d $ANYADDR $UDPOUT −j accept<br>
# DEFAULT and LOGGING<br>
# All remaining datagrams fall through to the default<br>
# rule and are dropped. They will be logged if you've<br>
# configured the LOGGING variable above.<br>
#<br>
if [ &quot;$LOGGING&quot; ]<br>
then<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred TCP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPCHAINS −A input −p tcp −l −j reject<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred UDP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPCHAINS −A input −p udp −l −j reject<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred ICMP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPCHAINS −A input −p icmp −l −j reject<br>
fi<br>
#<br>
# end.<br>
In our&nbsp;<b>iptables</b>&nbsp;example, we've switched to using the&nbsp;FORWARD&nbsp;ruleset because of the difference in meaning<br>of the&nbsp;INPUT&nbsp;ruleset in the&nbsp;<i>netfilter</i>&nbsp;implementation. This has implications for us; it means that none of the<br>rules protect the firewall host itself. To accurately mimic our&nbsp;<b>ipchains</b>&nbsp;example, we would replicate each of<br>
9.11. A Sample Firewall Configuration<br>
210<br>
<hr>
<A name=227></a>Linux Network Administrators Guide<br>
our rules in the&nbsp;INPUT&nbsp;chain. For clarity, we've dropped all incoming datagrams received from our outside<br>interface instead.<br>
#!/bin/bash<br>
##########################################################################<br>
# IPTABLES VERSION<br>
# This sample configuration is for a single host firewall configuration<br>
# with no services supported by the firewall machine itself.<br>
##########################################################################<br>
# USER CONFIGURABLE SECTION<br>
# The name and location of the ipchains utility.<br>
IPTABLES=iptables<br>
# The path to the ipchains executable.<br>
PATH=&quot;/sbin&quot;<br>
# Our internal network address space and its supporting network device.<br>
OURNET=&quot;172.29.16.0/24&quot;<br>
OURBCAST=&quot;172.29.16.255&quot;<br>
OURDEV=&quot;eth0&quot;<br>
# The outside address and the network device that supports it.<br>
ANYADDR=&quot;0/0&quot;<br>
ANYDEV=&quot;eth1&quot;<br>
# The TCP services we wish to allow to pass − &quot;&quot; empty means all ports<br>
# note: comma separated<br>
TCPIN=&quot;smtp,www&quot;<br>
TCPOUT=&quot;smtp,www,ftp,ftp−data,irc&quot;<br>
# The UDP services we wish to allow to pass − &quot;&quot; empty means all ports<br>
# note: comma separated<br>
UDPIN=&quot;domain&quot;<br>
UDPOUT=&quot;domain&quot;<br>
# The ICMP services we wish to allow to pass − &quot;&quot; empty means all types<br>
# ref: /usr/include/netinet/ip_icmp.h for type numbers<br>
# note: comma separated<br>
ICMPIN=&quot;0,3,11&quot;<br>
ICMPOUT=&quot;8,3,11&quot;<br>
# Logging; uncomment the following line to enable logging of datagrams<br>
# that are blocked by the firewall.<br>
# LOGGING=1<br>
# END USER CONFIGURABLE SECTION<br>
###########################################################################<br>
# Flush the Input table rules<br>
$IPTABLES −F FORWARD<br>
# We want to deny incoming access by default.<br>
$IPTABLES −P FORWARD deny<br>
# Drop all datagrams destined for this host received from outside.<br>
$IPTABLES −A INPUT −i $ANYDEV −j DROP<br>
# SPOOFING<br>
# We should not accept any datagrams with a source address matching ours<br>
# from the outside, so we deny them.<br>
9.11. A Sample Firewall Configuration<br>
211<br>
<hr>
<A name=228></a>Linux Network Administrators Guide<br>
$IPTABLES −A FORWARD −s $OURNET −i $ANYDEV −j DROP<br>
# SMURF<br>
# Disallow ICMP to our broadcast address to prevent &quot;Smurf&quot; style attack.<br>
$IPTABLES −A FORWARD −m multiport −p icmp −i $ANYDEV −d $OURNET −j DENY<br>
# We should accept fragments, in iptables we must do this explicitly.<br>
$IPTABLES −A FORWARD −f −j ACCEPT<br>
# TCP<br>
# We will accept all TCP datagrams belonging to an existing connection<br>
# (i.e. having the ACK bit set) for the TCP ports we're allowing through.<br>
# This should catch more than 95 % of all valid TCP packets.<br>
$IPTABLES −A FORWARD −m multiport −p tcp −d $OURNET −−dports $TCPIN /<br>
&nbsp; &nbsp; ! −−tcp−flags SYN,ACK ACK −j ACCEPT<br>
$IPTABLES −A FORWARD −m multiport −p tcp −s $OURNET −−sports $TCPIN /<br>
&nbsp; &nbsp; ! −−tcp−flags SYN,ACK ACK −j ACCEPT<br>
# TCP − INCOMING CONNECTIONS<br>
# We will accept connection requests from the outside only on the<br>
# allowed TCP ports.<br>
$IPTABLES −A FORWARD −m multiport −p tcp −i $ANYDEV −d $OURNET $TCPIN /<br>
&nbsp; &nbsp; −−syn −j ACCEPT<br>
# TCP − OUTGOING CONNECTIONS<br>
# We will accept all outgoing tcp connection requests on the allowed /<br>
&nbsp; &nbsp; TCP ports.<br>
$IPTABLES −A FORWARD −m multiport −p tcp −i $OURDEV −d $ANYADDR /<br>
&nbsp; &nbsp; −−dports $TCPOUT −−syn −j ACCEPT<br>
# UDP − INCOMING<br>
# We will allow UDP datagrams in on the allowed ports and back.<br>
$IPTABLES −A FORWARD −m multiport −p udp −i $ANYDEV −d $OURNET /<br>
&nbsp; &nbsp; −−dports $UDPIN −j ACCEPT<br>
$IPTABLES −A FORWARD −m multiport −p udp −i $ANYDEV −s $OURNET /<br>
&nbsp; &nbsp; −−sports $UDPIN −j ACCEPT<br>
# UDP − OUTGOING<br>
# We will allow UDP datagrams out to the allowed ports and back.<br>
$IPTABLES −A FORWARD −m multiport −p udp −i $OURDEV −d $ANYADDR /<br>
&nbsp; &nbsp; −−dports $UDPOUT −j ACCEPT<br>
$IPTABLES −A FORWARD −m multiport −p udp −i $OURDEV −s $ANYADDR /<br>
&nbsp; &nbsp; −−sports $UDPOUT −j ACCEPT<br>
# ICMP − INCOMING<br>
# We will allow ICMP datagrams in of the allowed types.<br>
$IPTABLES −A FORWARD −m multiport −p icmp −i $ANYDEV −d $OURNET /<br>
&nbsp; &nbsp; −−dports $ICMPIN −j ACCEPT<br>
# ICMP − OUTGOING<br>
# We will allow ICMP datagrams out of the allowed types.<br>
$IPTABLES −A FORWARD −m multiport −p icmp −i $OURDEV −d $ANYADDR /<br>
&nbsp; &nbsp; −−dports $ICMPOUT −j ACCEPT<br>
# DEFAULT and LOGGING<br>
# All remaining datagrams fall through to the default<br>
# rule and are dropped. They will be logged if you've<br>
# configured the LOGGING variable above.<br>
#<br>
if [ &quot;$LOGGING&quot; ]<br>
then<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred TCP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPTABLES −A FORWARD −m tcp −p tcp −j LOG<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred UDP<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPTABLES −A FORWARD −m udp −p udp −j LOG<br>
&nbsp; &nbsp; &nbsp; &nbsp; # Log barred ICMP<br>
9.11. A Sample Firewall Configuration<br>
212<br>
<hr>
<A name=229></a>Linux Network Administrators Guide<br>
&nbsp; &nbsp; &nbsp; &nbsp; $IPTABLES −A FORWARD −m udp −p icmp −j LOG<br>
fi<br>
#<br>
# end.<br>
In many simple situations, to use the sample all you have to do is edit the top section of the file labeled<br>USER CONFIGURABLE section to specify which protocols and datagrams type you wish to allow in and<br>out. For more complex configurations, you will need to edit the section at the bottom, as well. Remember,<br>this is a simple example, so scrutinize it very carefully to ensure it does what you want while implementing it.<br>
9.11. A Sample Firewall Configuration<br>
213<br>
<hr>
<A name=230></a><b>Chapter 10. IP Accounting</b><br>
In todays world of commercial Internet service, it is becoming increasingly important to know how much<br>data you are transmitting and receiving on your network connections. If you are an Internet Service Provider<br>and you charge your customers by volume, this will be essential to your business. If you are a customer of an<br>Internet Service Provider that charges by data volume, you will find it useful to collect your own data to<br>ensure the accuracy of your Internet charges.<br>
There are other uses for network accounting that have nothing to do with dollars and bills. If you manage a<br>server that offers a number of different types of network services, it might be useful to you to know exactly<br>how much data is being generated by each one. This sort of information could assist you in making decisions,<br>such as what hardware to buy or how many servers to run.<br>
The Linux kernel provides a facility that allows you to collect all sorts of useful information about the<br>network traffic it sees. This facility is called&nbsp;<i>IP accounting</i>.<br>
Chapter 10. IP Accounting<br>
214<br>
<hr>
<A name=231></a><b>10.1. Configuring the Kernel for IP Accounting</b><br>
&nbsp;The Linux IP accounting feature is very closely related to the Linux firewall software. The places you want<br>to collect accounting data are the same places that you would be interested in performing firewall filtering:<br>into and out of a network host, and in the software that does the routing of datagrams. If you haven't read the<br>section on firewalls, now is probably a good time to do so, as we will be using some of the concepts<br><a href="TLNAGs.html#183">described in&nbsp;Chapter 9</a>.<br>
&nbsp;To activate the Linux IP accounting feature, you should first see if your Linux kernel is configured for it.<br>Check to see if the&nbsp;/proc/net/ip_acct&nbsp;file exists. If it does, your kernel already supports IP accounting.<br>If it doesn't, you must build a new kernel, ensuring that you answer Y to the options in 2.0 and 2.2 series<br>kernels:<br>
Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] Network firewalls<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] TCP/IP networking<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;...<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] IP: accounting<br>
or in 2.4 series kernels:<br>
Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; [*] Network packet filtering (replaces ipchains)<br>
10.1. Configuring the Kernel for IP Accounting<br>
215<br>
<hr>
<A name=232></a><b>10.2. Configuring IP Accounting</b><br>
&nbsp;Because IP accounting is closely related to IP firewall, the same tool was designated to configure it, so<br><b>ipfwadm</b>,&nbsp;<b>ipchains</b>&nbsp;or&nbsp;<b>iptables</b>&nbsp;are used to configure IP accounting. The command syntax is very similar to<br>that of the firewall rules, so we won't focus on it, but we will discuss what you can discover about the nature<br>of your network traffic using this feature.<br>
The general syntax for IP accounting with&nbsp;<b>ipfwadm</b>&nbsp;is:<br>
#&nbsp;<b>ipfwadm −A [<i>direction</i></b><b>] [<i>command</i></b><b>] [<i>parameters</i></b><b>]</b><br>
The direction argument is new. This is simply coded as&nbsp;in,&nbsp;out, or&nbsp;both. These directions are from the<br>perspective of the linux machine itself, so&nbsp;in&nbsp;means data coming into the machine from a network<br>connection and&nbsp;out&nbsp;means data that is being transmitted by this host on a network connection. The<br>both&nbsp;direction is the sum of both the incoming and outgoing directions.<br>
The general command syntax for&nbsp;<b>ipchains</b>&nbsp;and&nbsp;<b>iptables</b>&nbsp;is:<br>
#&nbsp;<b>ipchains −A&nbsp;<i>chain&nbsp;rule−specification</i></b><br>
#&nbsp;<b>iptables −A&nbsp;<i>chain&nbsp;rule−specification</i></b><br>
The&nbsp;<b>ipchains</b>&nbsp;and&nbsp;<b>iptables</b>&nbsp;commands allow you to specify direction in a manner more consistent with the<br>firewall rules. IP Firewall Chains doesn't allow you to configure a rule that aggregates both directions, but it<br>does allow you to configure rules in the&nbsp;forward&nbsp;chain that the older implementation did not. We'll see the<br>difference that makes in some examples a little later.<br>
The commands are much the same as firewall rules, except that the policy rules do not apply here. We can<br>add, insert, delete, and list accounting rules. In the case of&nbsp;<b>ipchains</b>&nbsp;and&nbsp;<b>iptables</b>, all valid rules are<br>accounting rules, and any command that doesn't specify the&nbsp;<i>−j</i>&nbsp;option performs accounting only.<br>
The rule specification parameters for IP accounting are the same as those used for IP firewall. These are what<br>we use to define precisely what network traffic we wish to count and total.<br>
<b>10.2.1. Accounting by Address</b><br>
Let's work with an example to illustrate how we'd use IP accounting.<br>
Imagine we have a Linux−based router that serves two departments at the Virtual Brewery. The router has<br>two Ethernet devices,&nbsp;eth0&nbsp;and&nbsp;eth1, each of which services a department; and a PPP device,&nbsp;ppp0, that<br>connects us via a high−speed serial link to the main campus of the Groucho Marx University.<br>
Let's also imagine that for billing purposes we want to know the total traffic generated by each of the<br>departments across the serial link, and for management purposes we want to know the total traffic generated<br>between the two departments.<br>
The following table shows the interface addresses we will use in our example:<br>
10.2. Configuring IP Accounting<br>
216<br>
<hr>
<A name=233></a>Linux Network Administrators Guide<br>
<b>iface&nbsp;address</b><br>
<b>netmask</b><br>
eth0&nbsp;172.16.3.0&nbsp;255.255.255.0<br>
eth1&nbsp;172.16.4.0&nbsp;255.255.255.0<br>
To answer the question, How much data does each department generate on the PPP link?, we could use a<br>rule that looks like this:<br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −S 172.16.3.0/24 −b</b><br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −S 172.16.4.0/24 −b</b><br>
or:<br>
#&nbsp;<b>ipchains −A input −i ppp0 −d 172.16.3.0/24</b><br>
#&nbsp;<b>ipchains −A output −i ppp0 −s 172.16.3.0/24</b><br>
#&nbsp;<b>ipchains −A input −i ppp0 −d 172.16.4.0/24</b><br>
#&nbsp;<b>ipchains −A output −i ppp0 −s 172.16.4.0/24</b><br>
and with&nbsp;<b>iptables</b>:<br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −d 172.16.3.0/24</b><br>
#&nbsp;<b>iptables −A FORWARD −o ppp0 −s 172.16.3.0/24</b><br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −d 172.16.4.0/24</b><br>
#&nbsp;<b>iptables −A FORWARD −o ppp0 −s 172.16.4.0/24</b><br>
The first half of each of these set of rules say, Count all data traveling in either direction across the interface<br>named ppp0 with a source or destination (remember the function of the&nbsp;<i>−b</i>&nbsp;flag in&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>iptables</b>)<br>address of&nbsp;172.16.3.0/24.&nbsp;The second half of each ruleset is the same, but for the second Ethernet<br>network at our site.<br>
To answer the second question, How much data travels between the two departments?, we need a rule that<br>looks like this:<br>
#&nbsp;<b>ipfwadm −A both −a −S 172.16.3.0/24 −D 172.16.4.0/24 −b</b><br>
or:<br>
#&nbsp;<b>ipchains −A forward −s 172.16.3.0/24 −d 172.16.4.0/24 −b</b><br>
or:<br>
#&nbsp;<b>iptables −A FORWARD −s 172.16.3.0/24 −d 172.16.4.0/24</b><br>
#&nbsp;<b>iptables −A FORWARD −s 172.16.4.0/24 −d 172.16.3.0/24</b><br>
These rules will count all datagrams with a source address belonging to one of the department networks and a<br>destination address belonging to the other.<br>
10.2. Configuring IP Accounting<br>
217<br>
<hr>
<A name=234></a>Linux Network Administrators Guide<br>
<b>10.2.2. Accounting by Service Port</b><br>
Okay, let's suppose we also want a better idea of exactly what sort of traffic is being carried across our PPP<br>link. We might, for example, want to know how much of the link the FTP, smtp, and World Wide Web<br>services are consuming.<br>
A script of rules to enable us to collect this information might look like:<br>
#!/bin/sh<br>
# Collect FTP, smtp and www volume statistics for data carried on our<br>
# PPP link using ipfwadm<br>
#<br>
ipfwadm −A both −a −W ppp0 −P tcp −S 0/0 ftp ftp−data<br>
ipfwadm −A both −a −W ppp0 −P tcp −S 0/0 smtp<br>
ipfwadm −A both −a −W ppp0 −P tcp −S 0/0 www<br>
or:<br>
#!/bin/sh<br>
# Collect ftp, smtp and www volume statistics for data carried on our<br>
# PPP link using ipchains<br>
#<br>
ipchains −A input −i ppp0 −p tcp −s 0/0 ftp−data:ftp<br>
ipchains −A output −i ppp0 −p tcp −d 0/0 ftp−data:ftp<br>
ipchains −A input −i ppp0 −p tcp −s 0/0 smtp<br>
ipchains −A output −i ppp0 −p tcp −d 0/0 smtp<br>
ipchains −A input −i ppp0 −p tcp −s 0/0 www<br>
ipchains −A output −i ppp0 −p tcp −d 0/0 www<br>
or:<br>
#!/bin/sh<br>
# Collect ftp, smtp and www volume statistics for data carried on our<br>
# PPP link using iptables.<br>
#<br>
iptables −A FORWARD −i ppp0 −m tcp −p tcp −−sport ftp−data:ftp<br>
iptables −A FORWARD −o ppp0 −m tcp −p tcp −−dport ftp−data:ftp<br>
iptables −A FORWARD −i ppp0 −m tcp −p tcp −−sport smtp<br>
iptables −A FORWARD −o ppp0 −m tcp −p tcp −−dport smtp<br>
iptables −A FORWARD −i ppp0 −m tcp −p tcp −−sport www<br>
iptables −A FORWARD −o ppp0 −m tcp −p tcp −−dport www<br>
There are a couple of interesting features to this configuration. Firstly, we've specified the protocol. When we<br>specify ports in our rules, we must also specify a protocol because TCP and UDP provide separate sets of<br>ports. Since all of these services are TCB−based, we've specified it as the protocol. Secondly, we've specified<br>the two services&nbsp;ftp&nbsp;and&nbsp;ftp−data&nbsp;in one command.&nbsp;<b>ipfwadm</b>&nbsp;allows you to specify single ports, ranges<br>of ports, or arbitrary lists of ports. The&nbsp;<b>ipchains</b>&nbsp;command allows either single ports or ranges of ports, which<br>is what we've used here. The syntax &quot;ftp−data:ftp&quot; means &quot;ports ftp−data (20) through ftp (21),&quot; and is<br>how we encode ranges of ports in both&nbsp;<b>ipchains</b>&nbsp;and&nbsp;<b>iptables</b>. When you have a list of ports in an accounting<br>rule, it means that any data received for any of the ports in the list will cause the data to be added to that<br>entry's totals. Remembering that the FTP service uses two ports, the command port and the data transfer port,<br>we've added them together to total the FTP traffic. Lastly, we've specified the source address as&nbsp;0/0,<br>which is special notation that matches all addresses and is required by both the&nbsp;<b>ipfwadm</b>&nbsp;and<br><b>ipchains</b>&nbsp;commands in order to specify ports.<br>
10.2.2. Accounting by Service Port<br>
218<br>
<hr>
<A name=235></a>Linux Network Administrators Guide<br>
We can expand on the second point a little to give us a different view of the data on our link. Let's now<br>imagine that we class FTP, SMTP, and World Wide Web traffic as essential traffic, and all other traffic as<br>nonessential. If we were interested in seeing the ratio of essential traffic to nonessential traffic, we could do<br>something like:<br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −P tcp −S 0/0 ftp ftp−data smtp www</b><br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −P tcp −S 0/0 1:19 22:24 26:79 81:32767</b><br>
If you have already examined your&nbsp;/etc/services&nbsp;file, you will see that the second rule covers all ports<br>except (ftp,&nbsp;ftp−data,&nbsp;smtp, and&nbsp;www).<br>
How do we do this with the&nbsp;<b>ipchains</b>&nbsp;or&nbsp;<b>iptables</b>&nbsp;commands, since they allow only one argument in their port<br>specification? We can exploit user−defined chains in accounting just as easily as in firewall rules. Consider<br>the following approach:<br>
#&nbsp;<b>ipchains −N a−essent</b><br>
#&nbsp;<b>ipchains −N a−noness</b><br>
#&nbsp;<b>ipchains −A a−essent −j ACCEPT</b><br>
#&nbsp;<b>ipchains −A a−noness −j ACCEPT</b><br>
#&nbsp;<b>ipchains −A forward −i ppp0 −p tcp −s 0/0 ftp−data:ftp −j a−essent</b><br>
#&nbsp;<b>ipchains −A forward −i ppp0 −p tcp −s 0/0 smtp −j a−essent</b><br>
#&nbsp;<b>ipchains −A forward −i ppp0 −p tcp −s 0/0 www −j a−essent</b><br>
#&nbsp;<b>ipchains −A forward −j a−noness</b><br>
Here we create two user−defined chains, one called&nbsp;a−essent, where we capture accounting data for<br>essential services and another called&nbsp;a−noness, where we capture accounting data for nonessential services.<br>We then add rules to our forward chain that match our essential services and jump to the&nbsp;a−essent&nbsp;chain,<br>where we have just one rule that accepts all datagrams and counts them. The last rule in our forward chain is<br>a rule that jumps to our&nbsp;a−noness&nbsp;chain, where again we have just one rule that accepts all datagrams and<br>counts them. The rule that jumps to the&nbsp;a−noness&nbsp;chain will not be reached by any of our essential<br>services, as they will have been accepted in their own chain. Our tallies for essential and nonessential services<br>will therefore be available in the rules within those chains. This is just one approach you could take; there are<br>others. Our&nbsp;<b>iptables</b>&nbsp;implementation of the same approach would look like:<br>
#&nbsp;<b>iptables −N a−essent</b><br>
#&nbsp;<b>iptables −N a−noness</b><br>
#&nbsp;<b>iptables −A a−essent −j ACCEPT</b><br>
#&nbsp;<b>iptables −A a−noness −j ACCEPT</b><br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −m tcp −p tcp −−sport ftp−data:ftp −j a−essent</b><br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −m tcp −p tcp −−sport smtp −j a−essent</b><br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −m tcp −p tcp −−sport www −j a−essent</b><br>
#&nbsp;<b>iptables −A FORWARD −j a−noness</b><br>
&nbsp;This looks simple enough. Unfortunately, there is a small but unavoidable problem when trying to do<br>accounting by service type. You will remember that we discussed the role the MTU plays in TCP/IP<br>networking in an earlier chapter. The MTU defines the largest datagram that will be transmitted on a network<br>device. When a datagram is received by a router that is larger than the MTU of the interface that needs to<br>retransmit it, the router performs a trick called&nbsp;<i>fragmentation</i>. The router breaks the large datagram into small<br>pieces no longer than the MTU of the interface and then transmits these pieces. The router builds new headers<br>to put in front of each of these pieces, and these are what the remote machine uses to reconstruct the original<br>data. Unfortunately, during the fragmentation process the port is lost for all but the first fragment. This means<br>that the IP accounting can't properly count fragmented datagrams. It can reliably count only the first<br>fragment, or unfragmented datagrams. There is a small trick permitted by&nbsp;<b>ipfwadm</b>&nbsp;that ensures that while<br>we won't be able to know exactly what port the second and later fragments were from, we can still count<br>
10.2.2. Accounting by Service Port<br>
219<br>
<hr>
<A name=236></a>Linux Network Administrators Guide<br>
them. An early version of Linux accounting software assigned the fragments a fake port number, 0xFFFF,<br>that we could count. To ensure that we capture the second and later fragments, we could use a rule like:<br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −P tcp −S 0/0 0xFFFF</b><br>
The IP chains implementation has a slightly more sophisticated solution, but the result is much the same. If<br>using the&nbsp;<b>ipchains</b>&nbsp;command we'd instead use:<br>
#&nbsp;<b>ipchains −A forward −i ppp0 −p tcp −f</b><br>
and with&nbsp;<b>iptables</b>&nbsp;we'd use:<br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −m tcp −p tcp −f</b><br>
These won't tell us what the original port for this data was, but at least we are able to see how much of our<br>data is fragments, and be able to account for the volume of traffic they consume.<br>
In 2.2 kernels you can select a kernel compile−time option that negates this whole issue if your Linux<br>machine is acting as the single access point for a network. If you enable the&nbsp;IP: always<br>defragment&nbsp;option when you compile your kernel, all received datagrams will be reassembled by the<br>Linux router before routing and retransmission. This operation is performed before the firewall and<br>accounting software sees the datagram, and thus you will have no fragments to deal with. In 2.4 kernels you<br>compile and load the&nbsp;<i>netfilter</i>&nbsp;forward−fragment&nbsp;module.<br>
<b>10.2.3. Accounting of ICMP Datagrams</b><br>
&nbsp;The ICMP protocol does not use service port numbers and is therefore a little bit more difficult to collect<br>details on. ICMP uses a number of different types of datagrams. Many of these are harmless and normal,<br>while others should only be seen under special circumstances. Sometimes people with too much time on their<br>hands attempt to maliciously disrupt the network access of a user by generating large numbers of ICMP<br>messages. This is commonly called&nbsp;<i>ping flooding</i>. While IP accounting cannot do anything to prevent this<br>problem (IP firewalling can help, though!) we can at least put accounting rules in place that will show us if<br>anybody has been trying.<br>
ICMP doesn't use ports as TCP and UDP do. Instead ICMP has ICMP message types. We can build rules to<br>account for each ICMP message type. To do this, we place the ICMP message and type number in place of<br>the port field in the&nbsp;<b>ipfwadm</b><a href="TLNAGs.html#198">&nbsp;accounting commands. We listed the ICMP message types in&nbsp;Section 9.6.3.5</a>,<br>so refer to it if you need to remember what they are.<br>
An IP accounting rule to collect information about the volume of ping data that is being sent to you or that<br>you are generating might look like:<br>
#&nbsp;<b>ipfwadm −A both −a −P icmp −S 0/0 8</b><br>
#&nbsp;<b>ipfwadm −A both −a −P icmp −S 0/0 0</b><br>
#&nbsp;<b>ipfwadm −A both −a −P icmp −S 0/0 0xff</b><br>
or, with&nbsp;<b>ipchains</b>:<br>
#&nbsp;<b>ipchains −A forward −p icmp −s 0/0 8</b><br>
#&nbsp;<b>ipchains −A forward −p icmp −s 0/0 0</b><br>
10.2.3. Accounting of ICMP Datagrams<br>
220<br>
<hr>
<A name=237></a>Linux Network Administrators Guide<br>
#&nbsp;<b>ipchains −A forward −p icmp −s 0/0 −f</b><br>
or, with&nbsp;<b>iptables</b>:<br>
#&nbsp;<b>iptables −A FORWARD −m icmp −p icmp −−sports echo−request</b><br>
#&nbsp;<b>iptables −A FORWARD −m icmp −p icmp −−sports echo−reply</b><br>
#&nbsp;<b>iptables −A FORWARD −m icmp −p icmp −f</b><br>
The first rule collects information about the ICMP Echo Request datagrams (ping requests), and the<br>second rule collects information about the ICMP Echo Reply datagrams (ping replies). The third rule<br>collects information about ICMP datagram fragments. This is a trick similar to that described for fragmented<br>TCP and UDP datagrams.<br>
If you specify source and/or destination addresses in your rules, you can keep track of where the pings are<br>coming from, such as whether they originate inside or outside your network. Once you've determined where<br>the rogue datagrams are coming from, you can decide whether you want to put firewall rules in place to<br>prevent them or take some other action, such as contacting the owner of the offending network to advise them<br>of the problem, or perhaps even legal action if the problem is a malicious act.<br>
<b>10.2.4. Accounting by Protocol</b><br>
Let's now imagine that we are interested in knowing how much of the traffic on our link is TCP, UDP, and<br>ICMP. We would use rules like the following:<br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −P tcp −D 0/0</b><br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −P udp −D 0/0</b><br>
#&nbsp;<b>ipfwadm −A both −a −W ppp0 −P icmp −D 0/0</b><br>
or:<br>
#&nbsp;<b>ipchains −A forward −i ppp0 −p tcp −d 0/0</b><br>
#&nbsp;<b>ipchains −A forward −i ppp0 −p udp −d 0/0</b><br>
#&nbsp;<b>ipchains −A forward −i ppp0 −p icmp −d 0/0</b><br>
or:<br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −m tcp −p tcp</b><br>
#&nbsp;<b>iptables −A FORWARD −o ppp0 −m tcp −p tcp</b><br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −m udp −p udp</b><br>
#&nbsp;<b>iptables −A FORWARD −o ppp0 −m udp −p udp</b><br>
#&nbsp;<b>iptables −A FORWARD −i ppp0 −m icmp −p icmp</b><br>
#&nbsp;<b>iptables −A FORWARD −o ppp0 −m icmp −p icmp</b><br>
With these rules in place, all of the traffic flowing across the&nbsp;ppp0&nbsp;interface will be analyzed to determine<br>whether it is TCP, UDP, or IMCP traffic, and the appropriate counters will be updated for each. The<br><b>iptables</b>&nbsp;example splits incoming flow from outgoing flow as its syntax demands it.<br>
10.2.4. Accounting by Protocol<br>
221<br>
<hr>
<A name=238></a><b>10.3. Using IP Accounting Results</b><br>
It is all very well to be collecting this information, but how do we actually get to see it? To view the<br>collected accounting data and the configured accounting rules, we use our firewall configuration commands,<br>asking them to list our rules. The packet and byte counters for each of our rules are listed in the output.<br>
The&nbsp;<b>ipfwadm</b>,&nbsp;<b>ipchains</b>, and&nbsp;<b>iptables</b>&nbsp;commands differ in how accounting data is handled, so we will treat<br>them independently.<br>
<b>10.3.1. Listing Accounting Data with ipfwadm</b><br>
The most basic means of listing our accounting data with the&nbsp;<b>ipfwadm</b>&nbsp;command is to use it like this:<br>
#&nbsp;<b>ipfwadm −A −l</b><br>
IP accounting rules<br>
&nbsp;pkts bytes dir prot source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ports<br>
&nbsp;9833 2345K i/o all &nbsp;172.16.3.0/24 &nbsp; &nbsp; &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a<br>
56527 &nbsp; 33M i/o all &nbsp;172.16.4.0/24 &nbsp; &nbsp; &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n/a<br>
This will tell us the number of packets sent in each direction. If we use the extended output format with the<br>−e&nbsp;option (not shown here because the output is too wide for the page), we are also supplied the options and<br>applicable interface names. Most of the fields in the output will be self−explanatory, but the following may<br>not:<br>
<i>dir</i><br>
The direction in which the rule applies. Expected values here are&nbsp;in,&nbsp;out, or&nbsp;i/o, meaning both<br>ways.<br>
<i>prot</i><br>
The protocols to which the rule applies.<br>
<i>opt</i><br>
A coded form of the options we use when invoking&nbsp;<b>ipfwadm</b>.<br>
<i>ifname</i><br>
The name of the interface to which the rule applies.<br>
<i>ifaddress</i><br>
The address of the interface to which the rule applies.<br>
By default,&nbsp;<b>ipfwadm</b>&nbsp;displays the packet and byte counts in a shortened form, rounded to the nearest<br>thousand (K) or million (M). We can ask it to display the collected data in exact units by using the expanded<br>option as follows:<br>
10.3. Using IP Accounting Results<br>
222<br>
<hr>
<A name=239></a>Linux Network Administrators Guide<br>
#&nbsp;<b>ipfwadm −A −l −e −x</b><br>
<b>10.3.2. Listing Accounting Data with ipchains</b><br>
The&nbsp;<b>ipchains</b>&nbsp;command will not display our accounting data (packet and byte counters) unless we supply it<br>the&nbsp;−v&nbsp;argument. The simplest means of listing our accounting data with the&nbsp;<b>ipchains</b>&nbsp;is to use it like this:<br>
#&nbsp;<b>ipchains −L −v</b><br>
Again, just as with&nbsp;<b>ipfwadm</b>, we can display the packet and byte counters in units by using the expanded<br>output mode. The&nbsp;<b>ipchains</b>&nbsp;uses the&nbsp;−x&nbsp;argument for this:<br>
#&nbsp;<b>ipchains −L −v −x</b><br>
<b>10.3.3. Listing Accounting Data with iptables</b><br>
The&nbsp;<b>iptables</b>&nbsp;command behaves very similarly to the&nbsp;<b>ipchains</b>&nbsp;command. Again, we must use the&nbsp;−v&nbsp;when<br>listing tour rules to see the accounting counters. To list our accounting data, we would use:<br>
#&nbsp;<b>iptables −L −v</b><br>
Just as for the&nbsp;<b>ipchains</b>&nbsp;command, you can use the&nbsp;−x&nbsp;argument to show the output in expanded format with<br>unit figures.<br>
10.3.2. Listing Accounting Data with ipchains<br>
223<br>
<hr>
<A name=240></a><b>10.4. Resetting the Counters</b><br>
The IP accounting counters will overflow if you leave them long enough. If they overflow, you will have<br>difficulty determining the value they actually represent. To avoid this problem, you should read the<br>accounting data periodically, record it, and then reset the counters back to zero to begin collecting accounting<br>information for the next accounting interval.<br>
The&nbsp;<b>ipfwadm</b>&nbsp;and&nbsp;<b>ipchains</b>&nbsp;commands provide you with a means of doing this quite simply:<br>
#&nbsp;<b>ipfwadm −A −z</b><br>
or:<br>
#&nbsp;<b>ipchains −Z</b><br>
or:<br>
#&nbsp;<b>iptables −Z</b><br>
You can even combine the list and zeroing actions together to ensure that no accounting data is lost in<br>between:<br>
#&nbsp;<b>ipfwadm −A −l −z</b><br>
or:<br>
#&nbsp;<b>ipchains −L −Z</b><br>
or:<br>
#&nbsp;<b>iptables −L −Z −v</b><br>
These commands will first list the accounting data and then immediately zero the counters and begin<br>counting again. If you are interested in collecting and using this information regularly, you would probably<br>want to put this command into a script that recorded the output and stored it somewhere, and execute the<br>script periodically using the&nbsp;<b>cron</b>&nbsp;command.<br>
10.4. Resetting the Counters<br>
224<br>
<hr>
<A name=241></a><b>10.5. Flushing the Ruleset</b><br>
One last command that might be useful allows you to flush all the IP accounting rules you have configured.<br>This is most useful when you want to radically alter your ruleset without rebooting the machine.<br>
The&nbsp;−f&nbsp;argument in combination with the&nbsp;<b>ipfwadm</b>&nbsp;command will flush all of the rules of the type you<br>specify.&nbsp;<b>ipchains</b>&nbsp;supports the&nbsp;−F&nbsp;argument, which does the same:<br>
#&nbsp;<b>ipfwadm −A −f</b><br>
or:<br>
#&nbsp;<b>ipchains −F</b><br>
or:<br>
#&nbsp;<b>iptables −F</b><br>
This flushes all of your configured IP accounting rules, removing them all and saving you having to remove<br>each of them individually. Note that flushing the rules with&nbsp;<b>ipchains</b>&nbsp;does not cause any user−defined chains<br>to be removed, only the rules within them.<br>
10.5. Flushing the Ruleset<br>
225<br>
<hr>
<A name=242></a><b>10.6. Passive Collection of Accounting Data</b><br>
One last trick you might like to consider: if your Linux machine is connected to an Ethernet, you can apply<br>accounting rules to all of the data from the segment, not only that which it is transmitted by or destined for it.<br>Your machine will passively listen to all of the data on the segment and count it.<br>
You should first turn IP forwarding off on your Linux machine so that it doesn't try to route the datagrams it<br>receives.[65]&nbsp;In the 2.0.36 and 2.2 kernels, this is a matter of:<br>
#&nbsp;<b>echo 0 &gt;/proc/sys/net/ipv4/ip_forward</b><br>
You should then enable promiscuous mode on your Ethernet interface using the&nbsp;<b>ifconfig</b>&nbsp;command. Now<br>you can establish accounting rules that allow you to collect information about the datagrams flowing across<br>your Ethernet without involving your Linux in the route at all.<br>
10.6. Passive Collection of Accounting Data<br>
226<br>
<hr>
<A name=243></a><b>Chapter 11. IP Masquerade and Network Address<br>Translation</b><br>
You don't have to have a good memory to remember a time when only large organizations could afford to<br>have a number of computers networked together by a LAN. Today network technology has dropped so much<br>in price that two things have happened. First, LANs are now commonplace, even in many household<br>environments. Certainly many Linux users will have two or more computers connected by some Ethernet.<br>Second, network resources, particularly IP addresses, are now a scarce resource and while they used to be<br>free, they are now being bought and sold.<br>
Most people with a LAN will probably also want an Internet connection that every computer on the LAN can<br>use. The IP routing rules are quite strict in how they deal with this situation. Traditional solutions to this<br>problem would have involved requesting an IP network address, perhaps a class C address for small sites,<br>assigning each host on the LAN an address from this network and using a router to connect the LAN to the<br>Internet.<br>
In a commercialized Internet environment, this is quite an expensive proposition. First, you'd be required to<br>pay for the network address that is assigned to you. Second, you'd probably have to pay your Internet Service<br>Provider for the privilege of having a suitable route to your network put in place so that the rest of the<br>Internet knows how to reach you. This might still be practical for companies, but domestic installations don't<br>usually justify the cost.<br>
Fortunately, Linux provides an answer to this dilemma. This answer involves a component of a group of<br>advanced networking features called&nbsp;<i>Network Address Translation</i>&nbsp;(NAT). NAT describes the process of<br>modifying the network addresses contained with datagram headers while they are in transit. This might sound<br>odd at first, but we'll show that it is ideal for solving the problem we've just described and many have<br>encountered. IP masquerade is the name given to one type of network address translation that allows all of the<br>hosts on a private network to use the Internet at the price of a single IP address.<br>
&nbsp;IP masquerading allows you to use a private (reserved) IP network address on your LAN and have your<br>Linux−based router perform some clever, real−time translation of IP addresses and ports. When it receives a<br>datagram from a computer on the LAN, it takes note of the type of datagram it is, TCP, UDP, ICMP,<br>etc., and modifies the datagram so that it looks like it was generated by the router machine itself (and<br>remembers that it has done so). It then transmits the datagram onto the Internet with its single connected IP<br>address. When the destination host receives this datagram, it believes the datagram has come from the routing<br>host and sends any reply datagrams back to that address. When the Linux masquerade router receives a<br>datagram from its Internet connection, it looks in its table of established masqueraded connections to see if<br>this datagram actually belongs to a computer on the LAN, and if it does, it reverses the modification it did on<br>the forward path and transmits the datagram to the LAN computer.<br>
A simple example is illustrated in&nbsp;<a href="TLNAGs.html#243">Figure 11−1</a>.<br>
<b>Figure 11−1. A typical IP masquerade configuration</b><br>
Chapter 11. IP Masquerade and Network Address Translation<br>
227<br>
<hr>
<A name=244></a><IMG src="TLNAG-244_1.png"><br>
Linux Network Administrators Guide<br>
We have a small Ethernet network using one of the reserved network addresses. The network has a<br>Linux−based masquerade router providing access to the Internet. One of the workstations on the network<br>(192.168.1.3) wishes to establish a connection to the remote host 209.1.106.178 on port 8888. The<br>workstation routes its datagram to the masquerade router, which identifies this connection request as<br>requiring masquerade services. It accepts the datagram and allocates a port number to use (1035), substitutes<br>its own IP address and port number for those of the originating host, and transmits the datagram to the<br>destination host. The destination host believes it has received a connection request from the Linux<br>masquerade host and generates a reply datagram. The masquerade host, upon receiving this datagram, finds<br>the association in its masquerade table and reverses the substution it performed on the outgoing datagram. It<br>then transmits the reply datagram to the originating host.<br>
The local host believes it is speaking directly to the remote host. The remote host knows nothing about the<br>local host at all and believes it has received a connection from the Linux masquerade host. The Linux<br>masquerade host knows these two hosts are speaking to each other, and on what ports, and performs the<br>address and port translations necessary to allow communication.<br>
This might all seem a little confusing, and it can be, but it works and is really quite simple to configure. So<br>don't worry if you don't understand all the details yet.<br>
Chapter 11. IP Masquerade and Network Address Translation<br>
228<br>
<hr>
<A name=245></a><b>11.1. Side Effects and Fringe Benefits</b><br>
The IP masquerade facility comes with its own set of side effects, some of which are useful and some of<br>which might become bothersome.<br>
None of the hosts on the supported network behind the masquerade router are ever directly seen;<br>consequently, you need only one valid and routable IP address to allow all hosts to make network<br>connections out onto the Internet. This has a downside; none of those hosts are visible from the Internet and<br>you can't directly connect to them from the Internet; the only host visible on a masqueraded network is the<br>masquerade machine itself. This is important when you consider services such as mail or FTP. It helps<br>determine what services should be provided by the masquerade host and what services it should proxy or<br>otherwise treat specially.<br>
Second, because none of the masqueraded hosts are visible, they are relatively protected from attacks from<br>outside; this could simplify or even remove the need for firewall configuration on the masquerade host. You<br>shouldn't rely too heavily on this, though. Your whole network will be only as safe as your masquerade host,<br>so you should use firewall to protect it if security is a concern.<br>
Third, IP masquerade will have some impact on the performance of your networking. In typical<br>configurations this will probably be barely measurable. If you have large numbers of active masquerade<br>sessions, though, you may find that the processing required at the masquerade machine begins to impact your<br>network throughput. IP masquerade must do a good deal of work for each datagram compared to the process<br>of conventional routing. That 386SX16 machine you have been planning on using as a masquerade machine<br>supporting a dial−up link to the Internet might be fine, but don't expect too much if you decide you want to<br>use it as a router in your corporate network at Ethernet speeds.<br>
Last, some network services just won't work through masquerade, or at least not without a lot of help.<br>Typically, these are services that rely on incoming sessions to work, such as some types of Direct<br>Communications Channels (DCC), features in IRC, or certain types of video and audio multicasting services.<br>Some of these services have specially developed kernel modules to provide solutions for these, and we'll talk<br>about those in a moment. For others, it is possible that you will find no support, so be aware,it won't be<br>suitable in all situations.<br>
11.1. Side Effects and Fringe Benefits<br>
229<br>
<hr>
<A name=246></a><b>11.2. Configuring the Kernel for IP Masquerade</b><br>
&nbsp;To use the IP masquerade facility, your kernel must be compiled with masquerade support. You must select<br>the following options when configuring a 2.2 series kernel:<br>
Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] Network firewalls<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] TCP/IP networking<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] IP: firewalling<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] IP: masquerading<br>
&nbsp; &nbsp; &nbsp; &nbsp; −−− Protocol−specific masquerading support will be built as modules.<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] IP: ipautofw masq support<br>
&nbsp; &nbsp; &nbsp; &nbsp; [*] IP: ICMP masquerading<br>
Note that some of the masquerade support is available only as a kernel module. This means that you must<br>ensure that you&nbsp;make modules&nbsp;in addition to the usual&nbsp;make zImage&nbsp;when building your kernel.<br>
The 2.4 series kernels no longer offer IP masquerade support as a kernel compile time option. Instead, you<br>should select the network packet filtering option:<br>
Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; [M] Network packet filtering (replaces ipchains)<br>
In the 2.2 series kernels, a number of protocol−specific helper modules are created during kernel compilation.<br>Some protocols begin with an outgoing request on one port, and then expect an incoming connection on<br>another. Normally these cannot be masqueraded, as there is no way of associating the second connection with<br>the first without peering inside the protocols themselves. The helper modules do just that; they actually look<br>inside the datagrams and allow masquerading to work for supported protocols that otherwise would be<br>impossible to masquerade. The supported protocols are:<br>
<b>Module</b><br>
<b>Protocol</b><br>
ip_masq_ftp<br>
FTP<br>
ip_masq_irc<br>
IRC<br>
ip_masq_raudio<br>
RealAudio<br>
ip_masq_cuseeme&nbsp;CU−See−Me<br>
ip_masq_vdolive<br>
For VDO Live<br>
ip_masq_quake<br>
IdSoftware's Quake<br>
You must load these modules manually using the&nbsp;<b>insmod</b>&nbsp;command to implement them. Note that these<br>modules cannot be loaded using the&nbsp;<b>kerneld</b>&nbsp;daemon. Each of the modules takes an argument specifying<br>what ports it will listen on. For the RealAudio&quot; module you might use:[66]<br>
#&nbsp;<b>insmod ip_masq_raudio.o ports=7070,7071,7072</b><br>
The ports you need to specify depend on the protocol. An IP masquerade mini−HOWTO written by Ambrose<br>Au explains more about the IP masquerade modules and how to configure them.[67]<br>
11.2. Configuring the Kernel for IP Masquerade<br>
230<br>
<hr>
<A name=247></a>Linux Network Administrators Guide<br>
The&nbsp;<i>netfilter</i>&nbsp;package includes modules that perform similar functions. For example, to provide connection<br>tracking of FTP sessions, you'd load and use the&nbsp;ip_conntrack_ftp&nbsp;and&nbsp;ip_nat_ftp.o&nbsp;modules.<br>
11.2. Configuring the Kernel for IP Masquerade<br>
231<br>
<hr>
<A name=248></a><b>11.3. Configuring IP Masquerade</b><br>
&nbsp;If you've already read the firewall and accounting chapters, it probably comes as no surprise that the<br><b>ipfwadm</b>,&nbsp;<b>ipchains</b>, and&nbsp;<b>iptables</b>&nbsp;commands are used to configure the IP masquerade rules as well.<br>
Masquerade rules are a special class of filtering rule. You can masquerade only datagrams that are received<br>on one interface that will be routed to another interface. To configure a masquerade rule you construct a rule<br>very similar to a firewall forwarding rule, but with special options that tell the kernel to masquerade the<br>datagram. The&nbsp;<b>ipfwadm</b>&nbsp;command uses the&nbsp;<i>−m</i>&nbsp;option,&nbsp;<b>ipchains</b>&nbsp;uses&nbsp;−j MASQ, and&nbsp;<b>iptables</b>&nbsp;uses&nbsp;−j<br>MASQUERADE&nbsp;to indicate that datagrams matching the rule specification should be masqueraded.<br>
Let's look at an example. A computing science student at Groucho Marx University has a number of<br>computers at home internetworked onto a small Ethernet−based local area network. She has chosen to use<br>one of the reserved private Internet network addresses for her network. She shares her accomodation with<br>other students, all of whom have an interest in using the Internet. Because student living conditions are very<br>frugal, they cannot afford to use a permanent Internet connection, so instead they use a simple dial−up PPP<br>Internet connection. They would all like to be able to share the connection to chat on IRC, surf the Web, and<br>retrieve files by FTP directly to each of their computersIP masquerade is the answer.<br>
The student first configures a Linux machine to support the dial−up link and to act as a router for the LAN.<br>The IP address she is assigned when she dials up isn't important. She configures the Linux router with IP<br>masquerade and uses one of the private network addresses for her LAN:&nbsp;192.168.1.0. She ensures that<br>each of the hosts on the LAN has a default route pointing at the Linux router.<br>
The following&nbsp;<b>ipfwadm</b>&nbsp;commands are all that are required to make masquerading work in her configuration:<br>
#&nbsp;<b>ipfwadm −F −p deny</b><br>
#&nbsp;<b>ipfwadm −F −a accept −m −S 192.168.1.0/24 −D 0/0</b><br>
or with&nbsp;<b>ipchains</b>:<br>
#&nbsp;<b>ipchains −P forward −j deny</b><br>
#&nbsp;<b>ipchains −A forward −s 192.168.1.0/24 −d 0/0 −j MASQ</b><br>
or with&nbsp;<b>iptables</b>:<br>
#&nbsp;<b>iptables −t nat −P POSTROUTING DROP</b><br>
#&nbsp;<b>iptables −t nat −A POSTROUTING −o ppp0 −j MASQUERADE</b><br>
Now whenever any of the LAN hosts try to connect to a service on a remote host, their datagrams will be<br>automatically masqueraded by the Linux masquerade router. The first rule in each example prevents the<br>Linux machine from routing any other datagrams and also adds some security.<br>
To list the masquerade rules you have created, use the&nbsp;−l&nbsp;argument to the&nbsp;<b>ipfwadm</b>&nbsp;command, as we<br>described in earlier while discussing firewalls.<br>
To list the rule we created earlier we use:<br>
#&nbsp;<b>ipfwadm −F −l −e</b><br>
which should display something like:<br>
11.3. Configuring IP Masquerade<br>
232<br>
<hr>
<A name=249></a>Linux Network Administrators Guide<br>
#&nbsp;<b>ipfwadm −F −l −e</b><br>
IP firewall forward rules, default policy: accept<br>
&nbsp;pkts bytes type &nbsp;prot opt &nbsp;tosa tosx ifname &nbsp;ifaddress &nbsp;&amp;<br>
&nbsp; &nbsp; 0 &nbsp; &nbsp; 0 acc/m all &nbsp;−−−− 0xFF 0x00 any &nbsp; &nbsp; any &nbsp; &nbsp; &nbsp; &nbsp;&amp;<br>
The&nbsp;/m&nbsp;in the output indicates this is a masquerade rule.<br>
To list the masquerade rules with the&nbsp;<b>ipchains</b>&nbsp;command, use the&nbsp;<b>−L</b>&nbsp;argument. If we list the rule we created<br>earlier with&nbsp;<b>ipchains</b>, the output will look like:<br>
<b># ipchains −L</b><br>
Chain input (policy ACCEPT):<br>
Chain forward (policy ACCEPT):<br>
target &nbsp; &nbsp; prot opt &nbsp; &nbsp; source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;destination &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ports<br>
MASQ &nbsp; &nbsp; &nbsp; all &nbsp;−−−−−− &nbsp;192.168.1.0/24 &nbsp; &nbsp; &nbsp; &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n/a<br>
Chain output (policy ACCEPT):<br>
Any rules with a target of&nbsp;MASQ&nbsp;are masquerade rules.<br>
Finally, to list the rules using&nbsp;<b>iptables</b>&nbsp;you need to use:<br>
#&nbsp;<b>iptables −t nat −L</b><br>
Chain PREROUTING (policy ACCEPT)<br>
target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
Chain POSTROUTING (policy DROP)<br>
target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
MASQUERADE &nbsp;all &nbsp;−− &nbsp;anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anywhere &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MASQUERADE&nbsp;<br>
Chain OUTPUT (policy ACCEPT)<br>
target &nbsp; &nbsp; prot opt source &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destination &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
Again, masquerade rules appear with a target of&nbsp;MASQUERADE.<br>
<b>11.3.1. Setting Timing Parameters for IP Masquerade</b><br>
When each new connection is established, the IP masquerade software creates an association in memory<br>between each of the hosts involved in the connection. You can view these associations at any time by looking<br>at the&nbsp;/proc/net/ip_masquerade&nbsp;file. These associations will timeout after a period of inactivity,<br>though.<br>
You can set the timeout values using the&nbsp;<b>ipfwadm</b>&nbsp;command. The general syntax for this is:<br>
ipfwadm −M −s &lt;<i>tcp</i>&gt; &lt;<i>tcpfin</i>&gt; &lt;<i>udp</i>&gt;<br>
and for the&nbsp;<b>ipchains</b>&nbsp;command it is:<br>
ipchains −M −S &lt;<i>tcp</i>&gt; &lt;<i>tcpfin</i>&gt; &lt;<i>udp</i>&gt;<br>
The&nbsp;<i>iptables</i>&nbsp;implementation uses much longer default timers and does not allow you to set them.<br>
11.3.1. Setting Timing Parameters for IP Masquerade<br>
233<br>
<hr>
<A name=250></a>Linux Network Administrators Guide<br>
Each of these values represents a timer used by the IP masquerade software and are in units of seconds. The<br>following table summarizes the timers and their meanings:<br>
<b>Name&nbsp;Description</b><br>
tcp<br>
TCP session timeout. How long a TCP connection may remain idle before the association for it is<br>removed.<br>
tcpfin<br>
TCP timeout after FIN. How long an association will remain after a TCP connection has been<br>disconnected.<br>
udp<br>
UDP session timeout. How long a UDP connection may remain idle before the association for it is<br>removed.<br>
11.3.1. Setting Timing Parameters for IP Masquerade<br>
234<br>
<hr>
<A name=251></a><b>11.4. Handling Name Server Lookups</b><br>
&nbsp;Handling domain name server lookups from the hosts on the LAN with IP masquerading has always<br>presented a problem. There are two ways of accomodating DNS in a masquerade environment. You can tell<br>each of the hosts that they use the same DNS that the Linux router machine does, and let IP masquerade do<br>its magic on their DNS requests. Alternatively, you can run a caching name server on the Linux machine and<br>have each of the hosts on the LAN use the Linux machine as their DNS. Although a more aggressive action,<br>this is probably the better option because it reduces the volume of DNS traffic travelling on the Internet link<br>and will be marginally faster for most requests, since they'll be served from the cache. The downside to this<br><a href="TLNAGs.html#141">configuration is that it is more complex.&nbsp;Section 6.3.4, in Chapter 6, describes how to configure a caching<br></a>name server.<br>
11.4. Handling Name Server Lookups<br>
235<br>
<hr>
<A name=252></a><b>11.5. More About Network Address Translation</b><br>
The&nbsp;<i>netfilter</i>&nbsp;software is capable of many different types of Network Address Translation. IP Masquerade is<br>one simple application of it.<br>
It is possible, for example, to build NAT rules that translate only certain addresses or ranges of addresses and<br>leave all others untouched, or to translate addresses into pools of addresses rather than just a single address,<br>as masquerade does. You can in fact use the&nbsp;<b>iptables</b>&nbsp;command to generate NAT rules that map just about<br>anything, with combinations of matches using any of the standard attributes, such as source address,<br>destination address, protocol type, port number, etc.<br>
Translating the Source Address of a datagram is referred to as Source NAT, or&nbsp;SNAT, in the<br><i>netfilter</i>&nbsp;documentation. Translating the Destination Address of a datagram is known as Destination NAT,<br>or&nbsp;DNAT. Translating the TCP or UDP port is known by the term&nbsp;REDIRECT.&nbsp;SNAT,&nbsp;DNAT, and<br>REDIRECT&nbsp;are targets that you may use with the&nbsp;<b>iptables</b>&nbsp;command to build more complex and sophisticated<br>rules.<br>
&nbsp;The topic of Network Address Translation and its uses warrants at least a whole chapter of its<br>own.[68]&nbsp;Unfortunately we don't have the space in this book to cover it in any greater depth. You should read<br>the IPTABLES−HOWTO for more information, if you're interested in discovering more about how you<br>might use Network Address Translation.<br>
11.5. More About Network Address Translation<br>
236<br>
<hr>
<A name=253></a><b>Chapter 12. ImportantNetwork Features</b><br>
After successfully setting up IP and the resolver, you then must look at the services you want to provide over<br>the network. This chapter covers the configuration of a few simple network applications, including the<br><b>inetd</b>&nbsp;server and the programs from the&nbsp;<b>rlogin</b>&nbsp;family. We'll also deal briefly with the Remote Procedure Call<br>interface, upon which services like the Network File System (NFS) and the Network Information System<br>(NIS) are based. The configuration of NFS and NIS, however, is more complex and are described in separate<br>chapters, as are electronic mail and network news.<br>
Of course, we can't cover all network applications in this book. If you want to install one that's not discussed<br>here, like&nbsp;<b>talk</b>,&nbsp;<b>gopher</b>, or&nbsp;<b>http</b>, please refer to the manual pages of the server for details.<br>
Chapter 12. ImportantNetwork Features<br>
237<br>
<hr>
<A name=254></a><b>12.1. The inetd Super Server</b><br>
Programs that provide application services via the network are called network&nbsp;<i>daemons</i>. A daemon is a<br>program that opens a port, most commonly a well−known service port, and waits for incoming connections<br>on it. If one occurs, the daemon creates a child process that accepts the connection, while the parent continues<br>to listen for further requests. This mechanism works well, but has a few disadvantages; at least one instance<br>of every possible service you wish to provide must be active in memory at all times. In addition, the software<br>routines that do the listening and port handling must be replicated in every network daemon.<br>
To overcome these inefficiencies, most Unix installations run a special network daemon, what you might<br>consider a super server. This daemon creates sockets on behalf of a number of services and listens on all<br>of them simultaneously. When an incoming connection is received on any of these sockets, the super server<br>accepts the connection and spawns the server specified for this port, passing the socket across to the child to<br>manage. The server then returns to listening.<br>
&nbsp;The most common super server is called&nbsp;<b>inetd</b>, the Internet Daemon. It is started at system boot time and<br>takes the list of services it is to manage from a startup file named&nbsp;/etc/inetd.conf. In addition to those<br>servers, there are a number of trivial services performed by&nbsp;<b>inetd</b>&nbsp;itself called&nbsp;<i>internal services</i>. They include<br><b>chargen</b>, which simply generates a string of characters, and&nbsp;<b>daytime</b>, which returns the system's idea of the<br>time of day.<br>
An entry in this file consists of a single line made up of the following fields:<br>
<i>service&nbsp;type&nbsp;protocol&nbsp;wait&nbsp;user&nbsp;server&nbsp;cmdline</i><br>
Each of the fields is described in the following list:<br>
<i>service</i><br>
Gives the service name. The service name has to be translated to a port number by looking it up in<br>the&nbsp;/etc/services<a href="TLNAGs.html#259">&nbsp;file. This file will be described later in this chapter in the section&nbsp;Section<br>12.3</a>.<br>
<i>type</i><br>
Specifies a socket type, either stream (for connection−oriented protocols) or dgram (for datagram<br>protocols). TCP−based services should therefore always use stream, while UDP−based services<br>should always use dgram.<br>
<i>protocol</i><br>
Names the transport protocol used by the service. This must be a valid protocol name found in the<br>protocols&nbsp;file, explained later.<br>
<i>wait</i><br>
This option applies only to dgram sockets. It can be either wait or nowait. If wait is specified,<br><b>inetd</b>&nbsp;executes only one server for the specified port at any time. Otherwise, it immediately continues<br>to listen on the port after executing the server.<br>
12.1. The inetd Super Server<br>
238<br>
<hr>
<A name=255></a>Linux Network Administrators Guide<br>
This is useful for single−threaded servers that read all incoming datagrams until no more arrive,<br>and then exit. Most RPC servers are of this type and should therefore specify wait. The opposite type,<br>multi−threaded servers, allow an unlimited number of instances to run concurrently. These servers<br>should specify nowait.<br>
stream sockets should always use nowait.<br>
<i>user</i><br>
This is the login ID of the user who will own the process when it is executing. This will frequently be<br>the root user, but some services may use different accounts. It is a very good idea to apply the<br>principle of least privilege here, which states that you shouldn't run a command under a privileged<br>account if the program doesn't require this for proper functioning. For example, the NNTP news<br>server runs as news, while services that may pose a security risk (such as&nbsp;<b>tftp</b>&nbsp;or&nbsp;<b>finger</b>) are often run<br>as nobody.<br>
<i>server</i><br>
Gives the full pathname of the server program to be executed. Internal services are marked by the<br>keyword internal.<br>
<i>cmdline</i><br>
This is the command line to be passed to the server. It starts with the name of the server to be<br>executed and can include any arguments that need to be passed to it. If you are using the TCP<br>wrapper, you specify the full pathname to the server here. If not, then you just specify the server<br>name as you'd like it to appear in a process list. We'll talk about the TCP wrapper shortly.<br>
This field is empty for internal services.<br>
&nbsp;A sample&nbsp;inetd.conf&nbsp;<a href="TLNAGs.html#255">&nbsp;file is shown in&nbsp;Example 12−1. The&nbsp;</a><b>finger</b>&nbsp;service is commented out so that it is<br>not available. This is often done for security reasons, because it can be used by attackers to obtain names and<br>other details of users on your system.<br>
<b>Example 12−1. A Sample /etc/inetd.conf File</b><br>
#&nbsp;<br>
# inetd services<br>
ftp &nbsp; &nbsp; &nbsp;stream tcp nowait root &nbsp;/usr/sbin/ftpd &nbsp; &nbsp;in.ftpd −l<br>
telnet &nbsp; stream tcp nowait root &nbsp;/usr/sbin/telnetd in.telnetd −b/etc/issue<br>
#finger &nbsp;stream tcp nowait bin &nbsp; /usr/sbin/fingerd in.fingerd<br>
#tftp &nbsp; &nbsp;dgram &nbsp;udp wait &nbsp;nobody /usr/sbin/tftpd &nbsp; in.tftpd<br>
#tftp &nbsp; &nbsp;dgram &nbsp;udp wait &nbsp;nobody /usr/sbin/tftpd &nbsp; in.tftpd /boot/diskless<br>
#login &nbsp; stream tcp nowait root &nbsp;/usr/sbin/rlogind in.rlogind<br>
#shell &nbsp; stream tcp nowait root &nbsp;/usr/sbin/rshd &nbsp; &nbsp;in.rshd<br>
#exec &nbsp; &nbsp;stream tcp nowait root &nbsp;/usr/sbin/rexecd &nbsp;in.rexecd<br>
#<br>
# &nbsp; &nbsp; &nbsp; inetd internal services<br>
#<br>
daytime &nbsp;stream tcp nowait root internal<br>
daytime &nbsp;dgram &nbsp;udp nowait root internal<br>
time &nbsp; &nbsp; stream tcp nowait root internal<br>
time &nbsp; &nbsp; dgram &nbsp;udp nowait root internal<br>
12.1. The inetd Super Server<br>
239<br>
<hr>
<A name=256></a>Linux Network Administrators Guide<br>
echo &nbsp; &nbsp; stream tcp nowait root internal<br>
echo &nbsp; &nbsp; dgram &nbsp;udp nowait root internal<br>
discard &nbsp;stream tcp nowait root internal<br>
discard &nbsp;dgram &nbsp;udp nowait root internal<br>
chargen &nbsp;stream tcp nowait root internal<br>
chargen &nbsp;dgram &nbsp;udp nowait root internal<br>
&nbsp;The&nbsp;<b>tftp</b>&nbsp;daemon is shown commented out as well.&nbsp;<b>tftp</b>&nbsp;implements the&nbsp;<i>Trivial File Transfer<br>Protocol</i>&nbsp;(TFTP), which allows someone to transfer any world−readable files from your system without<br>password checking. This is especially harmful with the&nbsp;/etc/passwd&nbsp;file, and even more so when you<br>don't use shadow passwords.<br>
TFTP is commonly used by diskless clients and Xterminals to download their code from a boot server. If you<br>need to run&nbsp;<b>tftpd</b>&nbsp;for this reason, make sure to limit its scope to those directories from which clients will<br>retrieve files; you will need to add those directory names to&nbsp;<b>tftpd</b>'s command line. This is shown in the<br>second&nbsp;<b>tftp</b>&nbsp;line in the example.&nbsp;<br>
12.1. The inetd Super Server<br>
240<br>
<hr>
<A name=257></a><b>12.2. The tcpd Access Control Facility</b><br>
Since opening a computer to network access involves many security risks, applications are designed to guard<br>against several types of attacks. Some security features, however, may be flawed (most drastically<br>demonstrated by the RTM Internet worm, which exploited a hole in a number of programs, including old<br>versions of the sendmail mail daemon), or do not distinguish between secure hosts from which requests for a<br>particular service will be accepted and insecure hosts whose requests should be rejected. We've already<br>briefly discussed the&nbsp;<b>finger</b>&nbsp;and&nbsp;<b>tftp</b>&nbsp;services. Network Administrator would want to limit access to these<br>services to trusted hosts only, which is impossible with the usual setup, for which&nbsp;<b>inetd</b>&nbsp;provides this<br>service either to all clients or not at all.<br>
A useful tool for managing host−specific access is&nbsp;<b>tcpd</b>, often called the daemon wrapper.<br>
[69]&nbsp;For TCP<br>
services you want to monitor or protect, it is invoked instead of the server program.&nbsp;<b>tcpd</b>&nbsp;checks if the remote<br>host is allowed to use that service, and only if this succeeds will it execute the real server program.&nbsp;<b>tcpd</b>&nbsp;also<br>logs the request to the&nbsp;<b>syslog</b>&nbsp;daemon. Note that this does not work with UDP−based services.<br>
For example, to wrap the&nbsp;<b>finger</b>&nbsp;daemon, you have to change the corresponding line in&nbsp;inetd.conf&nbsp;from<br>this:<br>
# unwrapped finger daemon<br>
finger &nbsp; &nbsp;stream tcp nowait bin &nbsp; &nbsp;/usr/sbin/fingerd in.fingerd<br>
to this:<br>
# wrap finger daemon<br>
finger &nbsp;stream &nbsp;tcp &nbsp; &nbsp; nowait &nbsp;root &nbsp; &nbsp;/usr/sbin/tcpd &nbsp; in.fingerd<br>
Without adding any access control, this will appear to the client as the usual&nbsp;<b>finger</b>&nbsp;setup, except that any<br>requests are logged to&nbsp;<b>syslog</b>'s&nbsp;<i>auth</i>&nbsp;facility.<br>
Two files called&nbsp;/etc/hosts.allow&nbsp;and&nbsp;/etc/hosts.deny&nbsp;implement access control. They contain<br>entries that allow and deny access to certain services and hosts. When&nbsp;<b>tcpd</b>&nbsp;handles a request for a service<br>such as&nbsp;<b>finger</b>&nbsp;from a client host named biff.foobar.com, it scans&nbsp;hosts.allow&nbsp;and&nbsp;hosts.deny&nbsp;(in this<br>order) for an entry matching both the service and client host. If a matching entry is found in&nbsp;hosts.allow,<br>access is granted and&nbsp;<b>tcpd</b>&nbsp;doesn't consult the&nbsp;hosts.deny&nbsp;file. If no match is found in the<br>hosts.allow&nbsp;file, but a match is found in&nbsp;hosts.deny, the request is rejected by closing down the<br>connection. The request is accepted if no match is found at all.<br>
Entries in the access files look like this:<br>
<i>servicelist</i>:&nbsp;<i>hostlist</i>&nbsp;[:<i>shellcmd</i>]<br>
<i>servicelist</i>&nbsp;is a list of service names from&nbsp;/etc/services, or the keyword ALL. To match all<br>services except&nbsp;<b>finger</b>&nbsp;and&nbsp;<b>tftp</b>, use ALL EXCEPT&nbsp;finger, tftp.<br>
<i>hostlist</i>&nbsp;is a list of hostnames, IP addresses, or the keywords ALL, LOCAL, UNKNOWN or<br>PARANOID. ALL matches any host, while LOCAL matches hostnames that don't contain a<br>dot.[70]&nbsp;UNKNOWN matches any hosts whose name or address lookup failed. PARANOID matches any<br>host whose hostname does not resolve back to its IP address.[71]&nbsp;A name starting with a dot matches all hosts<br>whose domain is equal to this name. For example, .foobar.com matches biff.foobar.com, but not<br>nurks.fredsville.com. A pattern that ends with a dot matches any host whose IP address begins with the<br>
12.2. The tcpd Access Control Facility<br>
241<br>
<hr>
<A name=258></a>Linux Network Administrators Guide<br>
supplied pattern, so 172.16. matches 172.16.32.0, but not 172.15.9.1. A pattern of the form<br><i>n.n.n.n</i>/<i>m.m.m.m</i>&nbsp;is treated as an IP address and network mask, so we could specify our previous<br>example as 172.16.0.0/255.255.0.0 instead. Lastly, any pattern beginning with a / character allows you to<br>specify a file that is presumed to contain a list of hostname or IP address patterns, any of which are allowed<br>to match. So a pattern that looked like&nbsp;<i>/var/access/trustedhosts</i>&nbsp;would cause the&nbsp;<b>tcpd</b>&nbsp;daemon to read that file,<br>testing if any of the lines in it matched the connecting host.<br>
To deny access to the&nbsp;<b>finger</b>&nbsp;and&nbsp;<b>tftp</b>&nbsp;services to all but the local hosts, put the following in<br>/etc/hosts.deny&nbsp;and leave&nbsp;/etc/hosts.allow&nbsp;empty:<br>
in.tftpd, in.fingerd: ALL EXCEPT LOCAL,&nbsp;<i>.your.domain</i><br>
The optional&nbsp;<i>shellcmd</i>&nbsp;field may contain a shell command to be invoked when the entry is matched. This<br>is useful to set up traps that may expose potential attackers. The following example creates a log file listing<br>the user and host connecting, and if the host is not&nbsp;<i>vlager.vbrew.com</i>&nbsp;it will append the output of a&nbsp;<b>finger</b>&nbsp;to<br>that host:<br>
in.ftpd: ALL EXCEPT LOCAL, .vbrew.com : \<br>
&nbsp; &nbsp; &nbsp; echo &quot;request from %d@%h: &gt;&gt; /var/log/finger.log; \<br>
&nbsp; &nbsp; &nbsp; if [ %h != &quot;vlager.vbrew.com:&quot; ]; then \&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; finger −l @%h &gt;&gt; /var/log/finger.log \<br>
&nbsp; &nbsp; &nbsp; fi<br>
The %h and %d arguments are expanded by&nbsp;<b>tcpd</b>&nbsp;to the client hostname and service name, respectively.<br>Please refer to the&nbsp;hosts_access(5)&nbsp;manual page for details.&nbsp;<br>
12.2. The tcpd Access Control Facility<br>
242<br>
<hr>
<A name=259></a><b>12.3. The Services and Protocols Files</b><br>
The port numbers on which certain standard services are offered are defined in the Assigned Numbers<br>RFC. To enable server and client programs to convert service names to these numbers, at least part of the list<br>is kept on each host; it is stored in a file called&nbsp;/etc/services. An entry is made up like this:<br>
<i>service&nbsp;port</i>/<i>protocol</i>&nbsp; &nbsp;[<i>aliases</i>]<br>
Here,&nbsp;<i>service</i>&nbsp;specifies the service name,&nbsp;<i>port</i>&nbsp;defines the port the service is offered on, and<br><i>protocol</i>&nbsp;defines which transport protocol is used. Commonly, the latter field is either&nbsp;<i>udp</i>&nbsp;or&nbsp;<i>tcp</i>. It is<br>possible for a service to be offered for more than one protocol, as well as offering different services on the<br>same port as long as the protocols are different. The&nbsp;<i>aliases</i>&nbsp;field allows you to specify alternative names<br>for the same service.<br>
Usually, you don't have to change the services file that comes along with the network software on your Linux<br><a href="TLNAGs.html#259">system. Nevertheless, we give a small excerpt from that file in&nbsp;Example 12−2.</a><br>
<b>Example 12−2. A Sample /etc/services File</b><br>
# The services file:<br>
#<br>
# well−known services<br>
echo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Echo<br>
echo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7/udp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #<br>
discard &nbsp; &nbsp; &nbsp; &nbsp;9/tcp &nbsp;sink null &nbsp; &nbsp; &nbsp;# Discard<br>
discard &nbsp; &nbsp; &nbsp; &nbsp;9/udp &nbsp;sink null &nbsp; &nbsp; &nbsp;#<br>
daytime &nbsp; &nbsp; &nbsp; 13/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Daytime<br>
daytime &nbsp; &nbsp; &nbsp; 13/udp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #<br>
chargen &nbsp; &nbsp; &nbsp; 19/tcp &nbsp;ttytst source &nbsp;# Character Generator<br>
chargen &nbsp; &nbsp; &nbsp; 19/udp &nbsp;ttytst source &nbsp;#<br>
ftp−data &nbsp; &nbsp; &nbsp;20/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # File Transfer Protocol (Data)<br>
ftp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 21/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # File Transfer Protocol (Control)<br>
telnet &nbsp; &nbsp; &nbsp; &nbsp;23/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Virtual Terminal Protocol<br>
smtp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;25/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Simple Mail Transfer Protocol<br>
nntp &nbsp; &nbsp; &nbsp; &nbsp; 119/tcp &nbsp;readnews &nbsp; &nbsp; &nbsp; # Network News Transfer Protocol<br>
#<br>
# UNIX services<br>
exec &nbsp; &nbsp; &nbsp; &nbsp; 512/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # BSD rexecd<br>
biff &nbsp; &nbsp; &nbsp; &nbsp; 512/udp &nbsp;comsat &nbsp; &nbsp; &nbsp; &nbsp; # mail notification<br>
login &nbsp; &nbsp; &nbsp; &nbsp;513/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # remote login<br>
who &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;513/udp &nbsp;whod &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # remote who and uptime<br>
shell &nbsp; &nbsp; &nbsp; &nbsp;514/tcp &nbsp;cmd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# remote command, no passwd used<br>
syslog &nbsp; &nbsp; &nbsp; 514/udp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # remote system logging<br>
printer &nbsp; &nbsp; &nbsp;515/tcp &nbsp;spooler &nbsp; &nbsp; &nbsp; &nbsp;# remote print spooling<br>
route &nbsp; &nbsp; &nbsp; &nbsp;520/udp &nbsp;router routed &nbsp;# routing information protocol<br>
Note that the&nbsp;<b>echo</b>&nbsp;service is offered on port 7 for both TCP and UDP, and that port 512 is used for two<br>different services: remote execution (<b>rexec</b>) using TCP, and the&nbsp;<b>COMSAT</b>&nbsp;daemon, which notifies users of<br>new mail, over UDP (see&nbsp;<b>xbiff(1x)</b>).<br>
Like the services file, the networking library needs a way to translate protocol namesfor example, those<br>used in the services fileto protocol numbers understood by the IP layer on other hosts. This is done by<br>looking up the name in the&nbsp;/etc/protocols&nbsp;file. It contains one entry per line, each containing a protocol<br>name, and the associated number. Having to touch this file is even more unlikely than having to meddle with<br>
12.3. The Services and Protocols Files<br>
243<br>
<hr>
<A name=260></a>Linux Network Administrators Guide<br>
/etc/services. A sample file is given in&nbsp;<a href="TLNAGs.html#260">Example 12−3.</a><br>
<b>Example 12−3. A Sample /etc/protocols File</b><br>
#<br>
# Internet (IP) protocols<br>
#<br>
ip &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; IP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# internet protocol, pseudo protocol number<br>
icmp &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; ICMP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# internet control message protocol<br>
igmp &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; IGMP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# internet group multicast protocol<br>
tcp &nbsp; &nbsp; 6 &nbsp; &nbsp; &nbsp; TCP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # transmission control protocol<br>
udp &nbsp; &nbsp; 17 &nbsp; &nbsp; &nbsp;UDP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # user datagram protocol<br>
raw &nbsp; &nbsp; 255 &nbsp; &nbsp; RAW &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # RAW IP interface<br>
12.3. The Services and Protocols Files<br>
244<br>
<hr>
<A name=261></a><b>12.4. Remote Procedure Call</b><br>
The general mechanism for client−server applications is provided by the&nbsp;<i>Remote Procedure Call</i>&nbsp;(RPC)<br>package. RPC was developed by Sun Microsystems and is a collection of tools and library functions.<br><a href="TLNAGs.html#270">Important applications built on top of RPC are NIS, the Network Information System (described in&nbsp;Chapter<br>13</a>), and NFS, the Network File System (described in&nbsp;<a href="TLNAGs.html#287">Chapter 14</a>), which are both described in this book.<br>
&nbsp;An RPC server consists of a collection of procedures that a client can call by sending an RPC request to the<br>server along with the procedure parameters. The server will invoke the indicated procedure on behalf of the<br>client, handing back the return value, if there is any. In order to be machine−independent, all data exchanged<br>between client and server is converted to the&nbsp;<i>External Data Representation</i>&nbsp;format (XDR) by the sender, and<br>converted back to the machine−local representation by the receiver. RPC relies on standard UDP and TCP<br>sockets to transport the XDR formatted data to the remote host. Sun has graciously placed RPC in the public<br>domain; it is described in a series of RFCs.<br>
Sometimes improvements to an RPC application introduce incompatible changes in the procedure call<br>interface. Of course, simply changing the server would crash all applications that still expect the original<br>behavior. Therefore, RPC programs have version numbers assigned to them, usually starting with 1, and with<br>each new version of the RPC interface, this counter will be bumped up. Often, a server may offer several<br>versions simultaneously; clients then indicate by the version number in their requests which implementation<br>of the service they want to use.<br>
&nbsp;The communication between RPC servers and clients is somewhat peculiar. An RPC server offers one or<br>more collections of procedures; each set is called a&nbsp;<i>program</i>&nbsp;and is uniquely identified by a&nbsp;<i>program number</i>.<br>A list that maps service names to program numbers is usually kept in&nbsp;/etc/rpc, an excerpt of which is<br>shown in&nbsp;<a href="TLNAGs.html#261">Example 12−4</a>.<br>
<b>Example 12−4. A Sample /etc/rpc File</b><br>
#<br>
# /etc/rpc − miscellaneous RPC−based services<br>
#<br>
portmapper &nbsp; &nbsp; &nbsp;100000 &nbsp;portmap sunrpc<br>
rstatd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;100001 &nbsp;rstat rstat_svc rup perfmeter<br>
rusersd &nbsp; &nbsp; &nbsp; &nbsp; 100002 &nbsp;rusers<br>
nfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 100003 &nbsp;nfsprog<br>
ypserv &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;100004 &nbsp;ypprog<br>
mountd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;100005 &nbsp;mount showmount<br>
ypbind &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;100007<br>
walld &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 100008 &nbsp;rwall shutdown<br>
yppasswdd &nbsp; &nbsp; &nbsp; 100009 &nbsp;yppasswd<br>
bootparam &nbsp; &nbsp; &nbsp; 100026<br>
ypupdated &nbsp; &nbsp; &nbsp; 100028 &nbsp;ypupdate<br>
In TCP/IP networks, the authors of RPC faced the problem of mapping program numbers to generic network<br>services. They designed each server to provide both a TCP and a UDP port for each program and each<br>version. Generally, RPC applications use UDP when sending data, and fall back to TCP only when the data<br>to be transferred doesn't fit into a single UDP datagram.<br>
&nbsp;Of course, client programs need to find out to which port a program number maps. Using a configuration<br>file for this would be too unflexible; since RPC applications don't use reserved ports, there's no guarantee that<br>a port originally meant to be used by our database application hasn't been taken by some other process.<br>
12.4. Remote Procedure Call<br>
245<br>
<hr>
<A name=262></a>Linux Network Administrators Guide<br>
Therefore, RPC applications pick any port they can get and register it with a special program called the<br><i>portmapper daemon</i>. The portmapper acts as a service broker for all RPC servers running on its machine. A<br>client that wishes to contact a service with a given program number first queries the portmapper on the<br>server's host, which returns the TCP and UDP port numbers the service can be reached at.<br>
This method introduces a single point of failure, much like the&nbsp;<b>inetd</b>&nbsp;daemon does for the standard Berkeley<br>services. However, this case is even a little worse because when the portmapper dies, all RPC port<br>information is lost; this usually means you have to restart all RPC servers manually or reboot the entire<br>machine.<br>
On Linux, the portmapper is called&nbsp;/sbin/portmap, or sometimes&nbsp;/usr/sbin/rpc.portmap. Other<br>than making sure it is started from your network boot scripts, the portmapper doesn't require any<br>configuration.<br>
12.4. Remote Procedure Call<br>
246<br>
<hr>
<A name=263></a><b>12.5. Configuring Remote Loginand Execution</b><br>
It's often very useful to execute a command on a remote host and have input or output from that command be<br>read from, or written to, a network connection.<br>
&nbsp;The traditional commands used for executing commands on remote hosts are&nbsp;<b>rlogin</b>,&nbsp;<b>rsh</b>&nbsp;and&nbsp;<b>rcp</b>. We saw<br>an example of the&nbsp;<b>rlogin</b>&nbsp;command in&nbsp;<a href="TLNAGs.html#37">Chapter 1&nbsp;in the section&nbsp;</a><a href="TLNAGs.html#39">Section 1.2.1. We briefly discussed the<br></a><a href="TLNAGs.html#50">security issues associated with it in&nbsp;Section 1.5.1&nbsp;and suggested&nbsp;</a><b>ssh</b>&nbsp;as a replacement. The&nbsp;<b>ssh</b>&nbsp;package<br>provides replacements called&nbsp;<b>slogin</b>,&nbsp;<b>ssh</b>, and&nbsp;<b>scp</b>.<br>
Each of these commands spawns a shell on the remote host and allows the user to execute commands. Of<br>course, the client needs to have an account on the remote host where the command is to be executed. Thus, all<br>these commands use an authentication process. The&nbsp;<i>r</i>&nbsp;commands use a simple username and password<br>exchange between the hosts with no encryption, so anyone listening could easily intercept the passwords. The<br><b>ssh</b>&nbsp;command suite provides a higher level of security: it uses a technique called&nbsp;<b>Public Key Cryptography</b>,<br>which provides authentication and encryption between the hosts to ensure that neither passwords nor session<br>data are easily intercepted by other hosts.<br>
It is possible to relax authentication checks for certain users even further. For instance, if you frequently<br>have to log into other machines on your LAN, you might want to be admitted without having to type your<br>password every time. This was always possible with the&nbsp;<i>r</i>&nbsp;commands, but the&nbsp;<b>ssh</b>&nbsp;suite allows you to do this a<br>little more easily. It's still not a great idea because it means that if an account on one machine is breached,<br>access can be gained to all other accounts that user has configured for password−less login, but it is very<br>convenient and people will use it.<br>
Let's talk about removing the&nbsp;<i>r</i>&nbsp;commands and getting&nbsp;<b>ssh</b>&nbsp;to work instead.<br>
<b>12.5.1. Disabling the r; Commands</b><br>
Start by removing the&nbsp;<b>r</b>&nbsp;commands if they're installed. The easiest way to disable the old&nbsp;<b>r</b>&nbsp;commands is to<br>comment out (or remove) their entries in the&nbsp;/etc/inetd.conf&nbsp;file. The relevant entries will look<br>something like this:<br>
# Shell, login, exec and talk are BSD protocols.<br>
shell &nbsp; &nbsp;stream &nbsp;tcp &nbsp; &nbsp; nowait &nbsp;root &nbsp;/usr/sbin/tcpd /usr/sbin/in.rshd<br>
login &nbsp; &nbsp;stream &nbsp;tcp &nbsp; &nbsp; nowait &nbsp;root &nbsp;/usr/sbin/tcpd /usr/sbin/in.rlogind<br>
exec &nbsp; &nbsp; stream &nbsp;tcp &nbsp; &nbsp; nowait &nbsp;root &nbsp;/usr/sbin/tcpd /usr/sbin/in.rexecd<br>
You can comment them by placing a&nbsp;#&nbsp;character at the start of each line, or delete the lines completely.<br>Remember, you need to restart the&nbsp;<b>inetd</b>&nbsp;daemon for this change to take effect. Ideally, you should remove<br>the daemon programs themselves, too.<br>
<b>12.5.2. Installing and Configuring ssh</b><br>
&nbsp;OpenSSH is a free version of the ssh suite of programs; the Linux port can be found at<br>http://violet.ibs.com.au/openssh/ and in most modern Linux distributions.[72]&nbsp;We won't describe compilation<br>here; good instructions are included in the source. If you can install it from a precompiled package, then it's<br>
12.5. Configuring Remote Loginand Execution<br>
247<br>
<hr>
<A name=264></a>Linux Network Administrators Guide<br>
probably wise to do so.<br>
There are two parts to an&nbsp;<b>ssh</b>&nbsp;session. There is an&nbsp;<b>ssh</b>&nbsp;client that you need to configure and run on the local<br>host and an&nbsp;<b>ssh</b>&nbsp;daemon that must be running on the remote host.<br>
<b>12.5.2.1. The ssh daemon</b><br>
&nbsp;The&nbsp;<b>sshd</b>&nbsp;daemon is the program that listens for network connections from&nbsp;<b>ssh</b>&nbsp;clients, manages<br>authentication, and executes the requested command. It has one main configuration file called<br>/etc/ssh/sshd_config&nbsp;and a special file containing a key used by the authentication and encryption<br>processes to represent the host end. Each host and each client has its own key.<br>
&nbsp;A utility called&nbsp;<b>ssh−keygen</b>&nbsp;is supplied to generate a random key. This is usually used once at installation<br>time to generate the host key, which the system administrator usually stores in a file called<br>/etc/ssh/ssh_host_key. Keys can be of any length of 512 bits or greater. By default,<br><b>ssh−keygen</b>&nbsp;generates keys of 1024 bits in length, and most people use the default. To generate a random<br>key, you would invoke the&nbsp;<b>ssh−keygen</b>&nbsp;command like this:<br>
#&nbsp;<b>ssh−keygen −f /etc/ssh/ssh_host_key</b><br>
You will be prompted to enter a passphrase. However, host keys must not use a passphrase, so just press the<br>return key to leave it blank. The program output will look something like:<br>
Generating RSA keys: &nbsp;......oooooO...............................oooooO<br>
Key generation complete.<br>
Enter passphrase (empty for no passphrase):&nbsp;<br>
Enter same passphrase again:&nbsp;<br>
Your identification has been saved in /etc/ssh/ssh_host_key<br>
Your public key has been saved in /etc/ssh/ssh_host_key.pub<br>
The key fingerprint is:<br>
1024 3a:14:78:8e:5a:a3:6b:bc:b0:69:10:23:b7:d8:56:82 root@moria<br>
&nbsp;You will find at the end that two files have been created. The first is called the private key, which must be<br>kept secret and will be in&nbsp;/etc/ssh/ssh_host_key. The second is called the public key and is one that<br>you can share; it will be in&nbsp;/etc/ssh/ssh_host_key.pub.<br>
Armed with the keys for&nbsp;<b>ssh</b>&nbsp;communication, you need to create a configuration file. The&nbsp;<b>ssh</b>&nbsp;suite is very<br>powerful and the configuration file may contain many options. We'll present a simple example to get you<br>started; you should refer to the&nbsp;<b>ssh</b>&nbsp;documentation to enable other features. The following code shows a safe<br>and minimal&nbsp;<b>sshd</b>&nbsp;configuration file. The rest of the configuration options are detailed in the&nbsp;<b>sshd</b>(8)<br>manpage:<br>
# /etc/ssh/sshd_config<br>
#<br>
# The IP adddresses to listen for connections on. 0.0.0.0 means all<br>
# local addresses.<br>
ListenAddress 0.0.0.0<br>
# The TCP port to listen for connections on. The default is 22.<br>
12.5.2.1. The ssh daemon<br>
248<br>
<hr>
<A name=265></a>Linux Network Administrators Guide<br>
Port 22<br>
# The name of the host key file.<br>
HostKey /etc/ssh/ssh_host_key<br>
# The length of the key in bits.<br>
ServerKeyBits 1024<br>
# Should we allow root logins via ssh?<br>
PermitRootLogin no<br>
# Should the ssh daemon check users' home directory and files permissions?<br>
# are safe before allowing login?<br>
StrictModes yes<br>
# Should we allow old ~/.rhosts and /etc/hosts.equiv authentication method?<br>
RhostsAuthentication no<br>
# Should we allow pure RSA authentication?<br>
RSAAuthentication yes<br>
# Should we allow password authentication?<br>
PasswordAuthentication yes<br>
# Should we allow /etc/hosts.equiv combined with RSA host authentication?<br>
RhostsRSAAuthentication no<br>
# Should we ignore ~/.rhosts files?<br>
IgnoreRhosts yes<br>
# Should we allow logins to accounts with empty passwords?<br>
PermitEmptyPasswords no<br>
It's important to make sure the permissions of the configuration files are correct to ensure that system security<br>is maintained. Use the following commands:<br>
#&nbsp;<b>chown −R root:root /etc/ssh</b><br>
#&nbsp;<b>chmod 755 /etc/ssh</b><br>
#&nbsp;<b>chmod 600 /etc/ssh/ssh_host_key</b><br>
#&nbsp;<b>chmod 644 /etc/ssh/ssh_host_key.pub</b><br>
#&nbsp;<b>chmod 644 /etc/ssh/sshd_config</b><br>
The final stage of&nbsp;<b>sshd</b>&nbsp;administration daemon is to run it. Normally you'd create an&nbsp;rc&nbsp;file for it or add it to<br>an existing one, so that it is automatically executed at boot time. The daemon runs standalone and doesn't<br>require any entry in the&nbsp;/etc/inetd.conf&nbsp;file. The daemon must be run as the&nbsp;root&nbsp;user. The syntax is<br>very simple:<br>
/usr/sbin/sshd<br>
The&nbsp;<b>sshd</b>&nbsp;daemon will automatically place itself into the background when being run. You are now ready to<br>accept&nbsp;<i>ssh</i>&nbsp;connections.<br>
<b>12.5.2.2. The ssh client</b><br>
&nbsp;There are a number of&nbsp;<b>ssh</b>&nbsp;client programs:&nbsp;<b>slogin</b>,&nbsp;<b>scp</b>&nbsp;and&nbsp;<b>ssh</b>. They each read the same configuration file,<br>usually called&nbsp;/etc/ssh/ssh_config. They each also read configuration files from the&nbsp;.ssh&nbsp;directory<br>in the home directory of the user executing them. The most important of these files is the<br>.ssh/config&nbsp;file, which may contain options that override those specified in the<br>/etc/ssh/ssh_config&nbsp;file, the&nbsp;.ssh/identity&nbsp;file, which contains the user's own private key, and<br>
12.5.2.2. The ssh client<br>
249<br>
<hr>
<A name=266></a>Linux Network Administrators Guide<br>
the corresponding&nbsp;.ssh/identity.pub&nbsp;file, containing the user's public key. Other important files are<br>.ssh/known_hosts&nbsp;and&nbsp;.ssh/authorized_keys; we'll talk about those later in&nbsp;<a href="TLNAGs.html#267">Section 12.5.2.3</a>.<br>First, let's create the global configuration file and the user key file.<br>
/etc/ssh/ssh_config&nbsp;is very similar to the server configuration file. Again, there are lots of features<br><a href="TLNAGs.html#266">you can configure, but a minimal configuration looks like that presented in&nbsp;Example 12−5. The rest of the<br></a>configuration options are detailed in the&nbsp;<b>sshd(8)</b>&nbsp;manpage. You can add sections that match specific hosts or<br>groups of hosts. The parameter to the&nbsp;Host&nbsp;statement may be either the full name of a host or a wildcard<br>specification, as we've used in our example, to match all hosts. We could create an entry that used, for<br>example,&nbsp;Host *.vbrew.com&nbsp;to match any host in the&nbsp;vbrew.com&nbsp;domain.<br>
<b>Example 12−5. Example ssh Client Configuration File</b><br>
# /etc/ssh/ssh_config<br>
# Default options to use when connecting to a remote host<br>
Host *<br>
&nbsp; # Compress the session data?<br>
&nbsp; Compression yes<br>
&nbsp; # .. using which compression level? (1 − fast/poor, 9 − slow/good)<br>
&nbsp; CompressionLevel 6<br>
&nbsp; # Fall back to rsh if the secure connection fails?<br>
&nbsp; FallBackToRsh no<br>
&nbsp; # Should we send keep−alive messages? Useful if you use IP masquerade<br>
&nbsp; KeepAlive yes<br>
&nbsp; # Try RSA authentication?<br>
&nbsp; RSAAuthentication yes<br>
&nbsp; # Try RSA authentication in combination with .rhosts authentication?<br>
&nbsp; RhostsRSAAuthentication yes<br>
We mentioned in the server configuration section that every host and user has a key. The user's key is stored<br>in his or her&nbsp;~/.ssh/indentity&nbsp;file. To generate the key, use the same&nbsp;<b>ssh−keygen</b>&nbsp;command as we<br>used to generate the host key, except this time you do not need to specify the name of the file in which you<br>save the key. The&nbsp;<b>ssh−keygen</b>&nbsp;defaults to the correct location, but it prompts you to enter a filename in case<br>you'd like to save it elsewhere. It is sometimes useful to have multiple identity files, so&nbsp;<b>ssh</b>&nbsp;allows this. Just as<br>before,&nbsp;<b>ssh−keygen</b>&nbsp;will prompt you to entry a passphrase. Passphrases add yet another level of security and<br>are a good idea. Your passphrase won't be echoed on the screen when you type it.<br>
<b>Warning</b><br>
There is no way to recover a passphrase if you forget it. Make sure it is something you will remember, but as<br>with all passwords, make it something that isn't obvious, like a proper noun or your name. For a passphrase<br>to be truly effective, it should be between 10 and 30 characters long and not be plain English prose. Try to<br>throw in some unusual characters. If you forget your passphrase, you will be forced to generate a new key.<br>
You should ask each of your users to run the&nbsp;<b>ssh−keygen</b>&nbsp;command just once to ensure their key file is<br>created correctly. The&nbsp;<b>ssh−keygen</b>&nbsp;will create their&nbsp;~/.ssh/&nbsp;directories for them with appropriate<br>permissions and create their private and public keys in&nbsp;.ssh/identity&nbsp;and&nbsp;.ssh/identity.pub,<br>respectively. A sample session should look like:<br>
12.5.2.2. The ssh client<br>
250<br>
<hr>
<A name=267></a>Linux Network Administrators Guide<br>
$&nbsp;<b>ssh−keygen</b><br>
Generating RSA keys: &nbsp;.......oooooO..............................<br>
Key generation complete.<br>
Enter file in which to save the key (/home/maggie/.ssh/identity):&nbsp;<br>
Enter passphrase (empty for no passphrase):&nbsp;<br>
Enter same passphrase again:&nbsp;<br>
Your identification has been saved in /home/maggie/.ssh/identity.<br>
Your public key has been saved in /home/maggie/.ssh/identity.pub.<br>
The key fingerprint is:<br>
1024 85:49:53:f4:8a:d6:d9:05:d0:1f:23:c4:d7:2a:11:67 maggie@moria<br>
$<br>
Now&nbsp;<b>ssh</b>&nbsp;is ready to run.<br>
<b>12.5.2.3. Using ssh</b><br>
We should now have the&nbsp;<b>ssh</b>&nbsp;command and it's associated programs installed and ready to run. Let's now<br>take a quick look at how to run them.<br>
&nbsp;First, we'll try a remote login to a host. We can use the&nbsp;<b>slogin</b>&nbsp;program in much the same way as we used<br>the&nbsp;<b>rlogin</b>&nbsp;program in our example earlier in the book. The first time you attempt a connection to a host, the<br><b>ssh</b>&nbsp;client will retrieve the public key of the host and ask you to confirm its identity by prompting you with a<br>shortened version of the public key called a&nbsp;<b>fingerprint</b>.<br>
The administrator at the remote host should have supplied you in advance with its public key fingerprint,<br>which you should add to your&nbsp;.ssh/known_hosts&nbsp;file. If the remote administrator has not supplied you<br>the appropriate key, you can connect to the remote host, but&nbsp;<b>ssh</b>&nbsp;will warn you that it does have a key and<br>prompt you whether you wish to accept the one offered by the remote host. Assuming that you're sure no one<br>is engaging in DNS spoofing and you are in fact talking to the correct host, answer yes to the prompt. The<br>relevant key is then stored automatically in your&nbsp;.ssh/known_hosts&nbsp;and you will not be prompted for it<br>again. If, on a future connection attempt, the public key retrieved from that host does not match the one that is<br>stored, you will be warned, because this represents a potential security breach.<br>
A first−time login to a remote host will look something like:<br>
$&nbsp;<b>slogin vchianti.vbrew.com</b><br>
The authenticity of host 'vchianti.vbrew.com' can't be established.<br>
Key fingerprint is 1024 7b:d4:a8:28:c5:19:52:53:3a:fe:8d:95:dd:14:93:f5.<br>
Are you sure you want to continue connecting (yes/no)?&nbsp;<b>yes</b><br>
Warning: Permanently added 'vchianti.vbrew.com,172.16.2.3' to the list of/<br>
&nbsp; &nbsp; known hosts.<br>
maggie@vchianti.vbrew.com's password:&nbsp;<br>
Last login: Tue Feb &nbsp;1 23:28:58 2000 from vstout.vbrew.com<br>
$<br>
You will be prompted for a password, which you should answer with the password belonging to the remote<br>account, not the local one. This password is not echoed when you type it.<br>
Without any special arguments,&nbsp;<b>slogin</b>&nbsp;will attempt to log in with the same userid used on the local machine.<br>You can override this using the&nbsp;−l&nbsp;argument, supplying an alternate login name on the remote host. This is<br>what we did in our example earlier in the book.<br>
12.5.2.3. Using ssh<br>
251<br>
<hr>
<A name=268></a>Linux Network Administrators Guide<br>
We can copy files to and from the remote host using the&nbsp;<b>scp</b>&nbsp;program. Its syntax is similar to the<br>conventional&nbsp;<b>cp</b>&nbsp;with the exception that you may specify a hostname before a filename, meaning that the file<br>path is on the specified host. The following example illustrates&nbsp;<b>scp</b>&nbsp;syntax by copying a local file called<br>/tmp/fred&nbsp;to the&nbsp;/home/maggie/&nbsp;of the remote host&nbsp;<i>chianti.vbrew.com</i>:<br>
$&nbsp;<b>scp /tmp/fred vchianti.vbrew.com:/home/maggie/</b><br>
maggie@vchianti.vbrew.com's password:<br>
fred &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 100% |*****************************| 50165 &nbsp; 00:01 ETA<br>
Again, you'll be prompted for a password. The&nbsp;<b>scp</b>&nbsp;command displays useful progress messages by default.<br>You can copy a file from a remote host with the same ease; simply specify its hostname and filepath as the<br>source and the local path as the destination. It's even possible to copy a file from a remote host to some other<br>remote host, but it is something you wouldn't normally want to do, because all of the data travels via your<br>host.<br>
You can execute commands on remote hosts using the&nbsp;<b>ssh</b>&nbsp;command. Again, its syntax is very simple. Let's<br>have our user&nbsp;<b>maggie</b>&nbsp;retrieve the root directory of the remote host&nbsp;<i>vchianti.vbrew.com</i>. She'd do this with:<br>
$&nbsp;<b>ssh vchianti.vbrew.com ls −CF /</b><br>
maggie@vchianti.vbrew.com's password:<br>
bin/ &nbsp; &nbsp;console@ &nbsp;dos/ &nbsp; &nbsp; home/ &nbsp; &nbsp;lost+found/ &nbsp;pub@ &nbsp; tmp/ &nbsp;vmlinuz@<br>
boot/ &nbsp; dev/ &nbsp; &nbsp; &nbsp;etc/ &nbsp; &nbsp; initrd/ &nbsp;mnt/ &nbsp; &nbsp; &nbsp; &nbsp; root/ &nbsp;usr/ &nbsp;vmlinuz.old@<br>
cdrom/ &nbsp;disk/ &nbsp; &nbsp; floppy/ &nbsp;lib/ &nbsp; &nbsp; proc/ &nbsp; &nbsp; &nbsp; &nbsp;sbin/ &nbsp;var/<br>
You can place&nbsp;<b>ssh</b>&nbsp;in a command pipeline and pipe program input/output to or from it just like any other<br>command, except that the input or output is directed to or from the remote host via the&nbsp;<b>ssh</b>&nbsp;connection. Here<br>is an example of how you might use this capability in combination with the&nbsp;<b>tar</b>&nbsp;command to copy a whole<br>directory with subdirectories and files from a remote host to the local host:<br>
$&nbsp;<b>ssh vchianti.vbrew.com &quot;tar cf − /etc/&quot; | tar xvf −</b><br>
maggie@vchianti.vbrew.com's password:<br>
etc/GNUstep<br>
etc/Muttrc<br>
etc/Net<br>
etc/X11<br>
etc/adduser.conf<br>
..<br>
..<br>
Here we surrounded the command we will execute with quotation marks to make it clear what is passed as an<br>argument to&nbsp;<b>ssh</b>&nbsp;and what is used by the local shell. This command executes the&nbsp;<b>tar</b>&nbsp;command on the remote<br>host to archive the&nbsp;/etc/&nbsp;directory and write the output to standard output. We've piped to an instance of the<br><b>tar</b>&nbsp;command running on our local host in extract mode reading from standard input.<br>
Again, we were prompted for the password. Now you can see why we encouraged you to configure&nbsp;<b>ssh</b>&nbsp;so<br>that it doesn't prompt you for passwords all the time! Let's now configure our local&nbsp;<b>ssh</b>&nbsp;client so that it won't<br>prompt for a password when connecting to the vchianti.vbrew.com host. We mentioned the<br>.ssh/authorized_keys&nbsp;file earlier; this is where it is used. The&nbsp;.ssh/authorized_keys&nbsp;file<br>contains the&nbsp;<i>public</i>&nbsp;keys on any remote user accounts that we wish to automatically log in to. You can set up<br>automatic logins by copying the contents of the&nbsp;.ssh/identity.pub&nbsp;from the&nbsp;<i>remote</i>&nbsp;account into our<br>local&nbsp;.ssh/authorized_keys&nbsp;file. It is vital that the file permissions of<br>.ssh/authorized_keys&nbsp;allow only that you read and write it; anyone may steal and use the keys to log<br>in to that remote account. To ensure the permissions are correct, change&nbsp;.ssh/authorized_keys, as<br>shown:<br>
12.5.2.3. Using ssh<br>
252<br>
<hr>
<A name=269></a>Linux Network Administrators Guide<br>
$&nbsp;<b>chmod 600 ~/.ssh/authorized_keys</b><br>
The public keys are a long&nbsp;<i>single</i>&nbsp;line of plain text. If you use copy and paste to duplicate the key into your<br>local file, be sure to remove any end of line characters that might have been introduced along the way. The<br>.ssh/authorized_keys&nbsp;file may contain many such keys, each on a line of its own.<br>
The&nbsp;<b>ssh</b>&nbsp;suite of tools is very powerful and there are many other useful features and options that you will be<br>interested in exploring. Please refer to the manual pages and other documentation that is supplied with the<br>package for more information.<br>
12.5.2.3. Using ssh<br>
253<br>
<hr>
<A name=270></a><b>Chapter 13. The Network Information System</b><br>
When you're running a local area network, your overall goal is usually to provide an environment for your<br>users that makes the network transparent. An important stepping stone is keeping vital data such as user<br>account information synchronized among all hosts. This provides users with the freedom to move from<br>machine to machine without the inconvenience of having to remember different passwords and copy data<br>from one machine to another. Data that is centrally stored doesn't need to be replicated, so long as there is<br>some convenient means of accessing it from a network−connected host. By storing important administrative<br>information centrally, you can make ensure consistency of that data, increase flexibility for the users by<br>allowing them to move from host to host in a transparent way, and make the system administrator's life much<br>easier by maintaining a single copy of information to maintain when required.<br>
We previously discussed an important example of this concept that is used on the Internetthe Domain Name<br>System (DNS). DNS serves a limited range of information, the most important being the mapping between<br>hostname and IP address. For other types of information, there is no such specialized service. Moreover, if<br>you manage only a small LAN with no Internet connectivity, setting up DNS may not seem to be worth the<br>trouble.<br>
This is why Sun developed the&nbsp;<i>Network Information System</i>&nbsp;(NIS). NIS provides generic database access<br>facilities that can be used to distribute, for example, information contained in the&nbsp;passwd&nbsp;and&nbsp;groups&nbsp;files<br>to all hosts on your network. This makes the network appear as a single system, with the same accounts on all<br>hosts. Similarly, you can use NIS to distribute the hostname information from&nbsp;/etc/hosts&nbsp;to all machines<br>on the network.<br>
NIS is based on RPC, and comprises a server, a client−side library, and several administrative tools.<br>Originally, NIS was called&nbsp;<i>Yellow Pages</i>, or YP, which is still used to refer to it. Unfortunately, the name is a<br>trademark of British Telecom, which required Sun to drop that name. As things go, some names stick with<br>people, and so YP lives on as a prefix to the names of most NIS−related commands such as&nbsp;<b>ypserv</b>&nbsp;and<br><b>ypbind</b>.<br>
&nbsp;Today, NIS is available for virtually all Unixes, and there are even free implementations. BSD Net−2<br>released one that has been derived from a public domain reference implementation donated by Sun. The<br>library client code from this release had been in the Linux&nbsp;libc&nbsp;for a long time, and the administrative<br>programs were ported to Linux by Swen Thümmler.[73]&nbsp;An NIS server is missing from the reference<br>implementation, though.<br>
&nbsp;Peter Eriksson developed a new implementation called NYS.&nbsp;[74]&nbsp;It supports both plain NIS and Sun's<br>much enhanced NIS+. NYS not only provides a set of NIS tools and a server, but also adds a whole new set<br>of library functions that need to be compiled into your&nbsp;libc&nbsp;if you wish to use it. This includes a new<br>configuration scheme for hostname resolution that replaces the current scheme using&nbsp;host.conf.<br>
&nbsp;The GNU libc, known as&nbsp;libc6&nbsp;in the Linux community, includes an updated version of the traditional<br>NIS support developed by Thorsten Kukuk.[75]&nbsp;It supports all of the library functions that NYS provided and<br>also uses the enhanced configuration scheme of NYS. You still need the tools and server, but using GNU<br>libc&nbsp;saves you the trouble of having to meddle with patching and recompiling the library.<br>
This chapter focuses on the NIS support included in the GNU&nbsp;libc&nbsp;rather than the other two packages. If<br>you do want to run any of these packages, the instructions in this chapter may or may not be enough. For<br>additional information, refer to the NIS−HOWTO or a book such as&nbsp;<i>Managing NFS and NIS</i>&nbsp;by Hal Stern<br>(O'Reilly).<br>
Chapter 13. The Network Information System<br>
254<br>
<hr>
<A name=271></a>Linux Network Administrators Guide<br>
Chapter 13. The Network Information System<br>
255<br>
<hr>
<A name=272></a><b>13.1. Getting Acquainted with NIS</b><br>
&nbsp;NIS keeps database information in files called&nbsp;<i>maps</i>, which contain key−value pairs. An example of a<br>key−value pair is a user's login name and the encrypted form of their login password. Maps are stored on a<br>central host running the NIS server, from which clients may retrieve the information through various RPC<br>calls. Quite frequently, maps are stored in DBM files.[76]<br>
&nbsp;The maps themselves are usually generated from master text files such as&nbsp;/etc/hosts&nbsp;or<br>/etc/passwd. For some files, several maps are created, one for each search key type. For instance, you<br>may search the&nbsp;hosts&nbsp;file for a hostname as well as for an IP address. Accordingly, two NIS maps are<br>derived from it, called&nbsp;hosts.byname&nbsp;and&nbsp;hosts.byaddr.&nbsp;<a href="TLNAGs.html#272">Table 13−1</a>&nbsp;lists common maps and the files<br>from which they are generated.<br>
<b>Table 13−1. Some Standard NIS Maps and Corresponding Files</b><br>
<b>Master File</b><br>
<b>Map(s)</b><br>
<b>Description</b><br>
/etc/hosts<br>
hosts.byname,&nbsp;hosts.byaddr<br>
Maps IP addresses to host names<br>
/etc/networks<br>
networks.byname,<br>
Maps IP network addresses to network<br>
networks.byaddr<br>
names<br>
/etc/passwd<br>
passwd.byname,&nbsp;passwd.byuid<br>
Maps encrypted passwords to user login<br>names<br>
/etc/group<br>
group.byname,&nbsp;group.bygid<br>
Maps Group IDs to group names<br>
Maps service descriptions to service<br>
/etc/services<br>
services.byname,<br>
names<br>
services.bynumber<br>
/etc/rpc<br>
rpc.byname,&nbsp;rpc.bynumber<br>
Maps Sun RPC service numbers to RPC<br>service names<br>
/etc/protocols<br>
protocols.byname,<br>
Maps protocol numbers to protocol<br>
protocols.bynumber<br>
names<br>
/usr/lib/aliases&nbsp;mail.aliases<br>
Maps mail aliases to mail alias names<br>
You may find support for other files and maps in other NIS packages. These usually contain information for<br>applications not discussed in this book, such as the&nbsp;bootparams&nbsp;map that is used by Sun's<br><b>bootparamd</b>&nbsp;server.<br>
&nbsp;For some maps, people commonly use&nbsp;<i>nicknames</i>, which are shorter and therefore easier to type. Note that<br>these nicknames are understood only by&nbsp;<b>ypcat</b>&nbsp;and&nbsp;<b>ypmatch</b>, two tools for checking your NIS configuration.<br>To obtain a full list of nicknames understood by these tools, run the following command:<br>
13.1. Getting Acquainted with NIS<br>
256<br>
<hr>
<A name=273></a>Linux Network Administrators Guide<br>
$&nbsp;<b>ypcat −x</b><br>
Use &quot;passwd&quot; for &quot;passwd.byname&quot;<br>
Use &quot;group&quot; for &quot;group.byname&quot;<br>
Use &quot;networks&quot; for &quot;networks.byaddr&quot;<br>
Use &quot;hosts&quot; for &quot;hosts.byaddr&quot;<br>
Use &quot;protocols&quot; for &quot;protocols.bynumber&quot;<br>
Use &quot;services&quot; for &quot;services.byname&quot;<br>
Use &quot;aliases&quot; for &quot;mail.aliases&quot;<br>
Use &quot;ethers&quot; for &quot;ethers.byname&quot;<br>
&nbsp;The NIS server program is traditionally called&nbsp;<b>ypserv</b>. For an average network, a single server usually<br>suffices; large networks may choose to run several of these on different machines and different segments of<br>the network to relieve the load on the server machines and routers. These servers are synchronized by making<br>one of them the&nbsp;<i>master server</i>, and the others&nbsp;<i>slave servers</i>. Maps are created only on the master server's host.<br>From there, they are distributed to all slaves.<br>
&nbsp;We have been talking very vaguely about networks. There's a distinctive term in NIS that refers to a<br>collection of all hosts that share part of their system configuration data through NIS: the&nbsp;<i>NIS domain</i>.<br>Unfortunately, NIS domains have absolutely nothing in common with the domains we encountered in DNS.<br>To avoid any ambiguity throughout this chapter, we will therefore always specify which type of domain we<br>mean.<br>
&nbsp;NIS domains have a purely administrative function. They are mostly invisible to users, except for the<br>sharing of passwords between all machines in the domain. Therefore, the name given to an NIS domain is<br>relevant only to the administrators. Usually, any name will do, as long as it is different from any other NIS<br>domain name on your local network. For instance, the administrator at the Virtual Brewery may choose to<br>create two NIS domains, one for the Brewery itself, and one for the Winery, which she names brewery and<br>winery respectively. Another quite common scheme is to simply use the DNS domain name for NIS as well.<br>
To set and display the NIS domain name of your host, you can use the&nbsp;<b>domainname</b>&nbsp;command. When<br>invoked without any argument, it prints the current NIS domain name; to set the domain name, you must<br>become the superuser:<br>
#&nbsp;<b>domainname brewery</b><br>
NIS domains determine which NIS server an application will query. For instance, the&nbsp;<b>login</b>&nbsp;program on a host<br>at the Winery should, of course, query only the Winery's NIS server (or one of them, if there are several) for a<br>user's password information, while an application on a Brewery host should stick with the Brewery's server.<br>
&nbsp;One mystery now remains to be solved: how does a client find out which server to connect to? The simplest<br>approach would use a configuration file that names the host on which to find the server. However, this<br>approach is rather inflexible because it doesn't allow clients to use different servers (from the same domain,<br>of course) depending on their availability. Therefore, NIS implementations rely on a special daemon called<br><b>ypbind</b>&nbsp;to detect a suitable NIS server in their NIS domain. Before performing any NIS queries, an<br>application first finds out from&nbsp;<b>ypbind</b>&nbsp;which server to use.<br>
<b>ypbind</b>&nbsp;probes for servers by broadcasting to the local IP network; the first to respond is assumed to be the<br>fastest one and is used in all subsequent NIS queries. After a certain interval has elapsed, or if the server<br>becomes unavailable,&nbsp;<b>ypbind</b>&nbsp;probes for active servers again.<br>
Dynamic binding is useful only when your network provides more than one NIS server. Dynamic binding<br>also introduces a security problem.&nbsp;<b>ypbind</b>&nbsp;blindly believes whoever answers, whether it be a humble NIS<br>server or a malicious intruder. Needless to say, this becomes especially troublesome if you manage your<br>
13.1. Getting Acquainted with NIS<br>
257<br>
<hr>
<A name=274></a>Linux Network Administrators Guide<br>
password databases over NIS. To guard against this, the Linux&nbsp;<b>ypbind</b>&nbsp;program provides you with the option<br>of probing the local network to find the local NIS server, or configuring the NIS server hostname in a<br>configuration file.<br>
13.1. Getting Acquainted with NIS<br>
258<br>
<hr>
<A name=275></a><b>13.2. NIS Versus NIS+</b><br>
NIS and NIS+ share little more than their name and a common goal. NIS+ is structured entirely differently<br>from NIS. Instead of a flat namespace with disjoint NIS domains, NIS+ uses a hierarchical namespace similar<br>to that of DNS. Instead of maps, so−called&nbsp;<i>tables</i>&nbsp;are used that are made up of rows and columns, in which<br>each row represents an object in the NIS+ database and the columns cover properties of the objects that NIS+<br>knows and cares about. Each table for a given NIS+ domain comprises those of its parent domains. In<br>addition, an entry in a table may contain a link to another table. These features make it possible to structure<br>information in many ways.<br>
NIS+ additionally supports secure and encrypted RPC, which helps greatly to solve the security problems of<br>NIS.<br>
Traditional NIS has an RPC Version number of 2, while NIS+ is Version 3. At the time we're writing, there<br>isn't yet a good working implementation of NIS+ for Linux, so it isn't covered here.<br>
13.2. NIS Versus NIS+<br>
259<br>
<hr>
<A name=276></a><b>13.3. The Client Side of NIS</b><br>
If you are familiar with writing or porting network applications, you may notice that most of the NIS maps<br>listed previously correspond to library functions in the C library. For instance, to obtain<br>passwd&nbsp;information, you generally use the&nbsp;getpwnam&nbsp;and&nbsp;getpwuid&nbsp;functions, which return the account<br>information associated with the given username or numerical user ID, respectively. Under normal<br>circumstances, these functions perform the requested lookup on the standard file, such as&nbsp;/etc/passwd.<br>
An NIS−aware implementation of these functions, however, modifies this behavior and places an RPC call to<br>the NIS server, which looks up the username or user ID. This happens transparently to the application. The<br>function may treat the NIS data as though it has been appended to the original&nbsp;passwd&nbsp;file so both sets of<br>information are available to the application and used, or as though it has completely replaced it so that the<br>information in the local&nbsp;passwd&nbsp;is ignored and only the NIS data is used.<br>
For traditional NIS implementations, there were certain conventions for which maps were replaced and which<br>were appended to the original information. Some, like the&nbsp;passwd&nbsp;maps, required kludgy modifications of<br>the&nbsp;passwd&nbsp;file which, when done incorrectly, would open up security holes. To avoid these pitfalls, NYS<br>and the GNU&nbsp;libc&nbsp;use a general configuration scheme that determines whether a particular set of client<br>functions uses the original files, NIS, or NIS+, and in which order. This scheme will be described later in this<br>chapter.<br>
13.3. The Client Side of NIS<br>
260<br>
<hr>
<A name=277></a><b>13.4. Running an NIS Server</b><br>
After so much theoretical techno−babble, it's time to get our hands dirty with actual configuration work. In<br>this section, we will cover the configuration of an NIS server. If an NIS server is running on your network,<br>you won't have to set up your own; in this case, you may safely skip this section.<br>
Note that if you are just going to experiment with the server, make sure you don't set it up for an NIS domain<br>name that is already in use on your network. This may disrupt the entire network service and make a lot of<br>people very unhappy and very angry.<br>
&nbsp;There are two possible NIS server configurations: master and slave. The slave configuration provides a live<br>backup machine, should your master server fail. We will cover the configuration only for a master server<br>here. The server documentation will explain the differences, should you wish to configure a slave server.<br>
There are currently two NIS servers freely available for Linux: one contained in Tobias Reber's&nbsp;yps&nbsp;package,<br>and the other in Peter Eriksson's&nbsp;ypserv&nbsp;package. It doesn't matter which one you run.<br>
After installing the server program (<b>ypserv</b>) in&nbsp;/usr/sbin, you should create the directory that is going to<br>hold the map files your server is to distribute. When setting up an NIS domain for the brewery domain, the<br>maps would go to&nbsp;/var/yp/brewery. The server determines whether it is serving a particular NIS<br>domain by checking if the map directory is present. If you are disabling service for some NIS domain, make<br>sure to remove the directory as well.<br>
&nbsp;Maps are usually stored in DBM files to speed up lookups. They are created from the master files using a<br>program called&nbsp;<b>makedbm</b>&nbsp;(for Tobias's server) or&nbsp;<b>dbmload</b>&nbsp;(for Peter's server).<br>
Transforming a master file into a form that&nbsp;<b>dbmload</b>&nbsp;can parse usually requires some&nbsp;<b>awk</b>&nbsp;or&nbsp;<b>sed</b>&nbsp;magic,<br>which tends to be a little tedious to type and hard to remember. Therefore, Peter Eriksson's&nbsp;ypserv&nbsp;package<br>contains a Makefile (called&nbsp;ypMakefile) that manages the conversion of the most common master files for<br>you. You should install it as&nbsp;Makefile&nbsp;in your map directory and edit it to reflect the maps you want the<br>NIS server to share. Towards the top of the file, you'll find the all target that lists the services&nbsp;<b>ypserv</b>&nbsp;offers.<br>By default, the line looks something like this:<br>
all: ethers hosts networks protocols rpc services passwd group netid<br>
If you don't want to produce, for example, the&nbsp;ethers.byname&nbsp;and&nbsp;ethers.byaddr&nbsp;maps, simply<br>remove the ethers prerequisite from this rule. To test your setup, you can start with just one or two maps, like<br>the&nbsp;services.* maps.<br>
After editing the&nbsp;Makefile, while in the map directory, type&nbsp;<b>make</b>. This will automatically generate and<br>install the maps. You have to make sure to update the maps whenever you change the master files, otherwise<br>the changes will remain invisible to the network.<br>
The section Setting Up an NIS Client with GNU libc will explain how to configure the NIS client code.<br>If your setup doesn't work, you should try to find out whether requests are arriving at your server. If you<br>specify the&nbsp;−−debug&nbsp;command−line flag to&nbsp;<b>ypserv</b>, it prints debugging messages to the console about all<br>incoming NIS queries and the results returned. These should give you a hint as to where the problem lies.<br>Tobias's server doesn't have this option.<br>
13.4. Running an NIS Server<br>
261<br>
<hr>
<A name=278></a><b>13.5. NIS Server Security</b><br>
&nbsp;NIS used to have a major security flaw: it left your password file readable by virtually anyone in the entire<br>Internet, which made for quite a number of possible intruders. As long as an intruder knew your NIS domain<br>name and the address of your server, he could simply send it a request for the&nbsp;passwd.byname&nbsp;map and<br>instantly receive all your system's encrypted passwords. With a fast password−cracking program like<br><b>crack</b>&nbsp;and a good dictionary, guessing at least a few of your users' passwords is rarely a problem.<br>
&nbsp;This is what the&nbsp;<i>securenets</i>&nbsp;option is all about. It simply restricts access to your NIS server to certain hosts,<br>based on their IP addresses or network numbers. The latest version of&nbsp;<b>ypserv</b>&nbsp;implements this feature in two<br>ways. The first relies on a special configuration file called&nbsp;/etc/ypserv.securenets&nbsp;and the second<br>conveniently uses the&nbsp;/etc/hosts.allow&nbsp;and&nbsp;/etc/hosts.deny&nbsp;files we already encountered in<br><a href="TLNAGs.html#253">Chapter 12.</a>[77]&nbsp;Thus, to restrict access to hosts from within the Brewery, their network manager would add<br>the following line to&nbsp;hosts.allow:<br>
ypserv: 172.16.2.<br>
This would let all hosts from IP network 172.16.2.0 access the NIS server. To shut out all other hosts, a<br>corresponding entry in&nbsp;hosts.deny&nbsp;would have to read:<br>
ypserv: ALL<br>
IP numbers are not the only way you can specify hosts or networks in&nbsp;hosts.allow&nbsp;and&nbsp;hosts.deny.<br>Please refer to the&nbsp;hosts_access(5)&nbsp;manual page on your system for details. However, be warned that<br>you&nbsp;<i>cannot</i>&nbsp;use host or domain names for the ypserv entry. If you specify a hostname, the server tries to<br>resolve this hostnamebut the resolver in turn calls&nbsp;<b>ypserv</b>, and you fall into an endless loop.<br>
To configure securenets security using the&nbsp;/etc/ypserv.securenets&nbsp;method, you need to create its<br>configuration file,&nbsp;/etc/ypserv.securenets. This configuration file is simple in structure. Each line<br>describes a host or network of hosts that will be allowed access to the server. Any address not described by an<br>entry in this file will be refused access. A line beginning with a # will be treated as a comment. Example<br>13−1 shows what a simple&nbsp;/etc/ypserv.securenets&nbsp;would look like:<br>
<b>Example 13−1. Sample ypserv.securenets File</b><br>
# allow connections from local host −− necessary<br>
host 127.0.0.1<br>
# same as 255.255.255.255 127.0.0.1<br>
#<br>
# allow connections from any host on the Virtual Brewery network<br>
255.255.255.0 &nbsp; 172.16.1.0<br>
#<br>
The first entry on each line is the netmask to use for the entry, with host being treated as a special keyword<br>meaning netmask 255.255.255.255. The second entry on each line is the IP address to which to apply the<br>netmask.<br>
A third option is to use the secure portmapper instead of the&nbsp;securenets&nbsp;option in&nbsp;<b>ypserv</b>. The secure<br>portmapper (portmap−5.0) uses the&nbsp;hosts.allow&nbsp;scheme as well, but offers this for all RPC servers,<br>not just&nbsp;<b>ypserv</b>.[78]&nbsp;However, you should not use both the&nbsp;securenets&nbsp;option and the secure portmapper<br>
13.5. NIS Server Security<br>
262<br>
<hr>
<A name=279></a>Linux Network Administrators Guide<br>
at the same time, because of the overhead this authorization incurs.<br>
13.5. NIS Server Security<br>
263<br>
<hr>
<A name=280></a><b>13.6. Setting Up an NIS Client with GNU libc</b><br>
&nbsp;We will now describe and discuss the configuration of an NIS client using the GNU libc library support.<br>
&nbsp;Your first step should be to tell the GNU libc NIS client which server to use for NIS service. We mentioned<br>earlier that the Linux&nbsp;<b>ypbind</b>&nbsp;allows you to configure the NIS server to use. The default behavior is to query<br>the server on the local network. If the host you are configuring is likely to move from one domain to another,<br>such as a laptop, you would leave the&nbsp;/etc/yp.conf&nbsp;file empty and it would query on the local network<br>for the local NIS server wherever it happens to be.<br>
A more secure configuration for most hosts is to set the server name in the&nbsp;/etc/yp.conf&nbsp;configuration<br>file. A very simple file for a host on the Winery's network may look like this:<br>
# yp.conf − YP configuration for GNU libc library.<br>
#<br>
ypserver vbardolino<br>
The ypserver statement tells your host to use the host supplied as the NIS server for the local domain. In this<br>example we've specified the NIS server as vbardolino. Of course, the IP address corresponding to<br>vbardolino must be set in the&nbsp;hosts&nbsp;file; alternatively, you may use the IP address itself with the<br>server argument.<br>
In the form shown in the example, the&nbsp;<b>ypserver</b>&nbsp;command tells&nbsp;<b>ypbind</b>&nbsp;to use the named server regardless of<br>what the current NIS domain may be. If, however, you are moving your machine between different NIS<br>domains frequently, you may want to keep information for several domains in the&nbsp;yp.conf&nbsp;file. You can<br>have information on the servers for various NIS domains in&nbsp;yp.conf&nbsp;by specifying the information using<br>the domain statement. For instance, you might change the previous sample file to look like this for a laptop:<br>
# yp.conf − YP configuration for GNU libc library.<br>
#&nbsp;<br>
domain winery server vbardolino&nbsp;<br>
domain brewery server vstout&nbsp;<br>
This lets you bring up the laptop in either of the two domains by simply setting the desired NIS domain at<br>boot time using the&nbsp;<b>domainname</b>&nbsp;command. The NIS client then uses whichever server is relevant for the<br>current domain.<br>
There is a third option you may want to use. It covers the case when you don't know the name or IP address<br>of the server to use in a particular domain, but still want the ability use a fixed server on certain domains.<br>Imagine we want to insist on using a specified server while operating within the Winery domain, but want to<br>probe for the server to use while in the Brewery domain. We would modify our&nbsp;yp.conf&nbsp;file again to look<br>like this instead:<br>
# yp.conf − YP configuration for GNU libc library.<br>
#&nbsp;<br>
domain winery server vbardolino&nbsp;<br>
domain brewery broadcast<br>
The broadcast keyword tells&nbsp;<b>ypbind</b>&nbsp;to use whichever NIS server it finds for the domain.<br>
&nbsp;After creating this basic configuration file and making sure it is world−readable, you should run your first<br>test to connect to your server. Make sure to choose a map your server distributes, like&nbsp;hosts.byname, and<br>
13.6. Setting Up an NIS Client with GNU libc<br>
264<br>
<hr>
<A name=281></a>Linux Network Administrators Guide<br>
try to retrieve it by using the&nbsp;<b>ypcat</b>&nbsp;utility:<br>
#&nbsp;<b>ypcat hosts.byname</b><br>
172.16.2.2 &nbsp; &nbsp; &nbsp;vbeaujolais.vbrew.com &nbsp; &nbsp;vbeaujolais<br>
172.16.2.3 &nbsp; &nbsp; &nbsp;vbardolino.vbrew.com &nbsp; &nbsp; vbardolino<br>
172.16.1.1 &nbsp; &nbsp; &nbsp;vlager.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp; vlager<br>
172.16.2.1 &nbsp; &nbsp; &nbsp;vlager.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp; vlager<br>
172.16.1.2 &nbsp; &nbsp; &nbsp;vstout.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp; vstout<br>
172.16.1.3 &nbsp; &nbsp; &nbsp;vale.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vale<br>
172.16.2.4 &nbsp; &nbsp; &nbsp;vchianti.vbrew.com &nbsp; &nbsp; &nbsp; vchianti<br>
The output you get should resemble that just shown. If you get an error message instead that says:&nbsp;Can't<br>bind to server which serves domain, then either the NIS domain name you've set doesn't have<br>a matching server defined in&nbsp;yp.conf, or the server is unreachable for some reason. In the latter case, make<br>sure that a&nbsp;<b>ping</b>&nbsp;to the host yields a positive result, and that it is indeed running an NIS server. You can verify<br>the latter by using&nbsp;<b>rpcinfo</b>, which should produce the following output:<br>
#&nbsp;<b>rpcinfo −u&nbsp;</b><i>serverhost&nbsp;</i><b>ypserv</b><br>
program 100004 version 1 ready and waiting<br>
program 100004 version 2 ready and waiting<br>
13.6. Setting Up an NIS Client with GNU libc<br>
265<br>
<hr>
<A name=282></a><b>13.7. Choosing the Right Maps</b><br>
&nbsp;Having made sure you can reach the NIS server, you have to decide which configuration files to replace or<br>augment with NIS maps. Commonly, you will want to use NIS maps for the host and password lookup<br>functions. The former is especially useful if you do not have the BIND name service. The password lookup<br>lets all users log into their accounts from any system in the NIS domain; this usually goes along with sharing<br>a central&nbsp;/home&nbsp;directory among all hosts via NFS. The password map is explained detail in the next section.<br>
Other maps, like&nbsp;services.byname, don't provide such dramatic gains, but do save you some editing<br>work. The&nbsp;services.byname&nbsp;map is valuable if you install any network applications that use a service<br>name not in the standard&nbsp;services&nbsp;file.<br>
Generally, you want to have some choice of when a lookup function uses the local files, when it queries the<br>NIS server, and when it uses other servers such as DNS. GNU libc allows you to configure the order in which<br>a function accesses these services. This is controlled through the&nbsp;/etc/nsswitch.conf&nbsp;file, which<br>stands for&nbsp;<i>Name Service Switch</i>, but of course isn't limited to the name service. For any of the data lookup<br>functions supported by GNU libc, the file contains a line naming the services to use.<br>
The right order of services depends on the type of data each service is offering. It is unlikely that the<br>services.byname&nbsp;map will contain entries differing from those in the local&nbsp;services&nbsp;file; it will only<br>contain additional entries. So it appears reasonable to query the local files first and check NIS only if the<br>service name isn't found. Hostname information, on the other hand, may change very frequently, so DNS or<br>the NIS server should always have the most accurate account, while the local&nbsp;hosts&nbsp;file is only kept as a<br>backup if DNS and NIS should fail. For hostnames, therefore, you normally want to check the local file last.<br>
The following example shows how to force&nbsp;gethostbyname&nbsp;and&nbsp;gethostbyaddr&nbsp;to look in NIS and<br>DNS before the&nbsp;hosts&nbsp;file and how to have the&nbsp;getservbyname&nbsp;function look in the local files before<br>querying NIS. These resolver functions will try each of the listed services in turn; if a lookup succeeds, the<br>result is returned; otherwise, they will try the next service in the list. The file setting for these priorities is:<br>
# small sample /etc/nsswitch.conf<br>
#<br>
hosts: &nbsp; &nbsp; nis dns files&nbsp;<br>
services: &nbsp;files nis<br>
The following is a complete list of services and locations that may be used with an entry in the<br>nsswitch.conf&nbsp;file. The actual maps, files, servers, and objects queried depend on the entry name. The<br>following can appear to the right of a colon:<br>
<i>nis</i><br>
Use the current domain NIS server. The location of the server queried is configured in the<br>yp.conf&nbsp;file, as shown in the previous section. For the hosts entry, the&nbsp;hosts.byname&nbsp;and<br>hosts.byaddr&nbsp;maps are queried.<br>
<i>nisplus or nis+</i><br>
Use the NIS+ server for this domain. The location of the server is obtained from the<br>/etc/nis.conf&nbsp;file.<br>
<i>dns</i><br>
13.7. Choosing the Right Maps<br>
266<br>
<hr>
<A name=283></a>Linux Network Administrators Guide<br>
Use the DNS name server. This service type is useful only with the hosts entry. The name servers<br>queried are still determined by the standard&nbsp;resolv.conf&nbsp;file.<br>
<i>files</i><br>
Use the local file, such as the&nbsp;/etc/hosts&nbsp;file for the hosts entry.<br>
<i>compat</i><br>
Be compatible with older file formats. This option can be used when either NYS or glibc 2.x is used<br>for NIS or NIS+ lookups. While these versions normally can't interpret older NIS entries in<br>passwd&nbsp;and&nbsp;group&nbsp;files, compat option allows them to work with those formats.<br>
<i>db</i><br>
Look up the information from DBM files located in the&nbsp;/var/db&nbsp;directory. The corresponding NIS<br>map name is used for that file.<br>
Currently, the NIS support in GNU libc caters to the following&nbsp;nsswitch.conf&nbsp;databases: aliases,<br>ethers.group, hosts, netgroup, network, passwd, protocols, publickey, rpc, services, and shadow. More entries<br>are likely to be added.<br>
<a href="TLNAGs.html#283">Example 13−2&nbsp;shows a more complete example that introduces another feature of&nbsp;</a>nsswitch.conf. The<br>[NOTFOUND=return] keyword in the hosts entry tells the NIS client to return if the desired item couldn't be<br>found in the NIS or DNS database. That is, the NIS client will continue searching the local files&nbsp;<i>only</i>&nbsp;if calls<br>to the NIS and DNS servers fail for some other reason. The local files will then be used only at boot time and<br>as a backup when the NIS server is down.<br>
<b>Example 13−2. Sample nsswitch.conf File</b><br>
# /etc/nsswitch.conf<br>
#<br>
hosts: &nbsp; &nbsp; &nbsp;nis dns [NOTFOUND=return] files<br>
networks: &nbsp; nis [NOTFOUND=return] files<br>
services: &nbsp; files nis<br>
protocols: &nbsp;files nis<br>
rpc: &nbsp; &nbsp; &nbsp; &nbsp;files nis<br>
GNU libc provides some other actions that are described in the&nbsp;nsswitch&nbsp;manpage.<br>
13.7. Choosing the Right Maps<br>
267<br>
<hr>
<A name=284></a><b>13.8. Using the passwd and group Maps</b><br>
&nbsp;One of the major applications of NIS is synchronizing user and account information on all hosts in an NIS<br>domain. Consequently, you usually keep only a small local&nbsp;/etc/passwd&nbsp;file, to which site−wide<br>information from the NIS maps is appended. However, simply enabling NIS lookups for this service in<br>nsswitch.conf&nbsp;is not nearly enough.<br>
When relying on the password information distributed by NIS, you first have to make sure that the numeric<br>user IDs of any users you have in your local&nbsp;passwd&nbsp;file match the NIS server's idea of user IDs.<br>Consistency in user IDs is important for other purposes as well, like mounting NFS volumes from other hosts<br>in your network.<br>
If any of the numeric IDs in&nbsp;/etc/passwd&nbsp;or&nbsp;/etc/group&nbsp;differ from those in the maps, you have to<br>adjust file ownerships for all files that belong to that user. First, you should change all uids and gids in<br>passwd&nbsp;and&nbsp;group&nbsp;to the new values, then find that all files that belong to the users just changed and<br>change their ownership. Assume news used to have a user ID of 9 and okir had a user ID of 103, which were<br>changed to some other value; you could then issue the following commands as root:<br>
#&nbsp;<b>find / −uid &nbsp; 9 −print &gt;/tmp/uid.9</b><br>
#&nbsp;<b>find / −uid 103 −print &gt;/tmp/uid.103</b><br>
#&nbsp;<b>cat /tmp/uid.9 &nbsp; | xargs chown news</b><br>
#&nbsp;<b>cat /tmp/uid.103 | xargs chown okir</b><br>
It is important that you execute these commands with the new&nbsp;passwd&nbsp;file installed, and that you collect all<br>filenames before you change the ownership of any of them. To update the group ownerships of files, use a<br>similar method with the gid instead of the uid, and chgrp instead of chown.<br>
Once you do this, the numerical uids and gids on your system will agree with those on all other hosts in your<br>NIS domain. The next step is to add configuration lines to&nbsp;nsswitch.conf&nbsp;that enable NIS lookups for<br>user and group information:<br>
# /etc/nsswitch.conf − passwd and group treatment<br>
passwd: nis files<br>
group: &nbsp;nis files<br>
This affects where the&nbsp;<b>login</b>&nbsp;command and all its friends look for user information. When a user tries to log<br>in,&nbsp;<b>login</b>&nbsp;queries the NIS maps first, and if this lookup fails, falls back to the local files. Usually, you will<br>remove almost all users from your local files, and only leave entries for root and generic accounts like mail in<br>it. This is because some vital system tasks may have to map uids to usernames or vice versa. For example,<br>administrative&nbsp;<b>cron</b>&nbsp;jobs may execute the&nbsp;su&nbsp;command to temporarily become news, or the UUCP subsystem<br>may mail a status report. If news and uucp don't have entries in the local&nbsp;passwd&nbsp;file, these jobs will fail<br>miserably during an NIS brownout.<br>
Lastly, if you are using either the old NIS implementation (supported by the compat mode for the<br>passwd&nbsp;and&nbsp;group&nbsp;files in the NYS or glibc implementations), you must insert the unwieldy special entries<br>into them. These entries represent where the NIS derived records will be inserted into the database of<br>information. The entries can be added anywhere, but are usually just added to the end. The entries to add for<br>the&nbsp;/etc/passwd&nbsp;file are:<br>
<b>+::::::</b><br>
13.8. Using the passwd and group Maps<br>
268<br>
<hr>
<A name=285></a>Linux Network Administrators Guide<br>
and for the&nbsp;/etc/groups&nbsp;file:<br>
<b>+:::</b><br>
With both glibc 2.x and NYS you can override parameters in a users record received from the NIS server by<br>creating entries with a + prepended to the login name, and exclude specified users by creating entries with<br>a − prepended to the login name. For example the entries:<br>
<b>+stuart::::::/bin/jacl</b><br>
<b>−jedd::::::</b><br>
would override the shell specified for the user stuart supplied by the NIS server, and would disallow the user<br>jedd from logging in on this machine. Any fields left blank use the information supplied by the NIS server.<br>
There are two big caveats in order here. First, the setup as described up to here works only for login suites<br>that don't use shadow passwords. The intricacies of using shadow passwords with NIS will be discussed in<br>the next section. Second, the login commands are not the only ones that access the&nbsp;passwd&nbsp;filelook at the<br><b>ls</b>&nbsp;command, which most people use almost constantly. Whenever compiling a long listing,&nbsp;<b>ls</b>&nbsp;displays the<br>symbolic names for user and group owners of a file; that is, for each uid and gid it encounters, it has to query<br>the NIS server. An NIS query takes slightly longer to perform than the equivalent lookup in a local file. You<br>may find that sharing your&nbsp;passwd&nbsp;and&nbsp;group&nbsp;information using NIS causes a noticable reduction in the<br>performance of some programs that use this information frequently.<br>
Still, this is not the whole story. Imagine what happens if a user wants to change her password. Usually, she<br>will invoke&nbsp;<b>passwd</b>, which reads the new password and updates the local&nbsp;passwd&nbsp;file. This is impossible<br>with NIS, since that file isn't available locally anymore, but having users log into the NIS server whenever<br>they want to change their passwords is not an option, either. Therefore, NIS provides a drop−in replacement<br>for&nbsp;<b>passwd</b>&nbsp;called&nbsp;<b>yppasswd</b>, which handles password changes under NIS. To change the password on the<br>server host, it contacts the&nbsp;<b>yppasswdd</b>&nbsp;daemon on that host via RPC, and provides it with the updated<br>password information. Usually you install&nbsp;<b>yppasswd</b>&nbsp;over the normal program by doing something like this:<br>
#&nbsp;<b>cd /bin</b><br>
#&nbsp;<b>mv passwd passwd.old</b><br>
#&nbsp;<b>ln yppasswd passwd</b><br>
At the same time, you have to install&nbsp;<b>rpc.yppasswdd</b>&nbsp;on the server and start it from a network script. This<br>will effectively hide any of the contortions of NIS from your users.<br>
13.8. Using the passwd and group Maps<br>
269<br>
<hr>
<A name=286></a><b>13.9. Using NIS with Shadow Support</b><br>
&nbsp;Using NIS in conjunction with shadow password files is somewhat problematic. First we have some bad<br>news: using NIS defeats the goals of shadow passwords. The&nbsp;shadow&nbsp;password scheme was designed to<br>prevent nonroot users from having access to the encrypted form of the login passwords. Using NIS to share<br>shadow&nbsp;data by necessity makes the encrypted passwords available to any user who can listen to the NIS<br>server replies on the network. A policy to enforce users to choose good passwords is arguably better than<br>trying to shadow passwords in an NIS environment. Let's take a quick look at how you do it, should you<br>decide to forge on ahead.<br>
In libc5 there is no real solution to sharing&nbsp;shadow&nbsp;data using NIS. The only way to distribute password and<br>user information by NIS is through the standard&nbsp;passwd.*&nbsp;maps. If you do have shadow passwords<br>installed, the easiest way to share them is to generate a proper&nbsp;passwd&nbsp;file from&nbsp;/etc/shadow&nbsp;using tools<br>like&nbsp;<b>pwuncov</b>, and create the NIS maps from that file.<br>
Of course, there are some hacks necessary to use NIS and shadow passwords at the same time, for instance,<br>by installing an&nbsp;/etc/shadow&nbsp;file on each host in the network, while distributing user information, through<br>NIS. However, this hack is really crude and defies the goal of NIS, which is to ease system administration.<br>
&nbsp;The NIS support in the GNU libc library (libc6) provides support for shadow password databases. It does<br>not provide any real solution to making your passwords accessible, but it does simplify password<br>management in environments in which you do want to use NIS with shadow passwords. To use it, you must<br>create a&nbsp;shadow.byname&nbsp;database and add the following line to your&nbsp;/etc/nsswitch.conf:<br>
<b># Shadow password support</b><br>
<b>shadow: &nbsp; &nbsp; &nbsp; &nbsp; compat</b><br>
If you use shadow passwords along with NIS, you must try to maintain some security by restricting access to<br><a href="TLNAGs.html#278">your NIS database. See&nbsp;Section 13.5</a>&nbsp;earlier in this chapter.<br>
13.9. Using NIS with Shadow Support<br>
270<br>
<hr>
<A name=287></a><b>Chapter 14. The NetworkFile System</b><br>
The Network File System (NFS) is probably the most prominent network service using RPC. It allows you to<br>access files on remote hosts in exactly the same way you would access local files. A mixture of kernel<br>support and user−space daemons on the client side, along with an NFS server on the server side, makes this<br>possible. This file access is completely transparent to the client and works across a variety of server and host<br>architectures.<br>
NFS offers a number of useful features:<br>
Data accessed by all users can be kept on a central host, with clients mounting this directory at boot<br>
•&nbsp;<br>
time. For example, you can keep all user accounts on one host and have all hosts on your network<br>mount&nbsp;/home&nbsp;from that host. If NFS is installed beside NIS, users can log into any system and still<br>work on one set of files.<br>Data consuming large amounts of disk space can be kept on a single host. For example, all files and<br>
•&nbsp;<br>
programs relating to LaTeX and METAFONT can be kept and maintained in one place.<br>Administrative data can be kept on a single host. There is no need to use&nbsp;<br>
•&nbsp;<br>
<b>rcp</b>&nbsp;to install the same<br>
stupid file on 20 different machines.<br>
It's not too hard to set up basic NFS operation on both the client and server; this chapter tells you how.<br>
Linux NFS is largely the work of Rick Sladkey, who wrote the NFS kernel code and large parts of the NFS<br>server.[79]&nbsp;The latter is derived from the&nbsp;<i>unfsd</i>&nbsp;user space NFS server, originally written by Mark Shand, and<br>the&nbsp;<i>hnfs</i>&nbsp;Harris NFS server, written by Donald Becker.&nbsp;<br>
Let's have a look at how NFS works. First, a client tries to mount a directory from a remote host on a local<br>directory just the same way it does a physical device. However, the syntax used to specify the remote<br>directory is different. For example, to mount&nbsp;/home&nbsp;from host vlager to&nbsp;/users&nbsp;on vale, the administrator<br>issues the following command on vale:[80]<br>
#&nbsp;<b>mount −t nfs vlager:/home /users</b><br>
<b>mount</b>&nbsp;will try to connect to the&nbsp;<b>rpc.mountd</b>&nbsp;mount daemon on vlager via RPC. The server will check if<br>vale is permitted to mount the directory in question, and if so, return it a file handle. This file handle will be<br>used in all subsequent requests to files below&nbsp;/users.<br>
&nbsp;When someone accesses a file over NFS, the kernel places an RPC call to&nbsp;<b>rpc.nfsd</b>&nbsp;(the NFS daemon) on<br>the server machine. This call takes the file handle, the name of the file to be accessed, and the user and group<br>IDs of the user as parameters. These are used in determining access rights to the specified file. In order to<br>prevent unauthorized users from reading or modifying files, user and group IDs must be the same on both<br>hosts.<br>
On most Unix implementations, the NFS functionality of both client and server is implemented as<br>kernel−level daemons that are started from user space at system boot. These are the&nbsp;<i>NFS<br>Daemon</i>&nbsp;(<b>rpc.nfsd</b>) on the server host, and the&nbsp;<i>Block I/O Daemon</i>&nbsp;(<b>biod</b>) on the client host. To improve<br>throughput,&nbsp;<b>biod</b>&nbsp;performs asynchronous I/O using read−ahead and write−behind; also, several<br><b>rpc.nfsd</b>&nbsp;daemons are usually run concurrently.<br>
&nbsp;The current NFS implementation of Linux is a little different from the classic NFS in that the server code<br>runs entirely in user space, so running multiple copies simultaneously is more complicated. The current<br>
Chapter 14. The NetworkFile System<br>
271<br>
<hr>
<A name=288></a>Linux Network Administrators Guide<br>
<b>rpc.nfsd</b>&nbsp;implementation offers an experimental feature that allows limited support for multiple servers. Olaf<br>Kirch developed kernel−based NFS server support featured in 2.2 Version Linux kernels. Its performance is<br>significantly better than the existing userspace implementation. We'll describe it later in this chapter.<br>
Chapter 14. The NetworkFile System<br>
272<br>
<hr>
<A name=289></a><b>14.1. Preparing NFS</b><br>
Before you can use NFS, be it as server or client, you must make sure your kernel has NFS support<br>compiled in. Newer kernels have a simple interface on the&nbsp;proc&nbsp;filesystem for this, the<br>/proc/filesystems&nbsp;file, which you can display using&nbsp;<b>cat</b>:<br>
$&nbsp;<b>cat /proc/filesystems</b><br>
&nbsp; &nbsp; &nbsp; &nbsp; minix<br>
&nbsp; &nbsp; &nbsp; &nbsp; ext2<br>
&nbsp; &nbsp; &nbsp; &nbsp; msdos<br>
nodev &nbsp; proc<br>
nodev &nbsp; nfs<br>
If nfs is missing from this list, you have to compile your own kernel with NFS enabled, or perhaps you will<br>need to load the kernel module if your NFS support was compiled as a module. Configuring the kernel<br>network options is explained in the Kernel Configuration section of&nbsp;<br>
<a href="TLNAGs.html#64">Chapter 3</a>.<br>
14.1. Preparing NFS<br>
273<br>
<hr>
<A name=290></a><b>14.2. Mounting an NFS Volume</b><br>
&nbsp;The mounting of NFS volumes closely resembles regular file systems. Invoke&nbsp;<b>mount</b>&nbsp;using the following<br>syntax:[81]<br>
#&nbsp;<b>mount −t nfs&nbsp;</b><i>nfs_volume local_dir options</i><br>
<i>nfs_volume</i>&nbsp;is given as&nbsp;<i>remote_host</i>:<i>remote_dir</i>. Since this notation is unique to NFS filesystems,<br>you can leave out the&nbsp;−t nfs&nbsp;option.<br>
There are a number of additional options that you can specify to&nbsp;<b>mount</b>&nbsp;upon mounting an NFS volume.<br>These may be given either following the&nbsp;−o&nbsp;switch on the command line or in the options field of the<br>/etc/fstab&nbsp;entry for the volume. In both cases, multiple options are separated by commas and must not<br>contain any whitespace characters. Options specified on the command line always override those given in the<br>fstab&nbsp;file.<br>
Here is a sample entry from&nbsp;/etc/fstab:<br>
# volume &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mount point &nbsp; &nbsp; &nbsp; type &nbsp;options<br>
news:/var/spool/news &nbsp;/var/spool/news &nbsp; nfs &nbsp; timeo=14,intr<br>
This volume can then be mounted using this command:<br>
#&nbsp;<b>mount news:/var/spool/news</b><br>
In the absence of an&nbsp;fstab&nbsp;entry, NFS&nbsp;<b>mount</b>&nbsp;invocations look a lot uglier. For instance, suppose you<br>mount your users' home directories from a machine named moonshot, which uses a default block size of 4 K<br>for read/write operations. You might increase the block size to 8 K to obtain better performance by issuing<br>the command:<br>
#&nbsp;<b>mount moonshot:/home /home −o rsize=8192,wsize=8192</b><br>
The list of all valid options is described in its entirety in the&nbsp;nfs(5)&nbsp;manual page. The following is a<br>partial list of options you would probably want to use:<br>
<i>rsize=n and wsize=n</i><br>
These specify the datagram size used by the NFS clients on read and write requests, respectively. The<br>default depends on the version of kernel, but is normally 1,024 bytes.<br>
<i>timeo=n</i><br>
This sets the time (in tenths of a second) the NFS client will wait for a request to complete. The<br>default value is 7 (0.7 seconds). What happens after a timeout depends on whether you use the<br><i>hard</i>&nbsp;or&nbsp;<i>soft</i>&nbsp;option.<br>
<i>hard</i><br>
Explicitly mark this volume as hard−mounted. This is on by default. This option causes the server to<br>report a message to the console when a major timeout occurs and continues trying indefinitely.<br>
14.2. Mounting an NFS Volume<br>
274<br>
<hr>
<A name=291></a>Linux Network Administrators Guide<br>
<i>soft</i><br>
Soft−mount (as opposed to hard−mount) the driver. This option causes an I/O error to be reported to<br>the process attempting a file operation when a major timeout occurs.<br>
<i>intr</i><br>
Allow signals to interrupt an NFS call. Useful for aborting when the server doesn't respond.<br>
Except for&nbsp;<i>rsize</i>&nbsp;and&nbsp;<i>wsize</i>, all of these options apply to the client's behavior if the server should become<br>temporarily inaccessible. They work together in the following way: Whenever the client sends a request to<br>the NFS server, it expects the operation to have finished after a given interval (specified in the<br><i>timeout</i>&nbsp;option). If no confirmation is received within this time, a so−called&nbsp;<i>minor timeout</i>&nbsp;occurs, and the<br>operation is retried with the timeout interval doubled. After reaching a maximum timeout of 60 seconds, a<br><i>major timeout</i>&nbsp;occurs.<br>
&nbsp;By default, a major timeout causes the client to print a message to the console and start all over again, this<br>time with an initial timeout interval twice that of the previous cascade. Potentially, this may go on forever.<br>Volumes that stubbornly retry an operation until the server becomes available again are called<br><i>hard−mounted</i>. The opposite variety, called&nbsp;<i>soft−mounted</i>, generate an I/O error for the calling process<br>whenever a major timeout occurs. Because of the write−behind introduced by the buffer cache, this error<br>condition is not propagated to the process itself before it calls the&nbsp;write&nbsp;function the next time, so a<br>program can never be sure that a write operation to a soft−mounted volume has succeeded at all.<br>
Whether you hard− or soft−mount a volume depends partly on taste but also on the type of information you<br>want to access from a volume. For example, if you mount your X programs by NFS, you certainly would not<br>want your X session to go berserk just because someone brought the network to a grinding halt by firing up<br>seven copies of Doom at the same time or by pulling the Ethernet plug for a moment. By hard−mounting the<br>directory containing these programs, you make sure that your computer waits until it is able to re−establish<br>contact with your NFS server. On the other hand, non−critical data such as NFS−mounted news partitions or<br>FTP archives may also be soft−mounted, so if the remote machine is temporarily unreachable or down, it<br>doesn't hang your session. If your network connection to the server is flaky or goes through a loaded router,<br>you may either increase the initial timeout using the&nbsp;<i>timeo</i>&nbsp;option or hard−mount the volumes. NFS volumes<br>are hard−mounted by default.<br>
Hard mounts present a problem because, by default, the file operations are not interruptible. Thus, if a process<br>attempts, for example, a write to a remote server and that server is unreachable, the user's application hangs<br>and the user can't do anything to abort the operation. If you use the&nbsp;<i>intr</i>&nbsp;option in conjuction with a hard<br>mount, any signals received by the process interrupt the NFS call so that users can still abort hanging file<br>accesses and resume work (although without saving the file).<br>
Usually, the&nbsp;<b>rpc.mountd</b>&nbsp;daemon in some way or other keeps track of which directories have been mounted<br>by what hosts. This information can be displayed using the&nbsp;<b>showmount</b>&nbsp;program, which is also included in<br>the NFS server package:<br>
#&nbsp;<b>showmount −e moonshot</b><br>
Export list for localhost:<br>
/home &lt;anon clnt&gt;<br>
#&nbsp;<b>showmount −d moonshot</b><br>
Directories on localhost:<br>
/home<br>
14.2. Mounting an NFS Volume<br>
275<br>
<hr>
<A name=292></a>Linux Network Administrators Guide<br>
#&nbsp;<b>showmount −a moonshot</b><br>
All mount points on localhost:<br>
localhost:/home<br>
14.2. Mounting an NFS Volume<br>
276<br>
<hr>
<A name=293></a><b>14.3. The NFS Daemons</b><br>
&nbsp;If you want to provide NFS service to other hosts, you have to run the&nbsp;<b>rpc.nfsd</b>&nbsp;and&nbsp;<b>rpc.mountd</b>&nbsp;daemons<br>on your machine. As RPC−based programs, they are not managed by&nbsp;<b>inetd</b>, but are started up at boot time<br>and register themselves with the portmapper; therefore, you have to make sure to start them only after<br><b>rpc.portmap</b>&nbsp;is running. Usually, you'd use something like the following example in one of your network<br>boot scripts:<br>
if [ −x /usr/sbin/rpc.mountd ]; then<br>
&nbsp; &nbsp; &nbsp; &nbsp; /usr/sbin/rpc.mountd; echo −n &quot; mountd&quot;<br>
fi<br>
if [ −x /usr/sbin/rpc.nfsd ]; then<br>
&nbsp; &nbsp; &nbsp; &nbsp; /usr/sbin/rpc.nfsd; echo −n &quot; nfsd&quot;<br>
fi<br>
The ownership information of the files an NFS daemon provides to its clients usually contains only<br>numerical user and group IDs. If both client and server associate the same user and group names with these<br>numerical IDs, they are said to their share uid/gid space. For example, this is the case when you use NIS to<br>distribute the&nbsp;passwd&nbsp;information to all hosts on your LAN.<br>
On some occasions, however, the IDs on different hosts do not match. Rather than updating the uids and gids<br>of the client to match those of the server, you can use the&nbsp;<b>rpc.ugidd</b>&nbsp;mapping daemon to work around the<br>disparity. Using the&nbsp;<i>map_daemon</i>&nbsp;option explained a little later, you can tell&nbsp;<b>rpc.nfsd</b>&nbsp;to map the server's<br>uid/gid space to the client's uid/gid space with the aid of the&nbsp;<b>rpc.ugidd</b>&nbsp;on the client. Unfortunately, the<br><b>rpc.ugidd</b>&nbsp;daemon isn't supplied on all modern Linux distributions, so if you need it and yours doesn't have<br>it, you will need to compile it from source.<br>
<b>rpc.ugidd</b>&nbsp;is an RPC−based server that is started from your network boot scripts, just like&nbsp;<b>rpc.nfsd</b>&nbsp;and<br><b>rpc.mountd</b>:<br>
if [ −x /usr/sbin/rpc.ugidd ]; then<br>
&nbsp; &nbsp; &nbsp; &nbsp; /usr/sbin/rpc.ugidd; echo −n &quot; ugidd&quot;<br>
fi<br>
14.3. The NFS Daemons<br>
277<br>
<hr>
<A name=294></a><b>14.4. The exports File</b><br>
&nbsp;Now we'll look at how we configure the NFS server. Specifically, we'll look at how we tell the NFS server<br>what filesystems it should make available for mounting, and the various parameters that control the access<br>clients will have to the filesystem. The server determines the type of access that is allowed to the server's<br>files. The&nbsp;/etc/exports&nbsp;file lists the filesystems that the server will make available for clients to mount<br>and use.<br>
By default,&nbsp;<b>rpc.mountd</b>&nbsp;disallows all directory mounts, which is a rather sensible attitude. If you wish to<br>permit one or more hosts to NFS−mount a directory, you must&nbsp;<i>export</i>&nbsp;it, that is, specify it in the<br>exports&nbsp;file. A sample file may look like this:<br>
# exports file for vlager<br>
/home &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vale(rw) vstout(rw) vlight(rw)<br>
/usr/X11R6 &nbsp; &nbsp; &nbsp; &nbsp;vale(ro) vstout(ro) vlight(ro)<br>
/usr/TeX &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vale(ro) vstout(ro) vlight(ro)<br>
/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vale(rw,no_root_squash)<br>
/home/ftp &nbsp; &nbsp; &nbsp; &nbsp; (ro)<br>
Each line defines a directory and the hosts that are allowed to mount it. A hostname is usually a fully<br>qualified domain name but may additionally contain the * and ? wildcards, which act the way they do with<br>the Bourne shell. For instance,&nbsp;lab*.foo.com&nbsp;matches lab01.foo.com as well as laboratory.foo.com. The<br>host may also be specified using an IP address range in the form&nbsp;<i>address</i>/<i>netmask</i>. If no hostname is<br>given, as with the&nbsp;/home/ftp&nbsp;directory in the previous example, any host matches and is allowed to mount<br>the directory.<br>
When checking a client host against the&nbsp;exports&nbsp;file,&nbsp;<b>rpx.mountd</b>&nbsp;looks up the client's hostname using the<br>gethostbyaddr&nbsp;call. With DNS, this call returns the client's canonical hostname, so you must make sure<br>not to use aliases in&nbsp;exports. In an NIS environment the returned name is the first match from the hosts<br>database, and with neither DNS or NIS, the returned name is the first hostname found in the&nbsp;hosts&nbsp;file that<br>matches the client's address.<br>
The hostname is followed by an optional comma−separated list of flags, enclosed in parentheses. Some of the<br>values these flags may take are:<br>
<i>secure</i><br>
This flag insists that requests be made from a reserved source port, i.e., one that is less than 1,024.<br>This flag is set by default.<br>
<i>insecure</i><br>
This flag reverses the effect of the&nbsp;<i>secure</i>&nbsp;flag.<br>
<i>ro</i><br>
This flag causes the NFS mount to be read−only. This flag is enabled by default.<br>
<i>rw</i><br>
This option mounts file hierarchy read−write.<br>
14.4. The exports File<br>
278<br>
<hr>
<A name=295></a>Linux Network Administrators Guide<br>
<i>root_squash</i><br>
This security feature denies the superusers on the specified hosts any special access rights by<br>mapping requests from uid 0 on the client to the uid 65534 (that is, −2) on the server. This uid should<br>be associated with the user nobody.<br>
<i>no_root_squash</i><br>
Don't map requests from uid 0. This option is on by default, so superusers have superuser access to<br>your system's exported directories.<br>
<i>link_relative</i><br>
This option converts absolute symbolic links (where the link contents start with a slash) into relative<br>links. This option makes sense only when a host's entire filesystem is mounted; otherwise, some of<br>the links might point to nowhere, or even worse, to files they were never meant to point to. This<br>option is on by default.<br>
<i>link_absolute</i><br>
This option leaves all symbolic links as they are (the normal behavior for Sun−supplied NFS servers).<br>
<i>map_identity</i><br>
This option tells the server to assume that the client uses the same uids and gids as the server. This<br>option is on by default.<br>
<i>map_daemon</i><br>
This option tells the NFS server to assume that client and server do not share the same uid/gid space.<br><b>rpc.nfsd</b>&nbsp;then builds a list that maps IDs between client and server by querying the client's<br><b>rpc.ugidd</b>&nbsp;daemon.<br>
<i>map_static</i><br>
This option allows you to specify the name of a file that contains a static map of uids and gids. For<br>example,&nbsp;map_static=/etc/nfs/vlight.map&nbsp;would specify the<br>/etc/nfs/vlight.map&nbsp;file as a uid/gid map. The syntax of the map file is described in the<br>exports(5)&nbsp;manual page.<br>
<i>map_nis</i><br>
This option causes the NIS server to do the uid and gid mapping.<br>
<i>anonuid and anongid</i><br>
These options allow you to specify the uid and gid of the anonymous account. This is useful if you<br>have a volume exported for public mounts.<br>
Any error in parsing the&nbsp;exports&nbsp;file is reported to&nbsp;<b>syslogd</b>'s daemon facility at level notice whenever<br><b>rpc.nfsd</b>&nbsp;or&nbsp;<b>rpc.mountd</b>&nbsp;is started up.<br>
14.4. The exports File<br>
279<br>
<hr>
<A name=296></a>Linux Network Administrators Guide<br>
Note that hostnames are obtained from the client's IP address by reverse mapping, so the resolver must be<br>configured properly. If you use BIND and are very security conscious, you should enable spoof checking in<br>your&nbsp;host.conf&nbsp;file. We discuss these topics in&nbsp;<a href="TLNAGs.html#120">Chapter 6.</a><br>
14.4. The exports File<br>
280<br>
<hr>
<A name=297></a><b>14.5. Kernel−Based NFSv2 Server Support</b><br>
&nbsp;The user−space NFS server traditionally used in Linux works reliably but suffers performance problems<br>when overworked. This is primarily because of the overhead the system call interface adds to its operation,<br>and because it must compete for time with other, potentially less important, user−space processes.<br>
&nbsp;The 2.2.0 kernel supports an experimental kernel−based NFS server developed by Olaf Kirch and further<br>developed by H.J. Lu, G. Allan Morris, and Trond Myklebust. The kernel−based NFS support provides a<br>significant boost in server performance.<br>
In current release distributions, you may find the server tools available in prepackaged form. If not, you can<br>locate them at http://csua.berkeley.edu/~gam3/knfsd/. You need to build a 2.2.0 kernel with the kernel−based<br>NFS daemon included in order to make use of the tools. You can check if your kernel has the NFS daemon<br>included by looking to see if the&nbsp;/proc/sys/sunrpc/nfsd_debug&nbsp;file exists. If it's not there, you may<br>have to load the&nbsp;<b>rpc.nfsd</b>&nbsp;module using the&nbsp;<b>modprobe</b>&nbsp;utility.<br>
The kernel−based NFS daemon uses a standard&nbsp;/etc/exports&nbsp;configuration file. The package supplies<br>replacement versions of the&nbsp;<b>rpc.mountd</b>&nbsp;and&nbsp;<b>rpc.nfsd</b>&nbsp;daemons that you start much the same way as their<br>userspace daemon counterparts.<br>
14.5. Kernel−Based NFSv2 Server Support<br>
281<br>
<hr>
<A name=298></a><b>14.6. Kernel−Based NFSv3 Server Support</b><br>
The version of NFS that has been most commonly used is NFS Version 2. Technology has rolled on ahead<br>and it has begun to show weaknesses that only a revision of the protocol could overcome. Version 3 of the<br>Network File System supports larger files and filesystems, adds significantly enhanced security, and offers a<br>number of performance improvements that most users will find useful.<br>
Olaf Kirch and Trond Myklebust are developing an experimental NFSv3 server. It is featured in the<br>developer Version 2.3 kernels and a patch is available against the 2.2 kernel source. It builds on the Version 2<br>kernel−based NFS daemon.<br>
The patches are available from the Linux Kernel based NFS server home page at<br>http://csua.berkeley.edu/~gam3/knfsd/.<br>
14.6. Kernel−Based NFSv3 Server Support<br>
282<br>
<hr>
<A name=299></a><b>Chapter 15. IPX and the NCP Filesystem</b><br>
&nbsp;Long before Microsoft learned about networking, and even before the Internet was known outside<br>academic circles, corporate environments shared files and printers using file and print servers based on the<br>Novell NetWare operating system and associated protocols.[82]&nbsp;Many of these corporate users still have<br>legacy networks using these protocols and want to integrate this support with their new TCP/IP support.<br>
Linux supports not only the TCP/IP protocols, but also the suite of protocols used by the Novell Corporation's<br>NetWare operating system. These protocols are distant cousins of TCP/IP, and while they perform similar<br>sorts of functions, they differ in a number of ways and are unfortunately incompatible.<br>
Linux has both free and commercial software offerings to provide support for integration with the Novell<br>products.<br>
We'll provide a brief description of the protocols themselves in this chapter, but we focus on how to<br>configure and use free software to allow Linux to interoperate with Novell products.<br>
Chapter 15. IPX and the NCP Filesystem<br>
283<br>
<hr>
<A name=300></a><b>15.1. Xerox, Novell, and History</b><br>
&nbsp;First, let's look at where the protocols came from and what they look like. In the late 1970s, the Xerox<br>Corporation developed and published an open standard called the Xerox Network Specification (XNS). The<br>Xerox Network Specification described a series of protocols designed for general purpose internetworking,<br>with a strong emphasis on the use of local area networks. There were two primary networking protocols<br>involved: the Internet Datagram Protocol (IDP), which provided a connectionless and unreliable transport of<br>datagrams from one host to another, and the Sequenced Packet Protocol (SPP), which was a modified form of<br>IDP that was connection−based and reliable. The datagrams of an XNS network were individually addressed.<br>The addressing scheme used a combination of a 4−byte IDP network address (which was uniquely assigned<br>to each Ethernet LAN segment), and the 6−byte node address (the address of the NIC card). Routers were<br>devices that switched datagrams between two or more separate IDP networks. IDP has no notion of<br>subnetworks; any new collection of hosts requires another network address to be assigned. Network addresses<br>are chosen such that they are unique on the internetwork in question. Sometimes administrators develop<br>conventions by having each byte encode some other information, such as geographic location, so that<br>network addresses are allocated in a systemic way; it isn't a protocol requirement, however.<br>
&nbsp;The Novell Corporation chose to base their own networking suite on the XNS suite. Novell made small<br>enhancements to IDP and SPP and renamed them IPX (Internet Packet eXchange) and SPX (Sequenced<br>Packet eXchange). Novell added new protocols, such as the NetWare Core Protocol (NCP), which provided<br>file and printer sharing features that ran over IPX, and the Service Advertisement Protocol (SAP), which<br>enabled hosts on a Novell network to know which hosts provided which services.<br>
<a href="TLNAGs.html#300">Table 15−1</a>&nbsp;maps the relationship between the XNS, Novell, and TCP/IP suites in terms of function. The<br>
relationships are an approximation only, but should help you understand what is happening when we refer to<br>these protocols later on.<br>
<b>Table 15−1. XNS, Novell, and TCP/IP Protocol Relationships</b><br>
<b>XNS&nbsp;Novell&nbsp;TCP/IP&nbsp;Features</b><br>
IDP&nbsp;IPX<br>
UDP/IP&nbsp;Connectionless, unreliable transport<br>
SPP&nbsp;SPX<br>
TCP<br>
Connection−based, reliable transport<br>
NCP<br>
NFS<br>
File services<br>
RIP<br>
RIP<br>
Routing information exchange<br>
SAP<br>
Service availability information exchange<br>
15.1. Xerox, Novell, and History<br>
284<br>
<hr>
<A name=301></a><b>15.2. IPX and Linux</b><br>
&nbsp;Alan Cox first developed IPX support for the Linux kernel in 1985.&nbsp;[83]&nbsp;Initially it was useful for little<br>more than routing IPX datagrams. Since then, other people, notably Greg Page, have provided additional<br>support.[84]&nbsp;Greg developed the IPX configuration utilities that we'll use in this chapter to configure our<br>interfaces. Volker Lendecke developed support for the NCP filesystem to allow Linux to mount volumes on<br>network−connected NetWare fileservers.[85]&nbsp;He also created tools that allow printing to and from Linux.<br>Ales Dryak and Martin Stover each independently developed NCP fileserver daemons for Linux that allow<br>network−connected NetWare clients to mount Linux directories exported as NCP volumes, just as the NFS<br>daemon allows Linux to serve filesystems to clients using the NFS protocol.[86]&nbsp;Caldera Systems, Inc. offers<br>a commercial and fully licensed NetWare client and server that supports the latest Novell standards, including<br>support for the NetWare Directory Service (NDS).[87]<br>
Today, therefore, Linux supports a wide range of services that allow systems to be integrated with existing<br>Novell−based networks.<br>
<b>15.2.1. Caldera Support</b><br>
&nbsp;Although we don't detail the Caldera NetWare support in this chapter, it is important that we talk about it.<br>Caldera was founded by Ray Noorda, the former CEO of Novell. The Caldera NetWare support is a<br>commercial product and fully supported by Caldera. Caldera provides the NetWare support as a component<br>of their own Linux distribution called Caldera OpenLinux. The Caldera solution is an ideal way of<br>introducing Linux into environments that demand both commercial support and the ability to integrate into<br>existing or new Novell networks.<br>
The Caldera NetWare support is fully licensed by Novell, providing a high degree of certainty that the two<br>companies' products will be interoperable. The two exceptions to this certainty are &quot;pure IP&quot; operation for the<br>client, and NDS server, though neither of these were available at the time of writing. NetWare client and<br>NetWare server are both available. A suite of management tools is also provided that can simplify<br>management of not only your Linux−based NetWare machines, but your Novell NetWare machines, too, by<br>bringing the power of Unix scripting languages to the task. More information on Caldera can be found at their<br>web site.<br>
<b>15.2.2. More on NDS Support</b><br>
Along with Version 4 of NetWare, Novell introduced a feature called the NetWare Directory Service<br>(NDS). The NDS specifications are not available without a nondisclosure agreement, a restriction that<br>hampers development of free support. Only Version 2.2.0 or later of the&nbsp;ncpfs&nbsp;package, which we'll discuss<br>later, has any support for NDS. This support was developed by reverse engineering the NDS protocol. The<br>support seems to work, but is still officially considered experimental. You can use the non−NDS tools with<br>NetWare 4 servers, provided they have bindery emulation mode enabled.<br>
The Caldera software has full support for NDS because their implementation is licensed from Novell. This<br>implementation is not free, however. So you will not have access to the source code and will not be able to<br>freely copy and distribute the software.<br>
15.2. IPX and Linux<br>
285<br>
<hr>
<A name=302></a><b>15.3. Configuring the Kernel for IPXand NCPFS</b><br>
Configuring the kernel for IPX and the NCP filesystem is simply a matter of selecting the appropriate kernel<br>options at kernel build time. As with many other parts of the kernel, IPX and NCPFS kernel components can<br>be built into the kernel, or compiled as modules and loaded using the&nbsp;<b>insmod</b>&nbsp;command when you need them.<br>
The following options must be selected if you want to have Linux support and route the IPX protocol:<br>
General setup &nbsp;−−−&gt;<br>
&nbsp; &nbsp; [*] Networking support<br>
Networking options &nbsp;−−−&gt;<br>
&nbsp; &nbsp; &lt;*&gt; The IPX protocol<br>
Network device support &nbsp;−−−&gt;<br>
&nbsp; &nbsp; [*] Ethernet (10 or 100Mbit)<br>
&nbsp; &nbsp; &nbsp; &nbsp; ... and appropriate Ethernet device drivers<br>
If you want Linux to support the NCP filesystem so it can mount remote NetWare volumes, you must<br>additionally select these options:<br>
Filesystems &nbsp;−−−&gt;<br>
&nbsp; &nbsp; [*] /proc filesystem support<br>
&nbsp; &nbsp; &lt;*&gt; NCP filesystem support (to mount NetWare volumes)<br>
When you've compiled and installed your new kernel, you're ready to run IPX.<br>
15.3. Configuring the Kernel for IPXand NCPFS<br>
286<br>
<hr>
<A name=303></a><b>15.4. Configuring IPX Interfaces</b><br>
Just as with TCP/IP, you must configure your IPX interfaces before you can use them. The IPX protocol has<br>some unique requirements; consequently, a special set of configuration tools was developed. We will use<br>these tools to configure our IPX interfaces and routes.<br>
<b>15.4.1. Network Devices Supporting IPX</b><br>
The IPX protocol assumes that any collection of hosts that can transmit datagrams to each other without<br>routing belong to the same IPX network. All hosts belonging to a single Ethernet segment would all belong to<br>the same IPX network. Similarly (but less intuitively), both hosts supporting a PPP−based serial link must<br>belong to the IPX network that is the serial link itself. In an Ethernet environment, there are a number of<br>different frame types that may be used to carry IPX datagrams. The frame types represent different Ethernet<br>protocols and describe differing ways of carrying multiple protocols on the same Ethernet network. The most<br>common frame types you will encounter are&nbsp;802.2&nbsp;and&nbsp;ethernet_II. We'll talk more about frame types<br>in the next section.<br>
The Linux network devices that currently support the IPX protocol are the Ethernet and PPP drivers. The<br>Ethernet or PPP interface must be active before it can be configured for IPX use. Typically, you configure an<br>Ethernet device with both IP and IPX, so the device already exists, but if your network is IPX only, you need<br>to use the&nbsp;<b>ifconfig</b>&nbsp;to change the Ethernet device status to the following:<br>
#&nbsp;<b>ifconfig eth0 up</b><br>
<b>15.4.2. IPX Interface Configuration Tools</b><br>
Greg Page developed a set of configuration tools for IPX interfaces, which is a precompiled package in<br>modern distributions and may also be obtained in source form by anonymous FTP from<br><i>http://metalab.unc.edu/</i>&nbsp;in the&nbsp;/pub/Linux/system/filesystems/ncpfs/ipx.tgz&nbsp;file.<br>
An&nbsp;rc&nbsp;script file usually runs the IPX tools at boot time. Your distribution may already do this for you if you<br>have installed the prepackaged software.<br>
<b>15.4.3. The ipx_configure Command</b><br>
Each IPX interface must know which IPX network it belongs to and which frame type to use for IPX. Each<br>host supporting IPX has at least one interface that the rest of the network will use to refer to it, known as the<br><i>primary</i>&nbsp;interface. The Linux kernel IPX support provides a means of automatically configuring these<br>parameters; the&nbsp;<b>ipx_configure</b>&nbsp;command enables or disables this automatic configuration feature.<br>
With no arguments, the&nbsp;<b>ipx_configure</b>&nbsp;command displays the current setting of the automatic configuration<br>flags:<br>
15.4. Configuring IPX Interfaces<br>
287<br>
<hr>
<A name=304></a>Linux Network Administrators Guide<br>
#&nbsp;<b>ipx_configure</b><br>
Auto Primary Select is OFF<br>
Auto Interface Create is OFF<br>
Both the Auto Primary and Auto Interface flags are off by default. To set them and enable automatic<br>configuration, you simply supply arguments like these:<br>
#&nbsp;<b>ipx_configure −−auto_interface=on −−auto_primary=on</b><br>
When the&nbsp;−−auto_primary&nbsp;argument is set to&nbsp;on, the kernel will automatically ensure that at least one<br>active interface operates as the primary interface for the host.<br>
When the&nbsp;−−auto_interface&nbsp;argument is set to&nbsp;on, the kernel IPX driver will listen to all of the<br>frames received on the active network interfaces and attempt to determine the IPX network address and frame<br>type used.<br>
The auto−detection mechanism works well on properly managed networks. Sometimes network<br>administrators take shortcuts and break rules, and this can cause problems for the Linux auto−detection code.<br>The most common example of this is when one IPX network is configured to run over the same Ethernet with<br>multiple frame types. This is technically an invalid configuration, as an&nbsp;<i>802.2</i>&nbsp;host cannot directly<br>communicate with an Ethernet−II host and therefore they cannot be on the same IPX network. The Linux IPX<br>network software listens on the segment to IPX datagrams transmitted on it. From these, it attempts to<br>identify which network addresses are in use and which frame type is associated with each. If the same<br>network address is in use with multiple frame types or on multiple interfaces, the Linux code detects this as a<br>network address collision and is unable to determine which is the correct frame type. You will know this is<br>occurring if you see messages in your system log that look like:<br>
IPX: Network number collision 0x3901ab00<br>
eth0 etherII and eth0 802.3<br>
If you see this problem, disable the auto−detection feature and configure the interfaces manually using the<br><b>ipx_interface</b>&nbsp;command described in the next section.<br>
<b>15.4.4. The ipx_interface Command</b><br>
The&nbsp;<b>ipx_interface</b>&nbsp;command is used to manually add, modify, and delete IPX capability from an existing<br>network device. You should use&nbsp;<b>ipx_interface</b>&nbsp;when the automatic configuration method just described does<br>not work for you, or if you don't want to leave your interface configuration to chance.&nbsp;<b>ipx_interface</b>&nbsp;allows<br>you to specify the IPX network address, primary interface status, and IPX frame type that a network device<br>will use. If you are creating multiple IPX interfaces, you need one&nbsp;<b>ipx_interface</b>&nbsp;for each.<br>
The command syntax to add IPX to an existing device is straightforward and best explained with an example.<br>Let's add IPX to an existing Ethernet device:<br>
#&nbsp;<b>ipx_interface add −p eth0 etherII 0x32a10103</b><br>
The parameters in turn mean:<br>
<i>−p</i><br>
15.4.4. The ipx_interface Command<br>
288<br>
<hr>
<A name=305></a>Linux Network Administrators Guide<br>
This parameter specifies that this interface should be a primary interface. This parameter is optional.<br>
<i>eth0</i><br>
This is the name of the network device to which we are adding IPX support.<br>
<i>etherII</i><br>
This parameter is the frame type, in this case Ethernet−II. This value may also be coded as&nbsp;802.2,<br>802.3, or&nbsp;SNAP.<br>
<i>0x32a10103</i><br>
This is the IPX network address to which this interface belongs.<br>
The following command removes IPX from an interface:<br>
#&nbsp;<b>ipx_interface del eth0 etherII</b><br>
Lastly, to display the current IPX configuration of a network device, use:<br>
#&nbsp;<b>ipx_interface check eth0 etherII</b><br>
The&nbsp;<b>ipx_interface</b>&nbsp;command is explained more fully in its manual page.<br>
15.4.4. The ipx_interface Command<br>
289<br>
<hr>
<A name=306></a><b>15.5. Configuring an IPX Router</b><br>
You will recall from our short discussion of the protocols used in an IPX environment that IPX is a routable<br>protocol and that the Routing Information Protocol (RIP) is used to propagate routing information. The IPX<br>version of RIP is quite similar to the IP version. They operate in essentially the same way; routers<br>periodically broadcast the contents of their routing tables and other routers learn of them by listening and<br>integrating the information they receive. Hosts need only know who their local network is and be sure to send<br>datagrams for all other destinations via their local router. The router is responsible for carrying these<br>datagrams and forwarding them on to the next hop in the route.<br>
&nbsp;In an IPX environment, a second class of information must be propagated around the network. The Service<br>Advertisement Protocol (SAP) carries information relating to which services are available at which hosts<br>around the network. It is the SAP protocol, for example, that allows users to obtain lists of file or print<br>servers on the network. The SAP protocol works by having hosts that provide services periodically broadcast<br>the list of services they offer. The IPX network routers collect this information and propagate it throughout<br>the network alongside the network routing information. To be a compliant IPX router, you must propagate<br>both RIP and SAP information.<br>
Just like IP, IPX on Linux provides a routing daemon named&nbsp;<b>ipxd</b>&nbsp;to perform the tasks associated with<br>managing routing. Again, just as with IP, it is actually the kernel that manages the forwarding of datagrams<br>between IPX network interfaces, but it performs this according to a set of rules called the IPX routing table.<br>The&nbsp;<b>ipxd</b>&nbsp;daemon keeps that set of rules up to date by listening on each of the active network interfaces and<br>analyzing when a routing change is necessary. The&nbsp;<b>ipxd</b>&nbsp;daemon also answers requests from hosts on a<br>directly connected network that ask for routing information.<br>
The&nbsp;<b>ipxd</b>&nbsp;command is available prepackaged in some distributions, and in source form by anonymous FTP<br>from&nbsp;<i>http://metalab.unc.edu/</i>&nbsp;in the<br>/pub/Linux/system/filesystems/ncpfs/ipxripd−x.xx.tgz&nbsp;file.<br>
No configuration is necessary for the&nbsp;<b>ipxd</b>&nbsp;daemon. When it starts, it automatically manages routing among<br>the IPX devices that have been configured. The key is to ensure that you have your IPX devices configured<br>correctly using the&nbsp;<b>ipx_interface</b>&nbsp;command before you start&nbsp;<b>ipxd</b>. While auto−detection may work, when<br>you're performing a routing function it's best not to take chances, so manually configure the interfaces and<br>save yourself the pain of nasty routing problems. Every 30 seconds,&nbsp;<b>ipxd</b>&nbsp;rediscovers all of the locally<br>attached IPX networks and automatically manages them. This provides a means of managing networks on<br>interfaces that may not be active all of the time, such as PPP interfaces.<br>
The&nbsp;<b>ipxd</b>&nbsp;would normally be started at boot time from an&nbsp;rc&nbsp;boot script like this:<br>
#&nbsp;<b>/usr/sbin/ipxd</b><br>
No&nbsp;&amp;&nbsp;character is necessary because&nbsp;<b>ipxd</b>&nbsp;will move itself into the background by default. While the<br><b>ipxd</b>&nbsp;daemon is most useful on machines acting as IPX routers, it is also useful to hosts on segments where<br>there are multiple routers present. When you specify the&nbsp;−p&nbsp;argument,&nbsp;<b>ipxd</b>&nbsp;will act passively, listening to<br>routing information from the segment and updating the routing tables, but it will not transmit any routing<br>information. This way, a host can keep its routing tables up to date without having to request routes each time<br>it wants to contact a remote host.<br>
15.5. Configuring an IPX Router<br>
290<br>
<hr>
<A name=307></a>Linux Network Administrators Guide<br>
<b>15.5.1. Static IPX Routing Using the ipx_route Command</b><br>
There are occasions when we might want to hardcode an IPX route. Just as with IP, we can do this with<br>IPX. The&nbsp;<b>ipx_route</b>&nbsp;command writes a route into the IPX routing table without it needing to have been<br>learned by the&nbsp;<b>ipxd</b>&nbsp;routing daemon. The routing syntax is very simple (since IPX does not support<br>subnetworking) and looks like:<br>
#&nbsp;<b>ipx_route add 203a41bc 31a10103 00002a02b102</b><br>
The command shown would add a route to the remote IPX network&nbsp;<i>203a41bc</i>&nbsp;via the router on our local<br>network&nbsp;<i>31a10103</i>&nbsp;with node address&nbsp;<i>00002a02b102</i>.<br>
You can find the node address of a router by making judicious use of the&nbsp;<b>tcpdump</b>&nbsp;command with the<br>−e&nbsp;argument to display link level headers and look for traffic from the router. If the router is a Linux<br>machine, you can more simply use the&nbsp;<b>ifconfig</b>&nbsp;command to display it.<br>
You can delete a route using the&nbsp;<b>ipx_route</b>&nbsp;command:<br>
#&nbsp;<b>ipx_route del 203a41bc</b><br>
You can list the routes that are active in the kernel by looking at the&nbsp;/proc/net/ipx_route&nbsp;file. Our<br>routing table so far looks like this:<br>
#&nbsp;<b>cat ipx_route</b><br>
Network &nbsp; &nbsp;Router_Net &nbsp; Router_Node<br>
203A41BC &nbsp; 31A10103 &nbsp; &nbsp; 00002a02b102<br>
31A10103 &nbsp; Directly &nbsp; &nbsp; Connected<br>
The route to the&nbsp;<i>31A10103</i>&nbsp;network was automatically created when we configured the IPX interface. Each of<br>our local networks will be represented by an&nbsp;/proc/net/ipx_route&nbsp;entry like this one. Naturally, if our<br>machine is to act as a router, it will need at least one other interface.<br>
<b>15.5.2. Internal IPX Networks and Routing</b><br>
IPX hosts with more than one IPX interface have a unique network/node address combination for each of<br>their interfaces. To connect to such a host, you may use any of these network/node address combinations.<br>When SAP advertizes services, it supplies the network/node address associated with the service that is<br>offered. On hosts with multiple interfaces, this means that one of the interfaces must be chosen as the one to<br>propagate; this is the function of the primary interface flag we talked about earlier. But this presents a<br>problem: the route to this interface may not always be the optimal one, and if a network failure occurs that<br>isolates that network from the rest of the network, the host will become unreachable even though there are<br>other&nbsp;<i>possible</i>&nbsp;routes to the other interfaces. The other routes are never known to other hosts because they are<br>never propagated, and the kernel has no way of knowing that it should choose another primary interface. To<br>avoid this problem, a device was developed that allows an IPX host to be known by a single<br>route−independent network/node address for the purposes of SAP propagation. This solves our problem<br>because this new network/node address is reachable via all of the host interfaces, and is the one that is<br>advertised by SAP.<br>
To illustrate the problem and its solution,&nbsp;<a href="TLNAGs.html#308">Figure 15−1&nbsp;shows a server attached to two IPX networks. The first</a><br>
15.5.1. Static IPX Routing Using the ipx_route Command<br>
291<br>
<hr>
<A name=308></a><IMG src="TLNAG-308_1.png"><br>
Linux Network Administrators Guide<br>
network has no internal network, but the second does. The host in diagram&nbsp;<a href="TLNAGs.html#308">Figure 15−1</a>&nbsp;would choose one of<br>its interfaces as its primary interface, let's assume&nbsp;<i>0000001a:0800000010aa</i>, and that is what would be<br>advertised as its service access point. This works well for hosts on the&nbsp;<i>0000001a</i>&nbsp;network, but means that<br>users on the&nbsp;<i>0000002c</i>&nbsp;network will route via the network to reach that port, despite the server having a port<br>directly on that network if they've discovered this server from the SAP broadcasts.<br>
<b>Figure 15−1. IPX internal network</b><br>
Allowing such hosts to have a virtual network with virtual host addresses that are entirely a software<br>construct solves this problem. This virtual network is best thought of as being&nbsp;<i>inside</i>&nbsp;the IPX host. The SAP<br>information then needs only to be propagated for this virtual network/node address combination. This virtual<br>network is known as an&nbsp;<i>internal network</i>. But how do other hosts know how to reach this internal network?<br>Remote hosts route to the internal network via the directly connected networks of the host. This means that<br>you see routing entries that refer to the internal network of hosts supporting multiple IPX interfaces. Those<br>routes should choose the optimal route available at the time, and should one fail, the routing is automatically<br><a href="TLNAGs.html#308">updated to the next best interface and route. In&nbsp;Figure 15−1</a>, we've configured an internal IPX network of<br>address&nbsp;<i>0x10000010</i>&nbsp;and used a host address of&nbsp;<i>00:00:00:00:00:01</i>. It is this address that will be our primary<br>interface and will be advertised via SAP. Our routing will reflect this network as being reachable via&nbsp;<i>either</i>&nbsp;of<br>our real network ports, so hosts will always use the best network route to connect to our server.<br>
To create this internal network, use the&nbsp;<b>ipx_internal_net</b>&nbsp;command included in Greg Page's IPX tools<br>package. Again, a simple example demonstrates its use:<br>
#&nbsp;<b>ipx_internal_net add 10000010 000000000001</b><br>
This command would create an IPX internal network with address&nbsp;<i>10000010</i>&nbsp;and a node address of<br><i>000000000001</i>. The network address, just like any other IPX network address, must be unique on your<br>network. The node address is completely arbitrary, as there will normally be only one node on the network.<br>Each host may have only one IPX Internal Network, and if configured, the Internal Network will always be<br>the primary network.<br>
15.5.1. Static IPX Routing Using the ipx_route Command<br>
292<br>
<hr>
<A name=309></a>Linux Network Administrators Guide<br>
To delete an IPX Internal Network, use:<br>
#&nbsp;<b>ipx_internal_net del</b><br>
An internal IPX network is of absolutely no use to you unless your host both provides a service and has more<br>than one IPX interface active.<br>
15.5.1. Static IPX Routing Using the ipx_route Command<br>
293<br>
<hr>
<A name=310></a><b>15.6. Mounting a Remote NetWare Volume</b><br>
IPX is commonly used to mount NetWare volumes in the Linux filesystem. This allows file−based data<br>sharing between other operating systems and Linux. Volker Lendecke developed the NCP client for Linux<br>and a suite of associated tools that make data sharing possible.<br>
In an NFS environment, we'd use the Linux&nbsp;<b>mount</b>&nbsp;command to mount the remote filesystem. Unfortunately,<br>the NCP filesystem has unique requirements that make it impractical to build it into the normal&nbsp;<b>mount</b>. Linux<br>has an&nbsp;<b>ncpmount</b>&nbsp;command that we will use instead. The&nbsp;<b>ncpmount</b>&nbsp;command is one of the tools in Volker's<br>ncpfs&nbsp;package, which is available prepackaged in most modern distributions or in source form from<br>ftp.gwdg.de in the&nbsp;/pub/linux/misc/ncpfs/&nbsp;directory. The version current at the time of writing is<br>2.2.0.<br>
Before you can mount remote NetWare volumes, you must ensure your IPX network interface is configured<br>correctly (as described earlier). Next, you must know your login details on the NetWare server you wish to<br>mount; this includes the user ID and password. Lastly, you need to know which volume you wish to mount<br>and what local directory you wish to mount it under.<br>
<b>15.6.1. A Simple ncpmount Example</b><br>
A simple example of&nbsp;<b>ncpmount</b>&nbsp;usage looks like this:<br>
#&nbsp;<b>ncpmount −S ALES_F1 −U rick −P d00−b−gud /mnt/brewery</b><br>
This command mounts all volumes of the&nbsp;ALES_F1&nbsp;fileserver under the&nbsp;/mnt/brewery&nbsp;directory, using<br>the NetWare login&nbsp;rick&nbsp;with the password&nbsp;d00−b−gud.<br>
The&nbsp;<b>ncpmount</b>&nbsp;command is normally setuid to root and may therefore be used by any Linux user. By default,<br>that user owns the connection and only he or the root user will be able to unmount it.<br>
NetWare embodies the notion of a&nbsp;<i>volume</i>, which is analogous to a filesystem in Linux. A NetWare volume<br>is the logical representation of a NetWare filesystem, which might be a single disk partition be spread across<br>many partitions. By default, the Linux NCPFS support treats volumes as subdirectories of a larger logical<br>filesystem represented by the whole fileserver. The&nbsp;<b>ncpmount</b>&nbsp;command causes each of the NetWare<br>volumes of the mounted fileserver to appear as a subdirectory under the mount point. This is convenient if<br>you want access to the whole server, but for complex technical reasons you will be unable to re−export these<br>directories using NFS, should you wish to do so. We'll discuss a more complex alternative that works around<br>this problem in a moment.<br>
<b>15.6.2. The ncpmount Command in Detail</b><br>
The&nbsp;<b>ncpmount</b>&nbsp;has a large number of command line options that allow you quite a lot of flexibility in how<br><a href="TLNAGs.html#310">you manage your NCP mounts. The most important of these are described in&nbsp;Table 15−2.</a><br>
<b>Table 15−2. ncpmount Command Arguments</b><br>
15.6. Mounting a Remote NetWare Volume<br>
294<br>
<hr>
<A name=311></a>Linux Network Administrators Guide<br>
<b>Argument</b><br>
<b>Description</b><br>
−S&nbsp;<i>server</i><br>
The name of the fileserver to mount.<br>
−U<br>
The NetWare user ID to use when logging in to the fileserver.<br>
<i>user_name</i><br>
−P&nbsp;<i>password&nbsp;</i>The password to use for the NetWare login.<br>
−n<br>
This option must be used for NetWare logins that don't have a password associated with<br>them.<br>
−C<br>
This argument disables automatic conversion of passwords to uppercase.<br>
−c<br><i>client_name&nbsp;</i>This option allows you to specify who owns the connection to the fileserver. This is useful<br>
for NetWare printing, which we will discuss in more detail later.<br>
−u&nbsp;<i>uid</i><br>
The Linux user ID that should be shown as the owner of files in the mounted directory. If<br>this is not specified, it defaults to the user ID of the user who invokes the<br><b>ncpmount</b>&nbsp;command.<br>
−g&nbsp;<i>gid</i><br>
The Linux group ID that should be shown as the owner of files in the mounted directory. If<br>this is not specified, it will default to the group ID of the user who invokes the<br><b>ncpmount</b>&nbsp;command.<br>
−f&nbsp;<i>file_mode</i><br>
This option allows you to specify the file mode (permissions) that files in the mounted<br>directory should have. The value should be specified in octal, e.g.,&nbsp;0664. The permissions<br>that you will actually have are the file mode permissions specified with this option masked<br>with the permissions that your NetWare login ID has for the files on the fileserver. You<br>must have rights on the server and rights specified by this option in order to access a file.<br>The default value is derived from the current&nbsp;umask.<br>
−d&nbsp;<i>dir_mode</i><br>
This option allows you to specify the directory permissions in the mounted directory. It<br>behaves in the same way as the&nbsp;<i>−f</i>&nbsp;option, except that the default permissions are derived<br>from the current&nbsp;umask. Execute permissions are granted where read access is granted.<br>
−V&nbsp;<i>volume</i><br>
This option allows you to specify the name of a single NetWare volume to mount under<br>the mount point, rather than mounting all volumes of the target server. This option is<br>necessary if you wish to re−export a mounted NetWare volume using NFS.<br>
−t&nbsp;<i>time_out</i><br>
This option allows you to specify the time that the NCPFS client will wait for a response<br>from a server. The default value is 60mS and the timeout is specified in hundredths of a<br>second. If you experience any stability problems with NCP mounts, you should try<br>increasing this value.<br>
15.6. Mounting a Remote NetWare Volume<br>
295<br>
<hr>
<A name=312></a>Linux Network Administrators Guide<br>
−r<br>
The NCP client code attempts to resend datagrams to the server a number of times before<br>
<i>retry_count&nbsp;</i>deciding the connection is dead. This option allows you to change the retry count from the<br>
default of 5.<br>
<b>15.6.3. Hiding Your NetWare Login Password</b><br>
It is somewhat of a security risk to be putting a password on the command line, as we did with the<br><b>ncpmount</b>&nbsp;command. Other active, concurrent users could see the password if they happen to be running a<br>program like&nbsp;<b>top</b>&nbsp;or&nbsp;<b>ps</b>. To reduce the risk of others seeing and stealing NetWare login passwords,<br><b>ncpmount</b>&nbsp;is able to read certain details from a file in a user's home directory. In this file, the user keeps the<br>login name and password associated with each of the fileservers he or she intends to mount. The file is called<br>~/.nwclient&nbsp;and it must have permissions of&nbsp;0600&nbsp;to ensure that others cannot read it. If the permissions<br>are not correct, the&nbsp;<b>ncpmount</b>&nbsp;command will refuse to use it.<br>
The file has a very simple syntax. Any lines beginning with a # character are treated as comments and<br>ignored. The remainder of the lines have the syntax:<br>
<i>fileserver</i>/<i>userid&nbsp;password</i><br>
The&nbsp;<i>fileserver</i>&nbsp;is the name of the fileserver supporting the volumes you wish to mount. The&nbsp;<i>userid</i>&nbsp;is<br>the login name of your account on that server. The&nbsp;<i>password</i>&nbsp;field is optional. If it is not supplied, the<br><b>ncpmount</b>&nbsp;command prompts users for the password when they attempt the mount. If the&nbsp;<i>password</i>&nbsp;field is<br>specified as the − character, no password is used; this is equivalent to the&nbsp;−n&nbsp;command−line argument.<br>
You can supply any number of entries, but the fileserver field must be unique. The first fileserver entry has<br>special significance. The&nbsp;<b>ncpmount</b>&nbsp;command uses the&nbsp;−S&nbsp;command−line argument to determine which of<br>the entries in&nbsp;~/.nwclient&nbsp;to use. If no server is specified using the&nbsp;−S&nbsp;argument, the first server entry in<br>~/.nwclient&nbsp;is assumed, and is treated as your preferred server. You should place the fileserver you<br>mount most frequently in the first position in the file.<br>
<b>15.6.4. A More Complex ncpmount Example</b><br>
&nbsp;Let's look at a more complex&nbsp;<b>ncpmount</b>&nbsp;example involving a number of the features we've described. First,<br>let's build a simple&nbsp;~/.nwclient&nbsp;file:<br>
# NetWare login details for the Virtual Brewery and Winery<br>
#<br>
# Brewery Login<br>
ALES_F1/MATT staoic1<br>
#<br>
# Winery Login<br>
REDS01/MATT staoic1<br>
#<br>
Make sure its permissions are correct:<br>
$&nbsp;<b>chmod 600 ~/.nwclient</b><br>
15.6.3. Hiding Your NetWare Login Password<br>
296<br>
<hr>
<A name=313></a>Linux Network Administrators Guide<br>
Let's mount one volume of the Winery's server under a subdirectory of a shared directory, specifying the file<br>and directory permissions such that others may share the data from there:<br>
$ ncpmount −S REDS01 −V RESEARCH −f 0664 −d 0775 /usr/share/winery/data/<br>
This command, in combination with the&nbsp;~/.nwclient&nbsp;file shown, would mount the&nbsp;RESEARCH&nbsp;volume of<br>the&nbsp;REDS01&nbsp;server onto the&nbsp;/usr/share/winery/data/&nbsp;directory using the NetWare login ID of<br>MATT&nbsp;and the password retrieved from the&nbsp;~/.nwclient&nbsp;file. The permissions of the mounted files are<br>0664&nbsp;and the directory permissions are&nbsp;0775.<br>
15.6.3. Hiding Your NetWare Login Password<br>
297<br>
<hr>
<A name=314></a><b>15.7. Exploring Some of the Other IPX Tools</b><br>
The&nbsp;ncpfs&nbsp;package contains a number of useful tools that we haven't described yet. Many of these tools<br>emulate the tools that are supplied with NetWare. We'll look at the most useful ones in this section.<br>
<b>15.7.1. Server List</b><br>
&nbsp;The&nbsp;<b>slist</b>&nbsp;command lists all of the fileservers accessible to the host. The information is actually retrieved<br>from the nearest IPX router. This command was probably originally intended to allow users to see what<br>fileservers were available to mount. But it has become useful as a network diagnosis tool, allowing network<br>admins to see where SAP information is being propagated:<br>
$ slist<br>
NPPWR−31−CD01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23A91330 &nbsp;000000000001<br>
V242X−14−F02 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;A3062DB0 &nbsp;000000000001<br>
QITG_284ELI05_F4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;78A20430 &nbsp;000000000001<br>
QRWMA−04−F16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;B2030D6A &nbsp;000000000001<br>
VWPDE−02−F08 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;35540430 &nbsp;000000000001<br>
NMCS_33PARK08_F2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;248B0530 &nbsp;000000000001<br>
NCCRD−00−CD01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 21790430 &nbsp;000000000001<br>
NWGNG−F07 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 53171D02 &nbsp;000000000001<br>
QCON_7TOMLI04_F7 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;72760630 &nbsp;000000000001<br>
W639W−F04 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; D1014D0E &nbsp;000000000001<br>
QCON_481GYM0G_F1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;77690130 &nbsp;000000000001<br>
VITG_SOE−MAIL_F4R &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 33200C30 &nbsp;000000000001<br>
<b>slist</b>&nbsp;accepts no arguments. The output displays the fileserver name, the IPX network address, and the host<br>address.<br>
<b>15.7.2. Send Messages to NetWare Users</b><br>
&nbsp;NetWare supports a mechanism to send messages to logged−in users. The&nbsp;<b>nsend</b>&nbsp;command implements this<br>feature in Linux. You must be logged in to the server to send messages, so you need to supply the fileserver<br>name and login details on the command line with the destination user and the message to send:<br>
#&nbsp;<b>nsend −S vbrew_f1 −U gary −P j0yj0y supervisor</b><br>
<b>&nbsp; &nbsp; &nbsp; Join me for a lager before we do the print queues!</b><br>
Here a user with login name&nbsp;gary&nbsp;sends a tempting invitation to the person using the&nbsp;supervisor&nbsp;account<br>on the&nbsp;ALES_F1&nbsp;fileserver. Our default fileserver and login credentials will be used if we don't supply them.<br>
<b>15.7.3. Browsing and Manipulating Bindery Data</b><br>
Each NetWare fileserver maintains a database of information about its users and configuration. This<br>database is called the&nbsp;<i>bindery</i>. Linux supports a set of tools that allow you to read it, and if you have<br><a href="TLNAGs.html#314">supervisor permissions on the server, to set and remove it. A summary of these tools is listed in&nbsp;Table 15−3.</a><br>
15.7. Exploring Some of the Other IPX Tools<br>
298<br>
<hr>
<A name=315></a>Linux Network Administrators Guide<br>
<b>Table 15−3. Linux Bindery Manipulation Tools</b><br>
<b>Command Name&nbsp;Command Description</b><br>
<b>nwfstime</b><br>
Display or set a NetWare server's date and time<br>
<b>nwuserlist</b><br>
List users logged in at a NetWare server<br>
<b>nwvolinfo</b><br>
Display info about NetWare volumes<br>
<b>nwbocreate</b><br>
Create a NetWare bindery object<br>
<b>nwbols</b><br>
List NetWare bindery objects<br>
<b>nwboprops</b><br>
List properties of a NetWare bindery object<br>
<b>nwborm</b><br>
Remove a NetWare bindery object<br>
<b>nwbpcreate</b><br>
Create a NetWare bindery property<br>
<b>nwbpvalues</b><br>
Print a NetWare bindery property's contents<br>
<b>nwbpadd</b><br>
Set the value of a NetWare bindery property<br>
<b>nwbprm</b><br>
Remove a NetWare bindery property<br>
15.7. Exploring Some of the Other IPX Tools<br>
299<br>
<hr>
<A name=316></a><b>15.8. Printing to a NetWare Print Queue</b><br>
The&nbsp;ncpfs&nbsp;package contains a small utility called&nbsp;<b>nprint</b>&nbsp;that sends print jobs across an NCP connection to<br>a NetWare print queue. This command creates the connection if it doesn't currently exist and uses the<br>~/.nwclient&nbsp;file that we described earlier to hide the username and password from prying eyes. The<br>command−line arguments used to manage the login process are the same as those used by the&nbsp;<b>ncpmount</b>, so<br>we won't go through those again here. We will cover the most important command−line options in our<br>examples; refer to the&nbsp;nprint(1)&nbsp;manual page for details.<br>
The only required option for&nbsp;<b>nprint</b>&nbsp;is the name of the file to print. If the filename specified is − or if no<br>filename is specified at all,&nbsp;<b>nprint</b>&nbsp;will accept the print job from&nbsp;stdin. The most important&nbsp;<b>nprint</b>&nbsp;options<br>specify the fileserver and print queue to which you wish the job to be sent.&nbsp;<a href="TLNAGs.html#316">Table 15−4</a>&nbsp;lists the most<br>important options.<br>
<b>Table 15−4. nprint Command−Line Options</b><br>
<b>Option</b><br>
<b>Description</b><br>
−S&nbsp;<i>server_name</i><br>
The name of the NetWare fileserver supporting the print queue to which you wish to<br>print. Usually it is convenient for the server to have an entry in&nbsp;~/.nwclient.<br>This option is mandatory.<br>
−q&nbsp;<i>queue_name</i><br>
The print queue to which to send the print job. This option is mandatory.<br>
−d<br><i>job_description&nbsp;</i>Text that will appear in the print console utility when displaying the list of queued<br>
jobs.<br>
−l&nbsp;<i>lines</i><br>
The number of lines per printed page. This defaults to 66.<br>
−r&nbsp;<i>columns</i><br>
The number of columns per printed page. This defaults to 80.<br>
−c&nbsp;<i>copies</i><br>
The number of copies of the job that will be printed. The default is 1.<br>
A simple example using&nbsp;<b>nprint</b>&nbsp;would look like:<br>
$ nprint −S REDS01 −q PSLASER −c 2 /home/matt/ethylene.ps<br>
This command would print two copies of the file&nbsp;/home/matt/ethylene.ps&nbsp;to the printer named<br>PSLASER&nbsp;on the&nbsp;REDS01&nbsp;fileserver using a username and password obtained from the&nbsp;~/.nwclient&nbsp;file.<br>
<b>15.8.1. Using nprint with the Line Printer Daemon</b><br>
&nbsp;You will recall we previously mentioned that the&nbsp;−c&nbsp;option for the&nbsp;<b>ncpmount</b>&nbsp;is useful for printing. At last<br>we'll explain why and how.<br>
15.8. Printing to a NetWare Print Queue<br>
300<br>
<hr>
<A name=317></a>Linux Network Administrators Guide<br>
Linux usually uses BSD−style line printer software. The line printer daemon (<b>lpd</b>) is a daemon that checks a<br>local spool directory for queued jobs that are to be printed.&nbsp;<b>lpd</b>&nbsp;reads the printer name and some other<br>parameters from the specially formatted spool file and writes the data to the printer, optionally passing the<br>data through a filter to transform or manipulate it in some way.<br>
The&nbsp;<b>lpd</b>&nbsp;daemon uses a simple database called&nbsp;/etc/printcap&nbsp;to store printer configuration information,<br>including what filters are to be run.&nbsp;<b>lpd</b>&nbsp;usually runs with the permissions of a special system user called lp.<br>
You could configure&nbsp;<b>nprint</b>&nbsp;as a filter for the&nbsp;<b>lpd</b>&nbsp;to use, which allows users of your Linux machine to output<br>directly to remote printers hosted by a NetWare fileserver. To do this, the lp user must be able to write NCP<br>requests to the NCP connection to the server.<br>
An easy way to achieve this without requiring the lp user to establish its own connection and login is to<br>specify lp as the owner of a connection established by another user. A complete example of how to set up the<br>Linux printing system to handle print jobs from clients over NetWare is listed in three steps:<br>
Write a wrapper script.<br>
1.&nbsp;<br>
The&nbsp;/etc/printcap&nbsp;file doesn't permit options to be supplied to filters. Therefore, you need to<br>write a short script that invokes the command you want along with its options. The wrapper script<br>could be as simple as:<br>
#!/bin/sh<br>
# p2pslaser − simple script to redirect stdin to the<br>
# PSLASER queue on the REDS01 server<br>
#<br>
/usr/bin/nprint −S REDS01 −U stuart −q PSLASER<br>
#<br>
Store the script in the file&nbsp;/usr/local/bin/p2pslaser.<br>
Write the&nbsp;<br>
2.&nbsp;<br>
/etc/printcap&nbsp;entry.<br>
We'll need to configure the&nbsp;p2pslaser&nbsp;script we created as the output filter in the<br>/etc/printcap. This would look something like:<br>
pslaser|Postscript Laser Printer hosted by NetWare server:\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
:lp=/dev/null:\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
:sd=/var/spool/lpd/pslaser:\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>
:if=/usr/local/bin/p2pslaser:\<br>
:af=/var/log/lp−acct:\<br>
:lf=/var/log/lp−errs:\<br>
:pl#66:\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>
:pw#80:\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>
:pc#150:\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
:mx#0:\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
:sh: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>
Add the&nbsp;<br>
3.&nbsp;<br>
−c&nbsp;option to the&nbsp;<b>ncpmount</b>.<br>
ncpmount −S REDS01 .... −c lp ....<br>
Our local user stuart must specify the lp user as the owner of the connection when he mounts the<br>remote NetWare server.<br>
15.8. Printing to a NetWare Print Queue<br>
301<br>
<hr>
<A name=318></a>Linux Network Administrators Guide<br>
Now any Linux user may choose to specify&nbsp;pslaser&nbsp;as the printer name when invoking&nbsp;<i>lp</i>. The print job<br>will be sent to the specified NetWare server and spooled for printing.<br>
<b>15.8.2. Managing Print Queues</b><br>
&nbsp;The&nbsp;<b>pqlist</b>&nbsp;command lists all of the print queues available to you on the specified server. If you do not<br>specify a fileserver on the command line using the&nbsp;−S&nbsp;option, or a login name and password, these will be<br>taken from the default entry in your&nbsp;~/.nwclient&nbsp;file:<br>
#&nbsp;<b>pqlist −S vbrew_f1 −U guest −n</b><br>
Server: ALES_F1<br>
Print queue name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Queue ID &nbsp;<br>
−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−<br>
TEST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AA02009E<br>
Q2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EF0200D9<br>
NPI223761_P1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DA03007C<br>
Q1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;F1060004<br>
I−DATA &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0D0A003B<br>
NPI223761_P3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;D80A0031<br>
Our example shows a list of the print queues available to the&nbsp;guest&nbsp;user on the&nbsp;ALES_F1&nbsp;fileserver.[88]<br>
To view the print jobs on a print queue, use the&nbsp;<b>pqstat</b>&nbsp;command. It takes the print queue name as an<br>argument and lists all of the jobs in that queue. You may optionally supply another argument indicating how<br>many of the jobs in the queue you'd like to list. The following sample output has been compressed a bit to fit<br>the width of this book's page:<br>
$ pqstat −S ALES_F1 NPI223761_P1<br>
Server: ALES_F1 &nbsp; &nbsp; Queue: NPI223761_P1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Queue ID: 6A0E000C<br>
&nbsp; &nbsp;Seq &nbsp;Name &nbsp; &nbsp; &nbsp;Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Status &nbsp; Form &nbsp;Job ID &nbsp;<br>
−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−<br>
&nbsp; &nbsp; &nbsp;1 &nbsp;TOTRAN &nbsp; &nbsp;LyX document − proposal.lyx &nbsp; &nbsp;Active &nbsp; &nbsp; &nbsp;0 &nbsp;02660001<br>
We can see just one print job in the queue, owned by user&nbsp;TOTRAN. The rest of the options include a<br>description of the job, its status, and its job identifier.<br>
The&nbsp;<b>pqrm</b>&nbsp;command is used to remove print jobs from a specified print queue. To remove the job in the<br>queue we've just obtained the status of, we'd use:<br>
$ pqrm −S ALES_F1 NPI223761_P1 02660001<br>
The command is pretty straightforward but is clumsy to use in a hurry. It would be a worthwhile project to<br>write a basic script to simplify this operation.<br>
15.8.2. Managing Print Queues<br>
302<br>
<hr>
<A name=319></a><b>15.9. NetWare Server Emulation</b><br>
&nbsp;There are two free software emulators for NetWare fileservers under Linux.&nbsp;<b>lwared</b>&nbsp;was developed by Ales<br>Dryak and&nbsp;<b>mars_nwe</b>&nbsp;was developed by Martin Stover. Both of these packages provide elementary NetWare<br>fileserver emulation under Linux, allowing NetWare clients to mount Linux directories exported as NetWare<br>volumes. While the&nbsp;<b>lwared</b>&nbsp;server is simpler to configure, the&nbsp;<b>mars_nwe</b>&nbsp;server is more fully featured. The<br>installation and configuration of these packages is beyond the scope of this chapter, but both are described in<br>the IPX−HOWTO.<br>
15.9. NetWare Server Emulation<br>
303<br>
<hr>
<A name=320></a><b>Chapter 16. ManagingTaylor UUCP</b><br>
UUCP was designed in the late seventies by Mike Lesk at AT&amp;T Bell Laboratories to provide a simple<br>dialup network over public telephone lines. Despite the popularity of dialup PPP and SLIP connections to the<br>Internet, many people who want to have email and Usenet News on their home machine still use UUCP<br>because it is often cheaper, especially in countries where Internet users have to pay by the minute for local<br>telephone calls, or where they do not have a local ISP and must pay long distance toll rates to connect.<br>Although there are many implementations of UUCP running on a wide variety of hardware platforms and<br>operating systems, overall, they are highly compatible.<br>
However, as with most software that has somehow become standard over the years, there is no UUCP that<br>one would call&nbsp;<i>the</i>&nbsp;UUCP. It has undergone a steady evolution since the first version was implemented in<br>1976. Currently, there are two major species that differ mainly in their hardware support and configuration.<br>Of these two, various implementations exist, each varying slightly from its siblings.<br>
One species is known as Version 2 UUCP, which dates back to a 1977 implementation by Mike Lesk, David<br>A. Novitz, and Greg Chesson. Although it is fairly old, it is still frequently used. Recent implementations of<br>Version 2 provide much of the comfort that the newer UUCP species do.<br>
The second species was developed in 1983 and is commonly referred to as BNU (Basic Networking Utilities)<br>or HoneyDanBer UUCP. The latter name is derived from the authors' names (P. Honeyman, D. A. Novitz,<br>and B. E. Redman) and is often shortened further to HDB, which is the term we'll use in this chapter. HDB<br>was conceived to eliminate some of Version 2 UUCP's deficiencies. For example, new transfer protocols<br>were added, and the spool directory was split so that now there is one directory for each site with which you<br>have UUCP traffic.<br>
The implementation of UUCP currently distributed with Linux is Taylor UUCP 1.06, which is the version<br>this chapter is based upon.[89]&nbsp;Taylor UUCP Version 1.06 was released in August 1995. Apart from<br>traditional configuration files, Taylor UUCP can also be compiled to understand the newstylea.k.a.<br>Taylorconfiguration files.<br>
Taylor UUCP is usually compiled for HDB compatibility, the Taylor configuration scheme, or both. Because<br>the Taylor scheme is much more flexible and probably easier to understand than the often obscure HDB<br>configuration files, we will describe the Taylor scheme below.<br>
This chapter is not designed to exhaustively describe the command−line options for the UUCP commands<br>and what they do, but to give you an introduction to how to set up a working UUCP node. The first section<br>gives a gentle introduction about how UUCP implements remote execution and file transfers. If you are not<br><a href="TLNAGs.html#325">entirely new to UUCP, you might want to skip to the section&nbsp;Section 16.2</a>&nbsp;later in this chapter, which<br>explains the various files used to set up UUCP.<br>
We will, however, assume that you are familiar with the user programs of the UUCP suite,&nbsp;<b>uucp</b>&nbsp;and&nbsp;<b>uux</b>.<br>For a description, refer to the online manual pages.<br>
Besides the publicly accessible programs&nbsp;<b>uucp</b>&nbsp;and&nbsp;<b>uux</b>, the UUCP suite contains a number of commands<br>used for administrative purposes only. They are used to monitor UUCP traffic across your node, remove old<br>log files, or compile statistics. None of these will be described here because they are peripheral to the main<br>tasks of UUCP. Besides, they're well documented and fairly easy to understand; refer to the manual pages for<br>more information. However, there is a third category, which comprise the actual UUCP work horses. They<br>are called&nbsp;<b>uucico</b>&nbsp;(where&nbsp;<i>cico</i>&nbsp;stands for copy−in copy−out), and&nbsp;<b>uuxqt</b>, which executes jobs sent from<br>
Chapter 16. ManagingTaylor UUCP<br>
304<br>
<hr>
<A name=321></a>Linux Network Administrators Guide<br>
remote systems. We concentrate on these two important programs in this chapter.<br>
If you're not satisfied with our coverage of these topics, you should read the documentation that comes with<br>the UUCP package. This is a set of Texinfo files that describe the setup using the Taylor configuration<br>scheme. You can convert the Texinfo files into a&nbsp;<b>dvi</b>&nbsp;file using the&nbsp;<b>texi2dvi</b>&nbsp;(found in the Texinfo package in<br>your distribution) and view the&nbsp;<b>dvi</b>&nbsp;file using the&nbsp;<b>xdvi</b>&nbsp;command.<br>
Guylhem Aznar's UUCP−HOWTO is another good source for information about UUCP in a Linux<br>environment. It is available at any Linux Documentation Project mirror and is posted regularly to<br>comp.os.linux.answers.<br>
There's also a newsgroup for the discussion of UUCP called comp.mail.uucp. If you have questions specific<br>to Taylor UUCP, you may be better off asking them there, rather than on the comp.os.linux.* groups.<br>
Chapter 16. ManagingTaylor UUCP<br>
305<br>
<hr>
<A name=322></a><b>16.1. UUCP Transfers and Remote Execution</b><br>
The concept of jobs is vital to understanding UUCP. Every transfer that a user initiates with&nbsp;<b>uucp</b>&nbsp;or&nbsp;<b>uux</b>&nbsp;is<br>called a&nbsp;<b>job</b>. It is made up of a command to be executed on a remote system, a collection of files to be<br>transferred between sites, or both.<br>
As an example, the following command makes UUCP copy the file&nbsp;netguide.ps&nbsp;to a remote host named<br>pablo and execute the&nbsp;<b>lpr</b>&nbsp;command on pablo to print the file:<br>
$&nbsp;<b>uux −r pablo!lpr !netguide.ps</b><br>
UUCP does not generally call the remote system immediately to execute a job (or else you could make do<br>with&nbsp;<b>kermit</b>). Instead, it temporarily stores the job description away. This is called&nbsp;<i>spooling</i>. The directory<br>tree under which jobs are stored is therefore called the&nbsp;<i>spool directory</i>&nbsp;and is generally located in<br>/var/spool/uucp. In our example, the job description would contain information about the remote<br>command to be executed (<b>lpr</b>), the user who requested the execution, and a couple of other items. In addition<br>to the job description, UUCP has to store the input file&nbsp;netguide.ps.<br>
The exact location and naming of spool files may vary, depending on some compile−time options.<br>HDB−compatible UUCPs generally store spool files in a&nbsp;/var/spool/uucp&nbsp;subdirectory with the name<br>of the remote site. When compiled for Taylor configuration, UUCP creates subdirectories below the<br>site−specific spool directory for different types of spool files.<br>
At regular intervals, UUCP dials up the remote system. When a connection to the remote machine is<br>established, UUCP transfers the files describing the job, plus any input files. The incoming jobs will not be<br>executed immediately, but only after the connection terminates. Execution is handled by&nbsp;<b>uuxqt</b>, which also<br>takes care of forwarding any jobs that are designated for another site.<br>
&nbsp;To distinguish between more and less important jobs, UUCP associates a&nbsp;<i>grade</i>&nbsp;with each job. This is a<br>single digit ranging from 0 through 9, A through Z, and a through z, in decreasing precedence. Mail is<br>customarily spooled with grade B or C, while news is spooled with grade N. Jobs with higher grades are<br>transferred earlier. Grades may be assigned using the&nbsp;−g&nbsp;flag when invoking&nbsp;<b>uucp</b>&nbsp;or&nbsp;<b>uux</b>.<br>
You can also prohibit the transfer of jobs below a given grade at certain times. To do this we set the<br><i>maximum spool grade</i>&nbsp;that will be prohibited during a conversation. The maximum spool grade defaults to z,<br>meaning all grades will be transferred every time. Note the semantic ambiguity here: a file is transferred only<br>if it has a grade&nbsp;<i>equal to</i>&nbsp;or&nbsp;<i>above</i>&nbsp;the maximum spool grade threshold.<br>
<b>16.1.1. The Inner Workings of uucico</b><br>
&nbsp;To understand why&nbsp;<b>uucico</b>&nbsp;needs to know particular information, a quick description of how it actually<br>connects to a remote system is helpful.<br>
When you execute&nbsp;<b>uucico −s&nbsp;<i>system</i></b>&nbsp;from the command line,&nbsp;<b>uucico</b>&nbsp;first has to connect physically. The<br>actions taken depend on the type of connection to open. Thus, when using a telephone line, it has to find a<br>modem and dial out. Over TCP, it has to call&nbsp;gethostbyname&nbsp;to convert the name to a network address,<br>find out which port to open, and bind the address to the corresponding socket.<br>
16.1. UUCP Transfers and Remote Execution<br>
306<br>
<hr>
<A name=323></a>Linux Network Administrators Guide<br>
&nbsp;A successful connection is followed by authorization. This procedure generally consists of the remote<br>system asking for a login name and possibly a password. This exchange is commonly called the&nbsp;<i>login chat</i>.<br>The authorization procedure is performed either by the usual&nbsp;<b>getty/login</b>&nbsp;suite, or on TCP sockets by<br><b>uucico</b>&nbsp;itself. If authorization succeeds, the remote end fires up&nbsp;<b>uucico</b>. The local copy of&nbsp;<b>uucico</b>&nbsp;that<br>initiated the connection is referred to as&nbsp;<i>master</i>, and the remote copy as&nbsp;<i>slave</i>.<br>
&nbsp;Next follows the&nbsp;<i>handshake phase</i>: the master sends its hostname plus several flags. The slave checks this<br>hostname for permission to log in, send, and receive files, etc. The flags describe (among other things) the<br>maximum grade of spool files to transfer. If enabled, a conversation count or&nbsp;<i>call sequence number</i>&nbsp;check<br>takes place here. With this feature, both sites maintain a count of successful connections, which are<br>compared. If they do not match, the handshake fails. This is useful to protect yourself against impostors.<br>
Finally, the two&nbsp;<b>uucico</b>s try to agree on a common&nbsp;<i>transfer protocol</i>. This protocol governs the way data is<br>transferred, checked for consistency, and retransmitted in case of an error. There is a need for different<br>protocols because of the differing types of connections supported. For example, telephone lines require a<br>safe protocol, which is pessimistic about errors, while TCP transmission is inherently reliable and can use<br>a more efficient protocol that foregoes most extra error checking.<br>
After the handshake is complete, the actual transmission phase begins. Both ends turn on the selected<br>protocol driver. At this point, the drivers possibly perform a protocol−specific initialization sequence.<br>
The master then sends all files queued for the remote system whose spool grade is high enough. When it has<br>finished, it informs the slave that it is done and that the slave may now hang up. The slave now can either<br>agree to hang up or take over the conversation. This is a change of roles: now the remote system becomes<br>master, and the local one becomes slave. The new master now sends its files. When done, both&nbsp;<b>uucico</b>s<br>exchange termination messages and close the connection.<br>
If you need additional information on UUCP, please refer to the source code. There is also a really antique<br>article floating around the Net, written by David A. Novitz, which gives a detailed description of the UUCP<br>protocol.[90]&nbsp;The Taylor UUCP FAQ also discusses some details UUCP's implementation. It is posted to<br>comp.mail.uucp regularly.&nbsp;<br>
<b>16.1.2. uucico Command−line Options</b><br>
&nbsp;In this section, we describe the most important command−line options for&nbsp;<b>uucico</b>:<br>
<i>− − system, −s system</i><br>
Calls the named&nbsp;<i>system</i>&nbsp;unless prohibited by call−time restrictions.<br>
<i>−S system</i><br>
Calls the named&nbsp;<i>system</i>&nbsp;unconditionally.<br>
<i>− −master, −r1</i><br>
Starts&nbsp;<b>uucico</b>&nbsp;in master mode. This is the default when&nbsp;−s&nbsp;or&nbsp;−S&nbsp;is given. All by itself, the<br>−r1&nbsp;option causes&nbsp;<b>uucico</b>&nbsp;to try to call all systems in the&nbsp;sys&nbsp;file described in the next section of<br>this chapter, unless prohibited by call or retry time restrictions.<br>
16.1.2. uucico Command−line Options<br>
307<br>
<hr>
<A name=324></a>Linux Network Administrators Guide<br>
<i>− −slave, −r0</i><br>
Starts&nbsp;<b>uucico</b>&nbsp;in slave mode. This is the default when no&nbsp;−s&nbsp;or&nbsp;−S&nbsp;is given. In slave mode, either<br>standard input/output are assumed to be connected to a serial port, or the TCP port specified by the<br>−p&nbsp;option is used.<br>
<i>− −ifwork, −C</i><br>
This option supplements&nbsp;−s&nbsp;or&nbsp;−S&nbsp;and tells&nbsp;<b>uucico</b>&nbsp;to call the named system only if there are jobs<br>spooled for it.<br>
<i>− −debug type, −x type,&nbsp;−X type</i><br>
Turns on debugging of the specified type. Several types can be given as a comma−separated list. The<br>following types are valid: abnormal, chat, handshake, uucp−proto, proto, port, config, spooldir,<br>execute, incoming, and outgoing. Using all turns on all options. For compatibility with other UUCP<br>implementations, a number may be specified instead, which turns on debugging for the first&nbsp;<i>n</i>&nbsp;items<br>from the above list.<br>
Debugging messages will be logged to the&nbsp;Debug&nbsp;file below&nbsp;/var/spool/uucp.<br>
16.1.2. uucico Command−line Options<br>
308<br>
<hr>
<A name=325></a><b>16.2. UUCP Configuration Files</b><br>
&nbsp;In contrast to simpler file transfer programs, UUCP was designed to be able to handle all transfers<br>automatically. Once it is set up properly, interference by the administrator should not be necessary on a<br>day−to−day basis. The information required for automated transfer is kept in a couple of configuration files<br>that reside in the&nbsp;/usr/lib/uucp&nbsp;directory. Most of these files are used only when dialing out.<br>
<b>16.2.1. A Gentle Introduction to Taylor UUCP</b><br>
To say that UUCP configuration is difficult would be an understatement. It is really a hairy subject, and the<br>sometimes terse format of the configuration files doesn't make things easier (although the Taylor format is<br>almost easy reading compared to the older formats in HDB or Version 2).<br>
To give you a feel for how all the configuration files interact, we will introduce you to the most important<br>ones and have a look at sample entries from these files. We won't explain everything in detail now; a more<br>accurate account is given in separate sections that follow. If you want to set up your machine for UUCP, you<br>had best start with some sample files and adapt them gradually. You can pick either those shown below or<br>those included in your favorite Linux distribution.<br>
All files described in this section are kept in&nbsp;/etc/uucp&nbsp;or a subdirectory thereof. Some Linux<br>distributions contain UUCP binaries that have support for both HDB and Taylor configuration enabled, and<br>use different subdirectories for each configuration file set. There will usually be a&nbsp;README&nbsp;file in<br>/usr/lib/uucp.<br>
For UUCP to work properly, these files must be owned by the uucp user. Some of them contain passwords<br>and telephone numbers, and therefore should have permissions of 600. Note that although most UUCP<br>commands must be setuid to uucp, you must make sure the&nbsp;<b>uuchk</b>&nbsp;program is&nbsp;<i>not</i>. Otherwise, users will be<br>able to display system passwords even though the files have mode 600.<br>
The central UUCP configuration file is&nbsp;/etc/uucp/config, which is used to set general parameters. The<br>most important of them (and for now, the only one) is your host's UUCP name. At the Virtual Brewery, they<br>use vstout as their UUCP gateway:<br>
# /etc/uucp/config − UUCP main configuration file<br>
nodename &nbsp; &nbsp; &nbsp; &nbsp; vstout<br>
The&nbsp;sys&nbsp;file is the next important configuration file. It contains all the system−specific information of sites<br>to which you are linked. This includes the site's name and information on the link itself, such as the telephone<br>number when using a modem link. A typical entry for a modem−connected site called pablo would look like<br>this:<br>
# /usr/lib/uucp/sys − name UUCP neighbors<br>
# system: pablo<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pablo<br>
time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Any<br>
phone &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 555−22112<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;serial1<br>
speed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 38400<br>
chat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ogin: vstout ssword: lorca<br>
16.2. UUCP Configuration Files<br>
309<br>
<hr>
<A name=326></a>Linux Network Administrators Guide<br>
time specifies the times at which the remote system may be called. chat describes the login chat scriptsthe<br>sequence of strings that must be exchanged to allow&nbsp;<b>uucico</b>&nbsp;to log into pablo. We will get back to chat scripts<br>later. The port keyword simply names an entry in the&nbsp;port&nbsp;file. (Refer to&nbsp;<a href="TLNAGs.html#327">Figure 16−1.) You can assign<br></a>whatever name you like as long as it refers to a valid entry in&nbsp;port.<br>
The&nbsp;port&nbsp;file holds information specific to the link itself. For modem links, it describes the device special<br>file to be used, the range of speeds supported, and the type of dialing equipment connected to the port. The<br>following entry describes&nbsp;/dev/ttyS1&nbsp;(a.k.a. COM 2), to which the administrator has connected a<br>NakWell modem capable of running at speeds up to 38,400 bps. The port's name is chosen to match the port<br>name given in the&nbsp;sys&nbsp;file:<br>
# /etc/uucp/port − UUCP ports<br>
# /dev/ttyS1 (COM2)<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;serial1<br>
type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;modem<br>
device &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/dev/ttyS1<br>
speed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 38400<br>
dialer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nakwell<br>
The information pertaining to the dialers is kept in yet another file calledyou guessed itdial. For each<br>dialer type, it basically contains the sequence of commands that are issued to dial up a remote site, given the<br>telephone number. Again, this is specified as a chat script. For example, the entry for NakWell might look<br>like this:<br>
# /etc/uucp/dial − per−dialer information<br>
# NakWell modems<br>
dialer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nakwell<br>
chat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;&quot; AT&amp;F OK ATDT\T CONNECT<br>
The line starting with chat specifies the modem chat, which is the sequence of commands sent to and received<br>from the modem to initialize it and make it dial the desired number. The \T sequence will be replaced with<br>the phone number by&nbsp;<b>uucico</b>.<br>
To give you a rough idea how&nbsp;<b>uucico</b>&nbsp;deals with these configuration files, assume you issue the following<br>command:<br>
$&nbsp;<b>uucico −s pablo</b><br>
The first thing&nbsp;<b>uucico</b>&nbsp;does is look up pablo in the&nbsp;sys&nbsp;file. From the&nbsp;sys&nbsp;file entry for pablo, it sees that it<br>should use the serial1 port to establish the connection. The&nbsp;port&nbsp;file tells&nbsp;<b>uucico</b>&nbsp;that this is a modem port,<br>and that it has a NakWell modem attached.<br>
<b>uucico</b>&nbsp;now searches&nbsp;dial&nbsp;for the entry describing the NakWell modem, and having found one, opens the<br>serial port&nbsp;/dev/cua1&nbsp;and executes the dialer chat. That is, it sends&nbsp;<b>AT&amp;F</b>, waits for the&nbsp;<b>OK</b>&nbsp;response, etc.<br>When encountering the string \T, it substitutes the phone number (555−22112) extracted from the&nbsp;sys&nbsp;file.<br>
After the modem returns&nbsp;<b>CONNECT</b>, the connection has been established, and the modem chat is complete.<br><b>uucico</b>&nbsp;now returns to the&nbsp;sys&nbsp;file and executes the login chat. In our example, it would wait for the<br><b>login:</b>&nbsp;prompt, then send its username (<i>vstout</i>), wait for the&nbsp;<b>password:</b>&nbsp;prompt, and send its password (<b>lorca</b>).<br>
After completing authorization, the remote end is assumed to fire up its own&nbsp;<b>uucico</b>. The two then enter the<br>handshake phase described in the previous section.<br>
16.2. UUCP Configuration Files<br>
310<br>
<hr>
<A name=327></a><IMG src="TLNAG-327_1.png"><br>
Linux Network Administrators Guide<br>
<a href="TLNAGs.html#327">Figure 16−1</a>&nbsp;illustrates the dependencies among configuration files.<br>
<b>Figure 16−1. Interaction of Taylor UUCP configuration files</b><br>
<b>16.2.2. What UUCP Needs to Know</b><br>
Before you start writing the UUCP configuration files, you have to gather some information that UUCP<br>requires.<br>
First, you have to figure out what serial device your modem is attached to. Usually, the (DOS) ports COM1:<br>through COM4: map to the device special files&nbsp;/dev/ttyS0&nbsp;through&nbsp;/dev/ttyS3. Some distributions,<br>such as Slackware, create a link called&nbsp;/dev/modem&nbsp;to the appropriate&nbsp;ttyS*&nbsp;device file, and configure<br><b>kermit</b>,&nbsp;<b>seyon</b>, and any other communication programs to use this generic file. In this case, you should use<br>/dev/modem&nbsp;in your UUCP configuration, too.<br>
The reason for using a symbolic link is that all dial−out programs use so−called&nbsp;<i>lock files</i>&nbsp;to signal when a<br>serial port is in use. The names of these lock files are a concatenation of the string&nbsp;LCK..&nbsp;and the device<br>filename, for instance&nbsp;LCK..ttyS1. If programs use different names for the same device, they will fail to<br>recognize each other's lock files. As a consequence, they will disrupt each other's session when started at the<br>same time. This is quite possible when you schedule your UUCP calls using a&nbsp;crontab&nbsp;entry. For details on<br>serial port setup, please refer to&nbsp;<a href="TLNAGs.html#82">Chapter 4.</a><br>
Next, you must find out at what speed your modem and Linux will communicate. You have to set this speed<br>to the maximum effective transfer rate you expect to get. The effective transfer rate may be much higher than<br>the raw physical transfer rate your modem is capable of. For instance, many modems send and receive data at<br>56 kbps. Using compression protocols such as V.42bis, the actual transfer rate may climb over 100 kbps.<br>
Of course, if UUCP is to do anything at all, you need the phone number of a system to call. Also, you need a<br>valid login ID and possibly a password for the remote machine.[91]<br>
You also have to know&nbsp;<i>exactly</i>&nbsp;how to log into the system. Do you have to press the Enter key before the<br>login prompt appears? Does it display&nbsp;login:&nbsp;or&nbsp;user:? This is necessary for composing the&nbsp;<i>chat script</i>.<br>If you don't know, or if the usual chat script fails, try to call the system with a terminal program like<br><b>kermit</b>&nbsp;or&nbsp;<b>minicom</b>&nbsp;and record exactly what you have to do.<br>
16.2.2. What UUCP Needs to Know<br>
311<br>
<hr>
<A name=328></a>Linux Network Administrators Guide<br>
<b>16.2.3. Site Naming</b><br>
&nbsp;As with TCP/IP−based networking, your host has to have a name for UUCP networking. As long as you<br>simply want to use UUCP for file transfers to or from sites you dial up directly, or on a local network, this<br>name does not have to meet any standards.[92]<br>
However, if you use UUCP for a mail or news link, you should think about having the name registered with<br>the UUCP Mapping Project.[93]<a href="TLNAGs.html#349">&nbsp;The UUCP Mapping Project is described in&nbsp;Chapter 17. Even if you<br></a>participate in a domain, you might consider having an official UUCP name for your site.<br>
Frequently, people choose their UUCP name to match the first component of their fully qualified domain<br>name. Suppose your site's domain address is swim.twobirds.com; then your UUCP hostname would be swim.<br>Think of UUCP sites as knowing each other on a first−name basis. Of course, you can also use a UUCP name<br>completely unrelated to your fully qualified domain name.<br>
However, make sure not to use the unqualified site name in mail addresses unless you have registered it as<br>your official UUCP name. At the very best, mail to an unregistered UUCP host will vanish in some big black<br>bit bucket. If you use a name already held by some other site, this mail will be routed to that site and cause its<br>postmaster a lot of headaches.<br>
By default, the UUCP suite uses the name set by&nbsp;<b>hostname</b>&nbsp;as the site's UUCP name. This name is<br>commonly set by a command on the boot time&nbsp;rc&nbsp;scripts, and is usually stored in the&nbsp;/etc/hostname. If<br>your UUCP name is different from what you set your hostname to, you have to use the&nbsp;<b>hostname</b>&nbsp;option in<br>the&nbsp;config&nbsp;file to tell&nbsp;<b>uucico</b>&nbsp;about your UUCP name. This is described next.<br>
<b>16.2.4. Taylor Configuration Files</b><br>
We now return to the configuration files. Taylor UUCP gets its information from the following files:<br>
<i>config</i><br>
This is the main configuration file. You can define your site's UUCP name here.<br>
<i>sys</i><br>
This file describes all known sites. For each site, it specifies its name, what times to call it, which<br>number to dial (if any), what type of device to use, and how to log on.<br>
<i>port</i><br>
This file contains entries describing each available port, together with the line speed supported and<br>the dialer to be used.<br>
<i>dial</i><br>
This file describes dialers used to establish a telephone connection.<br>
16.2.3. Site Naming<br>
312<br>
<hr>
<A name=329></a>Linux Network Administrators Guide<br>
<i>dialcode</i><br>
This file contains expansions for symbolic dial codes.<br>
<i>call</i><br>
This file contains the login name and password to be used when calling a system. Rarely used.<br>
<i>passwd</i><br>
This file contains login names and passwords that systems may use when logging in. It is used only<br>when&nbsp;<b>uucico</b>&nbsp;does its own password checking.<br>
Taylor configuration files are generally made up of lines containing keyword−value pairs. A hash sign<br>introduces a comment that extends to the end of the line. To use a hash sign to mean itself, escape it with a<br>backslash like this:&nbsp;\#.<br>
There are quite a number of options you can tune with these configuration files. We can't go into all the<br>parameters, but we will cover the most important ones here. Then you should be able to configure a<br>modem−based UUCP link. Additional sections describe the modifications necessary if you want to use<br>UUCP over TCP/IP or over a direct serial line. A complete reference is given in the Texinfo documents that<br>accompany the Taylor UUCP sources.<br>
&nbsp;When you think you have configured your UUCP system completely, you can check your configuration<br>using the&nbsp;<b>uuchk</b>&nbsp;tool (located in&nbsp;/usr/lib/uucp).&nbsp;<b>uuchk</b>&nbsp;reads your configuration files and prints out a<br>detailed report of the configuration values used for each system.<br>
<b>16.2.5. General Configuration Options Using the config File</b><br>
&nbsp;You won't generally use this file to describe much beside your UUCP hostname. By default, UUCP will<br>use the name you set with the&nbsp;<b>hostname</b>&nbsp;command, but it is generally a good idea to set the UUCP name<br>explicitly. Here's a sample&nbsp;config&nbsp;file:<br>
# /usr/lib/uucp/config − UUCP main configuration file<br>
hostname &nbsp; &nbsp; &nbsp; &nbsp;vstout<br>
A number of miscellaneous parameters can be set here too, such as the name of the spool directory or access<br>rights for anonymous UUCP. The latter will be described later in this chapter in the section Anonymous<br>UUCP.<br>
<b>16.2.6. How to Tell UUCP About Other Systems Using the<br>sys File</b><br>
&nbsp;The&nbsp;sys&nbsp;file describes the systems that your machine knows about. An entry is introduced by the<br>system keyword; the subsequent lines up to the next system directive detail the parameters specific to that<br>site. Commonly, a system entry defines parameters such as the telephone number and login chat.<br>
16.2.5. General Configuration Options Using the config File<br>
313<br>
<hr>
<A name=330></a>Linux Network Administrators Guide<br>
Parameters before the very first system line set default values used for all systems. Usually, you set protocol<br>parameters and the like in the defaults section.<br>
The most prominent fields are discussed in detail in the following sections.<br>
<b>16.2.6.1. System name</b><br>
The&nbsp;<i>system</i>&nbsp;command names the remote system. You must specify the correct name of the remote system,<br>not an alias you invented, because&nbsp;<b>uucico</b>&nbsp;will check it against what the remote system says it is called when<br>you log on.[94]<br>
Each system name can appear only once. If you want to use several sets of configurations for the same<br>system (such as different telephone numbers&nbsp;<b>uucico</b>&nbsp;should try in turn), you can specify&nbsp;<i>alternates</i>, which<br>we'll describe after the basic configuration options.<br>
<b>16.2.6.2. Telephone number</b><br>
If the remote system is to be reached over a telephone line, the phone field specifies the number the modem<br>should dial. It may contain several tokens interpreted by&nbsp;<b>uucico</b>'s dialing procedure. An equal sign (=) means<br>wait for a secondary dial tone, and a dash (−) generates a one−second pause. Some telephone installations<br>choke when you don't pause between dialing a special access code and the telephone number.[95]<br>
It is often convenient to use names instead of numbers to describe area dialing codes. The&nbsp;dialcode&nbsp;file<br>allows you to associate a name with a code that you may subsequently use when specifying telephone<br>numbers for remote hosts. Suppose you have the following&nbsp;dialcode&nbsp;file:<br>
# /usr/lib/uucp/dialcode − dialcode translation<br>
Bogoham &nbsp; &nbsp; &nbsp; &nbsp; 024881<br>
Coxton &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;035119<br>
With these translations, you can use a phone number such as Bogoham7732 in the&nbsp;sys&nbsp;file, which will<br>probably make things a little more legible and a whole lot easier to update should the dialing code for<br>Bogoham ever change.<br>
<b>16.2.6.3. port and speed</b><br>
The port and speed options are used to select the device used for calling the remote system and the<br>maximum speed to which the device should be set.[96]&nbsp;A system entry may use either option alone or both<br>options in conjunction. When looking up a suitable device in the&nbsp;port&nbsp;file, only ports that have a matching<br>port name and/or speed range are selected.<br>
Generally, using the speed option only should suffice. If you have only one serial device defined in&nbsp;port,<br><b>uucico</b>&nbsp;always picks the right one anyway, so you only have to give it the desired speed. If you have several<br>modems attached to your systems, you still often don't want to name a particular port, because if&nbsp;<b>uucico</b>&nbsp;finds<br>that there are several matches, it tries each device in turn until it finds an unused one.<br>
16.2.6.1. System name<br>
314<br>
<hr>
<A name=331></a>Linux Network Administrators Guide<br>
<b>16.2.6.4. The login chat</b><br>
&nbsp;We already encountered the login chat script, which tells&nbsp;<b>uucico</b>&nbsp;how to log in to the remote system. It<br>consists of a list of tokens specifying strings expected and sent by the local&nbsp;<b>uucico</b>&nbsp;process.&nbsp;<b>uucico</b>&nbsp;waits until<br>the remote machine sends a login prompt, then returns the login name, waits for the remote system to send<br>the password prompt, and sends the password. Expect and send strings appear in alternation in the script.<br><b>uucico</b>&nbsp;automatically appends a carriage return character (\r) to any send string. Thus, a simple chat script<br>would look like:<br>
&nbsp;ogin: vstout ssword: catch22<br>
You will probably notice that the expect fields don't contain the whole prompts. This ensures that the login<br>succeeds, even if the remote system transmits&nbsp;<b>Login:</b>&nbsp;instead of&nbsp;<b>login:</b>. If the string you are expecting or<br>sending contains spaces or other white−space characters, you must use quotes to surround the text.<br>
<b>uucico</b>&nbsp;also allows for some sort of conditional execution. Let's say the remote machine's&nbsp;<b>getty</b>&nbsp;needs to be<br>reset before sending a prompt. For this, you can attach a subchat to an expect string, set off by a dash. The<br>subchat is executed only if the main expect fails, i.e., a timeout occurs. One way to use this feature is to send<br>a BREAK if the remote site doesn't display a login prompt. The following example gives a general−purpose<br>chat script that should also work in case you have to press Enter before the login appears. The empty first<br>argument,&nbsp;&quot;&quot;, tells UUCP to not wait for anything, but to continue with the next send string:<br>
&nbsp;&quot;&quot; \n\r\d\r\n\c ogin:−BREAK−ogin: vstout ssword: catch22<br>
A couple of special strings and escape characters can occur in the chat script. The following is a partial list of<br>characters legal in expect strings:<br>
<i>&quot;&quot;</i><br>
The empty string. It tells&nbsp;<b>uucico</b>&nbsp;to not wait for anything, but to proceed with the next send string<br>immediately.<br>
<i>\t</i><br>
Tab character.<br>
<i>\r</i><br>
Carriage return character.<br>
<i>\s</i><br>
Space character. You need this to embed spaces in a chat string.<br>
<i>\n</i><br>
Newline character.<br>
<i>\\</i><br>
Backslash character.<br>
16.2.6.4. The login chat<br>
315<br>
<hr>
<A name=332></a>Linux Network Administrators Guide<br>
On send strings, the following escape characters and strings are legal in addition to the above:<br>
<i>EOT</i><br>
End of transmission character (<b>^D</b>).<br>
<i>BREAK</i><br>
Break character.<br>
<i>\c</i><br>
Suppress sending of carriage return at end of string.<br>
<i>\d</i><br>
Delay sending for 1 second.<br>
<i>\E</i><br>
Enable echo checking. This requires&nbsp;<b>uucico</b>&nbsp;to wait for the echo of everything it writes to be read<br>back from the device before it can continue with the chat. It is primarily useful when used in modem<br>chats (which we will encounter later). Echo checking is off by default.<br>
<i>\e</i><br>
Disable echo checking.<br>
<i>\K</i><br>
Same as BREAK.<br>
<i>\p</i><br>
Pause for fraction of a second.<br>
<b>16.2.6.5. Alternates</b><br>
Sometimes you want to have multiple entries for a single system, for instance if the system can be reached<br>on different modem lines. With Taylor UUCP, you can do this by defining a so−called&nbsp;<i>alternate</i>.<br>
An alternate entry retains all settings from the main system entry and specifies only those values that should<br>be overridden in the default system entry or added to it. An alternate is offset from the system entry by a line<br>containing the keyword alternate.<br>
To use two phone numbers for pablo, you would modify its&nbsp;sys&nbsp;entry in the following way:<br>
system &nbsp; &nbsp; &nbsp; pablo<br>
phone &nbsp; &nbsp; &nbsp; &nbsp;123−456<br>
.. entries as above ...<br>
16.2.6.5. Alternates<br>
316<br>
<hr>
<A name=333></a>Linux Network Administrators Guide<br>
alternate<br>
phone &nbsp; &nbsp; &nbsp; &nbsp;123−455<br>
When calling pablo,&nbsp;<b>uucico</b>&nbsp;will first dial 123−456, and if this fails, it will try the alternate. The alternate<br>entry retains all settings from the main system entry and overrides the telephone number only.<br>
<b>16.2.6.6. Restricting call times</b><br>
&nbsp;Taylor UUCP provides a number of ways you may restrict the times when calls can be placed to a remote<br>system. You might do this either because of limitations the remote host places on its services during business<br>hours, or simply to avoid times with high call rates. Note that it is always possible to override call−time<br>restrictions by giving&nbsp;<b>uucico</b>&nbsp;the&nbsp;−S&nbsp;or&nbsp;−f&nbsp;option.<br>
By default, Taylor UUCP disallows connections at any time, so you&nbsp;<i>have</i>&nbsp;to use some sort of time<br>specification in the&nbsp;sys&nbsp;file. If you don't care about call time restrictions, you can specify the&nbsp;<b>time</b>&nbsp;option<br>with a value of Any in your&nbsp;sys&nbsp;file.<br>
The simplest way to restrict call time is to include a time entry, followed by a string made up of a day and a<br>time subfield. Day may be any combination of Mo, Tu, We, Th, Fr, Sa, and Su. You can also specify Any,<br>Never, or Wk for weekdays. The time consists of two 24−hour clock values, separated by a dash. They<br>specify the range during which calls may be placed. The combination of these tokens is written without white<br>space in between. Any number of day and time specifications may be grouped together with commas, as this<br>line shows:<br>
time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MoWe0300−0730,Fr1805−2200<br>
This example allows calls on Mondays and Wednesdays from 3:00 a.m. to 7:30 a.m., and on Fridays between<br>6:05 p.m. and 10:00 p.m. When a time field spans midnight, say Mo1830−0600, it actually means Monday,<br>between midnight and 6:00 a.m. and between 6:30 p.m. and midnight.<br>
The special time strings Any and Never mean what they say: calls may be placed at any or no time,<br>respectively.<br>
Taylor UUCP also has a number of special tokens you may use in time strings, such as NonPeak and Night.<br>These special tokens are shorthand for Any2300−0800,SaSu0800−1700 and Any1800−0700,SaSu,<br>respectively.<br>
The&nbsp;<i>time</i>&nbsp;command takes an optional second argument that describes a retry time in minutes. When an<br>attempt to establish a connection fails,&nbsp;<b>uucico</b>&nbsp;will not allow another attempt to dial up the remote host within<br>a certain interval. For instance, when you specify a retry time of 5 minutes,&nbsp;<b>uucico</b>&nbsp;will refuse to call the<br>remote system within 5 minutes after the last failure. By default,&nbsp;<b>uucico</b>&nbsp;uses an exponential backoff scheme,<br>where the retry interval increases with each repeated failure.<br>
&nbsp;The&nbsp;<b>timegrade</b>&nbsp;command allows you to attach a maximum spool grade to a schedule. For instance, assume<br>you have the following&nbsp;<b>timegrade</b>&nbsp;commands in a system entry:<br>
timegrade &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; N Wk1900−0700,SaSu&nbsp;<br>
timegrade &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; C Any<br>
16.2.6.6. Restricting call times<br>
317<br>
<hr>
<A name=334></a>Linux Network Administrators Guide<br>
This allows jobs with a spool grade of C or higher (usually mail is queued with grade B or C) to be<br>transferred whenever a call is established, while news (usually queued with grade N) are transferred only<br>during the night and at weekends.<br>
Just like&nbsp;<b>time</b>, the&nbsp;<b>timegrade</b>&nbsp;command takes a retry interval in minutes as an optional third argument.<br>
However, a caveat about spool grades is in order here. First, the&nbsp;<b>timegrade</b>&nbsp;option applies only to what<br><i>your</i>&nbsp;systems sends; the remote system may still transfer anything it likes. You can use the<br><b>call−timegrade</b>&nbsp;option to explicitly request it to send only jobs above some given spool grade; but there's no<br>guarantee it will obey this request.[97]<br>
Similarly, the&nbsp;<i>timegrade</i>&nbsp;field is not checked when a remote system calls in, so any jobs queued for the<br>calling system will be sent. However, the remote system can explicitly request your&nbsp;<b>uucico</b>&nbsp;to restrict itself to<br>a certain spool grade.<br>
<b>16.2.7. Identifying Available Devices Through the port File</b><br>
&nbsp;The&nbsp;port&nbsp;file tells&nbsp;<b>uucico</b>&nbsp;about the available ports. These are usually modem ports, but other types, such<br>as direct serial lines and TCP sockets, are supported as well.<br>
Like the&nbsp;sys&nbsp;file,&nbsp;port&nbsp;consists of separate entries starting with the keyword port followed by the port<br>name. This name may be used in the&nbsp;sys&nbsp;file's port statement. The name need not be unique; if there are<br>several ports with the same name,&nbsp;<b>uucico</b>&nbsp;will try each in turn until it finds one that is not currently being<br>used.<br>
The&nbsp;<b>port</b>&nbsp;command should be followed immediately by the type statement, which indicates what type of port<br>is described. Valid types are modem, direct for direct connections, and tcp for TCP sockets. If the<br><b>port</b>&nbsp;command is missing, the port type defaults to modem.<br>
In this section, we cover only modem ports; TCP ports and direct lines are discussed in a later section.<br>
For modem and direct ports, you have to specify the device for calling out using the device directive. Usually,<br>this is the name of a device special file in the&nbsp;/dev&nbsp;directory, like&nbsp;/dev/ttyS1.<br>
In the case of a modem device, the port entry also determines what type of modem is connected to the port.<br>Different types of modems have to be configured differently. Even modems that claim to be<br>Hayes−compatible aren't always really compatible with one another. Therefore, you have to tell&nbsp;<b>uucico</b>&nbsp;how<br>to initialize the modem and make it dial the desired number. Taylor UUCP keeps the descriptions of all<br>dialers in a file named&nbsp;dial. To use any of these, you have to specify the dialer's name using the<br><b>dialer</b>&nbsp;command.<br>
Sometimes, you will want to use a modem in different ways, depending on which system you call. For<br>instance, some older modems don't understand when a high−speed modem attempts to connect at 56 kbps;<br>they simply drop the line instead of negotiating a connect at 9,600 bps, for instance. When you know site<br>drop uses such a dumb modem, you have to set up your modem differently when calling them. For this, you<br>need an additional port entry in the&nbsp;port&nbsp;file that specifies a different dialer. Now you can give the new port<br>a different name, such as serial1−slow, and use the port directive in the drop system entry in&nbsp;sys.<br>
16.2.7. Identifying Available Devices Through the port File<br>
318<br>
<hr>
<A name=335></a>Linux Network Administrators Guide<br>
A better to distinguish the ports is by the speeds they support. For instance, the two port entries for the above<br>situation may look like this:<br>
# NakWell modem; connect at high speed<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;serial1 &nbsp; &nbsp; &nbsp; &nbsp; # port name<br>
type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;modem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # modem port<br>
device &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/dev/ttyS1 &nbsp; &nbsp; &nbsp;# this is COM2<br>
speed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 115200 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# supported speed<br>
dialer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nakwell &nbsp; &nbsp; &nbsp; &nbsp; # normal dialer<br>
# NakWell modem; connect at low speed<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;serial1 &nbsp; &nbsp; &nbsp; &nbsp; # port name<br>
type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;modem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # modem port<br>
device &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/dev/ttyS1 &nbsp; &nbsp; &nbsp;# this is COM2<br>
speed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# supported speed<br>
dialer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nakwell−slow &nbsp; &nbsp;# don't attempt fast connect<br>
The system entry for site drop would now give serial1 as the port name, but request to use it at only 9,600<br>bps.&nbsp;<b>uucico</b>&nbsp;then automatically uses the second port entry. All remaining sites that have a speed of 115,200<br>bps in the system entry will be called using the first port entry. By default, the first entry with a matching<br>speed will be used.<br>
<b>16.2.8. How to Dial a Number Using the dial File</b><br>
&nbsp;The&nbsp;dial&nbsp;file describes the way various dialers are used. Traditionally, UUCP talks of dialers rather than<br>modems, because in earlier times, it was usual practice to have one (expensive) automatic dialing device<br>serve a whole bank of modems. Today, most modems have dialing support built in, so this distinction gets a<br>little blurred.<br>
Nevertheless, different dialers or modems may require a different configuration. You can describe each of<br>them in the&nbsp;dial&nbsp;file. Entries in&nbsp;dial&nbsp;start with the&nbsp;<b>dialer</b>&nbsp;command that gives the dialer's name.<br>
The most important entry besides&nbsp;<b>dialer</b>&nbsp;is the modem chat, specified by the&nbsp;<b>chat</b>&nbsp;command. Similar to the<br>login chat, it consists of a sequence of strings&nbsp;<b>uucico</b>&nbsp;sends to the dialer and the responses it expects in return.<br>It is commonly used to reset the modem to some known state and dial the number. The following sample<br>dialer entry shows a typical modem chat for a Hayes−compatible modem:<br>
# NakWell modem; connect at high speed<br>
dialer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nakwell &nbsp; &nbsp; &nbsp; &nbsp; # dialer name<br>
chat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&quot;&quot; AT&amp;F OK\r ATH1E0Q0 OK\r ATDT\T CONNECT<br>
chat−fail &nbsp; &nbsp; &nbsp; BUSY<br>
chat−fail &nbsp; &nbsp; &nbsp; ERROR<br>
chat−fail &nbsp; &nbsp; &nbsp; NO\sCARRIER<br>
dtr−toggle &nbsp; &nbsp; &nbsp;true<br>
The modem chat begins with&nbsp;&quot;&quot;, the empty expect string.&nbsp;<b>uucico</b>&nbsp;therefore sends the first command<br><b>AT&amp;F</b>&nbsp;right away.&nbsp;<b>AT&amp;F</b>&nbsp;is the Hayes command to reset the modem to factory default configuration.<br><b>uucico</b>&nbsp;then waits until the modem has sent&nbsp;OK&nbsp;and sends the next command, which turns off local echo and<br>the like. After the modem returns&nbsp;OK&nbsp;again,&nbsp;<b>uucico</b>&nbsp;sends the dialing command&nbsp;<b>ATDT</b>. The escape sequence<br>\T&nbsp;in this string is replaced with the phone number taken from the system entry&nbsp;sys&nbsp;file.&nbsp;<b>uucico</b>&nbsp;then waits<br>for the modem to return the string&nbsp;CONNECT, which signals that a connection with the remote modem has<br>been established successfully.<br>
16.2.8. How to Dial a Number Using the dial File<br>
319<br>
<hr>
<A name=336></a>Linux Network Administrators Guide<br>
Sometimes the modem fails to connect to the remote system; for instance, if the other system is talking to<br>someone else and the line is busy. In this case, the modem returns an error message indicating the reason.<br>Modem chats are not capable of detecting such messages;&nbsp;<b>uucico</b>&nbsp;continues to wait for the expected string<br>until it times out. The UUCP log file therefore only shows a bland timed out in chat script instead of the<br>specific reason.<br>
However, Taylor UUCP allows you to tell&nbsp;<b>uucico</b>&nbsp;about these error messages using the&nbsp;<b>chat−fail</b>&nbsp;command<br>as shown above. When&nbsp;<b>uucico</b>&nbsp;detects a chat−fail string while executing the modem chat, it aborts the call<br>and logs the error message in the UUCP log file.<br>
The last command in the example shown above tells UUCP to toggle the Data Terminal Ready (DTR) control<br>line before starting the modem chat. Normally, the serial driver raises DTR when a process opens the device<br>to tell the attached modem that someone wants to talk to it. The dtr−toggle feature then drops DTR, waits a<br>moment, and raises it again. Many modems can be configured to react to a drop of DTR by going off−hook,<br>entering command state, or resetting themselves.[98]<br>
<b>16.2.9. UUCP Over TCP</b><br>
&nbsp;Absurd as it may sound, using UUCP to transfer data over TCP is not that bad an idea, especially when<br>transferring large amounts of data such as Usenet news. On TCP−based links, news is generally exchanged<br>using the NNTP protocol, through which articles are requested and sent individually without compression or<br>any other optimization. Although adequate for large sites with several concurrent newsfeeds, this technique is<br>very unfavorable for small sites that receive their news over a relatively slow connection such as ISDN.<br>These sites will usually want to combine the qualities of TCP with the advantages of sending news in large<br>batches, which can be compressed and thus transferred with very low overhead. A common way to transfer<br>these batches is to use UUCP over TCP.<br>
In&nbsp;sys, you would specify a system to be called via TCP like this:<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gmu<br>
address &nbsp; &nbsp; &nbsp; &nbsp; news.groucho.edu<br>
time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Any<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp−conn<br>
chat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ogin: vstout word: clouseau<br>
The&nbsp;<b>address</b>&nbsp;command gives the IP address of the host or its fully qualified domain name. The corresponding<br>port&nbsp;entry would read:<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp−conn<br>
type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp<br>
service &nbsp; &nbsp; &nbsp; &nbsp; 540<br>
The entry states that a TCP connection should be used when a&nbsp;sys&nbsp;entry references tcp−conn, and that<br><b>uucico</b>&nbsp;should attempt to connect to the TCP network port 540 on the remote host. This is the default port<br>number of the UUCP service. Instead of the port number, you may also give a symbolic port name to the<br><b>service</b>&nbsp;command. The port number corresponding to this name will be looked up in&nbsp;/etc/services. The<br>common name for the UUCP service is uucpd.<br>
16.2.9. UUCP Over TCP<br>
320<br>
<hr>
<A name=337></a>Linux Network Administrators Guide<br>
<b>16.2.10. Using a Direct Connection</b><br>
Assume you use a direct line to connect your system vstout to tiny. Much like in the modem case, you have<br>to write a system entry in the&nbsp;sys&nbsp;file. The&nbsp;<b>port</b>&nbsp;command identifies the serial port tiny is hooked up to:<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tiny<br>
time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Any<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;direct1<br>
speed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 38400<br>
chat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ogin: cathcart word: catch22<br>
In the&nbsp;port&nbsp;file, you have to describe the serial port for the direct connection. A dialer entry is not needed<br>because there's no need for dialing:<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;direct1<br>
type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;direct<br>
speed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 38400<br>
device &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/dev/ttyS1<br>
16.2.10. Using a Direct Connection<br>
321<br>
<hr>
<A name=338></a><b>16.3. Controlling Access to UUCP Features</b><br>
&nbsp;UUCP is quite a flexible system. With that flexibility comes a need to carefully control access to its<br>features to prevent abuse, whether it be intentional or accidental. The primary features of concern to the<br>UUCP administrator are remote command execution, file transfer, and forwarding. Taylor UUCP provides a<br>means of limiting the freedom that remote UUCP hosts have in exercising each of these features. With<br>careful selection of permissions, the UUCP administrator can ensure that the host's security is preserved.<br>
<b>16.3.1. Command Execution</b><br>
&nbsp;UUCP's task is to copy files from one system to another and to request execution of certain commands on<br>remote hosts. Of course, you as an administrator would want to control what rights you grant other<br>systemsallowing them to execute any command they choose on your system is definitely not a good idea.<br>
&nbsp;By default, the only commands Taylor UUCP allows other systems to execute on your machine are<br><b>rmail</b>&nbsp;and&nbsp;<b>rnews</b>, which are commonly used to exchange email and Usenet News over UUCP. To change the<br>set of commands for a particular system, you can use the commands keyword in the&nbsp;sys&nbsp;file. Similarly, you<br>may want to limit the search path to just those directories containing the allowed commands. You can change<br>the search path allowed for a remote host with the command−path statement. For instance, you may want to<br>allow system pablo to execute the&nbsp;<b>bsmtp</b>&nbsp;command in addition to&nbsp;<b>rmail</b>&nbsp;and&nbsp;<b>rnews</b>:[99]<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pablo<br>
...<br>
commands &nbsp; &nbsp; &nbsp; &nbsp;rmail rnews bsmtp<br>
<b>16.3.2. File Transfers</b><br>
&nbsp;Taylor UUCP also allows you to fine−tune file transfers in great detail. At one extreme, you can disable<br>transfers to and from a particular system. Just set request to no, and the remote system will not be able to<br>either retrieve files from your system or send it any files. Similarly, you can prohibit your users from<br>transferring files to or from a system by setting transfer to no. By default, users on both the local and the<br>remote system are allowed to upload and download files.<br>
In addition, you can configure the directories that files may be copied to and from. Usually you will want to<br>restrict access from remote systems to a single directory hierarchy, but still allow your users to send files<br>from their home directory. Commonly, remote users are allowed to receive files only from the public UUCP<br>directory&nbsp;/var/spool/uucppublic. This is the traditional place to make files publicly available, very<br>much like FTP servers on the Internet.[100]<br>
Taylor UUCP provides four different commands to configure the directories for sending and receiving files.<br>They are:&nbsp;<b>local−send</b>, which specifies the list of directories a user may ask UUCP to send files from;<br><b>local−receive</b>, which gives the list of directories a user may ask to receive files to; and&nbsp;<b>remote−send</b>&nbsp;and<br><b>remote−receive</b>, which do the analogous for requests from a foreign system. Consider the following<br>example:<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pablo<br>
...<br>
16.3. Controlling Access to UUCP Features<br>
322<br>
<hr>
<A name=339></a>Linux Network Administrators Guide<br>
local−send &nbsp; &nbsp; &nbsp;/home ~<br>
local−receive &nbsp; /home ~/receive<br>
remote−send &nbsp; &nbsp; ~ !~/incoming !~/receive<br>
remote−receive &nbsp;~/incoming<br>
The&nbsp;<b>local−send</b>&nbsp;command allows users on your host to send any files below&nbsp;/home&nbsp;and from the public<br>UUCP directory to pablo. The&nbsp;<b>local−receive</b>&nbsp;command allows them to receive files either to the<br>world−writable&nbsp;receive&nbsp;directory in the&nbsp;uucppublic, or any world−writable directory below&nbsp;/home.<br>The&nbsp;<b>remote−send</b>&nbsp;directive allows pablo to request files from&nbsp;/var/spool/uucppublic, except for<br>files from the&nbsp;incoming&nbsp;and&nbsp;receive&nbsp;directories. This is signaled to&nbsp;<b>uucico</b>&nbsp;by preceding the directory<br>names with exclamation marks. Finally, the last line allows pablo to upload files to incoming.<br>
A major problem with file transfers using UUCP is that it receives files only to directories that are<br>world−writable. This may tempt some users to set up traps for other users. However, there's no way to escape<br>this problem outside of disabling UUCP file transfers altogether.<br>
<b>16.3.3. Forwarding</b><br>
&nbsp;UUCP provides a mechanism to have other systems execute file transfers on your behalf. For instance,<br>suppose your system has&nbsp;<b>uucp</b>&nbsp;access to a system called seci, but not to another system called uchile. This<br>allows you to make seci retrieve a file from uchile for you and send it to your system. The following<br>command would achieve this:<br>
$&nbsp;<b>uucp −r seci!uchile!~/find−ls.gz ~/uchile.files.gz</b><br>
This technique of passing a job through several systems is called&nbsp;<i>forwarding</i>. On your own UUCP system,<br>you would want to limit the forwarding service to a few hosts you trust not to run up a horrendous phone bill<br>by making you download the latest X11R6 source release for them.<br>
By default, Taylor UUCP prohibits forwarding altogether. To enable forwarding for a particular system, you<br>can use the&nbsp;<b>forward</b>&nbsp;command. This command specifies a list of sites the system may request you to forward<br>jobs to and from. For instance, the UUCP administrator of seci would have to add the following lines to the<br>sys&nbsp;file to allow pablo to request files from uchile:<br>
####################<br>
# pablo<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pablo<br>
...<br>
forward &nbsp; &nbsp; &nbsp; &nbsp; uchile<br>
####################<br>
# uchile<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;uchile<br>
...<br>
forward−to &nbsp; &nbsp; &nbsp;pablo<br>
The forward−to entry for uchile is necessary so that any files returned by it are actually passed on to pablo.<br>Otherwise UUCP would drop them. This entry uses a variation of the&nbsp;<b>forward</b>&nbsp;command that permits<br>uchile to send files only to pablo through seci, not the other way round.<br>
To permit forwarding to any system, use the special keyword ANY (capital letters required).<br>
16.3.3. Forwarding<br>
323<br>
<hr>
<A name=340></a><b>16.4. Setting Up Your System for Dialing In</b><br>
&nbsp;If you want to set up your site for dialing in, you have to permit logins on your serial port and customize<br>some system files to provide UUCP accounts, which we will cover in this section.<br>
<b>16.4.1. Providing UUCP Accounts</b><br>
&nbsp;To begin with, you have to set up user accounts that let remote sites log into your system and establish a<br>UUCP connection. Generally, you will provide a separate login name to each system that polls you. When<br>setting up an account for system pablo, you might give it the username Upablo. There is no enforced policy<br>on login names; they can be just about anything, but it will be convenient for you if the login name is easily<br>related to the remote host name.<br>
For systems that dial in through the serial port, you usually have to add these accounts to the system<br>password file&nbsp;/etc/passwd. It is good practice to put all UUCP logins in a special group, such as uuguest.<br>The account's home directory should be set to the public spool directory&nbsp;/var/spool/uucppublic; its<br>login shell must be&nbsp;<b>uucico</b>.<br>
To serve UUCP systems that connect to your site over TCP, you have to set up&nbsp;<b>inetd</b>&nbsp;to handle incoming<br>connections on the uucp port by adding the following line to&nbsp;/etc/inetd.conf:&nbsp;[101]<br>
uucp &nbsp; stream &nbsp;tcp &nbsp; nowait &nbsp;root &nbsp;/usr/sbin/tcpd &nbsp;/usr/lib/uucp/uucico −l<br>
&nbsp;The&nbsp;−l&nbsp;option makes&nbsp;<b>uucico</b>&nbsp;perform its own login authorization. It prompts for a login name and a<br>password just like the standard&nbsp;<b>login</b>&nbsp;program, but relies on its private password database instead of<br>/etc/passwd. This private password file is named&nbsp;/etc/uucp/passwd&nbsp;and contains pairs of login<br>names and passwords:<br>
Upablo &nbsp;IslaNegra<br>
Ulorca &nbsp;co'rdoba<br>
This file must be owned by uucp and have permissions of 600.<br>
Does this database sound like such a good idea that you would like to use it on normal serial logins, too?<br>Well, in some cases you can. What you need is a&nbsp;<b>getty</b>&nbsp;program that you can tell to invoke&nbsp;<b>uucico</b>&nbsp;instead of<br><b>/bin/login</b>&nbsp;for your UUCP users.[102]&nbsp;The invocation of&nbsp;<b>uucico</b>&nbsp;would look like this:<br>
/usr/lib/uucp/uucico −l −u&nbsp;<i>user</i><br>
The&nbsp;−u&nbsp;option tells it to use the specified user name rather than prompting for it.[103]<br>
To protect your UUCP users from callers who might give a false system name and snarf all their mail, you<br>should add&nbsp;<b>called−login</b>&nbsp;commands to each system entry in the&nbsp;sys&nbsp;file. This is described in the next section.<br>
16.4. Setting Up Your System for Dialing In<br>
324<br>
<hr>
<A name=341></a>Linux Network Administrators Guide<br>
<b>16.4.2. Protecting Yourself Against Swindlers</b><br>
&nbsp;A major problem with UUCP is that the calling system can lie about its name; it announces its name to the<br>called system after logging in, but the server doesn't have any way to check it. Thus, an attacker could log<br>into his or her own UUCP account, pretend to be someone else, and pick up that other site's mail. This is<br>particularly troublesome if you offer login via anonymous UUCP, where the password is made public.<br>
You&nbsp;<i>must</i>&nbsp;guard against this sort of impostor. The cure for this disease is to require each system to use a<br>particular login name by specifying a called−login in&nbsp;sys. A sample system entry may look like this:<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pablo<br>
... usual options ...<br>
called−login &nbsp; &nbsp;Upablo<br>
The upshot is that whenever a system logs in and pretends it is pablo,&nbsp;<b>uucico</b>&nbsp;checks whether it has logged in<br>as Upablo. If it hasn't, the calling system is turned down, and the connection is dropped. You should make it a<br>habit to add the&nbsp;<b>called−login</b>&nbsp;command to every system entry you add to your&nbsp;sys&nbsp;file. It is important that<br>you do this for&nbsp;<i>all</i>&nbsp;systems in your&nbsp;<b>sys</b>&nbsp;file, regardless of whether they will ever call your site or not. For those<br>sites that never call you, you should probably set called−login to some totally bogus user name, such as<br>neverlogsin.<br>
<b>16.4.3. Be Paranoid: Call Sequence Checks</b><br>
Another way to fend off and detect impostors is to use&nbsp;<b>call sequence checks</b>. These help you protect against<br>intruders who somehow manage to find out the password with which you log into your UUCP system.<br>
When using call sequence checks, both machines keep track of the number of connections established so far.<br>The counter is incremented with each connection. After logging in, the caller sends its call sequence number,<br>and the receiver checks it against its own number. If they don't match, the connection attempt is rejected. If<br>the initial number is chosen at random, attackers will have a hard time guessing the correct call sequence<br>number.<br>
But call sequence checks do more for you. Even if some very clever person should detect your call sequence<br>number as well as your password, you will find out. When the attacker calls your UUCP feed and steals your<br>mail, this will increase the feeds call sequence number by one. The next time&nbsp;<i>you</i>&nbsp;call your feed and try to log<br>in, the remote&nbsp;<b>uucico</b>&nbsp;will refuse you, because the numbers don't match anymore!<br>
If you have enabled call sequence checks, you should check your log files regularly for error messages that<br>hint at possible attacks. If your system rejects the call sequence number the calling system offers,&nbsp;<b>uucico</b>&nbsp;will<br>put a message into the log file saying something like, Out of sequence call rejected. If your system is<br>rejected by its feed because the sequence numbers are out of sync, it will put a message in the log file saying,<br>Handshake failed (RBADSEQ).<br>
To enable call sequence checks, add the following command to the system entry:<br>
# enable call sequence checks<br>
sequence &nbsp; &nbsp; &nbsp; &nbsp;true<br>
In addition, you have to create the file containing the sequence number itself. Taylor UUCP keeps the<br>
16.4.2. Protecting Yourself Against Swindlers<br>
325<br>
<hr>
<A name=342></a>Linux Network Administrators Guide<br>
sequence number in a file called&nbsp;.Sequence&nbsp;in the remote site's spool directory. It&nbsp;<i>must</i>&nbsp;be owned by<br>uucp and must be mode 600 (i.e., readable and writeable only by uucp). It is best to initialize this file with an<br>arbitrary, previously agreed−upon start value. A simple way to create this file is:<br>
#&nbsp;<b>cd /var/spool/uucp/pablo</b><br>
#&nbsp;<b>echo 94316 &gt; .Sequence</b><br>
#&nbsp;<b>chmod 600 .Sequence</b><br>
#&nbsp;<b>chown uucp.uucp .Sequence</b><br>
Of course, the remote site has to enable call sequence checks as well and start by using exactly the same<br>sequence number as you.<br>
<b>16.4.4. Anonymous UUCP</b><br>
&nbsp;If you want to provide anonymous UUCP access to your system, you first have to set up a special account<br>for it as previously described. A common practice is to give the anonymous account a login name and a<br>password of uucp.<br>
In addition, you have to set a few of the security options for unknown systems. For instance, you may want to<br>prohibit them from executing any commands on your system. However, you cannot set these parameters in a<br>sys&nbsp;file entry because the&nbsp;<b>system</b>&nbsp;command requires the system's name, which you don't have. Taylor UUCP<br>solves this dilemma through the&nbsp;<b>unknown</b>&nbsp;command.&nbsp;<b>unknown</b>&nbsp;can be used in the&nbsp;config&nbsp;file to specify<br>any command that can usually appear in a system entry:<br>
unknown &nbsp; &nbsp; &nbsp; &nbsp; remote−receive ~/incoming<br>
unknown &nbsp; &nbsp; &nbsp; &nbsp; remote−send ~/pub<br>
unknown &nbsp; &nbsp; &nbsp; &nbsp; max−remote−debug none<br>
unknown &nbsp; &nbsp; &nbsp; &nbsp; command−path /usr/lib/uucp/anon−bin<br>
unknown &nbsp; &nbsp; &nbsp; &nbsp; commands rmail<br>
This will restrict unknown systems to downloading files from below the&nbsp;pub&nbsp;directory and uploading files to<br>the&nbsp;incoming&nbsp;directory below&nbsp;/var/spool/uucppublic. The next line will make&nbsp;<b>uucico</b>&nbsp;ignore any<br>requests from the remote system to turn on debugging locally. The last two lines permit unknown systems to<br>execute&nbsp;<b>rmail</b>; but the command path specified makes&nbsp;<b>uucico</b>&nbsp;look for the&nbsp;<b>rmail</b>&nbsp;command in a private<br>directory named&nbsp;anon−bin&nbsp;only. This restriction allows you to provide some special&nbsp;<b>rmail</b>&nbsp;that, for<br>instance, forwards all mail to the superuser for examination. This allows anonymous users to reach the<br>maintainer of the system, but at the same time prevents them from injecting any mail to other sites.<br>
To enable anonymous UUCP, you must specify at least one unknown statement in&nbsp;config. Otherwise<br><b>uucico</b>&nbsp;will reject all unknown systems.<br>
16.4.4. Anonymous UUCP<br>
326<br>
<hr>
<A name=343></a><b>16.5. UUCP Low−Level Protocols</b><br>
To negotiate session control and file transfers with the remote end,&nbsp;<b>uucico</b>&nbsp;uses a set of standardized<br>messages. This is often referred to as the&nbsp;<b>high−level protocol</b>. During the initialization phase and the hangup<br>phase these are simply sent across as strings. However, during the real transfer phase, an additional low−level<br>protocol that is mostly transparent to the higher levels is employed. This protocol offers some added benefits,<br>such as allowing error checks on data sent over unreliable links.<br>
<b>16.5.1. Protocol Overview</b><br>
UUCP is used over different types of connections, such as serial lines, TCP, or sometimes even X.25; it is<br>advantageous to transport UUCP within protocols designed specifically for the underlying network protocol.<br>In addition, several implementations of UUCP have introduced different protocols that do roughly the same<br>thing.<br>
Protocols can be divided into two categories:&nbsp;<b>streaming</b>&nbsp;and&nbsp;<b>packet</b>&nbsp;protocols. Protocols of the streaming<br>variety transfer a file as a whole, possibly computing a checksum over it. This is nearly free of overhead, but<br>requires a reliable connection because any error will cause the whole file to be retransmitted. These protocols<br>are commonly used over TCP connections but are not suitable for use over telephone lines. Although modern<br>modems do quite a good job at error correction, they are not perfect, nor is there any error detection between<br>your computer and the modem.<br>
On the other hand, packet−oriented protocols split up the file into several chunks of equal size. Each packet is<br>sent and received separately, a checksum is computed, and an acknowledgment is returned to the sender. To<br>make this more efficient, sliding−window protocols have been invented, which allow for a limited number (a<br>window) of outstanding acknowledgments at any time. This greatly reduces the amount of time&nbsp;<b>uucico</b>&nbsp;has to<br>wait during a transmission. Still, the relatively large overhead compared to a streaming protocol makes packet<br>protocols inefficient for TCP use, but ideal for telephone lines.<br>
The width of the data path also makes a difference. Sometimes sending 8−bit characters over a serial<br>connection is impossible; for instance, the connection could go through a stupid terminal server that strips off<br>the eighth bit. When you transmit 8−bit characters over a 7−bit connection, they have to be quoted on<br>transmission. In the worst−case scenerio, quoting doubles the amount of data to be transmitted, although<br>compression done by the hardware may compensate. Lines that can transmit arbitrary 8−bit characters are<br>usually called&nbsp;<i>8−bit clean</i>. This is the case for all TCP connections, as well as for most modem connections.<br>
Taylor UUCP 1.06 supports a wide variety of UUCP protocols. The most common of these are:<br>
<i>g</i><br>
This is the most common protocol and should be understood by virtually all&nbsp;<b>uucico</b>s. It does<br>thorough error checking and is therefore well suited for noisy telephone links.&nbsp;<i>g</i>&nbsp;requires an 8−bit<br>clean connection. It is a packet−oriented protocol that uses a sliding−window technique.<br>
<i>i</i><br>
This is a bidirectional packet protocol, which can send and receive files at the same time. It requires a<br>full−duplex connection and an 8−bit clean data path. It is currently understood by Taylor UUCP only.<br>
16.5. UUCP Low−Level Protocols<br>
327<br>
<hr>
<A name=344></a>Linux Network Administrators Guide<br>
<i>t</i><br>
This protocol is intended for use over a TCP connection or other truly error−free networks. It uses<br>packets of 1,024 bytes and requires an 8−bit clean connection.<br>
<i>e</i><br>
This should basically do the same as&nbsp;<i>t</i>. The main difference is that&nbsp;<i>e</i>&nbsp;is a streaming protocol and is<br>thus suited only to reliable network connections.<br>
<i>f</i><br>
This is intended for use with reliable X.25 connections. It is a streaming protocol and expects a 7−bit<br>data path. 8−bit characters are quoted, which can make it very inefficient.<br>
<i>G</i><br>
This is the System V Release 4 version of the&nbsp;<i>g</i>&nbsp;protocol. It is also understood by some other versions<br>of UUCP.<br>
<i>a</i><br>
This protocol is similiar to ZMODEM. It requires an 8−bit connection, but quotes certain control<br>characters like XON and XOFF.<br>
<b>16.5.2. Tuning the Transmission Protocol</b><br>
All protocols allow for some variation in packet sizes, timeouts, etc. Usually, the defaults work well under<br>standard circumstances, but may not be optimal for your situation. The&nbsp;<i>g</i>&nbsp;protocol, for instance, uses window<br>sizes from 1 to 7, and packet sizes in powers of 2 ranging from 64 through 4096. If your telephone line is<br>usually so noisy that it drops more than 5 percent of all packets, you should probably lower the packet size<br>and shrink the window. On the other hand, on very good telephone lines the protocol overhead of sending<br>acknowledgments for every 128 bytes may prove wasteful, so you might increase the packet size to 512 or<br>even 1,024. Most binaries included in Linux distributions default to a window size of 7 and 128−byte packets.<br>
Taylor UUCP lets you tune parameters with the&nbsp;<b>protocol−parameter</b>&nbsp;command in the&nbsp;sys&nbsp;file. For instance,<br>to set the&nbsp;<i>g</i>&nbsp;protocol's packet size to 512 when talking to pablo, you have to add:<br>
system &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pablo<br>
...<br>
protocol−parameter g &nbsp;packet−size &nbsp;512<br>
The tunable parameters and their names vary from protocol to protocol. For a complete list of them, refer to<br>the documentation enclosed in the Taylor UUCP source.<br>
16.5.2. Tuning the Transmission Protocol<br>
328<br>
<hr>
<A name=345></a>Linux Network Administrators Guide<br>
<b>16.5.3. Selecting Specific Protocols</b><br>
Not every implementation of&nbsp;<b>uucico</b>&nbsp;speaks and understands each protocol, so during the initial handshake<br>phase, both processes have to agree on a common one. The master&nbsp;<b>uucico</b>&nbsp;offers the slave a list of supported<br>protocols by sending&nbsp;P<i>protlist</i>, from which the slave may pick one.<br>
Based on the type of port used (modem, TCP, or direct),&nbsp;<b>uucico</b>&nbsp;will compose a default list of protocols. For<br>modem and direct connections, this list usually comprises&nbsp;<i>i</i>,&nbsp;<i>a</i>,&nbsp;<i>g</i>,&nbsp;<i>G</i>, and&nbsp;<i>j</i>. For TCP connections, the list is&nbsp;<i>t</i>,<br><i>e</i>,&nbsp;<i>i</i>,&nbsp;<i>a</i>,&nbsp;<i>g</i>,&nbsp;<i>G</i>,&nbsp;<i>j</i>, and&nbsp;<i>f</i>. You can override this default list with the&nbsp;<b>protocols</b>&nbsp;command, which may be specified<br>in a system entry as well as a port entry. For instance, you might edit the&nbsp;port&nbsp;file entry for your modem<br>port like this:<br>
port &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;serial1<br>
...<br>
protocols &nbsp; &nbsp; &nbsp; igG<br>
This will require any incoming or outgoing connection through this port to use&nbsp;<i>i</i>,&nbsp;<i>g</i>, or&nbsp;<i>G</i>. If the remote system<br>does not support any of these, the conversation will fail.<br>
16.5.3. Selecting Specific Protocols<br>
329<br>
<hr>
<A name=346></a><b>16.6. Troubleshooting</b><br>
This section describes what may go wrong with your UUCP connection and makes location suggestions to<br>fix the error. Although these problems are encountered on a regular basis, there is much more that can go<br>wrong than what we have listed.<br>
If you have a problem, enable debugging with&nbsp;−xall, and take a look at the output in&nbsp;Debug&nbsp;in the spool<br>directory. The file should help you to quickly recognize the problem. It is often helpful to turn on the<br>modem's speaker when it doesn't connect. With Hayes−compatible modems, you can turn on the speaker by<br>adding&nbsp;ATL1M1 OK&nbsp;to the modem chat in the&nbsp;dial&nbsp;file.<br>
The first check should always be whether all file permissions are set correctly.&nbsp;<b>uucico</b>&nbsp;should be setuid uucp,<br>and all files in&nbsp;/usr/lib/uucp,&nbsp;/var/spool/uucp, and&nbsp;/var/spool/uucppublic&nbsp;should be<br>owned by uucp. There are also some hidden files in the spool directory which must be owned by uucp as<br>well.[104]<br>
When you're sure you have the permissions of all files set correctly, and you're still experiencing problems,<br>you can then begin to take error messages more literally. We'll now look at some of the more common errors<br>and problems.<br>
<b>16.6.1. uucico Keeps Saying Wrong Time to Call</b><br>
This probably means that in the system entry in&nbsp;sys, you didn't specify a&nbsp;<b>time</b>&nbsp;command that details when<br>the remote system may be called, or you gave one that actually forbids calling at the current time. If no call<br>schedule is given,&nbsp;<b>uucico</b>&nbsp;assumes the system can never be called.<br>
<b>16.6.2. uucico Complains That the Site Is Already Locked</b><br>
This means that&nbsp;<b>uucico</b>&nbsp;detects a lock file for the remote system in&nbsp;/var/spool/uucp. The lock file may<br>be from an earlier call to the system that crashed or was killed. Another possible explanation is that there's<br>another&nbsp;<b>uucico</b>&nbsp;process sitting around that is trying to dial the remote system and has gotten stuck in a chat<br>script, or stalled for some other reason.<br>
To correct this error, kill all&nbsp;<b>uucico</b>&nbsp;processes open for the site with a hangup signal, and remove all lock files<br>that they have left lying around.<br>
<b>16.6.3. You Can Connect to the Remote Site, but the Chat<br>Script Fails</b><br>
Look at the text you receive from the remote site. If it's garbled, you might have a speed−related problem.<br>Otherwise, confirm that it really agrees with what your chat script expects. Remember, the chat script starts<br>with an expect string. If you receive the login prompt and send your name, but never get the password<br>prompt, insert some delays before sending it, or even in between the letters. You might be too fast for your<br>modem.<br>
16.6. Troubleshooting<br>
330<br>
<hr>
<A name=347></a>Linux Network Administrators Guide<br>
<b>16.6.4. Your Modem Does Not Dial</b><br>
If your modem doesn't indicate that the DTR line has been raised when&nbsp;<b>uucico</b>&nbsp;calls out, you might not have<br>given the right device to&nbsp;<b>uucico</b>. If your modem recognizes DTR, check with a terminal program that you can<br>write to the modem. If this works, turn on echoing with \E at the start of the modem chat. If the modem<br>doesn't echo your commands during the modem chat, check if your line speed is too high or low. If you see<br>the echo, check if you have disabled modem responses or set them to number codes. Verify that the chat<br>script itself is correct. Remember that you have to write two backslashes to send one to the modem.<br>
<b>16.6.5. Your Modem Tries to Dial but Doesn't Get Out</b><br>
Insert a delay into the phone number, especially if you have to dial a special sequence to gain an outside line<br>from a corporate telephone network. Make sure you are using the correct dial type, as some telephone<br>networks support only one type of dialing. Additionally, double check the telephone number to make sure it's<br>correct.<br>
<b>16.6.6. Login Succeeds, but the Handshake Fails</b><br>
Well, there can be a number of problems in this situation. The output in the log file should tell you a lot.<br>Look at what protocols the remote site offers (it sends a string&nbsp;P<i>&nbsp;protlist</i>&nbsp;during the handshake). For the<br>handshake to succeed, both ends must support at least one common protocol, so check that they do.<br>
If the remote system sends&nbsp;<b>RLCK</b>, there is a stale lockfile for you on the remote system already connected to<br>the remote system on a different line. Otherwise, ask the remote system administrator to remove the file.<br>
If the remote system sends&nbsp;<b>RBADSEQ</b>, it has conversation count checks enabled for you, but the numbers<br>didn't match. If it sends&nbsp;<b>RLOGIN</b>, you were not permitted to log in under this ID.<br>
16.6.4. Your Modem Does Not Dial<br>
331<br>
<hr>
<A name=348></a><b>16.7. Log Files and Debugging</b><br>
&nbsp;When compiling the UUCP suite to use Taylor−style logging, you have only three global log files, all of<br>which reside in the spool directory. The main log file is named&nbsp;Log&nbsp;and contains all the information about<br>established connections and transferred files. A typical excerpt looks like this (after a little reformatting to<br>make it fit the page):<br>
uucico pablo − (1994−05−28 17:15:01.66 539) Calling system pablo (port cua3)<br>
uucico pablo − (1994−05−28 17:15:39.25 539) Login successful<br>
uucico pablo − (1994−05−28 17:15:39.90 539) Handshake successful<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(protocol 'g' packet size 1024 window 7)<br>
uucico pablo postmaster (1994−05−28 17:15:43.65 539) Receiving D.pabloB04aj<br>
uucico pablo postmaster (1994−05−28 17:15:46.51 539) Receiving X.pabloX04ai<br>
uucico pablo postmaster (1994−05−28 17:15:48.91 539) Receiving D.pabloB04at<br>
uucico pablo postmaster (1994−05−28 17:15:51.52 539) Receiving X.pabloX04as<br>
uucico pablo postmaster (1994−05−28 17:15:54.01 539) Receiving D.pabloB04c2<br>
uucico pablo postmaster (1994−05−28 17:15:57.17 539) Receiving X.pabloX04c1<br>
uucico pablo − (1994−05−28 17:15:59.05 539) Protocol 'g' packets: sent 15,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resent 0, received 32<br>
uucico pablo − (1994−05−28 17:16:02.50 539) Call complete (26 seconds)<br>
uuxqt pablo postmaster (1994−05−28 17:16:11.41 546) Executing X.pabloX04ai<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(rmail okir)<br>
uuxqt pablo postmaster (1994−05−28 17:16:13.30 546) Executing X.pabloX04as<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(rmail okir)<br>
uuxqt pablo postmaster (1994−05−28 17:16:13.51 546) Executing X.pabloX04c1<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(rmail okir)<br>
The next important log file is&nbsp;Stats, which lists file transfer statistics. The section of<br>Stats&nbsp;corresponding to the above transfer looks like this (again, the lines have been split to fit the page):<br>
postmaster pablo (1994−05−28 17:15:44.78)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; received 1714 bytes in 1.802 seconds (951 bytes/sec)<br>
postmaster pablo (1994−05−28 17:15:46.66)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; received 57 bytes in 0.634 seconds (89 bytes/sec)<br>
postmaster pablo (1994−05−28 17:15:49.91)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; received 1898 bytes in 1.599 seconds (1186 bytes/sec)<br>
postmaster pablo (1994−05−28 17:15:51.67)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; received 65 bytes in 0.555 seconds (117 bytes/sec)<br>
postmaster pablo (1994−05−28 17:15:55.71)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; received 3217 bytes in 2.254 seconds (1427 bytes/sec)<br>
postmaster pablo (1994−05−28 17:15:57.31)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; received 65 bytes in 0.590 seconds (110 bytes/sec)<br>
The third file is&nbsp;Debug. Debugging information is written here. If you use debugging, make sure this file has<br>protection mode 600. Depending on the debug mode you select, it may contain the login and password you<br>use to connect to the remote system.<br>
If you have some tools around that expect your log files to be in the traditional format used by<br>HDB−compatible UUCP implementations, you can also compile Taylor UUCP to produce HDB−style logs.<br>This is simply a matter of enabling a compile−time option in&nbsp;config.h.<br>
16.7. Log Files and Debugging<br>
332<br>
<hr>
<A name=349></a><b>Chapter 17. Electronic Mail</b><br>
Electronic mail transport has been one of the most prominent uses of networking since the first networks<br>were devised. Email started as a simple service that copied a file from one machine to another and appended<br>it to the recipient's&nbsp;<i>mailbox</i>&nbsp;file. The concept remains the same, although an ever−growing net, with its<br>complex routing requirements and its ever increasing load of messages, has made a more elaborate scheme<br>necessary.<br>
&nbsp;Various standards of mail exchange have been devised. Sites on the Internet adhere to one laid out in<br>RFC−822, augmented by some RFCs that describe a machine−independent way of transferring just about<br><i>anything</i>, including graphics, sound files, and special characters sets, by email.[105]&nbsp;CCITT has defined<br>another standard, X.400. It is still used in some large corporate and government environments, but is<br>progressively being retired.<br>
Quite a number of mail transport programs have been implemented for Unix systems. One of the best known<br>is&nbsp;<b>sendmail</b>, which was developed by Eric Allman at the University of California at Berkeley. Eric Allman<br>now offers&nbsp;<b>sendmail</b>&nbsp;through a commercial venture, but the program remains free software.&nbsp;<b>sendmail</b>&nbsp;is<br>supplied as the standard mail agent in some Linux distributions. We describe&nbsp;<b>sendmail</b>&nbsp;configuration in<br><a href="TLNAGs.html#363">Chapter 18.</a><br>
Linux also uses&nbsp;<b>Exim</b>, written by Philip Hazel of the University of Cambridge. We describe<br><b>Exim</b><a href="TLNAGs.html#398">&nbsp;configuration in&nbsp;Chapter 19.</a><br>
Compared to&nbsp;<b>sendmail</b>,&nbsp;<b>Exim</b>&nbsp;is rather young. For the vast bulk of sites with email requirements, their<br>capabilities are pretty close.<br>
Both&nbsp;<b>Exim</b>&nbsp;and&nbsp;<b>sendmail</b>&nbsp;support a set of configuration files that have to be customized for your system.<br>Apart from the information that is required to make the mail subsystem run (such as the local hostname),<br>there are many parameters that may be tuned.&nbsp;<b>sendmail</b>'s main configuration file is very hard to understand<br>at first. It looks as if your cat has taken a nap on your keyboard with the shift key pressed.<br><b>Exim</b>&nbsp;configuration files are more structured and easier to understand than&nbsp;<b>sendmail</b>'s.&nbsp;<b>Exim</b>, however,<br>does not provide direct support for UUCP and handles only domain addresses. Today that isn't as big a<br>limitation as it once might have been; most sites stay within&nbsp;<b>Exim</b>'s limitations. However, for most sites, the<br>work required in setting up either of them is roughly the same.<br>
<a href="TLNAGs.html#363">In this chapter, we deal with what email is and what issues administrators have to deal with.&nbsp;Chapter 18&nbsp;and<br></a><a href="TLNAGs.html#398">Chapter 19&nbsp;provide instructions on setting up&nbsp;</a><b>sendmail</b>&nbsp;and&nbsp;<b>Exim</b>&nbsp;and for the first time. The included<br>information should help smaller sites become operational, but there are several more options and you can<br>spend many happy hours in front of your computer configuring the fanciest features.<br>
Toward the end of this chapter we briefly cover setting up&nbsp;<b>elm</b>, a very common mail user agent on many<br>Unix−like systems, including Linux.<br>
For more information about issues specific to electronic mail on Linux, please refer to the Electronic Mail<br>HOWTO by Guylhem Aznar,[106]&nbsp;which is posted to comp.os.linux.answers regularly. The source<br>distributions of&nbsp;<b>elm</b>,&nbsp;<b>Exim</b>, and&nbsp;<b>sendmail</b>&nbsp;also contain extensive documentation that should answer most<br>questions on setting them up, and we provide references to this documentation in their respective chapters. If<br>you need general information on email, a number of RFCs deal with this topic. They are listed in the<br>bibliography at the end of the book.<br>
Chapter 17. Electronic Mail<br>
333<br>
<hr>
<A name=350></a><b>17.1. What Is a Mail Message?</b><br>
A mail message generally consists of a message body, which is the text of the message, and special<br>administrative data specifying recipients, transport medium, etc., like what you see when you look at a<br>physical letter's envelope.<br>
This administrative data falls into two categories. In the first category is any data that is specific to the<br>transport medium, like the address of sender and recipient. It is therefore called the&nbsp;<i>envelope</i>. It may be<br>transformed by the transport software as the message is passed along.<br>
The second variety is any data necessary for handling the mail message, which is not particular to any<br>transport mechanism, such as the message's subject line, a list of all recipients, and the date the message was<br>sent. In many networks, it has become standard to prepend this data to the mail message, forming the<br>so−called&nbsp;<i>mail header</i>. It is offset from the&nbsp;<i>mail body</i>&nbsp;by an empty line.[107]<br>
Most mail transport software in the Unix world use a header format outlined in RFC−822. Its original<br>purpose was to specify a standard for use on the ARPANET, but since it was designed to be independent<br>from any environment, it has been easily adapted to other networks, including many UUCP−based networks.<br>
RFC−822 is only the lowest common denominator, however. More recent standards have been conceived to<br>cope with growing needs such as data encryption, international character set support, and MIME<br>(Multipurpose Internet Mail Extensions, described in RFC−1341 and other RFCs).<br>
In all these standards, the header consists of several lines separated by an end−of−line sequence. A line is<br>made up of a field name, beginning in column one, and the field itself, offset by a colon and white space. The<br>format and semantics of each field vary depending on the field name. A header field can be continued across<br>a newline if the next line begins with a whitespace character such as tab. Fields can appear in any order.<br>
A typical mail header may look like this:<br>
Return−Path: &lt;ph10@cus.cam.ac.uk&gt;<br>
Received: ursa.cus.cam.ac.uk (cusexim@ursa.cus.cam.ac.uk [131.111.8.6])<br>
&nbsp; &nbsp; by al.animats.net (8.9.3/8.9.3/Debian 8.9.3−6) with ESMTP id WAA04654<br>
&nbsp; &nbsp; for &lt;terry@animats.net&gt;; Sun, 30 Jan 2000 22:30:01 +1100<br>
Received: from ph10 (helo=localhost) by ursa.cus.cam.ac.uk with local−smtp<br>
&nbsp; &nbsp; (Exim 3.13 #1) id 12EsYC−0001eF−00; Sun, 30 Jan 2000 11:29:52 +0000<br>
Date: Sun, 30 Jan 2000 11:29:52 +0000 (GMT)<br>
From: Philip Hazel &lt;ph10@cus.cam.ac.uk&gt;<br>
Reply−To: Philip Hazel &lt;ph10@cus.cam.ac.uk&gt;<br>
To: Terry Dawson &lt;terry@animats.net&gt;, Andy Oram &lt;andyo@oreilly.com&gt;<br>
Subject: Electronic mail chapter<br>
In−Reply−To: &lt;38921283.A58948F2@animats.net&gt;<br>
Message−ID: &lt;Pine.SOL.3.96.1000130111515.5800A−200000@ursa.cus.cam.ac.uk&gt;<br>
Usually, all necessary header fields are generated by the mailer interface you use, like&nbsp;<b>elm</b>,&nbsp;<b>pine</b>,&nbsp;<b>mush</b>, or<br><b>mailx</b>. However, some are optional and may be added by the user.&nbsp;<b>elm</b>, for example, allows you to edit part<br>of the message header. Others are added by the mail transport software. If you look into a local mailbox file,<br>you may see each mail message preceded by a From line (note: no colon). This is&nbsp;<i>not</i>&nbsp;an RFC−822 header;<br>it has been inserted by your mail software as a convenience to programs reading the mailbox. To avoid<br>potential trouble with lines in the message body that also begin with From, it has become standard<br>procedure to escape any such occurrence by preceding it with a &gt; character.<br>
17.1. What Is a Mail Message?<br>
334<br>
<hr>
<A name=351></a>Linux Network Administrators Guide<br>
This list is a collection of common header fields and their meanings:<br>
<i>From:</i><br>
This contains the sender's email address and possibly the real name. A complete zoo of formats is<br>used here.<br>
<i>To:</i><br>
This is a list of recipient email addresses. Multiple recipient addresses are separated by a comma.<br>
<i>Cc:</i><br>
This is a list of email addresses that will receive carbon copies of the message. Multiple recipient<br>addresses are separated by a comma.<br>
<i>Bcc:</i><br>
This is a list of email addresses that will receive carbon copies of the message. The key difference<br>between a Cc: and a Bcc: is that the addresses listed in a Bcc: will not appear in the header<br>of the mail messages delivered to any recipient. It's a way of alerting recipients that you've sent<br>copies of the message to other people without telling them who those others are. Multiple recipient<br>addresses are separated by a comma.<br>
<i>Subject:</i><br>
Describes the content of the mail in a few words.<br>
<i>Date:</i><br>
Supplies the date and time the mail was sent.<br>
<i>Reply−To:</i><br>
Specifies the address the sender wants the recipient's reply directed to. This may be useful if you<br>have several accounts, but want to receive the bulk of mail only on the one you use most frequently.<br>This field is optional.<br>
<i>Organization:</i><br>
The organization that owns the machine from which the mail originates. If your machine is owned by<br>you privately, either leave this out, or insert private or some complete nonsense. This field is not<br>described by any RFC and is completely optional. Some mail programs support it directly, many<br>don't.<br>
<i>Message−ID:</i><br>
A string generated by the mail transport on the originating system. It uniquely identifies this message.<br>
<i>Received:</i><br>
17.1. What Is a Mail Message?<br>
335<br>
<hr>
<A name=352></a>Linux Network Administrators Guide<br>
Every site that processes your mail (including the machines of sender and recipient) inserts such a<br>field into the header, giving its site name, a message ID, time and date it received the message, which<br>site it is from, and which transport software was used. These lines allow you to trace which route the<br>message took, and you can complain to the person responsible if something went wrong.<br>
<i>X−anything:</i><br>
No mail−related programs should complain about any header that starts with&nbsp;X−. It is used to<br>implement additional features that have not yet made it into an RFC, or never will. For example,<br>there was once a very large Linux mailing list server that allowed you to specify which channel you<br>wanted the mail to go to by adding the string&nbsp;<b>X−Mn−Key:</b>&nbsp;followed by the channel name.<br>
17.1. What Is a Mail Message?<br>
336<br>
<hr>
<A name=353></a><b>17.2. How Is Mail Delivered?</b><br>
Generally, you will compose mail using a mailer interface like&nbsp;<b>mail</b>&nbsp;or&nbsp;<b>mailx</b>, or more sophisticated ones like<br><b>mutt</b>,&nbsp;<b>tkrat</b>, or&nbsp;<b>pine</b>. These programs are called&nbsp;<i>mail user agents</i>, or MUAs. If you send a mail message, the<br>interface program will in most cases hand it to another program for delivery. This is called the&nbsp;<i>mail transport<br>agent</i>, or MTA. On most systems the same MTA is used for both local and remote delivery and is usually<br>invoked as&nbsp;<b>/usr/sbin/sendmail</b>, or on non−FSSTND compliant systems as&nbsp;<b>/usr/lib/sendmail</b>. On UUCP<br>systems it is not uncommon to see mail delivery handled by two separate programs:&nbsp;<b>rmail</b>&nbsp;for remote mail<br>delivery and&nbsp;<b>lmail</b>&nbsp;for local mail delivery.<br>
&nbsp;Local delivery of mail is, of course, more than just appending the incoming message to the recipient's<br>mailbox. Usually, the local MTA understands aliasing (setting up local recipient addresses pointing to other<br>addresses) and forwarding (redirecting a user's mail to some other destination). Also, messages that cannot be<br>delivered must usually be&nbsp;<i>bounced</i>, that is, returned to the sender along with some error message.<br>
&nbsp;For remote delivery, the transport software used depends on the nature of the link. Mail delivered over a<br>network using TCP/IP commonly uses&nbsp;<i>Simple Mail Transfer Protocol</i>&nbsp;(SMTP), which is described in<br>RFC−821. SMTP was designed to deliver mail directly to a recipient's machine, negotiating the message<br>transfer with the remote side's SMTP daemon. Today it is common practice for organizations to establish<br>special hosts that accept all mail for recipients in the organization and for that host to manage appropriate<br>delivery to the intended recipient.<br>
&nbsp;Mail is usually not delivered directly in UUCP networks, but rather is forwarded to the destination host by<br>a number of intermediate systems. To send a message over a UUCP link, the sending MTA usually executes<br><b>rmail</b>&nbsp;on the forwarding system using&nbsp;<b>uux</b>, and feeds it the message on standard input.<br>
&nbsp;Since&nbsp;<b>uux</b>&nbsp;is invoked for each message separately, it may produce a considerable workload on a major mail<br>hub, as well as clutter the UUCP spool queues with hundreds of small files taking up a disproportionate<br>amount of disk space.[108]&nbsp;Some MTAs therefore allow you to collect several messages for a remote system<br>in a single batch file. The batch file contains the SMTP commands that the local host would normally issue if<br>a direct SMTP connection were used. This is called BSMTP, or&nbsp;<i>batched</i>&nbsp;SMTP. The batch is then fed to the<br><b>rsmtp</b>&nbsp;or&nbsp;<b>bsmtp</b>&nbsp;program on the remote system, which processes the input almost as if a normal SMTP<br>connection has occurred.<br>
17.2. How Is Mail Delivered?<br>
337<br>
<hr>
<A name=354></a><b>17.3. Email Addresses</b><br>
Email addresses are made up of at least two parts. One part is the name of a&nbsp;<i>mail domain</i>&nbsp;that will ultimately<br>translate to either the recipient's host or some host that accepts mail on behalf of the recipient. The other part<br>is some form of unique user identification that may be the login name of that user, the real name of that user<br>in Firstname.Lastname format, or an arbitrary alias that will be translated into a user or list of users. Other<br>mail addressing schemes, like X.400, use a more general set of attributes that are used to look up the<br>recipient's host in an X.500 directory server.<br>
How email addresses are interpreted depends greatly on what type of network you use. We'll concentrate on<br>how TCP/IP and UUCP networks interpret email addresses.<br>
<b>17.3.1. RFC−822</b><br>
Internet sites adhere to the RFC−822 standard, which requires the familiar notation of user@host.domain, for<br>which host.domain is the host's fully qualified domain name. The character separating the two is properly<br>called a commercial at sign, but it helps if you read it as at. This notation does not specify a route to the<br>destination host. Routing of the mail message is left to the mechanisms we'll describe shortly.<br>
You will see a lot of RFC−822 if you run an Internet connected site. Its use extends not only to mail, but has<br>also spilled over into other services, such as news. We discuss how RFC−822 is used for news in&nbsp;<a href="TLNAGs.html#412">Chapter 20</a>.<br>
<b>17.3.2. Obsolete Mail Formats</b><br>
In the original UUCP environment, the prevalent form was path!host!user, for which path described a<br>sequence of hosts the message had to travel through before reaching the destination host. This construct is<br>called the&nbsp;<i>bang path</i>&nbsp;notation, because an exclamation mark is colloquially called a bang. Today, many<br>UUCP−based networks have adopted RFC−822 and understand domain−based addresses.<br>
Other networks have still different means of addressing. DECnet−based networks, for example, use two<br>colons as an address separator, yielding an address of host::user.[109]&nbsp;The X.400 standard uses an entirely<br>different scheme, describing a recipient by a set of attribute−value pairs, like country and organization.<br>
Lastly, on FidoNet, each user is identified by a code like 2:320/204.9, consisting of four numbers denoting<br>zone (2 is for Europe), net (320 being Paris and Banlieue), node (the local hub), and point (the individual<br>user's PC). Fidonet addresses can be mapped to RFC−822; the above, for example, would be written as<br>Thomas.Quinot@p9.f204.n320.z2.fidonet.org. Now didn't we say domain names were easy to remember?<br>
<b>17.3.3. Mixing Different Mail Formats</b><br>
It is inevitable that when you bring together a number of different systems and a number of clever people,<br>they will seek ways to interconnect the differing systems so they are capable of internetworking.<br>Consequently, there are a number of different mail gateways that are able to link two different email systems<br>together so that mail may be forwarded from one to another. Addressing is the critical question when linking<br>two systems. We won't look at the gateways themselves in any detail, but let's take a look at some of the<br>
17.3. Email Addresses<br>
338<br>
<hr>
<A name=355></a>Linux Network Administrators Guide<br>
addressing complications that may arise when gateways of this sort are used.<br>
Consider mixing the UUCP style bang−path notation and RFC−822. These two types of addressing don't mix<br>too well. Assume there is an address of domainA!user@domainB. It is not clear whether the @ sign takes<br>precedence over the path, or vice versa: do we have to send the message to domainB, which mails it to<br>domainA!user, or should it be sent to domainA, which forwards it to user@domainB?<br>
Addresses that mix different types of address operators are called&nbsp;<i>hybrid addresses</i>. The most common type,<br>which we just illustrated, is usually resolved by giving the @ sign precedence over the path. In<br>domainA!user@domainB, this means sending the message to domainB first.<br>
However, there is a way to specify routes in RFC−822 conformant ways:<br>&lt;@domainA,@domainB:user@domainC&gt; denotes the address of user on domainC, where domainC is to be<br>reached through domainA and domainB (in that order). This type of address is frequently called a&nbsp;<i>source<br>routed</i>&nbsp;address. It's not a good idea to rely on this behavior, as revisions to the RFCs describing mail routing<br>recommend that source routing in a mail address be ignored and instead an attempt should be made to deliver<br>directly to the remote destination.<br>
Then there is the % address operator: user%domainB@domainA is first sent to domainA, which expands<br>the rightmost (in this case, the only) percent sign to an @ sign. The address is now user@domainB, and the<br>mailer happily forwards your message to domainB, which delivers it to user. This type of address is<br>sometimes referred to as Ye Olde ARPAnet Kludge, and its use is discouraged.<br>
There are some implications to using these different types of addressing that will be described throughout the<br>following sections. In an RFC−822 environment, you should avoid using anything other than absolute<br>addresses, such as user@host.domain.<br>
17.3. Email Addresses<br>
339<br>
<hr>
<A name=356></a><b>17.4. How Does Mail Routing Work?</b><br>
The process of directing a message to the recipient's host is called&nbsp;<i>routing</i>. Apart from finding a path from the<br>sending site to the destination, it involves error checking and may involve speed and cost optimization.<br>
There is a big difference between the way a UUCP site handles routing and the way an Internet site does. On<br>the Internet, the main job of directing data to the recipient host (once it is known by its IP address) is done by<br>the IP networking layer, while in the UUCP zone, the route has to be supplied by the user or generated by the<br>mail transfer agent.<br>
<b>17.4.1. Mail Routing on the Internet</b><br>
On the Internet, the destination host's configuration determines whether any specific mail routing is<br>performed. The default is to deliver the message to the destination by first determining what host the message<br>should be sent to and then delivering it directly to that host. Most Internet sites want to direct all inbound<br>mail to a highly available mail server that is capable of handling all this traffic and have it distribute the mail<br>locally. To announce this service, the site publishes a so−called MX record for its local domain in its DNS<br>database. MX stands for&nbsp;<i>Mail Exchanger</i>&nbsp;and basically states that the server host is willing to act as a mail<br>forwarder for all mail addresses in the domain. MX records can also be used to handle traffic for hosts that<br>are not connected to the Internet themselves, like UUCP networks or FidoNet hosts that must have their mail<br>passed through a gateway.<br>
MX records are always assigned a&nbsp;<i>preference</i>. This is a positive integer. If several mail exchangers exist for<br>one host, the mail transport agent will try to transfer the message to the exchanger with the lowest preference<br>value, and only if this fails will it try a host with a higher value. If the local host is itself a mail exchanger for<br>the destination address, it is allowed to forward messages only to MX hosts with a lower preference than its<br>own; this is a safe way of avoiding mail loops. If there is no MX record for a domain, or no MX records left<br>that are suitable, the mail transport agent is permitted to see if the domain has an IP address associated with it<br>and attempt delivery directly to that host.<br>
Suppose that an organization, say Foobar, Inc., wants all its mail handled by its machine mailhub. It will then<br>have MX records like this in the DNS database:<br>
green.foobar.com. &nbsp; &nbsp; &nbsp; &nbsp;IN &nbsp; MX &nbsp; &nbsp; &nbsp;5 &nbsp; &nbsp;mailhub.foobar.com.<br>
This announces mailhub.foobar.com as a mail exchanger for green.foobar.com with a preference of 5. A host<br>that wishes to deliver a message to joe@green.foobar.com checks DNS and finds the MX record pointing at<br>mailhub. If there's no MX with a preference smaller than 5, the message is delivered to mailhub, which then<br>dispatches it to green.<br>
&nbsp;This is a very simple description of how MX records work. For more information on mail routing on the<br>Internet, refer to RFC−821, RFC−974, and RFC−1123.<br>
<b>17.4.2. Mail Routing in the UUCP World</b><br>
Mail routing on UUCP networks is much more complicated than on the Internet because the transport<br>software does not perform any routing itself. In earlier times, all mail had to be addressed using bang paths.<br>
17.4. How Does Mail Routing Work?<br>
340<br>
<hr>
<A name=357></a>Linux Network Administrators Guide<br>
Bang paths specified a list of hosts through which to forward the message, separated by exclamation marks<br>and followed by the user's name. To address a letter to a user called Janet on a machine named moria, you<br>would use the path eek!swim!moria!janet. This would send the mail from your host to eek, from there on to<br>swim, and finally to moria.<br>
The obvious drawback of this technique is that it requires you to remember much more about network<br>topology, fast links, etc. than Internet routing requires. Much worse than that, changes in the network<br>topologylike links being deleted or hosts being removedmay cause messages to fail simply because you<br>aren't aware of the change. And finally, in case you move to a different place, you will most likely have to<br>update all these routes.<br>
One thing, however, that made the use of source routing necessary was the presence of ambiguous<br>hostnames. For instance, assume there are two sites named moria, one in the U.S. and one in France. Which<br>site does moria!janet refer to now? This can be made clear by specifying what path to reach moria through.<br>
&nbsp;The first step in disambiguating hostnames was the founding of the UUCP Mapping Project. It is located at<br>Rutgers University and registers all official UUCP hostnames, along with information on their UUCP<br>neighbors and their geographic location, making sure no hostname is used twice. The information gathered by<br>the Mapping Project is published as the&nbsp;<i>Usenet Maps</i>, which are distributed regularly through Usenet. A<br>typical system entry in a map (after removing the comments) looks like this:[110]<br>
moria<br>
&nbsp; &nbsp; &nbsp; &nbsp; bert(DAILY/2),<br>
&nbsp; &nbsp; &nbsp; &nbsp; swim(WEEKLY)<br>
This entry says moria has a link to bert, which it calls twice a day, and swim, which it calls weekly. We will<br>return to the map file format in more detail later.<br>
&nbsp;Using the connectivity information provided in the maps, you can automatically generate the full paths<br>from your host to any destination site. This information is usually stored in the&nbsp;paths&nbsp;file, also called the<br><i>pathalias database</i>. Assume the maps state that you can reach bert through ernie; a pathalias entry for<br>moria generated from the previous map snippet may then look like this:<br>
moria &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ernie!bert!moria!%s<br>
If you now give a destination address of janet@moria.uucp, your MTA will pick the route shown above and<br>send the message to ernie with an envelope address of bert!moria!janet.<br>
&nbsp;Building a&nbsp;paths&nbsp;file from the full Usenet maps is not a very good idea, however. The information<br>provided in them is usually rather distorted and occasionally out of date. Therefore, only a number of major<br>hosts use the complete UUCP world maps to build their&nbsp;paths&nbsp;files. Most sites maintain routing information<br>only for sites in their neighborhood and send any mail to sites they don't find in their databases to a smarter<br>host with more complete routing information. This scheme is called&nbsp;<i>smart−host routing</i>. Hosts that have only<br>one UUCP mail link (so−called&nbsp;<i>leaf sites</i>) don't do any routing of their own; they rely entirely on their smart<br>host.<br>
<b>17.4.3. Mixing UUCP and RFC−822</b><br>
The best cure for the problems of mail routing in UUCP networks so far is the adoption of the domain name<br>system in UUCP networks. Of course, you can't query a name server over UUCP. Nevertheless, many UUCP<br>
17.4.3. Mixing UUCP and RFC−822<br>
341<br>
<hr>
<A name=358></a>Linux Network Administrators Guide<br>
sites have formed small domains that coordinate their routing internally. In the maps, these domains<br>announce one or two hosts as their mail gateways so that there doesn't have to be a map entry for each host in<br>the domain. The gateways handle all mail that flows into and out of the domain. The routing scheme inside<br>the domain is completely invisible to the outside world.<br>
This works very well with the smart−host routing scheme. Global routing information is maintained by the<br>gateways only; minor hosts within a domain get along with only a small, handwritten&nbsp;paths&nbsp;file that lists<br>the routes inside their domain and the route to the mail hub. Even the mail gateways do not need routing<br>information for every single UUCP host in the world anymore. Besides the complete routing information for<br>the domain they serve, they only need to have routes to entire domains in their databases now. For instance,<br>this pathalias entry will route all mail for sites in the sub.org domain to smurf:<br>
.sub.org &nbsp; &nbsp; &nbsp; &nbsp;swim!smurf!%s<br>
Mail addressed to claire@jones.sub.org will be sent to swim with an envelope address of smurf!jones!claire.<br>
The hierarchical organization of the domain namespace allows mail servers to mix more specific routes with<br>less specific ones. For instance, a system in France may have specific routes for subdomains of fr, but route<br>any mail for hosts in the us domain toward some system in the U.S. In this way, domain−based routing (as<br>this technique is called) greatly reduces the size of routing databases, as well as the administrative overhead<br>needed.<br>
The main benefit of using domain names in a UUCP environment, however, is that compliance with<br>RFC−822 permits easy gatewaying between UUCP networks and the Internet. Many UUCP domains<br>nowadays have a link with an Internet gateway that acts as their smart host. Sending messages across the<br>Internet is faster, and routing information is much more reliable because Internet hosts can use DNS instead<br>of the Usenet Maps.<br>
In order to be reachable from the Internet, UUCP−based domains usually have their Internet gateway<br>announce an MX record for them (MX records were described previously in the section&nbsp;<a href="TLNAGs.html#356">Section 17.4.1). For<br></a>instance, assume that moria belongs to the orcnet.org domain. gcc2.groucho.edu acts as its Internet gateway.<br>moria would therefore use gcc2 as its smart host so that all mail for foreign domains is delivered across the<br>Internet. On the other hand, gcc2 would announce an MX record for *.orcnet.org and deliver all incoming<br>mail for orcnet sites to moria. The asterisk in *.orcnet.org is a wildcard that matches all hosts in that domain<br>that don't have any other record associated with them. This should normally be the case for UUCP−only<br>domains.<br>
The only remaining problem is that the UUCP transport programs can't deal with fully qualified domain<br>names. Most UUCP suites were designed to cope with site names of up to eight characters, some even less,<br>and using nonalphanumeric characters such as dots is completely out of the question for most.<br>
Therefore, we need mapping between RFC−822 names and UUCP hostnames. This mapping is completely<br>implementation−dependent. One common way of mapping FQDNs to UUCP names is to use the pathalias<br>file:<br>
moria.orcnet.org &nbsp;ernie!bert!moria!%s<br>
This will produce a pure UUCP−style bang path from an address that specifies a fully qualified domain name.<br>Some mailers provide a special file for this;&nbsp;<b>sendmail</b>, for instance, uses the&nbsp;uucpxtable.<br>
17.4.3. Mixing UUCP and RFC−822<br>
342<br>
<hr>
<A name=359></a>Linux Network Administrators Guide<br>
The reverse transformation (colloquially called&nbsp;<i>domainizing</i>) is sometimes required when sending mail from<br>a UUCP network to the Internet. As long as the mail sender uses the fully qualified domain name in the<br>destination address, this problem can be avoided by not removing the domain name from the envelope<br>address when forwarding the message to the smart host. However, there are still some UUCP sites that are<br>not part of any domain. They are usually domainized by appending the pseudo−domain uucp.<br>
The pathalias database provides the main routing information in UUCP−based networks. A typical entry<br>looks like this (site name and path are separated by tabs):<br>
moria.orcnet.org &nbsp;ernie!bert!moria!%s<br>
moria &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ernie!bert!moria!%s<br>
This makes any message to moria be delivered via ernie and bert. Both moria's fully qualified name and its<br>UUCP name have to be given if the mailer does not have a separate way to map between these namespaces.<br>
&nbsp;If you want to direct all messages to hosts inside a domain to its mail relay, you may also specify a path in<br>the pathalias database, giving the domain name preceded by a dot as the target. For example, if all hosts in<br>sub.org can be reached through swim!smurf, the pathalias entry might look like this:<br>
.sub.org &nbsp; &nbsp; &nbsp; &nbsp;swim!smurf!%s<br>
Writing a pathalias file is acceptable only when you are running a site that does not have to do much routing.<br>If you have to do routing for a large number of hosts, a better way is to use the&nbsp;<b>pathalias</b>&nbsp;command to create<br>the file from map files. Maps can be maintained much more easily, because you may simply add or remove a<br>system by editing the system's map entry and recreating the map file. Although the maps published by the<br>Usenet Mapping Project aren't used for routing very much anymore, smaller UUCP networks may provide<br>routing information in their own set of maps.<br>
&nbsp;A map file mainly consists of a list of sites that each system polls or is polled by. The system name begins<br>in the first column and is followed by a comma−separated list of links. The list may be continued across<br>newlines if the next line begins with a tab. Each link consists of the name of the site followed by a cost given<br>in brackets. The cost is an arithmetic expression made up of numbers and symbolic expressions like DAILY<br>or WEEKLY. Lines beginning with a hash sign are ignored.<br>
As an example, consider moria, which polls swim.twobirds.com twice a day and bert.sesame.com once per<br>week. The link to bert uses a slow 2,400 bps modem. moria would publish the following maps entry:<br>
moria.orcnet.org<br>
&nbsp; &nbsp; &nbsp; &nbsp; bert.sesame.com(DAILY/2),<br>
&nbsp; &nbsp; &nbsp; &nbsp; swim.twobirds.com(WEEKLY+LOW)<br>
moria.orcnet.org = moria<br>
The last line makes moria known under its UUCP name, as well. Note that its cost must be specified as<br>DAILY/2 because calling twice a day actually halves the cost for this link.<br>
Using the information from such map files,&nbsp;<b>pathalias</b>&nbsp;is able to calculate optimal routes to any destination<br>site listed in the paths file and produce a pathalias database from this which can then be used for routing to<br>these sites.<br>
<b>pathalias</b>&nbsp;provides a couple of other features like site−hiding (i.e., making sites accessible only through a<br>
gateway). See the&nbsp;<b>pathalias</b>&nbsp;manual page for details and a complete list of link costs.<br>
17.4.3. Mixing UUCP and RFC−822<br>
343<br>
<hr>
<A name=360></a>Linux Network Administrators Guide<br>
Comments in the map file generally contain additional information on the sites described in it. There is a<br>rigid format in which to specify this information so that it can be retrieved from the maps. For instance, a<br>program called&nbsp;<b>uuwho</b>&nbsp;uses a database created from the map files to display this information in a nicely<br>formatted way. When you register your site with an organization that distributes map files to its members,<br>you generally have to fill out such a map entry. Below is a sample map entry (in fact, it's the one for Olaf's<br>site):<br>
#N &nbsp; &nbsp; &nbsp;monad, monad.swb.de, monad.swb.sub.org<br>
#S &nbsp; &nbsp; &nbsp;AT 486DX50; Linux 0.99<br>
#O &nbsp; &nbsp; &nbsp;private<br>
#C &nbsp; &nbsp; &nbsp;Olaf Kirch<br>
#E &nbsp; &nbsp; &nbsp;okir@monad.swb.de<br>
#P &nbsp; &nbsp; &nbsp;Kattreinstr. 38, D−64295 Darmstadt, FRG<br>
#L &nbsp; &nbsp; &nbsp;49 52 03 N / 08 38 40 E<br>
#U &nbsp; &nbsp; &nbsp;brewhq<br>
#W &nbsp; &nbsp; &nbsp;okir@monad.swb.de (Olaf Kirch); Sun Jul 25 16:59:32 MET DST 1993<br>
#<br>
monad &nbsp; brewhq(DAILY/2)<br>
# Domains<br>
monad = monad.swb.de<br>
monad = monad.swb.sub.org<br>
The whitespace after the first two characters is a tab. The meaning of most of the fields is pretty obvious; you<br>will receive a detailed description from whichever domain you register with. The L field is the most fun to<br>find out: it gives your geographical position in latitude/longitude and is used to draw the PostScript maps that<br>show all sites for each country, as well as worldwide.[111]<br>
17.4.3. Mixing UUCP and RFC−822<br>
344<br>
<hr>
<A name=361></a><b>17.5. Configuring elm</b><br>
<b>elm</b>&nbsp;stands for electronic mail and is one of the more reasonably named Unix tools. It provides a<br>full−screen interface with a good help feature. We won't discuss how to use&nbsp;<b>elm</b>&nbsp;here, but only dwell on its<br>configuration options.<br>
Theoretically, you can run&nbsp;<b>elm</b>&nbsp;unconfigured, and everything works wellif you are lucky. But there are a<br>few options that must be set, although they are required only on occasion.<br>
When it starts,&nbsp;<b>elm</b>&nbsp;reads a set of configuration variables from the&nbsp;elm.rc&nbsp;file in&nbsp;/etc/elm. Then it<br>attempts to read the file&nbsp;.elm/elmrc&nbsp;in your home directory. You don't usually write this file yourself. It is<br>created when you choose Save new options from&nbsp;<b>elm</b>'s options menu.<br>
The set of options for the private&nbsp;elmrc&nbsp;file is also available in the global&nbsp;elm.rc&nbsp;file. Most settings in<br>your private&nbsp;elmrc&nbsp;file override those of the global file.<br>
<b>17.5.1. Global elm Options</b><br>
In the global&nbsp;elm.rc&nbsp;file, you must set the options that pertain to your host's name. For example, at the<br>Virtual Brewery, the file for vlager contains the following:<br>
#<br>
# The local hostname<br>
hostname = vlager<br>
#<br>
# Domain name<br>
hostdomain = .vbrew.com<br>
#<br>
# Fully qualified domain name<br>
hostfullname = vlager.vbrew.com<br>
These options set&nbsp;<b>elm</b>'s idea of the local hostname. Although this information is rarely used, you should set<br>the options. Note that these particular options only take effect when giving them in the global configuration<br>file; when found in your private&nbsp;elmrc, they will be ignored.<br>
<b>17.5.2. National Character Sets</b><br>
A set of standards and RFCs have been developed that amend the RFC−822 standard to support various types<br>of messages, such as plain text, binary data, PostScript files, etc. These standards are commonly referred to as<br>MIME, or Multipurpose Internet Mail Extensions. Among other things, MIME also lets the recipient know if<br>a character set other than standard ASCII has been used when writing the message, for example, using French<br>accents or German umlauts.&nbsp;<b>elm</b>&nbsp;supports these characters to some extent.<br>
The character set used by Linux internally to represent characters is usually referred to as ISO−8859−1,<br>which is the name of the standard it conforms to. It is also known as Latin−1. Any message using characters<br>from this character set should have the following line in its header:<br>
Content−Type: text/plain; charset=iso−8859−1<br>
17.5. Configuring elm<br>
345<br>
<hr>
<A name=362></a>Linux Network Administrators Guide<br>
The receiving system should recognize this field and take appropriate measures when displaying the message.<br>The default for text/plain messages is a charset value of us−ascii.<br>
To be able to display messages with character sets other than ASCII,&nbsp;<b>elm</b>&nbsp;must know how to print these<br>characters. By default, when&nbsp;<b>elm</b>&nbsp;receives a message with a&nbsp;<i>charset</i>&nbsp;field other than us−ascii (or a content<br>type other than text/plain, for that matter), it tries to display the message using a command called&nbsp;<b>metamail</b>.<br>Messages that require&nbsp;<b>metamail</b>&nbsp;to be displayed are shown with an&nbsp;<b>M</b>&nbsp;in the very first column in the<br>overview screen.<br>
Since Linux's native character set is ISO−8859−1, calling&nbsp;<b>metamail</b>&nbsp;is not necessary to display messages<br>using this character set. If&nbsp;<b>elm</b>&nbsp;is told that the display understands ISO−8859−1, it will not use&nbsp;<b>metamail</b>, but<br>will display the message directly instead. This can be enabled by setting the following option in the global<br>elm.rc:<br>
displaycharset = iso−8859−1<br>
Note that you should set this option even when you are never going to send or receive any messages that<br>actually contain characters other than ASCII. This is because people who do send such messages usually<br>configure their mailer to put the proper&nbsp;Content−Type:&nbsp;field into the mail header by default, whether or<br>not they are sending ASCII−only messages.<br>
However, setting this option in&nbsp;elm.rc&nbsp;is not enough. When displaying the message with its built−in pager,<br><b>elm</b>&nbsp;calls a library function for each character to determine whether it is printable. By default, this function<br>will only recognize ASCII characters as printable and display all other characters as&nbsp;^?. You may overcome<br>this function by setting the environment variable LC_CTYPE to ISO−8859−1, which tells the library to<br>accept Latin−1 characters as printable. Support for this and other features have been available since Version<br>4.5.8 of the Linux standard library.<br>
When sending messages that contain special characters from ISO−8859−1, you should make sure to set two<br>more variables in the&nbsp;elm.rc&nbsp;file:<br>
charset = iso−8859−1<br>
textencoding = 8bit<br>
This makes&nbsp;<b>elm</b>&nbsp;report the character set as ISO−8859−1 in the mail header and send it as an 8−bit value (the<br>default is to strip all characters to 7−bit).<br>
Of course, all character set options we've discussed here may also be set in the private&nbsp;elmrc&nbsp;file instead of<br>the global one so individual users can have their own default settings if the global one doesn't suit them.<br>
17.5. Configuring elm<br>
346<br>
<hr>
<A name=363></a><b>Chapter 18. Sendmail</b><br>
Chapter 18. Sendmail<br>
347<br>
<hr>
<A name=364></a><b>18.1. Introduction to sendmail</b><br>
It's been said that you aren't a&nbsp;<i>real</i>&nbsp;Unix system administrator until you've edited a&nbsp;sendmail.cf&nbsp;file. It's<br>also been said that you're crazy if you've attempted to do so twice.<br>
<b>sendmail</b>&nbsp;is an incredibly powerful mail program. It's also incredibly difficult to learn and understand. Any<br>program whose definitive reference (<b>sendmail</b>, by Bryan Costales and Eric Allman, published by O'Reilly) is<br>1,050 pages long scares most people off. Information on the&nbsp;<b>sendmail</b>&nbsp;reference is contained in the<br>bibliography at the end of this book.<br>
Fortunately, new versions of sendmail are different. You no longer need to directly edit the cryptic<br>sendmail.cf&nbsp;file; the new version provides a configuration utility that will create the&nbsp;sendmail.cf&nbsp;file<br>for you based on much simpler macro files. You do not need to understand the complex syntax of the<br>sendmail.cf&nbsp;file; the macro files don't require you to. Instead, you need only list items, such as the name<br>of features you wish to include in your configuration, and specify some of the parameters that determine how<br>that feature operates. A traditional Unix utility called&nbsp;<b>m4</b>&nbsp;then takes your macro configuration data and mixes<br>it with the data it reads from template files containing the actual&nbsp;sendmail.cf&nbsp;syntax, to produce your<br>sendmail.cf&nbsp;file.<br>
In this chapter we introduce&nbsp;<b>sendmail</b>&nbsp;and describe how to install, configure and test it, using the Virtual<br>Brewery as an example. If the information presented here helps make the task of configuring&nbsp;<b>sendmail</b>&nbsp;less<br>daunting for you, we hope you'll gain the confidence to tackle more complex configurations on your own.<br>
18.1. Introduction to sendmail<br>
348<br>
<hr>
<A name=365></a><b>18.2. Installing sendmail</b><br>
&nbsp;The&nbsp;<b>sendmail</b>&nbsp;mail transport agent is included in prepackaged form in most Linux distributions. Installation<br>in this case is relatively simple. Despite this fact, there are some good reasons to install&nbsp;<b>sendmail</b>&nbsp;from<br>source, especially if you are security conscious. The&nbsp;<b>sendmail</b>&nbsp;program is very complex and has earned a<br>reputation over the years for containing bugs that allow security breaches. One of the best known examples is<br>the RTM Internet worm that exploited a buffer overflow problem in early versions of&nbsp;<b>sendmail</b>. We touched<br>on this briefly in&nbsp;<a href="TLNAGs.html#183">Chapter 9. Most security exploits involving buffer overflows rely on all copies of<br></a><b>sendmail</b>&nbsp;on different machines being identical, as the exploits rely on data being stored in specific locations.<br>This, of course, is precisely what happens with&nbsp;<b>sendmail</b>&nbsp;installed from Linux distributions. Compiling<br><b>sendmail</b>&nbsp;from source yourself can help reduce this risk. Modern versions of&nbsp;<b>sendmail</b>&nbsp;are less vulnerable<br>because they have come under exceedingly close scrutiny as security has become a more widespread concern<br>throughout the Internet community.<br>
The&nbsp;<b>sendmail</b>&nbsp;source code is available via anonymous FTP from ftp.sendmail.org.<br>
Compilation is very simple bceause the&nbsp;<b>sendmail</b>&nbsp;source package directly supports Linux. The steps involved<br>in compiling&nbsp;<b>sendmail</b>&nbsp;are:<br>
<b># cd /usr/local/src</b><br>
<b># tar xvfz sendmail.8.9.3.tar.gz</b><br>
<b># cd src</b><br>
<b># ./Build</b><br>
You need&nbsp;root&nbsp;permissions to complete the installation of the resulting binary files using:<br>
<b># cd obj.Linux.2.0.36.i586</b><br>
<b># make install</b><br>
You have now installed the&nbsp;<b>sendmail</b>&nbsp;binary into the&nbsp;/usr/sbin&nbsp;directory. Several symbolic links to the<br><b>sendmail</b>&nbsp;binary will be installed into the&nbsp;/usr/bin/&nbsp;directory. We'll talk about those links when we<br>discuss common tasks in running&nbsp;<b>sendmail</b>.<br>
18.2. Installing sendmail<br>
349<br>
<hr>
<A name=366></a><b>18.3. Overview of Configuration Files</b><br>
&nbsp;Traditionally,&nbsp;<b>sendmail</b>&nbsp;was set up through a system configuration file (typically called<br>/etc/mail/sendmail.cf, or in older distributions,&nbsp;/etc/sendmail.cf, or even<br>/usr/lib/sendmail.cf) that is not anything close to any language you've seen before. Editing the<br>sendmail.cf&nbsp;file to provide customized behavior can be a humbling experience.<br>
Today&nbsp;<b>sendmail</b>&nbsp;makes all configuration options macro driven with an easy−to−understand syntax. The<br>macro method generates configurations to cover most installations, but you always have the option of tuning<br>the resultant&nbsp;sendmail.cf&nbsp;manually to work in a more complex environment.<br>
18.3. Overview of Configuration Files<br>
350<br>
<hr>
<A name=367></a><b>18.4. The sendmail.cf and sendmail.mc Files</b><br>
&nbsp;The&nbsp;<b>m4</b>&nbsp;macro processor program generates the&nbsp;sendmail.df&nbsp;file when it processes the macro<br>configuration file provided by the local system administrator. Throughout the remainder of this chapter we<br>will refer to this configuration file as the&nbsp;sendmail.mc&nbsp;file.<br>
The configuration process is basically a matter of creating a suitable&nbsp;sendmail.mc&nbsp;file that includes<br>macros that describe your desired configuration. The macros are expressions that the&nbsp;<b>m4</b>&nbsp;macro processor<br>understands and expands into the complex&nbsp;sendmail.cf&nbsp;syntax. The macro expressions are made up of<br>the macro name (the text in capital letters at the start), which can be likened to a function in a programming<br>language, and some parameters (the text within brackets) that are used in the expansion. The parameters may<br>be passed literally into the&nbsp;sendmail.cf&nbsp;output or may be used to govern the way the macro processing<br>occurs.<br>
A&nbsp;sendmail.mc&nbsp;file for a minimal configuration (UUCP or SMTP with all nonlocal mail being relayed to<br>a directly connected smart host) can be as short as 10 or 15 lines, excluding comments.<br>
<b>18.4.1. Two Example sendmail.mc Files</b><br>
If you're an administator of a number of different mail hosts, you might not want to name your<br>configuration file&nbsp;sendmail.mc. Instead, it is common practice to name it after the hostvstout.m4&nbsp;in<br>our case. The name doesn't really matter as long as the output is called&nbsp;sendmail.cf. Providing a unique<br>name for the configuration file for each host allows you to keep all configuration files in the same directory<br>and is just an administrative convenience. Let's look at two example macro configuration files so we know<br>where we are heading.<br>
Most&nbsp;<b>sendmail</b>&nbsp;configurations today use SMTP only. It is very simple to configure&nbsp;<b>sendmail</b>&nbsp;for SMTP.<br><a href="TLNAGs.html#367">Example 18−1&nbsp;expects a DNS name server to be available to resolve hosts and will attempt to accept and<br></a>deliver all mail for hosts using just SMTP.<br>
<b>Example 18−1. Sample Configuration File vstout.smtp.m4</b><br>
divert(−1)<br>
#<br>
# Sample configuration file for vstout − smtp only<br>
#<br>
divert(0)<br>
VERSIONID(`@(#)sendmail.mc &nbsp; &nbsp; &nbsp;8.7 (Linux) 3/5/96')<br>
OSTYPE(`linux')<br>
#<br>
# Include support for the local and smtp mail transport protocols.<br>
MAILER(`local')<br>
MAILER(`smtp')<br>
#<br>
FEATURE(rbl)<br>
FEATURE(access_db)<br>
# end<br>
A&nbsp;sendmail.mc&nbsp;file for vstout at the Virtual Brewery is shown in&nbsp;<a href="TLNAGs.html#368">Example 18−2. vstout uses SMTP to talk<br></a>to all hosts on the Brewery's LAN, and you'll see the commonality with the generic SMTP−only<br>
18.4. The sendmail.cf and sendmail.mc Files<br>
351<br>
<hr>
<A name=368></a>Linux Network Administrators Guide<br>
configuration just presented. In addition, the vstout configuration sends all mail for other destinations to<br>moria, its Internet relay host, via UUCP.<br>
<b>Example 18−2. Sample Configuration File vstout.uucpsmtp.m4</b><br>
divert(−1)<br>
#<br>
# Sample configuration file for vstout<br>
#<br>
divert(0)<br>
VERSIONID(`@(#)sendmail.mc &nbsp; &nbsp; &nbsp;8.7 (Linux) 3/5/96')<br>
OSTYPE(`linux')<br>
dnl<br>
# moria is our smart host, using the &quot;uucp−new&quot; transport.<br>
define(`SMART_HOST', `uucp−new:moria')<br>
dnl<br>
# Support the local, smtp and uucp mail transport protocols.<br>
MAILER(`local')<br>
MAILER(`smtp')<br>
MAILER(`uucp')<br>
LOCAL_NET_CONFIG<br>
# This rule ensures that all local mail is delivered using the<br>
# smtp transport, everything else will go via the smart host.<br>
R$* &lt; @ $* .$m. &gt; $* &nbsp; &nbsp;$#smtp $@ $2.$m. $: $1 &lt; @ $2.$m. &gt; $3<br>
dnl<br>
#<br>
FEATURE(rbl)<br>
FEATURE(access_db)<br>
# end<br>
If you compare and contrast the two configurations, you might be able to work out what each of the<br>configuration parameters does. We'll explain them all in detail.<br>
<b>18.4.2. Typically Used sendmail.mc Parameters</b><br>
&nbsp;A few of the items in the&nbsp;sendmail.mc&nbsp;file are required all the time; others can be ignored if you can get<br>away with defaults. The general sequence of the definitions in the&nbsp;sendmail.mc&nbsp;is as follows:<br>
VERSIONID<br>
1.&nbsp;<br>
OSTYPE<br>
2.&nbsp;<br>
DOMAIN<br>
3.&nbsp;<br>
FEATURE<br>
4.&nbsp;<br>
Local macro definitions<br>
5.&nbsp;<br>
MAILER<br>
6.&nbsp;<br>
LOCAL_* rulesets<br>
7.&nbsp;<br>
<a href="TLNAGs.html#367">We'll talk about each of these in turn in the following sections and refer to our examples in&nbsp;Example<br>18−1&nbsp;and&nbsp;</a><a href="TLNAGs.html#368">Example 18−2, when appropriate, to explain them.</a><br>
18.4.2. Typically Used sendmail.mc Parameters<br>
352<br>
<hr>
<A name=369></a>Linux Network Administrators Guide<br>
<b>18.4.2.1. Comments</b><br>
Lines in the&nbsp;sendmail.mc&nbsp;file that begin with the&nbsp;#&nbsp;character are not parsed by&nbsp;<b>m4</b>, and will by default be<br>output directly into the&nbsp;sendmail.cf&nbsp;file. This is useful if you want to comment on what your<br>configuration is doing in both the input and output files.<br>
To allow comments in your&nbsp;sendmail.mc&nbsp;that are&nbsp;<i>not</i>&nbsp;placed into the&nbsp;sendmail.cf, you can use the<br><b>m4</b>&nbsp;divert and dnl tokens. divert(−1) will cause all output to cease. divert(0) will cause output to be restored<br>to the default. Any output generated by lines between these will be discarded. In our example, we've used this<br>mechanism to provide a comment that appears only in the&nbsp;sendmail.mc&nbsp;file. To achieve the same result<br>for a single line, you can use the dnl token that means, literally, starting at the beginning of the next line,<br>delete all characters up to and including the next newline. We've used this in our example, too.<br>
These are standard&nbsp;<b>m4</b>&nbsp;features, and you can obtain more information on them from its manual page.<br>
<b>18.4.2.2. VERSIONID and OSTYPE</b><br>
VERSIONID(`@(#)sendmail.mc &nbsp;8.9 (Linux) 01/10/98')<br>
The&nbsp;VERSIONID&nbsp;macro is optional, but is useful to record the version of the sendmail configuration in the<br>sendmail.cf&nbsp;file. So you'll often encounter it, and we recommend it. In any case, be sure to include:<br>
OSTYPE(`linux')<br>
This is probably the most important definition. The&nbsp;OSTYPE&nbsp;macro causes a file of definitions to be included<br>that are good defaults for your operating system. Most of the definitions in an&nbsp;OSTYPE&nbsp;macro file set the<br>pathnames of various configuration files, mailer program paths and arguments, and the location of directories<br>sendmail uses to store messages. The standard sendmail source code release includes such a file for Linux,<br>which would be included by the previous example. Some Linux distributions, notably the Debian<br>distribution, include their own definition file that is completely Linux−FHS compliant. When your<br>distribution does this, you should probably use its definition instead of the Linux default one.<br>
The OSTYPE definition should be one of the first definitions to appear in your&nbsp;sendmail.mc&nbsp;file, as many<br>other definitions depend upon it.<br>
<b>18.4.2.3. DOMAIN</b><br>
The DOMAIN macro is useful when you wish to configure a large number of machines on the same<br>network in a standard way. It you're configuring a small number of hosts, it probably isn't worth bothering<br>with. You typically configure items, such as the name of mail relay hosts or hubs that all hosts on your<br>network will use.<br>
The standard installation contains a directory of&nbsp;<b>m4</b>&nbsp;macro templates used to drive the configuration process.<br>This directory is usually named&nbsp;/usr/share/sendmail.cf&nbsp;or something similar. Here you will find a<br>subdirectory called&nbsp;domain&nbsp;that contains domain−specific configuration templates. To make use of the<br>DOMAIN macro, you must create your own macro file containing the standard definitions you require for<br>
18.4.2.1. Comments<br>
353<br>
<hr>
<A name=370></a>Linux Network Administrators Guide<br>
your site, and write it into the&nbsp;domain&nbsp;subdirectory. You'd normally include only the macro definitions that<br>were unique to your domain here, such as smart host definitions or relay hosts, but you are not limited to<br>these.<br>
The&nbsp;<b>sendmail</b>&nbsp;source distribution comes with a number of sample domain macro files that you can use to<br>model your own.<br>
If you saved your domain macro file as&nbsp;/usr/share/sendmail.cf/domain/vbrew.m4, you'd<br>include definitions in your&nbsp;sendmail.mc&nbsp;using:<br>
DOMAIN(`vbrew')<br>
<b>18.4.2.4. FEATURE</b><br>
The FEATURE macro enables you to include predefined&nbsp;<b>sendmail</b>&nbsp;features in your configuration. These<br><b>sendmail</b>&nbsp;features make the supported configurations very simple to use. There are a large number, and<br>throughout this chapter we'll talk about only a few of the more useful and important ones. You can find full<br>details of the features available in the&nbsp;CF&nbsp;file included in the source package.<br>
To use any of the features listed, you should include a line in your&nbsp;sendmail.mc&nbsp;that looks like:<br>
FEATURE(<i>name</i>)<br>
where&nbsp;<i>name</i>&nbsp;is substituted with the feature name. Some features take one optional parameter. If you wish to<br>use something other than the default, you should use an entry that looks like:<br>
FEATURE(<i>name</i>,&nbsp;<i>param</i>)<br>
where&nbsp;<i>param</i>&nbsp;is the parameter to supply.<br>
<b>18.4.2.5. Local macro definitions</b><br>
The standard&nbsp;<b>sendmail</b>&nbsp;macro configuration files provide lots of hooks and variables with which you can<br>customize your configuration. These are called&nbsp;<b>local macro definitions</b>. Many of them are listed in the<br>CF&nbsp;file in the&nbsp;<b>sendmail</b>&nbsp;source package.<br>
The local macro definitions are usually invoked by supplying the name of the macro with an argument<br>representing the value you wish to assign to the variable the macro manages. Again, we'll explore some of the<br>more common local macro definitions in the examples we present later in the chapter.<br>
<b>18.4.2.6. Defining mail transport protocols</b><br>
If you want&nbsp;<b>sendmail</b>&nbsp;to transport mail in any way other than by local delivery, you must tell it which<br>transports to use. The&nbsp;MAILER&nbsp;macro makes this very easy. The current version of&nbsp;<b>sendmail</b>&nbsp;supports a<br>variety of mail transport protocols; some of these are experimental, others are probably rarely used.<br>
18.4.2.4. FEATURE<br>
354<br>
<hr>
<A name=371></a>Linux Network Administrators Guide<br>
In our network we need the SMTP transport to send and receive mail among the hosts on our local area<br>network, and the UUCP transport to send and receive mail from our smart host. To achieve this, we simply<br>include both the&nbsp;smtp&nbsp;and&nbsp;uucp&nbsp;mail transports. The&nbsp;local&nbsp;mail transport is included by default, but may<br>be defined for clarity, if you wish. If you are including both the&nbsp;smtp&nbsp;and the&nbsp;uucp&nbsp;mailers in your<br>configuration, you must always be sure to define the&nbsp;smtp&nbsp;mailer first.<br>
The more commonly used transports available to you using the MAILER macro are described in the<br>following list:<br>
<i>local</i><br>
This transport includes both the local delivery agent used to send mail into the mailbox of users on<br>this machine and the prog mailer used to send messages to local programs. This transport is included<br>by default.<br>
<i>smtp</i><br>
This transport implements the Simple Mail Transport Protocol (SMTP), which is the most common<br>means of transporting mail on the Internet. When you include this transport, four mailers are<br>configured:&nbsp;smtp&nbsp;(basic SMTP),&nbsp;esmtp&nbsp;(Extended SMTP),&nbsp;smtp8&nbsp;(8bit binary clean SMTP), and<br>relay&nbsp;(specifically designed for gatewaying messages between hosts).<br>
<i>uucp</i><br>
The uucp transport provides support for two mailers: uucp−old, which is the traditional UUCP, and<br>uucp−new, which allows multiple recipients to be handled in one transfer.<br>
<i>usenet</i><br>
This mailer allows you to send mail messages directly into Usenet style news networks. Any local<br>message directed to an address of&nbsp;<i>news.group.usenet</i>&nbsp;will be fed into the news network for the<br><i>news.group</i>&nbsp;newsgroup.<br>
<i>fax</i><br>
If you have the HylaFAX software installed, this mailer will allow you to direct email to it so that<br>you may build an email−fax gateway. This feature is experimental at the time of writing and more<br>information may be obtained from http://www.vix.com/hylafax/.<br>
There are others, such as the pop, procmail, mail11, phquery, and cyrus that are useful, but less common. If<br>your curiosity is piqued, you can read about these in the sendmail book or the documentation supplied in the<br>source package.<br>
<b>18.4.2.7. Configure mail routing for local hosts</b><br>
The Virtual Brewery's configuration is probably more complex than most sites require. Most sites today<br>would use the SMTP transport only and do not have to deal with UUCP at all. In our configuration we've<br>configured a smart host that is used to handle all outgoing mail. Since we are using the SMTP transport on<br>our local network we must tell&nbsp;<b>sendmail</b>&nbsp;that it is not to send local mail via the smart host. The<br>
18.4.2.7. Configure mail routing for local hosts<br>
355<br>
<hr>
<A name=372></a>Linux Network Administrators Guide<br>
LOCAL_NET_CONFIG&nbsp;macro allows you to insert sendmail rules directly into the output&nbsp;sendmail.cf&nbsp;to<br>modify the way that local mail is handled. We'll talk more about rewrite rules later on, but for the moment<br>you should accept that the rule we've supplied in our example specifies that any mail destined for hosts in the<br>vbrew.com domain should be delivered directly to the target hosts using the SMTP mail transport.<br>
18.4.2.7. Configure mail routing for local hosts<br>
356<br>
<hr>
<A name=373></a><b>18.5. Generating the sendmail.cf File</b><br>
When you have completed editing your&nbsp;<b>m4</b>&nbsp;configuration file, you must process it to produce the<br>/etc/mail/sendmail.cf&nbsp;file read by&nbsp;<b>sendmail</b>. This is straightforward, as illustrated by the following<br>example:<br>
#&nbsp;<b>cd /etc/mail</b><br>
#&nbsp;<b>m4 /usr/share/sendmail.cf/m4/cf.m4 vstout.uucpsmtp.mc &gt;sendmail.cf</b><br>
This command invokes the&nbsp;<b>m4</b>&nbsp;macro processor, supplying it the name of two macro definition files to<br>process.&nbsp;<b>m4</b>&nbsp;processes the files in the order given. The first file is a standard&nbsp;<b>sendmail</b>&nbsp;macro template<br>supplied with the&nbsp;<b>sendmail</b>&nbsp;source package, the second, of course, is the file containing our own macro<br>definitions. The output of the command is directed to the&nbsp;/etc/mail/sendmail.cf&nbsp;file, which is our<br>target file.<br>
You may now start&nbsp;<b>sendmail</b>&nbsp;with the new configuration.<br>
18.5. Generating the sendmail.cf File<br>
357<br>
<hr>
<A name=374></a><b>18.6. Interpreting and Writing Rewrite Rules</b><br>
&nbsp;Arguably the most powerful feature of&nbsp;<b>sendmail</b>&nbsp;is the rewrite rule. Rewrite rules are used by&nbsp;<b>sendmail</b>&nbsp;to<br>determine how to process a received mail message.&nbsp;<b>sendmail</b>&nbsp;passes the addresses from the&nbsp;<i>headers</i>&nbsp;of a mail<br>message through collections of rewrite rules called&nbsp;<i>rulesets</i>&nbsp;The rewrite rules transform a mail address from<br>one form to another and you can think of them as being similar to a command in your editor that replaces all<br>text matching a specified pattern with another.<br>
Each rule has a lefthand side and a righthand side, separated by at least one tab character. When&nbsp;<b>sendmail</b>&nbsp;is<br>processing mail it scans through the rewriting rules looking for a match on the lefthand side. If an address<br>matches the lefthand side of a rewrite rule, the address is replaced by the righthand side and processed again.<br>
<b>18.6.1. sendmail.cf R and S Commands</b><br>
In the&nbsp;sendmail.cf&nbsp;file, the rulesets are defined using commands coded as&nbsp;S<i>n</i>, where&nbsp;<i>n</i>&nbsp;specifies the<br>ruleset that is considered the current one.<br>
The rules themselves appear in commands coded as&nbsp;<b>R</b>. As each&nbsp;<b>R</b>&nbsp;command is read, it is added to the current<br>ruleset.<br>
If you're dealing only with the&nbsp;sendmail.mc&nbsp;file, you won't need to worry about&nbsp;<b>S</b>&nbsp;commands at all, as the<br>macros will build those for you. You will need to manually code your&nbsp;<b>R</b>&nbsp;rules.<br>
A&nbsp;<b>sendmail</b>&nbsp;ruleset therefore looks like:<br>
S<i>n</i><br>
R<i>lhs&nbsp;rhs</i><br>
R<i>lhs2&nbsp;rhs2</i><br>
<b>18.6.2. Some Useful Macro Definitions</b><br>
<b>sendmail</b>&nbsp;uses a number of standard macro definitions internally. The most useful of these in writing rulesets<br>are:<br>
<i>$j</i><br>
The fully qualified domain name of this host.<br>
<i>$w</i><br>
The hostname component of the FQDN.<br>
<i>$m</i><br>
The domain name component of the FQDN.<br>
18.6. Interpreting and Writing Rewrite Rules<br>
358<br>
<hr>
<A name=375></a>Linux Network Administrators Guide<br>
We can incorporate these macro definitions in our rewrite rules. Our Virtual Brewery configuration uses the<br>$m&nbsp;macro.<br>
<b>18.6.3. The Lefthand Side</b><br>
In the lefthand side of a rewriting rule, you specify a pattern that will match an address you wish to<br>transform. Most characters are matched literally, but there are a number of characters that have special<br>meaning; these are described in the following list. The rewrite rules for the lefthand side are:<br>
<i>$@</i><br>
Match exactly zero tokens<br>
<i>$*</i><br>
Match zero or more tokens<br>
<i>$+</i><br>
Match one or more tokens<br>
<i>$−</i><br>
Match exactly one token<br>
<i>$=x</i><br>
Match any phrase in class&nbsp;<i>x</i><br>
<i>$~x</i><br>
Match any word not in class&nbsp;<i>x</i><br>
A token is a string of characters delimited by spaces. There is no way to include spaces in a token, nor is it<br>necessary, as the expression patterns are flexible enough to work around this need. When a rule matches an<br>address, the text matched by each of the patterns in the expression will be assigned to special variables that<br>we'll use in the righthand side. The only exception to this is the&nbsp;$@, which matches no tokens and therefore<br>will never generate text to be used on the righthand side.<br>
<b>18.6.4. The Righthand Side</b><br>
When the lefthand side of a rewrite rule matches an address, the original text is deleted and replaced by the<br>righthand side of the rule. All tokens in the righthand side are copied literally, unless they begin with a dollar<br>sign. Just as for the lefthand side, a number of metasymbols may be used on the righthand side. These are<br>described in the following list. The rewrite rules for the righthand side are:<br>
<i>$n</i><br>
18.6.3. The Lefthand Side<br>
359<br>
<hr>
<A name=376></a>Linux Network Administrators Guide<br>
This metasymbol is replaced with the&nbsp;<i>n</i>'th expression from the lefthand side.<br>
<i>$[name$]</i><br>
This metasymbol resolves hostname to canonical name. It is replaced by the canonical form of the<br>host name supplied.<br>
<i>$(map key $@arguments $:default $)</i><br>
This is the more general form of lookup. The output is the result of looking up&nbsp;<i>key</i>&nbsp;in the map<br>named&nbsp;<i>map</i>&nbsp;passing&nbsp;<i>arguments</i>&nbsp;as arguments. The&nbsp;<i>map</i>&nbsp;can be any of the maps that<br><b>sendmail</b>&nbsp;supports such as the&nbsp;virtusertable&nbsp;that we describe a little later. If the lookup is<br>unsuccessful,&nbsp;<i>default</i>&nbsp;will be output. If a default is not supplied and lookup fails, the input is<br>unchanged and&nbsp;<i>key</i>&nbsp;is output.<br>
<i>$&gt;n</i><br>
This will cause the rest of this line to be parsed and then given to ruleset&nbsp;<i>n</i>&nbsp;to evaluate. The output of<br>the called ruleset will be written as output to this rule. This is the mechanism that allows rules to call<br>other rulesets.<br>
<i>$#mailer</i><br>
This metasymbol causes ruleset evaluation to halt and specifies the mailer that should be used to<br>transport this message in the next step of its delivery. This metasymbol should be called only from<br>ruleset 0 or one of its subroutines. This is the final stage of address parsing and should be<br>accompanied by the next two metasymbols.<br>
<i>$@host</i><br>
This metasymbol specifies the host that this message will be forwarded to. If the destination host is<br>the local host, it may be omitted. The&nbsp;<i>host</i>&nbsp;may be a colon−separated list of destination hosts that<br>will be tried in sequence to deliver the message.<br>
<i>$:user</i><br>
This metasymbol specifies the target user for the mail message.<br>
A rewrite rule that matches is normally tried repeatedly until it fails to match, then parsing moves on to the<br>next rule. This behavior can be changed by preceding the righthand side with one of two special righthand<br>side metaymbols described in the following list. The rewrite rules for a righthand side loop control<br>metasymbols are:<br>
<i>$@</i><br>
This metasymbol causes the ruleset to return with the remainder of the righthand side as the value.<br>No other rules in the ruleset are evaluated.<br>
<i>$:</i><br>
18.6.3. The Lefthand Side<br>
360<br>
<hr>
<A name=377></a>Linux Network Administrators Guide<br>
This metasymbol causes this rule to terminate immediately, but the rest of the current ruleset is<br>evaluated.<br>
<b>18.6.5. A Simple Rule Pattern Example</b><br>
To better see how the macro substitution patterns operate, consider the following rule lefthand side:<br>
$* &lt; $+ &gt;<br>
This rule matches Zero or more tokens, followed by the &lt; character, followed by one or more tokens,<br>followed by the &gt; character.<br>
If this rule were applied to&nbsp;brewer@vbrew.com&nbsp;or&nbsp;Head Brewer &lt; &gt;, the rule would not match. The<br>first string would not match because it does not include a &lt; character, and the second would fail because<br>$+&nbsp;matches&nbsp;<i>one or more</i>&nbsp;tokens and there are no tokens between the&nbsp;&lt;&gt;&nbsp;characters. In any case in which a<br>rule does not match, the righthand side of the rule is not used.<br>
If the rule were applied to&nbsp;Head Brewer &lt; brewer@vbrew.com &gt;, the rule would match, and on the<br>righthand side&nbsp;$1&nbsp;would be substituted with&nbsp;Head Brewer&nbsp;and&nbsp;$2&nbsp;would be substituted with<br>brewer@vbrew.com.<br>
If the rule were applied to&nbsp;&lt; brewer@vbrew.com &gt;&nbsp;the rule would match because&nbsp;$*&nbsp;matches&nbsp;<i>zero</i>&nbsp;or<br>more tokens, and on the righthand side&nbsp;$1&nbsp;would be substituted with the empty string.<br>
<b>18.6.6. Ruleset Semantics</b><br>
&nbsp;Each of the&nbsp;<b>sendmail</b>&nbsp;rulesets is called upon to perform a different task in mail processing. When you are<br>writing rules, it is important to understand what each of the rulesets are expected to do. We'll look at each of<br>the rulesets that the&nbsp;<b>m4</b>&nbsp;configuration scripts allow us to modify:<br>
<i>LOCAL_RULE_3</i><br>
Ruleset 3 is responsible for converting an address in an arbitrary format into a common format that<br><b>sendmail</b>&nbsp;will then process. The output format expected is the familiar looking<br><i>local−part</i>@<i>host−domain−spec</i>.<br>
Ruleset 3 should place the hostname part of the converted address inside the&nbsp;&lt;&nbsp;and&nbsp;&gt;&nbsp;characters to<br>make parsing by later rulesets easier. Ruleset 3 is applied before&nbsp;<b>sendmail</b>&nbsp;does any other processing<br>of an email address, so if you want&nbsp;<b>sendmail</b>&nbsp;to gateway mail from some system that uses some<br>unusual address format, you should add a rule using the&nbsp;LOCAL_RULE_3&nbsp;macro to convert<br>addresses into the common format.<br>
<i>LOCAL_RULE_0 and LOCAL_NET_CONFIG</i><br>
&nbsp;Ruleset 0 is applied to recipient addresses by&nbsp;<b>sendmail</b>&nbsp;after Ruleset 3. The<br>LOCAL_NET_CONFIG&nbsp;macro causes rules to be inserted into the&nbsp;<i>bottom half</i>&nbsp;of Ruleset 0.<br>
18.6.5. A Simple Rule Pattern Example<br>
361<br>
<hr>
<A name=378></a>Linux Network Administrators Guide<br>
Ruleset 0 is expected to perform the delivery of the message to the recipient, so it must resolve to a<br>triple that specifies each of the mailer, host, and user. The rules will be placed before any smart host<br>definition you may include, so if you add rules that resolve addresses appropriately, any address that<br>matches a rule will not be handled by the smart host. This is how we handle the direct&nbsp;<b>smtp</b>&nbsp;for the<br>users on our local LAN in our example.<br>
<i>LOCAL_RULE_1 and LOCAL_RULE_2</i><br>
&nbsp;Ruleset 1 is applied to all sender addresses and Ruleset 2 is applied to all recipient addresses. They<br>are both usually empty.<br>
<b>18.6.6.1. Interpreting the rule in our example</b><br>
<a href="TLNAGs.html#378">Our sample in&nbsp;Example 18−3&nbsp;uses the&nbsp;</a>LOCAL_NET_CONFIG&nbsp;macro to declare a local rule that ensures that<br>any mail within our domain is delivered directly using the&nbsp;<b>smtp</b>&nbsp;mailer. Now that we've looked at how<br>rewrite rules are constructed, we will be able to understand how this rule works. Let's take another look at it.<br>
<b>Example 18−3. Rewrite Rule from vstout.uucpsmtp.m4</b><br>
LOCAL_NET_CONFIG<br>
# This rule ensures that all local mail is delivered using the<br>
# smtp transport, everything else will go via the smart host.<br>
R$* &lt; @ $* .$m. &gt; $* &nbsp;$#smtp $@ $2.$m. $: $1 &lt; @ $2.$m. &gt; $3<br>
We know that the&nbsp;LOCAL_NET_CONFIG&nbsp;macro will cause the rule to be inserted somewhere near the end of<br>ruleset 0, but before any smart host definition. We also know that ruleset 0 is the last ruleset to be executed<br>and that it should resolve to a three−tuple specifying the mailer, user, and host.<br>
We can ignore the two comment lines; they don't do anything useful. The rule itself is the line beginning with<br>R. We know that the&nbsp;R&nbsp;is a&nbsp;<b>sendmail</b>&nbsp;command and that it adds this rule to the current ruleset, in this case<br>ruleset&nbsp;0. Let's look at the lefthand side and the righthand side in turn.<br>
The lefthand side looks like:&nbsp;$* &lt; @ $* .$m. &gt; $*.<br>
Ruleset 0 expects &lt; and &gt; characters because it is fed by ruleset 3. Ruleset 3 converts addresses into a<br>common form and to make parsing easier, it also places the host part of the mail address inside &lt;&gt;s.<br>
This rule matches any mail address that looks like:&nbsp;'DestUser &lt; @ somehost.ourdomain. &gt;<br>Some Text'. That is, it matches mail for any user at any host within our domain.<br>
You will remember that the text matched by metasymbols on the lefthand side of a rewrite rule is assigned to<br>macro definitions for use on the righthand side. In our example, the first&nbsp;$*&nbsp;matches all text from the start of<br>the address until the &lt; character. All of this text is assigned to&nbsp;$1&nbsp;for use on the righthand side. Similarly the<br>second&nbsp;$*&nbsp;in our rewrite rule is assigned to&nbsp;$2, and the last is assigned to&nbsp;$3.<br>
We now have enough to understand the lefthand side. This rule matches mail for any user at any host within<br>our domain. It assigns the username to $1, the hostname to&nbsp;$2, and any trailing text to&nbsp;$3. The righthand side<br>is then invoked to process these.<br>
18.6.6.1. Interpreting the rule in our example<br>
362<br>
<hr>
<A name=379></a>Linux Network Administrators Guide<br>
Let's now look at what we're expecting to see outputed. The righthand side of our example rewrite rule looks<br>like:&nbsp;$#smtp $@ $2.$m. $: $1 &lt; @ $2.$m. &gt; $3.<br>
When the righthand side of our ruleset is processed, each of the metasymbols are interpreted and relevant<br>substitutions are made.<br>
The&nbsp;$#&nbsp;metasymbol causes this rule to resolve to a specific mailer,&nbsp;<i>smtp</i>&nbsp;in our case.<br>
The&nbsp;$@&nbsp;resolves the target host. In our example, the target host is specified as&nbsp;$2.$m., which is the fully<br>qualified domain name of the host on in our domain. The FQDN is constructed of the hostname component<br>assigned to&nbsp;$2&nbsp;from our lefthand side with our domain name (.$m.) appended.<br>
The&nbsp;$:&nbsp;metasymbol specifies the target user, which we again captured from the lefthand side and had stored<br>in&nbsp;$1.<br>
We preserve the contents of the &lt;&gt; section, and any trailing text, using the data we collected from the<br>lefthand side of the rule.<br>
Since this rule resolves to a mailer, the message is forwarded to the mailer for delivery. In our example, the<br>message would be forwarded to the destination host using the SMTP protocol.<br>
18.6.6.1. Interpreting the rule in our example<br>
363<br>
<hr>
<A name=380></a><b>18.7. Configuring sendmail Options</b><br>
<b>sendmail</b>&nbsp;has a number of options that allow you to customize the way it performs certain tasks. There are a<br>
large number of these, so we've listed only a few of the more commonly used ones in the upcoming list.<br>
&nbsp;To configure any of these options, you may either define them in the&nbsp;<b>m4</b>&nbsp;configuration file, which is the<br>preferable method, or you may insert them directly into the&nbsp;sendmail.cf&nbsp;file. For example, if we wished<br>to have&nbsp;<b>sendmail</b>&nbsp;fork a new job for each mail message to be delivered, we might add the following line to<br>our&nbsp;<b>m4</b>&nbsp;configuration file:<br>
define(confSEPARATE_PROC,true)<br>
The corresponding&nbsp;sendmail.cf&nbsp;entry created is:<br>
O ForkEachJob=true<br>
The following list describes common&nbsp;<i>sendmail m4</i>&nbsp;options (and&nbsp;sendmail.cf&nbsp;equivalents):<br>
<i>confMIN_FREE_BLOCKS (MinFreeBlocks)</i><br>
There are occasions when a problem might prevent the immediate delivery of mail messages, causing<br>messages to be queued in the mail spool. If your mail host processes large volumes of mail, it is<br>possible for the mail spool to grow to such a size that it fills the filesystem supporting the spool. To<br>prevent this,&nbsp;<b>sendmail</b>&nbsp;provides this option to specify the minimum number of free disk blocks that<br>must exist before a mail message will be accepted. This allows you to ensure that&nbsp;<b>sendmail</b>&nbsp;never<br>causes your spool filesystem to be filled (Default: 100).<br>
<i>confME_TOO (MeToo)</i><br>
When a mail target such as an email alias is expanded, it is sometimes possible for the sender to<br>appear in the recipient list. This option determines whether the originators of an email message will<br>receive a copy if they appear in the expanded recipient list. Valid values are true and false<br>(Default: false).<br>
<i>confMAX_DAEMON_CHILDREN (MaxDaemonChildren)</i><br>
Whenever&nbsp;<b>sendmail</b>&nbsp;receives an SMTP connection from a remote host, it spawns a new copy of itself<br>to deal with the incoming mail message. This way, it is possible for&nbsp;<b>sendmail</b>&nbsp;to be processing<br>multiple incoming mail messages simulatanenously. While this is useful, each new copy of<br><b>sendmail</b>&nbsp;consumes memory in the host computer. If an unusually large number of incoming<br>connections are received, by chance, because of a problem or a malicious attack, it is possible for<br><b>sendmail</b>&nbsp;daemons to consume all system memory. This option provides you with a means of<br>limiting the maximum number of daemon children that will be spawned. When this number is<br>reached, new connections are rejected until some of the existing children have terminated (Default:<br>undefined).<br>
<i>confSEPARATE_PROC (ForkEachJob)</i><br>
When processing the mail queue and sending mail messages,&nbsp;<b>sendmail</b>&nbsp;processes one mail message<br>at a time. When this option is enabled,&nbsp;<b>sendmail</b>&nbsp;will fork a new copy of itself for each message to be<br>
18.7. Configuring sendmail Options<br>
364<br>
<hr>
<A name=381></a>Linux Network Administrators Guide<br>
delivered. This is particularly useful when there are some mail messages that are stuck in the queue<br>because of a problem with the target host (Default: false).<br>
<i>confSMTP_LOGIN_MSG (SmtpGreetingMessage)</i><br>
Whenever a connection is made to&nbsp;<b>sendmail</b>, a greeting message is sent. By default, this message<br>contains the hostname, name of the mail transfer agent, the sendmail version number, the local<br>version number, and the current date. RFC821 specifies that the first word of the greeting should be<br>the fully qualified domain name of the host, but the rest of the greeting can be configured however<br>you please. You can specify sendmail macros here and they will be expanded when used. The only<br>people who will see this message are suffering system administrators diagnosing mail delivery<br>problems or strongly curious people interested in discovering how your machine is configured. You<br>can relieve some of the tedium of their task by customizing the welcome message with some<br>witticisms; be nice. The word EMSTP will be inserted between the first and second words by<br><b>sendmail</b>, as this is the signal to remote hosts that we support the ESMTP protocol (Default:&nbsp;$j<br>Sendmail $v/$Z; $b).<br>
18.7. Configuring sendmail Options<br>
365<br>
<hr>
<A name=382></a><b>18.8. Some Useful sendmail Configurations</b><br>
There are myriad possible&nbsp;<b>sendmail</b>&nbsp;configurations. In this space we'll illustrate just a few important types<br>of configuration that will be useful in many&nbsp;<b>sendmail</b>&nbsp;installations.<br>
<b>18.8.1. Trusting Users to Set the From: Field</b><br>
It is sometimes useful to overwrite the&nbsp;From:&nbsp;field of an outgoing mail message. Let's say you have a<br>web−based program that generates email. Normally the mail message would appear to come from the user<br>who owned the web server process. We might want to specify some other source address so that the mail<br>appears to have originated from some other user or address on that machine.&nbsp;<b>sendmail</b>&nbsp;provides a means of<br>specifying which systems users are to be entrusted with the ability to do this.<br>
The&nbsp;use_ct_file&nbsp;feature enables the specification and use of a file that lists the names of trusted users.<br>By default, a small number of system users are trusted by&nbsp;<b>sendmail</b>&nbsp;(root, for example). The default<br>filename for this feature is&nbsp;/etc/mail/trusted−users&nbsp;in systems exploiting the<br>/etc/mail/&nbsp;configuration directory and&nbsp;/etc/sendmail.ct&nbsp;in those that don't. You can specify the<br>name and location of the file by overriding the&nbsp;confCT_FILE&nbsp;definition.<br>
Add FEATURE(use_ct_file) to your&nbsp;sendmail.mc&nbsp;file to enable the feature.<br>
<b>18.8.2. Managing Mail Aliases</b><br>
&nbsp;Mail aliases are a powerful feature that enable mail to be directed to mailboxes that are alternate names for<br>users or processes on a destination host. For example, it is common practice to have feedback or comments<br>relating to a World Wide Web server to be directed to webmaster. Often there isn't a user known as<br>webmaster on the target machine, instead it is an alias of another system user. Another common use of<br>mail aliases is exploited by mailing list server programs in which an alias directs incoming messages to the<br>list server program for handling.<br>
The&nbsp;/etc/aliases&nbsp;file is where the aliases are stored. The&nbsp;<b>sendmail</b>&nbsp;program consults this file when<br>determining how to handle an incoming mail message. If it finds an entry in this file matching the target user<br>in the mail message, it redirects the message to wherever the entry describes.<br>
Specifically there are three things that aliases allow to happen:<br>
They provide a shorthand or well−known name for mail to be addressed to in order to go to one or<br>
•&nbsp;<br>
more persons.<br>They can invoke a program with the mail message as the input to the program.<br>
•&nbsp;<br>
They can send mail to a file.<br>
•&nbsp;<br>
All systems require aliases for Postmaster and MAILER−DAEMON to be RFC−compliant.<br>
Always be extremely aware of security when defining aliases that invoke programs or write to programs,<br>since&nbsp;<b>sendmail</b>&nbsp;generally runs with root permissions.<br>
18.8. Some Useful sendmail Configurations<br>
366<br>
<hr>
<A name=383></a>Linux Network Administrators Guide<br>
Details concerning mail aliases may be found in the&nbsp;aliases(5)&nbsp;manual page. A sample&nbsp;aliases&nbsp;file is<br>shown in&nbsp;<a href="TLNAGs.html#383">Example 18−4</a>.<br>
<b>Example 18−4. Sample aliases File</b><br>
#<br>
# The following two aliases must be present to be RFC−compliant.<br>
# It is important to resolve them to 'a person' who reads mail routinely.<br>
#<br>
postmaster: &nbsp; &nbsp;root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# required entry<br>
MAILER−DAEMON: postmaster &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# required entry<br>
#<br>
#<br>
# demonstrate the common types of aliases<br>
#<br>
usenet: &nbsp; &nbsp; &nbsp; &nbsp;janet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # alias for a person<br>
admin: &nbsp; &nbsp; &nbsp; &nbsp; joe,janet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # alias for several people<br>
newspak−users: :include:/usr/lib/lists/newspak # read recipients from file<br>
changefeed: &nbsp; &nbsp;|/usr/local/lib/gup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # alias that invokes program<br>
complaints: &nbsp; &nbsp;/var/log/complaints &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # alias writes mail to file<br>
#<br>
Whenever you update the&nbsp;/etc/aliases&nbsp;file, be sure to run the command:<br>
#&nbsp;<b>/usr/bin/newaliases</b><br>
to rebuild the database that&nbsp;<b>sendmail</b>&nbsp;uses internally. The&nbsp;<b>/usr/bin/newaliases</b>&nbsp;command is a symbolic link to<br>the&nbsp;<b>sendmail</b>&nbsp;executable, and when invoked this way, behaves exactly as though it were invoked as:<br>
#&nbsp;<b>/usr/lib/sendmail −bi</b><br>
The&nbsp;<b>newaliases</b>&nbsp;command is an alternative and more convenient way to do this.<br>
<b>18.8.3. Using a Smart Host</b><br>
&nbsp;Sometimes a host finds mail that it is unable to deliver directly to the desired remote host. It is often<br>convenient to have a single host on a network take on the role of managing transmission of mail to remote<br>hosts that are difficult to reach, rather than have each local host try to do this independently.<br>
There are a few good reasons to have a single host take on mail management. You can simplify management<br>by having only one host with a comprehensive mail configuration that knows how to handle all of the<br>different mail transport types, such as UUCP, Usenet, etc. All other hosts need only a single tranport protocol<br>to send their mail to this central host. Hosts that fill this central mail routing and forwarding role are called<br><i>smart hosts</i>. If you have a smart host that will accept mail from you, you can send it mail of any sort and it<br>will manage the routing and transmission of that mail to the desired remote destinations.<br>
Another good application for smart host configurations is to manage transmission of mail across a private<br>firewall. An organization may elect to install a private IP network and use their own, unregistered IP<br>addresses. The private network may be connected to the Internet through a firewall. Sending mail to and from<br>hosts in the private network to the outside world using SMTP would not be possible in a conventional<br>configuration because the hosts are not able to accept or establish direct network connections to hosts on the<br>
18.8.3. Using a Smart Host<br>
367<br>
<hr>
<A name=384></a>Linux Network Administrators Guide<br>
Internet. Instead, the organization could elect to have the firewall provide a mail smart host function. The<br>smart host running on the firewall is able to establish direct network connections with hosts both on the<br>private network and on the Internet. The smart host would accept mail from both hosts on the private network<br>and the Internet, store them in local storage and then manage the retransmission of that mail to the correct<br>host directly.<br>
Smart hosts are usually used when all other methods of delivery have failed. In the case of the organization<br>with the private network, it would be perfectly reasonable to have the hosts attempt to deliver mail directly<br>first, and if that fails then to send it to the smart host. This relieves the smart host of a lot of traffic because<br>other hosts can directly send mail to other hosts on the private network.<br>
<b>sendmail</b>&nbsp;provides a simple method of configuring a smart host using the&nbsp;SMART_HOST&nbsp;feature; when<br>
implementing it in the Virtual Brewery configuration, we do exactly this. The relevant portions of our<br>configuration that define the smart host are:<br>
define(`SMART_HOST', `uucp−new:moria')<br>
LOCAL_NET_CONFIG<br>
# This rule ensures that all local mail is delivered using the<br>
# smtp transport, everything else will go via the smart host.<br>
R$* &lt; @ $* .$m. &gt; $* &nbsp; &nbsp;$#smtp $@ $2.$m. $: $1 &lt; @ $2.$m. &gt; $3<br>
The&nbsp;SMART_HOST&nbsp;macro allows you to specify the host that should relay all outgoing mail that you are<br>unable to deliver directly, and the mail transport protocol to use to talk to it.<br>
In our configuration we are using the&nbsp;uucp−new&nbsp;transport to UUCP host&nbsp;<i>moria</i>. If we wanted to configure<br><b>sendmail</b>&nbsp;to use an SMTP−based Smart Host, we would instead use something like:<br>
define(`SMART_HOST', `mail.isp.net')<br>
We don't need to specify SMTP as the transport, as it is the default.<br>
Can you guess what the&nbsp;LOCAL_NET_CONFIG&nbsp;macro and the rewrite rule might be doing?<br>
The&nbsp;LOCAL_NET_CONFIG&nbsp;macro allows you to add raw&nbsp;<b>sendmail</b>&nbsp;rewrite rules to your configuration that<br>define what mail should stay within the local mail system. In our example, we've used a rule that matches any<br>email address where the host belongs to our domain (.$m.) and rewrite it so that it is sent directly to the<br>SMTP&nbsp;mailer. This ensures that any message for a host on our local domain is directed immediately to the<br>SMTP mailer and forwarded to that host, rather than falling through to our smart host, which is the default<br>treatment.<br>
<b>18.8.4. Managing Unwanted or Unsolicited Mail (Spam)</b><br>
&nbsp;If you've subscribed to a mailing list, published your email address on a web site, or posted an article to<br>UseNet, you will most likely have begun to receive unsolicited advertising email. It is commonplace now for<br>people to scour the net in search of email addresses to add to mailing lists that they then sell to companies<br>seeking to advertise their products. This sort of mass−mailing behavior is commonly called spamming.<br>
The Free On−line Dictionary of Computing offers a mail−specific definition of spam as:[112]<br>
18.8.4. Managing Unwanted or Unsolicited Mail (Spam)<br>
368<br>
<hr>
<A name=385></a>Linux Network Administrators Guide<br>
2. (A narrowing of sense 1, above) To indiscrimately send large amounts of unsolicited<br>e−mail meant to promote a product or service. Spam in this sense is sort of like the electronic<br>equivalent of junk mail sent to &quot;Occupant.&quot;<br>
In the 1990s, with the rise in commercial awareness of the net, there are actually scumbags<br>who offer spamming as a &quot;service&quot; to companies wishing to advertise on the net. They do<br>this by mailing to collections of e−mail addresses, Usenet news, or mailing lists. Such<br>practises have caused outrage and aggressive reaction by many net users against the<br>individuals concerned.<br>
Fortunately,&nbsp;<b>sendmail</b>&nbsp;includes some support for mechanisms that can help you deal with unsolicited mail.<br>
<b>18.8.4.1. The Real−time Blackhole List</b><br>
The Real−time Blackhole List is a public facility provided to help reduce the volume of unsolicited<br>advertising you have to contend with. Known email sources and hosts are listed in a queryable database on<br>the Internet. They're entered there by people who have received unsolicited advertising from some email<br>address. Major domains sometimes find themselves on the list because of slip−ups in shutting down spam.<br>While some people complain about particular choices made by the maintainers of the list, it remains very<br>popular and disagreements are usually worked out quickly. Full details on how the service is operated may be<br>found from the home site of the Mail Abuse Protection System at&nbsp;<i>http://maps.vix.com/rbl/</i>.<br>
If you enable this&nbsp;<b>sendmail</b>&nbsp;feature, it will test the source address of each incoming mail message against the<br>Real−time Blackhole List to determine whether to accept the message. If you run a large site with many<br>users, this feature could save a considerable volume of disk space. This feature accepts a parameter to specify<br>the name of the server to use. The default is the main server at rbl.maps.vix.com.<br>
To configure the Real−time Blackhole List feature, add the following macro declaration to your<br>sendmail.mc&nbsp;file:<br>
FEATURE(rbl)<br>
Should you wish to specify some other RBL server, you would use a declaration that looks like:<br>
FEATURE(rbl,`rbl.host.net')<br>
<b>18.8.4.2. The access database</b><br>
&nbsp;An alternative system that offers greater flexibility and control at the cost of manual configuration is the<br><b>sendmail</b>&nbsp;access_db feature. The access database allows you to configure which hosts or users you will<br>accept mail from and which you will relay mail for.<br>
Managing who you will relay mail for is important, as it is another technique commonly employed by<br>spamming hosts to circumvent systems such as the Real−time Blackhole List just described. Instead of<br>sending the mail to you directly, spammers will relay the mail via some other unsuspecting host who allows<br>it. The incoming SMTP connection then doesn't come from the known spamming host, it instead comes from<br>the relay host. To ensure that your own mail hosts aren't used in this way, you should relay mail only for<br>known hosts. Versions of&nbsp;<b>sendmail</b>&nbsp;that are 8.9.0 or newer have relaying disabled by default, so for those<br>
18.8.4.1. The Real−time Blackhole List<br>
369<br>
<hr>
<A name=386></a>Linux Network Administrators Guide<br>
you'll need to use the access database to enable individual hosts to relay.<br>
The general idea is simple. When a new incoming SMTP connection is received,&nbsp;<b>sendmail</b>&nbsp;retrieves the<br>message header information and then consults the access database to see whether it should proceed to accept<br>the body of the message itself.<br>
The access database is a collection of rules that describe what action should be taken for messages received<br>from nominated hosts. The default access control file is called&nbsp;/etc/mail/access. The table has a<br>simple format. Each line of the table contains an access rule. The lefthand side of each rule is a pattern used<br>to match the sender of an incoming mail message. It may be a complete email address, a hostname, or an IP<br>address. The righthand side is the action to take. There are five types of action you may configure. These are:<br>
<i>OK</i><br>
Accept the mail message.<br>
<i>RELAY</i><br>
Accept messages from this host or user even if they are not destined for our host; that is, accept<br>messages for relaying to other hosts from this host.<br>
<i>REJECT</i><br>
Reject the mail with a generic message.<br>
<i>DISCARD</i><br>
Discard the message using the&nbsp;$#discard&nbsp;mailer.<br>
<i>### any text</i><br>
Return an error message using&nbsp;<i>###</i>&nbsp;as the error code (which should be RFC−821 compliant) and<br>any text as the message.<br>
An example&nbsp;/etc/mail/access&nbsp;might look like:<br>
friends@cybermail.com &nbsp; REJECT<br>
aol.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; REJECT<br>
207.46.131.30 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; REJECT<br>
postmaster@aol.com &nbsp; &nbsp; &nbsp;OK<br>
linux.org.au &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RELAY<br>
This example would reject any email received from friends@cybermail.com, any host in the domain<br><i>aol.com</i>&nbsp;and the host&nbsp;<i>207.46.131.30</i>. The next rule would accept email from postmaster@aol.com despite the<br>fact that the domain itself has a reject rule. The last rule allows relaying of mail from any host in the<br><i>linux.org.au</i>&nbsp;domain.<br>
To enable the access database feature, use the following declaration in your&nbsp;sendmail.mc&nbsp;file:<br>
FEATURE(access_db)<br>
18.8.4.1. The Real−time Blackhole List<br>
370<br>
<hr>
<A name=387></a>Linux Network Administrators Guide<br>
The default definition builds the database using&nbsp;hash −o /etc/mail/access, which generates a<br>simple hashed database from the plain text file. This is perfectly adequate in most installations. There are<br>other options that you should consider if you intend to have a large access database. Consult the<br><i>sendmail</i>&nbsp;book or other&nbsp;<b>sendmail</b>&nbsp;documentation for details.<br>
<b>18.8.4.3. Barring users from receiving mail</b><br>
&nbsp;If you have users or automated processes that send mail but will never need to receive it, it is sometimes<br>useful to refuse to accept mail destined for them. This saves wasted disk−space storing mail that will never be<br>read. The blacklist_recipients feature, when used in combination with the access_db feature, allows you to<br>disable the receipt of mail for local users.<br>
To enable the feature, you add the following lines to your&nbsp;sendmail.mc&nbsp;file, if they're not already there:<br>
FEATURE(access_db)<br>
FEATURE(blacklist_recipients)<br>
To disable receipt of mail for a local user, simply add his details into the access database. Usually you would<br>use the&nbsp;<i>###</i>&nbsp;entry style that would return a meaningful error message to the sender so they know why the<br>mail is not being delivered. This feature applies equally well to users in virtual mail domains, and you must<br>include the virtual mail domain in the access database specification. Some sample<br>/etc/mail/access&nbsp;entries might look like:<br>
daemon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;550 Daemon does not accept or read mail.<br>
flacco &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;550 Mail for this user has been administratively disabled.<br>
grump@dairy.org 550 Mail disabled for this recipient.<br>
<b>18.8.5. Configuring Virtual Email Hosting</b><br>
&nbsp;Virtual email hosting provides a host the capability of accepting and delivering mail on behalf of a number<br>of different domains as though it were a number of separate mail hosts. Most commonly, virtual hosting is<br>exploited by Internet Application Providers in combination with virtual web hosting, but it's simple to<br>configure and you never know when you might be in a position to virtual host a mailing list for your favorite<br>Linux project, so we'll describe it here.<br>
<b>18.8.5.1. Accepting mail for other domains</b><br>
When&nbsp;<b>sendmail</b>&nbsp;receives an email message, it compares the destination host in the message headers to the<br>local host name. If they match,&nbsp;<b>sendmail</b>&nbsp;accepts the message for local delivery; if they differ,&nbsp;<b>sendmail</b>&nbsp;may<br><a href="TLNAGs.html#385">decide to accept the message and attempt to forward it on to the final destination (See&nbsp;Section 18.8.4.2<br></a>earlier in this chapter for details on how to configure&nbsp;<b>sendmail</b>&nbsp;to accept mail for forwarding).<br>
If we wish to configure virtual email hosting, the first thing we need to do is to convince&nbsp;<b>sendmail</b>&nbsp;that it<br>should also accept mail for the domains that we are hosting. Fortunately, this is a very simple thing to do.<br>
The&nbsp;<b>sendmail</b>&nbsp;use_cw_file feature allows us to specify the name of a file where we store domain names for<br>which&nbsp;<b>sendmail</b>&nbsp;accepts mail. To configure the feature, add the feature declaration to your<br>
18.8.4.3. Barring users from receiving mail<br>
371<br>
<hr>
<A name=388></a>Linux Network Administrators Guide<br>
sendmail.mc&nbsp;file:<br>
FEATURE(use_cw_file)<br>
The default name of the file will be&nbsp;/etc/mail/local−host−names&nbsp;for distributions using the<br>/etc/mail/&nbsp;configuration directory or&nbsp;/etc/sendmail.cw&nbsp;for those that don't. Alternatively, you can<br>specify the name and location of the file by overriding the&nbsp;confCW_FILE&nbsp;macro using a variation on:<br>
define(`confCW_FILE',`/etc/virtualnames')<br>
To stick with the default filename, if we wished to offer virtual hosting to the&nbsp;<i>bovine.net</i>,&nbsp;<i>dairy.org</i>, and<br><i>artist.org</i>&nbsp;domains, we would create a&nbsp;/etc/mail/local−host−names&nbsp;that looks like:<br>
bovine.net<br>
dairy.org<br>
artist.org<br>
When this is done, and assuming appropriate DNS records exist that point those domain names to our host,<br><b>sendmail</b>&nbsp;will accept mail messages for those domains as though they were destined for our real domain<br>name.<br>
<b>18.8.5.2. Forwarding virtual−hosted mail to other destinations</b><br>
&nbsp;The&nbsp;<b>sendmail</b>&nbsp;virtusertable feature configures support for the virtual user table, where we configure virtual<br>email hosting. The virtual user table maps incoming mail destined for some&nbsp;<i>user@host</i>&nbsp;to some<br><i>otheruser@otherhost</i>. You can think of this as an advanced mail alias feature, one that operates using not just<br>the destination user, but also the destination domain.<br>
To configure the virtusertable feature, add the feature to your&nbsp;sendmail.mc&nbsp;configuration as shown:<br>
FEATURE(virtusertable)<br>
By default, the file containing the rules to perform translations will be&nbsp;/etc/mail/virtusertable.<br>You can override this by supplying an argument to the macro definition; consult a detailed<br><b>sendmail</b>&nbsp;reference to learn about what options are available.<br>
The format of the virtual user table is very simple. The lefthand side of each line contains a pattern<br>representing the original destination mail address; the righthand side has a pattern representing the mail<br>address the virtual hosted address will be mapped to.<br>
The following example shows three possible types of entries:<br>
samiam@bovine.net &nbsp; &nbsp; colin<br>
sunny@bovine.net &nbsp; &nbsp; &nbsp;darkhorse@mystery.net<br>
@dairy.org &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mail@jhm.org<br>
@artist.org &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $1@red.firefly.com<br>
In this example, we are virtual hosting three domains:&nbsp;<i>bovine.net</i>,&nbsp;<i>dairy.org</i>, and&nbsp;<i>artist.org</i>.<br>
The first entry redirects mail sent to a user in the&nbsp;<i>bovine.net</i>&nbsp;virtual domain to a local user on the machine.<br>The second entry redirects mail to a user in the same virtual domain to a user in another domain. The third<br>
18.8.5.2. Forwarding virtual−hosted mail to other destinations<br>
372<br>
<hr>
<A name=389></a>Linux Network Administrators Guide<br>
example redirects all mail addressed to any user in the&nbsp;<i>dairly.org</i>&nbsp;virtual domain to a single remote mail<br>address. Finally, the last entry redirects any mail to a user in the&nbsp;<i>artist.org</i>&nbsp;virtual domain to the same user in<br>another domain; for example, julie@artists.org would be redirected to julie@red.firefly.com.<br>
18.8.5.2. Forwarding virtual−hosted mail to other destinations<br>
373<br>
<hr>
<A name=390></a><b>18.9. Testing Your Configuration</b><br>
&nbsp;The&nbsp;<b>m4</b>&nbsp;command processes the macro definition files according to its own syntax rules without<br>understanding anything about correct&nbsp;<b>sendmail</b>&nbsp;syntax; so there won't be any error messages if you've gotten<br>anything wrong in your macro definition file. For this reason, it is very important that you thoroughly test<br>your configuration. Fortunately,&nbsp;<b>sendmail</b>&nbsp;provides a relatively easy way of doing this.<br>
<b>sendmail</b>&nbsp;supports an address test mode that allows us to test our configuration and identify any errors. In<br>this mode of operation, we invoke&nbsp;<b>sendmail</b>&nbsp;from the command line, and it prompts us for a ruleset<br>specification and a destination mail address.&nbsp;<b>sendmail</b>&nbsp;then processes that destination address using the rules<br>specified, displaying the output of each rewrite rule as it proceeds. To place&nbsp;<b>sendmail</b>&nbsp;into this mode, we<br>invoke it with the&nbsp;−bt&nbsp;argument:<br>
#&nbsp;<b>/usr/sbin/sendmail −bt</b><br>
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)<br>
Enter &lt;ruleset&gt; &lt;address&gt;<br>
&gt;<br>
The default configuration file used is the&nbsp;/etc/mail/sendmail.cf&nbsp;file; you can specify an alternate<br>configuration file using the&nbsp;−C&nbsp;argument. To test our configuration, we need to select a number of addresses<br>to process that will tell us that each of our mail−handing requirements are met. To illustrate this, we'll work<br>through a test of our more complicated UUCP configuration shown in&nbsp;<a href="TLNAGs.html#368">Example 18−2</a>.<br>
First we'll test that&nbsp;<b>sendmail</b>&nbsp;is able to deliver mail to local users on the system. In these tests we expect all<br>addresses to be rewritten to the&nbsp;<i>local</i>&nbsp;mailer on this machine:<br>
#&nbsp;<b>/usr/sbin/sendmail −bt</b><br>
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)<br>
Enter &lt;ruleset&gt; &lt;address&gt;<br>
&gt;&nbsp;<b>3,0 isaac</b><br>
rewrite: ruleset &nbsp; 3 &nbsp; input: isaac<br>
rewrite: ruleset &nbsp;96 &nbsp; input: isaac<br>
rewrite: ruleset &nbsp;96 returns: isaac<br>
rewrite: ruleset &nbsp; 3 returns: isaac<br>
rewrite: ruleset &nbsp; 0 &nbsp; input: isaac<br>
rewrite: ruleset 199 &nbsp; input: isaac<br>
rewrite: ruleset 199 returns: isaac<br>
rewrite: ruleset &nbsp;98 &nbsp; input: isaac<br>
rewrite: ruleset &nbsp;98 returns: isaac<br>
rewrite: ruleset 198 &nbsp; input: isaac<br>
rewrite: ruleset 198 returns: $# local $: isaac<br>
rewrite: ruleset &nbsp; 0 returns: $# local $: isaac<br>
This output shows us how&nbsp;<b>sendmail</b>&nbsp;processes mail addressed to&nbsp;<i>isaac</i>&nbsp;on this system. Each line shows us<br>what information has been supplied to a ruleset or the result obtained from processing by a ruleset. We told<br><b>sendmail</b>&nbsp;we wished to use rulesets 3 and 0 to process the address. Ruleset 0 is what is normally invoked and<br>we forced ruleset 3 because it is not tested by default. The last line shows us that the result of ruleset 0 does<br>indeed direct mail to&nbsp;<i>isaac</i>&nbsp;to the&nbsp;<i>local</i>&nbsp;mailer.<br>
Next we'll test mail addressed to our SMTP address:&nbsp;<i>isaac@vstout.vbrew.com</i>. We should be able to produce<br>the same end result as our last example:<br>
#&nbsp;<b>/usr/sbin/sendmail −bt</b><br>
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)<br>
18.9. Testing Your Configuration<br>
374<br>
<hr>
<A name=391></a>Linux Network Administrators Guide<br>
Enter &lt;ruleset&gt; &lt;address&gt;<br>
&gt; 3,0 isaac@vstout.vbrew.com<br>
rewrite: ruleset &nbsp; 3 &nbsp; input: isaac @ vstout . vbrew . com<br>
rewrite: ruleset &nbsp;96 &nbsp; input: isaac &lt; @ vstout . vbrew . com &gt;<br>
rewrite: ruleset &nbsp;96 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp; 3 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp; 0 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 199 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 199 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp;98 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp;98 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 198 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 198 returns: $# local $: isaac<br>
rewrite: ruleset &nbsp; 0 returns: $# local $: isaac<br>
Again, this test passed. Next we'll test mail to our UUCP style address:&nbsp;<i>vstout!isaac</i>.<br>
#&nbsp;<b>/usr/sbin/sendmail −bt</b><br>
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)<br>
Enter &lt;ruleset&gt; &lt;address&gt;<br>
&gt; 3,0 vstout!isaac<br>
rewrite: ruleset &nbsp; 3 &nbsp; input: vstout ! isaac<br>
rewrite: ruleset &nbsp;96 &nbsp; input: isaac &lt; @ vstout . UUCP &gt;<br>
rewrite: ruleset &nbsp;96 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp; 3 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp; 0 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 199 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 199 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp;98 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp;98 returns: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 198 &nbsp; input: isaac &lt; @ vstout . vbrew . com . &gt;<br>
rewrite: ruleset 198 returns: $# local $: isaac<br>
rewrite: ruleset &nbsp; 0 returns: $# local $: isaac<br>
This test has also passed. These tests confirm that any mail received for local users on this machine will be<br>properly delivered irrespective of how the address is formatted. If you've defined any aliases for your<br>machine, such as virtual hosts, you should repeat these tests for each of the alternate names by which this host<br>is known to ensure they also work correctly.<br>
Next we will test that mail addressed to other hosts in the&nbsp;<i>vbrew.com</i>&nbsp;domain is delivered directly to that host<br>using the SMTP mailer:<br>
#&nbsp;<b>/usr/sbin/sendmail −bt</b><br>
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)<br>
Enter &lt;ruleset&gt; &lt;address&gt;<br>
&gt; 3,0 isaac@vale.vbrew.com<br>
rewrite: ruleset &nbsp; 3 &nbsp; input: isaac @ vale . vbrew . com<br>
rewrite: ruleset &nbsp;96 &nbsp; input: isaac &lt; @ vale . vbrew . com &gt;<br>
rewrite: ruleset &nbsp;96 returns: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp; 3 returns: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp; 0 &nbsp; input: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset 199 &nbsp; input: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset 199 returns: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp;98 &nbsp; input: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp;98 returns: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset 198 &nbsp; input: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset 198 returns: $# smtp $@ vale . vbrew . com . /<br>
&nbsp; &nbsp; $: isaac &lt; @ vale . vbrew . com . &gt;<br>
rewrite: ruleset &nbsp; 0 returns: $# smtp $@ vale . vbrew . com . /<br>
18.9. Testing Your Configuration<br>
375<br>
<hr>
<A name=392></a>Linux Network Administrators Guide<br>
&nbsp; &nbsp; $: isaac &lt; @ vale . vbrew . com . &gt;<br>
We can see that this test has directed the message to the SMTP mailer to be forwarded directly to the<br><i>vale.vbrew.com</i>&nbsp;host and specifies the user&nbsp;<i>isaac</i>. This test confirms that our<br>LOCAL_NET_CONFIG&nbsp;definition works correctly. For this test to succeed, the destination hostname must be<br>able to be resolved correctly, so it must either have an entry in our&nbsp;/etc/hosts&nbsp;file, or in our local DNS.<br>We can see what happens if the destination hostname isn't able to be resolved by intentionally specifying an<br>unknown host:<br>
#&nbsp;<b>/usr/sbin/sendmail −bt</b><br>
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)<br>
Enter &lt;ruleset&gt; &lt;address&gt;<br>
&gt; 3,0 isaac@vXXXX.vbrew.com<br>
rewrite: ruleset &nbsp; 3 &nbsp; input: isaac @ vXXXX . vbrew . com<br>
rewrite: ruleset &nbsp;96 &nbsp; input: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
vXXXX.vbrew.com: Name server timeout<br>
rewrite: ruleset &nbsp;96 returns: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset &nbsp; 3 returns: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
== Ruleset 3,0 (3) status 75<br>
rewrite: ruleset &nbsp; 0 &nbsp; input: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset 199 &nbsp; input: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset 199 returns: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset &nbsp;98 &nbsp; input: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset &nbsp;98 returns: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset 198 &nbsp; input: isaac &lt; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset &nbsp;95 &nbsp; input: &lt; uucp−new : moria &gt; isaac &lt;/<br>
&nbsp; &nbsp; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset &nbsp;95 returns: $# uucp−new $@ moria $: isaac &lt;/<br>
&nbsp; &nbsp; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset 198 returns: $# uucp−new $@ moria $: isaac &lt;/<br>
&nbsp; &nbsp; @ vXXXX . vbrew . com &gt;<br>
rewrite: ruleset &nbsp; 0 returns: $# uucp−new $@ moria $: isaac &lt;/<br>
&nbsp; &nbsp; @ vXXXX . vbrew . com &gt;<br>
This result is very different. First, ruleset 3 returned an error message indicating the hostname could not be<br>resolved. Second, we deal with this situation by relying on the other key feature of our configuration, the<br>smart host. The smart host will is to handle any mail that is otherwise undeliverable. The hostname we<br>specified in this test was unable to be resolved and the rulesets determined that the mail should be forwarded<br>to our smart host&nbsp;<i>moria</i>&nbsp;using the&nbsp;<i>uucp−new</i>&nbsp;mailer. Our smart host might be better connected and know what<br>to do with the address.<br>
Our final test ensures that any mail addressed to a host not within our domain is delivered to our smart host.<br>This should produce a result similar to our previous example:<br>
#&nbsp;<b>/usr/sbin/sendmail −bt</b><br>
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)<br>
Enter &lt;ruleset&gt; &lt;address&gt;<br>
&gt; 3,0 isaac@linux.org.au<br>
rewrite: ruleset &nbsp; 3 &nbsp; input: isaac @ linux . org . au<br>
rewrite: ruleset &nbsp;96 &nbsp; input: isaac &lt; @ linux . org . au &gt;<br>
rewrite: ruleset &nbsp;96 returns: isaac &lt; @ linux . org . au . &gt;<br>
rewrite: ruleset &nbsp; 3 returns: isaac &lt; @ linux . org . au . &gt;<br>
rewrite: ruleset &nbsp; 0 &nbsp; input: isaac &lt; @ linux . org . au . &gt;<br>
rewrite: ruleset 199 &nbsp; input: isaac &lt; @ linux . org . au . &gt;<br>
rewrite: ruleset 199 returns: isaac &lt; @ linux . org . au . &gt;<br>
rewrite: ruleset &nbsp;98 &nbsp; input: isaac &lt; @ linux . org . au . &gt;<br>
rewrite: ruleset &nbsp;98 returns: isaac &lt; @ linux . org . au . &gt;<br>
18.9. Testing Your Configuration<br>
376<br>
<hr>
<A name=393></a>Linux Network Administrators Guide<br>
rewrite: ruleset 198 &nbsp; input: isaac &lt; @ linux . org . au . &gt;<br>
rewrite: ruleset &nbsp;95 &nbsp; input: &lt; uucp−new : moria &gt; isaac &lt;/<br>
&nbsp; &nbsp; @ linux . org . au . &gt;<br>
rewrite: ruleset &nbsp;95 returns: $# uucp−new $@ moria $: isaac &lt;/<br>
&nbsp; &nbsp; @ linux . org . au . &gt;<br>
rewrite: ruleset 198 returns: $# uucp−new $@ moria $: isaac &lt;/<br>
&nbsp; &nbsp; @ linux . org . au . &gt;<br>
rewrite: ruleset &nbsp; 0 returns: $# uucp−new $@ moria $: isaac &lt;/<br>
&nbsp; &nbsp; @ linux . org . au . &gt;<br>
The results of this test indicate that the hostname was resolved, and that the message would still have been<br>routed to our smart host. This proves that our&nbsp;LOCAL_NET_CONFIG&nbsp;definition works correctly and it<br>handled both cases correctly. This test was also successful, so we can happily assume our configuration is<br>correct and use it.<br>
18.9. Testing Your Configuration<br>
377<br>
<hr>
<A name=394></a><b>18.10. Running sendmail</b><br>
The&nbsp;<b>sendmail</b>&nbsp;daemon can be run in either of two ways. One way is to have to have it run from the<br><b>inetd</b>&nbsp;daemon; the alternative, and more commonly used method is to run&nbsp;<b>sendmail</b>&nbsp;as a standalone daemon.<br>It is also common for mailer programs to invoke&nbsp;<b>sendmail</b>&nbsp;as a user command to accept locally generated<br>mail for delivery.<br>
When running&nbsp;<b>sendmail</b>&nbsp;in standalone mode, place the command in an&nbsp;rc&nbsp;file so it starts at boot time. The<br>syntax used is commonly:<br>
/usr/sbin/sendmail −bd −q10m<br>
The&nbsp;−bd&nbsp;argument tells&nbsp;<b>sendmail</b>&nbsp;to run as a daemon. It will fork and run in the background. The<br>−q10m&nbsp;argument tells&nbsp;<b>sendmail</b>&nbsp;to check its queue every ten minutes. You may choose to use a different<br>queue to check time.<br>
To run&nbsp;<b>sendmail</b>&nbsp;from the&nbsp;<b>inetd</b>&nbsp;network daemon, you'd use an entry like:<br>
smtp &nbsp;stream &nbsp;tcp nowait &nbsp;nobody &nbsp;/usr/sbin/sendmail −bs<br>
The&nbsp;−bs&nbsp;argument here tells&nbsp;<b>sendmail</b>&nbsp;to use the SMTP protocol on stdin/stdout, which is required for use<br>with&nbsp;<b>inetd</b>.<br>
The&nbsp;<b>runq</b>&nbsp;command is usually a symlink to the&nbsp;<b>sendmail</b>&nbsp;binary and is a more convenient form of:<br>
#&nbsp;<b>sendmail −q</b><br>
When&nbsp;<b>sendmail</b>&nbsp;is invoked this way, it processes any mail waiting in the queue to be transmitted. When<br>running&nbsp;<b>sendmail</b>&nbsp;from&nbsp;<b>inetd</b>&nbsp;you must also create a&nbsp;<b>cron</b>&nbsp;job that runs the&nbsp;<b>runq</b>&nbsp;command periodically to<br>ensure that the mail spool is serviced periodically.<br>
A suitable&nbsp;<b>cron</b>&nbsp;table entry would be similar to:<br>
# Run the mail spool every fifteen minutes<br>
0,15,30,45 &nbsp; &nbsp; * &nbsp; &nbsp; * &nbsp; &nbsp; * &nbsp; &nbsp; * &nbsp; &nbsp; /usr/bin/runq<br>
In most installations&nbsp;<b>sendmail</b>&nbsp;processes the queue every 15 minutes as shown in our&nbsp;crontab&nbsp;example,<br>attempting to transmit any messages there.<br>
18.10. Running sendmail<br>
378<br>
<hr>
<A name=395></a><b>18.11. Tips and Tricks</b><br>
There are a number of things you can do to make managing a&nbsp;<b>sendmail</b>&nbsp;site efficient. A number of<br>management tools are provided in the&nbsp;<b>sendmail</b>&nbsp;package; let's look at the most important of these.<br>
<b>18.11.1. Managing the Mail Spool</b><br>
&nbsp;Mail is queued in the&nbsp;/var/spool/mqueue&nbsp;directory before being transmitted. This directory is called<br>the mail spool. The&nbsp;<b>sendmail</b>&nbsp;program provides a means of displaying a formatted list of all spooled mail<br>messages and their status.<br>
The&nbsp;<b>/usr/bin/mailq</b>&nbsp;command is a symbolic link to the&nbsp;<b>sendmail</b>&nbsp;executable and behaves indentically to:<br>
#&nbsp;<b>sendmail −bp</b><br>
The output displays the message ID, its size, the time it was placed in the queue, who sent it, and a message<br>indicating its current status. The following example shows a mail message stuck in the queue with a problem:<br>
$&nbsp;<b>mailq</b><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mail Queue (1 request)<br>
−−Q−ID−− −−Size−− −−−−−Q−Time−−−−− −−−−−−−−−−−−Sender/Recipient−−−−−−−−−−−−<br>
RAA00275 &nbsp; &nbsp; &nbsp;124 Wed Dec &nbsp;9 17:47 root<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(host map: lookup (tao.linux.org.au): deferred)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;terry@tao.linux.org.au<br>
This message is still in the mail queue because the destination host IP address could not be resolved.<br>
We can force&nbsp;<b>sendmail</b>&nbsp;to process the queue now by issuing the&nbsp;/usr/bin/runq&nbsp;command.<br>
The&nbsp;<b>runq</b>&nbsp;command produces no output.&nbsp;<b>sendmail</b>&nbsp;will begin processing the mail queue in the background.<br>
<b>18.11.2. Forcing a Remote Host to Process its Mail Queue</b><br>
&nbsp;If you use a temporary dial−up Internet connection with a&nbsp;<i>fixed</i>&nbsp;IP address and rely on an MX host to<br>collect your mail while you are disconnected, you will find it useful to force the MX host to process its mail<br>queue soon after you establish your connection.<br>
A small&nbsp;<b>perl</b>&nbsp;program is included with the&nbsp;<b>sendmail</b>&nbsp;distribution that makes this simple for mail hosts that<br>support it. The&nbsp;<b>etrn</b>&nbsp;script has much the same effect on a remote host as the&nbsp;<b>runq</b>&nbsp;command has on our own.<br>If we invoke the command as shown in this example:<br>
#&nbsp;<b>etrn vstout.vbrew.com</b><br>
we will force the host&nbsp;<i>vstout.vbrew.com</i>&nbsp;to process any mail queued for our local machine.<br>
Typically you'd add this command to your PPP&nbsp;ip−up&nbsp;script so that it is executed soon after your network<br>connection is established.<br>
18.11. Tips and Tricks<br>
379<br>
<hr>
<A name=396></a>Linux Network Administrators Guide<br>
<b>18.11.3. Analyzing Mail Statistics</b><br>
<b>sendmail</b>&nbsp;collects data on mail traffic volumes and some information on hosts to which it has delivered<br>
mail. There are two commands available to display this information,&nbsp;<b>mailstats</b>, and&nbsp;<b>hoststat</b>.<br>
<b>18.11.3.1. mailstats</b><br>
&nbsp;The&nbsp;<b>mailstats</b>&nbsp;command displays statistics on the volume of mail processed by&nbsp;<b>sendmail</b>. The time at<br>which data collection commenced is printed first, followed by a table with one row for each configured<br>mailer and one showing a summary total of all mail. Each line presents eight items of information:<br>
<b>Field</b><br>
<b>Meaning</b><br>
M<br>
The mailer (transport protocol) number<br>
msgsfr<br>
The number of messages received from the mailer<br>
bytes_from&nbsp;The Kbytes of mail from the mailer<br>
msgsto<br>
The number of messages sent to the mailer<br>
bytes_to<br>
The Kbytes of mail sent to the mailer<br>
msgsreg<br>
The number of messages rejected<br>
msgsdis<br>
The number of messages discarded<br>
Mailer<br>
The name of the mailer<br>
A sample of the output of the&nbsp;<b>mailstats</b>&nbsp;command is shown in&nbsp;<a href="TLNAGs.html#396">Example 18−5</a>.<br>
<b>Example 18−5. Sample Output of the mailstats Command</b><br>
#&nbsp;<b>/usr/sbin/mailstats</b><br>
Statistics from Sun Dec 20 22:47:02 1998<br>
&nbsp;M &nbsp; msgsfr &nbsp;bytes_from &nbsp; msgsto &nbsp; &nbsp;bytes_to &nbsp;msgsrej msgsdis &nbsp;Mailer<br>
&nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0K &nbsp; &nbsp; &nbsp; 19 &nbsp; &nbsp; &nbsp; &nbsp;515K &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; 0 &nbsp;prog<br>
&nbsp;3 &nbsp; &nbsp; &nbsp; 33 &nbsp; &nbsp; &nbsp; &nbsp;545K &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0K &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; 0 &nbsp;local<br>
&nbsp;5 &nbsp; &nbsp; &nbsp; 88 &nbsp; &nbsp; &nbsp; &nbsp;972K &nbsp; &nbsp; &nbsp;139 &nbsp; &nbsp; &nbsp; 1018K &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; 0 &nbsp;esmtp<br>
=============================================================<br>
&nbsp;T &nbsp; &nbsp; &nbsp;121 &nbsp; &nbsp; &nbsp; 1517K &nbsp; &nbsp; &nbsp;158 &nbsp; &nbsp; &nbsp; 1533K &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; 0<br>
This data is collected if the&nbsp;<i>StatusFile</i>&nbsp;option is enabled in the&nbsp;sendmail.cf&nbsp;file and the status file exists.<br>Typically you'd add the following to your&nbsp;sendmail.cf&nbsp;file:<br>
# status file<br>
O StatusFile=/var/log/sendmail.st<br>
To restart the statistics collection, you need to make the statistics file zero length:<br>
&gt; /var/log/sendmail.st<br>
and restart&nbsp;<b>sendmail</b>.<br>
18.11.3. Analyzing Mail Statistics<br>
380<br>
<hr>
<A name=397></a>Linux Network Administrators Guide<br>
<b>18.11.3.2. hoststat</b><br>
&nbsp;The&nbsp;<b>hoststat</b>&nbsp;command displays information about the status of hosts that&nbsp;<b>sendmail</b>&nbsp;has attempted to<br>deliver mail to. The&nbsp;<b>hoststat</b>&nbsp;command is equivalent to invoking&nbsp;<b>sendmail</b>&nbsp;as:<br>
<b>sendmail −bh</b><br>
The output presents each host on a line of its own, and for each the time since delivery was attempted to it,<br>and the status message received at that time.<br>
<a href="TLNAGs.html#397">Example 18−6&nbsp;shows the sort of output you can expect from the&nbsp;</a><b>hoststat</b>&nbsp;command. Note that most of the<br>results indicate successful delivery. The result for&nbsp;<i>earthlink.net</i>, on the other hand, indicates that delivery was<br>unsuccessful. The status message can sometimes help determine the cause of the failure. In this case, the<br>connection timed out, probably because the host was down or unreachable at the time delivery was attempted.<br>
<b>Example 18−6. Sample Output of the oststat Command</b><br>
#&nbsp;<b>hoststat</b><br>
&nbsp;−−−−−−−−−−−−−− Hostname −−−−−−−−−− How long ago −−−−−−−−−Results−−−−−−−−−<br>
&nbsp;mail.telstra.com.au &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;04:05:41 250 Message accepted for<br>
&nbsp;scooter.eye−net.com.au &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;81+08:32:42 250 OK id=0zTGai−0008S9−0<br>
&nbsp;yarrina.connect.com.a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 53+10:46:03 250 LAA09163 Message acce<br>
&nbsp;happy.optus.com.au &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;55+03:34:40 250 Mail accepted<br>
&nbsp;mail.zip.com.au &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;04:05:33 250 RAA23904 Message acce<br>
&nbsp;kwanon.research.canon.com.au &nbsp; &nbsp; &nbsp; &nbsp;44+04:39:10 250 ok 911542267 qp 21186<br>
&nbsp;linux.org.au &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;83+10:04:11 250 IAA31139 Message acce<br>
&nbsp;albert.aapra.org.au &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;00:00:12 250 VAA21968 Message acce<br>
&nbsp;field.medicine.adelaide.edu.au &nbsp; &nbsp; &nbsp;53+10:46:03 250 ok 910742814 qp 721<br>
&nbsp;copper.fuller.net &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 65+12:38:00 250 OAA14470 Message acce<br>
&nbsp;amsat.org &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5+06:49:21 250 UAA07526 Message acce<br>
&nbsp;mail.acm.org &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;53+10:46:17 250 TAA25012 Message acce<br>
&nbsp;extmail.bigpond.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11+04:06:20 250 ok<br>
&nbsp;earthlink.net &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 45+05:41:09 Deferred: Connection time&nbsp;<br>
The&nbsp;<b>purgestat</b>&nbsp;command flushes the collected host data and is equivalent to invoking sendmail as:<br>
#&nbsp;<b>sendmail −bH</b><br>
The statistics will continue to grow until you purge them. You might want to periodically run the<br><b>purgestat</b>&nbsp;command to make it easier to search and find recent entries, especially if you have a busy site. You<br>could put the command into a&nbsp;crontab&nbsp;file so it runs automatically, or just do it yourself occasionally.<br>
18.11.3.2. hoststat<br>
381<br>
<hr>
<A name=398></a><b>Chapter 19. Getting EximUp and Running</b><br>
This chapter gives you a quick introduction to setting up Exim and an overview of its functionality. Although<br>Exim is largely compatible with&nbsp;<b>sendmail</b>&nbsp;in its behavior, its configuration files are completely different.<br>
The main configuration file is usually called&nbsp;/etc/exim.conf&nbsp;or&nbsp;/etc/exim/config&nbsp;in most Linux<br>distributions, or&nbsp;/usr/lib/exim/config&nbsp;in older configurations. You can find out where the<br>configuration file is by running the command:<br>
$&nbsp;<b>exim −bP configure_file</b><br>
You may have to edit the configuration file to reflect values specific to your site. In most common<br>configurations there isn't a great deal to change, and a working configuration should rarely have to be<br>modified.<br>
By default, Exim processes and delivers all incoming mail immediately. If you have relatively high traffic,<br>you may instead have Exim collect all messages in the so−called&nbsp;<i>queue</i>, and process them at regular intervals<br>only.<br>
When handling mail within a TCP/IP network, Exim is frequently run in daemon mode: at system boot<br>time, it is invoked from&nbsp;/etc/init.d/exim[113]&nbsp;and puts itself in the background, where it waits for<br>incoming TCP connections on the SMTP port (usually port 25). This is beneficial whenever you expect to<br>have a significant amount of traffic because Exim doesn't have to start up for every incoming connection.<br>Alternatively,&nbsp;<b>inetd</b>&nbsp;could manage the SMTP port and have it spawn Exim whenever there is a connection on<br>this port. This configuration might be useful when you have limited memory and low mail traffic volumes.<br>
&nbsp;Exim has a complicated set of command−line options, including many that match those of sendmail.<br>Instead of trying to put together exactly the right options for your needs, you can implement the most<br>common types of operation by invoking traditional commands like&nbsp;<b>rmail</b>&nbsp;or&nbsp;<b>rsmtp</b>. These are symbolic links<br>to Exim (or if they're not, you can easily link them to it). When you run one of the commands, Exim checks<br>the name you used to invoke it and sets the proper options itself.<br>
There are two links to Exim that you should have under all circumstances:&nbsp;<b>/usr/bin/rmail</b>&nbsp;and<br><b>/usr/sbin/sendmail</b>.[114]&nbsp;When you compose and send a mail message with a user agent like&nbsp;<b>elm</b>, the<br>message is piped to&nbsp;<b>sendmail</b>&nbsp;or&nbsp;<b>rmail</b>&nbsp;for delivery, which is why both&nbsp;<b>/usr/sbin/sendmail</b>&nbsp;and<br><b>/usr/bin/rmail</b>&nbsp;should point to Exim. The list of recipients for the message is passed to Exim on the<br>command line.[115]&nbsp;The same happens with mail coming in via UUCP. You can set up the required<br>pathnames to point to Exim by typing the following at a shell prompt:<br>
$&nbsp;<b>ln −s /usr/sbin/exim /usr/bin/rmail</b><br>
$&nbsp;<b>ln −s /usr/sbin/exim /usr/sbin/sendmail</b><br>
If you want to dig further into the details of configuring Exim, you should consult the full Exim specification.<br>If this isn't included in your favorite Linux distribution, you can get it from the source to Exim, or read it<br>online from Exim's web site at http://www.exim.org.<br>
Chapter 19. Getting EximUp and Running<br>
382<br>
<hr>
<A name=399></a><b>19.1. Running Exim</b><br>
To run Exim, you must first decide whether you want it to handle incoming SMTP messages by running as<br>a separate daemon, or whether to have&nbsp;<b>inetd</b>&nbsp;manage the SMTP port and invoke Exim only whenever an<br>SMTP connection is requested from a client. Usually, you will prefer daemon operation on the mail server<br>because it loads the machine far less than spawning Exim over and over again for each connection. As the<br>mail server also delivers most incoming mail directly to the users, you should choose&nbsp;<b>inetd</b>&nbsp;operation on most<br>other hosts.<br>
&nbsp;Whatever mode of operation you choose for each individual host, you have to make sure you have the<br>following entry in your&nbsp;/etc/services&nbsp;file:<br>
smtp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;25/tcp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Simple Mail Transfer Protocol<br>
This defines the TCP port number that is used for SMTP conversations. Port number 25 is the standard<br>defined by the Assigned Numbers RFC (RFC−1700).<br>
When run in daemon mode, Exim puts itself in the background and waits for connections on the SMTP port.<br>When a connection occurs, it forks, and the child process conducts an SMTP conversation with the peer<br>process on the calling host. The Exim daemon is usually started by invoking it from the&nbsp;rc&nbsp;script at boot time<br>using the following command:<br>
/usr/sbin/exim −bd −q15m<br>
The&nbsp;−bd&nbsp;flag turns on daemon mode, and&nbsp;−q15m&nbsp;makes it process whatever messages have accumulated in<br>the message queue every 15 minutes.<br>
&nbsp;If you want to use&nbsp;<b>inetd</b>&nbsp;instead, your&nbsp;/etc/inetd.conf&nbsp;file should contain a line like this:<br>
smtp &nbsp; &nbsp;stream &nbsp;tcp nowait &nbsp;root &nbsp;/usr/sbin/exim &nbsp;in.exim −bs<br>
Remember you have to make&nbsp;<b>inetd</b>&nbsp;re−read&nbsp;inetd.conf&nbsp;by sending it an HUP signal after making any<br>changes.[116]<br>
Daemon and&nbsp;<b>inetd</b>&nbsp;modes are mutually exclusive. If you run Exim in daemon mode, you should make sure to<br>comment out any line in&nbsp;inetd.conf&nbsp;for the smtp service. Equivalently, when having&nbsp;<b>inetd</b>&nbsp;manage Exim,<br>make sure that no&nbsp;rc&nbsp;script starts the Exim daemon.<br>
You can check that Exim is correctly set up for receiving incoming SMTP messages by telnetting to the<br>SMTP port on your machine. This is what a successful connect to the SMTP server looks like:<br>
$&nbsp;<b>telnet localhost smtp</b><br>
Trying 127.0.0.1...<br>
Connected to localhost.<br>
Escape character is '^]'.<br>
220 richard.vbrew.com ESMTP Exim 3.13 #1 Sun, 30 Jan 2000 16:23:55 +0600<br>
<b>quit</b><br>
221 richard.brew.com closing connection<br>
Connection closed by foreign host.<br>
If this test doesn't produce the SMTP banner (the line starting with the 220 code), check that you are either<br>running an Exim daemon process or have&nbsp;<b>inetd</b>&nbsp;correctly configured. If that doesn't reveal the problem, look<br>
19.1. Running Exim<br>
383<br>
<hr>
<A name=400></a>Linux Network Administrators Guide<br>
in the Exim log files (described next) in case there is an error in Exim's configuration file.<br>
19.1. Running Exim<br>
384<br>
<hr>
<A name=401></a><b>19.2. If Your Mail Doesn't Get Through</b><br>
&nbsp;A number of features are available for troubleshooting installation problems. The first place to check is<br>Exim's log files. On Linux systems they are normally kept in&nbsp;/var/log/exim/log&nbsp;and are named<br>exim_mainlog,&nbsp;exim_rejectlog, and&nbsp;exim_paniclog. On other operating systems, they are often<br>kept in&nbsp;/var/spool/exim/log. You can find out where the log files are by running the command:<br>
exim −bP log_file_path<br>
The main log lists all transactions, the reject log contains details of messages that were rejected for policy<br>reasons, and the panic log is for messages related to configuration errors and the like.<br>
Typical entries in the main log are shown below. Each entry in the log itself is a single line of text, starting<br>with a date and time. They have been split into several lines here in order to fit them on the page:<br>
2000−01−30 15:46:37 12EwYe−0004WO−00 &lt;= jack@vstout.vbrew.com&nbsp;<br>
&nbsp; H=vstout.vbrew.com [192.168.131.111] U=exim P=esmtp S=32100&nbsp;<br>
&nbsp; id=38690D72.286F@vstout.vbrew.com<br>
2000−01−30 15:46:37 12EwYe−0004WO−00 =&gt; jill &lt;jill@vbrew.com&gt;&nbsp;<br>
&nbsp; D=localuser T=local_delivery<br>
2000−01−30 15:46:37 12EwYe−0004WO−00 Completed<br>
These entries show that a message from jack@vstout.vbrew.com to jill@vbrew.com was successfully<br>delivered to a mailbox on the local host. Message arrivals are flagged with&nbsp;&lt;=, and deliveries with&nbsp;=&gt;.<br>
There are two kinds of delivery errors: permanent and temporary. A permanent delivery error is recorded in a<br>log entry like this, flagged with&nbsp;**:<br>
2000−01−30 14:48:28 12EvcH−0003rC−00 ** bill@lager.vbrew.com&nbsp;<br>
&nbsp; R=lookuphost T=smtp: SMTP error from remote mailer after RCPT TO:<br>
&nbsp; &lt;bill@lager.vbrew.com&gt;: host lager.vbrew.com [192.168.157.2]:&nbsp;<br>
&nbsp; 550 &lt;bill@lager.vbrew.com&gt;... User unknown<br>
After a failure like this, Exim sends a delivery failure report, often called a&nbsp;<i>bounce message</i>&nbsp;back to the<br>sender.<br>
Temporary errors are flagged with&nbsp;==:<br>
2000−01−30 12:50:50 12E9Un−0004Wq−00 == jim@bitter.vbrew.com&nbsp;<br>
&nbsp; T=smtp defer (145): Connection timed out<br>
This error is typical for a situation in which Exim properly recognizes that the message should be delivered to<br>a remote host, but is not able to connect to the SMTP service on that host. The host may be down or there<br>could be a network problem. Whenever a message is&nbsp;<i>deferred</i>&nbsp;like this, it remains on Exim's queue and is<br>retried at intervals. However, if it fails to be delivered for a sufficiently long time (usually several days), a<br>permanent error occurs and the message is bounced.<br>
If you are unable to locate your problem from the error message Exim generates, you may want to turn on<br>debugging messages. You can do this using the&nbsp;−d&nbsp;flag, optionally followed by a number specifying the level<br>of verbosity (a value of 9 gives maximum information). Exim then displays a report of its operation on the<br>screen, which may give you more hints about what is going wrong.<br>
19.2. If Your Mail Doesn't Get Through<br>
385<br>
<hr>
<A name=402></a><b>19.3. Compiling Exim</b><br>
Exim is still under active development; the version of Exim included in Linux distributions is probably not<br>the latest release. If you need a feature or a bugfix found in a later release, you have to obtain a copy of the<br>source code and compile it yourself. The latest release can be found via Exim's web page at<br>http://www.exim.org.<br>
Linux is one of the many operating systems supported by the Exim source. To compile Exim for Linux, you<br>should edit the&nbsp;src/EDITME&nbsp;file and put the result in a file called&nbsp;Local/Makefile. There are<br>comments in&nbsp;src/EDITME&nbsp;that tell you what the various settings are used for. Then run&nbsp;<b>make</b>. See the<br>Exim manual for detailed information on building Exim from source.<br>
19.3. Compiling Exim<br>
386<br>
<hr>
<A name=403></a><b>19.4. Mail Delivery Modes</b><br>
&nbsp;As noted previously, Exim is able to deliver messages immediately or queue them for later processing. All<br>incoming mail is stored in the&nbsp;input&nbsp;directory below&nbsp;/var/spool/exim. When queueing is not in<br>operation, a delivery process is started for each message as soon as it arrives. Otherwise, it is left on the<br>queue until a&nbsp;<i>queue−runner</i>&nbsp;process picks it up. Queueing can be made unconditional by setting<br>queue_only&nbsp;in the configuration file, or it can be conditional on the 1−minute system load by a setting<br>such as:<br>
queue_only_load = 4<br>
which causes messages to be queued if the system load exceeds 4.[117]<br>
If your host is not permanently connected to the Internet, you may want to turn on queueing for remote<br>addresses, while allowing Exim to perform local deliveries immediately. You can do this by setting:<br>
queue_remote_domains = *<br>
in the configuration file.<br>
If you turn on any form of queuing, you have to make sure the queues are checked regularly, probably every<br>10 or 15 minutes. Even without any explicit queueing options, the queues need to be checked for messages<br>that have been deferred because of temporary delivery failures. If you run Exim in daemon mode, you must<br>add the&nbsp;−q15m&nbsp;option on the command line to process the queue every 15 minutes. You can also invoke<br><b>exim −q</b>&nbsp;from&nbsp;<b>cron</b>&nbsp;at these intervals.<br>
&nbsp;You can display the current mail queue by invoking Exim with the&nbsp;−bp&nbsp;option. Equivalently, you can<br>make&nbsp;<b>mailq</b>&nbsp;a link to Exim, and invoke&nbsp;<b>mailq</b>:<br>
$&nbsp;<b>mailq</b><br>
&nbsp;2h &nbsp; 52K 12EwGE−0005jD−00 &lt;sam@vbrew.com&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; D bob@vbrew.com<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; harry@example.net &nbsp;<br>
This shows a single message from sam@vbrew.com to two recipients sitting in the message queue. It has<br>been successfully delivered to bob@vbrew.com, but has not yet been delivered to harry@example.net,<br>though it has been on the queue for two hours. The size of the message is 52K, and the ID by which Exim<br>identifies this message is&nbsp;12EwGE−0005jD−00. You can find out why the delivery is not yet complete by<br>looking at the message's individual log file, which is kept in the&nbsp;msglog&nbsp;directory in Exim's spool directory.<br>The&nbsp;−Mvl&nbsp;option is an easy way of doing this:<br>
$&nbsp;<b>exim −Mvl 12EwGE−0005jD−00</b><br>
2000−01−30 17:28:13 example.net [192.168.8.2]: Connection timed out<br>
2000−01−30 17:28:13 harry@example.net: remote_smtp transport deferred:&nbsp;<br>
&nbsp; Connection timed out<br>
Individual log files keep a copy of log entries for each message so you can easily inspect them. The same<br>information could have been extracted from the main log file using the&nbsp;<b>exigrep</b>&nbsp;utility:<br>
$&nbsp;<b>exigrep 12EwGE−0005jD−00 /var/log/exim/exim_mainlog</b><br>
19.4. Mail Delivery Modes<br>
387<br>
<hr>
<A name=404></a>Linux Network Administrators Guide<br>
That would take longer, especially on a busy system where the log files can get quite big. The&nbsp;<b>exigrep</b>&nbsp;utility<br>comes into its own when looking for information about more than one message. Its first argument is a regular<br>expression, and it picks out all the log lines concerned with any messages that have at least one log line that<br>matches the expression. Thus it can be used to pick out all messages for one specific address, or all those to<br>or from a specific host.<br>
You can keep a general watch on what a running Exim is doing by running&nbsp;<b>tail</b>&nbsp;on its main log file. Another<br>way of doing this is to run the&nbsp;<b>eximon</b>&nbsp;utility that comes with Exim. This is an X11 application that puts up a<br>scrolling display of the main log, and also shows a list of messages that are awaiting delivery, as well as some<br>stripcharts about delivery activity.<br>
19.4. Mail Delivery Modes<br>
388<br>
<hr>
<A name=405></a><b>19.5. Miscellaneous config Options</b><br>
Here are a few of the more useful options you can set in the configuration file:<br>
<i>message_size_limit</i><br>
Setting this option limits the size of message that Exim will accept.<br>
<i>return_size_limit</i><br>
Setting this option limits the amount of an incoming message that Exim will return as part of a<br>bounce message.<br>
<i>deliver_load_max</i><br>
If the system load exceeds the value given for this option, all mail delivery is suspended, though<br>messages are still accepted.<br>
<i>smtp_accept_max</i><br>
This is the maximum number of simultaneous incoming SMTP calls Exim is prepared to accept.<br>
<i>log_level</i><br>
This option controls the amount of material that is written to the log. There are also some options<br>with names beginning with&nbsp;log_&nbsp;that control the logging of specific information.<br>
19.5. Miscellaneous config Options<br>
389<br>
<hr>
<A name=406></a><b>19.6. Message Routing and Delivery</b><br>
Exim splits up mail delivery into three different tasks: routing, directing, and transporting. There are a<br>number of code modules of each type, and each is separately configurable. Usually a number of different<br>routers, directors, and transports are set up in the configuration file.<br>
Routers resolve remote addresses, determining which host the message should be sent to and which<br>transport should be used. In Internet−connected hosts there is often just one router, which does the resolution<br>by looking up the domain in the DNS. Alternatively, there may be one router that handles addresses destined<br>for hosts on a local LAN, and a second to send any other addresses to a single&nbsp;<i>smart host</i>; for example, an<br>ISP's mail server.<br>
Local addresses are given to the directors, of which there are normally several, to handle aliasing and<br>forwarding as well as identifying local mailboxes. Mailing lists can be handled by aliasing or forwarding<br>directors. If an address gets aliased or forwarded, any generated addresses are handled independently by the<br>routers or directors, as necessary. By far the most common case will be delivery to a mailbox, but messages<br>may also be piped into a command or appended to a file other than the default mailbox.<br>
A transport is responsible for implementing a method of delivery; for example, sending the message over an<br>SMTP connection or adding it to a specific mailbox. Routers and directors select which transport to use for<br>each recipient address. If a transport fails, Exim either generates a bounce message or defers the address for a<br>later retry.<br>
With Exim, you have a lot of freedom in configuring these tasks. For each of them, a number of drivers are<br>available, from which you can choose those you need. You describe them to Exim in different sections of its<br>configuration file. The transports are defined first, followed by the directors, and then the routers. There are<br>no built−in defaults, though Exim is distributed with a default configuration file that covers simple cases. If<br>you want to change Exim's routing policy or modify a transport, it is easiest to start from the default<br>configuration and make changes rather than attempt to set up a complete configuration from scratch.<br>
<b>19.6.1. Routing Messages</b><br>
&nbsp;When given an address to deliver, Exim first checks whether the domain is one that is handled on the local<br>host by matching it against a list in the&nbsp;local_domains&nbsp;configuration variable. If this option is not set, the<br>local host name is used as the only local domain. If the domain is local, the address is handed to the directors.<br>Otherwise, it is handed to the routers to find out which host to forward a message to.[118]<br>
<b>19.6.2. Delivering Messages to Local Addresses</b><br>
&nbsp;Most commonly, a local address is just a user's login name, in which case the message is delivered to the<br>user's mailbox,&nbsp;/var/spool/mail/<i>user−name</i>. Other cases include aliases, mailing list names, and mail<br>forwarding by the user. In these cases, the local address expands to a new list of addresses, which may be<br>either local or remote.<br>
Apart from these normal addresses, Exim can handle other types of local message destinations, like<br>filenames and pipe commands. When delivering to a file, Exim appends the message, creating the file if<br>necessary. File and pipe destinations are not addresses in their own right, so you can't send mail to, say,<br>
19.6. Message Routing and Delivery<br>
390<br>
<hr>
<A name=407></a>Linux Network Administrators Guide<br>
/etc/passwd@vbrew.com and expect to overwrite the password file; deliveries to a specific file are valid only<br>if they come from forwarding or alias files. Note, however, that /etc/passwd@vbrew.com is a syntactically<br>valid email address, but if Exim received it, it would (typically) search for a user whose login name was<br>/etc/passwd, fail to find one, and bounce the message.<br>
&nbsp;In an alias list or forwarding file, a&nbsp;<i>filename</i>&nbsp;is anything that begins with a slash (/) that does not parse as a<br>fully qualified email address. For example,&nbsp;/tmp/junk&nbsp;in a forwarding or alias file is interpreted as a file<br>name, but /tmp/junk@vbrew.com is an email address, though it is not likely to be a very useful one.<br>However, valid addresses of this type are seen when sending mail through X.400 gateways, because X.400<br>addresses start with a slash.<br>
&nbsp;Similarly, a&nbsp;<i>pipe command</i>&nbsp;may be any Unix command preceded by the pipe symbol (|), unless the string<br>parses as a valid email address complete with domain. Unless you have changed the configuration, Exim does<br>not use a shell to run the command; instead, it splits it up into a command name, arguments itself, and runs it<br>directly. The message is fed to the command on its standard input.<br>
For example, to gate a mailing list into a local newsgroup, you might use a shell script named&nbsp;<b>gateit</b>, and set<br>up a local alias that delivers all messages from this mailing list to the script using&nbsp;|gateit. If the command<br>line contains a comma, it and the preceding pipe symbol must be enclosed in double quotes.<br>
<b>19.6.2.1. Local users</b><br>
&nbsp;A local address most commonly denotes a user's mailbox. This is normally located in<br>/var/spool/mail&nbsp;and has the name of the user, who also owns the file. If it does not exist, it is created<br>by Exim.<br>
In some configurations, the group is set to the user's group and the mode is 0600. In these cases, delivery<br>processes are run as the user, and the user may delete the mailbox entirely. In other configurations, the<br>mailbox's group is mail, and it has mode 660; delivery processes are run under a system uid and group mail,<br>and users cannot delete their mailbox files, though they can empty them.<br>
Note that although&nbsp;/var/spool/mail&nbsp;is currently the standard place to put the mailbox files, some mail<br>software may be compiled to use different paths, for example,&nbsp;/usr/spool/mail. If delivery to users on<br>your machine fails consistently, you should see if it helps to make this a symbolic link to<br>/var/spool/mail.<br>
The addresses MAILER−DAEMON and postmaster should normally appear in your alias file, expanding into<br>the email address of the system administrator. MAILER−DAEMON is used by Exim as the sender address in<br>bounce messages. It is also recommended that root be set up as an alias for an administrator, especially when<br>deliveries are being run under the permissions of the recipient users, in order to avoid running any delivery as<br>root.<br>
<b>19.6.2.2. Forwarding</b><br>
&nbsp;Users can redirect their mail to alternative addresses by creating a&nbsp;.forward&nbsp;file in their home<br>directories. This contains a list of recipients separated by commas and/or newlines. All lines of the file are<br>read and interpreted. Any type of address may be used. A practical example of a&nbsp;.forward&nbsp;file for<br>vacations might be:<br>
19.6.2.1. Local users<br>
391<br>
<hr>
<A name=408></a>Linux Network Administrators Guide<br>
janet, &quot;|vacation&quot;<br>
In other descriptions of&nbsp;.forward&nbsp;files, you might see the username at the start preceded by a backslash.<br>This was necessary in some older MTAs to stop a search for a&nbsp;.forward&nbsp;for the new name, which could<br>lead to looping. The backslash is not necessary in Exim, which automatically avoids loops of this<br>kind.[119]&nbsp;However, a backslash is permitted, and in fact it does make a difference in configurations where<br>several domains are being handled at once. Without a backslash, an unqualified username is qualified with a<br>default domain; with a backslash the incoming domain is preserved.<br>
The first address in the forward file delivers the incoming message to&nbsp;<i>janet</i>'s mailbox, while the<br><b>vacation</b>&nbsp;command returns a short notification to the sender.[120]<br>
&nbsp;In addition to supporting traditional forwarding files, Exim can be configured to allow more complex<br>files called&nbsp;<i>filters</i>. Instead of being just a list of forwarding addresses, a filter file can contain tests on the<br>contents of the incoming message so that, for example, messages could be forwarded only if the subject<br>contained the message urgent. The system administrator must decide whether to allow users this flexibility.<br>
<b>19.6.3. Alias Files</b><br>
&nbsp;Exim is able to handle alias files compatible with Berkeley's&nbsp;<b>sendmail</b>&nbsp;alias files. Entries in the alias file<br>can have the following form:<br>
<i>alias</i>:&nbsp;<i>recipients</i><br>
<i>recipients</i>&nbsp;is a comma−separated list of addresses that will be substituted for the alias. The recipient list<br>may be continued across newlines if the next line begins with whitespace.<br>
A special feature allows Exim to handle mailing lists that are held separately from the alias file: if you specify<br>:include:<i>filename</i>&nbsp;as a recipient, Exim reads the specified file and substitutes its contents as a list of<br><a href="TLNAGs.html#409">recipients. An alternative to handling mailing lists is shown later in this chapter in&nbsp;Section 19.6.4.</a><br>
The main aliases file is&nbsp;/etc/aliases. If you make this file world−writable or group−writeable, Exim<br>will refuse to use it and will defer local deliveries. You can control the test it applies to the file's permissions<br>by setting&nbsp;modemask&nbsp;in the&nbsp;system_aliases&nbsp;director.<br>
This is a sample&nbsp;aliases&nbsp;file:<br>
# vbrew.com /etc/aliases file<br>
hostmaster: janet<br>
postmaster: janet<br>
usenet: phil<br>
# The development mailing list.<br>
development: joe, sue, mark, biff,<br>
&nbsp; &nbsp; &nbsp; &nbsp; /var/mail/log/development<br>
owner−development: joe<br>
# Announcements of general interest are mailed to all<br>
# of the staff<br>
announce: :include: /etc/Exim/staff,<br>
&nbsp; &nbsp; &nbsp; &nbsp; /var/mail/log/announce<br>
owner−announce: root<br>
# gate the ppp mailing list to a local newsgroup<br>
ppp−list: &quot;|/usr/local/bin/gateit local.lists.ppp&quot;<br>
19.6.3. Alias Files<br>
392<br>
<hr>
<A name=409></a>Linux Network Administrators Guide<br>
When there are file names and pipe commands in an alias file, as here, Exim needs to be told which userid to<br>run the deliveries under. The&nbsp;user&nbsp;option (and possibly&nbsp;group, too) must be set in Exim's configuration<br>file, either on the director that is handling the aliases, or on the transports to which it directs these items.<br>
If an error occurs while delivering to an address generated from the&nbsp;aliases&nbsp;file, Exim will send a bounce<br>message to the sender of the message, as usual, but this might not be appropriate. The&nbsp;errors_to&nbsp;option<br>can be used to specify that bounce messages are to be sent elsewhere; for example, to the postmaster.<br>
<b>19.6.4. Mailing Lists</b><br>
&nbsp;Instead of the&nbsp;aliases&nbsp;file, mailing lists may also be managed by means a&nbsp;forwardfile&nbsp;director. The<br>lists are all kept in a single directory such as&nbsp;/etc/exim/lists/, and a mailing list named nag−bugs is<br>described by the file&nbsp;lists/nag−bugs. This should contain the members' addresses separated by commas<br>or newlines. Lines beginning with a hash sign (#) are treated as comments. A simple director to use such data<br>is as follows:<br>
lists:<br>
&nbsp; driver = forwardfile<br>
&nbsp; file = /etc/exim/lists/${local_part}<br>
&nbsp; no_check_local_user<br>
&nbsp; errors_to = ${local_part}−request<br>
When this director runs, the values of the&nbsp;file&nbsp;and&nbsp;errors_to&nbsp;options are&nbsp;<i>expanded</i>. Expansion causes<br>certain portions of the strings beginning with dollar characters to be replaced every time the string is used.<br>The simplest kind of expansion is the insertion of the value of one of Exim's variables, and this is what is<br>happening here. The substring&nbsp;${local_part}&nbsp;substitutes the value of the&nbsp;$local_part, which is<br>the local part of the address that is being processed.<br>
For each mailing list, a user (or alias or mailing list) named&nbsp;<i>listname−request</i>&nbsp;should exist; any errors<br>occurring when resolving an address or delivering to a list member are reported to this address.<br>
19.6.4. Mailing Lists<br>
393<br>
<hr>
<A name=410></a><b>19.7. Protecting Against Mail Spam</b><br>
Mail spam, or unsolicited email advertising, is an annoying problem for many users. A project has been<br>
formed to address this problem called the Mail Abuse Protection System (MAPS), and a mechanism has been<br>built that reduces the problem, called the Real Time Blackhole List (RBL). Information on how the MAPS<br>RBL works can be obtained from its online documentation at http://maps.vix.com/rbl/. The idea is simple.<br>Sites that are caught generating mail spam are added into the database and mail transfer agents like Exim are<br>able to query the database to confirm that a source is not a spammer before accepting mail from it.<br>
Since the advent of the RBL, several other similar lists have been created. One of the most useful is the<br>Dial−Up List (DUL), which lists the IP addresses of dial−up hosts. These should normally send outgoing<br>mail only to their ISP's mail servers. Many sites block mail from external dial−ups because when such a host<br>avoids its own ISP's server, it is usually up to no good.<br>
Exim provides support for the real−time and other blacklists. It is very easily configured. To enable it, add<br>the following lines to your&nbsp;/etc/exim.conf&nbsp;file:<br>
# Vixie / MAPS RBL (http://maps.vix.com/rbl)<br>
rbl_domains = rbl.maps.vix.com : dul.maps.vix.com<br>
This example checks both the RBL and the DUL, rejecting any messages from hosts that are on either list.<br>The&nbsp;rbl_hosts&nbsp;option allows you to specify groups of hosts to which RBL checking does (or does not)<br>apply. The default setting is:<br>
rbl_hosts = *<br>
which means that all hosts are subject to RBL checking. If you wanted to override blacklisting and accept<br>mail from a specific host without performing the RBL checking you could, for example, use:<br>
rbl_hosts = ! nocheck.example.com : *<br>
The exclamation mark before the first item in this list indicates a negated item: if the calling host is<br>nocheck.example.com, it will match this item. But because of the negation, RBL checking is not performed.<br>Any other host matches the second item in the list.<br>
19.7. Protecting Against Mail Spam<br>
394<br>
<hr>
<A name=411></a><b>19.8. UUCP Setup</b><br>
&nbsp;Exim does not have any specific code for transporting mail via UUCP, nor does it support UUCP bang path<br>addresses. However, if domain addressing is being used, Exim can be interfaced to UUCP fairly simply. Here<br>is a configuration fragment for sending certain domains to UUCP, taken from a real installation:<br>
# Transport<br>
uucp:<br>
&nbsp; driver = pipe<br>
&nbsp; user = nobody<br>
&nbsp; command = &quot;/usr/local/bin/uux −r − \<br>
&nbsp; &nbsp; ${substr_−5:$host}!rmail ${local_part}&quot;<br>
&nbsp; return_fail_output = true<br>
# Router<br>
uucphost:<br>
&nbsp; transport = uucp<br>
&nbsp; driver = domainlist<br>
&nbsp; route_file = /usr/exim/uucphosts<br>
&nbsp; search_type = lsearch<br>
In a complete configuration file, the transport would be inserted among the other transports, and the router<br>probably defined as the first router. The file&nbsp;/usr/exim/uucphosts&nbsp;contains entries like this:<br>
darksite.example.com: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; darksite.UUCP<br>
which is interpreted to mean, Send mail addressed to the domain&nbsp;<i>darksite.example.com</i>&nbsp;to the UUCP host<br><i>darksite</i>. This configuration could be set up more simply without the router adding the suffix .UUCP to<br><i>darksite</i>&nbsp;only to have the transport take it off again, but this way is useful because it makes clear the<br>distinction between the domain name&nbsp;<i>darksite.example.com</i>&nbsp;and the UUCP host name&nbsp;<i>darksite</i>.<br>
Whenever the router comes across a domain that is in the route file, it will send the address to the UUCP<br>transport, which subsequently pipes it to the&nbsp;<b>uux</b><a href="TLNAGs.html#320">&nbsp;command (described in&nbsp;Chapter 16). If there is a problem,<br></a><b>uux</b>&nbsp;will generate some output and terminate with a non−zero error code. The setting of<br>return_fail_output&nbsp;makes sure that the output is returned to the sender.<br>
If incoming UUCP messages are grouped into files in batched SMTP format, they can be passed directly to<br>Exim using a command like this:<br>
exim −bS &lt;/var/uucp/incoming/001<br>
However, there is one catch. When Exim receives a message locally, it insists that the sender is the logged−in<br>user that calls it, but for a UUCP batch we want the senders to be taken from the incoming messages. Exim<br>will do this if the process that calls it is running as a&nbsp;<i>trusted user</i>. If you arrange for incoming UUCP to be<br>handled by a user called uucp, for example, you need to specify:<br>
trusted_users = uucp<br>
in the Exim configuration file to ensure that sender addresses are correctly handled.<br>
19.8. UUCP Setup<br>
395<br>
<hr>
<A name=412></a><b>Chapter 20. Netnews</b><br>
Netnews, or Usenet news, remains one of the most important and highly valued services on computer<br>networks today. Dismissed by some as a mire of unsolicited commercial email and pornography, Netnews<br>still maintains several cases of the high−quality discussion groups that made it a critical resource in pre−web<br>days. Even in these times of a billion web pages, Netnews is still a source for online help and community on<br>many topics.<br>
Chapter 20. Netnews<br>
396<br>
<hr>
<A name=413></a><b>20.1. Usenet History</b><br>
The idea of network news was born in 1979 when two graduate students, Tom Truscott and Jim Ellis,<br>thought of using UUCP to connect machines for information exchange among Unix users. They set up a<br>small network of three machines in North Carolina.<br>
Initially, traffic was handled by a number of shell scripts (later rewritten in C), but they were never released<br>to the public. They were quickly replaced by A News, the first public release of news software.<br>
A News was not designed to handle more than a few articles per group and day. When the volume continued<br>to grow, it was rewritten by Mark Horton and Matt Glickman, who called it the B release (a.k.a. B News).<br>The first public release of B News was version 2.1 in 1982. It was expanded continuously, with several new<br>features added. Its current version is B News 2.11. It is slowly becoming obsolete; its last official maintainer<br>switched to INN.<br>
&nbsp;Geoff Collyer and Henry Spencer rewrote B News and released it in 1987; this is release C, or C News.<br>Since its release, there have been a number of patches to C News, the most prominent being the C News<br>Performance Release. On sites that carry a large number of groups, the overhead involved in frequently<br>invoking&nbsp;<b>relaynews</b>, which is responsible for dispatching incoming articles to other hosts, is significant. The<br>Performance Release adds an option to&nbsp;<b>relaynews</b>&nbsp;that allows it to run in&nbsp;<i>daemon mode</i>, through which the<br>program puts itself in the background. The Performance Release is the C News version currently included in<br>most Linux releases. We describe C News in detail in&nbsp;<a href="TLNAGs.html#418">Chapter 21</a>.<br>
&nbsp;All news releases up to C were primarily targeted for UUCP networks, although they could be used in other<br>environments, as well. Efficient news transfer over networks like TCP/IP or DECNet required a new scheme.<br>So in 1986, the&nbsp;<i>Network News Transfer Protocol</i>&nbsp;(NNTP) was introduced. It is based on network connections<br>and specifies a number of commands to interactively transfer and retrieve articles.<br>
There are a number of NNTP−based applications available from the Net. One of them is the&nbsp;<b>nntpd</b>&nbsp;package<br>by Brian Barber and Phil Lapsley, which you can use to provide newsreading service to a number of hosts<br>inside a local network.&nbsp;<b>nntpd</b>&nbsp;was designed to complement news packages, such as B News or C News, to<br>give them NNTP features. If you want to use NNTP with the C News server, you should read&nbsp;<a href="TLNAGs.html#441">Chapter 22</a>,<br>which explains how to configure the&nbsp;<b>nntpd</b>&nbsp;daemon and run it with C News.<br>
&nbsp;An alternative package supporting NNTP is INN, or&nbsp;<i>Internet News</i>. It is not just a frontend, but a news<br>system in its own right. It comprises a sophisticated news relay daemon that can maintain several concurrent<br>NNTP links efficiently, and is therefore the news server of choice for many Internet sites. We discuss it in<br>detail in&nbsp;<a href="TLNAGs.html#455">Chapter 23</a>.<br>
20.1. Usenet History<br>
397<br>
<hr>
<A name=414></a><IMG src="TLNAG-414_1.png"><br>
<b>20.2. What Is Usenet, Anyway?</b><br>
&nbsp;One of the most astounding facts about Usenet is that it isn't part of any organization, nor does it have any<br>sort of centralized network management authority. In fact, it's part of Usenet lore that except for a technical<br>description, you cannot define&nbsp;<i>what</i>&nbsp;it is; at the risk of sounding stupid, one might define Usenet as a<br>collaboration of separate sites that exchange Usenet news. To be a Usenet site, all you have to do is find<br>another Usenet site and strike an agreement with its owners and maintainers to exchange news with you.<br>Providing another site with news is called&nbsp;<i>feeding</i>&nbsp;it, whence another common axiom of Usenet philosophy<br>originates: Get a feed, and you're on it.<br>
&nbsp;The basic unit of Usenet news is the&nbsp;<i>article</i>. This is a message a user writes and posts to the net. In order<br>to enable news systems to deal with it, it is prepended with administrative information, the so−called article<br>header. It is very similar to the mail header format laid down in the Internet mail standard RFC−822, in that it<br>consists of several lines of text, each beginning with a field name terminated by a colon, which is followed by<br>the field's value.[121]<br>
&nbsp;Articles are submitted to one or more&nbsp;<i>newsgroup</i>. One may consider a newsgroup a forum for articles<br>relating to a common topic. All newsgroups are organized in a hierarchy, with each group's name indicating<br>its place in the hierarchy. This often makes it easy to see what a group is all about. For example, anybody can<br>see from the newsgroup name that comp.os.linux.announce is used for announcements concerning a<br>computer operating system named Linux.<br>
&nbsp;These articles are then exchanged between all Usenet sites that are willing to carry news from this group.<br>When two sites agree to exchange news, they are free to exchange whatever newsgroups they like, and may<br>even add their own local news hierarchies. For example, groucho.edu might have a news link to<br>barnyard.edu, which is a major news feed, and several links to minor sites which it feeds news. Now<br>Barnyard College might receive all Usenet groups, while GMU only wants to carry a few major hierarchies<br>like sci, comp, or rec. Some of the downstream sites, say a UUCP site called brewhq, will want to carry even<br>fewer groups, because they don't have the network or hardware resources. On the other hand, brewhq might<br>want to receive newsgroups from the fj hierarchy, which GMU doesn't carry. It therefore maintains another<br>link with gargleblaster.com, which carries all fj groups and feeds them to brewhq. The news flow is shown in<br><a href="TLNAGs.html#414">Figure 20−1</a>.<br>
<b>Figure 20−1. Usenet newsflow through Groucho Marx University</b><br>
20.2. What Is Usenet, Anyway?<br>
398<br>
<hr>
<A name=415></a>Linux Network Administrators Guide<br>
The labels on the arrows originating from brewhq may require some explanation, though. By default, it wants<br>all locally generated news to be sent to groucho.edu. However, as groucho.edu does not carry the fj groups,<br>there's no point in sending it any messages from those groups. Therefore, the feed from brewhq to GMU is<br>labeled&nbsp;all,!fj, meaning that all groups except those below fj are sent to it.<br>
20.2. What Is Usenet, Anyway?<br>
399<br>
<hr>
<A name=416></a><b>20.3. How Does Usenet Handle News?</b><br>
&nbsp;Today, Usenet has grown to enormous proportions. Sites that carry the whole of Netnews usually transfer<br>something like a paltry 60 MB a day.[122]&nbsp;Of course, this requires much more than pushing files around. So<br>let's take a look at the way most Unix systems handle Usenet news.<br>
News begins when users create and post articles. Each user enters a message into a special application called<br>a newsreader, which formats it appropriately for transmission to the local news server. In Unix environments<br>the newsreader commonly uses the&nbsp;<b>inews</b>&nbsp;command to transmit articles to the newsserver using the TCP/IP<br>protocol. But it's also possible to write the article directly into a file in a special directory called the news<br>spool. Once the posting is delivered to the local news server, it takes responsibility for delivering the article<br>to other news users.<br>
News is distributed through the net by various transports. The medium used to be UUCP, but today the<br>main traffic is carried by Internet sites. The routing algorithm used is called&nbsp;<i>flooding</i>. Each site maintains a<br>number of links (<i>news feeds</i>) to other sites. Any article generated or received by the local news system is<br>forwarded to them, unless it has already been at that site, in which case it is discarded. A site may find out<br>about all other sites the article has already traversed by looking at the&nbsp;Path:&nbsp;header field. This header<br>contains a list of all systems through which the article has been forwarded in bang path notation.<br>
&nbsp;To distinguish articles and recognize duplicates, Usenet articles have to carry a message ID (specified in<br>the&nbsp;Message−Id:&nbsp;header field), which combines the posting site's name and a serial number into<br>&lt;<i>serial</i>@<i>site</i>&gt;. For each article processed, the news system logs this ID into a&nbsp;<i>history</i>&nbsp;file, against<br>which all newly arrived articles are checked.<br>
&nbsp;The flow between any two sites may be limited by two criteria. For one, an article is assigned a distribution<br>(in the&nbsp;Distribution:&nbsp;header field), which may be used to confine it to a certain group of sites. On the<br>other hand, the newsgroups exchanged may be limited by both the sending and receiving systems. The set of<br>newsgroups and distributions allowed to be transmitted to a site are usually kept in the&nbsp;sys&nbsp;file.<br>
&nbsp;The sheer number of articles usually requires that improvements be made to the above scheme. On UUCP<br>networks, systems collect articles over a period of time and combine them into a single file, which is<br>compressed and sent to the remote site. This is called&nbsp;<i>batching</i>.<br>
&nbsp;An alternative technique is the&nbsp;<i>ihave/sendme</i>&nbsp;protocol that prevents duplicate articles from being<br>transferred, thus saving net bandwidth. Instead of putting all articles in batch files and sending them along,<br>only the message IDs of articles are combined into a giant ihave message and sent to the remote site. The<br>remote site reads this message, compares it to its history file, and returns the list of articles it wants in a<br>sendme message. Only the requested articles are sent.<br>
Of course, ihave/sendme makes sense only if it involves two big sites that receive news from several<br>independent feeds each, and that poll each other often enough for an efficient flow of news.<br>
Sites that are on the Internet generally rely on TCP/IP−based software that uses the Network News Transfer<br>Protocol (NNTP). NNTP is described in RFC−977; it is responsible for the transfer of news between news<br>servers and provides Usenet access to single users on remote hosts.<br>
&nbsp;NNTP knows three different ways to transfer news. One is a real−time version of ihave/sendme, also<br>referred to as&nbsp;<i>pushing</i>&nbsp;news. The second technique is called&nbsp;<i>pulling</i>&nbsp;news, in which the client requests a list of<br>articles in a given newsgroup or hierarchy that have arrived at the server's site after a specified date, and<br>
20.3. How Does Usenet Handle News?<br>
400<br>
<hr>
<A name=417></a>Linux Network Administrators Guide<br>
chooses those it cannot find in its history file. The third technique is for interactive newsreading and allows<br>you or your newsreader to retrieve articles from specified newgroups, as well as post articles with incomplete<br>header information.<br>
&nbsp;At each site, news is kept in a directory hierarchy below&nbsp;/var/spool/news, each article in a separate<br>file, and each newsgroup in a separate directory. The directory name is made up of the newsgroup name, with<br>the components being the path components. Thus, comp.os.linux.misc articles are kept in<br>/var/spool/news/comp/os/linux/misc. The articles in a newsgroup are assigned numbers in the<br>order they arrive. This number serves as the file's name. The range of numbers of articles currently online is<br>kept in a file called&nbsp;active, which at the same time serves as a list of newsgroups your site knows.<br>
&nbsp;Since disk space is a finite resource, you have to start throwing away articles after some time.&nbsp;[123]&nbsp;This is<br>called&nbsp;<i>expiring</i>. Usually, articles from certain groups and hierarchies are expired at a fixed number of days<br>after they arrive. This may be overridden by the poster by specifying a date of expiration in the<br>Expires:&nbsp;field of the article header.<br>
You now have enough information to choose what to read next. UUCP users should read about C−News in<br><a href="TLNAGs.html#418">Chapter 21. If you're using a TCP/IP network, read about NNTP in&nbsp;</a><a href="TLNAGs.html#441">Chapter 22. If you need to transfer<br></a>moderate amounts of news over TCP/IP, the server described in that chapter may be enough for you. To<br>install a heavy−duty news server that can handle huge volumes of material, go on to read about InterNet<br><a href="TLNAGs.html#455">News in&nbsp;Chapter 23.</a><br>
20.3. How Does Usenet Handle News?<br>
401<br>
<hr>
<A name=418></a><b>Chapter 21. C News</b><br>
One of the most popular software packages for Netnews is C News. It was designed for sites that carry news<br>over UUCP links. This chapter will discuss the central concepts of C News, basic installation, and<br>maintenance tasks.<br>
&nbsp;C News stores its configuration files in&nbsp;/etc/news, and most of its binaries are kept below the<br>/usr/lib/news/&nbsp;directory. Articles are kept below&nbsp;/var/spool/news. You should make sure that<br>virtually all files in these directories are owned by user news or group news. Most problems arise from files<br>being inaccessible to C News. Use&nbsp;<b>su</b>&nbsp;to become the user news before you touch anything in the directory.<br>The only exception is the&nbsp;<b>setnewsids</b>&nbsp;command, which is used to set the real user ID of some news programs.<br>It must be owned by root and have the setuid bit set.<br>
In this chapter, we describe all C News configuration files in detail and show you what you have to do to<br>keep your site running.<br>
Chapter 21. C News<br>
402<br>
<hr>
<A name=419></a><b>21.1. Delivering News</b><br>
&nbsp;Articles can be fed to C News in several ways. When a local user posts an article, the newsreader usually<br>hands it to the&nbsp;<b>inews</b>&nbsp;command, which completes the header information. News from remote sites, be it a<br>single article or a whole batch, is given to the&nbsp;<b>rnews</b>&nbsp;command, which stores it in the<br>/var/spool/news/in.coming&nbsp;directory, from where it will be picked up at a later time by&nbsp;<b>newsrun</b>.<br>With any of these two techniques, however, the article will eventually be handed to the&nbsp;<b>relaynews</b>&nbsp;command.<br>
&nbsp;For each article, the&nbsp;<b>relaynews</b>&nbsp;command first checks if the article has already been seen at the local site by<br>looking up the message ID in the&nbsp;history&nbsp;file. Duplicate articles are dropped. Then&nbsp;<b>relaynews</b>&nbsp;looks at the<br>Newsgroups:&nbsp;header line to find out if the local site requests articles from any of these groups. If it does,<br>and the newsgroup is listed in the&nbsp;active&nbsp;file,&nbsp;<b>relaynews</b>&nbsp;tries to store the article in the corresponding<br>directory in the news spool area. If this directory does not exist, it is created. The article's message ID is then<br>logged to the&nbsp;history&nbsp;file. Otherwise,&nbsp;<b>relaynews</b>&nbsp;drops the article.<br>
Sometimes&nbsp;<b>relaynews</b>&nbsp;fails to store an incoming article because a group to which it has been posted is not<br>listed in your&nbsp;active&nbsp;file. In this case, the article is moved to the junk group.[124]<b>&nbsp;relaynews</b>&nbsp;also checks<br>for stale or misdated articles and reject them. Incoming batches that fail for any other reason are moved to<br>/var/spool/news/in.coming/bad, and an error message is logged.<br>
After this, the article is relayed to all other sites that request news from these groups, using the transport<br>specified for each particular site. To make sure an article isn't sent to a site that has already seen it, each<br>destination site is checked against the article's&nbsp;Path:&nbsp;header field, which contains the list of sites the article<br>has traversed so far, written in the UUCP−style bang−path source−routing style described in&nbsp;<a href="TLNAGs.html#349">Chapter 17</a>. If<br>the destination site's name does not appear in this list, the article is sent to it.<br>
&nbsp;C News is commonly used to relay news between UUCP sites, although it is also possible to use it in an<br>NNTP environment. To deliver news to a remote UUCP site, either in single articles or whole batches,&nbsp;<b>uux</b>&nbsp;is<br>used to execute the&nbsp;<b>rnews</b>&nbsp;command on the remote site and feed the article or batch to it on standard input.<br>Refer to&nbsp;<a href="TLNAGs.html#320">Chapter 16</a>, for more information on UUCP.<br>
&nbsp;Batching is the term used to describe sending large bundles of individual articles all in one transmission.<br>When batching is enabled for a given site, C News does not send any incoming article immediately; instead,<br>it appends its path name to a file, usually called&nbsp;out.going/site/togo. Periodically, a program is<br>executed from a&nbsp;<b>crontab</b>&nbsp;entry by the&nbsp;<b>cron</b>&nbsp;program, which reads this file and bundles all of the listed articles<br>into one or more file, optionally compressing them and sending them to&nbsp;<b>rnews</b>&nbsp;at the remote site.[125]<br>
<a href="TLNAGs.html#419">Figure 21−1</a>&nbsp;shows the news flow through&nbsp;<b>relaynews</b>. Articles may be relayed to the local site (denoted by<br>ME), to a site named ponderosa via email, and a site named moria, for which batching is enabled.<br>
<b>Figure 21−1. News flow through relaynews</b><br>
21.1. Delivering News<br>
403<br>
<hr>
<A name=420></a><IMG src="TLNAG-420_1.png"><br>
Linux Network Administrators Guide<br>
21.1. Delivering News<br>
404<br>
<hr>
<A name=421></a><b>21.2. Installation</b><br>
&nbsp;C News should be available in a prepackaged format for any modern Linux distribution, so installation will<br>be easy. If not, or if you want to install from the original source distribution, then of course you can.[126]&nbsp;No<br>matter how you install it, you will need to edit the C News configuration files. Their formats are described in<br>the following list:<br>
<i>sys</i><br>
The&nbsp;sys&nbsp;file controls which newsgroups your site receives and forwards. We discuss it in detail in<br>the following section.<br>
<i>active</i><br>
Not usually edited by the administration; contains directions for handling articles in each newsgroup<br>the site handles.<br>
<i>organization</i><br>
This file should contain your organization's name, for example, Virtual Brewery, Inc. On your<br>home machine, enter private site, or anything else you like. Most people will not consider your<br>site properly configured if you haven't customized this file.<br>
<i>newsgroups</i><br>
This file is a list of all newsgroups, with a one−line description of each one's purpose. These<br>descriptions are frequently used by your newsreader when displaying the list of all groups to which<br>you are subscribed.<br>
<i>mailname</i><br>
Your site's mail name, e.g., vbrew.com.<br>
<i>whoami</i><br>
Your site's name for news purposes. Quite often, the UUCP site name is used, e.g., vbrew.<br>
<i>explist</i><br>
You should probably edit this file to reflect your preferred expiration times for special newsgroups.<br>Disk space may play an important role in your choices.<br>
&nbsp;To create an initial hierarchy of newsgroups, obtain&nbsp;active&nbsp;and&nbsp;newsgroups&nbsp;files from the site that<br>feeds you. Install them in&nbsp;/etc/news, making sure they are owned by news and have a mode of 644, using<br>the&nbsp;<b>chmod</b>&nbsp;command. Remove all to.* groups from the active file, and add to.my−site, to.feed−site, junk, and<br>control. The to.* groups are normally used for exchanging ihave/sendme messages, but you should list them<br>regardless of whether you plan to use ihave/sendme or not. Next, replace all article numbers in the second<br>and third field of&nbsp;active&nbsp;using the following commands:<br>
#&nbsp;<b>cp active active.old</b><br>
21.2. Installation<br>
405<br>
<hr>
<A name=422></a>Linux Network Administrators Guide<br>
#&nbsp;<b>sed 's/ [0−9]* [0−9]* / 0000000000 00001 /' active.old &gt; active</b><br>
#&nbsp;<b>rm active.old</b><br>
The second command invokes the&nbsp;<b>sed</b>&nbsp;stream editor. This invocation replaces two strings of digits with a<br>string of zeroes and the string&nbsp;000001, respectively.<br>
Finally, create the news spool directory and the subdirectories used for incoming and outgoing news:<br>
#&nbsp;<b>cd /var/spool</b><br>
#&nbsp;<b>mkdir news news/in.coming news/out.going news/out.master</b><br>
#&nbsp;<b>chown −R news.news news</b><br>
#&nbsp;<b>chmod −R 755 news</b><br>
If you're using precompiled newsreaders sourced from a different distribution to the C News server you have<br>running, you may find that some expect the news spool in&nbsp;/usr/spool/news&nbsp;rather than<br>/var/spool/news. If your newsreader doesn't seem to find any articles, create a symbolic link from<br>/usr/spool/news&nbsp;to&nbsp;/var/spool/news&nbsp;like this:<br>
#&nbsp;<b>ln −sf /usr/spool/news /var/spool/news</b><br>
Now you are ready to receive news. Note that you don't have to create the individual newsgroup spool<br>directories. C News automatically creates spool directories for any newsgroup it receives an article for, if one<br>doesn't already exist.<br>
In particular, this happens to&nbsp;<i>all</i>&nbsp;groups to which an article has been cross−posted. So, after a while, you will<br>find your news spool cluttered with directories for newsgroups you have never subscribed to, like<br>alt.lang.teco. You may prevent this by either removing all unwanted groups from&nbsp;active, or by regularly<br>running a shell script that removes all empty directories below&nbsp;/var/spool/news&nbsp;(except<br>out.going&nbsp;and&nbsp;in.coming, of course).<br>
&nbsp;C News needs a user to send error messages and status reports to. By default, this is usenet. If you use the<br>default, you have to set up an alias for it that forwards all of its mail to one or more responsible person. You<br>may also override this behavior by setting the environment variable NEWSMASTER to the appropriate<br>name. You have to do so in news's&nbsp;crontab&nbsp;file, as well as every time you invoke an administrative tool<br>manually, so installing an alias is probably easier. Mail aliases are described in&nbsp;<a href="TLNAGs.html#363">Chapter 18</a>, and&nbsp;<a href="TLNAGs.html#398">Chapter 19</a>.<br>
&nbsp;While you're hacking&nbsp;/etc/passwd, make sure that every user has her real name in the pw_gecos field<br>of the password file (this is the fourth field). It is a question of Usenet netiquette that the sender's real name<br>appears in the&nbsp;From:&nbsp;field of the article. Of course, you will want to do so anyway when you use mail.<br>
21.2. Installation<br>
406<br>
<hr>
<A name=423></a><b>21.3. The sys File</b><br>
&nbsp;The&nbsp;sys&nbsp;file, located in&nbsp;/etc/news, controls which hierarchies you receive and forward to other sites.<br>Although there are maintenance tools named&nbsp;<b>addfeed</b>&nbsp;and&nbsp;<b>delfeed</b>, we think it's better to maintain this file by<br>hand.<br>
The&nbsp;sys&nbsp;file contains entries for each site to which you forward news, as well as a description of the groups<br>you will accept. The first line is a ME entry that describes your system. It's a safe bet to use the following:<br>
ME:all/all::<br>
You also have to add a line for each site to which you feed news. Each line looks like this:<br>
<i>site</i>[/<i>exclusions</i>]:<i>grouplist</i>[/<i>distlist</i>][:<i>flags</i>[:<i>cmds</i>]]<br>
Entries may be continued across newlines using a backslash (\) at the end of the line to be continued. A hash<br>sign (#) denotes a comment.<br>
<i>site</i><br>
This is the name of the site the entry applies to. One usually chooses the site's UUCP name for this.<br>There has to be an entry for your site in the&nbsp;sys&nbsp;file too, or you will not receive any articles yourself.<br>
&nbsp;The special site name ME denotes your site. The ME entry defines all groups you are willing to<br>store locally. Articles that aren't matched by the ME line will go to the junk group.<br>
&nbsp;C News rejects any articles that have already passed through this site to prevent loops. C News<br>does this by ensuring that the local site name does not appear in the&nbsp;Path:&nbsp;of the article. Some sites<br>may be known by a number of valid names. For example, some sites use their fully qualified domain<br>name in this field, or an alias like&nbsp;news.<i>site.domain</i>. To ensure the loop prevention mechanism<br>works, it is important to add all aliases to the exclusion list, separating them by commas.<br>
For the entry applying to site moria, for instance, the&nbsp;<i>site</i>&nbsp;field would contain<br>moria/moria.orcnet.org. If moria were also by an alias of news.orcnet.org, then our&nbsp;<i>site</i>&nbsp;field would<br>contain moria/moria.orcnet.org,news.orcnet.org.<br>
<i>grouplist</i><br>
&nbsp;This is a comma−separated subscription list of groups and hierarchies for this particular site. A<br>hierarchy may be specified by giving the hierarchy's prefix (such as comp.os for all groups whose<br>names start with this prefix), optionally followed by the keyword all (e.g., comp.os.all).<br>
You can exclude a hierarchy or group from forwarding by preceding it with an exclamation mark. If<br>a newsgroup is checked against the list, the longest match applies. For example, if<br><i>grouplist</i>&nbsp;contains this list:<br>
!comp,comp.os.linux,comp.folklore.computers<br>
no groups from the comp hierarchy except comp.folklore.computers and all groups below<br>comp.os.linux will be fed to that site.<br>
21.3. The sys File<br>
407<br>
<hr>
<A name=424></a>Linux Network Administrators Guide<br>
If the site requests to be forwarded all news you receive yourself, enter all as&nbsp;<i>grouplist</i>.<br>
<i>distlist</i><br>
&nbsp;This value is offset from the&nbsp;<i>grouplist</i>&nbsp;by a slash and contains a list of distributions to be<br>forwarded. Again, you may exclude certain distributions by preceding them with an exclamation<br>mark. All distributions are denoted by all. Omitting&nbsp;<i>distlist</i>&nbsp;implies a list of all.<br>
For example, you may use a distribution list of all,!local to prevent news meant only for local use<br>from being sent to remote sites.<br>
There are usually at least two distributions: world, which is often the default distribution used when<br>none is specified by the user, and local. There may be other distributions that apply to a certain<br>region, state, country, etc. Finally, there are two distributions used by C News only; these are<br>sendme and ihave, and are used for the sendme/ihave protocol.<br>
The use of distributions is a subject of debate. The distribution field in a news article can be created<br>arbitrarily, but for a distribution to be effective, the news servers in the network must know it. Some<br>misbehaving newsreaders create bogus distributions by simply assuming the top−level newsgroup<br>hierarchy of the article destination is a reasonable distribution. For example, one might assume<br>comp to be a reasonable distribution to use when posting to the<br>comp.os.linux.networking newsgroup. Distributions that apply to regions are often questionable, too,<br>because news may travel outside of your region when sent across the Internet.[127]&nbsp;Distributions<br>applying to an organization, however, are very meaningful; e.g., to prevent confidential information<br>from leaving the company network. This purpose, however, is generally served better by creating a<br>separate newsgroup or hierarchy.<br>
<i>flags</i><br>
This option describes certain parameters for the feed. It may be empty or a combination of the<br>following:<br>
<i>F</i><br>
&nbsp;This flag enables batching.<br>
<i>f</i><br>
&nbsp;This is almost identical to the&nbsp;F&nbsp;flag, but allows C News to calculate the size of outgoing batches<br>more precisely, and should probably be used in preference.<br>
<i>I</i><br>
&nbsp;This flag makes C News produce an article list suitable for use by ihave/sendme. Additional<br>modifications to the&nbsp;sys&nbsp;and the&nbsp;batchparms&nbsp;file are required to enable ihave/sendme.<br>
<i>n</i><br>
&nbsp;This creates batch files for active NNTP transfer clients like&nbsp;<b>nntpxmit&nbsp;</b>&nbsp;(see&nbsp;<a href="TLNAGs.html#441">Chapter 22). The batch<br></a>files contain the article's filename along with its message ID.<br>
21.3. The sys File<br>
408<br>
<hr>
<A name=425></a>Linux Network Administrators Guide<br>
<i>L</i><br>
This tells C News to transmit only articles posted at your site. This flag may be followed by a<br>decimal number&nbsp;<i>n</i>, which makes C News transfer articles posted only within&nbsp;<i>n</i>&nbsp;hops from your site. C<br>News determines the number of hops from the&nbsp;<i>Path:</i>&nbsp;field.<br>
<i>u</i><br>
This tells C News to batch only articles from unmoderated groups.<br>
<i>m</i><br>
This tells C News to batch only articles from moderated groups.<br>
You may use at most one of&nbsp;F,&nbsp;f,&nbsp;I, or&nbsp;n.<br>
<i>cmds</i><br>
&nbsp;This field contains a command that will be executed for each article, unless you enable batching. The<br>article will be fed to the command on standard input. This should be used for very small feed only; otherwise,<br>the load on both systems will be too high.<br>
The default command is:<br>
uux − −r −z&nbsp;<i>remote−system</i>!rnews<br>
This invokes&nbsp;<b>rnews</b>&nbsp;on the remote system, feeding it the article on standard input.<br>
The default search path for commands given in this field is&nbsp;/bin:/usr/bin:/usr/lib/news/batch.<br>The latter directory contains a number of shell scripts whose names start with&nbsp;<b>via</b>; they are briefly described<br>later in this chapter.<br>
&nbsp;If batching is enabled using one of the&nbsp;F,&nbsp;f,&nbsp;I, or&nbsp;n&nbsp;flags, C News expects to find a filename in this field<br>rather than a command. If the filename does not begin with a slash (/), it is assumed to be relative to<br>/var/spool/news/out.going. If the field is empty, it defaults to&nbsp;remote−system/togo. The file<br>is expected to be in the same format as the&nbsp;remote−system/togo&nbsp;file and contain a list of articles to<br>transmit.<br>
When setting up C News, you will most probably have to write your own&nbsp;sys&nbsp;file. Here is a sample file for<br>vbrew.com, from which you may copy what you need:<br>
# We take whatever they give us.<br>
ME:all/all::<br>
# We send everything we receive to moria, except for local and<br>
# brewery−related articles. We use batching.<br>
moria/moria.orcnet.org:all,!to,to.moria/all,!local,!brewery:f:<br>
# We mail comp.risks to jack@ponderosa.uucp<br>
ponderosa:comp.risks/all::rmail jack@ponderosa.uucp<br>
# swim gets a minor feed<br>
swim/swim.twobirds.com:comp.os.linux,rec.humor.oracle/all,!local:f:<br>
# Log mail map articles for later processing<br>
usenet−maps:comp.mail.maps/all:F:/var/spool/uumaps/work/batch<br>
21.3. The sys File<br>
409<br>
<hr>
<A name=426></a><b>21.4. The active File</b><br>
&nbsp;The&nbsp;active&nbsp;file is located in&nbsp;/etc/, and lists all groups known at your site and the articles currently<br>online. You will rarely have to touch it, but we explain it nevertheless for sake of completion. Entries take the<br>following form:<br>
<i>newsgroup&nbsp;high&nbsp;low&nbsp;perm</i><br>
<i>newsgroup</i>&nbsp;is the group's name.&nbsp;<i>low</i>&nbsp;and&nbsp;<i>high</i>&nbsp;are the lowest and highest numbers of articles currently<br>available. If none are available at the moment,&nbsp;<i>low</i>&nbsp;is equal to&nbsp;<i>high</i>+1.<br>
At least that's what the&nbsp;<i>low</i>&nbsp;field is meant to do. However, for efficiency, C News doesn't update this field.<br>This wouldn't be such a big loss if there weren't newsreaders that depend on it. For instance,&nbsp;<b>trn</b>&nbsp;checks this<br>field to see if it can purge any articles from its thread database. To update the&nbsp;<i>low</i>&nbsp;field, you therefore have<br>to run the&nbsp;<b>updatemin</b>&nbsp;command regularly (or, in earlier versions of C News, the&nbsp;<b>upact</b>&nbsp;script).<br>
<i>perm</i>&nbsp;is a parameter detailing the access users are granted to the group. It takes one of the following values:<br>
<i>y</i><br>
Users are allowed to post to this group.<br>
<i>n</i><br>
Users are not allowed to post to this group. However, the group may still be read.<br>
<i>x</i><br>
This group has been disabled locally. This happens sometimes when news administrators (or their<br>superiors) take offense at articles posted to certain groups.<br>
Articles received for this group are not stored locally, although they are forwarded to the sites that<br>request them.<br>
<i>m</i><br>
This denotes a moderated group. When a user tries to post to this group, an intelligent newsreader<br>notifies her of this and send the article to the moderator instead. The moderator's address is taken<br>from the&nbsp;moderators&nbsp;file in&nbsp;/var/lib/news.<br>
<i>=real−group</i><br>
This marks&nbsp;<i>newsgroup</i>&nbsp;as being a local alias for another group, namely&nbsp;<i>real−group</i>. All articles<br>posted to&nbsp;<i>newsgroup</i>&nbsp;will be redirected to it.<br>
In C News, you will generally not have to access this file directly. Groups can be added or deleted locally<br>using&nbsp;<b>addgroup</b>&nbsp;and&nbsp;<b>delgroup</b><a href="TLNAGs.html#439">&nbsp;(see the section&nbsp;Section 21.10&nbsp;later in this chapter). A newgroup control<br></a>message adds a group for the whole of Usenet, while a rmgroup message deletes a group.&nbsp;<i>Never send such a<br>message yourself!</i>&nbsp;For instructions on how to create a newsgroup, read the monthly postings in<br>news.announce.newusers.<br>
21.4. The active File<br>
410<br>
<hr>
<A name=427></a>Linux Network Administrators Guide<br>
The&nbsp;active.times&nbsp;file is closely related to the&nbsp;active&nbsp;file. Whenever a group is created, C News logs a<br>message to this file containing the name of the group created, the date of creation, whether it was done by a<br>newgroup control message or locally, and who did it. This is convenient for newsreaders that may notify the<br>user of any recently created groups. It is also used by the&nbsp;<b>NEWGROUPS</b>&nbsp;command of NNTP.<br>
21.4. The active File<br>
411<br>
<hr>
<A name=428></a><b>21.5. Article Batching</b><br>
&nbsp;News batches follow a particular format that is the same for B News, C News, and INN. Each article is<br>preceded by a line like this:<br>
#! rnews&nbsp;<i>count</i><br>
<i>count</i>&nbsp;is the number of bytes in the article. When you use batch compression, the resulting file is<br>compressed as a whole and preceded by another line, indicated by the message to be used for unpacking. The<br>standard compression tool is compress, which is marked by:<br>
#! cunbatch<br>
Sometimes, when the news server sends batches via mail software that removes the eighth bit from all data, a<br>compressed batch may be protected using what is called&nbsp;<i>c7−encoding</i>; these batches will be marked by<br><b>c7unbatch</b>.<br>
When a batch is fed to&nbsp;<b>rnews</b>&nbsp;on the remote site, it checks for these markers and processes the batch<br>appropriately. Some sites also use other compression tools, like&nbsp;<b>gzip</b>, and precede their gzipped files with the<br>word&nbsp;<b>zunbatch</b>&nbsp;instead. C News does not recognize nonstandard headers like these; you have to modify the<br>source to support them.<br>
&nbsp;In C News, article batching is performed by&nbsp;/usr/lib/news/batch/sendbatches, which takes a<br>list of articles from the&nbsp;site/togo&nbsp;file and puts them into several newsbatches. It should be executed once<br>per hour, or even more frequently, depending on the volume of traffic. Its operation is controlled by the<br>batchparms&nbsp;file in&nbsp;/var/lib/news. This file describes the maximum batch size allowed for each site,<br>the batching and optional compression program to be used, and the transport for delivering it to the remote<br>site. You may specify batching parameters on a per−site basis, as well as a set of default parameters for sites<br>not explicitly mentioned.<br>
When installing C News, you will most likely find a&nbsp;batchparms&nbsp;file in your distribution that contains a<br>reasonable default entry, so there's a good chance that you won't have to touch the file. Just in case, we<br>describe its format. Each line consists of six fields, separated by spaces or tabs:<br>
<i>site&nbsp;size&nbsp;max&nbsp;batcher&nbsp;muncher&nbsp;transport</i><br>
<i>site</i><br>
<i>site</i>&nbsp;is the name of the site to which the entry applies. The&nbsp;togo&nbsp;file for this site must reside in<br>out.going/togo&nbsp;below the news spool. A site name of /default/ denotes the default entry and is<br>to match any site not directly specified with an entry unique to it.<br>
<i>size</i><br>
<i>size</i>&nbsp;is the maximum size of article batches created (before compression). For single articles larger<br>than this, C News makes an exception and puts each in a single batch by itself.<br>
<i>max</i><br>
21.5. Article Batching<br>
412<br>
<hr>
<A name=429></a>Linux Network Administrators Guide<br>
<i>max</i>&nbsp;is the maximum number of batches created and scheduled for transfer before batching stalls for<br>this particular site. This is useful in case the remote site should be down for a long time, because it<br>prevents C News from cluttering your UUCP spool directories with zillions of newsbatches.<br>
C News determines the number of queued batches using the&nbsp;<b>queuelen</b>&nbsp;script in&nbsp;/usr/lib/news/.<br>If you've installed C News in a prepackaged format, the script should not need any editing, but if you<br>choose to use a different flavor of spool directories, for example, Taylor UUCP, you might have to<br>write your own. If you don't care about the number of spool files (because you're the only person<br>using your computer and you don't write articles by the megabyte), you may replace the script's<br>contents by a simple&nbsp;<b>exit 0</b>&nbsp;statement.<br>
<i>batcher</i><br>
The&nbsp;<i>batcher</i>&nbsp;field contains the command used for producing a batch from the list of articles in the<br>togo&nbsp;file. For regular feeds, this is usually&nbsp;<b>batcher</b>. For other purposes, alternative batchers may be<br>provided. For instance, the ihave/sendme protocol requires the article list to be turned into&nbsp;<i>ihave</i>&nbsp;or<br><i>sendme</i>&nbsp;control messages, which are posted to the newsgroup to.site. This is performed by<br><b>batchih</b>&nbsp;and&nbsp;<b>batchsm</b>.<br>
<i>muncher</i><br>
The&nbsp;<i>muncher</i>&nbsp;field specifies the compression command. Usually, this is compcun, a script that<br>produces a compressed batch.[128]&nbsp;Alternatively, suppose you create a muncher that uses&nbsp;<b>gzip</b>, say<br><b>gzipcun</b>&nbsp;(note that you have to write it yourself). You have to make sure that&nbsp;<b>uncompress</b>&nbsp;on the<br>remote site is patched to recognize files compressed with&nbsp;<b>gzip</b>.<br>
If the remote site does not have an&nbsp;<b>uncompress</b>&nbsp;command, you may specify&nbsp;<b>nocomp</b>, which does not<br>do any compression.<br>
<i>transport</i><br>
The last field,&nbsp;<i>transport</i>, describes the transport to be used. A number of standard commands for<br>different transports are available; their names begin with&nbsp;<b>via</b>.&nbsp;<b>sendbatches</b>&nbsp;passes them the<br>destination sitename on the command line. If the&nbsp;batchparms&nbsp;entry is not /default/,<br><b>sendbatches</b>&nbsp;derives the sitename from the&nbsp;<i>site</i>&nbsp;field by stripping it of anything after and including<br>the first dot or slash. If the batchparms entry is /default/, the directory names in&nbsp;out.going&nbsp;are<br>used.<br>
To perform batching for a specific site, use the following command:<br>
#&nbsp;<b>su news −c &quot;/usr/lib/news/batch/sendbatches site&quot;</b><br>
When invoked without arguments,&nbsp;<b>sendbatches</b>&nbsp;handles all batch queues. The interpretation of all<br>depends on the presence of a default entry in&nbsp;batchparms. If one is found, all directories in<br>/var/spool/news/out.going&nbsp;are checked; otherwise,&nbsp;<b>sendbatches</b>&nbsp;cycles through all entries in<br>batchparms, processing just the sites found there. Note that&nbsp;<b>sendbatches</b>, when scanning the<br>out.going&nbsp;directory, takes only those directories that contain no dots or at signs (@) as sitenames.<br>
&nbsp;There are two commands that use&nbsp;<b>uux</b>&nbsp;to execute&nbsp;<b>rnews</b>&nbsp;on the remote system:&nbsp;<b>viauux</b>&nbsp;and&nbsp;<b>viauuxz</b>. The<br>latter sets the&nbsp;−z&nbsp;flag for&nbsp;<b>uux</b>&nbsp;to keep older versions from returning success messages for each article<br>delivered. Another command,&nbsp;<b>viamail</b>, sends article batches to the user rnews on the remote system via mail.<br>
21.5. Article Batching<br>
413<br>
<hr>
<A name=430></a>Linux Network Administrators Guide<br>
Of course, this requires that the remote system somehow feeds all mail for rnews to its local news system. For<br>a complete list of these transports, refer to the&nbsp;newsbatch&nbsp;manual page.<br>
All commands from the last three fields must be located in either&nbsp;out.going/site&nbsp;or<br>/usr/lib/news/batch. Most of them are scripts; you can easily tailor new tools for your personal<br>needs. They are invoked through pipes. The list of articles is fed to the batcher on standard input, which<br>produces the batch on standard output. This is piped into the muncher, and so on.<br>
Here is a sample file:<br>
# batchparms file for the brewery<br>
# site &nbsp; &nbsp; &nbsp; &nbsp;| size &nbsp; |max &nbsp; &nbsp;|batcher &nbsp;|muncher &nbsp; &nbsp;|transport<br>
#−−−−−−−−−−−−−+−−−−−−−−+−−−−−−−+−−−−−−−−−+−−−−−−−−−−−+−−−−−−−−−−−<br>
/default/ &nbsp; &nbsp; &nbsp; 100000 &nbsp;22 &nbsp; &nbsp; &nbsp;batcher &nbsp; compcun &nbsp; &nbsp; viauux<br>
swim &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10000 &nbsp;10 &nbsp; &nbsp; &nbsp;batcher &nbsp; nocomp &nbsp; &nbsp; &nbsp;viauux<br>
21.5. Article Batching<br>
414<br>
<hr>
<A name=431></a><b>21.6. Expiring News</b><br>
&nbsp;In B News, expiration needs to be performed by a program called&nbsp;<b>expire</b>, which took a list of newsgroups<br>as arguments, along with a time specification after which articles had to be expired. To have different<br>hierarchies expire at different times, you had to write a script that invoked&nbsp;<b>expire</b>&nbsp;for each of them separately.<br>C News offers a more convenient solution. In a file called&nbsp;explist, you may specify newsgroups and<br>expiration intervals. A command called&nbsp;<b>doexpire</b>&nbsp;is usually run once a day from&nbsp;<b>cron</b>&nbsp;and processes all<br>groups according to this list.<br>
&nbsp;Occasionally, you may want to retain articles from certain groups even after they have been expired; for<br>example, you might want to keep programs posted to comp.sources.unix. This is called&nbsp;<i>archiving</i>.<br>explist&nbsp;permits you to mark groups for archiving.<br>
An entry in&nbsp;explist&nbsp;looks like this:<br>
<i>grouplist&nbsp;perm&nbsp;times&nbsp;archive</i><br>
<i>grouplist</i>&nbsp;is a comma−separated list of newsgroups to which the entry applies. Hierarchies may be<br>specified by giving the group name prefix, optionally appended with all. For example, for an entry applying<br>to all groups below comp.os, enter either&nbsp;<b>comp.os</b>&nbsp;or&nbsp;<b>comp.os.all</b>.<br>
When&nbsp;<i>expiring</i>&nbsp;news from a group, the name is checked against all entries in&nbsp;explist&nbsp;in the order given.<br>The first matching entry applies. For example, to throw away the majority of comp after four days, except for<br>comp.os.linux.announce, which you want to keep for a week, you simply have an entry for the latter, which<br>specifies a seven−day expiration period, followed by an expiration period for comp, which specifies four<br>days.<br>
The&nbsp;<i>perm</i>&nbsp;field details if the entry applies to moderated, unmoderated, or any groups. It may take the values<br>m, u, or x, which denote moderated, unmoderated, or any type.<br>
The third field,&nbsp;<i>times</i>, usually contains only a single number. This is the number of days after which articles<br>expire if they haven't been assigned an artificial expiration date in an&nbsp;Expires:&nbsp;field in the article header.<br>Note that this is the number of days counting from its&nbsp;<i>arrival</i>&nbsp;at your site, not the date of posting.<br>
The&nbsp;<i>times</i>&nbsp;field may, however, be more complex than that. It may be a combination of up to three numbers<br>separated from one another by dashes. The first denotes the number of days that have to pass before the<br>article is considered a candidate for expiration, even if the&nbsp;Expires:&nbsp;field would have it expire already. It is<br>rarely useful to use a value other than zero. The second field is the previously mentioned default number of<br>days after which it will be expired. The third is the number of days after which an article will be expired<br>unconditionally, regardless of whether it has an&nbsp;Expires:&nbsp;field or not. If only the middle number is given,<br>the other two take default values. These may be specified using the special entry /bounds/, which is described<br>a little later.<br>
The fourth field,&nbsp;<i>archive</i>, denotes whether the newsgroup is to be archived and where. If no archiving is<br>intended, a dash should be used. Otherwise, you either use a full pathname (pointing to a directory) or an at<br>sign (@). The at sign denotes the default archive directory, which must then be given to&nbsp;<b>doexpire</b>&nbsp;by using<br>the&nbsp;−a&nbsp;flag on the command line. An archive directory should be owned by news. When&nbsp;<b>doexpire</b>&nbsp;archives<br>an article from say, comp.sources.unix, it stores it in the directory comp/sources/unix below the archive<br>directory, creating it if necessary. The archive directory itself, however, will not be created.<br>
21.6. Expiring News<br>
415<br>
<hr>
<A name=432></a>Linux Network Administrators Guide<br>
There are two special entries in your&nbsp;explist&nbsp;file that&nbsp;<b>doexpire</b>&nbsp;relies on. Instead of a list of newsgroups,<br>they have the keywords /bounds/ and /expired/. The /bounds/ entry contains the default values for the three<br>values of the&nbsp;<i>times</i>&nbsp;field described previously.<br>
The /expired/ field determines how long C News will hold onto lines in the&nbsp;history&nbsp;file. C News will not<br>remove a line from the history file once the corresponding article(s) have been expired, but will hold onto it<br>in case a duplicate should arrive after this date. If you are fed by only one site, you can keep this value small.<br>Otherwise, a couple of weeks is advisable on UUCP networks, depending on the delays you experience with<br>articles from these sites.<br>
Here is a sample&nbsp;explist&nbsp;file with rather tight expiry intervals:<br>
# keep history lines for two weeks. No article gets more than three months<br>
/expired/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x &nbsp; &nbsp; &nbsp; 14 &nbsp; &nbsp; &nbsp;−<br>
/bounds/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;x &nbsp; &nbsp; &nbsp; 0−1−90 &nbsp;−<br>
# groups we want to keep longer than the rest<br>
comp.os.linux.announce &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;m &nbsp; &nbsp; &nbsp; 10 &nbsp; &nbsp; &nbsp;−<br>
comp.os.linux &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x &nbsp; &nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; −<br>
alt.folklore.computers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;u &nbsp; &nbsp; &nbsp; 10 &nbsp; &nbsp; &nbsp;−<br>
rec.humor.oracle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;m &nbsp; &nbsp; &nbsp; 10 &nbsp; &nbsp; &nbsp;−<br>
soc.feminism &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;m &nbsp; &nbsp; &nbsp; 10 &nbsp; &nbsp; &nbsp;−<br>
# Archive *.sources groups<br>
comp.sources,alt.sources &nbsp; &nbsp; &nbsp; &nbsp;x &nbsp; &nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; @<br>
# defaults for tech groups<br>
comp,sci &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;x &nbsp; &nbsp; &nbsp; 7 &nbsp; &nbsp; &nbsp; −<br>
# enough for a long weekend<br>
misc,talk &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp; &nbsp; −<br>
# throw away junk quickly<br>
junk &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;x &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; −<br>
# control messages are of scant interest, too<br>
control &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; −<br>
# catch−all entry for the rest of it<br>
all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x &nbsp; &nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp; −<br>
Expiring presents several potential problems. One is that your newsreader might rely on the third field of<br>the&nbsp;<i>active</i>&nbsp;file described earlier, which contains the number of the lowest article online. When expiring<br>articles, C News does not update this field. If you need (or want) to have this field represent the real situation,<br>you need to run a program called&nbsp;<b>updatemin</b>&nbsp;after each run of&nbsp;<b>doexpire</b>. (In older versions of C News, a<br>script called&nbsp;<b>upact</b>&nbsp;did this.)<br>
C News does not expire by scanning the newsgroup's directory, but simply checks the&nbsp;history&nbsp;file if the<br>article is due for expiration.[129]&nbsp;If your history file somehow gets out of sync, articles may be around on<br>your disk forever because C News has literally forgotten them.[130]&nbsp;You can repair this by using the<br><b>addmissing</b>&nbsp;script in&nbsp;/usr/lib/news/maint, which will add missing articles to the&nbsp;history&nbsp;file or<br><b>mkhistory</b>, which rebuilds the entire file from scratch. Don't forget to become user news before invoking it,<br>or else you will wind up with a&nbsp;history&nbsp;file unreadable by C News.&nbsp;<br>
21.6. Expiring News<br>
416<br>
<hr>
<A name=433></a><b>21.7. Miscellaneous Files</b><br>
There are a number of files that control the behavior of C News, but are not essential. All of them reside in<br>/etc/news. We describe them briefly here:<br>
<i>newsgroups</i><br>
&nbsp;This is a companion file of&nbsp;active&nbsp;that contains a list of each newsgroup name along with a<br>one−line description of its main topic. This file is automatically updated when C News receives a<br>checknews control message.<br>
<i>localgroups</i><br>
If you have a lot of local groups, you can keep C News from complaining about them each time you<br>receive a&nbsp;checkgroups&nbsp;message by putting their names and descriptions in this file, just as they<br>would appear in&nbsp;newsgroups.<br>
<i>mailpaths</i><br>
&nbsp;This file contains the moderator's address for each moderated group. Each line contains the group<br>name followed by the moderator's email address (offset by a tab).<br>
Two special entries are provided as defaults: backbone and internet. Both provide, in bang−path<br>notation, the path to the nearest backbone site and the site that understands RFC−822 style addresses<br>(user@host). The default entries are:<br>
internet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; backbone<br>
You do not have to change the internet entry if you have&nbsp;<b>exim</b>&nbsp;or&nbsp;<b>sendmail</b>&nbsp;installed; they understand<br>RFC−822 addressing.<br>
The backbone entry is used whenever a user posts to a moderated group whose moderator is not<br>listed explicitly. If the newsgroup's name is alt.sewer and the backbone entry contains path!%s, C<br>News will mail the article to path!alt−sewer, hoping that the backbone machine is able to forward the<br>article. To find out which path to use, ask the news−admin at the site that feeds you. As a last resort,<br>you can also use uunet.uu.net!%s.<br>
<i>distributions</i><br>
This file is not really a C News file, but is used by some newsreaders and&nbsp;<b>nntpd</b>. It contains the list<br>of distributions recognized by your site and a description of their (intended) effects. For example,<br>Virtual Brewery has the following file:<br>
world &nbsp; &nbsp; &nbsp; &nbsp; everywhere in the world<br>
local &nbsp; &nbsp; &nbsp; &nbsp; Only local to this site<br>
nl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Netherlands only<br>
mugnet &nbsp; &nbsp; &nbsp; &nbsp;MUGNET only<br>
fr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;France only<br>
de &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Germany only<br>
brewery &nbsp; &nbsp; &nbsp; Virtual Brewery only<br>
21.7. Miscellaneous Files<br>
417<br>
<hr>
<A name=434></a>Linux Network Administrators Guide<br>
<i>log</i><br>
This file contains a log of all C News activities. It is culled regularly by running&nbsp;<b>newsdaily</b>;<br>copies of the old log files are kept in&nbsp;log.o,&nbsp;log.oo, etc.<br>
<i>errlog</i><br>
This is a log of all error messages created by C News. These messages do not include logs of articles<br>junked due to being sent to an invalid wrong group or other user errors. This file is mailed to the<br>newsmaster (usenet by default) automatically by&nbsp;<b>newsdaily</b>&nbsp;if it is not found empty.<br>
errlog&nbsp;is cleared by&nbsp;<b>newsdaily</b>.&nbsp;errlog.o&nbsp;keeps old copies and companions.<br>
<i>batchlog</i><br>
This file logs all runs of&nbsp;<b>sendbatches</b>. It is usually of scant interest. It is also attended by&nbsp;<b>newsdaily</b>.<br>
<i>watchtime</i><br>
This is an empty file created each time&nbsp;<b>newswatch</b>&nbsp;runs.<br>
21.7. Miscellaneous Files<br>
418<br>
<hr>
<A name=435></a><b>21.8. Control Messages</b><br>
&nbsp;The Usenet news protocol knows a special category of articles that evoke certain responses or actions by<br>the news system. These are called&nbsp;<i>control</i>&nbsp;messages. They are recognized by the presence of a<br><i>Control:</i>&nbsp;field in the article header, which contains the name of the control operation to be performed.<br>There are several types of them, all of which are handled by shell scripts located in&nbsp;/usr/lib/news/ctl.<br>
Most of these messages perform their action automatically at the time the article is processed by C News<br>without notifying the newsmaster. By default, only checkgroups messages will be handed to the newsmaster,<br>but you may change this by editing the scripts.<br>
<b>21.8.1. The cancel Message</b><br>
&nbsp;The most widely known message is cancel, with which a user can cancel an article sent earlier. This<br>effectively removes the article from the spool directories, if it exists. The cancel message is forwarded to all<br>sites that receive news from the groups affected, regardless of whether the article has been seen already. This<br>takes into account the possibility that the original article has been delayed over the cancellation message.<br>Some news systems allow users to cancel other people's messages; this is, of course, a definite no−no.<br>
<b>21.8.2. newgroup and rmgroup</b><br>
&nbsp;Two messages dealing with creation or removal of newsgroups are the newgroup and rmgroup messages.<br>Newsgroups below the usual hierarchies may be created only after a discussion and voting has been held<br>among Usenet readers. The rules applying to the alt hierarchy allow for something close to anarchy. For more<br>information, see the regular postings in news.announce.newusers and news.announce.newgroups. Never send<br>a newgroup or rmgroup message yourself unless you definitely know that you are allowed to.<br>
<b>21.8.3. The checkgroups Message</b><br>
&nbsp;checkgroups messages are sent by news administrators to make all sites within a network synchronize their<br>active&nbsp;files with the realities of Usenet. For example, commercial Internet Service Providers might send<br>out such a message to their customers' sites. Once a month, the official checkgroups message for the major<br>hierarchies is posted to comp.announce.newgroups by its moderator. However, it is posted as an ordinary<br>article, not as a control message. To perform the checkgroups operation, save this article to a file, say<br>/tmp/check, remove everything up to the beginning of the control message itself, and feed it to the<br>checkgroups script using the following command:<br>
#&nbsp;<b>su news −c &quot;/usr/lib/news/ctl/checkgroups&quot; &lt; /tmp/check</b><br>
This will update your&nbsp;newsgroups&nbsp;file from the new list of groups, adding the groups listed in<br>localgroups. The old&nbsp;newsgroups&nbsp;file will be moved to&nbsp;newsgroups.bac. Note that posting the<br>message locally rarely works, because&nbsp;<b>inews</b>, the command that accepts and posts articles from users, refuses<br>to accept that large an article.<br>
21.8. Control Messages<br>
419<br>
<hr>
<A name=436></a>Linux Network Administrators Guide<br>
If C News finds mismatches between the checkgroups list and the&nbsp;active&nbsp;file, it produces a list of<br>commands that would bring your site up to date and mails it to the news administrator.<br>
The output typically looks like this:<br>
From news Sun Jan 30 16:18:11 1994<br>
Date: Sun, 30 Jan 94 16:18 MET<br>
From: news (News Subsystem)<br>
To: usenet<br>
Subject: Problems with your active file<br>
The following newsgroups are not valid and should be removed.<br>
&nbsp; &nbsp; &nbsp; &nbsp; alt.ascii−art<br>
&nbsp; &nbsp; &nbsp; &nbsp; bionet.molbio.gene−org<br>
&nbsp; &nbsp; &nbsp; &nbsp; comp.windows.x.intrisics<br>
&nbsp; &nbsp; &nbsp; &nbsp; de.answers<br>
You can do this by executing the commands:<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/lib/news/maint/delgroup alt.ascii−art<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/lib/news/maint/delgroup bionet.molbio.gene−org<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/lib/news/maint/delgroup comp.windows.x.intrisics<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/lib/news/maint/delgroup de.answers<br>
The following newsgroups were missing.<br>
&nbsp; &nbsp; &nbsp; &nbsp; comp.binaries.cbm<br>
&nbsp; &nbsp; &nbsp; &nbsp; comp.databases.rdb<br>
&nbsp; &nbsp; &nbsp; &nbsp; comp.os.geos<br>
&nbsp; &nbsp; &nbsp; &nbsp; comp.os.qnx<br>
&nbsp; &nbsp; &nbsp; &nbsp; comp.unix.user−friendly<br>
&nbsp; &nbsp; &nbsp; &nbsp; misc.legal.moderated<br>
&nbsp; &nbsp; &nbsp; &nbsp; news.newsites<br>
&nbsp; &nbsp; &nbsp; &nbsp; soc.culture.scientists<br>
&nbsp; &nbsp; &nbsp; &nbsp; talk.politics.crypto<br>
&nbsp; &nbsp; &nbsp; &nbsp; talk.politics.tibet<br>
When you receive a message like this from your news system, don't believe it automatically. Depending on<br>who sent the checkgroups message, it may lack a few groups or even entire hierarchies; you should be careful<br>about removing any groups. If you find groups are listed as missing that you want to carry at your site, you<br>have to add them using the&nbsp;<b>addgroup</b>&nbsp;script. Save the list of missing groups to a file and feed it to the<br>following little script:<br>
#!/bin/sh<br>
#<br>
WHOIAM=`whoami`<br>
if [ &quot;$WHOIAM&quot; != &quot;news&quot; ]<br>
then<br>
&nbsp; &nbsp; &nbsp; &nbsp; echo &quot;You must run $0 as user 'news'&quot; &gt;&amp;2<br>
&nbsp; &nbsp; &nbsp; &nbsp; exit 1<br>
fi<br>
#<br>
cd /usr/lib/news<br>
while read group; do<br>
&nbsp; &nbsp; if grep −si &quot;^$group[[:space:]].*moderated&quot; newsgroup; then<br>
&nbsp; &nbsp; &nbsp; &nbsp; mod=m<br>
&nbsp; &nbsp; else<br>
&nbsp; &nbsp; &nbsp; &nbsp; mod=y<br>
&nbsp; &nbsp; fi<br>
&nbsp; &nbsp; /usr/lib/news/maint/addgroup $group $mod<br>
done<br>
21.8. Control Messages<br>
420<br>
<hr>
<A name=437></a>Linux Network Administrators Guide<br>
<b>21.8.4. sendsys, version, and senduuname</b><br>
Finally, there are three messages that can be used to find out about the network's topology. These are<br>sendsys, version, and senduuname. They cause C News to return the&nbsp;sys&nbsp;file to the sender, as well as a<br>software version string and the output of&nbsp;<b>uuname</b>, respectively. C News is very laconic about<br>version messages; it returns a simple, unadorned&nbsp;C.<br>
Again, you should&nbsp;<i>never</i>&nbsp;issue such a message unless you have made sure that it cannot leave your (regional)<br>network. Replies to sendsys messages can quickly bring down a UUCP network.[131]<br>
21.8.4. sendsys, version, and senduuname<br>
421<br>
<hr>
<A name=438></a><b>21.9. C News in an NFS Environment</b><br>
&nbsp;A simple way to distribute news within a local network is to keep all news on a central host and export the<br>relevant directories via NFS so that newsreaders may scan the articles directly. The overhead involved in<br>retrieving and threading articles is significantly lower than NNTP. NNTP, on the other hand, wins in a<br>heterogeneous network where equipment varies widely among hosts, or where users don't have equivalent<br>accounts on the server machine.<br>
When you use NFS, articles posted on a local host have to be forwarded to the central machine because<br>accessing adminstrative files might otherwise expose the system to race conditions that leave the files<br>inconsistent. Also, you might want to protect your news spool area by exporting it read−only, which also<br>requires forwarding to the central machine.<br>
C News handles this central machine configuration transparently to the user. When you post an article, your<br>newsreader usually invokes&nbsp;<b>inews</b>&nbsp;to inject the article into the news system. This command runs a number of<br>checks on the article, completes the header, and checks the file&nbsp;server&nbsp;in&nbsp;/etc/news. If this file exists<br>and contains a hostname different from the local host's name,&nbsp;<b>inews</b>&nbsp;is invoked on that server host via&nbsp;<b>rsh</b>.<br>Since the&nbsp;<b>inews</b>&nbsp;script uses a number of binary commands and support files from C News, you have to either<br>have C News installed locally or mount the news software from the server.<br>
For the&nbsp;<b>rsh</b>&nbsp;invocation to work properly, each user who posts news must have an equivalent account on the<br>server system, i.e., one to which she can log in without being asked for a password.<br>
Make sure that the hostname given in&nbsp;server&nbsp;literally matches the output of the&nbsp;<b>hostname</b>&nbsp;command on the<br>server machine, or else C News will loop forever in an attempt to deliver the article. We discuss NFS is detail<br><a href="TLNAGs.html#287">in&nbsp;Chapter 14.</a><br>
21.9. C News in an NFS Environment<br>
422<br>
<hr>
<A name=439></a><b>21.10. Maintenance Tools and Tasks</b><br>
Despite the complexity of C News, a news administrator's life can be fairly easy; C News provides you with a<br>wide variety of maintenance tools. Some of these are intended to be run regularly from&nbsp;<b>cron</b>, like&nbsp;<b>newsdaily</b>.<br>Using these scripts greatly reduces daily care and feeding requirements of your C News installation.<br>
Unless stated otherwise, these commands are located in&nbsp;/usr/lib/news/maint. (Note that you must<br>become user news before invoking these commands. Running them as a superuser may render critical<br>newsfiles inaccessible to C News.):<br>
<i><b>newsdaily</b></i><br>
The name already says it: run this once a day. It is an important script that helps you keep log files<br>small, retaining copies of each from the last three runs. It also tries to sense anomalies, like stale<br>batches in the incoming and outgoing directories, postings to unknown or moderated newsgroups,<br>etc. Resulting error messages are mailed to the newsmaster.<br>
<i><b>newswatch</b></i><br>
This script should be run regularly to look for anomalies in the news system, once an hour or so. It is<br>intended to detect problems that will have an immediate effect on the operability of your news<br>system, in which case it mails a trouble report to the newsmaster. Things checked include stale lock<br>files that don't get removed, unattended input batches, and disk space shortage.<br>
<i><b>addgroup</b></i><br>
This script adds a group to your site locally. The proper invocation is:<br>
addgroup&nbsp;<i>groupname</i>&nbsp;y|n|m|=<i>realgroup</i><br>
The second argument has the same meaning as the flag in the&nbsp;active&nbsp;file, meaning that anyone<br>may post to the group (y), that no one may post (n), that it is moderated (m), or that it is an alias for<br>another group (=<i>realgroup</i>). You might also want to use&nbsp;<b>addgroup</b>&nbsp;when the first articles in a<br>newly created group arrive earlier than the newgroup control message that is intended to create it.<br>
<i><b>delgroup</b></i><br>
This script allows you to delete a group locally. Invoke it as:<br>
delgroup&nbsp;<i>groupname</i><br>
You still have to delete the articles that remain in the newsgroup's spool directory. Alternatively, you<br>might leave it to the natural course of events (i.e., expiration) to make them go away.<br>
<i><b>addmissing</b></i><br>
This script adds missing articles to the&nbsp;history&nbsp;file. Run it when there are articles that seem to<br>hang around forever.<br>
<i><b>newsboot</b></i><br>
21.10. Maintenance Tools and Tasks<br>
423<br>
<hr>
<A name=440></a>Linux Network Administrators Guide<br>
This script should be run at system boot time. It removes any lock files left over when news<br>processes were killed at shutdown, and closes and executes any batches left over from NNTP<br>connections that were terminated when shutting down the system.<br>
<i><b>newsrunning</b></i><br>
This script resides in&nbsp;/usr/lib/news/input&nbsp;and may be used to disable unbatching of<br>incoming news, for instance during work hours. You may turn off unbatching by invoking:<br>
/usr/lib/news/input/newsrunning off<br>
It is turned on by using on instead of off.<br>
21.10. Maintenance Tools and Tasks<br>
424<br>
<hr>
<A name=441></a><b>Chapter 22. NNTP and thenntpd Daemon</b><br>
Network News Transfer Protocol (NNTP) provides for a vastly different approach to news exchange from C<br>News and other news servers without native NNTP support. Rather than rely on a batch technology like<br>UUCP to transfer news articles between machines, it allows articles to be exchanged via an interactive<br>network connection. NNTP is not a particular software package, but an Internet standard described in<br>RFC−977. It is based on a stream−oriented connection, usually over TCP, between a client anywhere in the<br>network and a server on a host that keeps Netnews on disk storage. The stream connection allows the client<br>and server to interactively negotiate article transfer with nearly no turnaround delay, thus keeping the number<br>of duplicate articles low. Together with the Internet's high−transfer rates, this adds up to a news transport that<br>surpasses the original UUCP networks by far. While some years ago it was not uncommon for an article to<br>take two weeks or more before it arrived in the last corner of Usenet; it is now often less than two days. On<br>the Internet itself, it is even within the range of minutes.<br>
Various commands allow clients to retrieve, send, and post articles. The difference between sending and<br>posting is that the latter may involve articles with incomplete header information; it generally means that the<br>user has just written the article.[132]&nbsp;Article retrieval may be used by news transfer clients as well as<br>newsreaders. This makes NNTP an excellent tool for providing news access to many clients on a local<br>network without going through the contortions that are necessary when using NFS.<br>
&nbsp;NNTP also provides for an active and a passive way to transfer news, colloquially called pushing and<br>pulling. Pushing is basically the same as the ihave/sendme protocol used by C News (described in&nbsp;<a href="TLNAGs.html#418">Chapter<br>21</a>). The client offers an article to the server through the&nbsp;<b>IHAVE msgid</b>&nbsp;command, and the server returns a<br>response code that indicates whether it already has the article or if it wants it. If the server wants the article,<br>the client sends the article, terminated by a single dot on a separate line.<br>
Pushing news has the single disadvantage that it places a heavy load on the server system, since the system<br>has to search its history database for every single article.<br>
&nbsp;The opposite technique is pulling news, in which the client requests a list of all (available) articles from a<br>group that have arrived after a specified date. This query is performed by the&nbsp;<b>NEWNEWS</b>&nbsp;command. From<br>the returned list of message IDs, the client selects those articles it does not yet have, using the<br><b>ARTICLE</b>&nbsp;command for each of them in turn.<br>
Pulling news needs tight control by the server over which groups and distributions it allows a client to<br>request. For example, it has to make sure that no confidential material from newsgroups local to the site is<br>sent to unauthorized clients.<br>
There are also a number of convenience commands for newsreaders that permit them to retrieve the article<br>header and body separately, or even single header lines from a range of articles. This lets you keep all news<br>on a central host, with all users on the (presumably local) network using NNTP−based client programs for<br>reading and posting. This is an alternative to exporting the news directories via NFS, as described in&nbsp;<a href="TLNAGs.html#418">Chapter<br>21</a>.<br>
&nbsp;An overall problem of NNTP is that it allows a knowledgeable person to insert articles into the news stream<br>with false sender specification. This is called&nbsp;<i>news faking</i>&nbsp;or&nbsp;<i>spoofing</i>.[133]&nbsp;An extension to NNTP allows<br>you to require user authentication for certain commands, providing some measure of protection against<br>people abusing your news server in this way.<br>
Chapter 22. NNTP and thenntpd Daemon<br>
425<br>
<hr>
<A name=442></a>Linux Network Administrators Guide<br>
&nbsp;There are a number of NNTP packages. One of the more widely known is the NNTP daemon, also known<br>as the&nbsp;<i>reference implementation</i>. Originally, it was written by Stan Barber and Phil Lapsley to illustrate the<br>details of RFC−977. As with much of the good software available today, you may find it prepackaged for<br>your Linux distribution, or you can obtain the source and compile it yourself. If you choose to compile it<br>yourself, you will need to be quite familiar with your distribution to ensure you configure all of the file paths<br>correctly.<br>
The&nbsp;<b>nntpd</b>&nbsp;package has a server, two clients for pulling and pushing news, and an&nbsp;<b>inews</b>&nbsp;replacement. They<br>live in a B News environment, but with a little tweaking, they will be happy with C News, too. However, if<br>you plan to use NNTP for more than offering newsreaders access to your news server, the reference<br>implementation is not really an option. We will therefore discuss only the NNTP daemon contained in the<br><b>nntpd</b>&nbsp;package and leave out the client programs.<br>
&nbsp;If you wish to run a large news site, you should look at the&nbsp;<i>InterNet News</i>&nbsp;package, or INN, that was<br>written by Rich Salz. It provides both NNTP and UUCP−based news transport. News transport is definitely<br>better than&nbsp;<b>nntpd</b>. We discuss INN in detail in&nbsp;<a href="TLNAGs.html#455">Chapter 23</a>.<br>
Chapter 22. NNTP and thenntpd Daemon<br>
426<br>
<hr>
<A name=443></a><b>22.1. The NNTP Protocol</b><br>
We've mentioned two NNTP commands that are key to how news articles are pushed or pulled between<br>servers. Now we'll look at these in the context of an actual NNTP session to show you how simple the<br>protocol is. For the purposes of our illustration, we'll use a simple&nbsp;<b>telnet</b>&nbsp;client to connect to an INN−based<br>news server at the Virtual Brewery called&nbsp;<i>news.vbrew.com</i>. The server is running a minimal configuration to<br><a href="TLNAGs.html#455">keep the examples short. We'll look at how to complete the configuration of this server in&nbsp;Chapter 23. In our<br></a>testing we'll be very careful to generate articles in the&nbsp;<i>junk</i>&nbsp;newsgroup only, to avoid disturbing anyone else.<br>
<b>22.1.1. Connecting to the News Server</b><br>
Connecting to the news server is a simple as opening a TCP connection to its NNTP port. When you are<br>connected, you will be greeted with a welcome banner. One of the first commands you might try is help. The<br>response you get generally depends upon whether the server believes you are a remote NNTP server or a<br>newsreader, as there are different command sets required. You can change your operating mode using the<br><b>mode</b>&nbsp;command; we'll look at that in a moment:<br>
$&nbsp;<b>telnet news.vbrew.com nntp</b><br>
Trying 172.16.1.1...<br>
Connected to localhost.<br>
Escape character is '^]'.<br>
200 news.vbrew.com InterNetNews server INN 1.7.2 08−Dec−1997 ready<br>
<b>help</b><br>
100 Legal commands<br>
&nbsp; &nbsp; &nbsp; &nbsp; authinfo<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; help<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ihave<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; check<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; takethis<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mode<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmode<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quit<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; head<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stat<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xbatch<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xpath<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xreplic<br>
For more information, contact &quot;usenet&quot; at this machine.<br>
.<br>
The responses to NNTP commands always end with a period (.) on a line by itself. The numbers you see in<br>the output listing are&nbsp;<i>response codes</i>&nbsp;and are used by the server to indicate success or failure of a command.<br>The response codes are described in RFC−977; we'll talk about the most important ones as we proceed.<br>
<b>22.1.2. Pushing a News Article onto a Server</b><br>
&nbsp;We mentioned the&nbsp;<b>IHAVE</b>&nbsp;command when we talked about pushing news articles onto a news server. Let's<br>now have a look at how the&nbsp;<b>IHAVE</b>&nbsp;command actually works:<br>
22.1. The NNTP Protocol<br>
427<br>
<hr>
<A name=444></a>Linux Network Administrators Guide<br>
<b>ihave &lt;123456@gw.vk2ktj.ampr.org&gt;</b><br>
335<br>
<b>From: terry@gw.vk2ktj.ampr.org</b><br>
<b>Subject: test message sent with ihave</b><br>
<b>Newsgroups: junk</b><br>
<b>Distribution: world</b><br>
<b>Path: gw.vk2ktj.ampr.org</b><br>
<b>Date: 26 April 1999</b><br>
<b>Message−ID: &lt;123456@gw.vk2ktj.ampr.org&gt;</b><br>
<b>Body:&nbsp;</b><br>
<b>This is a test message sent using the NNTP IHAVE command.</b><br>
<b>.</b><br>
235<br>
All NNTP commands are case insensitive, so you may enter them in either upper− or lowercase. The<br><b>IHAVE</b>&nbsp;command takes one mandatory argument, it being the Message ID of the article that is being pushed.<br>Every news article is assigned a unique message ID when it is created. The&nbsp;<b>IHAVE</b>&nbsp;command provides a way<br>of the NNTP server to say which articles it has when it wants to push articles to another server. The sending<br>server will issue an&nbsp;<b>IHAVE</b>&nbsp;command for each article it wishes to push. If the command response code<br>generated by the receiving NNTP server is in the ãxx range, the sending NNTP server will transmit the<br>complete article, including it's full header, terminating the article with a period on a line by itself. If the<br>response code was in the äxx range, the receiving server has chosen not to accept this article, possibly<br>because it already has it, or because of some problem, such as running out of disk space.<br>
When the article has been transmitted, the receiving serve issues another response code indicating whether<br>the article transmission was successful.<br>
<b>22.1.3. Changing to NNRP Reader Mode</b><br>
&nbsp;Newsreaders use their own set of commands when talking to a news server. To activate these commands,<br>the news server has to be operating in&nbsp;<i>reader</i>&nbsp;mode. Most news servers default to reader mode, unless the IP<br>address of the connecting host is listed as a news−forwarding peer. In any case, NNTP provides a command<br>to explicitly switch into reader mode:<br>
<b>mode reader</b><br>
200 news.vbrew.com InterNetNews NNRP server INN 1.7.2 08−Dec−1997 ready/<br>
&nbsp; &nbsp; (posting ok).<br>
<b>help</b><br>
100 Legal commands<br>
&nbsp; authinfo user Name|pass Password|generic &lt;prog&gt; &lt;args&gt;<br>
&nbsp; article [MessageID|Number]<br>
&nbsp; body [MessageID|Number]<br>
&nbsp; date<br>
&nbsp; group newsgroup<br>
&nbsp; head [MessageID|Number]<br>
&nbsp; help<br>
&nbsp; ihave<br>
&nbsp; last<br>
&nbsp; list [active|active.times|newsgroups|distributions|distrib.pats|/<br>
&nbsp; &nbsp; &nbsp; overview.fmt|subscriptions]<br>
&nbsp; listgroup newsgroup<br>
&nbsp; mode reader<br>
&nbsp; newgroups yymmdd hhmmss [&quot;GMT&quot;] [&lt;distributions&gt;]<br>
22.1.3. Changing to NNRP Reader Mode<br>
428<br>
<hr>
<A name=445></a>Linux Network Administrators Guide<br>
&nbsp; newnews newsgroups yymmddhhmmss [&quot;GMT&quot;] [&lt;distributions&gt;]<br>
&nbsp; next<br>
&nbsp; post<br>
&nbsp; slave<br>
&nbsp; stat [MessageID|Number]<br>
&nbsp; xgtitle [group_pattern]<br>
&nbsp; xhdr header [range|MessageID]<br>
&nbsp; xover [range]<br>
&nbsp; xpat header range|MessageID pat [morepat...]<br>
&nbsp; xpath MessageID<br>
Report problems to &lt;usenet@vlager.vbrew.com&gt;<br>
.<br>
NNTP reader mode has a lot of commands. Many of these are designed to make the life of a newsreader<br>easier. We mentioned earlier that there are commands that instruct the server to send the head and the body of<br>articles separately. There are also commands that list the available groups and articles, and others that allow<br>posting, an alternate means of sending news articles to the server.<br>
<b>22.1.4. Listing Available Groups</b><br>
&nbsp;The&nbsp;<b>list</b>&nbsp;command lists a number of different types of information; notably the groups supported by the<br>server:<br>
<b>list newsgroups</b><br>
215 Descriptions in form &quot;group description&quot;.<br>
control &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; News server internal group<br>
junk &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;News server internal group<br>
local.general &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; General local stuff<br>
local.test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Local test group<br>
.<br>
<b>22.1.5. Listing Active Groups</b><br>
list active&nbsp;shows each supported group and provides information about them. The two numbers in<br>
each line of the output are the high−water mark and the low−water markthat is, the highest numbered article<br>and lowest numbered article in each group. The newsreader is able to form an idea of the number of articles<br>in the group from these. We'll talk a little more about these numbers in a moment. The last field in the output<br>displays flags that control whether posting is allowed to the group, whether the group is moderated, and<br>whether articles posted are actually stored or just passed on. These flags are described in detail in&nbsp;<a href="TLNAGs.html#455">Chapter 23</a>.<br>An example looks like this:<br>
<b>list active</b><br>
215 Newsgroups in form &quot;group high low flags&quot;.<br>
control 0000000000 0000000001 y<br>
junk 0000000003 0000000001 y<br>
alt.test 0000000000 0000000001 y<br>
.<br>
22.1.4. Listing Available Groups<br>
429<br>
<hr>
<A name=446></a>Linux Network Administrators Guide<br>
<b>22.1.6. Posting an Article</b><br>
&nbsp;We mentioned there was a difference between pushing an article and posting an article. When you are<br>pushing an article, there is an implicit assumption that the article already exists, that it has a message<br>identifier that has been uniquely assigned to it by the server to which it was originally posted, and that it has a<br>complete set of headers. When posting an article, you are creating the article for the first time and the only<br>headers you supply are those that are meaningful to you, such as the Subject and the Newgroups to which you<br>are posting the article. The news server you post the article on will add all the other headers for you and<br>create a message ID that it will use when pushing the article onto other servers.<br>
All of this means that posting an article is even easier than pushing one. An example posting looks like this:<br>
<b>post</b><br>
340 Ok<br>
<b>From: terry@richard.geek.org.au</b><br>
<b>Subject: test message number 1</b><br>
<b>Newsgroups: junk</b><br>
<b>Body:&nbsp;</b><br>
<b>This is a test message, please feel free to ignore it.</b><br>
<b>.</b><br>
240 Article posted<br>
We've generated two more messages like this one to give our following examples some realism.<br>
<b>22.1.7. Listing New Articles</b><br>
&nbsp;When a newsreader first connects to a new server and the user chooses a newsgroup to browse, the<br>newsreader will want to retrieve a list of new articles, those posted or received since the last login by the user.<br>The&nbsp;newnews&nbsp;command is used for this purpose. Three mandatory arguments must be supplied: the name of<br>the group or groups to query, the start date, and the start time from which to list. The date and time are each<br>specified as six−digit numbers, with the most significant information first;&nbsp;<i>yymmdd</i>&nbsp;and&nbsp;<i>hhmmss</i>,<br>respectively:<br>
<b>newnews junk 990101 000000</b><br>
230 New news follows<br>
&lt;7g2o5r$aa$6@news.vbrew.com&gt;<br>
&lt;7g5bhm$8f$2@news.vbrew.com&gt;<br>
&lt;7g5bk5$8f$3@news.vbrew.com&gt;<br>
.<br>
<b>22.1.8. Selecting a Group on Which to Operate</b><br>
&nbsp;When the user selects a newsgroup to browse, the newsreader may tell the news server that the group was<br>selected. This simplifies the interaction between newsreader and news server; it removes the need to<br>constantly send the name of the newsgroup with each command. The&nbsp;group&nbsp;command simply takes the<br>name of the selected group as an argument. Many following commands use the group selected as the default,<br>unless another newsgroup is specified explicitly:<br>
22.1.6. Posting an Article<br>
430<br>
<hr>
<A name=447></a>Linux Network Administrators Guide<br>
<b>group junk</b><br>
211 3 1 3 junk<br>
The&nbsp;group&nbsp;command returns a message indicating the number of active messages, the low−water mark, the<br>high−water mark, and the name of the group, respectively. Note that while the number of active messages<br>and the high−water mark are the same in our example, this is not often the case; in an active news server,<br>some articles may have expired or been deleted, lowering the number of active messages but leaving the<br>high−water mark untouched.<br>
<b>22.1.9. Listing Articles in a Group</b><br>
&nbsp;To address newsgroup articles, the newsreader must know which article numbers represent active articles.<br>The&nbsp;listgroup&nbsp;command offers a list of the active article numbers in the current group, or an explicit<br>group if the group name is supplied:<br>
<b>listgroup junk</b><br>
211 Article list follows<br>
1<br>
2<br>
3<br>
.<br>
<b>22.1.10. Retrieving an Article Header Only</b><br>
&nbsp;The user must have some information about an article before she can know whether she wishes to read it.<br>We mentioned earlier that some commands allow the article header and body to be transferred separately.<br>The&nbsp;head&nbsp;command is used to request that the server transmit just the header of the specified article to the<br>newsreader. If the user doesn't want to read this article, we haven't wasted time and network bandwidth<br>transferring a potentially large article body unnecessarily.<br>
Articles may be referenced using either their number (from the&nbsp;listgroup&nbsp;command) or their message<br>identifier:<br>
<b>head 2</b><br>
221 2 &lt;7g5bhm$8f$2@news.vbrew.com&gt; head<br>
Path: news.vbrew.com!not−for−mail<br>
From: terry@richard.geek.org.au<br>
Newsgroups: junk<br>
Subject: test message number 2<br>
Date: 27 Apr 1999 21:51:50 GMT<br>
Organization: The Virtual brewery<br>
Lines: 2<br>
Message−ID: &lt;7g5bhm$8f$2@news.vbrew.com&gt;<br>
NNTP−Posting−Host: localhost<br>
X−Server−Date: 27 Apr 1999 21:51:50 GMT<br>
Body:&nbsp;<br>
Xref: news.vbrew.com junk:2<br>
.<br>
22.1.9. Listing Articles in a Group<br>
431<br>
<hr>
<A name=448></a>Linux Network Administrators Guide<br>
<b>22.1.11. Retrieving an Article Body Only</b><br>
&nbsp;If, on the other hand, the user decides she does want to read the article, her newsreader needs a way of<br>requesting that the message body be transmitted. The&nbsp;body&nbsp;command is used for this purpose. It operates in<br>much the same way as the&nbsp;head&nbsp;command, except that only the message body is returned:<br>
<b>body 2</b><br>
222 2 &lt;7g5bhm$8f$2@news.vbrew.com&gt; body<br>
This is another test message, please feel free to ignore it too.<br>
.<br>
<b>22.1.12. Reading an Article from a Group</b><br>
&nbsp;While it is normally most efficient to separately transfer the headers and bodies of selected articles, there<br>are occasions when we are better off transferring the complete article. A good example of this is in<br>applications through which we want to transfer all of the artices in a group without any sort of preselection,<br>such as when we are using an NNTP cache program like&nbsp;<b>leafnode</b>.[134]<br>
Naturally, NNTP provides a means of doing this, and not surprisingly, it operates almost identically to the<br>head&nbsp;command as well. The&nbsp;article&nbsp;command also accepts an article number or message ID as an<br>argument, but returns the whole article including its header:<br>
<b>article 1</b><br>
220 1 &lt;7g2o5r$aa$6@news.vbrew.com&gt; article<br>
Path: news.vbrew.com!not−for−mail<br>
From: terry@richard.geek.org.au<br>
Newsgroups: junk<br>
Subject: test message number 1<br>
Date: 26 Apr 1999 22:08:59 GMT<br>
Organization: The Virtual brewery<br>
Lines: 2<br>
Message−ID: &lt;7g2o5r$aa$6@news.vbrew.com&gt;<br>
NNTP−Posting−Host: localhost<br>
X−Server−Date: 26 Apr 1999 22:08:59 GMT<br>
Body:&nbsp;<br>
Xref: news.vbrew.com junk:1<br>
This is a test message, please feel free to ignore it.<br>
.<br>
If you attempt to retrieve an unknown article, the server will return a message with an appropriately coded<br>response code and perhaps a readable text message:<br>
<b>article 4</b><br>
423 Bad article number<br>
We've described how the most important NNTP commands are used in this section. If you're interested in<br>developing software that implements the NNTP protocol, you should refer to the relevant RFC documents;<br>they provide a great deal of detail that we couldn't include here.<br>
Let's now look at NNTP in action through the&nbsp;<i>nntpd</i>&nbsp;server.<br>
22.1.11. Retrieving an Article Body Only<br>
432<br>
<hr>
<A name=449></a>Linux Network Administrators Guide<br>
22.1.11. Retrieving an Article Body Only<br>
433<br>
<hr>
<A name=450></a><b>22.2. Installing the NNTP Server</b><br>
The NNTP server (<i>nntpd</i>) may be compiled in two ways, depending on the expected load on the news<br>system. There are no compiled versions available, because of some site−specific defaults that are hardcoded<br>into the executable. All configuration is done through macros defined in&nbsp;common/conf.h.<br>
<i>nntpd</i>&nbsp;may be configured as either a standalone server that is started at system boot time from an&nbsp;<b>rc</b>&nbsp;file, or a<br>daemon managed by&nbsp;<b>inetd</b>. In the latter case, you have to have the following entry in&nbsp;/etc/inetd.conf:<br>
nntp &nbsp; &nbsp;stream &nbsp;tcp nowait &nbsp; &nbsp; &nbsp;news &nbsp; &nbsp;/usr/etc/in.nntpd &nbsp; &nbsp;nntpd<br>
The&nbsp;inetd.conf&nbsp;syntax is described in detail in&nbsp;<a href="TLNAGs.html#253">Chapter 12</a>. If you configure&nbsp;<b>nntpd</b>&nbsp;as standalone, make<br>sure that any such line in&nbsp;<b>inetd.conf</b>&nbsp;is commented out. In either case, you have to make sure the following<br>line appears in&nbsp;/etc/services:<br>
nntp &nbsp; &nbsp;119/tcp &nbsp; readnews untp &nbsp; &nbsp;# Network News Transfer Protocol<br>
To temporarily store any incoming articles,&nbsp;<b>nntpd</b>&nbsp;also needs a&nbsp;.tmp&nbsp;directory in your news spool. You<br>should create it using the following commands:<br>
#&nbsp;<b>mkdir /var/spool/news/.tmp</b><br>
#&nbsp;<b>chown news.news /var/spool/news/.tmp</b><br>
22.2. Installing the NNTP Server<br>
434<br>
<hr>
<A name=451></a><b>22.3. Restricting NNTP Access</b><br>
&nbsp;Access to NNTP resources is governed by the file&nbsp;nntp_access&nbsp;in&nbsp;/etc/news. Lines in this file<br>describe the access rights granted to foreign hosts. Each line has the following format:<br>
<i>site</i>&nbsp; &nbsp;read|xfer|both|no &nbsp; &nbsp;post|no &nbsp; &nbsp; &nbsp;[!<i>exceptgroups</i>]<br>
If a client connects to the NNTP port,&nbsp;<i>nntpd</i>&nbsp;attempts to obtain the host's fully qualified domain name from its<br>IP address using reverse lookup. The client's hostname and IP address are checked against the&nbsp;<i>site</i>&nbsp;field of<br>each entry in the order in which they appear in the file. Matches may be either partial or exact. If an entry<br>matches exactly, it applies; if the match is partial, it applies only if there is no other match following it that is<br>at least as good.&nbsp;<i>site</i>&nbsp;may be specified in one of the following ways:<br>
<i>Hostname</i><br>
This is a fully qualified domain name of a host. If this matches the client's canonical hostname<br>literally, the entry applies, and all following entries are ignored.<br>
<i>IP address</i><br>
This is an IP address in dotted quad notation. If the client's IP address matches this, the entry applies,<br>and all following entries are ignored.<br>
<i>Domain name</i><br>
This is a domain name, specified as *.<i>domain</i>. If the client's hostname matches the domain name,<br>the entry matches.<br>
<i>Network name</i><br>
This is the name of a network as specified in&nbsp;/etc/networks. If the network number of the<br>client's IP address matches the network number associated with the network name, the entry matches.<br>
<i>Default</i><br>
The string&nbsp;default&nbsp;matches any client.<br>
Entries with a more general site specification should be specified earlier, because any matches will be<br>overridden by later, more exact matches.<br>
The second and third fields describe the access rights granted to the client. The second field details the<br>permissions to retrieve news by pulling (read), and transmit news by pushing (xfer). A value of both enables<br>both; no denies access altogether. The third field grants the client the right to post articles, i.e., deliver articles<br>with incomplete header information, which is completed by the news software. If the second field contains<br>no, the third field is ignored.<br>
The fourth field is optional and contains a comma−separated list of groups to which the client is denied<br>access.<br>
This is a sample&nbsp;nntp_access&nbsp;file:<br>
22.3. Restricting NNTP Access<br>
435<br>
<hr>
<A name=452></a>Linux Network Administrators Guide<br>
#<br>
# by default, anyone may transfer news, but not read or post<br>
default &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xfer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;no<br>
#<br>
# public.vbrew.com offers public access via modem. We allow<br>
# them to read and post to any but the local.* groups<br>
public.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp;read &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;post &nbsp; &nbsp;!local<br>
#<br>
# all other hosts at the brewery may read and post<br>
*.vbrew.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;post<br>
22.3. Restricting NNTP Access<br>
436<br>
<hr>
<A name=453></a><b>22.4. NNTP Authorization</b><br>
&nbsp;The&nbsp;<b>nntpd</b>&nbsp;daemon provides a simple authorization scheme. If you capitalize any of the access tokens in<br>the&nbsp;nntp_access&nbsp;file,&nbsp;<b>nntpd</b>&nbsp;requires authorization from the client for the respective operation. For<br>instance, when specifying a permission of Xfer or XFER, (as opposed to xfer),&nbsp;<b>nntpd</b>&nbsp;will not let the client<br>transfer articles to your site unless it passes authorization.<br>
The authorization procedure is implemented by means of a new NNTP command named&nbsp;<b>AUTHINFO</b>. Using<br>this command, the client transmits a username and a password to the NNTP server.&nbsp;<b>nntpd</b>&nbsp;validates them by<br>checking them against the&nbsp;/etc/passwd&nbsp;database and verifies that the user belongs to the nntp group.<br>
The current implementation of NNTP authorization is only experimental and has therefore not been<br>implemented very portably. The result of this is that it works only with plain−style password databases;<br>shadow passwords are not recognized. If you are compiling from source and have the PAM package installed,<br>the password check is fairly simple to change.<br>
22.4. NNTP Authorization<br>
437<br>
<hr>
<A name=454></a><b>22.5. nntpd Interaction with C News</b><br>
&nbsp;When&nbsp;<b>nntpd</b>&nbsp;receives an article, it has to deliver it to the news subsystem. Depending on whether it was<br>received as a result of an&nbsp;<b>IHAVE</b>&nbsp;or&nbsp;<b>POST</b>&nbsp;command, the article is handed to&nbsp;<b>rnews</b>&nbsp;or&nbsp;<b>inews</b>, respectively.<br>Instead of invoking&nbsp;<b>rnews</b>, you may also configure it (at compile time), to batch the incoming articles and<br>move the resulting batches to&nbsp;/var/spool/news/in.coming, where they are left for&nbsp;<b>relaynews</b>&nbsp;to pick<br>them up at the next queue run.<br>
<b>nntpd</b>&nbsp;has to have access to the&nbsp;history&nbsp;file to be able to properly perform the ihave/sendme protocol.<br>
At compile time, you have to make sure the path to that file is set correctly. If you use C News, make sure<br>that C News and&nbsp;<b>nntpd</b>&nbsp;agree on the format of your history file. C News uses&nbsp;dbm&nbsp;hashing functions to<br>access it; however, there are quite a number of different and slightly incompatible implementations of the<br>dbm&nbsp;library. If C News has been linked with a different&nbsp;dbm&nbsp;library than you have in your standard&nbsp;libc,<br>you have to link&nbsp;<b>nntpd</b>&nbsp;with this library, too.<br>
<b>nntpd</b>&nbsp;and C news disagreement sometimes produces error messages in the system log that&nbsp;<b>nntpd</b>&nbsp;can not<br>
open it properly, or you might see duplicate articles being received via NNTP. A good test of a<br>malfunctioning news transfer is to pick an article from your spool area, telnet to the&nbsp;<i>nntp</i>&nbsp;port, and offer it to<br><b>nntpd</b>&nbsp;as shown in the next example. Of course, you have to replace&nbsp;<i>msg@id</i>&nbsp;with the message ID of the<br>article you want to feed to&nbsp;<b>nntpd</b>:<br>
$&nbsp;<b>telnet localhost nntp</b><br>
Trying 127.0.0.1...<br>
Connected to localhost<br>
Escape characters is '^ ]'.<br>
201 vstout NNTP[auth] server version 1.5.11t (16 November 1991) ready at<br>
Sun Feb 6 16:02:32 1194 (no posting)<br>
<b>IHAVE&nbsp;</b><i>msg@id</i><br>
435 Got it.<br>
<b>QUIT</b><br>
This conversation shows&nbsp;<b>nntpd</b>'s proper reaction; the message&nbsp;Got it&nbsp;tells you that it already has this<br>article. If you get a message of&nbsp;<b>335 Ok</b>&nbsp;instead, the lookup in the history file failed for some reason.<br>Terminate the conversation by typing Ctrl−D. You can check what has gone wrong by checking the system<br>log;&nbsp;<b>nntpd</b>&nbsp;logs all kinds of messages to the daemon facility of&nbsp;<b>syslog</b>. An incompatible&nbsp;dbm&nbsp;library usually<br>manifests itself in a message complaining that&nbsp;dbminit&nbsp;failed.<br>
22.5. nntpd Interaction with C News<br>
438<br>
<hr>
<A name=455></a><b>Chapter 23. Internet News</b><br>
The Internet News daemon (INN) is arguably the most popular Netnews server in use today. INN is<br>extremely flexible and is suitable for all but the smallest news sites.[135]&nbsp;INN scales well and is suited to<br>large news server configurations.<br>
The INN server comprises a number of components, each with their own configuration files that we will<br>discuss in turn. Configuration of INN can be a little involved, but we'll describe each of the stages in this<br>chapter and arm you with enough information to make sense of the INN manual pages and documentation<br>and build configurations for just about any application.<br>
Chapter 23. Internet News<br>
439<br>
<hr>
<A name=456></a><IMG src="TLNAG-456_1.png"><br>
<b>23.1. Some INN Internals</b><br>
INN's core program is the&nbsp;<b>innd</b>&nbsp;daemon.&nbsp;<b>innd</b>'s task is to handle all incoming articles, storing them<br>locally, and to pass them on to any outgoing newsfeeds if required. It is started at boot time and runs<br>continually as a background process. Running as a daemon improves performance because it has to read its<br>status files only once when starting. Depending on the volume of your news feed, certain files such as<br>history&nbsp;(which contain a list of all recently processed articles) may range from a few megabytes to tens of<br>megabytes.<br>
Another important feature of INN is that there is always only one instance of&nbsp;<b>innd</b>&nbsp;running at any time. This<br>is also very beneficial to performance, because the daemon can process all articles without having to worry<br>about synchronizing its internal states with other copies of&nbsp;<b>innd</b>&nbsp;rummaging around the news spool at the<br>same time. However, this choice affects the overall design of the news system. Because it is so important that<br>incoming news is processed as quickly as possible, it is unacceptable that the server be tied up with such<br>mundane tasks as serving newsreaders accessing the news spool via NNTP, or decompressing newsbatches<br>arriving via UUCP. Therefore, these tasks have been broken out of the main server and implemented in<br>separate support programs.&nbsp;<a href="TLNAGs.html#456">Figure 23−1&nbsp;attempts to illustrate the relationships between&nbsp;</a><b>innd</b>, the other local<br>tasks, and remote news servers and newsreaders.<br>
&nbsp;Today, NNTP is the most common means of transporting news articles around, and&nbsp;<b>innd</b>&nbsp;doesn't directly<br>support anything else. This means that&nbsp;<b>innd</b>&nbsp;listens on a TCP socket (port 119) for connections and accepts<br>news articles using the ihave protocol.<br>
Articles arriving by transports other than NNTP are supported indirectly by having another process accept the<br>articles and forward them to&nbsp;<b>innd</b>&nbsp;via NNTP. Newsbatches coming in over a UUCP link, for instance, are<br>traditionally handled by the&nbsp;<b>rnews</b>&nbsp;program. INN's&nbsp;<b>rnews</b>&nbsp;decompresses the batch if necessary, and breaks it<br>up into individual articles; it then offers them to&nbsp;<b>innd</b>&nbsp;one by one.<br>
Newsreaders can deliver news when a user posts an article. Since the handling of newsreaders deserves<br>special attention, we will come back to this a little later.<br>
<b>Figure 23−1. INN architecture (simplified for clarity)</b><br>
When receiving an article,&nbsp;<b>innd</b>&nbsp;first looks up its message ID in the&nbsp;history&nbsp;file. Duplicate articles are<br>dropped and the occurrences are optionally logged. The same goes for articles that are too old or lack some<br>required header field, such as&nbsp;Subject:.[136]&nbsp;If&nbsp;<b>innd</b>&nbsp;finds that the article is acceptable, it looks at the<br>Newsgroups:&nbsp;header line to find out what groups it has been posted to. If one or more of these groups are<br>
23.1. Some INN Internals<br>
440<br>
<hr>
<A name=457></a>Linux Network Administrators Guide<br>
found in the&nbsp;active&nbsp;file, the article is filed to disk. Otherwise, it is filed to the special group junk.<br>
Individual articles are kept below&nbsp;/var/spool/news, also called the&nbsp;<i>news spool</i>. Each newsgroup has a<br>separate directory, in which each article is stored in a separate file. The file names are consecutive numbers,<br>so that an article in comp.risks may be filed as&nbsp;comp/risks/217, for instance. When&nbsp;<b>innd</b>&nbsp;finds that the<br>directory it wants to store the article in does not exist, it creates it automatically.<br>
Apart from storing articles locally, you may also want to pass them on to outgoing feeds. This is governed<br>by the&nbsp;newsfeeds&nbsp;file that lists all downstream sites along with the newsgroups that should be fed to them.<br>
Just like&nbsp;<b>innd</b>'s receiving end, the processing of outgoing news is handled by a single interface, too. Instead<br>of doing all the transport−specific handling itself,&nbsp;<b>innd</b>&nbsp;relies on various backends to manage the transmission<br>of articles to other news servers. Outgoing facilities are collectively dubbed&nbsp;<i>channels</i>. Depending on its<br>purpose, a channel can have different attributes that determine exactly what information&nbsp;<b>innd</b>&nbsp;passes on to it.<br>
For an outgoing NNTP feed, for instance,&nbsp;<b>innd</b>&nbsp;might fork the&nbsp;<b>innxmit</b>&nbsp;program at startup, and, for each<br>article that should be sent across that feed, pass its message ID, size, and filename to&nbsp;<b>innxmit</b>'s standard<br>input. For an outgoing UUCP feed, on the other hand, it might write the article's size and file name to a<br>special logfile, which is head by a different process at regular intervals in order to create batches and queue<br>them to the UUCP subsystem.<br>
Besides these two examples, there are other types of channels that are not strictly outgoing feeds. These are<br>used, for instance, when archiving certain newsgroups, or when generating overview information. Overview<br>information is intended to help newsreaders thread articles more efficiently. Old−style newsreaders had to<br>scan all articles separately in order to obtain the header information required for threading. This would put an<br>immense strain on the server machine, especially when using NNTP; furthermore, it was very slow.[137]&nbsp;The<br>overview mechanism alleviates this problem by prerecording all relevant headers in a separate file (called<br>.overview) for each newsgroup. This information can then be picked up by newsreaders either by reading<br>it directly from the spool directory, or by using the&nbsp;<b>XOVER</b>&nbsp;command when connected via NNTP. INN has<br>the&nbsp;<b>innd</b>&nbsp;daemon feed all articles to the&nbsp;<b>overchan</b>&nbsp;command, which is attached to the daemon through a<br>channel. We'll see how this is done when we discuss configuring news feeds later.<br>
23.1. Some INN Internals<br>
441<br>
<hr>
<A name=458></a><b>23.2. Newsreaders and INN</b><br>
&nbsp;Newsreaders running on the same machine as the server (or having mounted the server's news spool via<br>NFS) can read articles from the spool directly. To post an article composed by the user, they invoke the<br><b>inews</b>&nbsp;program, which adds any header fields that are missing and forwards them to the daemon via NNTP.<br>
Alternatively, newsreaders can access the server remotely via NNTP. This type of connection is handled<br>differently from NNTP−based news feeds, to avoid tying up the daemon. Whenever a newsreader connects to<br>the NNTP server,&nbsp;<b>innd</b>&nbsp;forks a separate program called&nbsp;<b>nnrpd</b>, which handles the session while&nbsp;<b>innd</b>&nbsp;returns<br>to the more important things (receiving incoming news, for example).[138]&nbsp;You may be wondering how the<br><b>innd</b>&nbsp;process can distinguish between an incoming news feed and a connecting newsreader. The answer is<br>quite simple: the NNTP protocol requires that an NNTP−based newsreader issue a&nbsp;<b>mode reader</b>&nbsp;command<br>after connecting to the server; when this command is received, the server starts the&nbsp;<b>nnrpd</b>&nbsp;process, hands the<br>connection to it, and returns to listening for connections from another news server. There used to be at least<br>one DOS−based newsreader which was not configured to do this, and hence failed miserably when talking to<br>INN, because&nbsp;<b>innd</b>&nbsp;itself does not recognize any of the commands used to read news if it doesn't know the<br>connection is from a news reader.<br>
We'll talk a little more about newsreader access to INN under &quot;Controlling Newsreader Access,&quot; later in the<br>chapter.<br>
23.2. Newsreaders and INN<br>
442<br>
<hr>
<A name=459></a><b>23.3. Installing INN</b><br>
&nbsp;Before diving into INN's configuration, let's talk about its installation. Read this section, even if you've<br>installed INN from one of the various Linux distributions; it contains some hints about security and<br>compatibility.<br>
Linux distributions included Verson INN−1.4sec for quite some time. Unfortunately, this version had two<br>subtle security problems. Modern versions don't have these problems and most distributions include a<br>precompiled Linux binary of INN Version 2 or later.<br>
If you choose, you can build INN yourself. You can obtain the source from ftp.isc.org in the<br>/isc/inn/&nbsp;directory. Building INN requires that you edit a configuration file that tells INN some detail<br>about your operating system, and some features may require minor modifications to the source itself.<br>
Compiling the package itself is pretty simple; there's a script called&nbsp;<b>BUILD</b>&nbsp;that will guide you through the<br>process. The source also contains extensive documentation on how to install and configure INN.<br>
After installing all binaries, some manual fixups may be required to reconcile INN with any other<br>applications that may want to access its&nbsp;<b>rnews</b>&nbsp;or&nbsp;<b>inews</b>&nbsp;programs. UUCP, for instance, expects to find the<br><b>rnews</b>&nbsp;program in&nbsp;/usr/bin&nbsp;or&nbsp;/bin, while INN installs it in&nbsp;/usr/lib/bin&nbsp;by default. Make sure<br>/usr/lib/bin/&nbsp;is in the default search path, or that there are symbolic links pointing to the actual<br>location of the&nbsp;<b>rnews</b>&nbsp;and&nbsp;<b>inews</b>&nbsp;commands.<br>
23.3. Installing INN<br>
443<br>
<hr>
<A name=460></a><b>23.4. Configuring INN: the Basic Setup</b><br>
One of the greatest obstacles beginners may face is that INN requires a working network setup to function<br>properly, even when running on a standalone host. Therefore, it is essential that your kernel supports TCP/IP<br><a href="TLNAGs.html#97">networking when running INN, and that you have set up the loopback interface as explained in&nbsp;Chapter 5</a>.<br>
Next, you have to make sure that&nbsp;<b>innd</b>&nbsp;is started at boot time. The default INN installation provides a script<br>file called&nbsp;boot&nbsp;in the&nbsp;/etc/news/&nbsp;directory. If your distribution uses the SystemV−style&nbsp;<b>init</b>&nbsp;package, all<br>you have to do is create a symbolic link from your&nbsp;/etc/init.d/inn&nbsp;file pointing to<br>/etc/news/boot. For other flavors of&nbsp;<b>init</b>, you have to make sure&nbsp;/etc/news/boot&nbsp;is executed from<br>one of your&nbsp;rc&nbsp;scripts. Since INN requires networking support, the startup script should be run&nbsp;<i>after</i>&nbsp;the<br>network interfaces are configured.<br>
23.4. Configuring INN: the Basic Setup<br>
444<br>
<hr>
<A name=461></a><b>23.5. INN Configuration Files</b><br>
&nbsp;Having completed these general tasks, you can now turn to the really interesting part of INN: its<br>configuration files. All these files reside in&nbsp;/etc/news. Some changes to configurations files were<br>introduced in Version 2, and it is Version 2 that we describe here. If you're running an older version, you<br>should find this chapter useful to guide you in upgrading your configuration. During the next few sections,<br>we will discuss them one by one, building the Virtual Brewery's configuration as an example.<br>
If you want to find out more about the features of individual configuration files, you can also consult the<br>manual pages; the INN distribution contains individual manual pages for each of them.<br>
<b>23.5.1. Global Parameters</b><br>
There are a number of INN parameters that are global in nature; they are relevant to all newsgroups carried.<br>
<b>23.5.1.1. The inn.conf file</b><br>
INN's main configuration file is&nbsp;inn.conf. Among other things, it determines the name by which your<br>machine is known on Usenet. Version 2 of INN allows a baffling number of parameters to be configured in<br>this file. Fortunately, most parameters have default values that are reasonable for most sites. The<br>inn.conf(5)&nbsp;file details all of the parameters, and you should read it carefully if you experience any<br>problems.<br>
A simple example&nbsp;inn.conf&nbsp;might look like:<br>
# Sample inn.conf for the Virtual Brewery<br>
server: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vlager.vbrew.com<br>
domain: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vbrew.com<br>
fromhost: &nbsp; &nbsp; &nbsp; &nbsp;vbrew.com<br>
pathhost: &nbsp; &nbsp; &nbsp; &nbsp;news.vbrew.com<br>
organization: &nbsp; &nbsp;The Virtual Brewery<br>
mta: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /usr/sbin/sendmail −oi %s<br>
moderatormailer: %s@uunet.uu.net<br>
#<br>
# Paths to INN components and files.<br>
#<br>
pathnews: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /usr/lib/news<br>
pathbin: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/lib/news/bin<br>
pathfilter: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /usr/lib/news/bin/filter<br>
pathcontrol: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/lib/news/bin/control<br>
pathdb: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/lib/news<br>
pathetc: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/etc/news<br>
pathrun: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/run/news<br>
pathlog: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/log/news<br>
pathhttp: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/log/news<br>
pathtmp: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/tmp<br>
pathspool: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/spool/news<br>
patharticles: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/spool/news/articles<br>
pathoverview: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/spool/news/overview<br>
pathoutgoing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/spool/news/outgoing<br>
pathincoming: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/spool/news/incoming<br>
patharchive: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/spool/news/archive<br>
23.5. INN Configuration Files<br>
445<br>
<hr>
<A name=462></a>Linux Network Administrators Guide<br>
pathuniover: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/var/spool/news/uniover<br>
overviewname: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .overview<br>
The first line tells the programs&nbsp;<b>rnews</b>&nbsp;and&nbsp;<b>inews</b>&nbsp;which host to contact when delivering articles. This entry is<br>absolutely crucial; to pass articles to&nbsp;<b>innd</b>, they have to establish an NNTP connection with the server.<br>
The domain keyword should specify the domain portion of the host's fully qualified domain name. A couple<br>of programs must look up your host's fully qualified domain name; if your resolver library returns the<br>unqualified hostname only, the name given in the domain attribute is tacked onto it. It's not a problem to<br>configure it either way, so it's best to define domain.<br>
The next line defines what hostname&nbsp;<b>inews</b>&nbsp;is going to use when adding a&nbsp;<i>From:</i>&nbsp;line to articles posted by<br>local users. Most newsreaders use the&nbsp;<i>From:</i>&nbsp;field when composing a reply mail message to the author of an<br>article. If you omit this field, it will default to your news host's fully qualifed domain name. This is ot always<br>the best choice. You might, for example, have news and mail handled by two different hosts. In this case, you<br>would supply the fully qualified domain name of your mail host after the fromhost statement.<br>
The pathhost line defines the hostname INN is to add to the&nbsp;Path:&nbsp;header field whenever it receives an<br>article. In most cases, you will want to use the fully qualified domain name of your news server; you can then<br>omit this field since that is the default. Occasionally you may want to use a generic name, such as<br><i>news.vbrew.com</i>, when serving a large domain. Doing this allows you to move the news system easily to a<br>different host, should you choose to at some time.<br>
The next line contains the organization keyword. This statement allows you to configure what text&nbsp;<b>inews</b>&nbsp;will<br>put into the&nbsp;Organization:&nbsp;line of articles posted by your local users. Formally, you would place a<br>description of your organization or your organization's name in full here. Should you not wish to be so<br>formal, it is fashionable for organizations with a sense of humor to exhibit it here.<br>
The organization keyword is mandatory and specifies the pathname of the mail transport agent that will be<br>used for posting moderator messages.&nbsp;%s&nbsp;is replaced by the moderator email address.<br>
The moderatormailer entry defines a default address used when a user tries to post to a moderated newsgroup.<br>The list of moderator addresses for each newsgroup is usually kept in a separate file, but you will have a hard<br>time keeping track of all of them. The moderatormailer entry is therefore consulted as a last resort; if it is<br>defined,&nbsp;<b>inews</b>&nbsp;will replace the&nbsp;%s&nbsp;string with the (slightly transformed) newsgroup name and send the entire<br>article to this address. For instance, when posting to soc.feminism, the article is mailed to<br>soc−feminism@uunet.uu.net, given the above configuration. At UUNET, there should be a mail alias<br>installed for each of these submissions addresses that automatically forwards all messages to the appropriate<br>moderator.<br>
Finally, each of the remaining entries specifies the location of some component file or executable belonging<br>to INN. If you've installed INN from a package, these paths should have been configured for you. If you're<br>installing from source, you'll need to ensure that they reflect where you've installed INN.<br>
<b>23.5.2. Configuring Newsgroups</b><br>
&nbsp;The news administrator on a system is able to control which newsgroups users have access to. INN<br>provides two configuration files that allow the administrator to decide which newsgroups to support and<br>provide descriptions for them.<br>
23.5.2. Configuring Newsgroups<br>
446<br>
<hr>
<A name=463></a>Linux Network Administrators Guide<br>
<b>23.5.2.1. The active and newsgroups files</b><br>
&nbsp;The&nbsp;active&nbsp;and&nbsp;newsgroups&nbsp;files are used to store and describe the newsgroups hosted by this news<br>server. They list which newsgroups we are interested in receiving and serving articles for, and administrative<br>information about them. These files are found in the&nbsp;/var/lib/news/&nbsp;directory.<br>
The&nbsp;active&nbsp;file determines which newsgroups this server supports. Its syntax is straightforward. Each line<br>in the&nbsp;active&nbsp;file has four fields delimited by whitespace:<br>
name himark lomark flags<br>
The&nbsp;<i>name</i>&nbsp;field is the name of the newsgroup. The&nbsp;<i>himark</i>&nbsp;field is the highest number that has been used<br>for an article in that newsgroup. The&nbsp;<i>lomark</i>&nbsp;field is the lowest active number in use in the newsgroup. To<br>illustrate how this works, consider the follow scenario. Imagine that we have a newly created newsgroup:<br><i>himark</i>&nbsp;and&nbsp;<i>lowmark</i>&nbsp;are both 0 because there are no articles. If we post 5 articles, they will be numbered<br>1 through 5.&nbsp;<i>himark</i>&nbsp;will now equal 5, the highest numbered article, and&nbsp;<i>lowmark</i>&nbsp;will equal 1, the lowest<br>active article. If article 5 is cancelled there will be no change;&nbsp;<i>himark</i>&nbsp;will remain at 5 to ensure that that<br>article number is not reallocated and&nbsp;<i>lowmark</i>&nbsp;will remain at 1, the lowest active article. If we now cancel<br>article 1,&nbsp;<i>himark</i>&nbsp;will remain unchanged, but&nbsp;<i>lowmark</i>&nbsp;will now equal 2, because 1 is no longer active. If<br>we now post a new article, it will be assigned article number 6, so&nbsp;<i>himark</i>&nbsp;will now equal 6. Article 5 has<br>been in use, so we won't reassign it.&nbsp;<i>lowmark</i>&nbsp;remains at 2. This mechanism allows us to easily allocate<br>unique article numbers for new articles and to calculate approximately how many active articles there are in<br>the group:&nbsp;<i>himark</i>−<i>lowmark</i>.<br>
The field may contain one of the following:<br>
<i>y</i><br>
Posting directly to this news server is allowed.<br>
<i>n</i><br>
Posting directly to this news server is not allowed. This prevents newsreaders from posting directly to<br>this news server. New articles may only be received from other news servers.<br>
<i>m</i><br>
The group is moderated. Any articles posted to this newsgroup are forwarded to the newsgroup<br>moderator for approval before they enter the newsgroup. Most newsgroups are unmoderated.<br>
<i>j</i><br>
Articles in this group are not kept, but only passed on. This causes the news server to accept the<br>article, but all it will do with it is pass it to the up−stream news servers. It will not make the<br>articles available to newsreaders reading from this server.<br>
<i>x</i><br>
23.5.2.1. The active and newsgroups files<br>
447<br>
<hr>
<A name=464></a>Linux Network Administrators Guide<br>
Articles cannot be posted to this newsgroup. The only way that news articles are delivered to this<br>server is by feeding them from another news server. Newsreaders may not directly write articles to<br>this server.<br>
<i>=foo.bar</i><br>
Articles are locally filed into the ``foo.bar'' group.<br>
In our simple server configuration we'll carry a small number of newsgroups, so our<br>/var/lib/news/active&nbsp;file will look like:<br>
control 0000000000 0000000001 y<br>
junk 0000000000 0000000001 y<br>
rec.crafts.brewing 0000000000 0000000001 y<br>
rec.crafts.brewing.ales 0000000000 0000000001 y<br>
rec.crafts.brewing.badtaste 0000000000 0000000001 y<br>
rec.crafts.brewing.brandy 0000000000 0000000001 y<br>
rec.crafts.brewing.champagne 0000000000 0000000001 y<br>
rec.crafts.brewing.private 0000000000 0000000001 y<br>
The&nbsp;<i>himark</i>&nbsp;and&nbsp;<i>lomark</i>&nbsp;numbers in this example are those you would use when creating new newsgroups.<br>The&nbsp;<i>himark</i>&nbsp;and&nbsp;<i>lomark</i>&nbsp;numbers will look quite different for a newsgroup that has been active for some<br>time.<br>
The&nbsp;newsgroups&nbsp;file is even simpler. It provides one−line descriptions of newsgroups. Some newsreaders<br>are able to read and present this information to a user to help them decide whether they want to subscribe.<br>
The format of the&nbsp;newsgroups&nbsp;file is simply:<br>
name description<br>
The&nbsp;<i>name</i>&nbsp;field is the name of a newsgroup, and the &lt;<i>description</i>&nbsp;is a single line description of that<br>newsgroup.<br>
We want to describe the newsgroups that our server supports, so we'll build our&nbsp;newsgroups&nbsp;file as<br>follows:<br>
rec.crafts.brewing.ales &nbsp; &nbsp; &nbsp; &nbsp; Home brewing Ales and Lagers<br>
rec.crafts.brewing.badtaste &nbsp; &nbsp; Home brewing foul tasting brews<br>
rec.crafts.brewing.brandy &nbsp; &nbsp; &nbsp; Home brewing your own Brandy<br>
rec.crafts.brewing.champagne &nbsp; &nbsp;Home brew your own Champagne<br>
rec.crafts.brewing.private &nbsp; &nbsp; &nbsp;The Virtual Brewery home brewers group<br>
<b>23.5.3. Configuring Newsfeeds</b><br>
&nbsp;INN provides the news administrator the ability to control which newsgroups are forwarded on to other<br>news servers and how they will be forwarded. The most common method uses the NNTP protocol described<br>earlier, but INN also allows newsfeeds via other protocols, such as UUCP.<br>
23.5.3. Configuring Newsfeeds<br>
448<br>
<hr>
<A name=465></a>Linux Network Administrators Guide<br>
<b>23.5.3.1. The newsfeeds file</b><br>
The&nbsp;newsfeeds&nbsp;file determines where news articles will be sent. It normally resides in the<br>/etc/news/&nbsp;directory.<br>
The format of the&nbsp;newsfeeds&nbsp;is a little complicated at first. We'll describe the general layout here, and the<br>newsfeeds(5)&nbsp;manual page describes what we leave out. The format is as follows:<br>
# newsfeeds file format<br>
site:pattern:flags:param<br>
site2:pattern2\<br>
&nbsp; &nbsp; &nbsp; &nbsp; :flags2:param2<br>
Each news feed to a site is described by a single line, or may be spread across multiple lines using the \<br>continuation character. The : characters delimit the fields in each line. The # character at the start of a line<br>marks that line as a comment.<br>
The&nbsp;<i>site</i>&nbsp;field names the site to which this feed description relates. The sitename can be coded any way you<br>like and doesn't have to be the domain name of the site. The site name will be used later and will refer to an<br>entry in a table that supplies the hostname to the&nbsp;<b>innxmit</b>&nbsp;program that transmits the news articles by NNTP<br>to the remote server. You may have multiple entries for each site; each entry will be treated individually.<br>
The&nbsp;<i>pattern</i>&nbsp;field specifies which news groups are to be sent to this site. The default is to send all groups,<br>so if that is what you want, just make this field empty. This field is usually a comma−delimited list of<br>pattern−matching expressions. The * character matches zero or more of any character, the . character has no<br>special significance, the ! character (if used at the start of an expression) performs a logical NOT, and the @<br>character at the start of a newsgroup name means Do not forward any articles that are posted or crossposted<br>to this group. The list is read and parsed from left to right, so you should ensure that you place the more<br>specific rules first. The pattern:<br>
rec.crafts.brewing*,!rec.crafts.brewing.poison,@rec.crafts.brewing.private<br>
would send all of the&nbsp;<i>rec.crafts.brewing</i>&nbsp;news heirarchy&nbsp;<i>except</i>&nbsp;the&nbsp;<i>rec.crafts.brewing.poison</i>. It would not<br>feed any articles that were either posted or crossposted to the&nbsp;<i>rec.crafts.brewing.private</i>&nbsp;newsgroup; these<br>articles will be trapped and available only to those people who use this server. If you reversed the first two<br>patterns, the first pattern would be overridden by the second and you would end up feeding articles for the<br><i>rec.crafts.brewing.poison</i>&nbsp;newsgroup. The same is true of the first and last patterns; you must always place<br>the more specific patterns before any less specific patterns for them to take effect.<br>
<i>flags</i>&nbsp;controls and places constraints on the feed of news articles to this site. The&nbsp;<i>flags</i>&nbsp;field is a comma<br>delimited list can contain any of the items from the following list, delimited by commands:<br>
<i>&lt;size</i><br>
Article must be less then size bytes.<br>
<i>Aitems</i><br>
Article checks.&nbsp;<i>items</i>&nbsp;can be one or more of&nbsp;d&nbsp;(must have Distribution header) or&nbsp;p&nbsp;(don't check for<br>site in Path header).<br>
23.5.3.1. The newsfeeds file<br>
449<br>
<hr>
<A name=466></a>Linux Network Administrators Guide<br>
<i>Bhigh/low</i><br>
Internal buffer size before writing to output.<br>
<i>H[count]</i><br>
Article must have less then&nbsp;<i>count</i>&nbsp;hops; the default is 1.<br>
<i>Isize</i><br>
Internal buffer size (for a file feed).<br>
<i>Mpattern</i><br>
Only moderated groups that match the pattern.<br>
<i>Npattern</i><br>
Only unmoderated groups that match the pattern.<br>
<i>Ssize</i><br>
Start spooling if more than size bytes get queued.<br>
<i>Ttype</i><br>
Feed types:&nbsp;f&nbsp;(file),&nbsp;m&nbsp;(funnel; the&nbsp;<i>param</i>&nbsp;field names the entry that articles will be funneled to),<br>p&nbsp;(pipe to program),&nbsp;c&nbsp;(send to stdin channel of the&nbsp;<i>param</i>&nbsp;field's subprocess), and&nbsp;x&nbsp;(like c, but<br>handles commands on stdin).<br>
<i>Witems</i><br>
What to write:&nbsp;b&nbsp;(article bytesize),&nbsp;f&nbsp;(full path),&nbsp;g&nbsp;(first newsgroup),&nbsp;m&nbsp;(Message ID),&nbsp;n&nbsp;(relative<br>path),&nbsp;s&nbsp;(site that fed article),&nbsp;t&nbsp;(time received),&nbsp;*&nbsp;(names of funnel feed−ins or all sites that get the<br>article),&nbsp;N&nbsp;(newsgroups header),&nbsp;D&nbsp;(distribution header),&nbsp;H&nbsp;(all headers),&nbsp;O&nbsp;(overview data), and<br>R&nbsp;(replication data).<br>
The&nbsp;param&nbsp;field has special coding that is dependent on the type of feed. In the most common configuration<br>it is where you specify the name of the output file to which you will write the outgoing feed. In other<br>configurations you can leave it out. In yet other configurations it takes on different meanings. If you want to<br>do something unusual, the&nbsp;newsfeeds(5)&nbsp;manual page will explain the use of the&nbsp;param&nbsp;field in some<br>detail.<br>
There is a special site name that should be coded as&nbsp;ME&nbsp;and should be the first entry in the file. This entry is<br>used to control the default settings for your news feeds. If the&nbsp;ME&nbsp;entry has a distribution list associated with<br>it, this list will be prepended to each of the other site entries before they are sent. This allows you to, for<br>example, declare some newsgroups to be automatically fed, or automatically blocked from feeding, without<br>having to repeat the pattern in each site entry.<br>
We mentioned earlier that it was possible to use some special feeds to generate thread data that makes the<br>newsreader's job easier. We'll do this by exploiting the&nbsp;<b>overchan</b>&nbsp;command that is part of the INN<br>
23.5.3.1. The newsfeeds file<br>
450<br>
<hr>
<A name=467></a>Linux Network Administrators Guide<br>
distribution. To do this, we've created a special local feed called&nbsp;overview&nbsp;that will pass the news articles<br>to the&nbsp;<b>overchan</b>&nbsp;command for processing into overview data.<br>
Our news server will provide only one external news feed, which goes to the Groucho Marx University, and<br>they receive articles for all newsgroups except the&nbsp;<i>control</i>&nbsp;and&nbsp;<i>junk</i>&nbsp;newsgroups, the<br><i>rec.crafts.brewing.private</i>&nbsp;newsgroup, which will be kept locally, and the<br><i>rec.crafts.brewing.poison</i>&nbsp;newsgroup, which we don't want people from our brewery seen posting to.<br>
We'll use the&nbsp;<b>nntpsend</b>&nbsp;command to transport the news via NNTP to the news.groucho.edu server.<br><b>nntpsend</b>&nbsp;requires us to use the file delivery method and to write the article's pathname and article ID.<br>Note that we've set the&nbsp;<i>param</i>&nbsp;field to the name of the output file. We'll talk a little more about the<br><b>nntpsend</b>&nbsp;command in a moment. Our resulting newsfeed's configuration is:<br>
# /etc/news/newsfeeds file for the Virtual Brewery<br>
#<br>
# Send all newsgroups except the control and junk ones by default<br>
ME:!control,!junk::<br>
#<br>
# Generate overview data for any newsreaders to use.<br>
overview::Tc,WO:/usr/lib/news/bin/overchan<br>
#<br>
# Feed the Groucho Marx University everything except our private newsgroup<br>
# and any articles posted to the rec.crafts.brewing.poison newsgroup.<br>
gmarxu:!rec.crafts.brewing.poison,@rec.crafts.brewing.private:\<br>
&nbsp; &nbsp; &nbsp; &nbsp; Tf,Wnm:news.groucho.edu<br>
#<br>
<b>23.5.3.2. The nntpsend.ctl file</b><br>
&nbsp;The&nbsp;<b>nntpsend</b>&nbsp;program manages the transmission of news articles using the NNTP protocol by calling the<br><b>innxmit</b>&nbsp;command. We saw a simple use of the&nbsp;<b>nntpsend</b>&nbsp;command earlier, but it too has a configuration file<br>that provides us with some flexibility in how we configure our news feeds.<br>
The&nbsp;<b>nntpsend</b>&nbsp;command expects to find batch files for the sites it will feed. It expects those batch files to be<br>named&nbsp;/var/spool/news/out.going/<i>sitename</i>.&nbsp;<b>innd</b>&nbsp;creates these batch files when acting on an<br>entry in the&nbsp;newsfeeds, which we saw in the previous sections. We specified the sitename as the filename<br>in the&nbsp;<i>param</i>&nbsp;field, and that satisfies the&nbsp;<b>nntpsend</b>&nbsp;command's input requirements.<br>
The&nbsp;<b>nntpsend</b>&nbsp;command has a configuration file called&nbsp;nntpsend.ctl&nbsp;that is usually stored in the<br>/etc/news/&nbsp;directory.<br>
The&nbsp;nntpsend.ctl&nbsp;file allows us to associate a fully qualified domain name, some news feed size<br>constraints, and a number of transmission parameters with a news feed site name. The sitename is a means of<br>uniquely identifying a logical feed of articles. The general format of the file is:<br>
sitename:fqdn:max_size:[args]<br>
The following list describes the elements of this format:<br>
<i>sitename</i><br>
23.5.3.2. The nntpsend.ctl file<br>
451<br>
<hr>
<A name=468></a>Linux Network Administrators Guide<br>
The sitename as supplied in the&nbsp;newsfeeds&nbsp;file<br>
<i>fqdn</i><br>
The fully qualified domain name of the news server to which we will be feeding the news articles<br>
<i>max_size</i><br>
The maximum volume of news to feed in any single transfer<br>
<i>args</i><br>
Additional arguments to pass to the&nbsp;<b>innxmit</b>&nbsp;command<br>
Our sample configuration requires a very simple&nbsp;nntpsend.ctl&nbsp;file. We have only one news feed. We'll<br>restrict the feed to a maximum of 2 MB of traffic and we'll pass an argument to the&nbsp;<b>innxmit</b>&nbsp;that sets a<br>3−minute (180 second) timeout. If we were a larger site and had many news feeds, we'd simply create new<br>entries for each new feed site that looked much the same as this one:<br>
# /etc/news/nntpsend.ctl<br>
#<br>
gmarxu:news.groucho.edu:2m:−t 180<br>
#<br>
<b>23.5.4. Controlling Newsreader Access</b><br>
&nbsp;Not so many years ago, it was common for organizations to provide public access to their news servers.<br>Today it is difficult to locate public news servers; most organizations carefully control who has access to their<br>servers, typically restricting access to users supported on their network. INN provides configuration files to<br>control this access.<br>
<b>23.5.4.1. The incoming.conf file</b><br>
&nbsp;We mentioned in our introduction to INN that it achieves some of its efficiency and size by separating the<br>news feed mechanism from the newsreading mechanism. The&nbsp;/etc/news/incoming.conf&nbsp;file is where<br>you specify which hosts will be feeding you news using the NNTP protocol, as well as where you define<br>some parameters that control the way articles are fed to you from these hosts. Any host not listed in this file<br>that connects to the news socket will not be handled by the&nbsp;<b>innd</b>&nbsp;daemon; instead, it will be handled by the<br><b>nnrpd</b>&nbsp;daemon.<br>
The&nbsp;/etc/news/incoming.conf&nbsp;file syntax is very simple, but it takes a moment to come to terms<br>with. Three types of valid entries are allowed: key/value pairs, which are how you specify attributes and their<br>values; peers, which is how you specify the name of a host allowed to send articles to us using NNTP; and<br>groups, a means of applying key/value pairs to groups of peers. Key/value pairs can have three different types<br>of scope. Global pairs apply to every peer defined in the file. Group pairs apply to all peers defined within<br>that group. Peer pairs apply only to that one peer. Specific definitions override less specific ones: therefore,<br>
23.5.4. Controlling Newsreader Access<br>
452<br>
<hr>
<A name=469></a>Linux Network Administrators Guide<br>
peer definitions override group definitions, which in turn override global pairs.<br>
Curly brace characters ({}) are used to delimit the start and end of the&nbsp;group&nbsp;and&nbsp;peer&nbsp;specifications. The<br># character marks the rest of the line it appears on as a comment. Key/value pairs are separated by the colon<br>character and appear one to a line.<br>
A number of different keys may be specified. The more common and useful are:<br>
<i>hostname</i><br>
This key specifies a comma−separated list of fully qualifed names or IP addresses of the peers that<br>we'll allow to send us articles. If this key is not supplied, the hostname defaults to the label of the<br>peer.<br>
<i>streaming</i><br>
This key determines whether streaming commands are allowed from this host. It is a Boolean value<br>that defaults to&nbsp;true.<br>
<i>max−connections</i><br>
This key specifies the maximum number of connections allowed from this group or peer. A value of<br>zero means unlimited (which can also be specified using&nbsp;none).<br>
<i>password</i><br>
This key allows you to specify the password that must be used by a peer if it is to be allowed to<br>transfer news. The default is to not require a password.<br>
<i>patterns</i><br>
This key specifies the newsgroups that we accept from the associated peer. This field is coded<br>according to precisely the same rules as we used in our&nbsp;newsfeeds&nbsp;file.<br>
In our example we have only one host that we are expecting to feed us news: our upstream news provider at<br>Groucho Marx University. We'll have no password, but we will ensure that we don't accept any articles for<br>our private newsgroup from outside. Our&nbsp;hosts.nntp&nbsp;looks like:<br>
# Virtual Brewery incoming.conf file.<br>
# Global settings<br>
streaming: &nbsp; &nbsp; &nbsp; true<br>
max−connections: 5<br>
# Allow NNTP posting from our local host.<br>
peer ME {<br>
&nbsp; &nbsp; hostname: &quot;localhost, 127.0.0.1&quot;<br>
}<br>
# Allow groucho to send us all newsgroup except our local ones.<br>
peer groucho {<br>
23.5.4. Controlling Newsreader Access<br>
453<br>
<hr>
<A name=470></a>Linux Network Administrators Guide<br>
&nbsp; &nbsp; hostname: news.groucho.edu<br>
&nbsp; &nbsp; patterns: !rec.crafts.brewing.private<br>
}<br>
<b>23.5.4.2. The nnrp.access file</b><br>
&nbsp;We mentioned earlier that newsreaders, and in fact any host not listed in the&nbsp;hosts.nntp, that connect to<br>the INN news server are handled by the&nbsp;<b>nnrpd</b>&nbsp;program.&nbsp;<b>nnrpd</b>&nbsp;uses the&nbsp;/etc/news/nnrp.access&nbsp;file<br>to determine who is allowed to make use of the news server, and what permissions they should have.<br>
The&nbsp;nnrp.access&nbsp;file has a similar structure to the other configuration files we've looked at. It comprises<br>a set of patterns used to match against the connecting host's domain name or IP address, and fields that<br>determine what access and permission it should be given. Each entry should appear on a line by itself, and<br>fields are separated by colons. The last entry in this file that matches the connecting host will be the one used,<br>so again, you should put general patterns first and follow them with more specific ones later in the file. The<br>five fields of each entry in the order they should appear are:<br>
<i>Hostname or IP address</i><br>
This field conforms to&nbsp;wildmat(3)&nbsp;pattern−matching rules. It is a pattern that describes the<br>connecting host's name or IP address.<br>
<i>Permissions</i><br>
This field determines what permissions the matching host should be granted. There are two<br>permissons you may configure:&nbsp;R&nbsp;gives read permissions, and&nbsp;P&nbsp;gives posting permissions.<br>
<i>Username</i><br>
This field is optional and allows you to specify a username that an NNTP client must log into the<br>server before being allowed to post news articles. This field may be left blank. No user authentication<br>is required to read articles.<br>
<i>Password</i><br>
This field is optional and is the password accompanying the&nbsp;<i>username</i>&nbsp;field. Leaving this field<br>blank means that no password is required to post articles.<br>
<i>Newsgroups</i><br>
This field is a pattern specifying which newsgroups the client is allowed to access. The pattern<br>follows the same rules as those used in the&nbsp;newsfeeds&nbsp;file. The default for this field is no<br>newsgroups, so you would normally have a pattern configured here.<br>
In the virtual brewery example, we will allow any NNTP client in the Virtual Brewery domain to both read<br>and post to all newsgroups. We will allow any NNTP client read−only access to all newsgroups except our<br>
23.5.4.2. The nnrp.access file<br>
454<br>
<hr>
<A name=471></a>Linux Network Administrators Guide<br>
private internal newsgroup. Our&nbsp;nnrp.access&nbsp;file will look like this:<br>
# Virtual Brewery − nnrp.access<br>
# We will allow public reading of all newsgroups except our private one.<br>
*:R:::*,!rec.crafts.brewing.private<br>
# Any host with the Virtual Brewery domain may Read and Post to all&nbsp;<br>
# newsgroups<br>
*.vbrew.com:RP::*<br>
<b>23.5.5. Expiring News Articles</b><br>
&nbsp;When news articles are received by a news server, they are stored to disk. News articles need to be<br>available to users for some period of time to be useful, so a large operating news server can consume lots of<br>disk space. To ensure that the disk space is used effectively, you can opt to delete news articles automatically<br>after a period of time. This is called&nbsp;<b>article expiration</b>. Naturally, INN provides a means of automatically<br>expiring news articles.<br>
<b>23.5.5.1. The expire.ctl file</b><br>
The INN server uses a program called&nbsp;<b>expire</b>&nbsp;to delete expired news articles. The&nbsp;<b>expire</b>&nbsp;program in turn<br>uses a file called&nbsp;/etc/news/expire.ctl&nbsp;to configure the rules that govern article expiration.<br>
The syntax of&nbsp;/etc/news/expire.ctl&nbsp;is fairly simple. As with most configuration files, empty lines or<br>lines beginning with the # character are ignored. The general idea is that you specify one rule per line. Each<br>rule defines how article expiration will be performed on newsgroups matching a supplied pattern. The rule<br>syntax looks like this:<br>
<i>pattern</i>:<i>modflag</i>:<i>keep</i>:<i>default</i>:<i>purge</i><br>
The following list describes the fields:<br>
<i>pattern</i><br>
This field is a comma−delimited list of patterns matching names of newsgroups. The&nbsp;wildmat(3)<br>routine is used to match these patterns. The last rule matching a newsgroup name is the one that is<br>applied, so if you want to specify wildcard (*) rules, they should be listed first in this file.<br>
<i>modflag</i><br>
This flag describes how this rule applies to moderated newsgroups. It can be coded with an&nbsp;M&nbsp;to mean<br>that this rule applies only to moderated newsgroups, a&nbsp;U&nbsp;to mean that this rule applies only to<br>unmoderated newsgroups, or an&nbsp;A&nbsp;to mean that this rule ignores the moderated status and applies to<br>all groups.<br>
<i>keep</i><br>
This field allows you to specify the minimum time an article with an Expires header will be kept<br>before it is expired. The units are days, and are a floating point, so you may specify values like<br>
23.5.5. Expiring News Articles<br>
455<br>
<hr>
<A name=472></a>Linux Network Administrators Guide<br>
7.5&nbsp;for seven−and−a−half days. You may also specify&nbsp;never&nbsp;if you wish articles to stay in a<br>newsgroup forever.<br>
<i>default</i><br>
This field is the most important. This field allows you to specify the time an article without an<br>Expires&nbsp;header will be kept. Most articles won't have an&nbsp;Expires&nbsp;header. This field is coded in<br>the same way as the&nbsp;<i>keep</i>&nbsp;field, with&nbsp;never&nbsp;meaning that articles without&nbsp;Expires&nbsp;headers will<br>never be expired.<br>
<i>purge</i><br>
This field allows you to specify the maximum time an article with an&nbsp;Expires&nbsp;header will be kept<br>before it is expired. The coding of this field is the same as for the&nbsp;keep&nbsp;field.<br>
Our requirements are simple. We will keep all articles in all newsgroups for 14 days by default, and between<br>7 and 21 days for articles that have an&nbsp;Expires&nbsp;header. The&nbsp;<i>rec.crafts.brewing.private</i>&nbsp;newsgroup is our<br>internal newsgroup, so we'll make sure we don't expire any articles from it:<br>
# expire.ctl file for the Virtual Brewery<br>
# Expire all articles in 14 days by default, 7−21 days for those with<br>
# Expires: headers<br>
*:A:7:14:21<br>
# This is a special internal newsgroup, which we will never expire.<br>
rec.crafts.brewing.private:A:never:never:never<br>
We will mention one special type of entry you may have in your&nbsp;/etc/news/expires.ctl&nbsp;file. You<br>may have exactly one line that looks like this:<br>
/remember/:<i>days</i><br>
This entry allows you to specify the minimum number of days that an article will be remembered in the<br>history file, irrespective of whether the article itself has been expired or not. This might be useful if one of the<br>sites that is feeding you articles is infrequent and has a habit of sending you old articles every now and again.<br>Setting the&nbsp;<i>/remember/</i>&nbsp;field helps to prevent the upstream server from sending you the article again, even<br>if it has already been expired from your server. If your server remembers it has already received the article, it<br>will reject attempts to resend it. It is important to remember that this setting has no effect at all on article<br>expiration; it affects only the time that details of an article are kept in the history database.<br>
<b>23.5.6. Handling Control Messages</b><br>
Just as with C News, INN can automatically process control messages. INN provides a powerful<br>configuration mechanism to control what action will occur for each of a variety of control messages, and an<br>access control mechanism to control who can initiate actions against which newsgroups.<br>
23.5.6. Handling Control Messages<br>
456<br>
<hr>
<A name=473></a>Linux Network Administrators Guide<br>
<b>23.5.6.1. The control.ctl file</b><br>
The&nbsp;control.ctl&nbsp;file is fairly simple in structure. The syntax rules for this file are much the same as for<br>the other INN configuration files. Lines beginning with&nbsp;#&nbsp;are ignored, lines may be continued using&nbsp;/, and<br>fields are delimited by&nbsp;:.<br>
When a control message is received, it is tested against each rule in turn. The last rule in the file that matches<br>the message is the rule that will be used, so you should put any generic rules at the start of the file and more<br>specific rules at the end of the file. The general syntax of the file is:<br>
<i>message</i>:<i>from</i>:<i>newsgroups</i>:<i>action</i><br>
The meanings of each of the fields are:<br>
<i>message</i><br>
This is the name of the control message. Typical control messages are described later.<br>
<i>from</i><br>
This is a shell−style pattern matching the email address of the person sending the message. The email<br>address is converted to lowercase before comparison.<br>
<i>newsgroups</i><br>
If the control message is&nbsp;newgroup&nbsp;or&nbsp;rmgroup, this field is a shell−style pattern matching the<br>newsgroup created or removed.<br>
<i>action</i><br>
This field specifies what action to take for any message matching the rule. There are quite a number<br>of actions we can take; they are described in the next list.<br>
The&nbsp;<i>message</i>&nbsp;field of each line can have one of the following values:<br>
<i>checkgroups</i><br>
This message requests that news administrators resynchonrize their active newsgroups database<br>against the list of newsgroups supplied in the control message.<br>
<i>newgroup</i><br>
This message requests the creation of a new newsgroup. The body of the control message should<br>contain a short description of the purpose of the newsgroup to be created.<br>
<i>rmgroup</i><br>
requests that a newsgroup be removed.<br>
<i>sendsys</i><br>
23.5.6.1. The control.ctl file<br>
457<br>
<hr>
<A name=474></a>Linux Network Administrators Guide<br>
This message requests that the&nbsp;sys&nbsp;file of this news server be transmitted by mail to the originator<br>of the control message. RFC−1036 states that it is a requirement of Usenet membership that this<br>information be publicly available because it is used to keep the map of Usenet up to date.<br>
<i>version</i><br>
This message requests that the hostname and version of news server software be returned to the<br>originator of the control message.<br>
<i>all</i><br>
This is a special coding that will match any control message.<br>
The&nbsp;<i>message</i>&nbsp;field may include the following actions:<br>
<i>doit</i><br>
The requested command is performed. In many cases, a mail message will be sent to the<br>administrator to advise them that the action has taken place.<br>
<i>doit=file</i><br>
This is the same as the&nbsp;doit&nbsp;action except that a log message will be written to the&nbsp;<i>file</i>&nbsp;log file. If the<br>specified file is&nbsp;<i>mail</i>, the log entry is sent by email. If the specified file is the null string, the log<br>message is written to&nbsp;/dev/null&nbsp;and is equivalent to using the unqualified&nbsp;doit&nbsp;action. If the<br><i>file</i>&nbsp;name begins with a / character, the name is taken to be an absolute filename for the logfile;<br>otherwise, the specified name is translated to&nbsp;/var/log/news/file.log.<br>
<i>doifarg</i><br>
The requested command is performed if the command has an argument. If the command has no<br>argument, the control message is ignored.<br>
<i>drop</i><br>
The requested command is ignored.<br>
<i>log</i><br>
A log message is sent to the&nbsp;stderr&nbsp;output of the&nbsp;<b>innd</b>&nbsp;process. This is normally directed out to the<br>/var/log/news/errlog&nbsp;file.<br>
<i>log=file</i><br>
This is the same as a&nbsp;log&nbsp;action, except the logfile is specified as per the rules given for the<br>doit=<i>file</i>&nbsp;action.<br>
<i>mail</i><br>
An email message is sent to the news administrator containing the requested command details. No<br>other action takes place.<br>
23.5.6.1. The control.ctl file<br>
458<br>
<hr>
<A name=475></a>Linux Network Administrators Guide<br>
<i>verify−*</i><br>
&nbsp;If an action begins with the string&nbsp;verify−, then the control message is authenticated using<br>PGP (or GPG).[139]<br>
So that you can see what a&nbsp;control.ctl&nbsp;file would look like in practice, here is a very short illustrative<br>sample:<br>
## Sample /etc/news/control.ctl<br>
##<br>
## Warning: You should not use this file, it is illustrative only.<br>
## &nbsp; &nbsp; &nbsp;Control Message Handling<br>
all:*:*:mail<br>
checkgroups:*:*:mail<br>
ihave:*:*:drop<br>
sendme:*:*:drop<br>
sendsys:*:*:log=sendsys<br>
senduuname:*:*:log=senduuname<br>
version:*:*:log=version<br>
newgroup:*:*:mail<br>
rmgroup:*:*:mail<br>
## &nbsp;Handle control messages for the eight most important news heirarchies<br>
## &nbsp;COMP, HUMANITIES, MISC, NEWS, REC, SCI, SOC, TALK<br>
checkgroups:*:comp.*|humanities.*|misc.*|news.*|rec.*|sci.*|soc.*|talk.*:drop<br>
newgroup:*:comp.*|humanities.*|misc.*|news.*|rec.*|sci.*|soc.*|talk.*:drop<br>
rmgroup:*:comp.*|humanities.*|misc.*|news.*|rec.*|sci.*|soc.*|talk.*:drop<br>
checkgroups:group−admin@isc.org:*:verify−news.announce.newgroups<br>
newgroup:group−admin@isc.org:comp.*|misc.*|news.*:verify−news.announce.newgroups<br>
newgroup:group−admin@isc.org:rec.*|sci.*|soc.*:verify−news.announce.newgroups<br>
newgroup:group−admin@isc.org:talk.*|humanities.*:verify−news.announce.newgroups<br>
rmgroup:group−admin@isc.org:comp.*|misc.*|news.*:verify−news.announce.newgroups<br>
rmgroup:group−admin@isc.org:rec.*|sci.*|soc.*:verify−news.announce.newgroups<br>
rmgroup:group−admin@isc.org:talk.*|humanities.*:verify−news.announce.newgroups<br>
## GNU ( Free Software Foundation )<br>
newgroup:gnu@prep.ai.mit.edu:gnu.*:doit<br>
newgroup:news@*ai.mit.edu:gnu.*:doit<br>
rmgroup:gnu@prep.ai.mit.edu:gnu.*:doit<br>
rmgroup:news@*ai.mit.edu:gnu.*:doit<br>
## LINUX (Newsfeed from news.lameter.com)<br>
checkgroups:christoph@lameter.com:linux.*:doit<br>
newgroup:christoph@lameter.com:linux.*:doit<br>
rmgroup:christoph@lameter.com:linux.*:doit<br>
23.5.6.1. The control.ctl file<br>
459<br>
<hr>
<A name=476></a><b>23.6. Running INN</b><br>
&nbsp;The&nbsp;<b>inn</b>&nbsp;source package provides a script suitable for starting&nbsp;<b>inn</b>&nbsp;at boot time. The script is usually called<br>/usr/lib/news/bin/rc.news. The script reads arguments from another script, usually called<br>/usr/lib/news/innshellvars, which contains definitions of the filenames and filepaths that&nbsp;<b>inn</b>&nbsp;will<br>use to locate components it needs. It is generally considered a good idea to execute&nbsp;<b>inn</b>&nbsp;with the permissions<br>of a non−root user, such as&nbsp;news.<br>
To ensure that&nbsp;<b>inn</b>&nbsp;is started at boot time, you should check that&nbsp;/usr/lib/news/innshellvars&nbsp;is<br>configured correctly and then call the&nbsp;/usr/lib/news/bin/rc.news&nbsp;script from a script executed at<br>boot time.<br>
Additionally, there are administrative tasks that must be performed periodically. These tasks are usually<br>configured to be executed by the&nbsp;<b>cron</b>&nbsp;command. The best way to do this is to add the appropriate commands<br>to your&nbsp;/etc/crontab&nbsp;file, or even better, create a file suitable for the&nbsp;/etc/cron.d&nbsp;directory, if your<br>distribution provides one. An example of such a file might look like:<br>
# Example /etc/cron.d/inn file, as used in the Debian distribution.<br>
#<br>
SHELL=/bin/sh<br>
PATH=/usr/lib/news/bin:/sbin:/bin:/usr/sbin:/usr/bin<br>
# Expire old news and overview entries nightly, generate reports.<br>
15 0 * * * &nbsp; &nbsp; &nbsp;news &nbsp; &nbsp;news.daily expireover lowmark delayrm<br>
# Every hour, run an rnews −U. This is not only for UUCP sites, but<br>
# also to process queued up articles put there by in.nnrpd in case<br>
# innd wasn't accepting any articles.<br>
10 * * * * &nbsp; &nbsp; &nbsp;news &nbsp; &nbsp;rnews −U<br>
These commands will ensure that old news is automatically expired each day, and that any queued articles are<br>processed each hour. Note also that they are executed with the permissions of the&nbsp;news&nbsp;user.<br>
23.6. Running INN<br>
460<br>
<hr>
<A name=477></a><b>23.7. Managing INN: The ctlinnd Command</b><br>
&nbsp;The INN news server comes with a command to manage its day−to−day operation. The&nbsp;<b>ctlinnd</b>&nbsp;command<br>can be used to manipulate newsgroups and newsgroup feeds, to obtain the status, of the server, and to reload,<br>stop, and start the server.<br>
You'd normally get a summary of the&nbsp;<b>ctlinnd</b>&nbsp;command syntax using:<br>
<i># ctlinnd −h</i><br>
We'll cover some of the more important uses of&nbsp;<b>ctlinnd</b>&nbsp;here; please consult the&nbsp;<b>ctlinnd</b>&nbsp;manual page for<br>more detail.<br>
<b>23.7.1. Add a New Group</b><br>
Use the following syntax to add a new group:<br>
ctlinnd newgroup&nbsp;<i>group&nbsp;rest&nbsp;creator</i><br>
The arguments are defined as follows:<br>
<i>group</i><br>
The name of the group to create.<br>
<i>rest</i><br>
This argument should be coded in the same way as the&nbsp;<i>flags</i>&nbsp;field of the&nbsp;active&nbsp;file. It defaults to<br>y&nbsp;if not supplied.<br>
<i>creator</i><br>
The name of the person creating the group. Enclose it in quotes if there are any spaces in the name.<br>
<b>23.7.2. Change a Group</b><br>
Use the following syntax to change a group:<br>
ctlinnd changegroup&nbsp;<i>group&nbsp;rest</i><br>
The arguments are defined as follows:<br>
<i>group</i><br>
The name of the group to change.<br>
<i>rest</i><br>
23.7. Managing INN: The ctlinnd Command<br>
461<br>
<hr>
<A name=478></a>Linux Network Administrators Guide<br>
This argument should be coded in the same way as the&nbsp;<i>flags</i>&nbsp;field of the&nbsp;active&nbsp;file.<br>
This command is useful to change the moderation status of a group.<br>
<b>23.7.3. Remove a Group</b><br>
Use the following syntax to remove a group:<br>
ctlinnd rmgroup&nbsp;<i>group</i><br>
The argument is defined as follows:<br>
<i>group</i><br>
The name of the group to remove.<br>
This command removes the specified newsgroup from the&nbsp;active&nbsp;file. It has no effect on the news spool.<br>All articles in the spool for the specified group will be expired in the usual fashion, but no new articles will<br>be accepted.<br>
<b>23.7.4. Renumber a Group</b><br>
Use the following syntax to renumber a group:<br>
ctlinnd renumber&nbsp;<i>group</i><br>
The argument is defined as follows:<br>
<i>group</i><br>
The name of the group to renumber. If a&nbsp;<b>group</b>&nbsp;is an empty string, all groups are renumbered.<br>
This command updates the low−water mark for the specified group.<br>
<b>23.7.5. Allow/Disallow Newsreaders</b><br>
Use the following syntax to allow or disallow newsreaders:<br>
ctlinnd readers&nbsp;<i>flag&nbsp;text</i><br>
The arguments are defined as follows:<br>
<i>flag</i><br>
Specifying&nbsp;n&nbsp;causes all newsreader connections to be disallowed. Specifying&nbsp;y&nbsp;allows newsreader<br>connections.<br>
23.7.3. Remove a Group<br>
462<br>
<hr>
<A name=479></a>Linux Network Administrators Guide<br>
<i>text</i><br>
The text supplied will be given to newsreaders who attempt to connect, and usually describes the<br>reason for disabling newsreader access. When reenabling newsreader access, this field must be either<br>an empty string or a copy of the text supplied when the newsreader was disabled.<br>
This command does not affect incoming newsfeeds. It only controls connections from newsreaders.<br>
<b>23.7.6. Reject Newsfeed Connections</b><br>
Use the following syntax to reject newsfeed connections:<br>
ctlinnd reject&nbsp;<i>reason</i><br>
The argument is defined as follows:<br>
<i>reason</i><br>
The text supplied should explain why incoming connections to&nbsp;<b>innd</b>&nbsp;are rejected.<br>
This command does not affect connections that are handed off to&nbsp;<b>nnrpd</b>&nbsp;(i.e., newsreaders); it only affects<br>connections that would be handled by&nbsp;<b>innd</b>&nbsp;directly, such as remote newsfeeds.<br>
<b>23.7.7. Allow Newsfeed Connections</b><br>
Use the following syntax to allow newsfeed connections:<br>
ctlinnd allow&nbsp;<i>reason</i><br>
The argument is defined as follows:<br>
<i>reason</i><br>
The supplied text must be the same as that supplied to the preceding&nbsp;<b>reject</b>&nbsp;command or an empty<br>string.<br>
This command reverses the effect of a&nbsp;<b>reject</b>&nbsp;command.<br>
<b>23.7.8. Disable News Server</b><br>
Use the following syntax to disable the news server:<br>
ctlinnd throttle&nbsp;<i>reason</i><br>
The argument is defined as follows:<br>
23.7.6. Reject Newsfeed Connections<br>
463<br>
<hr>
<A name=480></a>Linux Network Administrators Guide<br>
<i>reason</i><br>
The reason for throttling the server.<br>
This command is simultaneously equivalent to a&nbsp;newsreaders no&nbsp;and a&nbsp;reject, and is useful when<br>emergency work is performed on the news database. It ensures that nothing attempts to update it while you<br>are working on it.<br>
<b>23.7.9. Restart News Server</b><br>
Use the following syntax to restart the news server:<br>
ctlinnd go&nbsp;<i>reason</i><br>
The argument is defined as follows:<br>
<i>reason</i><br>
The reason given when stopping the server. If this field is an empty string, the server will be<br>reenabled unconditionally. If a reason is given, only those functions disabled with a reason matching<br>the supplied text will be restarted.<br>
This command is used to restart a server function after a&nbsp;<b>throttle</b>,&nbsp;<b>pause</b>, or&nbsp;<b>reject</b>&nbsp;command.<br>
<b>23.7.10. Display Status of a Newsfeed</b><br>
Use the following syntax to display the status of a newsfeed:<br>
ctlinnd feedinfo&nbsp;<i>site</i><br>
The argument is defined as follows:<br>
<i>site</i><br>
The site name (taken from the&nbsp;newsfeeds&nbsp;file) for which you wish to display the newsfeed's status.<br>
<b>23.7.11. Drop a Newsfeed</b><br>
Use the following syntax to drop a newsfeed:<br>
ctlinnd drop&nbsp;<i>site</i><br>
The argument is defined as follows:<br>
<i>site</i><br>
23.7.9. Restart News Server<br>
464<br>
<hr>
<A name=481></a>Linux Network Administrators Guide<br>
The name of the site (taken from the&nbsp;newsfeeds&nbsp;file) to which feeds are dropped. If this field is an<br>empty string, all active feeds will be dropped.<br>
Dropping a newsfeed to a site halts any active feeds to the site. It is not a permanent change. This command<br>would be useful if you've modified the feed details for a site and a feed to that site is active.<br>
<b>23.7.12. Begin a Newsfeed</b><br>
Use the following syntax to begin a newsfeed:<br>
ctlinnd begin&nbsp;<i>site</i><br>
The argument is defined as follows:<br>
<i>site</i><br>
The name of the site from the&nbsp;newsfeeds&nbsp;file to which feeds are started. If a feed to the site is<br>already active, a&nbsp;<b>drop</b>&nbsp;command is done first automatically.<br>
This command causes the server to reread the&nbsp;newsfeeds&nbsp;file, locate the matching entry, and commence a<br>newsfeed to the named site using the details found. You can use this command to test a new news feed to a<br>site after you've added or modified its entry in the&nbsp;newsfeeds&nbsp;file.<br>
<b>23.7.13. Cancel an Article</b><br>
Use the following syntax to cancel an article:<br>
ctlinnd cancel&nbsp;<i>Message−Id</i><br>
The argument is defined as follows:<br>
<i>Message−ID</i><br>
The ID of the article to be cancelled.<br>
This command causes the specified article to be deleted from the server. It does not generate a cancel<br>message.<br>
23.7.12. Begin a Newsfeed<br>
465<br>
<hr>
<A name=482></a><b>Chapter 24. Newsreader Configuration</b><br>
A&nbsp;<b>newsreader</b>&nbsp;is a program that users invoke to view, store, and create news articles. Several newsreaders<br>have been ported to Linux. We will describe the basic setup for the three most popular newsreaders:&nbsp;<b>tin</b>,&nbsp;<b>trn</b>,<br>and&nbsp;<b>nn</b>.<br>
One of the most effective newsreaders is:<br>
$&nbsp;<b>find /var/spool/news −name '[0−9]*' −exec cat {} \; | more</b><br>
This is the way Unix die−hards read their news.<br>
Most newsreaders, however, are much more sophisticated. They usually offer a full−screen interface with<br>separate levels for displaying all groups the user has subscribed to, an overview of all articles in each group,<br>and individual articles. Many web browsers double as newsreaders, but if you want to use a standalone<br>newsreader, this chapter explains how to configure two classic ones:&nbsp;<b>trn</b>&nbsp;and&nbsp;<b>nn</b>.<br>
At the newsgroup level, most newsreaders display a list of articles, showing their subject lines and authors. In<br>big groups, it is difficult for the user to keep track of articles relating to each other, although it is possible to<br>identify responses to earlier articles.<br>
&nbsp;A response usually repeats the original article's subject, prepending it with&nbsp;Re:. Additionally, the<br>References:&nbsp;header line should include the message ID of the article on which the response is directly<br>following up. Sorting articles by these two criteria generates small clusters (in fact, trees) of articles, which<br>are called&nbsp;<i>threads</i>. One of the tasks of writing a newsreader is devising an efficient scheme of threading,<br>because the time required for this is proportional to the square of the number of articles.<br>
We will not go into how the user interfaces are built here. All newsreaders currently available for Linux have<br>a good help function; please refer to it for more details.<br>
In the following sections, we will deal only with administrative tasks. Most of these relate to the creation of<br>threads databases and accounting.<br>
Chapter 24. Newsreader Configuration<br>
466<br>
<hr>
<A name=483></a><b>24.1. tin Configuration</b><br>
The most versatile newsreader with respect to threading is&nbsp;<b>tin</b>. It was written by Iain Lea and is loosely<br>modeled on an older newsreader named&nbsp;<b>tass</b>&nbsp;(written by Rich Skrenta). It does its threading when the user<br>enters the newsgroup, and it is pretty fast unless you're getting posts via NNTP.<br>
On a 486DX50, it takes roughly 30 seconds to thread 1,000 articles when reading directly from disk. It would<br>take more than 5 minutes over NNTP to reach a loaded news server.[140]&nbsp;You may improve this time by<br>regularly updating your index file by invoking&nbsp;<b>tin</b>&nbsp;with the&nbsp;−u&nbsp;option, so that when you next start&nbsp;<b>tin</b>&nbsp;to read<br>news the threads already exist. Alternatively, you can invoke&nbsp;<b>tin</b>&nbsp;with the&nbsp;−U&nbsp;option to read news. When<br>invoked this way,&nbsp;<b>tin</b>&nbsp;forks a background process to build the index files while you are reading news.<br>
Usually,&nbsp;<b>tin</b>&nbsp;dumps its threading databases in the user's home directory below&nbsp;.tin/index. This may be<br>costly in terms of resources, however, so you should keep a single copy of them in a central location. This<br>may be achieved by making&nbsp;<b>tin</b>&nbsp;setuid to news, for example.&nbsp;<b>tin</b>&nbsp;will then keep all thread databases below<br>/var/spool/news/.index. For any file access or shell escape, it will reset its effective uid to the real<br>uid of the user who invoked it.[141]<br>
The version of&nbsp;<b>tin</b>&nbsp;included in some Linux distributions is compiled without NNTP support, but most do have<br>it now. When invoked as&nbsp;<b>rtin</b>&nbsp;or with the&nbsp;−r&nbsp;option,&nbsp;<b>tin</b>&nbsp;tries to connect to the NNTP server specified in the<br>file&nbsp;/etc/nntpserver&nbsp;or in the NNTPSERVER environment variable. The&nbsp;nntpserver&nbsp;file simply<br>contains the server's name on a single line.<br>
24.1. tin Configuration<br>
467<br>
<hr>
<A name=484></a><b>24.2. trn Configuration</b><br>
<b>trn</b>&nbsp;is also the successor to an older newsreader, namely&nbsp;<b>rn</b>&nbsp;(which means&nbsp;<i>read news</i>). The t in its name<br>stands for threaded. It was written by Wayne Davidson.<br>
Unlike&nbsp;<b>tin</b>,&nbsp;<b>trn</b>&nbsp;has no provision for generating its threading database at runtime. Instead, it uses those<br>prepared by a program called&nbsp;<b>mthreads</b>&nbsp;that has to be invoked regularly from&nbsp;<b>cron</b>&nbsp;to update the index files.<br>
You can still access new articles if you're not running&nbsp;<b>mthreads</b>, but you will have all those A GENUINE<br>INVESTMENT OPPORTUNITY articles scattered across your article selection menu, instead of a single<br>thread you may easily skip.<br>
To turn on threading for particular newsgroups, invoke&nbsp;<b>mthreads</b>&nbsp;with the list of newsgroups on the<br>command line. The format of the list is the same as the one in the C News&nbsp;sys&nbsp;file:<br>
$&nbsp;<b>mthreads comp,rec,!rec.games.go</b><br>
This command enables threading for all of comp and rec, except for rec.games.go (people who play Go don't<br>need fancy threads). After that, you simply invoke&nbsp;<b>mthreads</b>&nbsp;with no options at all to make it thread any<br>newly arrived articles. Threading of all groups found in your&nbsp;active&nbsp;file can be turned on by invoking<br><b>mthreads</b>&nbsp;with a group list of all.<br>
If you're receiving news during the night, you will customarily run&nbsp;<b>mthreads</b>&nbsp;once in the morning, but you<br>can also to do so more frequently if necessary. Sites that have very heavy traffic may want to run<br><b>mthreads</b>&nbsp;in daemon mode. When it is started at boot time using the&nbsp;−d&nbsp;option, it puts itself in the<br>background, wakes up every ten minutes to check if there are any newly arrived articles, and threads them.<br>To run&nbsp;<b>mthreads</b>&nbsp;in daemon mode, put the following line in your&nbsp;rc.news&nbsp;script:<br>
/usr/local/bin/rn/mthreads −deav<br>
The&nbsp;−a&nbsp;option makes&nbsp;<b>mthreads</b>&nbsp;automatically turn on threading for new groups as they are created;<br>−v&nbsp;enables verbose log messages to the&nbsp;<b>mthreads</b>&nbsp;log file&nbsp;mt.log&nbsp;in the directory where you have<br><b>trn</b>&nbsp;installed.<br>
&nbsp;Old articles that are no longer available must be removed from the index files regularly. By default, only<br>articles with a number below the low−water mark will be removed.[142]&nbsp;Articles above this number that<br>have been expired (because the oldest article has been assigned a long expiration date by an<br><i>Expires:</i>&nbsp;header field) may nevertheless be removed by giving&nbsp;<b>mthreads</b>&nbsp;the&nbsp;−e&nbsp;option to force an<br>enhanced expiry run. When&nbsp;<b>mthreads</b>&nbsp;is running in daemon mode, the&nbsp;−e&nbsp;option makes&nbsp;<b>mthreads</b>&nbsp;put in<br>such an enhanced expiry run once a day, shortly after midnight.<br>
24.2. trn Configuration<br>
468<br>
<hr>
<A name=485></a><b>24.3. nn Configuration</b><br>
<b>nn</b>, written by Kim F. Storm, claims to be a newsreader whose ultimate goal is not to read news. Its name<br>stands for No News, and its motto is No news is good news.&nbsp;<b>nn</b>&nbsp;is better.<br>
To achieve this ambitious goal,&nbsp;<b>nn</b>&nbsp;comes with a large assortment of maintenance tools that not only allow<br>thread generation, but also extensive database consistency checks, accounting, gathering of usage statistics,<br>and access restrictions. There is also an administration program called&nbsp;<b>nnadmin</b>, which allows you to<br>perform these tasks interactively. It is very intuitive, so we will not dwell on these aspects, but deal only with<br>the generation of the index files.<br>
The&nbsp;<b>nn</b>&nbsp;threads database manager is called&nbsp;<b>nnmaster</b>. It is usually run as a daemon, started from an&nbsp;rc&nbsp;file<br>at boot time. It is invoked as:<br>
/usr/local/lib/nn/nnmaster −l −r −C<br>
This enables threading for all newsgroups present in your&nbsp;active&nbsp;file.<br>
Equivalently, you may invoke&nbsp;<b>nnmaster</b>&nbsp;periodically from&nbsp;<b>cron</b>, giving it a list of groups to act upon. This<br>list is very similar to the subscription list in the&nbsp;sys&nbsp;file, except that it uses blanks instead of commas.<br>Instead of the fake group name&nbsp;<i>all</i>, an empty argument of&nbsp;&quot;&quot;&nbsp;should be used to denote all groups. A sample<br>invocation looks like this:<br>
#&nbsp;<b>/usr/local/lib/nn/nnmaster !rec.games.go rec comp</b><br>
Note that the order is significant. The leftmost group specification that matches always wins. Thus, if we had<br>put !rec.games.go after rec, all articles from this group would have been threaded nevertheless.<br>
<b>nn</b>&nbsp;offers several methods to remove expired articles from its databases. The first is to update the database<br>
by scanning the newsgroup directories and discarding the entries whose corresponding article has exceeded<br>its expiration date. This is the default operation obtained by invoking&nbsp;<b>nnmaster</b>&nbsp;with the&nbsp;−E&nbsp;option. It is<br>reasonably quick, unless you're doing this via NNTP.<br>
The second method behaves exactly like a default expiration run of&nbsp;<b>mthreads</b>; it removes only those entries<br>that refer to articles with numbers below the low−water mark in the&nbsp;active&nbsp;file. It may be enabled using the<br>−e&nbsp;option.<br>
Finally, the third strategy discards the entire database and recollects all articles. It may be enabled using the<br>−E3&nbsp;option.<br>
The list of groups to be expired is given by the&nbsp;−F&nbsp;option in the same fashion as above. However, if you have<br><b>nnmaster</b>&nbsp;running as daemon, you must kill it (using&nbsp;−k) before expiration can take place, and restart it with<br>the original options afterward. Thus the proper command to run expiration on all groups using the first<br>method is:<br>
#&nbsp;<b>nnmaster −kF &quot;&quot;</b><br>
#&nbsp;<b>nnmaster −lrC</b><br>
There are many more flags that fine−tune the&nbsp;<b>nn</b>'s behavior. If you are concerned about removing bad articles<br>or assembling article digests, read the&nbsp;<b>nnmaster</b>&nbsp;manual page.<br>
24.3. nn Configuration<br>
469<br>
<hr>
<A name=486></a>Linux Network Administrators Guide<br>
<b>nnmaster</b>&nbsp;relies on a file named&nbsp;GROUPS, which is located in&nbsp;/var/lib/nn. If it does not exist when<br><b>nnmaster</b>&nbsp;is first run, it is created. For each newsgroup, it contains a line that begins with the group's name,<br>optionally followed by a time stamp and flags. You may edit these flags to enable certain behavior for the<br>group in question, but you may not change the order in which the groups appear.[143]&nbsp;The flags allowed and<br>their effects are detailed in the&nbsp;<b>nnmaster</b>&nbsp;manual page, too.<br>
24.3. nn Configuration<br>
470<br>
<hr>
<A name=487></a><IMG src="TLNAG-487_1.png"><br>
<IMG src="TLNAG-487_2.png"><br>
<b>Appendix A. Example Network:The Virtual Brewery</b><br>
Throughout this book we've used the following example that is a little less complex than Groucho Marx<br>University and may be closer to the tasks you will actually encounter.<br>
The Virtual Brewery is a small company that brews, as the name suggests, virtual beer. To manage their<br>business more efficiently, the virtual brewers want to network their computers, which all happen to be PCs<br>running the brightest and shiniest production Linux kernel.&nbsp;<a href="TLNAGs.html#487">Figure A−1&nbsp;shows the network configuration.</a><br>
On the same floor, just across the hall, there's the Virtual Winery, which works closely with the brewery. The<br>vintners run an Ethernet of their own. Quite naturally, the two companies want to link their networks once<br>they are operational. As a first step, they want to set up a gateway host that forwards datagrams between the<br>two subnets. Later, they also want to have a UUCP link to the outside world, through which they exchange<br>mail and news. In the long run, they also want to set up PPP connections to connect to offsite locations and to<br>the Internet.<br>
The Virtual Brewery and the Virtual Winery each have a class C subnet of the Brewery's class B network,<br><a href="TLNAGs.html#487">and gateway to each other via the host vlager, which also supports the UUCP connection.&nbsp;Figure A−2</a>&nbsp;shows<br>the configuration.<br>
<b>Figure A−1. The Virtual Brewery and Virtual Winery subnets</b><br>
<b>Figure A−2. The Virtual Brewery Network</b><br>
Appendix A. Example Network:The Virtual Brewery<br>
471<br>
<hr>
<A name=488></a><b>A.1. Connecting the Virtual Subsidiary Network</b><br>
The Virtual Brewery grows and opens a branch in another city. The subsidiary runs an Ethernet of its own<br>using the IP network number 172.16.3.0, which is subnet 3 of the Brewery's class B network. The host<br>vlager acts as the gateway for the Brewery network and will support the PPP link; its peer at the new branch<br>is called vbourbon and has an IP address of 172.16.3.1. This network is illustrated in&nbsp;<a href="TLNAGs.html#487">Figure A−2</a>.<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
A.1. Connecting the Virtual Subsidiary Network<br>
472<br>
<hr>
<A name=489></a><b>Appendix B. Useful Cable Configurations</b><br>
If you wish to connect two computers together and you don't have an Ethernet network, you will need either a<br>serial null modem cable, or a PLIP parallel cable.<br>
These cables can be bought off the shelf, but are much cheaper and fairly simple to make yourself.<br>
Appendix B. Useful Cable Configurations<br>
473<br>
<hr>
<A name=490></a><b>B.1. A PLIP Parallel Cable</b><br>
To make a parallel cable to use for PLIP, you will need two 25−pin connectors (called DB−25) and a cable<br>with at least eleven conductors. The cable must not be any longer than 15 meters (50 feet). The cable may or<br>may not have a shield, but if you are building a long cable, it is probably a good idea to have one.<br>
If you look at the connector, you should be able to read tiny numbers at the base of each pinfrom 1 for the<br>pin at the top left (if you hold the broader side up) to 25 for the pin at the bottom right. For the null printer<br><a href="TLNAGs.html#491">cable, you have to connect the following pins of both connectors with each other, as shown in&nbsp;Figure B−1.</a><br>
All remaining pins remain unconnected. If the cable is shielded, the shield should be connected to the<br>DB−25's metallic shell on just&nbsp;<i>one</i>&nbsp;end.<br>
B.1. A PLIP Parallel Cable<br>
474<br>
<hr>
<A name=491></a><IMG src="TLNAG-491_1.png"><br>
<IMG src="TLNAG-491_2.png"><br>
<b>B.2. A Serial NULL Modem Cable</b><br>
A serial null modem cable will work for both SLIP and PPP. Again, you will need two DB−25 connectors.<br>This time your cable requires only eight conductors.<br>
You may have seen other NULL modem cable designs, but this one allows you to use hardware flow<br>controlwhich is far superior to XON/XOFF flow controlor none at all. The conductor configuration is<br>shown in&nbsp;<a href="TLNAGs.html#491">Figure B−2</a>:<br>
Again, if you have a shield, you should connect it to the first pin at one end only.<br>
<b>Figure B−1. Parallel PLIP cable</b><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>
<b>Figure B−2. Serial NULL−Modem cable</b><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br>
B.2. A Serial NULL Modem Cable<br>
475<br>
<hr>
<A name=492></a><b>Appendix C. Linux Network Administrator's Guide,<br>Second Edition Copyright Information</b><br>
Copyright © 1993 Olaf Kirch Copyright © 2000 Terry Dawson Copyright on O'Reilly printed version ©<br>2000 O'Reilly &amp; Associates<br>
The online version of this book, which at this time of printing contains exactly the same text as the O'Reilly<br>printed version, is available under the GNU FDL. Rights to reprint the document under the FDL include the<br>right to print and distribute printed copies of the online version. Rights to copy the O'Reilly printed version<br>are reserved. You can find the online copy of the license at<br>http://www.oreilly.com/catalog/linag/licenseinfo.html. The book is available at<br>http://www.linuxdoc.org/LDP/nag/nag.html and http://www.oreilly.com/catalog/linag/, and may be reposted<br>by others at other locations.<br>
Permission is granted to copy, print, distribute, and modify the online document under the terms of the GNU<br>Free Documentation License, Version 1.1, or any later version published by the Free Software Foundation;<br>with the Invariant Sections being the Acknowledgments (in the&nbsp;<i>Preface</i><a href="TLNAGs.html#492">&nbsp;and&nbsp;Appendix C.&quot; Further<br></a>acknowledgments can be added outside the Invariant Section. The Front−Cover Text must read:<br>
<i>Linux Network Administrator's Guide<br></i>by Olaf Kirch and Terry Dawson<br>Copyright &nbsp;© 1993 Olaf Kirch<br>Copyright &nbsp;© 2000 Terry Dawson<br>Copyright on O'Reilly printed version © 2000 O'Reilly &amp; Associates<br>
The following is a copy of the GNU Free Documentation License, which is also at<br>http://www.gnu.org/copyleft/fdl.html.<br>
Version 1.1, March 2000<br>Copyright © 2000 &nbsp;Free Software Foundation, Inc.<br>59 Temple Place, Suite 330, Boston, MA &nbsp;02111−1307 &nbsp;USA<br>Everyone is permitted to copy and distribute verbatim copies<br>of this license document, but changing it is not allowed.<br>
Appendix C. Linux Network Administrator's Guide, Second Edition Copyright Information<br>
476<br>
<hr>
<A name=493></a><b>C.1. 0. Preamble</b><br>
The purpose of this License is to make a manual, textbook, or other written document &quot;free&quot; in the sense of<br>freedom: to assure everyone the effective freedom to copy and redistribute it, with or without modifying it,<br>either commercially or noncommercially. Secondarily, this License preserves for the author and publisher a<br>way to get credit for their work, while not being considered responsible for modifications made by others.<br>
This License is a kind of &quot;copyleft,&quot; which means that derivative works of the document must themselves be<br>free in the same sense. It complements the GNU General Public License, which is a copyleft license designed<br>for free software.<br>
We have designed this License in order to use it for manuals for free software, because free software needs<br>free documentation: a free program should come with manuals providing the same freedoms that the software<br>does. But this License is not limited to software manuals; it can be used for any textual work, regardless of<br>subject matter or whether it is published as a printed book. We recommend this License principally for works<br>whose purpose is instruction or reference.<br>
C.1. 0. Preamble<br>
477<br>
<hr>
<A name=494></a><b>C.2. 1. Applicability and Definitions</b><br>
This License applies to any manual or other work that contains a notice placed by the copyright holder saying<br>it can be distributed under the terms of this License. The &quot;Document,&quot; below, refers to any such manual or<br>work. Any member of the public is a licensee, and is addressed as &quot;you.&quot;<br>
A &quot;Modified Version&quot; of the Document means any work containing the Document or a portion of it, either<br>copied verbatim, or with modifications and/or translated into another language.<br>
A &quot;Secondary Section&quot; is a named appendix or a front−matter section of the Document that deals exclusively<br>with the relationship of the publishers or authors of the Document to the Document's overall subject (or to<br>related matters) and contains nothing that could fall directly within that overall subject. (For example, if the<br>Document is in part a textbook of mathematics, a Secondary Section may not explain any mathematics.) The<br>relationship could be a matter of historical connection with the subject or with related matters, or of legal,<br>commercial, philosophical, ethical or political position regarding them.<br>
The &quot;Invariant Sections&quot; are certain Secondary Sections whose titles are designated, as being those of<br>Invariant Sections, in the notice that says that the Document is released under this License.<br>
The &quot;Cover Texts&quot; are certain short passages of text that are listed, as Front−Cover Texts or Back−Cover<br>Texts, in the notice that says that the Document is released under this License.<br>
A &quot;Transparent&quot; copy of the Document means a machine−readable copy, represented in a format whose<br>specification is available to the general public, whose contents can be viewed and edited directly and<br>straightforwardly with generic text editors or (for images composed of pixels) generic paint programs or (for<br>drawings) some widely available drawing editor, and that is suitable for input to text formatters or for<br>automatic translation to a variety of formats suitable for input to text formatters. A copy made in an otherwise<br>Transparent file format whose markup has been designed to thwart or discourage subsequent modification by<br>readers is not Transparent. A copy that is not &quot;Transparent&quot; is called &quot;Opaque.&quot;<br>
Examples of suitable formats for Transparent copies include plain ASCII without markup, Texinfo input<br>format, LaTeX input format, SGML or XML using a publicly available DTD, and standard−conforming<br>simple HTML designed for human modification. Opaque formats include PostScript, PDF, proprietary<br>formats that can be read and edited only by proprietary word processors, SGML or XML for which the DTD<br>and/or processing tools are not generally available, and the machine−generated HTML produced by some<br>word processors for output purposes only.<br>
The &quot;Title Page&quot; means, for a printed book, the title page itself, plus such following pages as are needed to<br>hold, legibly, the material this License requires to appear in the title page. For works in formats that do not<br>have any title page as such, &quot;Title Page&quot; means the text near the most prominent appearance of the work's<br>title, preceding the beginning of the body of the text.<br>
C.2. 1. Applicability and Definitions<br>
478<br>
<hr>
<A name=495></a><b>C.3. 2. Verbatim Copying</b><br>
You may copy and distribute the Document in any medium, either commercially or noncommercially,<br>provided that this License, the copyright notices, and the license notice saying this License applies to the<br>Document are reproduced in all copies, and that you add no other conditions whatsoever to those of this<br>License. You may not use technical measures to obstruct or control the reading or further copying of the<br>copies you make or distribute. However, you may accept compensation in exchange for copies. If you<br>distribute a large enough number of copies you must also follow the conditions in section 3.<br>
You may also lend copies, under the same conditions stated above, and you may publicly display copies.<br>
C.3. 2. Verbatim Copying<br>
479<br>
<hr>
<A name=496></a><b>C.4. 3. Copying in Quantity</b><br>
If you publish printed copies of the Document numbering more than 100, and the Document's license notice<br>requires Cover Texts, you must enclose the copies in covers that carry, clearly and legibly, all these Cover<br>Texts: Front−Cover Texts on the front cover, and Back−Cover Texts on the back cover. Both covers must<br>also clearly and legibly identify you as the publisher of these copies. The front cover must present the full<br>title with all words of the title equally prominent and visible. You may add other material on the covers in<br>addition. Copying with changes limited to the covers, as long as they preserve the title of the Document and<br>satisfy these conditions, can be treated as verbatim copying in other respects.<br>
If the required texts for either cover are too voluminous to fit legibly, you should put the first ones listed (as<br>many as fit reasonably) on the actual cover, and continue the rest onto adjacent pages.<br>
If you publish or distribute Opaque copies of the Document numbering more than 100, you must either<br>include a machine−readable Transparent copy along with each Opaque copy, or state in or with each Opaque<br>copy a publicly−accessible computer−network location containing a complete Transparent copy of the<br>Document, free of added material, which the general network−using public has access to download<br>anonymously at no charge using public−standard network protocols. If you use the latter option, you must<br>take reasonably prudent steps, when you begin distribution of Opaque copies in quantity, to ensure that this<br>Transparent copy will remain thus accessible at the stated location until at least one year after the last time<br>you distribute an Opaque copy (directly or through your agents or retailers) of that edition to the public.<br>
It is requested, but not required, that you contact the authors of the Document well before redistributing any<br>large number of copies, to give them a chance to provide you with an updated version of the Document.<br>
C.4. 3. Copying in Quantity<br>
480<br>
<hr>
<A name=497></a><b>C.5. 4. Modifications</b><br>
You may copy and distribute a Modified Version of the Document under the conditions of sections 2 and 3<br>above, provided that you release the Modified Version under precisely this License, with the Modified<br>Version filling the role of the Document, thus licensing distribution and modification of the Modified Version<br>to whoever possesses a copy of it. In addition, you must do these things in the Modified Version:<br>
Use in the Title Page (and on the covers, if any) a title distinct from that of the Document, and from<br>
A.&nbsp;<br>
those of previous versions (which should, if there were any, be listed in the History section of the<br>Document). You may use the same title as a previous version if the original publisher of that version<br>gives permission.<br>List on the Title Page, as authors, one or more persons or entities responsible for authorship of the<br>
B.&nbsp;<br>
modifications in the Modified Version, together with at least five of the principal authors of the<br>Document (all of its principal authors, if it has less than five).<br>State on the Title page the name of the publisher of the Modified Version, as the publisher.<br>
C.&nbsp;<br>
Preserve all the copyright notices of the Document.<br>
D.&nbsp;<br>
Add an appropriate copyright notice for your modifications adjacent to the other copyright notices.<br>
E.&nbsp;<br>
Include, immediately after the copyright notices, a license notice giving the public permission to use<br>
F.&nbsp;<br>
the Modified Version under the terms of this License, in the form shown in the Addendum below.<br>Preserve in that license notice the full lists of Invariant Sections and required Cover Texts given in<br>
G.&nbsp;<br>
the Document's license notice.<br>Include an unaltered copy of this License.<br>
H.&nbsp;<br>
I.&nbsp;Preserve the section entitled &quot;History,&quot; and its title, and add to it an item stating at least the title, year,<br>
new authors, and publisher of the Modified Version as given on the Title Page. If there is no section<br>entitled &quot;History&quot; in the Document, create one stating the title, year, authors, and publisher of the<br>Document as given on its Title Page, then add an item describing the Modified Version as stated in<br>the previous sentence.<br>
J.&nbsp;Preserve the network location, if any, given in the Document for public access to a Transparent copy<br>
of the Document, and likewise the network locations given in the Document for previous versions it<br>was based on. These may be placed in the &quot;History&quot; section. You may omit a network location for a<br>work that was published at least four years before the Document itself, or if the original publisher of<br>the version it refers to gives permission.<br>In any section entitled &quot;Acknowledgements&quot; or &quot;Dedications,&quot; preserve the section's title, and<br>
K.&nbsp;<br>
preserve in the section all the substance and tone of each of the contributor acknowledgements and/or<br>dedications given therein.<br>Preserve all the Invariant Sections of the Document, unaltered in their text and in their titles. Section<br>
L.&nbsp;<br>
numbers or the equivalent are not considered part of the section titles.<br>
M.&nbsp;Delete any section entitled &quot;Endorsements.&quot; Such a section may not be included in the Modified<br>
Version.<br>Do not retitle any existing section as &quot;Endorsements&quot; or to conflict in title with any Invariant Section.<br>
N.&nbsp;<br>
If the Modified Version includes new front−matter sections or appendices that qualify as Secondary Sections<br>and contain no material copied from the Document, you may at your option designate some or all of these<br>sections as invariant. To do this, add their titles to the list of Invariant Sections in the Modified Version's<br>license notice. These titles must be distinct from any other section titles.<br>
You may add a section entitled &quot;Endorsements,&quot; provided it contains nothing but endorsements of your<br>Modified Version by various partiesfor example, statements of peer review or that the text has been<br>approved by an organization as the authoritative definition of a standard.<br>
C.5. 4. Modifications<br>
481<br>
<hr>
<A name=498></a>Linux Network Administrators Guide<br>
You may add a passage of up to five words as a Front−Cover Text, and a passage of up to 25 words as a<br>Back−Cover Text, to the end of the list of Cover Texts in the Modified Version. Only one passage of<br>Front−Cover Text and one of Back−Cover Text may be added by (or through arrangements made by) any one<br>entity. If the Document already includes a cover text for the same cover, previously added by you or by<br>arrangement made by the same entity you are acting on behalf of, you may not add another; but you may<br>replace the old one, on explicit permission from the previous publisher that added the old one.<br>
The author(s) and publisher(s) of the Document do not by this License give permission to use their names for<br>publicity for or to assert or imply endorsement of any Modified Version.<br>
C.5. 4. Modifications<br>
482<br>
<hr>
<A name=499></a><b>C.6. 5. Combining Documents</b><br>
You may combine the Document with other documents released under this License, under the terms defined<br>in section 4 above for modified versions, provided that you include in the combination all of the Invariant<br>Sections of all of the original documents, unmodified, and list them all as Invariant Sections of your<br>combined work in its license notice.<br>
The combined work need only contain one copy of this License, and multiple identical Invariant Sections<br>may be replaced with a single copy. If there are multiple Invariant Sections with the same name but different<br>contents, make the title of each such section unique by adding at the end of it, in parentheses, the name of the<br>original author or publisher of that section if known, or else a unique number. Make the same adjustment to<br>the section titles in the list of Invariant Sections in the license notice of the combined work.<br>
In the combination, you must combine any sections entitled &quot;History&quot; in the various original documents,<br>forming one section entitled &quot;History&quot;; likewise combine any sections entitled &quot;Acknowledgements,&quot; and any<br>sections entitled &quot;Dedications.&quot; You must delete all sections entitled &quot;Endorsements.&quot;<br>
C.6. 5. Combining Documents<br>
483<br>
<hr>
<A name=500></a><b>C.7. 6. Collections of Documents</b><br>
You may make a collection consisting of the Document and other documents released under this License, and<br>replace the individual copies of this License in the various documents with a single copy that is included in<br>the collection, provided that you follow the rules of this License for verbatim copying of each of the<br>documents in all other respects.<br>
You may extract a single document from such a collection, and distribute it individually under this License,<br>provided you insert a copy of this License into the extracted document, and follow this License in all other<br>respects regarding verbatim copying of that document.<br>
C.7. 6. Collections of Documents<br>
484<br>
<hr>
<A name=501></a><b>C.8. 7. Aggregation with Independent Works</b><br>
A compilation of the Document or its derivatives with other separate and independent documents or works, in<br>or on a volume of a storage or distribution medium, does not as a whole count as a Modified Version of the<br>Document, provided no compilation copyright is claimed for the compilation. Such a compilation is called an<br>&quot;aggregate,&quot; and this License does not apply to the other self−contained works thus compiled with the<br>Document, on account of their being thus compiled, if they are not themselves derivative works of the<br>Document.<br>
If the Cover Text requirement of section 3 is applicable to these copies of the Document, then if the<br>Document is less than one quarter of the entire aggregate, the Document's Cover Texts may be placed on<br>covers that surround only the Document within the aggregate. Otherwise they must appear on covers around<br>the whole aggregate.<br>
C.8. 7. Aggregation with Independent Works<br>
485<br>
<hr>
<A name=502></a><b>C.9. 8. Translation</b><br>
Translation is considered a kind of modification, so you may distribute translations of the Document under<br>the terms of section 4. Replacing Invariant Sections with translations requires special permission from their<br>copyright holders, but you may include translations of some or all Invariant Sections in addition to the<br>original versions of these Invariant Sections. You may include a translation of this License provided that you<br>also include the original English version of this License. In case of a disagreement between the translation<br>and the original English version of this License, the original English version will prevail.<br>
C.9. 8. Translation<br>
486<br>
<hr>
<A name=503></a><b>C.10. 9. Termination</b><br>
You may not copy, modify, sublicense, or distribute the Document except as expressly provided for under<br>this License. Any other attempt to copy, modify, sublicense or distribute the Document is void, and will<br>automatically terminate your rights under this License. However, parties who have received copies, or rights,<br>from you under this License will not have their licenses terminated so long as such parties remain in full<br>compliance.<br>
C.10. 9. Termination<br>
487<br>
<hr>
<A name=504></a><b>C.11. 10. Future Revisions of this License</b><br>
The Free Software Foundation may publish new, revised versions of the GNU Free Documentation License<br>from time to time. Such new versions will be similar in spirit to the present version, but may differ in detail to<br>address new problems or concerns. See http://www.gnu.org/copyleft/.<br>
Each version of the License is given a distinguishing version number. If the Document specifies that a<br>particular numbered version of this License &quot;or any later version&quot; applies to it, you have the option of<br>following the terms and conditions either of that specified version or of any later version that has been<br>published (not as a draft) by the Free Software Foundation. If the Document does not specify a version<br>number of this License, you may choose any version ever published (not as a draft) by the Free Software<br>Foundation.<br>
C.11. 10. Future Revisions of this License<br>
488<br>
<hr>
<A name=505></a><b>Appendix D. SAGE: The SystemAdministrators<br>Guild</b><br>
If you are not getting everything you need from posting to comp.os.linux.* groups and reading<br>documentation, maybe it's time to consider joining SAGE, the System Administrators Guild, sponsored by<br>USENIX. The main goal of SAGE is to advance system administration as a profession. SAGE brings together<br>system and network administrators to foster professional and technical development, share problems and<br>solutions, and communicate with users, management, and vendors on system administration topics.<br>
Current SAGE initiatives include:<br>
Co−sponsoring the highly successful annual System Administration Conferences (LISA) with<br>
•&nbsp;<br>
USENIX.<br>Publishing&nbsp;<br>
•&nbsp;<br>
<b>Job Descriptions for System Administrators</b>, edited by Tina Darmohray, the first in a<br>
series of very practical booklets and resource guides covering system administration issues and<br>techniques.<br>Creating an archive site, ftp.sage.usenix.org, for papers from the System Administration Conferences<br>
•&nbsp;<br>
and sysadmin−related documentation.<br>Establishing working groups in areas important to system administrators, such as jobs, publications,<br>
•&nbsp;<br>
policies, electronic information distribution, education, vendors, and standards.<br>
To learn more about the USENIX Association and its Special Technical Group, SAGE, contact the USENIX<br>Association office at (510) 528−8649 in the U.S., or by email to office@usenix.org. To receive information<br>electronically, contact info@usenix.org. Annual SAGE membership is $25 (you must also be a member of<br>USENIX). Members enjoy free subscriptions to&nbsp;<i>login:</i>&nbsp;and&nbsp;<b>Computing Systems</b>, a quarterly refereed<br>technical journal; discounts on conference and symposia registration; and savings on SAGE publication<br>purchases and other services.<br>
Appendix D. SAGE: The SystemAdministrators Guild<br>
489<br>
<hr>
<A name="outline"></a><h1>Document Outline</h1>
<ul><li><A href="TLNAGs.html#2">Table of Contents</A>
<li><A href="TLNAGs.html#17">1. Purpose and Audience for This Book</A>
<li><A href="TLNAGs.html#18">2. Sources of Information</A>
<ul><li><A href="TLNAGs.html#19">2.1. Documentation Available via FTP</A>
<li><A href="TLNAGs.html#19">2.2. Documentation Available via WWW</A>
<li><A href="TLNAGs.html#19">2.3. Documentation Available Commercially</A>
<li><A href="TLNAGs.html#20">2.4. Linux Journal and Linux Magazine</A>
<li><A href="TLNAGs.html#20">2.5. Linux Usenet Newsgroups</A>
<li><A href="TLNAGs.html#21">2.6. Linux Mailing Lists</A>
<li><A href="TLNAGs.html#22">2.7. Online Linux Support</A>
<li><A href="TLNAGs.html#22">2.8. Linux User Groups</A>
<li><A href="TLNAGs.html#23">2.9. Obtaining Linux</A>
</ul><li><A href="TLNAGs.html#25">3. File System Standards</A>
<li><A href="TLNAGs.html#26">4. Standard Linux Base</A>
<li><A href="TLNAGs.html#27">5. About This Book</A>
<li><A href="TLNAGs.html#29">6. The Official Printed Version</A>
<li><A href="TLNAGs.html#31">7. Overview</A>
<li><A href="TLNAGs.html#33">8. Conventions Used in This Book</A>
<li><A href="TLNAGs.html#34">9. Submitting Changes</A>
<li><A href="TLNAGs.html#35">10. Acknowledgments</A>
<ul><li><A href="TLNAGs.html#35">10.1. The Hall of Fame</A>
</ul><li><A href="TLNAGs.html#37">Chapter 1. Introduction to Networking</A>
<li><A href="TLNAGs.html#38">1.1. History</A>
<li><A href="TLNAGs.html#39">1.2. TCP/IP Networks</A>
<ul><li><A href="TLNAGs.html#39">1.2.1. Introduction to TCP/IP Networks</A>
<li><A href="TLNAGs.html#40">1.2.2. Ethernets</A>
<li><A href="TLNAGs.html#41">1.2.3. Other Types of Hardware</A>
<li><A href="TLNAGs.html#43">1.2.4. The Internet Protocol</A>
<li><A href="TLNAGs.html#44">1.2.5. IP Over Serial Lines</A>
<li><A href="TLNAGs.html#44">1.2.6. The Transmission Control Protocol</A>
<li><A href="TLNAGs.html#45">1.2.7. The User Datagram Protocol</A>
<li><A href="TLNAGs.html#45">1.2.8. More on Ports</A>
<li><A href="TLNAGs.html#46">1.2.9. The Socket Library</A>
</ul><li><A href="TLNAGs.html#47">1.3. UUCP Networks</A>
<li><A href="TLNAGs.html#48">1.4. Linux Networking</A>
<ul><li><A href="TLNAGs.html#48">1.4.1. Different Streaks of Development</A>
<li><A href="TLNAGs.html#49">1.4.2. Where to Get the Code</A>
</ul><li><A href="TLNAGs.html#50">1.5. Maintaining Your System</A>
<ul><li><A href="TLNAGs.html#50">1.5.1. System Security</A>
</ul><li><A href="TLNAGs.html#52">Chapter 2. Issues of TCP/IP Networking</A>
<li><A href="TLNAGs.html#53">2.1. Networking Interfaces</A>
<li><A href="TLNAGs.html#54">2.2. IP Addresses</A>
<li><A href="TLNAGs.html#56">2.3. Address Resolution</A>
<li><A href="TLNAGs.html#57">2.4. IP Routing</A>
<ul><li><A href="TLNAGs.html#57">2.4.1. IP Networks</A>
<li><A href="TLNAGs.html#57">2.4.2. Subnetworks</A>
<li><A href="TLNAGs.html#58">2.4.3. Gateways</A>
<li><A href="TLNAGs.html#59">2.4.4. The Routing Table</A>
<li><A href="TLNAGs.html#61">2.4.5. Metric Values</A>
</ul><li><A href="TLNAGs.html#62">2.5. The Internet Control Message Protocol</A>
<li><A href="TLNAGs.html#63">2.6. Resolving Host Names</A>
<li><A href="TLNAGs.html#64">Chapter 3. Configuringthe NetworkingHardware</A>
<li><A href="TLNAGs.html#67">3.1. Kernel Configuration</A>
<ul><li><A href="TLNAGs.html#67">3.1.1. Kernel Options in Linux 2.0 and Higher</A>
<li><A href="TLNAGs.html#69">3.1.2. Kernel Networking Options in Linux 2.0.0 and Higher</A>
</ul><li><A href="TLNAGs.html#73">3.2. A Tour of Linux Network Devices</A>
<li><A href="TLNAGs.html#75">3.3. Ethernet Installation</A>
<ul><li><A href="TLNAGs.html#75">3.3.1. Ethernet Autoprobing</A>
</ul><li><A href="TLNAGs.html#78">3.4. The PLIP Driver</A>
<li><A href="TLNAGs.html#80">3.5. The PPP and SLIP Drivers</A>
<li><A href="TLNAGs.html#81">3.6. Other Network Types</A>
<li><A href="TLNAGs.html#82">Chapter 4. Configuring the Serial Hardware</A>
<li><A href="TLNAGs.html#83">4.1. Communications Software for Modem Links</A>
<li><A href="TLNAGs.html#84">4.2. Introduction to Serial Devices</A>
<li><A href="TLNAGs.html#85">4.3. Accessing Serial Devices</A>
<ul><li><A href="TLNAGs.html#86">4.3.1. The Serial Device Special Files</A>
</ul><li><A href="TLNAGs.html#88">4.4. Serial Hardware</A>
<li><A href="TLNAGs.html#89">4.5. Using the Configuration Utilities</A>
<ul><li><A href="TLNAGs.html#89">4.5.1. The setserial Command</A>
<li><A href="TLNAGs.html#91">4.5.2. The stty Command</A>
</ul><li><A href="TLNAGs.html#94">4.6. Serial Devices and the login: Prompt</A>
<ul><li><A href="TLNAGs.html#94">4.6.1. Configuring the mgetty Daemon</A>
</ul><li><A href="TLNAGs.html#97">Chapter 5. Configuring TCP/IP Networking</A>
<li><A href="TLNAGs.html#98">5.1. Mounting the /proc Filesystem</A>
<li><A href="TLNAGs.html#99">5.2. Installing the Binaries</A>
<li><A href="TLNAGs.html#100">5.3. Setting the Hostname</A>
<li><A href="TLNAGs.html#101">5.4. Assigning IP Addresses</A>
<li><A href="TLNAGs.html#102">5.5. Creating Subnets</A>
<li><A href="TLNAGs.html#103">5.6. Writing hosts and networks Files</A>
<li><A href="TLNAGs.html#105">5.7. Interface Configuration for IP</A>
<ul><li><A href="TLNAGs.html#105">5.7.1. The Loopback Interface</A>
<li><A href="TLNAGs.html#107">5.7.2. Ethernet Interfaces</A>
<li><A href="TLNAGs.html#108">5.7.3. Routing Through a Gateway</A>
<li><A href="TLNAGs.html#109">5.7.4. Configuring a Gateway</A>
<li><A href="TLNAGs.html#109">5.7.5. The PLIP Interface</A>
<li><A href="TLNAGs.html#110">5.7.6. The SLIP and PPP Interfaces</A>
<li><A href="TLNAGs.html#110">5.7.7. The Dummy Interface</A>
<li><A href="TLNAGs.html#111">5.7.8. IP Alias</A>
</ul><li><A href="TLNAGs.html#112">5.8. All About ifconfig</A>
<li><A href="TLNAGs.html#115">5.9. The netstat Command</A>
<ul><li><A href="TLNAGs.html#115">5.9.1. Displaying the Routing Table</A>
<li><A href="TLNAGs.html#116">5.9.2. Displaying Interface Statistics</A>
<li><A href="TLNAGs.html#117">5.9.3. Displaying Connections</A>
</ul><li><A href="TLNAGs.html#118">5.10. Checking the ARP Tables</A>
<li><A href="TLNAGs.html#120">Chapter 6. Name Service and Resolver Configuration</A>
<li><A href="TLNAGs.html#121">6.1. The Resolver Library</A>
<ul><li><A href="TLNAGs.html#121">6.1.1. The host.conf File</A>
<ul><li><A href="TLNAGs.html#122">6.1.1.1. Resolver environment variables</A>
</ul><li><A href="TLNAGs.html#123">6.1.2. The nsswitch.conf File</A>
<li><A href="TLNAGs.html#125">6.1.3. Configuring Name Server Lookups Using resolv.conf</A>
<li><A href="TLNAGs.html#127">6.1.4. Resolver Robustness</A>
</ul><li><A href="TLNAGs.html#128">6.2. How DNS Works</A>
<ul><li><A href="TLNAGs.html#129">6.2.1. Name Lookups with DNS</A>
<li><A href="TLNAGs.html#130">6.2.2. Types of Name Servers</A>
<li><A href="TLNAGs.html#131">6.2.3. The DNS Database</A>
<li><A href="TLNAGs.html#132">6.2.4. Reverse Lookups</A>
</ul><li><A href="TLNAGs.html#134">6.3. Running named</A>
<ul><li><A href="TLNAGs.html#134">6.3.1. The named.boot File</A>
<li><A href="TLNAGs.html#136">6.3.2. The BIND 8 host.conf File</A>
<li><A href="TLNAGs.html#137">6.3.3. The DNS Database Files</A>
<li><A href="TLNAGs.html#141">6.3.4. Caching-only named Configuration</A>
<li><A href="TLNAGs.html#142">6.3.5. Writing the Master Files</A>
<li><A href="TLNAGs.html#144">6.3.6. Verifying the Name Server Setup</A>
<li><A href="TLNAGs.html#146">6.3.7. Other Useful Tools</A>
</ul><li><A href="TLNAGs.html#148">Chapter 7. Serial Line IP</A>
<li><A href="TLNAGs.html#149">7.1. General Requirements</A>
<li><A href="TLNAGs.html#150">7.2. SLIP Operation</A>
<li><A href="TLNAGs.html#153">7.3. Dealing with Private IP Networks</A>
<li><A href="TLNAGs.html#154">7.4. Using dip</A>
<ul><li><A href="TLNAGs.html#154">7.4.1. A Sample Script</A>
<li><A href="TLNAGs.html#156">7.4.2. A dip Reference</A>
<ul><li><A href="TLNAGs.html#156">7.4.2.1. The modem commands</A>
<li><A href="TLNAGs.html#157">7.4.2.2. The echo command</A>
<li><A href="TLNAGs.html#157">7.4.2.3. The get command</A>
<li><A href="TLNAGs.html#157">7.4.2.4. The print command</A>
<li><A href="TLNAGs.html#157">7.4.2.5. Variable names</A>
<li><A href="TLNAGs.html#158">7.4.2.6. The if and goto commands</A>
<li><A href="TLNAGs.html#158">7.4.2.7. send, wait, and sleep</A>
<li><A href="TLNAGs.html#158">7.4.2.8. mode and default</A>
</ul></ul><li><A href="TLNAGs.html#160">7.5. Running in Server Mode</A>
<li><A href="TLNAGs.html#162">Chapter 8. The Point-to-Point Protocol</A>
<li><A href="TLNAGs.html#163">8.1. PPP on Linux</A>
<li><A href="TLNAGs.html#164">8.2. Running pppd</A>
<li><A href="TLNAGs.html#165">8.3. Using Options Files</A>
<li><A href="TLNAGs.html#166">8.4. Using chat to Automate Dialing</A>
<li><A href="TLNAGs.html#168">8.5. IP Configuration Options</A>
<ul><li><A href="TLNAGs.html#168">8.5.1. Choosing IP Addresses</A>
<li><A href="TLNAGs.html#169">8.5.2. Routing Through a PPP Link</A>
</ul><li><A href="TLNAGs.html#171">8.6. Link Control Options</A>
<li><A href="TLNAGs.html#173">8.7. General Security Considerations</A>
<li><A href="TLNAGs.html#174">8.8. Authentication with PPP</A>
<ul><li><A href="TLNAGs.html#174">8.8.1. PAP Versus CHAP</A>
<li><A href="TLNAGs.html#175">8.8.2. The CHAP Secrets File</A>
<li><A href="TLNAGs.html#176">8.8.3. The PAP Secrets File</A>
</ul><li><A href="TLNAGs.html#178">8.9. Debugging Your PPP Setup</A>
<li><A href="TLNAGs.html#179">8.10. More Advanced PPP Configurations</A>
<ul><li><A href="TLNAGs.html#179">8.10.1. PPP Server</A>
<li><A href="TLNAGs.html#180">8.10.2. Demand Dialing</A>
<li><A href="TLNAGs.html#181">8.10.3. Persistent Dialing</A>
</ul><li><A href="TLNAGs.html#183">Chapter 9. TCP/IP Firewall</A>
<li><A href="TLNAGs.html#184">9.1. Methods of Attack</A>
<li><A href="TLNAGs.html#186">9.2. What Is a Firewall?</A>
<li><A href="TLNAGs.html#187">9.3. What Is IP Filtering?</A>
<li><A href="TLNAGs.html#188">9.4. Setting Up Linux for Firewalling</A>
<ul><li><A href="TLNAGs.html#188">9.4.1. Kernel Configured with IP Firewall</A>
<li><A href="TLNAGs.html#189">9.4.2. The ipfwadm Utility</A>
<li><A href="TLNAGs.html#189">9.4.3. The ipchains Utility</A>
<li><A href="TLNAGs.html#189">9.4.4. The iptables Utility</A>
</ul><li><A href="TLNAGs.html#190">9.5. Three Ways We Can Do Filtering</A>
<li><A href="TLNAGs.html#191">9.6. Original IP Firewall (2.0 Kernels)</A>
<ul><li><A href="TLNAGs.html#191">9.6.1. Using ipfwadm</A>
<ul><li><A href="TLNAGs.html#191">9.6.1.1. A nave example</A>
<li><A href="TLNAGs.html#193">9.6.1.2. An important refinement</A>
<li><A href="TLNAGs.html#193">9.6.1.3. Listing our rules</A>
</ul><li><A href="TLNAGs.html#194">9.6.2. A More Complex Example</A>
<li><A href="TLNAGs.html#195">9.6.3. Summary of ipfwadm Arguments</A>
<ul><li><A href="TLNAGs.html#195">9.6.3.1. Categories</A>
<li><A href="TLNAGs.html#195">9.6.3.2. Commands</A>
<li><A href="TLNAGs.html#196">9.6.3.3. Parameters</A>
<li><A href="TLNAGs.html#197">9.6.3.4. Optional arguments</A>
<li><A href="TLNAGs.html#198">9.6.3.5. ICMP datagram types</A>
</ul></ul><li><A href="TLNAGs.html#199">9.7. IP Firewall Chains (2.2 Kernels)</A>
<ul><li><A href="TLNAGs.html#199">9.7.1. Using ipchains</A>
<li><A href="TLNAGs.html#199">9.7.2. ipchains Command Syntax</A>
<ul><li><A href="TLNAGs.html#200">9.7.2.1. Commands</A>
<li><A href="TLNAGs.html#201">9.7.2.2. Rule specification parameters</A>
<li><A href="TLNAGs.html#202">9.7.2.3. Options</A>
</ul><li><A href="TLNAGs.html#203">9.7.3. Our Nave Example Revisited</A>
<li><A href="TLNAGs.html#204">9.7.4. Listing Our Rules with ipchains</A>
<li><A href="TLNAGs.html#204">9.7.5. Making Good Use of Chains</A>
<ul><li><A href="TLNAGs.html#205">9.7.5.1. User-defined chains</A>
<li><A href="TLNAGs.html#208">9.7.5.2. The ipchains support scripts</A>
</ul></ul><li><A href="TLNAGs.html#210">9.8. Netfilter and IP Tables (2.4 Kernels)</A>
<ul><li><A href="TLNAGs.html#212">9.8.1. Backward Compatability with ipfwadmand ipchains</A>
<li><A href="TLNAGs.html#212">9.8.2. Using iptables</A>
<ul><li><A href="TLNAGs.html#212">9.8.2.1. Commands</A>
<li><A href="TLNAGs.html#214">9.8.2.2. Rule specification parameters</A>
<li><A href="TLNAGs.html#215">9.8.2.3. Options</A>
<li><A href="TLNAGs.html#215">9.8.2.4. Extensions</A>
</ul><li><A href="TLNAGs.html#217">9.8.3. Our Nave Example Revisited, Yet Again</A>
</ul><li><A href="TLNAGs.html#218">9.9. TOS Bit Manipulation</A>
<ul><li><A href="TLNAGs.html#218">9.9.1. Setting the TOS Bits Using ipfwadm or ipchains</A>
<li><A href="TLNAGs.html#219">9.9.2. Setting the TOS Bits Using iptables</A>
</ul><li><A href="TLNAGs.html#221">9.10. Testing a Firewall Configuration</A>
<li><A href="TLNAGs.html#223">9.11. A Sample Firewall Configuration</A>
<li><A href="TLNAGs.html#230">Chapter 10. IP Accounting</A>
<li><A href="TLNAGs.html#231">10.1. Configuring the Kernel for IP Accounting</A>
<li><A href="TLNAGs.html#232">10.2. Configuring IP Accounting</A>
<ul><li><A href="TLNAGs.html#232">10.2.1. Accounting by Address</A>
<li><A href="TLNAGs.html#234">10.2.2. Accounting by Service Port</A>
<li><A href="TLNAGs.html#236">10.2.3. Accounting of ICMP Datagrams</A>
<li><A href="TLNAGs.html#237">10.2.4. Accounting by Protocol</A>
</ul><li><A href="TLNAGs.html#238">10.3. Using IP Accounting Results</A>
<ul><li><A href="TLNAGs.html#238">10.3.1. Listing Accounting Data with ipfwadm</A>
<li><A href="TLNAGs.html#239">10.3.2. Listing Accounting Data with ipchains</A>
<li><A href="TLNAGs.html#239">10.3.3. Listing Accounting Data with iptables</A>
</ul><li><A href="TLNAGs.html#240">10.4. Resetting the Counters</A>
<li><A href="TLNAGs.html#241">10.5. Flushing the Ruleset</A>
<li><A href="TLNAGs.html#242">10.6. Passive Collection of Accounting Data</A>
<li><A href="TLNAGs.html#243">Chapter 11. IP Masquerade and Network Address Translation</A>
<li><A href="TLNAGs.html#245">11.1. Side Effects and Fringe Benefits</A>
<li><A href="TLNAGs.html#246">11.2. Configuring the Kernel for IP Masquerade</A>
<li><A href="TLNAGs.html#248">11.3. Configuring IP Masquerade</A>
<ul><li><A href="TLNAGs.html#249">11.3.1. Setting Timing Parameters for IP Masquerade</A>
</ul><li><A href="TLNAGs.html#251">11.4. Handling Name Server Lookups</A>
<li><A href="TLNAGs.html#252">11.5. More About Network Address Translation</A>
<li><A href="TLNAGs.html#253">Chapter 12. ImportantNetwork Features</A>
<li><A href="TLNAGs.html#254">12.1. The inetd Super Server</A>
<li><A href="TLNAGs.html#257">12.2. The tcpd Access Control Facility</A>
<li><A href="TLNAGs.html#259">12.3. The Services and Protocols Files</A>
<li><A href="TLNAGs.html#261">12.4. Remote Procedure Call</A>
<li><A href="TLNAGs.html#263">12.5. Configuring Remote Loginand Execution</A>
<ul><li><A href="TLNAGs.html#263">12.5.1. Disabling the r; Commands</A>
<li><A href="TLNAGs.html#263">12.5.2. Installing and Configuring ssh</A>
<ul><li><A href="TLNAGs.html#264">12.5.2.1. The ssh daemon</A>
<li><A href="TLNAGs.html#265">12.5.2.2. The ssh client</A>
<li><A href="TLNAGs.html#267">12.5.2.3. Using ssh</A>
</ul></ul><li><A href="TLNAGs.html#270">Chapter 13. The Network Information System</A>
<li><A href="TLNAGs.html#272">13.1. Getting Acquainted with NIS</A>
<li><A href="TLNAGs.html#275">13.2. NIS Versus NIS+</A>
<li><A href="TLNAGs.html#276">13.3. The Client Side of NIS</A>
<li><A href="TLNAGs.html#277">13.4. Running an NIS Server</A>
<li><A href="TLNAGs.html#278">13.5. NIS Server Security</A>
<li><A href="TLNAGs.html#280">13.6. Setting Up an NIS Client with GNU libc</A>
<li><A href="TLNAGs.html#282">13.7. Choosing the Right Maps</A>
<li><A href="TLNAGs.html#284">13.8. Using the passwd and group Maps</A>
<li><A href="TLNAGs.html#286">13.9. Using NIS with Shadow Support</A>
<li><A href="TLNAGs.html#287">Chapter 14. The NetworkFile System</A>
<li><A href="TLNAGs.html#289">14.1. Preparing NFS</A>
<li><A href="TLNAGs.html#290">14.2. Mounting an NFS Volume</A>
<li><A href="TLNAGs.html#293">14.3. The NFS Daemons</A>
<li><A href="TLNAGs.html#294">14.4. The exports File</A>
<li><A href="TLNAGs.html#297">14.5. Kernel-Based NFSv2 Server Support</A>
<li><A href="TLNAGs.html#298">14.6. Kernel-Based NFSv3 Server Support</A>
<li><A href="TLNAGs.html#299">Chapter 15. IPX and the NCP Filesystem</A>
<li><A href="TLNAGs.html#300">15.1. Xerox, Novell, and History</A>
<li><A href="TLNAGs.html#301">15.2. IPX and Linux</A>
<ul><li><A href="TLNAGs.html#301">15.2.1. Caldera Support</A>
<li><A href="TLNAGs.html#301">15.2.2. More on NDS Support</A>
</ul><li><A href="TLNAGs.html#302">15.3. Configuring the Kernel for IPXand NCPFS</A>
<li><A href="TLNAGs.html#303">15.4. Configuring IPX Interfaces</A>
<ul><li><A href="TLNAGs.html#303">15.4.1. Network Devices Supporting IPX</A>
<li><A href="TLNAGs.html#303">15.4.2. IPX Interface Configuration Tools</A>
<li><A href="TLNAGs.html#303">15.4.3. The ipx_configure Command</A>
<li><A href="TLNAGs.html#304">15.4.4. The ipx_interface Command</A>
</ul><li><A href="TLNAGs.html#306">15.5. Configuring an IPX Router</A>
<ul><li><A href="TLNAGs.html#307">15.5.1. Static IPX Routing Using the ipx_route Command</A>
<li><A href="TLNAGs.html#307">15.5.2. Internal IPX Networks and Routing</A>
</ul><li><A href="TLNAGs.html#310">15.6. Mounting a Remote NetWare Volume</A>
<ul><li><A href="TLNAGs.html#310">15.6.1. A Simple ncpmount Example</A>
<li><A href="TLNAGs.html#310">15.6.2. The ncpmount Command in Detail</A>
<li><A href="TLNAGs.html#312">15.6.3. Hiding Your NetWare Login Password</A>
<li><A href="TLNAGs.html#312">15.6.4. A More Complex ncpmount Example</A>
</ul><li><A href="TLNAGs.html#314">15.7. Exploring Some of the Other IPX Tools</A>
<ul><li><A href="TLNAGs.html#314">15.7.1. Server List</A>
<li><A href="TLNAGs.html#314">15.7.2. Send Messages to NetWare Users</A>
<li><A href="TLNAGs.html#314">15.7.3. Browsing and Manipulating Bindery Data</A>
</ul><li><A href="TLNAGs.html#316">15.8. Printing to a NetWare Print Queue</A>
<ul><li><A href="TLNAGs.html#316">15.8.1. Using nprint with the Line Printer Daemon</A>
<li><A href="TLNAGs.html#318">15.8.2. Managing Print Queues</A>
</ul><li><A href="TLNAGs.html#319">15.9. NetWare Server Emulation</A>
<li><A href="TLNAGs.html#320">Chapter 16. ManagingTaylor UUCP</A>
<li><A href="TLNAGs.html#322">16.1. UUCP Transfers and Remote Execution</A>
<ul><li><A href="TLNAGs.html#322">16.1.1. The Inner Workings of uucico</A>
<li><A href="TLNAGs.html#323">16.1.2. uucico Command-line Options</A>
</ul><li><A href="TLNAGs.html#325">16.2. UUCP Configuration Files</A>
<ul><li><A href="TLNAGs.html#325">16.2.1. A Gentle Introduction to Taylor UUCP</A>
<li><A href="TLNAGs.html#327">16.2.2. What UUCP Needs to Know</A>
<li><A href="TLNAGs.html#328">16.2.3. Site Naming</A>
<li><A href="TLNAGs.html#328">16.2.4. Taylor Configuration Files</A>
<li><A href="TLNAGs.html#329">16.2.5. General Configuration Options Using the config File</A>
<li><A href="TLNAGs.html#329">16.2.6. How to Tell UUCP About Other Systems Using the sys File</A>
<ul><li><A href="TLNAGs.html#330">16.2.6.1. System name</A>
<li><A href="TLNAGs.html#330">16.2.6.2. Telephone number</A>
<li><A href="TLNAGs.html#330">16.2.6.3. port and speed</A>
<li><A href="TLNAGs.html#331">16.2.6.4. The login chat</A>
<li><A href="TLNAGs.html#332">16.2.6.5. Alternates</A>
<li><A href="TLNAGs.html#333">16.2.6.6. Restricting call times</A>
</ul><li><A href="TLNAGs.html#334">16.2.7. Identifying Available Devices Through the port File</A>
<li><A href="TLNAGs.html#335">16.2.8. How to Dial a Number Using the dial File</A>
<li><A href="TLNAGs.html#336">16.2.9. UUCP Over TCP</A>
<li><A href="TLNAGs.html#337">16.2.10. Using a Direct Connection</A>
</ul><li><A href="TLNAGs.html#338">16.3. Controlling Access to UUCP Features</A>
<ul><li><A href="TLNAGs.html#338">16.3.1. Command Execution</A>
<li><A href="TLNAGs.html#338">16.3.2. File Transfers</A>
<li><A href="TLNAGs.html#339">16.3.3. Forwarding</A>
</ul><li><A href="TLNAGs.html#340">16.4. Setting Up Your System for Dialing In</A>
<ul><li><A href="TLNAGs.html#340">16.4.1. Providing UUCP Accounts</A>
<li><A href="TLNAGs.html#341">16.4.2. Protecting Yourself Against Swindlers</A>
<li><A href="TLNAGs.html#341">16.4.3. Be Paranoid: Call Sequence Checks</A>
<li><A href="TLNAGs.html#342">16.4.4. Anonymous UUCP</A>
</ul><li><A href="TLNAGs.html#343">16.5. UUCP Low-Level Protocols</A>
<ul><li><A href="TLNAGs.html#343">16.5.1. Protocol Overview</A>
<li><A href="TLNAGs.html#344">16.5.2. Tuning the Transmission Protocol</A>
<li><A href="TLNAGs.html#345">16.5.3. Selecting Specific Protocols</A>
</ul><li><A href="TLNAGs.html#346">16.6. Troubleshooting</A>
<ul><li><A href="TLNAGs.html#346">16.6.1. uucico Keeps Saying Wrong Time to Call</A>
<li><A href="TLNAGs.html#346">16.6.2. uucico Complains That the Site Is Already Locked</A>
<li><A href="TLNAGs.html#346">16.6.3. You Can Connect to the Remote Site, but the Chat Script Fails</A>
<li><A href="TLNAGs.html#347">16.6.4. Your Modem Does Not Dial</A>
<li><A href="TLNAGs.html#347">16.6.5. Your Modem Tries to Dial but Doesn't Get Out</A>
<li><A href="TLNAGs.html#347">16.6.6. Login Succeeds, but the Handshake Fails</A>
</ul><li><A href="TLNAGs.html#348">16.7. Log Files and Debugging</A>
<li><A href="TLNAGs.html#349">Chapter 17. Electronic Mail</A>
<li><A href="TLNAGs.html#350">17.1. What Is a Mail Message?</A>
<li><A href="TLNAGs.html#353">17.2. How Is Mail Delivered?</A>
<li><A href="TLNAGs.html#354">17.3. Email Addresses</A>
<ul><li><A href="TLNAGs.html#354">17.3.1. RFC-822</A>
<li><A href="TLNAGs.html#354">17.3.2. Obsolete Mail Formats</A>
<li><A href="TLNAGs.html#354">17.3.3. Mixing Different Mail Formats</A>
</ul><li><A href="TLNAGs.html#356">17.4. How Does Mail Routing Work?</A>
<ul><li><A href="TLNAGs.html#356">17.4.1. Mail Routing on the Internet</A>
<li><A href="TLNAGs.html#356">17.4.2. Mail Routing in the UUCP World</A>
<li><A href="TLNAGs.html#357">17.4.3. Mixing UUCP and RFC-822</A>
</ul><li><A href="TLNAGs.html#361">17.5. Configuring elm</A>
<ul><li><A href="TLNAGs.html#361">17.5.1. Global elm Options</A>
<li><A href="TLNAGs.html#361">17.5.2. National Character Sets</A>
</ul><li><A href="TLNAGs.html#363">Chapter 18. Sendmail</A>
<li><A href="TLNAGs.html#364">18.1. Introduction to sendmail</A>
<li><A href="TLNAGs.html#365">18.2. Installing sendmail</A>
<li><A href="TLNAGs.html#366">18.3. Overview of Configuration Files</A>
<li><A href="TLNAGs.html#367">18.4. The sendmail.cf and sendmail.mc Files</A>
<ul><li><A href="TLNAGs.html#367">18.4.1. Two Example sendmail.mc Files</A>
<li><A href="TLNAGs.html#368">18.4.2. Typically Used sendmail.mc Parameters</A>
<ul><li><A href="TLNAGs.html#369">18.4.2.1. Comments</A>
<li><A href="TLNAGs.html#369">18.4.2.2. VERSIONID and OSTYPE</A>
<li><A href="TLNAGs.html#369">18.4.2.3. DOMAIN</A>
<li><A href="TLNAGs.html#370">18.4.2.4. FEATURE</A>
<li><A href="TLNAGs.html#370">18.4.2.5. Local macro definitions</A>
<li><A href="TLNAGs.html#370">18.4.2.6. Defining mail transport protocols</A>
<li><A href="TLNAGs.html#371">18.4.2.7. Configure mail routing for local hosts</A>
</ul></ul><li><A href="TLNAGs.html#373">18.5. Generating the sendmail.cf File</A>
<li><A href="TLNAGs.html#374">18.6. Interpreting and Writing Rewrite Rules</A>
<ul><li><A href="TLNAGs.html#374">18.6.1. sendmail.cf R and S Commands</A>
<li><A href="TLNAGs.html#374">18.6.2. Some Useful Macro Definitions</A>
<li><A href="TLNAGs.html#375">18.6.3. The Lefthand Side</A>
<li><A href="TLNAGs.html#375">18.6.4. The Righthand Side</A>
<li><A href="TLNAGs.html#377">18.6.5. A Simple Rule Pattern Example</A>
<li><A href="TLNAGs.html#377">18.6.6. Ruleset Semantics</A>
<ul><li><A href="TLNAGs.html#378">18.6.6.1. Interpreting the rule in our example</A>
</ul></ul><li><A href="TLNAGs.html#380">18.7. Configuring sendmail Options</A>
<li><A href="TLNAGs.html#382">18.8. Some Useful sendmail Configurations</A>
<ul><li><A href="TLNAGs.html#382">18.8.1. Trusting Users to Set the From: Field</A>
<li><A href="TLNAGs.html#382">18.8.2. Managing Mail Aliases</A>
<li><A href="TLNAGs.html#383">18.8.3. Using a Smart Host</A>
<li><A href="TLNAGs.html#384">18.8.4. Managing Unwanted or Unsolicited Mail (Spam)</A>
<ul><li><A href="TLNAGs.html#385">18.8.4.1. The Real-time Blackhole List</A>
<li><A href="TLNAGs.html#385">18.8.4.2. The access database</A>
<li><A href="TLNAGs.html#387">18.8.4.3. Barring users from receiving mail</A>
</ul><li><A href="TLNAGs.html#387">18.8.5. Configuring Virtual Email Hosting</A>
<ul><li><A href="TLNAGs.html#387">18.8.5.1. Accepting mail for other domains</A>
<li><A href="TLNAGs.html#388">18.8.5.2. Forwarding virtual-hosted mail to other destinations</A>
</ul></ul><li><A href="TLNAGs.html#390">18.9. Testing Your Configuration</A>
<li><A href="TLNAGs.html#394">18.10. Running sendmail</A>
<li><A href="TLNAGs.html#395">18.11. Tips and Tricks</A>
<ul><li><A href="TLNAGs.html#395">18.11.1. Managing the Mail Spool</A>
<li><A href="TLNAGs.html#395">18.11.2. Forcing a Remote Host to Process its Mail Queue</A>
<li><A href="TLNAGs.html#396">18.11.3. Analyzing Mail Statistics</A>
<ul><li><A href="TLNAGs.html#396">18.11.3.1. mailstats</A>
<li><A href="TLNAGs.html#397">18.11.3.2. hoststat</A>
</ul></ul><li><A href="TLNAGs.html#398">Chapter 19. Getting EximUp and Running</A>
<li><A href="TLNAGs.html#399">19.1. Running Exim</A>
<li><A href="TLNAGs.html#401">19.2. If Your Mail Doesn't Get Through</A>
<li><A href="TLNAGs.html#402">19.3. Compiling Exim</A>
<li><A href="TLNAGs.html#403">19.4. Mail Delivery Modes</A>
<li><A href="TLNAGs.html#405">19.5. Miscellaneous config Options</A>
<li><A href="TLNAGs.html#406">19.6. Message Routing and Delivery</A>
<ul><li><A href="TLNAGs.html#406">19.6.1. Routing Messages</A>
<li><A href="TLNAGs.html#406">19.6.2. Delivering Messages to Local Addresses</A>
<ul><li><A href="TLNAGs.html#407">19.6.2.1. Local users</A>
<li><A href="TLNAGs.html#407">19.6.2.2. Forwarding</A>
</ul><li><A href="TLNAGs.html#408">19.6.3. Alias Files</A>
<li><A href="TLNAGs.html#409">19.6.4. Mailing Lists</A>
</ul><li><A href="TLNAGs.html#410">19.7. Protecting Against Mail Spam</A>
<li><A href="TLNAGs.html#411">19.8. UUCP Setup</A>
<li><A href="TLNAGs.html#412">Chapter 20. Netnews</A>
<li><A href="TLNAGs.html#413">20.1. Usenet History</A>
<li><A href="TLNAGs.html#414">20.2. What Is Usenet, Anyway?</A>
<li><A href="TLNAGs.html#416">20.3. How Does Usenet Handle News?</A>
<li><A href="TLNAGs.html#418">Chapter 21. C News</A>
<li><A href="TLNAGs.html#419">21.1. Delivering News</A>
<li><A href="TLNAGs.html#421">21.2. Installation</A>
<li><A href="TLNAGs.html#423">21.3. The sys File</A>
<li><A href="TLNAGs.html#426">21.4. The active File</A>
<li><A href="TLNAGs.html#428">21.5. Article Batching</A>
<li><A href="TLNAGs.html#431">21.6. Expiring News</A>
<li><A href="TLNAGs.html#433">21.7. Miscellaneous Files</A>
<li><A href="TLNAGs.html#435">21.8. Control Messages</A>
<ul><li><A href="TLNAGs.html#435">21.8.1. The cancel Message</A>
<li><A href="TLNAGs.html#435">21.8.2. newgroup and rmgroup</A>
<li><A href="TLNAGs.html#435">21.8.3. The checkgroups Message</A>
<li><A href="TLNAGs.html#437">21.8.4. sendsys, version, and senduuname</A>
</ul><li><A href="TLNAGs.html#438">21.9. C News in an NFS Environment</A>
<li><A href="TLNAGs.html#439">21.10. Maintenance Tools and Tasks</A>
<li><A href="TLNAGs.html#441">Chapter 22. NNTP and thenntpd Daemon</A>
<li><A href="TLNAGs.html#443">22.1. The NNTP Protocol</A>
<ul><li><A href="TLNAGs.html#443">22.1.1. Connecting to the News Server</A>
<li><A href="TLNAGs.html#443">22.1.2. Pushing a News Article onto a Server</A>
<li><A href="TLNAGs.html#444">22.1.3. Changing to NNRP Reader Mode</A>
<li><A href="TLNAGs.html#445">22.1.4. Listing Available Groups</A>
<li><A href="TLNAGs.html#445">22.1.5. Listing Active Groups</A>
<li><A href="TLNAGs.html#446">22.1.6. Posting an Article</A>
<li><A href="TLNAGs.html#446">22.1.7. Listing New Articles</A>
<li><A href="TLNAGs.html#446">22.1.8. Selecting a Group on Which to Operate</A>
<li><A href="TLNAGs.html#447">22.1.9. Listing Articles in a Group</A>
<li><A href="TLNAGs.html#447">22.1.10. Retrieving an Article Header Only</A>
<li><A href="TLNAGs.html#448">22.1.11. Retrieving an Article Body Only</A>
<li><A href="TLNAGs.html#448">22.1.12. Reading an Article from a Group</A>
</ul><li><A href="TLNAGs.html#450">22.2. Installing the NNTP Server</A>
<li><A href="TLNAGs.html#451">22.3. Restricting NNTP Access</A>
<li><A href="TLNAGs.html#453">22.4. NNTP Authorization</A>
<li><A href="TLNAGs.html#454">22.5. nntpd Interaction with C News</A>
<li><A href="TLNAGs.html#455">Chapter 23. Internet News</A>
<li><A href="TLNAGs.html#456">23.1. Some INN Internals</A>
<li><A href="TLNAGs.html#458">23.2. Newsreaders and INN</A>
<li><A href="TLNAGs.html#459">23.3. Installing INN</A>
<li><A href="TLNAGs.html#460">23.4. Configuring INN: the Basic Setup</A>
<li><A href="TLNAGs.html#461">23.5. INN Configuration Files</A>
<ul><li><A href="TLNAGs.html#461">23.5.1. Global Parameters</A>
<ul><li><A href="TLNAGs.html#461">23.5.1.1. The inn.conf file</A>
</ul><li><A href="TLNAGs.html#462">23.5.2. Configuring Newsgroups</A>
<ul><li><A href="TLNAGs.html#463">23.5.2.1. The active and newsgroups files</A>
</ul><li><A href="TLNAGs.html#464">23.5.3. Configuring Newsfeeds</A>
<ul><li><A href="TLNAGs.html#465">23.5.3.1. The newsfeeds file</A>
<li><A href="TLNAGs.html#467">23.5.3.2. The nntpsend.ctl file</A>
</ul><li><A href="TLNAGs.html#468">23.5.4. Controlling Newsreader Access</A>
<ul><li><A href="TLNAGs.html#468">23.5.4.1. The incoming.conf file</A>
<li><A href="TLNAGs.html#470">23.5.4.2. The nnrp.access file</A>
</ul><li><A href="TLNAGs.html#471">23.5.5. Expiring News Articles</A>
<ul><li><A href="TLNAGs.html#471">23.5.5.1. The expire.ctl file</A>
</ul><li><A href="TLNAGs.html#472">23.5.6. Handling Control Messages</A>
<ul><li><A href="TLNAGs.html#473">23.5.6.1. The control.ctl file</A>
</ul></ul><li><A href="TLNAGs.html#476">23.6. Running INN</A>
<li><A href="TLNAGs.html#477">23.7. Managing INN: The ctlinnd Command</A>
<ul><li><A href="TLNAGs.html#477">23.7.1. Add a New Group</A>
<li><A href="TLNAGs.html#477">23.7.2. Change a Group</A>
<li><A href="TLNAGs.html#478">23.7.3. Remove a Group</A>
<li><A href="TLNAGs.html#478">23.7.4. Renumber a Group</A>
<li><A href="TLNAGs.html#478">23.7.5. Allow/Disallow Newsreaders</A>
<li><A href="TLNAGs.html#479">23.7.6. Reject Newsfeed Connections</A>
<li><A href="TLNAGs.html#479">23.7.7. Allow Newsfeed Connections</A>
<li><A href="TLNAGs.html#479">23.7.8. Disable News Server</A>
<li><A href="TLNAGs.html#480">23.7.9. Restart News Server</A>
<li><A href="TLNAGs.html#480">23.7.10. Display Status of a Newsfeed</A>
<li><A href="TLNAGs.html#480">23.7.11. Drop a Newsfeed</A>
<li><A href="TLNAGs.html#481">23.7.12. Begin a Newsfeed</A>
<li><A href="TLNAGs.html#481">23.7.13. Cancel an Article</A>
</ul><li><A href="TLNAGs.html#482">Chapter 24. Newsreader Configuration</A>
<li><A href="TLNAGs.html#483">24.1. tin Configuration</A>
<li><A href="TLNAGs.html#484">24.2. trn Configuration</A>
<li><A href="TLNAGs.html#485">24.3. nn Configuration</A>
<li><A href="TLNAGs.html#487">Appendix A. Example Network:The Virtual Brewery</A>
<li><A href="TLNAGs.html#488">A.1. Connecting the Virtual Subsidiary Network</A>
<li><A href="TLNAGs.html#489">Appendix B. Useful Cable Configurations</A>
<li><A href="TLNAGs.html#490">B.1. A PLIP Parallel Cable</A>
<li><A href="TLNAGs.html#491">B.2. A Serial NULL Modem Cable</A>
<li><A href="TLNAGs.html#492">Appendix C. Linux Network Administrator's Guide, Second Edition Copyright Information</A>
<li><A href="TLNAGs.html#493">C.1. 0. Preamble</A>
<li><A href="TLNAGs.html#494">C.2. 1. Applicability and Definitions</A>
<li><A href="TLNAGs.html#495">C.3. 2. Verbatim Copying</A>
<li><A href="TLNAGs.html#496">C.4. 3. Copying in Quantity</A>
<li><A href="TLNAGs.html#497">C.5. 4. Modifications</A>
<li><A href="TLNAGs.html#499">C.6. 5. Combining Documents</A>
<li><A href="TLNAGs.html#500">C.7. 6. Collections of Documents</A>
<li><A href="TLNAGs.html#501">C.8. 7. Aggregation with Independent Works</A>
<li><A href="TLNAGs.html#502">C.9. 8. Translation</A>
<li><A href="TLNAGs.html#503">C.10. 9. Termination</A>
<li><A href="TLNAGs.html#504">C.11. 10. Future Revisions of this License</A>
<li><A href="TLNAGs.html#505">Appendix D. SAGE: The SystemAdministrators Guild</A>
</ul><hr>
</BODY>
</HTML>
